var ef=(Mt,Nt,Ye)=>{if(!Nt.has(Mt))throw TypeError("Cannot "+Ye)};var P=(Mt,Nt,Ye)=>(ef(Mt,Nt,"read from private field"),Ye?Ye.call(Mt):Nt.get(Mt)),B=(Mt,Nt,Ye)=>{if(Nt.has(Mt))throw TypeError("Cannot add the same private member more than once");Nt instanceof WeakSet?Nt.add(Mt):Nt.set(Mt,Ye)},oe=(Mt,Nt,Ye,eo)=>(ef(Mt,Nt,"write to private field"),eo?eo.call(Mt,Ye):Nt.set(Mt,Ye),Ye),Rb=(Mt,Nt,Ye,eo)=>({set _(p){oe(Mt,Nt,p,Ye)},get _(){return P(Mt,Nt,eo)}}),N=(Mt,Nt,Ye)=>(ef(Mt,Nt,"access private method"),Ye);(()=>{var Mt={970:function(p,Se,_e){var ut;(function(xt){"use strict";function Xe(V,M){var W=(V&65535)+(M&65535),Ee=(V>>16)+(M>>16)+(W>>16);return Ee<<16|W&65535}function q(V,M){return V<<M|V>>>32-M}function x(V,M,W,Ee,ce,G){return Xe(q(Xe(Xe(M,V),Xe(Ee,G)),ce),W)}function se(V,M,W,Ee,ce,G,ee){return x(M&W|~M&Ee,V,M,ce,G,ee)}function A(V,M,W,Ee,ce,G,ee){return x(M&Ee|W&~Ee,V,M,ce,G,ee)}function De(V,M,W,Ee,ce,G,ee){return x(M^W^Ee,V,M,ce,G,ee)}function Qe(V,M,W,Ee,ce,G,ee){return x(W^(M|~Ee),V,M,ce,G,ee)}function Et(V,M){V[M>>5]|=128<<M%32,V[(M+64>>>9<<4)+14]=M;var W,Ee,ce,G,ee,z=1732584193,O=-271733879,R=-1732584194,Y=271733878;for(W=0;W<V.length;W+=16)Ee=z,ce=O,G=R,ee=Y,z=se(z,O,R,Y,V[W],7,-680876936),Y=se(Y,z,O,R,V[W+1],12,-389564586),R=se(R,Y,z,O,V[W+2],17,606105819),O=se(O,R,Y,z,V[W+3],22,-1044525330),z=se(z,O,R,Y,V[W+4],7,-176418897),Y=se(Y,z,O,R,V[W+5],12,1200080426),R=se(R,Y,z,O,V[W+6],17,-1473231341),O=se(O,R,Y,z,V[W+7],22,-45705983),z=se(z,O,R,Y,V[W+8],7,1770035416),Y=se(Y,z,O,R,V[W+9],12,-1958414417),R=se(R,Y,z,O,V[W+10],17,-42063),O=se(O,R,Y,z,V[W+11],22,-1990404162),z=se(z,O,R,Y,V[W+12],7,1804603682),Y=se(Y,z,O,R,V[W+13],12,-40341101),R=se(R,Y,z,O,V[W+14],17,-1502002290),O=se(O,R,Y,z,V[W+15],22,1236535329),z=A(z,O,R,Y,V[W+1],5,-165796510),Y=A(Y,z,O,R,V[W+6],9,-1069501632),R=A(R,Y,z,O,V[W+11],14,643717713),O=A(O,R,Y,z,V[W],20,-373897302),z=A(z,O,R,Y,V[W+5],5,-701558691),Y=A(Y,z,O,R,V[W+10],9,38016083),R=A(R,Y,z,O,V[W+15],14,-660478335),O=A(O,R,Y,z,V[W+4],20,-405537848),z=A(z,O,R,Y,V[W+9],5,568446438),Y=A(Y,z,O,R,V[W+14],9,-1019803690),R=A(R,Y,z,O,V[W+3],14,-187363961),O=A(O,R,Y,z,V[W+8],20,1163531501),z=A(z,O,R,Y,V[W+13],5,-1444681467),Y=A(Y,z,O,R,V[W+2],9,-51403784),R=A(R,Y,z,O,V[W+7],14,1735328473),O=A(O,R,Y,z,V[W+12],20,-1926607734),z=De(z,O,R,Y,V[W+5],4,-378558),Y=De(Y,z,O,R,V[W+8],11,-2022574463),R=De(R,Y,z,O,V[W+11],16,1839030562),O=De(O,R,Y,z,V[W+14],23,-35309556),z=De(z,O,R,Y,V[W+1],4,-1530992060),Y=De(Y,z,O,R,V[W+4],11,1272893353),R=De(R,Y,z,O,V[W+7],16,-155497632),O=De(O,R,Y,z,V[W+10],23,-1094730640),z=De(z,O,R,Y,V[W+13],4,681279174),Y=De(Y,z,O,R,V[W],11,-358537222),R=De(R,Y,z,O,V[W+3],16,-722521979),O=De(O,R,Y,z,V[W+6],23,76029189),z=De(z,O,R,Y,V[W+9],4,-640364487),Y=De(Y,z,O,R,V[W+12],11,-421815835),R=De(R,Y,z,O,V[W+15],16,530742520),O=De(O,R,Y,z,V[W+2],23,-995338651),z=Qe(z,O,R,Y,V[W],6,-198630844),Y=Qe(Y,z,O,R,V[W+7],10,1126891415),R=Qe(R,Y,z,O,V[W+14],15,-1416354905),O=Qe(O,R,Y,z,V[W+5],21,-57434055),z=Qe(z,O,R,Y,V[W+12],6,1700485571),Y=Qe(Y,z,O,R,V[W+3],10,-1894986606),R=Qe(R,Y,z,O,V[W+10],15,-1051523),O=Qe(O,R,Y,z,V[W+1],21,-2054922799),z=Qe(z,O,R,Y,V[W+8],6,1873313359),Y=Qe(Y,z,O,R,V[W+15],10,-30611744),R=Qe(R,Y,z,O,V[W+6],15,-1560198380),O=Qe(O,R,Y,z,V[W+13],21,1309151649),z=Qe(z,O,R,Y,V[W+4],6,-145523070),Y=Qe(Y,z,O,R,V[W+11],10,-1120210379),R=Qe(R,Y,z,O,V[W+2],15,718787259),O=Qe(O,R,Y,z,V[W+9],21,-343485551),z=Xe(z,Ee),O=Xe(O,ce),R=Xe(R,G),Y=Xe(Y,ee);return[z,O,R,Y]}function nt(V){var M,W="",Ee=V.length*32;for(M=0;M<Ee;M+=8)W+=String.fromCharCode(V[M>>5]>>>M%32&255);return W}function Kt(V){var M,W=[];for(W[(V.length>>2)-1]=void 0,M=0;M<W.length;M+=1)W[M]=0;var Ee=V.length*8;for(M=0;M<Ee;M+=8)W[M>>5]|=(V.charCodeAt(M/8)&255)<<M%32;return W}function ae(V){return nt(Et(Kt(V),V.length*8))}function Ft(V,M){var W,Ee=Kt(V),ce=[],G=[],ee;for(ce[15]=G[15]=void 0,Ee.length>16&&(Ee=Et(Ee,V.length*8)),W=0;W<16;W+=1)ce[W]=Ee[W]^909522486,G[W]=Ee[W]^1549556828;return ee=Et(ce.concat(Kt(M)),512+M.length*8),nt(Et(G.concat(ee),640))}function Ue(V){var M="0123456789abcdef",W="",Ee,ce;for(ce=0;ce<V.length;ce+=1)Ee=V.charCodeAt(ce),W+=M.charAt(Ee>>>4&15)+M.charAt(Ee&15);return W}function be(V){return unescape(encodeURIComponent(V))}function rt(V){return ae(be(V))}function Ke(V){return Ue(rt(V))}function on(V,M){return Ft(be(V),be(M))}function Ra(V,M){return Ue(on(V,M))}function te(V,M,W){return M?W?on(M,V):Ra(M,V):W?rt(V):Ke(V)}ut=function(){return te}.call(Se,_e,Se,p),ut!==void 0&&(p.exports=ut)})(this)},680:function(p){(function(Se,_e){p.exports=_e()})(this,function(){"use strict";var Se=1e3,_e=6e4,ut=36e5,xt="millisecond",Xe="second",q="minute",x="hour",se="day",A="week",De="month",Qe="quarter",Et="year",nt="date",Kt="Invalid Date",ae=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,Ft=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,Ue={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_")},be=function(ce,G,ee){var z=String(ce);return!z||z.length>=G?ce:""+Array(G+1-z.length).join(ee)+ce},rt={s:be,z:function(ce){var G=-ce.utcOffset(),ee=Math.abs(G),z=Math.floor(ee/60),O=ee%60;return(G<=0?"+":"-")+be(z,2,"0")+":"+be(O,2,"0")},m:function ce(G,ee){if(G.date()<ee.date())return-ce(ee,G);var z=12*(ee.year()-G.year())+(ee.month()-G.month()),O=G.clone().add(z,De),R=ee-O<0,Y=G.clone().add(z+(R?-1:1),De);return+(-(z+(ee-O)/(R?O-Y:Y-O))||0)},a:function(ce){return ce<0?Math.ceil(ce)||0:Math.floor(ce)},p:function(ce){return{M:De,y:Et,w:A,d:se,D:nt,h:x,m:q,s:Xe,ms:xt,Q:Qe}[ce]||String(ce||"").toLowerCase().replace(/s$/,"")},u:function(ce){return ce===void 0}},Ke="en",on={};on[Ke]=Ue;var Ra=function(ce){return ce instanceof W},te=function ce(G,ee,z){var O;if(!G)return Ke;if(typeof G=="string"){var R=G.toLowerCase();on[R]&&(O=R),ee&&(on[R]=ee,O=R);var Y=G.split("-");if(!O&&Y.length>1)return ce(Y[0])}else{var et=G.name;on[et]=G,O=et}return!z&&O&&(Ke=O),O||!z&&Ke},V=function(ce,G){if(Ra(ce))return ce.clone();var ee=typeof G=="object"?G:{};return ee.date=ce,ee.args=arguments,new W(ee)},M=rt;M.l=te,M.i=Ra,M.w=function(ce,G){return V(ce,{locale:G.$L,utc:G.$u,x:G.$x,$offset:G.$offset})};var W=function(){function ce(ee){this.$L=te(ee.locale,null,!0),this.parse(ee)}var G=ce.prototype;return G.parse=function(ee){this.$d=function(z){var O=z.date,R=z.utc;if(O===null)return new Date(NaN);if(M.u(O))return new Date;if(O instanceof Date)return new Date(O);if(typeof O=="string"&&!/Z$/i.test(O)){var Y=O.match(ae);if(Y){var et=Y[2]-1||0,ht=(Y[7]||"0").substring(0,3);return R?new Date(Date.UTC(Y[1],et,Y[3]||1,Y[4]||0,Y[5]||0,Y[6]||0,ht)):new Date(Y[1],et,Y[3]||1,Y[4]||0,Y[5]||0,Y[6]||0,ht)}}return new Date(O)}(ee),this.$x=ee.x||{},this.init()},G.init=function(){var ee=this.$d;this.$y=ee.getFullYear(),this.$M=ee.getMonth(),this.$D=ee.getDate(),this.$W=ee.getDay(),this.$H=ee.getHours(),this.$m=ee.getMinutes(),this.$s=ee.getSeconds(),this.$ms=ee.getMilliseconds()},G.$utils=function(){return M},G.isValid=function(){return this.$d.toString()!==Kt},G.isSame=function(ee,z){var O=V(ee);return this.startOf(z)<=O&&O<=this.endOf(z)},G.isAfter=function(ee,z){return V(ee)<this.startOf(z)},G.isBefore=function(ee,z){return this.endOf(z)<V(ee)},G.$g=function(ee,z,O){return M.u(ee)?this[z]:this.set(O,ee)},G.unix=function(){return Math.floor(this.valueOf()/1e3)},G.valueOf=function(){return this.$d.getTime()},G.startOf=function(ee,z){var O=this,R=!!M.u(z)||z,Y=M.p(ee),et=function(Xn,ct){var ze=M.w(O.$u?Date.UTC(O.$y,ct,Xn):new Date(O.$y,ct,Xn),O);return R?ze:ze.endOf(se)},ht=function(Xn,ct){return M.w(O.toDate()[Xn].apply(O.toDate("s"),(R?[0,0,0,0]:[23,59,59,999]).slice(ct)),O)},$e=this.$W,at=this.$M,Bt=this.$D,K="set"+(this.$u?"UTC":"");switch(Y){case Et:return R?et(1,0):et(31,11);case De:return R?et(1,at):et(0,at+1);case A:var di=this.$locale().weekStart||0,pe=($e<di?$e+7:$e)-di;return et(R?Bt-pe:Bt+(6-pe),at);case se:case nt:return ht(K+"Hours",0);case x:return ht(K+"Minutes",1);case q:return ht(K+"Seconds",2);case Xe:return ht(K+"Milliseconds",3);default:return this.clone()}},G.endOf=function(ee){return this.startOf(ee,!1)},G.$set=function(ee,z){var O,R=M.p(ee),Y="set"+(this.$u?"UTC":""),et=(O={},O[se]=Y+"Date",O[nt]=Y+"Date",O[De]=Y+"Month",O[Et]=Y+"FullYear",O[x]=Y+"Hours",O[q]=Y+"Minutes",O[Xe]=Y+"Seconds",O[xt]=Y+"Milliseconds",O)[R],ht=R===se?this.$D+(z-this.$W):z;if(R===De||R===Et){var $e=this.clone().set(nt,1);$e.$d[et](ht),$e.init(),this.$d=$e.set(nt,Math.min(this.$D,$e.daysInMonth())).$d}else et&&this.$d[et](ht);return this.init(),this},G.set=function(ee,z){return this.clone().$set(ee,z)},G.get=function(ee){return this[M.p(ee)]()},G.add=function(ee,z){var O,R=this;ee=Number(ee);var Y=M.p(z),et=function(at){var Bt=V(R);return M.w(Bt.date(Bt.date()+Math.round(at*ee)),R)};if(Y===De)return this.set(De,this.$M+ee);if(Y===Et)return this.set(Et,this.$y+ee);if(Y===se)return et(1);if(Y===A)return et(7);var ht=(O={},O[q]=_e,O[x]=ut,O[Xe]=Se,O)[Y]||1,$e=this.$d.getTime()+ee*ht;return M.w($e,this)},G.subtract=function(ee,z){return this.add(-1*ee,z)},G.format=function(ee){var z=this,O=this.$locale();if(!this.isValid())return O.invalidDate||Kt;var R=ee||"YYYY-MM-DDTHH:mm:ssZ",Y=M.z(this),et=this.$H,ht=this.$m,$e=this.$M,at=O.weekdays,Bt=O.months,K=function(ct,ze,ke,pa){return ct&&(ct[ze]||ct(z,R))||ke[ze].slice(0,pa)},di=function(ct){return M.s(et%12||12,ct,"0")},pe=O.meridiem||function(ct,ze,ke){var pa=ct<12?"AM":"PM";return ke?pa.toLowerCase():pa},Xn={YY:String(this.$y).slice(-2),YYYY:this.$y,M:$e+1,MM:M.s($e+1,2,"0"),MMM:K(O.monthsShort,$e,Bt,3),MMMM:K(Bt,$e),D:this.$D,DD:M.s(this.$D,2,"0"),d:String(this.$W),dd:K(O.weekdaysMin,this.$W,at,2),ddd:K(O.weekdaysShort,this.$W,at,3),dddd:at[this.$W],H:String(et),HH:M.s(et,2,"0"),h:di(1),hh:di(2),a:pe(et,ht,!0),A:pe(et,ht,!1),m:String(ht),mm:M.s(ht,2,"0"),s:String(this.$s),ss:M.s(this.$s,2,"0"),SSS:M.s(this.$ms,3,"0"),Z:Y};return R.replace(Ft,function(ct,ze){return ze||Xn[ct]||Y.replace(":","")})},G.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},G.diff=function(ee,z,O){var R,Y=M.p(z),et=V(ee),ht=(et.utcOffset()-this.utcOffset())*_e,$e=this-et,at=M.m(this,et);return at=(R={},R[Et]=at/12,R[De]=at,R[Qe]=at/3,R[A]=($e-ht)/6048e5,R[se]=($e-ht)/864e5,R[x]=$e/ut,R[q]=$e/_e,R[Xe]=$e/Se,R)[Y]||$e,O?at:M.a(at)},G.daysInMonth=function(){return this.endOf(De).$D},G.$locale=function(){return on[this.$L]},G.locale=function(ee,z){if(!ee)return this.$L;var O=this.clone(),R=te(ee,z,!0);return R&&(O.$L=R),O},G.clone=function(){return M.w(this.$d,this)},G.toDate=function(){return new Date(this.valueOf())},G.toJSON=function(){return this.isValid()?this.toISOString():null},G.toISOString=function(){return this.$d.toISOString()},G.toString=function(){return this.$d.toUTCString()},ce}(),Ee=W.prototype;return V.prototype=Ee,[["$ms",xt],["$s",Xe],["$m",q],["$H",x],["$W",se],["$M",De],["$y",Et],["$D",nt]].forEach(function(ce){Ee[ce[1]]=function(G){return this.$g(G,ce[0],ce[1])}}),V.extend=function(ce,G){return ce.$i||(ce(G,W,V),ce.$i=!0),V},V.locale=te,V.isDayjs=Ra,V.unix=function(ce){return V(1e3*ce)},V.en=on[Ke],V.Ls=on,V.p={},V})},852:(p,Se,_e)=>{"use strict";_e.r(Se),_e.d(Se,{Constants:()=>x});var ut=_e(314);const xt="2.12.0",Xe="production",q=class{};let x=q;x.SIYUAN_VERSION=xt,x.NODE_ENV=Xe,x.SIYUAN_APPID=Math.random().toString(36).substring(8),x.ASSETS_ADDRESS="https://assets.b3logfile.com/siyuan/",x.PROTYLE_CDN="/stage/protyle",x.UPLOAD_ADDRESS="/upload",x.SERVICE_WORKER_PATH="/service-worker.js",x.SIYUAN_DROP_FILE="application/siyuan-file",x.SIYUAN_DROP_GUTTER="application/siyuan-gutter",x.SIYUAN_DROP_TAB="application/siyuan-tab",x.SIYUAN_DROP_EDITOR="application/siyuan-editor",x.SIYUAN_CMD="siyuan-cmd",x.SIYUAN_GET="siyuan-get",x.SIYUAN_EVENT="siyuan-event",x.SIYUAN_CONFIG_TRAY="siyuan-config-tray",x.SIYUAN_QUIT="siyuan-quit",x.SIYUAN_HOTKEY="siyuan-hotkey",x.SIYUAN_INIT="siyuan-init",x.SIYUAN_SEND_WINDOWS="siyuan-send-windows",x.SIYUAN_SAVE_CLOSE="siyuan-save-close",x.SIYUAN_AUTO_LAUNCH="siyuan-auto-launch",x.SIYUAN_OPEN_WORKSPACE="siyuan-open-workspace",x.SIYUAN_OPEN_URL="siyuan-open-url",x.SIYUAN_OPEN_WINDOW="siyuan-open-window",x.SIYUAN_OPEN_FOLDER="siyuan-open-folder",x.SIYUAN_OPEN_FILE="siyuan-open-file",x.SIYUAN_EXPORT_PDF="siyuan-export-pdf",x.SIYUAN_EXPORT_NEWWINDOW="siyuan-export-newwindow",x.CUSTOM_SY_READONLY="custom-sy-readonly",x.CUSTOM_SY_FULLWIDTH="custom-sy-fullwidth",x.CUSTOM_REMINDER_WECHAT="custom-reminder-wechat",x.CUSTOM_RIFF_DECKS="custom-riff-decks",x.SIZE_SCROLL_TB=24,x.SIZE_SCROLL_STEP=256,x.SIZE_LINK_TEXT_MAX=24,x.SIZE_TOOLBAR_HEIGHT=(0,ut.tq)()?0:32,x.SIZE_GET_MAX=102400,x.SIZE_UNDO=64,x.SIZE_TITLE=512,x.SIZE_EDITOR_WIDTH=760,x.SIZE_ZOOM=[.25,.33,.5,.67,.75,.8,.9,1,1.1,1.25,1.5,1.75,2,2.5,3],x.CB_MOVE_NOLIST="cb-move-nolist",x.CB_MOUNT_REMOVE="cb-mount-remove",x.CB_GET_APPEND="cb-get-append",x.CB_GET_BEFORE="cb-get-before",x.CB_GET_UNCHANGEID="cb-get-unchangeid",x.CB_GET_HL="cb-get-hl",x.CB_GET_FOCUS="cb-get-focus",x.CB_GET_FOCUSFIRST="cb-get-focusfirst",x.CB_GET_SETID="cb-get-setid",x.CB_GET_ALL="cb-get-all",x.CB_GET_BACKLINK="cb-get-backlink",x.CB_GET_UNUNDO="cb-get-unundo",x.CB_GET_SCROLL="cb-get-scroll",x.CB_GET_CONTEXT="cb-get-context",x.CB_GET_ROOTSCROLL="cb-get-rootscroll",x.CB_GET_HTML="cb-get-html",x.CB_GET_HISTORY="cb-get-history",x.LOCAL_ZOOM="local-zoom",x.LOCAL_SEARCHDATA="local-searchdata",x.LOCAL_SEARCHKEYS="local-searchkeys",x.LOCAL_SEARCHASSET="local-searchasset",x.LOCAL_DOCINFO="local-docinfo",x.LOCAL_DAILYNOTEID="local-dailynoteid",x.LOCAL_HISTORYNOTEID="local-historynoteid",x.LOCAL_CODELANG="local-codelang",x.LOCAL_FONTSTYLES="local-fontstyles",x.LOCAL_EXPORTPDF="local-exportpdf",x.LOCAL_EXPORTWORD="local-exportword",x.LOCAL_EXPORTIMG="local-exportimg",x.LOCAL_BAZAAR="local-bazaar",x.LOCAL_PDFTHEME="local-pdftheme",x.LOCAL_LAYOUTS="local-layouts",x.LOCAL_AI="local-ai",x.LOCAL_PLUGINTOPUNPIN="local-plugintopunpin",x.LOCAL_FLASHCARD="local-flashcard",x.LOCAL_FILEPOSITION="local-fileposition",x.LOCAL_DIALOGPOSITION="local-dialogposition",x.LOCAL_SESSION_FIRSTLOAD="local-session-firstload",x.DIALOG_OPENCARD="dialog-opencard",x.DIALOG_MAKECARD="dialog-makecard",x.DIALOG_VIEWCARDS="dialog-viewcards",x.DIALOG_DIALYNOTE="dialog-dialynote",x.DIALOG_RECENTDOCS="dialog-recentdocs",x.DIALOG_SWITCHTAB="dialog-switchtab",x.DIALOG_SEARCH="dialog-search",x.DIALOG_REPLACE="dialog-replace",x.DIALOG_GLOBALSEARCH="dialog-globalsearch",x.TIMEOUT_DBLCLICK=190,x.TIMEOUT_INPUT=256,x.TIMEOUT_LOAD=300,x.TIMEOUT_TRANSITION=300,x.TIMEOUT_COUNT=1e3,x.HELP_PATH={zh_CN:"20210808180117-czj9bvb",zh_CHT:"20211226090932-5lcq56f",en_US:"20210808180117-6v0mkxr",fr_FR:"20210808180117-6v0mkxr"},x.QUICK_DECK_ID="20230218211946-2kw8jgx",x.KEYCODELIST={8:"\u232B",9:"\u21E5",13:"\u21A9",16:"\u21E7",17:"\u2303",18:"\u2325",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"\u2190",38:"\u2191",39:"\u2192",40:"\u2193",44:"PrintScreen",45:"Insert",46:"\u2326",48:"0",49:"1",50:"2",51:"3",52:"4",53:"5",54:"6",55:"7",56:"8",57:"9",65:"A",66:"B",67:"C",68:"D",69:"E",70:"F",71:"G",72:"H",73:"I",74:"J",75:"K",76:"L",77:"M",78:"N",79:"O",80:"P",81:"Q",82:"R",83:"S",84:"T",85:"U",86:"V",87:"W",88:"X",89:"Y",90:"Z",91:"\u2318",92:"\u2318",93:"ContextMenu",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",182:"MyComputer",183:"MyCalculator",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},x.SIYUAN_KEYMAP={general:{mainMenu:{default:"\u2325\\",custom:"\u2325\\"},commandPanel:{default:"\u2325\u21E7P",custom:"\u2325\u21E7P"},editReadonly:{default:"\u21E7\u2318G",custom:"\u21E7\u2318G"},syncNow:{default:"F9",custom:"F9"},enterBack:{default:"\u2325\u2190",custom:"\u2325\u2190"},enter:{default:"\u2325\u2192",custom:"\u2325\u2192"},goForward:{default:"\u2318]",custom:"\u2318]"},goBack:{default:"\u2318[",custom:"\u2318["},newFile:{default:"\u2318N",custom:"\u2318N"},search:{default:"\u2318F",custom:"\u2318F"},globalSearch:{default:"\u2318P",custom:"\u2318P"},stickSearch:{default:"\u21E7\u2318F",custom:"\u21E7\u2318F"},replace:{default:"\u2318R",custom:"\u2318R"},closeTab:{default:"\u2318W",custom:"\u2318W"},fileTree:{default:"\u23251",custom:"\u23251"},outline:{default:"\u23252",custom:"\u23252"},bookmark:{default:"\u23253",custom:"\u23253"},tag:{default:"\u23254",custom:"\u23254"},dailyNote:{default:"\u23255",custom:"\u23255"},inbox:{default:"\u23256",custom:"\u23256"},backlinks:{default:"\u23257",custom:"\u23257"},graphView:{default:"\u23258",custom:"\u23258"},globalGraph:{default:"\u23259",custom:"\u23259"},riffCard:{default:"\u23250",custom:"\u23250"},config:{default:"\u2325P",custom:"\u2325P"},dataHistory:{default:"\u2325H",custom:"\u2325H"},toggleWin:{default:"\u2325M",custom:"\u2325M"},lockScreen:{default:"\u2325N",custom:"\u2325N"},recentDocs:{default:"\u2318E",custom:"\u2318E"},goToTab1:{default:"\u23181",custom:"\u23181"},goToTab2:{default:"\u23182",custom:"\u23182"},goToTab3:{default:"\u23183",custom:"\u23183"},goToTab4:{default:"\u23184",custom:"\u23184"},goToTab5:{default:"\u23185",custom:"\u23185"},goToTab6:{default:"\u23186",custom:"\u23186"},goToTab7:{default:"\u23187",custom:"\u23187"},goToTab8:{default:"\u23188",custom:"\u23188"},goToTab9:{default:"\u23189",custom:"\u23189"},goToTabNext:{default:"\u21E7\u2318]",custom:"\u21E7\u2318]"},goToTabPrev:{default:"\u21E7\u2318[",custom:"\u21E7\u2318["},goToEditTabNext:{default:"\u2303\u21E5",custom:"\u2303\u21E5"},goToEditTabPrev:{default:"\u2303\u21E7\u21E5",custom:"\u2303\u21E7\u21E5"},move:{default:"",custom:""},selectOpen1:{default:"",custom:""},toggleDock:{default:"",custom:""},splitLR:{default:"",custom:""},splitMoveR:{default:"",custom:""},splitTB:{default:"",custom:""},splitMoveB:{default:"",custom:""},closeOthers:{default:"",custom:""},closeAll:{default:"",custom:""},closeUnmodified:{default:"",custom:""},closeLeft:{default:"",custom:""},closeRight:{default:"",custom:""},tabToWindow:{default:"",custom:""}},editor:{general:{duplicate:{default:"\u2318D",custom:"\u2318D"},expandDown:{default:"\u2325\u21E7\u2193",custom:"\u2325\u21E7\u2193"},expandUp:{default:"\u2325\u21E7\u2191",custom:"\u2325\u21E7\u2191"},copyPlainText:{default:"",custom:""},copyID:{default:"",custom:""},copyProtocolInMd:{default:"",custom:""},netImg2LocalAsset:{default:"",custom:""},netAssets2LocalAssets:{default:"",custom:""},optimizeTypography:{default:"",custom:""},hLayout:{default:"",custom:""},vLayout:{default:"",custom:""},refPopover:{default:"",custom:""},copyText:{default:"",custom:""},expand:{default:"\u2318\u2193",custom:"\u2318\u2193"},collapse:{default:"\u2318\u2191",custom:"\u2318\u2191"},insertBottom:{default:"\u2325\u2318.",custom:"\u2325\u2318."},refTab:{default:"\u21E7\u2318.",custom:"\u21E7\u2318."},openBy:{default:"\u2325,",custom:"\u2325,"},insertRight:{default:"\u2325.",custom:"\u2325."},attr:{default:"\u2325\u2318A",custom:"\u2325\u2318A"},quickMakeCard:{default:"\u2325\u2318F",custom:"\u2325\u2318F"},refresh:{default:"F5",custom:"F5"},copyBlockRef:{default:"\u21E7\u2318C",custom:"\u21E7\u2318C"},copyProtocol:{default:"\u21E7\u2318H",custom:"\u21E7\u2318H"},copyBlockEmbed:{default:"\u21E7\u2318E",custom:"\u21E7\u2318E"},copyHPath:{default:"\u21E7\u2318P",custom:"\u21E7\u2318P"},undo:{default:"\u2318Z",custom:"\u2318Z"},redo:{default:"\u2318Y",custom:"\u2318Y"},rename:{default:"F2",custom:"F2"},newNameFile:{default:"F3",custom:"F3"},newContentFile:{default:"F4",custom:"F4"},newNameSettingFile:{default:"\u2318F3",custom:"\u2318F3"},showInFolder:{default:"\u2325A",custom:"\u2325A"},outline:{default:"\u2325O",custom:"\u2325O"},backlinks:{default:"\u2325B",custom:"\u2325B"},graphView:{default:"\u2325G",custom:"\u2325G"},spaceRepetition:{default:"\u2325F",custom:"\u2325F"},fullscreen:{default:"\u2325Y",custom:"\u2325Y"},alignLeft:{default:"\u2325L",custom:"\u2325L"},alignCenter:{default:"\u2325C",custom:"\u2325C"},alignRight:{default:"\u2325R",custom:"\u2325R"},wysiwyg:{default:"\u2325\u23187",custom:"\u2325\u23187"},preview:{default:"\u2325\u23189",custom:"\u2325\u23189"},insertBefore:{default:"\u21E7\u2318B",custom:"\u21E7\u2318B"},insertAfter:{default:"\u21E7\u2318A",custom:"\u21E7\u2318A"},jumpToParentNext:{default:"\u21E7\u2318N",custom:"\u21E7\u2318N"},moveToUp:{default:"\u21E7\u2318\u2191",custom:"\u21E7\u2318\u2191"},moveToDown:{default:"\u21E7\u2318\u2193",custom:"\u21E7\u2318\u2193"}},insert:{appearance:{default:"\u2325\u2318X",custom:"\u2325\u2318X"},lastUsed:{default:"\u2325X",custom:"\u2325X"},ref:{default:"\u2325[",custom:"\u2325["},kbd:{default:"\u2318'",custom:"\u2318'"},sup:{default:"\u2318H",custom:"\u2318H"},sub:{default:"\u2318J",custom:"\u2318J"},bold:{default:"\u2318B",custom:"\u2318B"},"inline-math":{default:"\u2318M",custom:"\u2318M"},memo:{default:"\u2325\u2318M",custom:"\u2325\u2318M"},underline:{default:"\u2318U",custom:"\u2318U"},italic:{default:"\u2318I",custom:"\u2318I"},mark:{default:"\u2325D",custom:"\u2325D"},tag:{default:"\u2318T",custom:"\u2318T"},strike:{default:"\u21E7\u2318S",custom:"\u21E7\u2318S"},"inline-code":{default:"\u2318G",custom:"\u2318G"},link:{default:"\u2318K",custom:"\u2318K"},check:{default:"\u2318L",custom:"\u2318L"},table:{default:"\u2318O",custom:"\u2318O"},code:{default:"\u21E7\u2318K",custom:"\u21E7\u2318K"},clearInline:{default:"\u2318\\",custom:"\u2318\\"}},heading:{paragraph:{default:"\u2325\u23180",custom:"\u2325\u23180"},heading1:{default:"\u2325\u23181",custom:"\u2325\u23181"},heading2:{default:"\u2325\u23182",custom:"\u2325\u23182"},heading3:{default:"\u2325\u23183",custom:"\u2325\u23183"},heading4:{default:"\u2325\u23184",custom:"\u2325\u23184"},heading5:{default:"\u2325\u23185",custom:"\u2325\u23185"},heading6:{default:"\u2325\u23186",custom:"\u2325\u23186"}},list:{indent:{default:"\u21E5",custom:"\u21E5"},outdent:{default:"\u21E7\u21E5",custom:"\u21E7\u21E5"},checkToggle:{default:"\u2318\u21A9",custom:"\u2318\u21A9"}},table:{insertRowAbove:{default:"\u21E7\u2318T",custom:"\u21E7\u2318T"},insertRowBelow:{default:"\u21E7\u2318D",custom:"\u21E7\u2318D"},insertColumnLeft:{default:"\u21E7\u2318L",custom:"\u21E7\u2318L"},insertColumnRight:{default:"\u21E7\u2318R",custom:"\u21E7\u2318R"},moveToUp:{default:"\u2325\u2318T",custom:"\u2325\u2318T"},moveToDown:{default:"\u2325\u2318B",custom:"\u2325\u2318B"},moveToLeft:{default:"\u2325\u2318L",custom:"\u2325\u2318L"},moveToRight:{default:"\u2325\u2318R",custom:"\u2325\u2318R"},"delete-row":{default:"\u2318-",custom:"\u2318-"},"delete-column":{default:"\u21E7\u2318-",custom:"\u21E7\u2318-"}}},plugin:{}},x.SIYUAN_EMPTY_LAYOUT={hideDock:!1,layout:{direction:"tb",size:"0px",type:"normal",instance:"Layout",children:[{direction:"lr",size:"auto",type:"normal",instance:"Layout",children:[{direction:"tb",size:"0px",type:"left",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]},{direction:"lr",resize:"lr",size:"auto",type:"center",instance:"Layout",children:[{instance:"Wnd",children:[{instance:"Tab",children:[]}]}]},{direction:"tb",size:"0px",resize:"lr",type:"right",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]}]},{direction:"lr",size:"0px",resize:"tb",type:"bottom",instance:"Layout",children:[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]}]},bottom:{pin:!0,data:[]},left:{pin:!0,data:[[{type:"file",size:{width:227,height:0},show:!0,icon:"iconFiles",hotkeyLangId:"fileTree"},{type:"outline",size:{width:227,height:0},show:!1,icon:"iconAlignCenter",hotkeyLangId:"outline"},{type:"inbox",size:{width:320,height:0},show:!1,icon:"iconInbox",hotkeyLangId:"inbox"}],[{type:"bookmark",size:{width:227,height:0},show:!1,icon:"iconBookmark",hotkeyLangId:"bookmark"},{type:"tag",size:{width:227,height:0},show:!1,icon:"iconTags",hotkeyLangId:"tag"}]]},right:{pin:!0,data:[[{type:"graph",size:{width:320,height:0},show:!1,icon:"iconGraph",hotkeyLangId:"graphView"},{type:"globalGraph",size:{width:320,height:0},show:!1,icon:"iconGlobalGraph",hotkeyLangId:"globalGraph"}],[{type:"backlink",size:{width:320,height:0},show:!1,icon:"iconLink",hotkeyLangId:"backlinks"}]]}},x.SIYUAN_DEFAULT_REPLACETYPES={text:!0,imgText:!0,imgTitle:!0,imgSrc:!1,aText:!0,aTitle:!0,aHref:!1,code:!1,em:!0,strong:!0,inlineMath:!1,inlineMemo:!0,kbd:!0,mark:!0,s:!0,sub:!0,sup:!0,tag:!0,u:!0,docTitle:!0,codeBlock:!1,mathBlock:!1,htmlBlock:!1},x.SIYUAN_IMAGE_VIP=`<svg version="1.1" xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32">
<path fill="#ffd00f" d="M2.288 12.643l23.487 12.853c0.286 0.153 0.477 0.45 0.477 0.791 0 0.082-0.011 0.161-0.032 0.237l0.001-0.006c-0.119 0.395-0.479 0.678-0.905 0.678-0.004 0-0.009-0-0.013-0h-19.439c-0.958 0-1.766-0.684-1.885-1.595l-1.691-12.956z"></path>
<path fill="#ffd00f" d="M29.676 12.643l-1.691 12.957c-0.119 0.911-0.927 1.594-1.884 1.594h-19.442c-0.004 0-0.009 0-0.013 0-0.425 0-0.785-0.281-0.903-0.668l-0.002-0.007c-0.019-0.070-0.031-0.15-0.031-0.232 0-0.341 0.191-0.638 0.472-0.788l0.005-0.002 23.487-12.853z"></path>
<path fill="#ffe668" d="M15.413 8.369l10.394 15.921c0.378 0.579 0.407 1.317 0.076 1.924-0.328 0.591-0.948 0.985-1.66 0.985-0 0-0.001 0-0.001 0h-17.617c-0.694 0-1.331-0.378-1.661-0.985-0.144-0.26-0.229-0.569-0.229-0.899 0-0.382 0.114-0.736 0.31-1.033l-0.004 0.007 10.394-15.921z"></path>
<path fill="#ffdd4e" d="M15.396 8.403l11.659 15.921c0.401 0.579 0.432 1.317 0.081 1.924-0.361 0.594-1.005 0.985-1.741 0.985-0.008 0-0.017-0-0.025-0h-9.344l-0.63-18.83z"></path>
<path fill="#ffd00f" d="M13.868 6.478c0 0.946 0.767 1.712 1.712 1.712s1.712-0.767 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM28.577 10.818c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0zM0 10.822c0 0.945 0.766 1.712 1.712 1.712s1.712-0.766 1.712-1.712v0c0-0.945-0.766-1.712-1.712-1.712s-1.712 0.766-1.712 1.712v0z"></path>
</svg>`,x.SIYUAN_IMAGE_FILE="1f4c4",x.SIYUAN_IMAGE_NOTE="1f5c3",x.SIYUAN_IMAGE_FOLDER="1f4d1",x.SIYUAN_ASSETS_IMAGE=[".apng",".ico",".cur",".jpg",".jpe",".jpeg",".jfif",".pjp",".pjpeg",".png",".gif",".webp",".bmp",".svg",".avif"],x.SIYUAN_ASSETS_AUDIO=[".mp3",".wav",".ogg",".m4a"],x.SIYUAN_ASSETS_VIDEO=[".mov",".weba",".mkv",".mp4",".webm"],x.SIYUAN_ASSETS_EXTS=[".pdf"].concat(q.SIYUAN_ASSETS_IMAGE).concat(q.SIYUAN_ASSETS_AUDIO).concat(q.SIYUAN_ASSETS_VIDEO),x.SIYUAN_ASSETS_SEARCH=[".txt",".md",".markdown",".docx",".xlsx",".pptx",".pdf",".json",".log",".sql",".html",".xml",".java",".h",".c",".cpp",".go",".rs",".swift",".kt",".py",".php",".js",".css",".ts",".sh",".bat",".cmd",".ini",".yaml",".rst",".adoc",".textile",".opml",".org",".wiki",".epub"],x.SIYUAN_CONFIG_APPEARANCE_DARK_CODE=["a11y-dark","agate","an-old-hope","androidstudio","arta","atom-one-dark","atom-one-dark-reasonable","base16/3024","base16/apathy","base16/apprentice","base16/ashes","base16/atelier-cave","base16/atelier-dune","base16/atelier-estuary","base16/atelier-forest","base16/atelier-heath","base16/atelier-lakeside","base16/atelier-plateau","base16/atelier-savanna","base16/atelier-seaside","base16/atelier-sulphurpool","base16/atlas","base16/bespin","base16/black-metal","base16/black-metal-bathory","base16/black-metal-burzum","base16/black-metal-dark-funeral","base16/black-metal-gorgoroth","base16/black-metal-immortal","base16/black-metal-khold","base16/black-metal-marduk","base16/black-metal-mayhem","base16/black-metal-nile","base16/black-metal-venom","base16/brewer","base16/bright","base16/brogrammer","base16/brush-trees-dark","base16/chalk","base16/circus","base16/classic-dark","base16/codeschool","base16/colors","base16/danqing","base16/darcula","base16/dark-violet","base16/darkmoss","base16/darktooth","base16/decaf","base16/default-dark","base16/dracula","base16/edge-dark","base16/eighties","base16/embers","base16/equilibrium-dark","base16/equilibrium-gray-dark","base16/espresso","base16/eva","base16/eva-dim","base16/flat","base16/framer","base16/gigavolt","base16/google-dark","base16/grayscale-dark","base16/green-screen","base16/gruvbox-dark-hard","base16/gruvbox-dark-medium","base16/gruvbox-dark-pale","base16/gruvbox-dark-soft","base16/hardcore","base16/harmonic16-dark","base16/heetch-dark","base16/helios","base16/hopscotch","base16/horizon-dark","base16/humanoid-dark","base16/ia-dark","base16/icy-dark","base16/ir-black","base16/isotope","base16/kimber","base16/london-tube","base16/macintosh","base16/marrakesh","base16/materia","base16/material","base16/material-darker","base16/material-palenight","base16/material-vivid","base16/mellow-purple","base16/mocha","base16/monokai","base16/nebula","base16/nord","base16/nova","base16/ocean","base16/oceanicnext","base16/onedark","base16/outrun-dark","base16/papercolor-dark","base16/paraiso","base16/pasque","base16/phd","base16/pico","base16/pop","base16/porple","base16/qualia","base16/railscasts","base16/rebecca","base16/ros-pine","base16/ros-pine-moon","base16/sandcastle","base16/seti-ui","base16/silk-dark","base16/snazzy","base16/solar-flare","base16/solarized-dark","base16/spacemacs","base16/summercamp","base16/summerfruit-dark","base16/synth-midnight-terminal-dark","base16/tango","base16/tender","base16/tomorrow-night","base16/twilight","base16/unikitty-dark","base16/vulcan","base16/windows-10","base16/windows-95","base16/windows-high-contrast","base16/windows-nt","base16/woodland","base16/xcode-dusk","base16/zenburn","codepen-embed","dark","devibeans","far","felipec","github-dark","github-dark-dimmed","gml","gradient-dark","hybrid","ir-black","isbl-editor-dark","kimbie-dark","lioshi","monokai","monokai-sublime","night-owl","nnfx-dark","nord","obsidian","panda-syntax-dark","paraiso-dark","pojoaque","qtcreator-dark","rainbow","shades-of-purple","srcery","stackoverflow-dark","sunburst","tomorrow-night-blue","tomorrow-night-bright","tokyo-night-dark","vs2015","xt256"],x.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE=["ant-design","a11y-light","arduino-light","ascetic","atom-one-light","base16/atelier-cave-light","base16/atelier-dune-light","base16/atelier-estuary-light","base16/atelier-forest-light","base16/atelier-heath-light","base16/atelier-lakeside-light","base16/atelier-plateau-light","base16/atelier-savanna-light","base16/atelier-seaside-light","base16/atelier-sulphurpool-light","base16/brush-trees","base16/classic-light","base16/cupcake","base16/cupertino","base16/default-light","base16/dirtysea","base16/edge-light","base16/equilibrium-gray-light","base16/equilibrium-light","base16/fruit-soda","base16/github","base16/google-light","base16/grayscale-light","base16/gruvbox-light-hard","base16/gruvbox-light-medium","base16/gruvbox-light-soft","base16/harmonic16-light","base16/heetch-light","base16/humanoid-light","base16/horizon-light","base16/ia-light","base16/material-lighter","base16/mexico-light","base16/one-light","base16/papercolor-light","base16/ros-pine-dawn","base16/sagelight","base16/shapeshifter","base16/silk-light","base16/solar-flare-light","base16/solarized-light","base16/summerfruit-light","base16/synth-midnight-terminal-light","base16/tomorrow","base16/unikitty-light","base16/windows-10-light","base16/windows-95-light","base16/windows-high-contrast-light","brown-paper","base16/windows-nt-light","color-brewer","docco","foundation","github","googlecode","gradient-light","grayscale","idea","intellij-light","isbl-editor-light","kimbie-light","lightfair","magula","mono-blue","nnfx-light","panda-syntax-light","paraiso-light","purebasic","qtcreator-light","routeros","school-book","stackoverflow-light","tokyo-night-light","vs","xcode","default"],x.ZWSP="\u200B",x.INLINE_TYPE=["block-ref","kbd","text","file-annotation-ref","a","strong","em","u","s","mark","sup","sub","tag","code","inline-math","inline-memo"],x.BLOCK_HINT_KEYS=["((","[[","\uFF08\uFF08","\u3010\u3010"],x.BLOCK_HINT_CLOSE_KEYS={"((":"))","[[":"]]","\uFF08\uFF08":"\uFF09\uFF09","\u3010\u3010":"\u3011\u3011"},x.ALIAS_CODE_LANGUAGES=["js","ts","html","toml","c#","bat"],x.ANALYTICS_EVT_ON_GET_CONFIG="siyuan.onGetConfig"},706:(p,Se,_e)=>{"use strict";_e.r(Se),_e.d(Se,{addScript:()=>xt,addScriptSync:()=>ut});const ut=(Xe,q)=>{if(document.getElementById(q))return!1;const x=new XMLHttpRequest;x.open("GET",Xe,!1),x.setRequestHeader("Accept","text/javascript, application/javascript, application/ecmascript, application/x-ecmascript, */*; q=0.01"),x.send("");const se=document.createElement("script");se.type="text/javascript",se.text=x.responseText,se.id=q,document.head.appendChild(se)},xt=(Xe,q)=>new Promise(x=>{if(document.getElementById(q))return x(!1),!1;const se=document.createElement("script");se.src=Xe,se.async=!0,document.head.appendChild(se),se.onload=()=>{if(document.getElementById(q))return se.remove(),x(!1),!1;se.id=q,x(!0)}})},314:(p,Se,_e)=>{"use strict";_e.d(Se,{FJ:()=>q,MK:()=>Ft,N_:()=>xt,Qf:()=>ae,UP:()=>Xe,Y$:()=>Et,b1:()=>x,jU:()=>Qe,on:()=>De,qP:()=>se,rJ:()=>nt,sZ:()=>A,tq:()=>ut,vc:()=>Kt});const ut=()=>!!document.getElementById("sidebar"),xt=()=>["docker","ios","android"].includes(window.siyuan.config.system.container)?window.siyuan.config.system.container:window.siyuan.config.system.os,Xe=()=>window.navigator.userAgent.startsWith("SiYuan/")?q()?"desktop-window":"desktop":"browser-desktop",q=()=>!document.getElementById("toolbar"),x=()=>"ontouchstart"in window&&navigator.maxTouchPoints>1,se=(Ue,be)=>Ue.length===be.length&&Ue.every(rt=>be.includes(rt)),A=(Ue,be)=>Math.floor(Math.random()*(be-Ue+1))+Ue,De=(Ue,be=window.location.search)=>{const rt=be.substring(be.indexOf("?")),Ke=rt.indexOf("#");return new URLSearchParams(rt.substring(0,Ke>=0?Ke:void 0)).get(Ue)},Qe=()=>!1,Et=Ue=>/^\(\(\d{14}-\w{7} '.*'\)\)$/.test(Ue),nt=Ue=>/^<<assets\/.+\/\d{14}-\w{7} ".+">>$/.test(Ue),Kt=Ue=>/^[_a-zA-Z][_.\-0-9a-zA-Z]*$/.test(Ue),ae=Ue=>Function(`"use strict";return (${Ue})`)(),Ft=(Ue,be)=>{if(Ue===be||typeof Ue=="number"&&isNaN(Ue)&&typeof be=="number"&&isNaN(be))return!0;if(Ue instanceof Date&&be instanceof Date)return Ue.getTime()===be.getTime();if(!Ue||!be||typeof Ue!="object"&&typeof be!="object")return Ue===be;if(Ue.prototype!==be.prototype)return!1;const rt=Object.keys(Ue);return rt.length!==Object.keys(be).length?!1:rt.every(Ke=>Ft(Ue[Ke],be[Ke]))}},916:(p,Se,_e)=>{"use strict";_e.r(Se),_e.d(Se,{GenericScripting:()=>q,docPropertiesLookup:()=>Xe});var ut=_e(272),xt=_e.n(ut);async function Xe(x){const se="",A=se.split("#")[0];let{info:De,metadata:Qe,contentDispositionFilename:Et,contentLength:nt}=await x.getMetadata();if(!nt){const{length:Kt}=await x.getDownloadInfo();nt=Kt}return{...De,baseURL:A,filesize:nt,filename:Et||(0,ut.getPdfFilenameFromUrl)(se),metadata:Qe?.getRaw(),authors:Qe?.get("dc:creator"),numPages:x.numPages,URL:se}}class q{constructor(se){this._ready=(0,ut.loadScript)(se,!0).then(()=>window.pdfjsSandbox.QuickJSSandbox())}async createSandbox(se){(await this._ready).create(se)}async dispatchEventInSandbox(se){const A=await this._ready;setTimeout(()=>A.dispatchEvent(se),0)}async destroySandbox(){(await this._ready).nukeSandbox()}}},272:(p,Se,_e)=>{"use strict";const{addScriptSync:ut}=_e(706),{Constants:xt}=_e(852);ut(`${xt.PROTYLE_CDN}/js/pdf/pdf.js?v=3.5.141`,"pdfjsScript"),p.exports=window["pdfjs-dist/build/pdf"]},917:p=>{function Se(_e){return Promise.resolve().then(()=>{var ut=new Error("Cannot find module '"+_e+"'");throw ut.code="MODULE_NOT_FOUND",ut})}Se.keys=()=>[],Se.resolve=Se,Se.id=917,p.exports=Se}},Nt={};function Ye(p){var Se=Nt[p];if(Se!==void 0)return Se.exports;var _e=Nt[p]={exports:{}};return Mt[p].call(_e.exports,_e,_e.exports,Ye),_e.exports}Ye.n=p=>{var Se=p&&p.__esModule?()=>p.default:()=>p;return Ye.d(Se,{a:Se}),Se},Ye.d=(p,Se)=>{for(var _e in Se)Ye.o(Se,_e)&&!Ye.o(p,_e)&&Object.defineProperty(p,_e,{enumerable:!0,get:Se[_e]})},Ye.o=(p,Se)=>Object.prototype.hasOwnProperty.call(p,Se),Ye.r=p=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(p,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(p,"__esModule",{value:!0})};var eo={};(()=>{var ei,Oi,Ri,$s,Bi,Ps,Go,tf,zr,Bb,Ms,Yr,qb,ua,En,fa,qi,jo,Ko,nf,Gr,Fb,Zo,af,jr,Ub,Kr,Wb,Zr,Vb,Jr,zb,Xr,Yb,Qr,Gb,Nn,Jo,sf,Fi,Il,Xo,of,ec,jb,Qo,lf,tc,Kb,Ns,Ui,nc,Zb,el,rf,tl,cf,ac,Jb,ic,Xb,sc,Qb,nl,df,oc,ew,lc,tw,Hs,Vc,Wi,Dl,ti,Js,rc,nw,al,uf,il,ff,Os,zc,cc,aw,sl,pf,ol,gf,Vi,$l,zi,Pl,ll,hf,Rs,Qt,dc,iw,Yi,Ml,uc,sw,fc,ow,pc,lw,gc,rw,rl,mf,hc,cw,Gi,Nl,mc,dw,bc,uw,wc,fw,yc,pw,_c,gw,cl,bf,ni,Xs,Bs,Yc,qs,Gc,vc,hw,dl,wf,Ec,mw,Fs,kc,bw,Sc,ww,ul,Us,$a,fl,yf,Hn,pl,_f,gl,vf,Pa,On,Ma,ai,Ws,jc,hl,Ef,Vs,zs,Ys,Lc,yw,Cc,_w,ii,si,oi,bl,Gs,ji,js,Kc,wl,kf,yl,Sf,_l,Lf,vl,Cf,xc,vw,Ac,Ew,Na,Ki,El,xf,Zi,Ha,sn,Ji,kl,Sl,Ll,Tc,Xi,kn,li,Ic,kw,Dc,Sw,$c,Lw,Qi,Hl,Ks,Zc,Pc,Cw,Cl,Af,Mc,xw,Jn,Oa,xl,Tf,Nc,Aw,Hc,Tw,Al,If,Oc,Iw,Zs,Jc,Rc,Dw,Bc,$w,qc,Pw,Fc,Mw,Tl,Uc,Nw,Xu,$k,ri,Qs,Wc,Hw,Rn,Sn,ci;"use strict";var p=Ye(852);const Se=()=>([1e7].toString()+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,t=>(parseInt(t,10)^window.crypto.getRandomValues(new Uint32Array(1))[0]&15>>parseInt(t,10)/4).toString(16)),_e=(t,e)=>{if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let n=t,a=!1;for(;n&&!a&&!n.classList.contains("b3-typography");)n.nodeName.indexOf(e)===0?a=!0:n=n.parentElement;return a&&n},ut=(t,e,n=!1)=>{let a=A(t,e,n),i=!1,s=!1;for(;a&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"))&&!s;)i=A(a.parentElement,e,n),i?a=i:s=!0;return a||!1},xt=(t,e)=>{let n=_e(t,e),a=!1,i=!1;for(;n&&!n.classList.contains("protyle-wysiwyg")&&!i;)a=_e(n.parentElement,e),a?n=a:i=!0;return n||!1},Xe=(t,e,n,a=!1)=>{let i=q(t,e,n,a),s=!1,o=!1;for(;i&&!i.classList.contains("protyle-wysiwyg")&&!o;)s=q(i.parentElement,e,n,a),s?i=s:o=!0;return i||!1},q=(t,e,n,a=!1)=>{if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let i=t,s=!1;for(;i&&!s&&(a?i.tagName!=="BODY":!i.classList.contains("protyle-wysiwyg"));)typeof n=="string"&&i.getAttribute(e)?.split(" ").includes(n)||typeof n!="string"&&i.hasAttribute(e)?s=!0:i=i.parentElement;return s&&i},x=t=>{const e=q(t,"data-node-id",null);return e&&e.tagName!=="BUTTON"&&e.getAttribute("data-type")?.startsWith("Node")?e:!1},se=(t,e)=>{if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let n=t,a=!1;for(;n&&!a&&!n.classList.contains("protyle-wysiwyg");)n.nodeName===e?a=!0:n=n.parentElement;return a&&n},A=(t,e,n=!1)=>{if(!t)return!1;t.nodeType===3&&(t=t.parentElement);let a=t,i=!1;for(;a&&!i&&(n?a.tagName!=="BODY":!a.classList.contains("protyle-wysiwyg"));)a.classList?.contains(e)?i=!0:a=a.parentElement;return i&&a},De=t=>{let e=t;for(;e;){if(e.previousElementSibling&&e.previousElementSibling.getAttribute("data-node-id"))return e.previousElementSibling;const n=x(e.parentElement);if(n)e=n;else return!1}},Qe=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).reverse().find(n=>{if(!q(n.parentElement,"data-type","NodeBlockQueryEmbed"))return e=n,!0}),e||t},Et=t=>{let e;return Array.from(t.querySelectorAll("[data-node-id]")).find(n=>{if(!q(n.parentElement,"data-type","NodeBlockQueryEmbed")&&!n.classList.contains("li")&&!n.classList.contains("sb"))return e=n,!0}),e||t},nt=t=>{let e=t;for(;e;){if(e.nextElementSibling&&!e.nextElementSibling.classList.contains("protyle-attr"))return e.nextElementSibling;const n=x(e.parentElement);if(n)e=n;else return!1}return!1},Kt=t=>{let e=t;for(;e;)if(e.classList.contains("list")||e.classList.contains("li")||e.classList.contains("bq")||e.classList.contains("sb"))e=e.querySelector("[data-node-id]");else return e;return!1},ae=t=>!t||t.getAttribute("contenteditable")==="true"&&!t.classList.contains("protyle-wysiwyg")?t:t.querySelector('[contenteditable="true"]'),Ft=t=>["NodeBlockQueryEmbed","NodeThematicBreak","NodeMathBlock","NodeHTMLBlock","NodeIFrame","NodeWidget","NodeVideo","NodeAudio"].includes(t.getAttribute("data-type"))||t.getAttribute("data-type")==="NodeCodeBlock"&&t.classList.contains("render-node"),Ue=t=>{let e=t;for(;e.parentElement&&!e.parentElement.classList.contains("protyle-wysiwyg");)if(!e.parentElement.getAttribute("data-node-id"))e=e.parentElement;else{let n=!1;if(Array.from(e.parentElement.querySelectorAll('[contenteditable="true"]')).find(a=>{if(a.textContent.replace(p.Constants.ZWSP,"").replace(`
`,"")!=="")return n=!0,!0}),n||e.previousElementSibling?.getAttribute("data-node-id")||e.nextElementSibling?.getAttribute("data-node-id"))break;e=e.parentElement}return e},be=t=>{if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeBlockquote"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=be(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=be(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else{t=be(t);break}else if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)for(;!t.parentElement.classList.contains("protyle-wysiwyg");)if(t.parentElement.getAttribute("data-type")==="NodeList"&&t.parentElement.childElementCount===2)t=t.parentElement;else if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&t.parentElement.childElementCount===3)t=t.parentElement;else{t=be(t);break}return t},rt=t=>{let e=t.nextSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.nextSibling;else return e;return!1},Ke=t=>{let e=t.previousSibling;for(;e;)if(e.textContent===""&&e.nodeType===3)e=e.previousSibling;else return e;return!1},on=t=>{let e=t.nextElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.firstElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.nextElementSibling)e=e.parentElement;else{if(e.nextElementSibling.tagName==="LI")return e.nextElementSibling;if(e.nextElementSibling.tagName==="UL")return e.nextElementSibling.firstElementChild}return!1},Ra=t=>{let e=t.previousElementSibling;if(e)return e.tagName==="LI"?e:e.tagName==="UL"?e.lastElementChild:!1;for(e=t.parentElement;e.tagName==="UL";)if(!e.previousElementSibling)e=e.parentElement;else{if(e.previousElementSibling.tagName==="LI")return e.previousElementSibling;if(e.previousElementSibling.tagName==="UL"){const n=e.previousElementSibling.querySelectorAll(".b3-list-item");return n[n.length-1]}}return!1},te=require("electron"),V=()=>{const t=document.getElementById("message");t.innerHTML=`<div class="fn__flex-1"></div>
<button class="b3-button--cancel b3-button b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.clearMessage}"><svg style="margin-right: 0"><use xlink:href="#iconSelect"></use></svg></button>`,t.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(t);){if(n.classList.contains("b3-snackbar__close")){W(n.parentElement.getAttribute("data-id")),e.preventDefault();break}else if(n.isSameNode(t.lastElementChild)){n.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{n.parentElement.firstElementChild.innerHTML=""},p.Constants.TIMEOUT_INPUT),e.preventDefault();break}else{if(n.tagName==="A"||n.tagName==="BUTTON")break;if(n.classList.contains("b3-snackbar")){W(n.getAttribute("data-id")),e.preventDefault(),e.stopPropagation();break}}n=n.parentElement}})},M=(t,e=6e3,n="info",a)=>{const i=document.getElementById("message").firstElementChild;if(!i){alert(t);return}const s=a||Se(),o=i.querySelector(`.b3-snackbar[data-id="${s}"]`),l=t+(n==="error"?" v"+p.Constants.SIYUAN_VERSION:"");if(o){if(window.clearTimeout(parseInt(o.getAttribute("data-timeoutid"))),o.innerHTML=`<div class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${l}</div>${e===0?'<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>':""}`,n==="error"?o.classList.add("b3-snackbar--error"):o.classList.remove("b3-snackbar--error"),e>0){const c=window.setTimeout(()=>{W(s)},e);o.setAttribute("data-timeoutid",c.toString())}return}let r=`<div data-id="${s}" class="b3-snackbar--hide b3-snackbar${n==="error"?" b3-snackbar--error":""}"><div class="b3-snackbar__content${e===0?" b3-snackbar__content--close":""}">${l}</div>`;if(e===0)r+='<svg class="b3-snackbar__close"><use xlink:href="#iconCloseRound"></use></svg>';else if(e!==-1){const c=window.setTimeout(()=>{W(s)},e);r=r.replace("<div data-id",`<div data-timeoutid="${c}" data-id`)}return i.parentElement.classList.add("b3-snackbars--show"),i.insertAdjacentHTML("afterbegin",r+"</div>"),setTimeout(()=>{i.querySelectorAll(".b3-snackbar--hide").forEach(c=>{c.classList.remove("b3-snackbar--hide")})}),i.firstElementChild.nextElementSibling&&i.firstElementChild.nextElementSibling.innerHTML===i.firstElementChild.innerHTML&&i.firstElementChild.nextElementSibling.remove(),i.scrollTo({top:0,behavior:"smooth"}),s},W=t=>{const e=document.getElementById("message").firstElementChild;if(e)if(t){const n=e.querySelector(`[data-id="${t}"]`);n&&(n.classList.add("b3-snackbar--hide"),setTimeout(()=>{n.remove(),e.childElementCount===0&&W()},p.Constants.TIMEOUT_INPUT));let a=!1;Array.from(e.children).find(i=>{if(!i.classList.contains("b3-snackbar--hide"))return a=!0,!0}),a?e.parentElement.classList.add("b3-snackbars--show"):e.parentElement.classList.remove("b3-snackbars--show")}else e.parentElement.classList.remove("b3-snackbars--show"),setTimeout(()=>{e.innerHTML=""},p.Constants.TIMEOUT_INPUT)},Ee=t=>{t&&(window.siyuan.config.system.container==="ios"?window.location.href=t:at()?window.JSAndroid.openExternal(t):window.open(t))},ce=()=>at()?window.JSAndroid.readClipboard():navigator.clipboard.readText(),G=t=>{let e;getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0).cloneRange());try{if(at()){window.JSAndroid.writeClipboard(t);return}if(Bt()){window.webkit.messageHandlers.setClipboard.postMessage(t);return}navigator.clipboard.writeText(t)}catch{if(Bt())window.webkit.messageHandlers.setClipboard.postMessage(t);else if(at())window.JSAndroid.writeClipboard(t);else{const a=document.createElement("textarea");a.value=t,a.style.position="fixed",document.body.appendChild(a),a.focus(),a.select(),document.execCommand("copy"),document.body.removeChild(a),e&&Z(e)}}},ee=async t=>{t=t.replace(new RegExp(p.Constants.ZWSP,"g"),""),await G(t)},z=()=>et()?"touchstart":"click",O=t=>$e()?!!(t.metaKey&&!t.ctrlKey):!!(!t.metaKey&&t.ctrlKey),R=t=>!t.metaKey&&!t.ctrlKey,Y=()=>window.siyuan.config.system.osPlatform.toLowerCase().indexOf("huawei")>-1,et=()=>navigator.userAgent.indexOf("iPhone")>-1,ht=()=>navigator.userAgent.indexOf("iPad")>-1,$e=()=>navigator.platform.toUpperCase().indexOf("MAC")>-1,at=()=>window.siyuan.config.system.container==="android"&&window.JSAndroid,Bt=()=>window.siyuan.config.system.container==="ios"&&window.webkit?.messageHandlers,K=t=>{if($e())return t;const e=new Map(Object.entries({"\u2318":"Ctrl","\u2303":"Ctrl","\u21E7":"Shift","\u2325":"Alt","\u21E5":"Tab","\u232B":"Backspace","\u2326":"Delete","\u21A9":"Enter"})),n=[];(t.indexOf("\u2318")>-1||t.indexOf("\u2303")>-1)&&n.push(e.get("\u2318")),t.indexOf("\u21E7")>-1&&n.push(e.get("\u21E7")),t.indexOf("\u2325")>-1&&n.push(e.get("\u2325"));const a=t.replace(/⌘|⇧|⌥|⌃/g,"");return a&&n.push(e.get(a)||a),n.join("+")},di=t=>{w("/api/storage/getLocalStorage",void 0,e=>{window.siyuan.storage=e.data;const n={};n[p.Constants.LOCAL_SEARCHASSET]={keys:[],col:"",row:"",layout:0,method:0,types:{},sort:0,k:""},p.Constants.SIYUAN_ASSETS_SEARCH.forEach(a=>{n[p.Constants.LOCAL_SEARCHASSET].types[a]=!0}),n[p.Constants.LOCAL_SEARCHKEYS]={keys:[],replaceKeys:[],col:"",row:"",layout:0,colTab:"",rowTab:"",layoutTab:0},n[p.Constants.LOCAL_PDFTHEME]={light:"light",dark:"dark",annoColor:"var(--b3-pdf-background1)"},n[p.Constants.LOCAL_LAYOUTS]=[],n[p.Constants.LOCAL_AI]=[],n[p.Constants.LOCAL_PLUGINTOPUNPIN]=[],n[p.Constants.LOCAL_FILEPOSITION]={},n[p.Constants.LOCAL_DIALOGPOSITION]={},n[p.Constants.LOCAL_FLASHCARD]={fullscreen:!1},n[p.Constants.LOCAL_BAZAAR]={theme:"0",template:"0",icon:"0",widget:"0"},n[p.Constants.LOCAL_EXPORTWORD]={removeAssets:!1,mergeSubdocs:!1},n[p.Constants.LOCAL_EXPORTPDF]={landscape:!1,marginType:"0",scale:1,pageSize:"A4",removeAssets:!0,keepFold:!1,mergeSubdocs:!1,watermark:!1},n[p.Constants.LOCAL_EXPORTIMG]={keepFold:!1,watermark:!1},n[p.Constants.LOCAL_DOCINFO]={id:""},n[p.Constants.LOCAL_FONTSTYLES]=[],n[p.Constants.LOCAL_SEARCHDATA]={page:1,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},p.Constants.SIYUAN_DEFAULT_REPLACETYPES)},n[p.Constants.LOCAL_ZOOM]=1,[p.Constants.LOCAL_EXPORTIMG,p.Constants.LOCAL_SEARCHKEYS,p.Constants.LOCAL_PDFTHEME,p.Constants.LOCAL_BAZAAR,p.Constants.LOCAL_EXPORTWORD,p.Constants.LOCAL_EXPORTPDF,p.Constants.LOCAL_DOCINFO,p.Constants.LOCAL_FONTSTYLES,p.Constants.LOCAL_SEARCHDATA,p.Constants.LOCAL_ZOOM,p.Constants.LOCAL_LAYOUTS,p.Constants.LOCAL_AI,p.Constants.LOCAL_PLUGINTOPUNPIN,p.Constants.LOCAL_SEARCHASSET,p.Constants.LOCAL_FLASHCARD,p.Constants.LOCAL_DIALOGPOSITION,p.Constants.LOCAL_FILEPOSITION].forEach(a=>{if(typeof e.data[a]=="string")try{const i=JSON.parse(e.data[a]);typeof i=="number"?window.siyuan.storage[a]=i:window.siyuan.storage[a]=Object.assign(n[a],i)}catch{window.siyuan.storage[a]=n[a]}else typeof e.data[a]>"u"&&(window.siyuan.storage[a]=n[a])}),(!window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA].replaceTypes||Object.keys(window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA].replaceTypes).length===0)&&(window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA].replaceTypes=Object.assign({},p.Constants.SIYUAN_DEFAULT_REPLACETYPES)),t()})},pe=(t,e)=>{w("/api/storage/setLocalStorageVal",{app:p.Constants.SIYUAN_APPID,key:t,val:e})},Xn=t=>{if(t.cmd==="msg")return M(t.msg,t.data.closeTimeout,t.code===0?"info":"error",t.data.id),!1;if(t.cmd==="cmsg")return W(t.data.id),!1;if(t.cmd==="cprogress"){const e=document.getElementById("progress");return e&&e.remove(),!1}return t.cmd==="reloadui"?(t.data?.resetScroll&&(window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION]={},pe(p.Constants.LOCAL_FILEPOSITION,window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION])),It({cb(){window.location.reload()},errorExit:!1}),!1):t.code<0?(M(t.msg,t.data&&t.data.closeTimeout||0,t.code===-1?"error":"info"),!1):t};class ct{constructor(e){this.app=e.app,e.msgCallback&&this.connect(e)}connect(e){const n=`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/ws`,a=new WebSocket(`${n}?app=${p.Constants.SIYUAN_APPID}&id=${e.id}${e.type?"&type="+e.type:""}`);a.onopen=()=>{e.callback&&e.callback.call(this),document.getElementById("errorLog")&&(Jm(this.app,{upsertRootIDs:[],removeRootIDs:[]}),window.siyuan.dialogs.find(s=>{if(s.element.id==="errorLog")return s.destroy(),!0}))},a.onmessage=i=>{if(e.msgCallback){const s=Xn(JSON.parse(i.data));e.msgCallback.call(this,s)}},a.onclose=i=>{0<=i.reason.indexOf("unauthenticated")||0>i.reason.indexOf("close websocket")&&(console.warn("WebSocket is closed. Reconnect will be attempted in 3 second.",i),setTimeout(()=>{this.connect({id:e.id,type:e.type,msgCallback:e.msgCallback})},3e3))},a.onerror=i=>{i.target.url.endsWith("&type=main")&&i.target.readyState===3&&Qm()},this.ws=a}send(e,n,a=!1){this.ws&&(this.reqId=a?0:new Date().getTime(),this.ws.send(JSON.stringify({cmd:e,reqId:this.reqId,param:n})))}}var ze=Ye(706);const ke=(t,e,n,a=0,i=0)=>{t.style.top=n+"px",t.style.left=e+"px";const s=t.getBoundingClientRect();if(s.bottom>window.innerHeight||s.top<p.Constants.SIZE_TOOLBAR_HEIGHT){const o=n-s.height-a;o>p.Constants.SIZE_TOOLBAR_HEIGHT&&o+s.height<window.innerHeight?t.style.top=o+"px":o<=p.Constants.SIZE_TOOLBAR_HEIGHT?t.style.top=p.Constants.SIZE_TOOLBAR_HEIGHT+"px":t.style.top=Math.max(p.Constants.SIZE_TOOLBAR_HEIGHT,window.innerHeight-s.height)+"px"}s.right>window.innerWidth?t.style.left=`${window.innerWidth-s.width-i}px`:s.left<0&&(t.style.left="0")},pa=(t,e={})=>{const n={};Da(t,n),te.ipcRenderer.send(p.Constants.SIYUAN_OPEN_WINDOW,{position:e.position,width:e.width,height:e.height,url:`${window.location.protocol}//${window.location.host}/stage/build/app/window.html?v=${p.Constants.SIYUAN_VERSION}&json=${encodeURIComponent(JSON.stringify(n))}`}),t.parent.removeTab(t.id)},to=(t,e={})=>{w("/api/block/getBlockInfo",{id:t},n=>{if(n.code===3){M(n.msg);return}const a={title:n.data.rootTitle,docIcon:n.data.rootIcon,pin:!1,active:!0,instance:"Tab",action:"Tab",children:{notebookId:n.data.box,blockId:t,rootId:n.data.rootID,mode:"wysiwyg",instance:"Editor",action:n.data.rootID===t?p.Constants.CB_GET_SCROLL:p.Constants.CB_GET_ALL}};te.ipcRenderer.send(p.Constants.SIYUAN_OPEN_WINDOW,{position:e.position,width:e.width,height:e.height,url:`${window.location.protocol}//${window.location.host}/stage/build/app/window.html?v=${p.Constants.SIYUAN_VERSION}&json=${encodeURIComponent(JSON.stringify(a))}`})})};var I=Ye(314);const Ol=t=>{t.classList.add("protyle-wysiwyg--hl"),setTimeout(function(){t.classList.remove("protyle-wysiwyg--hl")},1024)},Ow=(t,e,n=!1)=>{let a;const i=t.wysiwyg.element;if(!t.preview.element.classList.contains("fn__none")){a=document.getElementById(e),a&&(t.preview.element.scrollTop=a.offsetTop,Ol(a));return}if(Array.from(i.querySelectorAll(`[data-node-id="${e}"]`)).find(s=>{if(!q(s,"data-type","block-render",!0))return a=s,!0}),a)return He(t,a,n),Ol(a),a;if(e===t.block.rootID&&t.options.render.title)return Ol(t.title.editElement),t.title.editElement},He=(t,e,n=!1,a="auto")=>{if(!t.disabled&&!n&&getSelection().rangeCount>0&&x(getSelection().getRangeAt(0).startContainer)){const r=t.contentElement,c=$n(r).top-r.getBoundingClientRect().top;let d=0;c<0?d=r.scrollTop+c:c>r.clientHeight-74&&(d=r.scrollTop+(c+74-r.clientHeight)),d!==0&&r.scroll({top:d,behavior:a});return}if(e||(e=x(re(t.wysiwyg.element).startContainer)),!e)return;let i=0,s=e;for(;s&&!s.classList.contains("protyle-wysiwyg");)i+=s.offsetTop,s=s.parentElement;let o=0,l=t.element.firstElementChild;for(;l&&!l.classList.contains("protyle-content");)o+=l.clientHeight,l=l.nextElementSibling;if(n){t.contentElement.scroll({top:i-o,behavior:a});return}t.contentElement.scrollTop>i-32?t.contentElement.scroll({top:i-o,behavior:a}):t.contentElement.scrollTop+t.contentElement.clientHeight<i+e.clientHeight-o&&t.contentElement.scroll({top:i+e.clientHeight-o-t.contentElement.clientHeight,behavior:a})},kt=require("path"),we=t=>t&&t.replace(/&/g,"&amp;").replace(/</g,"&lt;"),no=t=>t.replace(/</g,"&lt;"),Ba=t=>t.replace(/"/g,"&quot;").replace(/'/g,"&apos;"),qa=t=>t.replace(/"/g,"&quot;").replace(/'/g,"&apos;").replace(/</g,"&amp;lt;").replace(/&lt;/g,"&amp;lt;"),Df=()=>{const t=window.siyuan.emojis[(0,I.sZ)(0,window.siyuan.emojis.length-1)];return typeof t.items[(0,I.sZ)(0,t.items.length-1)]>"u"?"1f600":t.items[(0,I.sZ)(0,t.items.length-1)].unicode},ie=(t,e="",n=!1,a=!1)=>{if(!t)return"";let i="";if(t.indexOf(".")>-1)i=`<img class="${e}" ${a?"data-":""}src="/emojis/${t}"/>`;else try{t.split("-").forEach(s=>{s.length<5?i+=String.fromCodePoint(parseInt("0"+s,16)):i+=String.fromCodePoint(parseInt(s,16))}),n&&(i=`<span class="${e}">${i}</span>`)}catch{}return i},Rl=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-index");if((typeof a.isIntersecting>"u"?a.intersectionRatio!==0:a.isIntersecting)&&i){let s="";window.siyuan.emojis[parseInt(i)].items.forEach(o=>{s+=`<button data-unicode="${o.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?o.description_zh_cn:o.description}">
${ie(o.unicode)}</button>`}),a.target.innerHTML=s,a.target.removeAttribute("data-index")}})});t.querySelectorAll(".emojis__content").forEach(n=>{e.observe(n)})},ao=t=>{const e=new IntersectionObserver(n=>{n.forEach(a=>{const i=a.target.getAttribute("data-src");(typeof a.isIntersecting>"u"?a.intersectionRatio!==0:a.isIntersecting)&&i&&(a.target.src=i,a.target.removeAttribute("data-src"))})});t.querySelectorAll("img").forEach(n=>{e.observe(n)})},io=(t="",e)=>{let n="";const a=[];t&&(n=`<div class="emojis__title">${window.siyuan.languages.emoji}</div><div class="emojis__content">`);let i=0,s="";const o=[];window.siyuan.emojis.forEach((r,c)=>{t||(n+=`<div class="emojis__title" data-type="${c+1}">${window.siyuan.config.lang==="zh_CN"?r.title_zh_cn:r.title}</div><div style="min-height:${c===0?"28px":"336px"}" class="emojis__content"${c>1?' data-index="'+c+'"':""}>`),r.items.length===0&&c===0&&!t&&(n+=`<div style="margin-left: 4px">${window.siyuan.languages.setEmojiTip}</div>`),r.items.forEach(d=>{if(t){if(window.siyuan.config.editor.emoji.includes(d.unicode)&&(ie(d.unicode)===t||d.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||d.description.toLowerCase().indexOf(t.toLowerCase())>-1||d.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1)&&a.push(d),e&&i>e)return;(ie(d.unicode)===t||d.keywords.toLowerCase().indexOf(t.toLowerCase())>-1||d.description.toLowerCase().indexOf(t.toLowerCase())>-1||d.description_zh_cn.toLowerCase().indexOf(t.toLowerCase())>-1)&&(r.id==="custom"?o.push(d):s+=`<button data-unicode="${d.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?d.description_zh_cn:d.description}">
${ie(d.unicode,void 0,!1,!0)}</button>`,i++)}else window.siyuan.config.editor.emoji.includes(d.unicode)&&a.push(d),c<2&&(n+=`<button data-unicode="${d.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?d.description_zh_cn:d.description}">
${ie(d.unicode,void 0,!1,!0)}</button>`)}),t||(n+="</div>")}),t&&(o.sort((r,c)=>{const d=r.keywords.split("/"),u=c.keywords.split("/");return d[d.length-1].toLowerCase().indexOf(t.toLowerCase())<u[u.length-1].toLowerCase().indexOf(t.toLowerCase())?-1:0}).sort((r,c)=>{const d=r.keywords.split("/"),u=c.keywords.split("/");return d[d.length-1].toLowerCase().indexOf(t.toLowerCase())===u[u.length-1].toLowerCase().indexOf(t.toLowerCase())&&d[d.length-1].length<u[u.length-1].length?-1:0}).forEach(r=>{n+=`<button data-unicode="${r.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?r.description_zh_cn:r.description}">
${ie(r.unicode,void 0,!1,!0)}</button>`}),n=n+s+"</div>");let l="";return a.length>0&&(l=`<div class="emojis__title" data-type="0">${window.siyuan.languages.recentEmoji}</div><div class="emojis__content">`,window.siyuan.config.editor.emoji.forEach(r=>{const c=a.filter(d=>d.unicode===r);c[0]&&(l+=`<button data-unicode="${c[0].unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?c[0].description_zh_cn:c[0].description}">
${ie(c[0].unicode,void 0,!1,!0)}
</button>`)}),l+="</div>"),l+n===""?`<div class="emojis__title">${window.siyuan.languages.emptyContent}</div>`:l+n},ui=t=>{window.siyuan.config.editor.emoji.unshift(t),window.siyuan.config.editor.emoji.length>p.Constants.SIZE_UNDO&&window.siyuan.config.editor.emoji.pop(),window.siyuan.config.editor.emoji=Array.from(new Set(window.siyuan.config.editor.emoji)),w("/api/setting/setEmoji",{emoji:window.siyuan.config.editor.emoji})},fi=(t,e,n,a)=>{e!=="av"?window.siyuan.menus.menu.remove():window.siyuan.menus.menu.removeScrollEvent();const i=new me({disableAnimation:!0,transparent:!0,hideCloseIcon:!0,width:(0,I.tq)()?"80vw":"360px",height:"50vh",content:`<div class="emojis">
<div class="fn__flex">
    <span class="fn__space"></span>
    <label class="b3-form__icon fn__flex-1" style="overflow:initial;">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
    </label>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show fn__flex-center b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    <span class="fn__space"></span>
</div>
<div class="emojis__panel">${io()}</div>
<div class="fn__flex">
    <div data-type="0" class="emojis__type ariaLabel" aria-label="${window.siyuan.languages.recentEmoji}">${ie("2b50")}</div>
    <div data-type="1" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f527")}</div>
    <div data-type="2" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f60d")}</div>
    <div data-type="3" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f433")}</div>
    <div data-type="4" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f96a")}</div>
    <div data-type="5" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f3a8")}</div>
    <div data-type="6" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f3dd")}</div>
    <div data-type="7" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f52e")}</div>
    <div data-type="8" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("267e")}</div>
    <div data-type="9" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f6a9")}</div>
</div>
</div>`});i.element.querySelector(".b3-dialog__container").setAttribute("data-menu","true");const s=i.element.querySelector(".b3-dialog");s.style.justifyContent="inherit",s.style.alignItems="inherit",ke(i.element.querySelector(".b3-dialog__container"),n.x,n.y,n.h,n.w),i.element.querySelector(".emojis__item").classList.add("emojis__item--current");const o=i.element.querySelector(".b3-text-field"),l=i.element.querySelector(".emojis__panel");o.addEventListener("compositionend",()=>{l.innerHTML=io(o.value),o.value?l.nextElementSibling.classList.add("fn__none"):l.nextElementSibling.classList.remove("fn__none"),l.scrollTop=0,i.element.querySelector(".emojis__item")?.classList.add("emojis__item--current"),o.value===""&&Rl(i.element),ao(i.element)}),o.addEventListener("input",r=>{r.isComposing||(l.innerHTML=io(o.value),o.value?l.nextElementSibling.classList.add("fn__none"):l.nextElementSibling.classList.remove("fn__none"),l.scrollTop=0,i.element.querySelector(".emojis__item")?.classList.add("emojis__item--current"),o.value===""&&Rl(i.element),ao(i.element))}),o.addEventListener("keydown",r=>{if(r.isComposing||r.key.indexOf("Arrow")===-1&&r.key!=="Enter")return;const c=i.element.querySelector(".emojis__item--current");if(!c)return;if(r.key==="Enter"){const u=c.getAttribute("data-unicode");e==="notebook"?w("/api/notebook/setNotebookIcon",{notebook:t,icon:u},()=>{i.destroy(),ui(u),pi(u,t,"iconFilesRoot")}):e==="doc"?w("/api/attr/setBlockAttrs",{id:t,attrs:{icon:u}},()=>{i.destroy(),ui(u),pi(u,t),Bl(u,t)}):a(u),r.preventDefault(),r.stopPropagation();return}let d;if(r.key==="ArrowLeft"||r.key==="ArrowUp"?c.previousElementSibling?(c.classList.remove("emojis__item--current"),d=c.previousElementSibling,r.preventDefault(),r.stopPropagation()):c.parentElement.previousElementSibling?.previousElementSibling&&(c.classList.remove("emojis__item--current"),d=c.parentElement.previousElementSibling.previousElementSibling.lastElementChild,r.preventDefault(),r.stopPropagation()):(r.key==="ArrowRight"||r.key==="ArrowDown")&&(c.nextElementSibling?(c.classList.remove("emojis__item--current"),d=c.nextElementSibling,r.preventDefault(),r.stopPropagation()):c.parentElement.nextElementSibling?.nextElementSibling&&(c.classList.remove("emojis__item--current"),d=c.parentElement.nextElementSibling.nextElementSibling.firstElementChild,r.preventDefault(),r.stopPropagation())),d){d.classList.add("emojis__item--current");const u=o.clientHeight+6;d.offsetTop-u<l.scrollTop?l.scrollTop=d.offsetTop-u:d.offsetTop-u-l.clientHeight+d.clientHeight>l.scrollTop&&(l.scrollTop=d.offsetTop-u-l.clientHeight+d.clientHeight)}}),(0,I.tq)()||o.focus(),Rl(i.element),ao(i.element),i.element.addEventListener("click",r=>{const c=r.target,d=A(c,"emojis__type");if(d){const g=l.querySelector(`[data-type="${d.getAttribute("data-type")}"]`);if(g){const h=g.nextElementSibling.getAttribute("data-index");if(h){let m="";window.siyuan.emojis[parseInt(h)].items.forEach(b=>{m+=`<button data-unicode="${b.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?b.description_zh_cn:b.description}">
${ie(b.unicode)}</button>`}),g.nextElementSibling.innerHTML=m,g.nextElementSibling.removeAttribute("data-index")}l.scrollTo({top:g.offsetTop-34})}return}const u=A(c,"block__icon");if(u&&u.getAttribute("aria-label")===window.siyuan.languages.remove){e==="notebook"?w("/api/notebook/setNotebookIcon",{notebook:t,icon:""},()=>{i.destroy(),pi("",t,"iconFilesRoot")}):e==="doc"?w("/api/attr/setBlockAttrs",{id:t,attrs:{icon:""}},()=>{i.destroy(),pi("",t),Bl("",t)}):a("");return}const f=A(c,"emojis__item");if(f||u){let g="";f?(g=f.getAttribute("data-unicode"),e!=="av"&&i.destroy()):g=Df(),e==="notebook"?w("/api/notebook/setNotebookIcon",{notebook:t,icon:g},()=>{ui(g),pi(g,t,"iconFilesRoot")}):e==="doc"?w("/api/attr/setBlockAttrs",{id:t,attrs:{icon:g}},()=>{ui(g),pi(g,t),Bl(g,t)}):a(g);return}})},Bl=(t,e)=>{Pe().outline.forEach(n=>{n.blockId===e&&(n.headerElement.nextElementSibling.firstElementChild.outerHTML=ie(t||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0))})},pi=(t,e,n="iconFile")=>{let a;const i=St("file");if(i){const s=i.data.file;n==="iconFile"?a=s.element.querySelector(`[data-node-id="${e}"] .b3-list-item__icon`):a=s.element.querySelector(`[data-node-id="${e}"] .b3-list-item__icon`)||s.element.querySelector(`[data-url="${e}"] .b3-list-item__icon`)||s.closeElement.querySelector(`[data-url="${e}"] .b3-list-item__icon`)}a&&(a.innerHTML=ie(t||(n==="iconFile"?a.previousElementSibling.classList.contains("fn__hidden")?p.Constants.SIYUAN_IMAGE_FILE:p.Constants.SIYUAN_IMAGE_FOLDER:p.Constants.SIYUAN_IMAGE_NOTE))),n!=="iconFile"&&ha()},Qn=t=>{te.ipcRenderer.send(p.Constants.SIYUAN_OPEN_FOLDER,t)},Rw=()=>{const t=new URLSearchParams(window.location.search),e=t.get("url");let n="",a=!1;if(/^web\+siyuan:\/\/blocks\/\d{14}-\w{7}/.test(e))n=e.substring(20,20+22),a=(0,I.on)("focus",e)==="1";else if(window.JSAndroid){const i=window.JSAndroid.getBlockURL();n=so(i),a=(0,I.on)("focus",i)==="1"}else n=t.get("id"),a=t.get("focus")==="1";return{id:n,isZoomIn:a}},$f=t=>/^siyuan:\/\/blocks\/\d{14}-\w{7}/.test(t),so=t=>t.substring(16,16+22),Pf=(t=window.location.href)=>{const e=new URL(window.location.origin);e.pathname="/check-auth",e.searchParams.set("to",t),window.location.href=e.href},Bw=()=>{let t=document.getElementById("baseURL");t||(t=document.createElement("base"),t.id="baseURL"),t.setAttribute("href",location.origin),document.getElementsByTagName("head")[0].appendChild(t)},ft=(t,e=!0,n=!1)=>{let a=t;return e&&(a=Le().basename(t)),n&&a.endsWith(".sy")&&(a=a.substr(0,a.length-3)),a},Xc=t=>t.substring(7,t.length-Le().extname(t).length-23),es=t=>!t||(t=t.trim(),1>t.length)?!1:(t=t.toLowerCase(),t.startsWith("assets/")||t.startsWith("file://")||t.startsWith("\\\\")?!0:t.indexOf(":")===1),Le=()=>kt.posix?kt.posix:kt,qw=()=>kt,Qc=t=>{const e=[];return t.forEach(n=>{if(n.getAttribute("data-type")!=="navigation-root"){const a=n.getAttribute("data-path");e.find(s=>{if(a.startsWith(s.replace(".sy","")))return!0})||e.push(a)}}),e},ed=(t,e,n)=>{w("/api/filetree/moveDocs",{toNotebook:e,fromPaths:t,toPath:n})},ga=(t,e,n,a,i=!1)=>{if(window.siyuan.dialogs.find(f=>{if(f.element.querySelector("#foldList"))return f.destroy(),!0}))return;const o=new me({title:`${a||window.siyuan.languages.move}
<div style="max-height: 16px;overflow: auto;line-height: 14px;-webkit-mask-image: linear-gradient(to top, rgba(0, 0, 0, 0) 0, #000 6px);padding-bottom: 4px;margin-bottom: -4px" class="ft__smaller ft__on-surface fn__hidescrollbar"></div>`,content:`<div class="b3-form__icon" style="margin: 8px">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
    <input class="b3-text-field fn__block b3-form__icon-input" value="" placeholder="${window.siyuan.languages.search}">
</div>
<ul id="foldList" class="fn__flex-1 fn__none b3-list b3-list--background${(0,I.tq)()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></ul>
<div id="foldTree" class="fn__flex-1${(0,I.tq)()?" b3-list--mobile":""}" style="overflow: auto;position: relative"></div>
<div class="fn__hr"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"50vw",height:(0,I.tq)()?"80vh":"70vh",destroyCallback(){n&&Z(n)}});e&&e.length>0&&w("/api/filetree/getHPathsByPaths",{paths:e},f=>{o.element.querySelector(".b3-dialog__header .ft__smaller").innerHTML=we(f.data.join(" "))});const l=o.element.querySelector("#foldList"),r=o.element.querySelector("#foldTree");ha(f=>{let g="";f.forEach(h=>{if(!h.closed){let m="";i&&(m=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${h.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${h.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${h.flashcardCount}</span>`),g+=`<ul class="b3-list b3-list--background">
<li class="b3-list-item${g===""?" b3-list-item--focus":""}" data-path="/" data-box="${h.id}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${ie(h.icon||p.Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${we(h.name)}</span>
    ${m}
</li></ul>`}}),r.innerHTML=g},i);const c=o.element.querySelector(".b3-text-field");c.focus();const d=f=>{if(!(f&&f.isComposing)){if(c.value.trim()===""){l.classList.add("fn__none"),r.classList.remove("fn__none");return}r.classList.add("fn__none"),l.classList.remove("fn__none"),l.scrollTo(0,0),w("/api/filetree/searchDocs",{k:c.value,flashcard:i},g=>{let h="";g.data.forEach(m=>{let b="";i&&(b=`<span class="fn__flex-1"></span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${m.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${m.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${m.flashcardCount}</span>`),h+=`<li class="b3-list-item${h===""?" b3-list-item--focus":""}" data-path="${m.path}" data-box="${m.box}">
    ${ie(m.boxIcon||p.Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__showall" style="padding:4px 0">${we(m.hPath)}</span>
    ${b}
</li>`}),l.innerHTML=h})}};d(),c.addEventListener("compositionend",f=>{d(f)}),c.addEventListener("input",f=>{d(f)});const u=28;c.addEventListener("keydown",f=>{if(f.isComposing)return;const g=l.classList.contains("fn__none")?r:l,h=g.querySelectorAll(".b3-list-item--focus");if(h.length===0)return;let m=h[0];if(f.key.startsWith("Arrow")&&h.forEach((b,y)=>{y!==0&&b.classList.remove("b3-list-item--focus")}),l.classList.contains("fn__none")){if(f.key==="ArrowRight"&&!m.querySelector(".b3-list-item__arrow--open")&&!m.querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||f.key==="ArrowLeft"&&m.querySelector(".b3-list-item__arrow--open")){td(m,i),f.preventDefault();return}if(f.key==="ArrowLeft"){let b=m.parentElement.previousElementSibling;if(b){b.tagName!=="LI"&&(b=g.querySelector(".b3-list-item")),m.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus");const y=b.getBoundingClientRect(),_=g.getBoundingClientRect();(y.top<_.top||y.bottom>_.bottom)&&b.scrollIntoView(y.top<_.top)}return f.preventDefault(),!0}if(f.key==="ArrowDown"||f.key==="ArrowRight"){let b=m;for(;b;)if(b.nextElementSibling)if(b.nextElementSibling.classList.contains("fn__none"))b=b.nextElementSibling;else{b.nextElementSibling.tagName==="UL"?b=b.nextElementSibling.firstElementChild:b=b.nextElementSibling;break}else{if(b.parentElement.id==="foldTree")break;b=b.parentElement}if(b.classList.contains("b3-list-item")){m.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus");const y=b.getBoundingClientRect(),_=r.getBoundingClientRect();(y.top<_.top||y.bottom>_.bottom)&&b.scrollIntoView(y.top<_.top)}return f.preventDefault(),!0}if(f.key==="ArrowUp"){let b=m;for(;b;)if(b.previousElementSibling)if(b.previousElementSibling.classList.contains("fn__none"))b=b.previousElementSibling;else{if(b.previousElementSibling.tagName==="LI")b=b.previousElementSibling;else{const y=b.previousElementSibling.querySelectorAll(".b3-list-item");b=y[y.length-1]}break}else{if(b.parentElement.id==="foldTree")break;b=b.parentElement}if(b.classList.contains("b3-list-item")){m.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus");const y=b.getBoundingClientRect(),_=r.getBoundingClientRect();(y.top<_.top||y.bottom>_.bottom)&&b.scrollIntoView(y.top<_.top)}f.preventDefault()}}else{if(f.key==="ArrowDown"){m.classList.remove("b3-list-item--focus"),m.nextElementSibling?m.nextElementSibling.classList.add("b3-list-item--focus"):g.children[0].classList.add("b3-list-item--focus"),m=g.querySelector(".b3-list-item--focus"),(g.scrollTop<m.offsetTop-g.clientHeight+u||g.scrollTop>m.offsetTop)&&(g.scrollTop=m.offsetTop-g.clientHeight+u),f.preventDefault();return}if(f.key==="ArrowUp"){if(m.classList.remove("b3-list-item--focus"),m.previousElementSibling)m.previousElementSibling.classList.add("b3-list-item--focus");else{const b=g.children.length;g.children[b-1].classList.add("b3-list-item--focus")}m=g.querySelector(".b3-list-item--focus"),(g.scrollTop<m.offsetTop-g.clientHeight+u||g.scrollTop>m.offsetTop-u*2)&&(g.scrollTop=m.offsetTop-u*2),f.preventDefault();return}}if(f.key==="Enter"){const b=g.querySelectorAll(".b3-list-item--focus");if(b.length===0)return;const y=[],_=[];b.forEach(v=>{y.push(v.getAttribute("data-path")),_.push(v.getAttribute("data-box"))}),t(y,_),o.destroy(),f.preventDefault()}}),o.element.addEventListener("click",f=>{let g=f.target;for(;g&&!g.isEqualNode(o.element);){if(g.classList.contains("b3-list-item__toggle")){td(g.parentElement,i),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-button--text")){const m=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(m.length===0)return;const b=[],y=[];m.forEach(_=>{b.push(_.getAttribute("data-path")),y.push(_.getAttribute("data-box"))}),t(b,y),o.destroy(),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-button--cancel")){o.destroy(),f.preventDefault(),f.stopPropagation();break}else if(g.classList.contains("b3-list-item")){const m=(l.classList.contains("fn__none")?r:l).querySelectorAll(".b3-list-item--focus");if(m.length===0)return;a===window.siyuan.languages.specifyPath&&O(f)?m.length===1&&m[0].isSameNode(g)||g.classList.toggle("b3-list-item--focus"):(m[0].classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus")),g.getAttribute("data-path")==="/"&&td(g,i),f.preventDefault(),f.stopPropagation();break}g=g.parentElement}c.focus()})},td=(t,e)=>{const n=t.querySelector(".b3-list-item__arrow");if(n.classList.contains("b3-list-item__arrow--open")){n.classList.remove("b3-list-item__arrow--open"),t.nextElementSibling&&t.nextElementSibling.tagName==="UL"&&t.nextElementSibling.classList.add("fn__none");return}if(t.nextElementSibling&&t.nextElementSibling.tagName==="UL"){n.classList.add("b3-list-item__arrow--open"),t.nextElementSibling.classList.remove("fn__none");return}const a=t.getAttribute("data-box");w("/api/filetree/listDocsByPath",{notebook:a,path:t.getAttribute("data-path"),flashcard:e},i=>{if(i.data.path==="/"&&i.data.files.length===0){M(window.siyuan.languages.emptyContent);return}let s="";if(i.data.files.forEach(l=>{let r="";e?r=`<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardNewCard}">${l.newFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardReviewCard}">${l.dueFlashcardCount}</span>
<span class="counter counter--right b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.flashcardCard}">${l.flashcardCount}</span>`:l.count&&l.count>0&&(r=`<span class="popover__block counter b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.ref}">${l.count}</span>`),s+=`<li title="${ft(l.name,!0,!0)} ${l.hSize}${l.bookmark?`
`+window.siyuan.languages.bookmark+" "+l.bookmark:""}${l.name1?`
`+window.siyuan.languages.name+" "+l.name1:""}${l.alias?`
`+window.siyuan.languages.alias+" "+l.alias:""}${l.memo?`
`+window.siyuan.languages.memo+" "+l.memo:""}${l.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",l.subFileCount):""}
${window.siyuan.languages.modifiedAt} ${l.hMtime}
${window.siyuan.languages.createdAt} ${l.hCtime}" 
data-box="${a}" class="b3-list-item" data-path="${l.path}">
    <span style="padding-left: ${l.path.split("/").length*8}px" class="b3-list-item__toggle b3-list-item__toggle--hl${l.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${ie(l.icon||(l.subFileCount===0?p.Constants.SIYUAN_IMAGE_FILE:p.Constants.SIYUAN_IMAGE_FOLDER),"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${ft(l.name,!0,!0)}</span>
    ${r}
</li>`}),s==="")return;n.classList.add("b3-list-item__arrow--open"),t.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${s}</ul>`);const o=t.nextElementSibling;setTimeout(()=>{o.setAttribute("style",`height:${o.childElementCount*t.clientHeight}px;`),setTimeout(()=>{o.classList.remove("file-tree__sliderDown"),o.removeAttribute("style")},120)},2)})},ea=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.name,!0}),e},Fw=t=>{let e="";return window.siyuan.notebooks.find(n=>{if(n.id===t)return e=n.icon,!0}),e},Uw=(t,e)=>{window.siyuan.notebooks.find(n=>{if(n.id===t)return n.name=e,!0})},nd=()=>{let t=0;return window.siyuan.notebooks.forEach(e=>{e.closed||t++}),t},ha=(t,e=!1)=>{w("/api/notebook/lsNotebooks",{flashcard:e},n=>{e||(window.siyuan.notebooks=n.data.notebooks),t&&t(n.data.notebooks)})},ma=(t,e="outerHTML")=>{if(!t.querySelector("[data-type='block-render']"))return t[e];const n=t.cloneNode(!0);return n.querySelectorAll("span[data-render='1'][data-type='block-render']").forEach(a=>{a.innerHTML="",a.setAttribute("data-render","2")}),n[e]},Ww=t=>{const e=document.createElement("template");return e.innerHTML=t,e.content.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{A(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),e.innerHTML},ql=(t,e,n=!1)=>{if((0,I.tq)())return;const a=e.getBoundingClientRect();if(a.height===0||!t){hn();return}let i=document.getElementById("tooltip");i?i.innerHTML=t:(document.body.insertAdjacentHTML("beforeend",`<div class="tooltip" id="tooltip">${t}</div>`),i=document.getElementById("tooltip")),n?i.classList.add("tooltip--error"):i.classList.remove("tooltip--error"),e.getAttribute("data-inline-memo-content")?i.classList.add("tooltip--memo"):i.classList.remove("tooltip--memo");let s=a.left,o=a.bottom;const l=e.getAttribute("data-position"),r=e.parentElement.getBoundingClientRect();l==="right"?s=a.right-i.clientWidth:l?.endsWith("bottom")?o+=parseInt(l):l==="parentE"&&(o=r.top,s=r.right+8);const c=l==="parentE"?o:a.top,d=window.innerHeight-o;i.style.maxHeight=Math.max(c,d)+"px",o+i.clientHeight>window.innerHeight&&c>d?i.style.top=(l==="parentE"?r.bottom:a.top)-i.clientHeight+"px":i.style.top=o+"px",s+i.clientWidth>window.innerWidth?l==="parentE"?i.style.left=r.left-8-i.clientWidth+"px":i.style.left=window.innerWidth-i.clientWidth+"px":i.style.left=Math.max(0,s)+"px"},hn=()=>{const t=document.getElementById("tooltip");t&&t.remove()},Fl=(t,e)=>/\r\n|\r|\n|\u2028|\u2029|\t|\//.test(t)?(e?ql(window.siyuan.languages.fileNameRule,e,!0):M(window.siyuan.languages.fileNameRule),!1):t.length>p.Constants.SIZE_TITLE?(e?ql(window.siyuan.languages._kernel[106],e,!0):M(window.siyuan.languages._kernel[106]),!1):!0,mn=t=>t.replace(/\r\n|\r|\n|\u2028|\u2029|\t|\//g,"").substring(0,p.Constants.SIZE_TITLE),ad=t=>t.replace(/\\\\|\/|"|:|\*|\?|\\|'|<|>|\|/g,""),id=t=>{if(window.siyuan.config.readonly)return;const e=new me({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px",destroyCallback(){t.range&&Z(t.range)}}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.value=Lute.UnEscapeHTMLStr(t.name),n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(!Fl(n.value))return!1;if(n.value===t.name)return e.destroy(),!1;n.value.trim()===""?n.value="Untitled":n.value=mn(n.value),t.type==="notebook"?w("/api/notebook/renameNotebook",{notebook:t.notebookId,name:n.value},()=>{Uw(t.notebookId,n.value)}):w("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:n.value}),e.destroy()})},sd=t=>{const e=new me({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()});const i=Xc(t);n.value=i,n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{if(n.value===i||!n.value)return e.destroy(),!1;w("/api/asset/renameAsset",{oldPath:t,newName:n.value})})},Vw=t=>{if(getSelection().rangeCount===0)return;const e=getSelection().getRangeAt(0),n=x(e.startContainer);if(!n)return;let a=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));a.length===0&&(a=[n]);let i="",s=e.toString();if(s===""){if(s=a[0].textContent,a.forEach(o=>{i+=ma(o)}),!s)return}else{const o=document.createElement("div");o.appendChild(e.cloneContents()),i=o.innerHTML}s.length>10&&(s=s.substr(0,10)+"..."),s=mn(s),w("/api/filetree/createDoc",{notebook:t.notebookId,path:Le().join(ft(t.path,!1,!0),Lute.NewNodeID()+".sy"),title:s,md:t.lute.BlockDOM2StdMd(i)})},zw=t=>{let e="",n="";if(Pe().editor.find(a=>{const i=a.parent.headElement;if(i.classList.contains("item--focus")&&(e=a.editor.protyle.notebookId,t?n=a.editor.protyle.path:n=Le().dirname(a.editor.protyle.path),A(i,"layout__wnd--active")))return!0}),!e){const a=St("file").data.file;if(a instanceof xa){const i=a.element.querySelector(".b3-list-item--focus");if(i){const s=xt(i,"UL");s&&(e=s.getAttribute("data-url"));const o=i.getAttribute("data-path");t?n=o:n=Le().dirname(o)}}}return e||window.siyuan.notebooks.find(a=>{if(!a.closed)return e=a.id,n="/",!0}),{notebookId:e,currentPath:n}},gi=t=>{if(nd()===0){M(window.siyuan.languages.newFileTip);return}if(!t.notebookId){const e=zw(t.useSavePath);t.notebookId=e.notebookId,t.currentPath=e.currentPath}w("/api/filetree/getDocCreateSavePath",{notebook:t.notebookId},e=>{if(e.data.path.indexOf("/")>-1&&t.useSavePath||t.name)e.data.path.startsWith("/")||t.currentPath==="/"?w("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:Le().join(e.data.path,t.name||""),markdown:""},n=>{de({app:t.app,id:n.data,action:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT]})}):w("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.currentPath.endsWith(".sy")?t.currentPath:t.currentPath+".sy"},n=>{w("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:Le().join(n.data,e.data.path,t.name||""),parentID:ft(t.currentPath,!0,!0),markdown:""},a=>{de({app:t.app,id:a.data,action:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT]})})});else{let n=e.data.path||"Untitled";if(n=n.substring(n.lastIndexOf("/")+1),!Fl(n))return;const a=Lute.NewNodeID(),i=Le().join(ft(t.currentPath,!1,!0),a+".sy");t.paths&&(t.paths[t.paths.indexOf(void 0)]=i),w("/api/filetree/createDoc",{notebook:t.notebookId,path:i,title:n,md:"",sorts:t.paths},()=>{de({app:t.app,id:a,action:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT]})})}})},od=(t,e,n)=>{w("/api/filetree/getRefCreateSavePath",{notebook:e},a=>{a.data.path?a.data.path.startsWith("/")?n(ft(a.data.path,!1,!0)):w("/api/filetree/getHPathByPath",{notebook:e,path:t},i=>{n(ft(Le().join(i.data,a.data.path),!1,!0))}):w("/api/filetree/getHPathByPath",{notebook:e,path:t},i=>{n(ft(i.data,!1,!0))})})},ld=(t,e)=>{X(["dialog"]),gi({app:t,useSavePath:!0,name:mn(e.trim())||"Untitled"})},Ne=(t,e,n,a)=>{const i=new me({title:t,content:`<div class="b3-dialog__content">
    <div class="ft__breakword">${e}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text" id="confirmDialogConfirmBtn">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{a&&a(i),i.destroy()}),s[1].addEventListener("click",()=>{n&&n(i),i.destroy()})};class Yw{constructor(){this.wheelEvent="onwheel"in document.createElement("div")?"wheel":"mousewheel",this.element=document.getElementById("commonMenu"),this.element.querySelector(".b3-menu__title .b3-menu__label").innerHTML=window.siyuan.languages.back,this.element.addEventListener((0,I.tq)()?"click":"mouseover",e=>{const n=e.target;if((0,I.tq)()&&(A(n,"b3-menu__title")||typeof e.detail=="string"&&e.detail==="back")){const o=this.element.querySelectorAll(".b3-menu__item--show");o.length>0?o[o.length-1].classList.remove("b3-menu__item--show"):this.remove();return}const a=A(n,"b3-menu__item");if(!a||a.classList.contains("b3-menu__item--readonly"))return;const i=a.querySelector(".b3-menu__submenu");this.element.querySelectorAll(".b3-menu__item--show").forEach(s=>{!s.contains(a)&&!s.isSameNode(a)&&!a.contains(s)&&s.classList.remove("b3-menu__item--show")}),this.element.querySelectorAll(".b3-menu__item--current").forEach(s=>{s.classList.remove("b3-menu__item--current")}),a.classList.add("b3-menu__item--current"),i&&(a.classList.add("b3-menu__item--show"),this.element.classList.contains("b3-menu--fullscreen")||this.showSubMenu(i))})}showSubMenu(e){const n=e.parentElement.getBoundingClientRect();e.style.top=n.top-8+"px",e.style.left=n.right+8+"px",e.style.bottom="auto";const a=e.getBoundingClientRect();a.right>window.innerWidth&&(n.left-8>a.width?e.style.left=n.left-8-a.width+"px":e.style.left=window.innerWidth-a.width+"px"),a.bottom>window.innerHeight&&(e.style.top="auto",e.style.bottom="8px")}preventDefault(e){!A(e.target,"b3-menu")&&!A(e.target,"keyboard__bar")&&e.preventDefault()}addSeparator(e){return this.addItem({type:"separator",index:e})}addItem(e){const n=new S(e);return this.append(n.element,e.index),n.element}removeScrollEvent(){window.removeEventListener((0,I.tq)()?"touchmove":this.wheelEvent,this.preventDefault,!1)}remove(){window.siyuan.menus.menu.removeCB&&(window.siyuan.menus.menu.removeCB(),window.siyuan.menus.menu.removeCB=void 0),this.removeScrollEvent(),this.element.firstElementChild.classList.add("fn__none"),this.element.lastElementChild.innerHTML="",this.element.lastElementChild.removeAttribute("style"),this.element.classList.add("fn__none"),this.element.classList.remove("b3-menu--list","b3-menu--fullscreen"),this.element.removeAttribute("style"),window.siyuan.menus.menu.element.removeAttribute("data-name"),window.siyuan.menus.menu.element.removeAttribute("data-from")}append(e,n){if(e){if(typeof n=="number"){const a=this.element.querySelectorAll(".b3-menu__items > .b3-menu__separator")[n];if(a){a.before(e);return}}this.element.lastElementChild.append(e)}}popup(e){this.element.lastElementChild.innerHTML!==""&&(window.addEventListener((0,I.tq)()?"touchmove":this.wheelEvent,this.preventDefault,{passive:!1}),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.classList.remove("fn__none"),ke(this.element,e.x-(e.isLeft?window.siyuan.menus.menu.element.clientWidth:0),e.y,e.h,e.w))}fullscreen(e="all"){this.element.lastElementChild.innerHTML!==""&&(this.element.classList.add("b3-menu--fullscreen"),this.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.element.firstElementChild.classList.remove("fn__none"),this.element.classList.remove("fn__none"),window.addEventListener("touchmove",this.preventDefault,{passive:!1}),setTimeout(()=>{e==="bottom"?(this.element.style.transform="translateY(-50vh)",this.element.style.height="50vh"):this.element.style.transform="translateY(-100vh)"}),this.element.lastElementChild.scrollTop=0)}}class S{constructor(e){if(e.type==="empty"){this.element=document.createElement("div"),this.element.innerHTML=e.label,e.bind&&e.bind(this.element);return}if(this.element=document.createElement("button"),e.disabled&&this.element.setAttribute("disabled","disabled"),e.type==="separator"){this.element.classList.add("b3-menu__separator");return}if(this.element.classList.add("b3-menu__item"),e.current&&this.element.classList.add("b3-menu__item--selected"),e.click&&this.element.addEventListener("click",n=>{if(this.element.getAttribute("disabled"))return;let a=e.click(this.element,n);a instanceof Promise&&(a=!1),n.preventDefault(),n.stopImmediatePropagation(),n.stopPropagation(),this.element.parentElement&&!a&&window.siyuan.menus.menu.remove()}),e.id&&this.element.setAttribute("data-id",e.id),e.type==="readonly"&&this.element.classList.add("b3-menu__item--readonly"),e.element)this.element.append(e.element);else{let n=`<span class="b3-menu__label">${e.label}</span>`;typeof e.iconHTML=="string"?n=e.iconHTML+n:n=`<svg class="b3-menu__icon ${e.iconClass||""}" style="${e.icon==="iconClose"?"height:10px;":""}"><use xlink:href="#${e.icon||""}"></use></svg>${n}`,e.accelerator&&(n+=`<span class="b3-menu__accelerator">${K(e.accelerator)}</span>`),e.action&&(n+=`<svg class="b3-menu__action"><use xlink:href="#${e.action}"></use></svg>`),this.element.innerHTML=n}if(e.bind&&(this.element.classList.add("b3-menu__item--custom"),e.bind(this.element)),e.submenu){const n=document.createElement("div");n.classList.add("b3-menu__submenu"),n.innerHTML='<div class="b3-menu__items"></div>',e.submenu.forEach(a=>{n.firstElementChild.append(new S(a).element)}),this.element.insertAdjacentHTML("beforeend",'<svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>'),this.element.append(n)}}}const hi=(t,e)=>{let n=t;for(;n&&(n.classList.contains("b3-menu__separator")||n.classList.contains("b3-menu__item--readonly"))&&!n.querySelector(".b3-text-field");)e?n=n.nextElementSibling:n=n.previousElementSibling;return n},Gw=t=>{if(window.siyuan.menus.menu.element.classList.contains("fn__none")||t.altKey||t.shiftKey||t.ctrlKey||t.metaKey)return!1;const e=t.target;if(window.siyuan.menus.menu.element.contains(e)&&["INPUT","TEXTAREA"].includes(e.tagName))return!1;const n=p.Constants.KEYCODELIST[t.keyCode];if(n==="\u2193"||n==="\u2191"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");let i;if(a?(a.classList.remove("b3-menu__item--current","b3-menu__item--show"),n==="\u2191"?(i=hi(a.previousElementSibling,!1),i||(i=hi(a.parentElement.lastElementChild,!1))):(i=hi(a.nextElementSibling,!0),i||(i=hi(a.parentElement.firstElementChild,!0)))):n==="\u2191"?i=hi(window.siyuan.menus.menu.element.lastElementChild.lastElementChild,!1):i=hi(window.siyuan.menus.menu.element.lastElementChild.firstElementChild,!0),i){i.classList.add("b3-menu__item--current"),i.classList.remove("b3-menu__item--show");const s=i.parentElement.getBoundingClientRect(),o=i.getBoundingClientRect();(s.top>o.top||s.bottom<o.bottom)&&i.scrollIntoView(s.top>o.top)}return!0}else if(n==="\u2192"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(!a)return!0;const i=a.querySelector(".b3-menu__submenu");if(!i)return!0;a.classList.remove("b3-menu__item--current"),a.classList.add("b3-menu__item--show");const s=hi(i.firstElementChild.firstElementChild,!0);return s&&s.classList.add("b3-menu__item--current"),window.siyuan.menus.menu.showSubMenu(i),!0}else if(n==="\u2190"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__submenu .b3-menu__item--current");if(!a)return!0;const i=A(a,"b3-menu__item--show");return i&&(i.classList.remove("b3-menu__item--show"),i.classList.add("b3-menu__item--current"),a.classList.remove("b3-menu__item--current")),!0}else if(n==="\u21A9"){const a=window.siyuan.menus.menu.element.querySelector(".b3-menu__item--current");if(a){const i=a.querySelector(".b3-text-field"),s=a.querySelector(".b3-switch");if(i)return i.focus(),!0;s?s.click():a.dispatchEvent(new CustomEvent(z())),window.siyuan.menus.menu.remove()}else return!1;return!0}};class jw{constructor(){this.menus=[]}addSeparator(e){typeof e=="number"?this.menus.splice(e,0,{type:"separator"}):this.menus.push({type:"separator"})}addItem(e){typeof e.index=="number"?this.menus.splice(e.index,0,e):this.menus.push(e)}}const ts=require("fs"),mi=(t,e)=>{if(!document.getElementById(e)){const n=document.createElement("link");n.id=e,n.rel="stylesheet",n.type="text/css",n.href=t;const a=document.querySelector("#pluginsStyle");a?a.before(n):document.getElementsByTagName("head")[0].appendChild(n)}},ba=(t,e)=>{let n="";return t.forEach(a=>{typeof a=="string"?n+=`<option value="${a}" ${e===a?"selected":""}>${a}</option>`:n+=`<option value="${a.name}" ${e===a.name?"selected":""}>${a.label}</option>`}),n},Mf=()=>{w("/api/snippet/getSnippet",{type:"all",enabled:2},t=>{t.data.snippets.forEach(e=>{const n=`snippet${e.type==="css"?"CSS":"JS"}${e.id}`;let a=document.getElementById(n);if(!window.siyuan.config.snippet.enabledCSS&&e.type==="css"||!window.siyuan.config.snippet.enabledJS&&e.type==="js"){a&&a.remove();return}if(!e.enabled){a&&a.remove();return}if(a){if(a.innerHTML===e.content)return;a.remove()}e.type==="css"?document.head.insertAdjacentHTML("beforeend",`<style id="${n}">${e.content}</style>`):e.type==="js"&&(a=document.createElement("script"),a.type="text/javascript",a.text=e.content,a.id=n,document.head.appendChild(a))})})},Kw=()=>{w("/api/snippet/getSnippet",{type:"all",enabled:2},t=>{let e="",n="";t.data.snippets.forEach(s=>{s.type==="css"?e+=rd(s):n+=rd(s)});const a=new me({width:"70vw",height:"80vh",content:`<div class="layout-tab-bar fn__flex fn__flex-shrink" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
    <div data-type="css" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">CSS</span><span class="fn__flex-1"></span></div>
    <div data-type="js" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">JS</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1" style="overflow:auto;padding: 16px 24px">
    <div>
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
            <span aria-label="${window.siyuan.languages.addAttr} CSS" id="addCodeSnippetCSS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleCSS" class="b3-switch b3-switch--side fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledCSS?" checked":""}>
        </div>
        ${e}
    </div>
    <div class="fn__none">
        <div class="fn__flex">
            <div class="fn__flex-1"></div>
            <span aria-label="${window.siyuan.languages.addAttr} JS" id="addCodeSnippetJS" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            <input data-action="toggleJS" class="b3-switch b3-switch--side fn__flex-center" type="checkbox"${window.siyuan.config.snippet.enabledJS?" checked":""}>
        </div>
        ${n}
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback:s=>{s?.cancel!=="true"&&Hf(a,t.data.snippets,i,!0)}});t.data.snippets.forEach(s=>{const o=a.element.querySelector(`[data-id="${s.id}"] input`);o.value=s.name;const l=a.element.querySelector(`[data-id="${s.id}"] textarea`);l.textContent=s.content});const i=[];a.element.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isSameNode(a.element);){if(o.id==="addCodeSnippetCSS"||o.id==="addCodeSnippetJS"){o.parentElement.insertAdjacentHTML("afterend",rd({type:o.id==="addCodeSnippetCSS"?"css":"js",name:"",content:"",enabled:!1})),s.stopPropagation(),s.preventDefault();break}else if(o.classList.contains("b3-button--cancel")){a.destroy({cancel:"true"}),s.stopPropagation(),s.preventDefault();break}else if(o.classList.contains("b3-button--text")){Hf(a,t.data.snippets,i),s.stopPropagation(),s.preventDefault();break}else if(o.classList.contains("item")){o.getAttribute("data-type")==="css"?(o.classList.add("item--focus"),o.nextElementSibling.classList.remove("item--focus"),o.parentElement.nextElementSibling.firstElementChild.classList.remove("fn__none"),o.parentElement.nextElementSibling.lastElementChild.classList.add("fn__none")):(o.classList.add("item--focus"),o.previousElementSibling.classList.remove("item--focus"),o.parentElement.nextElementSibling.firstElementChild.classList.add("fn__none"),o.parentElement.nextElementSibling.lastElementChild.classList.remove("fn__none")),s.stopPropagation(),s.preventDefault();break}else if(o.dataset.action==="remove"){const l=o.parentElement.parentElement;i.push("#snippet"+(l.getAttribute("data-type")==="css"?"CSS":"JS")+l.getAttribute("data-id")),l.remove(),s.stopPropagation(),s.preventDefault();break}o=o.parentElement}})})},rd=t=>`<div data-id="${t.id||""}" data-type="${t.type}">
    <div class="fn__hr--b"></div>
    <div class="fn__flex">
        <input type="text" class="fn__size200 b3-text-field" placeholder="${window.siyuan.languages.title}">
        <div class="fn__flex-1"></div>
        <div class="fn__space"></div>
        <span aria-label="${window.siyuan.languages.remove}" data-action="remove" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
        <div class="fn__space"></div>
        <input data-type="snippet" class="b3-switch b3-switch--side fn__flex-center" type="checkbox"${t.enabled?" checked":""}>
    </div>
    <div class="fn__hr"></div>
    <textarea class="fn__block b3-text-field" placeholder="${window.siyuan.languages.codeSnippet}" style="resize: vertical;font-family:var(--b3-font-family-code)" spellcheck="false"></textarea>
    <div class="fn__hr--b"></div>
</div>`,Nf=(t,e,n)=>{w("/api/snippet/setSnippet",{snippets:e},()=>{n.forEach(a=>{const i=document.querySelector(a);i&&i.remove()}),window.siyuan.config.snippet.enabledCSS=t.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked,window.siyuan.config.snippet.enabledJS=t.element.querySelector('.b3-switch[data-action="toggleJS"]').checked,w("/api/setting/setSnippet",window.siyuan.config.snippet),Mf(),t.destroy({cancel:"true"})})},Hf=(t,e,n,a=!1)=>{const i=[];t.element.querySelectorAll("[data-id]").forEach(s=>{i.push({id:s.getAttribute("data-id"),name:s.querySelector("input").value,type:s.getAttribute("data-type"),content:s.querySelector("textarea").value,enabled:s.querySelector(".b3-switch").checked})}),(0,I.MK)(e,i)&&window.siyuan.config.snippet.enabledCSS===t.element.querySelector('.b3-switch[data-action="toggleCSS"]').checked&&window.siyuan.config.snippet.enabledJS===t.element.querySelector('.b3-switch[data-action="toggleJS"]').checked?t.destroy({cancel:"true"}):a?Ne(window.siyuan.languages.save,window.siyuan.languages.snippetsTip,()=>{Nf(t,i,n)}):Nf(t,i,n)},bn=(t,e)=>{let n="";switch(t){case"NodeDocument":n="iconFile";break;case"NodeThematicBreak":n="iconLine";break;case"NodeParagraph":n="iconParagraph";break;case"NodeHeading":e?n="icon"+e.toUpperCase():n="iconHeadings";break;case"NodeBlockquote":n="iconQuote";break;case"NodeList":e==="t"?n="iconCheck":e==="o"?n="iconOrderedList":n="iconList";break;case"NodeListItem":n="iconListItem";break;case"NodeCodeBlock":case"NodeYamlFrontMatter":n="iconCode";break;case"NodeTable":n="iconTable";break;case"NodeBlockQueryEmbed":n="iconSQL";break;case"NodeSuperBlock":n="iconSuper";break;case"NodeMathBlock":n="iconMath";break;case"NodeHTMLBlock":n="iconHTML5";break;case"NodeWidget":n="iconBoth";break;case"NodeIFrame":n="iconLanguage";break;case"NodeVideo":n="iconVideo";break;case"NodeAudio":n="iconRecord";break;case"NodeAttributeView":n="iconDatabase";break}return n},Ln=(t,e=p.Constants.PROTYLE_CDN,n=!1)=>{let a=[];t.getAttribute("data-subtype")==="math"?a=[t]:a=Array.from(t.querySelectorAll('[data-subtype="math"]')),a.length!==0&&(mi(`${e}/js/katex/katex.min.css?v=0.16.0`,"protyleKatexStyle"),(0,ze.addScript)(`${e}/js/katex/katex.min.js?v=0.16.0`,"protyleKatexScript").then(()=>{(0,ze.addScript)(`${e}/js/katex/mhchem.min.js?v=0.16.0`,"protyleKatexMhchemScript").then(()=>{a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true");let s=i;i.tagName==="DIV"&&(s=i.firstElementChild);let o={};try{o=(0,I.Qf)(window.siyuan.config.editor.katexMacros||"{}")}catch(l){console.warn("KaTex macros is not JSON",l)}try{s.innerHTML=window.katex.renderToString(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")),{displayMode:i.tagName==="DIV",output:"html",macros:o,trust:!0,strict:r=>r==="unicodeTextInMathMode"?"ignore":"warn"}),s.classList.remove("ft__error");const l=x(i);if(i.tagName==="DIV"){s.firstElementChild.setAttribute("contenteditable","false"),s.childElementCount<2&&s.insertAdjacentHTML("beforeend",`<span style="position: absolute;right: 0;top: 0;">${p.Constants.ZWSP}</span>`);const r=s.querySelectorAll(".base");r.length>0&&r[r.length-1].insertAdjacentHTML("afterend","<span class='fn__flex-1'></span>");const c=s.querySelector(".katex-html > .newline");c&&(c.parentElement.style.display="block")}else{l&&i.getBoundingClientRect().width>l.clientWidth?(i.style.maxWidth="100%",i.style.overflowX="auto",i.style.overflowY="hidden",i.style.display="inline-block"):(i.style.maxWidth="",i.style.overflowX="",i.style.overflowY="",i.style.display="");const r=rt(i);r?r&&r.nodeType!==3&&r.getAttribute("data-type")?.indexOf("inline-math")>-1?i.after(document.createTextNode(p.Constants.ZWSP)):r&&!r.textContent.startsWith(`
`)&&r.textContent!==p.Constants.ZWSP&&i.insertAdjacentHTML("beforeend","&#xFEFF;"):i.parentElement.tagName!=="TH"&&i.parentElement.tagName!=="TD"?i.insertAdjacentText("afterend",`
`):i.insertAdjacentText("afterend",p.Constants.ZWSP),i.previousSibling?.textContent.endsWith(`
`)?i.insertAdjacentText("beforebegin",p.Constants.ZWSP):!Ke(i)&&["TH","TD"].includes(i.parentElement.tagName)&&i.insertAdjacentText("afterbegin",p.Constants.ZWSP)}n&&setTimeout(()=>{if(i.tagName==="DIV"){const r=i.querySelector(".katex-display");r.clientWidth<r.scrollWidth&&r.firstElementChild.setAttribute("style",`font-size:${r.clientWidth*100/r.scrollWidth}%`)}else l&&i.offsetWidth>l.clientWidth&&i.firstElementChild.setAttribute("style",`font-size:${l.clientWidth*100/i.offsetWidth}%`)})}catch(l){s.innerHTML=l.message,s.classList.add("ft__error")}})})}))};class oo{constructor(e){this.click=e.click,this.ctrlClick=e.ctrlClick,this.altClick=e.altClick,this.shiftClick=e.shiftClick,this.rightClick=e.rightClick,this.toggleClick=e.toggleClick,this.element=e.element,this.blockExtHTML=e.blockExtHTML,this.topExtHTML=e.topExtHTML,this.updateData(e.data),this.bindEvent()}updateData(e){this.data=e,!this.data||this.data.length===0?this.element.innerHTML=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`:(this.element.innerHTML=this.genHTML(this.data),Ln(this.element))}genHTML(e){let n=`<ul${e[0].depth===0?" class='b3-list b3-list--background'":""}>`;return e.forEach(a=>{let i="",s='<svg class="b3-list-item__graphic"><use xlink:href="#iconFolder"></use></svg>';a.type==="bookmark"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconBookmark"></use></svg>':a.type==="tag"?s='<svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg>':a.type==="backlink"?(i=` aria-label="${qa(a.hPath)}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}"><use xlink:href="#${bn(a.nodeType,a.subType)}"></use></svg>`):a.type==="outline"&&(i=` aria-label="${qa(Lute.BlockDOM2Content(a.name))}"`,s=`<svg class="b3-list-item__graphic popover__block" data-id="${a.id}" style="height: 22px;width: 10px;"><use xlink:href="#${bn(a.nodeType,a.subType)}"></use></svg>`);let o="";a.count&&(o=`<span class="counter">${a.count}</span>`);const l=a.children&&a.children.length>0||a.blocks&&a.blocks.length>0;let r="";(0,I.tq)()?a.depth>0&&(r=`padding-left: ${(a.depth-1)*20+24}px`):r=`padding-left: ${(a.depth-1)*18+22}px;margin-right: 2px`;const c=l||a.type==="backlink"&&!(0,I.tq)();n+=`<li class="b3-list-item${(0,I.tq)()?"":" b3-list-item--hide-action"}" 
${a.id?'data-node-id="'+a.id+'"':""} 
${a.box?'data-notebook-id="'+a.box+'"':""} 
data-treetype="${a.type}" 
data-type="${a.nodeType}" 
data-subtype="${a.subType}" 
${a.label?"data-label='"+a.label+"'":""}>
    <span style="${r}" class="b3-list-item__toggle${c?" b3-list-item__toggle--hl":""}${c?"":" fn__hidden"}">
        <svg data-id="${encodeURIComponent(a.name+a.depth)}" class="b3-list-item__arrow${l?" b3-list-item__arrow--open":""}"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${s}
    <span class="b3-list-item__text ariaLabel" data-position="parentE"${i}>${a.name}</span>
    ${this.topExtHTML||""}
    ${o}
</li>`,a.children&&a.children.length>0&&(n+=this.genHTML(a.children)+"</ul>"),a.blocks&&a.blocks.length>0&&(n+=this.genBlockHTML(a.blocks,!0,a.type)+"</ul>")}),n}genBlockHTML(e,n=!1,a){let i=`<ul class="${n?"":"fn__none"}">`;return e.forEach(s=>{let o="";s.count&&(o=`<span class="counter">${s.count}</span>`);let l;a==="outline"?l=`<svg data-defids='["${s.defID}"]' class="b3-list-item__graphic popover__block" data-id="${s.id}" style="height: 22px;width: 10px;"><use xlink:href="#${bn(s.type,s.subType)}"></use></svg>`:s.type==="NodeDocument"?l=`<span data-defids='["${s.defID}"]' class="b3-list-item__graphic popover__block" data-id="${s.id}">${ie(s.ial.icon||p.Constants.SIYUAN_IMAGE_FILE)}</span>`:l=`<svg data-defids='["${s.defID}"]' class="b3-list-item__graphic popover__block" data-id="${s.id}"><use xlink:href="#${bn(s.type,s.subType)}"></use></svg>`;let r="";(0,I.tq)()?s.depth>0&&(r=`padding-left: ${(s.depth-1)*20+24}px`):r=`padding-left: ${(s.depth-1)*18+22}px;margin-right: 2px`,i+=`<li class="b3-list-item${(0,I.tq)()?"":" b3-list-item--hide-action"}"  
data-node-id="${s.id}" 
data-ref-text="${encodeURIComponent(s.refText)}" 
data-def-id="${s.defID}" 
data-type="${s.type}" 
data-subtype="${s.subType}" 
data-treetype="${a}" 
data-def-path="${s.defPath}">
    <span style="${r}" class="b3-list-item__toggle${s.children?" b3-list-item__toggle--hl":""}${s.children?"":" fn__hidden"}">
        <svg data-id="${s.id}" class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${l}
    <span class="b3-list-item__text ariaLabel" data-position="parentE" ${a==="outline"?' aria-label="'+qa(Lute.BlockDOM2Content(s.content))+'"':""}>${s.content}</span>
    ${o}
    ${this.blockExtHTML||""}
</li>`,s.children&&s.children.length>0&&(i+=this.genBlockHTML(s.children,!1,a)+"</ul>")}),i}toggleBlocks(e){if(this.toggleClick){this.toggleClick(e);return}if(!e.nextElementSibling)return;const n=e.firstElementChild.firstElementChild;n.classList.contains("b3-list-item__arrow--open")?(n.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling.classList.add("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-list-item__arrow--open"),e.nextElementSibling.classList.remove("fn__none"),e.nextElementSibling.nextElementSibling&&e.nextElementSibling.nextElementSibling.tagName==="UL"&&e.nextElementSibling.nextElementSibling.classList.remove("fn__none"))}setCurrent(e){e.classList.contains("b3-list--empty")||(this.element.querySelectorAll("li").forEach(n=>{n.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus"))}bindEvent(){this.element.addEventListener("contextmenu",e=>{let n=e.target;for(;n&&!n.isEqualNode(this.element);){if(n.tagName==="LI"&&this.rightClick){this.rightClick(n,e),e.preventDefault(),e.stopPropagation();break}n=n.parentElement}}),this.element.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(this.element);){if(n.classList.contains("b3-list-item__toggle")&&!n.classList.contains("fn__hidden")){this.toggleBlocks(n.parentElement),this.setCurrent(n.parentElement),e.preventDefault();break}if(n.classList.contains("b3-list-item__action")&&this.click){const a=se(n,"LI");a&&this.click(a,e),e.preventDefault(),e.stopPropagation();break}else if(n.tagName==="LI"){this.setCurrent(n),n.getAttribute("data-node-id")||n.getAttribute("data-treetype")==="tag"?(this.ctrlClick&&window.siyuan.ctrlIsPressed?this.ctrlClick(n):this.altClick&&window.siyuan.altIsPressed?this.altClick(n):this.shiftClick&&window.siyuan.shiftIsPressed?this.shiftClick(n):this.click&&this.click(n,e),e.stopPropagation()):this.toggleBlocks(n),e.preventDefault();break}n=n.parentElement}}),this.element.addEventListener("dragstart",e=>{const n=_e(e.target,"LI");n&&(e.dataTransfer.setData("text/html",n.outerHTML),n.style.opacity="0.1",window.siyuan.dragElement=n)}),this.element.addEventListener("dragend",e=>{const n=_e(e.target,"LI");n&&(n.style.opacity="1"),window.siyuan.dragElement=void 0})}expandAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.remove("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.add("b3-list-item__arrow--open")})}collapseAll(){this.element.querySelectorAll("ul").forEach(e=>{e.classList.contains("b3-list")||e.classList.add("fn__none")}),this.element.querySelectorAll(".b3-list-item__arrow").forEach(e=>{e.classList.remove("b3-list-item__arrow--open")})}getExpandIds(){const e=[];return this.element.querySelectorAll(".b3-list-item__arrow--open").forEach(n=>{e.push(n.getAttribute("data-id"))}),e}setExpandIds(e){this.element.querySelectorAll(".b3-list-item__arrow").forEach(n=>{e.includes(n.getAttribute("data-id"))?(n.classList.add("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.classList.remove("fn__none")):(n.classList.remove("b3-list-item__arrow--open"),n.parentElement.parentElement.nextElementSibling&&n.parentElement.parentElement.nextElementSibling.tagName==="UL"&&n.parentElement.parentElement.nextElementSibling.classList.add("fn__none"))})}}const wa=()=>`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`,Of=(t,e=p.Constants.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="abc"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="abc"]')),n.length!==0&&n.length>0&&(0,ze.addScript)(`${e}/js/abcjs/abcjs-basic-min.js?v=6.2.2`,"protyleAbcjsScript").then(()=>{n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",wa()),a.childElementCount<4&&a.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${p.Constants.ZWSP}</span>`);const i=a.firstElementChild.nextElementSibling;window.ABCJS.renderAbc(i,Lute.UnEscapeHTMLStr(a.getAttribute("data-content")),{responsive:"resize"}),i.setAttribute("contenteditable","false"),a.setAttribute("data-render","true")})})},Rf=(t,e=p.Constants.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="echarts"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="echarts"]')),n.length!==0&&n.length>0&&(0,ze.addScript)(`${e}/js/echarts/echarts.min.js?v=5.3.2`,"protyleEchartsScript").then(()=>{(0,ze.addScript)(`${e}/js/echarts/echarts-gl.min.js?v=2.0.9`,"protyleEchartsGLScript").then(()=>{let a;if(n[0].firstElementChild.clientWidth===0){const i=A(n[0],"layout-tab-container",!0);i&&Array.from(i.children).find(s=>{if(s.classList.contains("protyle")&&!s.classList.contains("fn__none"))return a=s.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}n.forEach(async i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",wa());const s=i.firstElementChild.nextElementSibling;try{s.style.height=i.style.height;const o=await(0,I.Qf)(Lute.UnEscapeHTMLStr(i.getAttribute("data-content")));window.echarts.init(s,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption(o),i.setAttribute("data-render","true"),s.classList.remove("ft__error"),s.textContent.endsWith(p.Constants.ZWSP)||s.firstElementChild.insertAdjacentText("beforeend",p.Constants.ZWSP)}catch(o){window.echarts.dispose(s),s.classList.add("ft__error"),s.innerHTML=`echarts render error: <br>${o}`}})})})},Bf=(t,e=p.Constants.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="graphviz"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="graphviz"]')),n.length!==0&&(0,ze.addScript)(`${e}/js/graphviz/viz.js?v=0.0.0`,"protyleGraphVizScript").then(()=>{n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",wa());const i=a.firstElementChild.nextElementSibling;try{const s=new Blob([`importScripts('${document.getElementById("protyleGraphVizScript").src.replace("viz.js","full.render.js")}');`],{type:"application/javascript"}),l=(window.URL||window.webkitURL).createObjectURL(s),r=new Worker(l);new Viz({worker:r}).renderSVGElement(Lute.UnEscapeHTMLStr(a.getAttribute("data-content"))).then(c=>{i.innerHTML=c.outerHTML,i.classList.remove("ft__error"),i.setAttribute("contenteditable","false"),a.textContent.endsWith(p.Constants.ZWSP)||a.insertAdjacentHTML("beforeend",`<span style="position: absolute">${p.Constants.ZWSP}</span>`)}).catch(c=>{i.innerHTML=`graphviz render error: <br>${c}`,i.classList.add("ft__error")})}catch(s){console.error("Graphviz error",s)}a.setAttribute("data-render","true")})})},qf=(t,e=p.Constants.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mermaid"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mermaid"]')),n.length!==0&&(0,ze.addScript)(`${e}/js/mermaid/mermaid.min.js?v=10.3.0`,"protyleMermaidScript").then(()=>{const a={securityLevel:"loose",altFontFamily:"sans-serif",fontFamily:"sans-serif",startOnLoad:!1,flowchart:{htmlLabels:!0,useMaxWidth:!0},sequence:{useMaxWidth:!0,diagramMarginX:8,diagramMarginY:8,boxMargin:8,showSequenceNumbers:!0},gantt:{leftPadding:75,rightPadding:20}};if(window.siyuan.config.appearance.mode===1&&(a.theme="dark"),window.mermaid.initialize(a),n[0].firstElementChild.clientWidth===0){const i=q(n[0],"fold","1");if(!i)return;const s=new MutationObserver(()=>{Ff(n),s.disconnect()});s.observe(i,{attributeFilter:["fold"]})}else Ff(n)})},Ff=t=>{t.forEach((e,n)=>{if(e.getAttribute("data-render")==="true")return;e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",`<div class="protyle-icons">
    <span aria-label="${window.siyuan.languages.edit}" class="b3-tooltips__sw b3-tooltips protyle-icon protyle-icon--first protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__sw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>`);const a=e.firstElementChild.nextElementSibling;a.removeAttribute("data-processed"),a.textContent=Lute.UnEscapeHTMLStr(e.getAttribute("data-content")),setTimeout(()=>{window.mermaid.init(void 0,a)},p.Constants.TIMEOUT_LOAD*n),e.setAttribute("data-render","true"),a.setAttribute("contenteditable","false"),e.textContent.endsWith(p.Constants.ZWSP)||e.insertAdjacentHTML("beforeend",`<span style="position: absolute">${p.Constants.ZWSP}</span>`)})},Uf=(t,e=p.Constants.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="mindmap"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="mindmap"]')),n.length!==0&&(0,ze.addScript)(`${e}/js/echarts/echarts.min.js?v=0.0.0`,"protyleEchartsScript").then(()=>{let a;if(n[0].firstElementChild.clientWidth===0){const i=A(n[0],"layout-tab-container",!0);i&&Array.from(i.children).find(s=>{if(s.classList.contains("protyle")&&!s.classList.contains("fn__none")&&s.querySelector(".protyle-wysiwyg").firstElementChild)return a=s.querySelector(".protyle-wysiwyg").firstElementChild.clientWidth,!0})}n.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.firstElementChild.classList.contains("protyle-icons")||i.insertAdjacentHTML("afterbegin",wa());const s=i.firstElementChild.nextElementSibling;try{s.style.height=i.style.height,window.echarts.init(s,window.siyuan.config.appearance.mode===1?"dark":void 0,{width:a}).setOption({series:[{data:[JSON.parse(Lute.EChartsMindmapStr(Lute.UnEscapeHTMLStr(i.getAttribute("data-content"))))],initialTreeDepth:-1,itemStyle:{borderWidth:0,color:"#4285f4"},label:{backgroundColor:"#f6f8fa",borderColor:"#d1d5da",borderRadius:6,borderWidth:.5,color:"#586069",lineHeight:20,offset:[-5,0],padding:[0,5],position:"insideRight"},lineStyle:{color:"#d1d5da",width:1},roam:!0,symbol:(o,l)=>l?.data?.children?"circle":"path://",type:"tree"}],tooltip:{trigger:"item",triggerOn:"mousemove"},backgroundColor:"transparent"}),i.setAttribute("data-render","true"),s.textContent.endsWith(p.Constants.ZWSP)||s.firstElementChild.insertAdjacentText("beforeend",p.Constants.ZWSP),s.classList.remove("ft__error")}catch(o){s.classList.add("ft__error"),s.innerHTML=`Mindmap render error: <br>${o}`}})})},Wf=(t,e=p.Constants.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="flowchart"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="flowchart"]')),n.length!==0&&(0,ze.addScript)(`${e}/js/flowchart.js/flowchart.min.js?v=0.0.0`,"protyleFlowchartScript").then(()=>{if(n[0].firstElementChild.clientWidth===0){const a=q(n[0],"fold","1");if(!a)return;const i=new MutationObserver(()=>{Vf(n),i.disconnect()});i.observe(a,{attributeFilter:["fold"]})}else Vf(n)})},Vf=t=>{t.forEach(e=>{if(e.getAttribute("data-render")==="true")return;e.getAttribute("data-node-id")&&(e.firstElementChild.classList.contains("protyle-icons")||e.insertAdjacentHTML("afterbegin",wa()),e.childElementCount<4&&e.lastElementChild.insertAdjacentHTML("beforebegin",`<span style="position: absolute">${p.Constants.ZWSP}</span>`));const n=e.firstElementChild.nextElementSibling||e.firstElementChild,a=flowchart.parse(Lute.UnEscapeHTMLStr(e.getAttribute("data-content")));n.innerHTML="";try{a.drawSVG(n)}catch(i){n.classList.add("ft__error"),n.innerHTML=`Flow Chart render error: <br>${i}`}n.setAttribute("contenteditable","false"),e.setAttribute("data-render","true")})},zf=(t,e=p.Constants.PROTYLE_CDN)=>{let n=[];t.getAttribute("data-subtype")==="plantuml"?n=[t]:n=Array.from(t.querySelectorAll('[data-subtype="plantuml"]')),n.length!==0&&(0,ze.addScript)(`${e}/js/plantuml/plantuml-encoder.min.js?v=0.0.0`,"protylePlantumlScript").then(()=>{n.forEach(a=>{if(a.getAttribute("data-render")==="true")return;a.firstElementChild.classList.contains("protyle-icons")||a.insertAdjacentHTML("afterbegin",wa());const i=a.firstElementChild.nextElementSibling;try{i.innerHTML=`<img src=${window.siyuan.config.editor.plantUMLServePath}${window.plantumlEncoder.encode(Lute.UnEscapeHTMLStr(a.getAttribute("data-content")))}">`,i.classList.remove("ft__error"),a.setAttribute("data-render","true")}catch(s){i.classList.add("ft__error"),i.innerHTML=`plantuml render error: <br>${s}`}})})},Yf=t=>{let e=[];t.getAttribute("data-type")==="NodeHTMLBlock"?e=[t]:e=Array.from(t.querySelectorAll('[data-type="NodeHTMLBlock"]')),e.length!==0&&e.length>0&&e.forEach(n=>{n.firstElementChild.firstElementChild.setAttribute("aria-label",window.siyuan.languages.edit),n.firstElementChild.lastElementChild.setAttribute("aria-label",window.siyuan.languages.more)})},Zw=(t,e)=>{const n=document.createElement("div");n.innerHTML=t;let a=!1;if((n.childElementCount===1&&n.lastElementChild.style.fontFamily.indexOf("monospace")>-1||n.childElementCount===1&&n.querySelectorAll("pre").length===1||t.indexOf(`
<p class="p1">`)===0||n.childElementCount===1&&n.firstElementChild.tagName==="TABLE"&&n.querySelector(".line-number")&&n.querySelector(".line-content"))&&(a=!0),a){let i=e||t;return/\n/.test(i)?`<div data-type="NodeCodeBlock" class="code-block" data-node-id="${Lute.NewNodeID()}"><div class="protyle-action"><span class="protyle-action--first protyle-action__language" contenteditable="false">${window.siyuan.storage[p.Constants.LOCAL_CODELANG]}</span><span class="fn__flex-1"></span><span aria-label="${window.siyuan.languages.copy}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--first protyle-action__copy"><svg><use xlink:href="#iconCopy"></use></svg></span><span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-icon--last protyle-action__menu"><svg><use xlink:href="#iconMore"></use></svg></span></div><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${i.replace(/&/g,"&amp;").replace(/</g,"&lt;")}<wbr></div><div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`:(i=i.replace("<","&lt;").replace(">","&gt;"),"`"+i+"`")}return!1},bt=t=>{const e=t.getAttribute("data-subtype");if(!["abc","plantuml","mermaid","flowchart","echarts","mindmap","graphviz","math"].includes(e)||t.getAttribute("data-type")!=="NodeHTMLBlock"){Of(t),Yf(t),zf(t),qf(t),Wf(t),Rf(t),Uf(t),Bf(t),Ln(t);return}e==="abc"?Of(t):e==="plantuml"?zf(t):e==="mermaid"?qf(t):e==="flowchart"?Wf(t):e==="echarts"?Rf(t):e==="mindmap"?Uf(t):e==="graphviz"?Bf(t):e==="math"?Ln(t):t.getAttribute("data-type")==="NodeHTMLBlock"&&Yf(t)};class At{constructor(e,n){if(this.menu=window.siyuan.menus.menu,this.isOpen=!1,this.element=this.menu.element,e){const a=this.menu.element.getAttribute("data-name");a&&a===e&&(this.isOpen=!0)}this.menu.remove(),this.isOpen||(this.menu.element.setAttribute("data-name",e),this.menu.removeCB=n)}showSubMenu(e){this.menu.showSubMenu(e)}addItem(e){if(!this.isOpen)return this.menu.addItem(e)}addSeparator(e){if(!this.isOpen)return this.menu.addSeparator(e)}open(e){this.isOpen||this.menu.popup(e)}fullscreen(e="all"){this.isOpen||this.menu.fullscreen(e)}close(){this.menu.remove()}}const Gf=(t,e)=>{if(t.includes("\u2303")){if(!e.ctrlKey)return!1}else if($e()?e.ctrlKey:t.includes("\u2318")?!e.ctrlKey:e.ctrlKey)return!1;if(t.includes("\u2325")){if(!e.altKey)return!1}else if(e.altKey)return!1;if(t.includes("\u21E7")){if(!e.shiftKey)return!1}else if(e.shiftKey)return!1;if(t.includes("\u2318")){if($e()?!e.metaKey:!e.ctrlKey)return!1}else if($e()?e.metaKey:t.includes("\u2303")?!e.ctrlKey:e.ctrlKey)return!1;return!0},$=(t,e)=>{if(!t)return!1;if(t.startsWith("\u2303")&&!$e()){if(t==="\u2303D")return!1;t=t.replace("\u2318","").replace("\u2303","\u2318").replace("\u2318\u21E7","\u21E7\u2318").replace("\u2318\u2325\u21E7","\u2325\u21E7\u2318").replace("\u2318\u2325","\u2325\u2318")}if(t.indexOf("\u21E7")===-1&&t.indexOf("\u2318")===-1&&t.indexOf("\u2325")===-1&&t.indexOf("\u2303")===-1)return!!(R(e)&&!e.altKey&&!e.shiftKey&&t===p.Constants.KEYCODELIST[e.keyCode]);const n=t.split("");if(t.indexOf("F")>-1&&n.forEach((i,s)=>{i==="F"&&(n[s]="F"+n.splice(s+1,1),n[s+1]&&(n[s+1]+=n.splice(s+1,1)))}),t.startsWith("\u21E7")&&n.length===2)return!!(R(e)&&!e.altKey&&e.shiftKey&&n[1]===p.Constants.KEYCODELIST[e.keyCode]);if(t.startsWith("\u2325")){let i=n.length===3?n[2]:n[1];n.length===4&&(i=n[3]);const s=i===p.Constants.KEYCODELIST[e.keyCode];return!!(s&&e.altKey&&!e.shiftKey&&(n.length===3?O(e)&&t.startsWith("\u2325\u2318"):R(e))||s&&t.startsWith("\u2325\u21E7\u2318")&&n.length===4&&e.altKey&&e.shiftKey&&O(e)||s&&t.startsWith("\u2325\u21E7")&&n.length===3&&e.altKey&&e.shiftKey&&R(e))}if(t.startsWith("\u2303")){if(!$e())return!1;let i=n.length===3?n[2]:n[1];n.length===4?i=n[3]:n.length===5&&(i=n[4]);const s=i===p.Constants.KEYCODELIST[e.keyCode];return!!(s&&e.ctrlKey&&!e.altKey&&!e.shiftKey&&n.length<4&&(n.length===3?e.metaKey&&t.startsWith("\u2303\u2318"):!e.metaKey)||s&&t.startsWith("\u2303\u21E7")&&n.length===3&&e.ctrlKey&&!e.altKey&&e.shiftKey&&!e.metaKey||s&&t.startsWith("\u2303\u2325")&&n.length===3&&e.ctrlKey&&e.altKey&&!e.shiftKey&&!e.metaKey||s&&n.length===4&&e.ctrlKey&&(t.startsWith("\u2303\u2325\u21E7")&&e.shiftKey&&!e.metaKey&&e.altKey||t.startsWith("\u2303\u2325\u2318")&&!e.shiftKey&&e.metaKey&&e.altKey||t.startsWith("\u2303\u21E7\u2318")&&e.shiftKey&&e.metaKey&&!e.altKey)||s&&n.length===5&&e.ctrlKey&&e.shiftKey&&e.metaKey&&e.altKey)}const a=n.length>2&&n[0]==="\u21E7";return O(e)&&!e.altKey&&(!a&&!e.shiftKey||a&&e.shiftKey)?(a?n[2]:n[1])===p.Constants.KEYCODELIST[e.keyCode]:!1};var Q=Ye(680);const ln=(t,e=0,n=1e3)=>{t.scroll.lastScrollTop=-1,setTimeout(()=>{t.scroll.lastScrollTop=e},n)},Jw=(t,e,n,a=!1)=>{if(!e.parentElement.previousElementSibling&&e.parentElement.nextElementSibling&&e.parentElement.nextElementSibling.classList.contains("protyle-attr")){Ul(t,[e.parentElement],n,a,e);return}if(!e.parentElement.previousElementSibling&&e.parentElement.parentElement.parentElement.classList.contains("list")){n.insertNode(document.createElement("wbr"));const u=e.parentElement.parentElement,f=u.outerHTML,g=e.parentElement.parentElement.previousElementSibling.lastElementChild,h=g.parentElement.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove(),g.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),u.getAttribute("data-subtype")==="o"&&it(u),F(t,[{action:"update",id:u.getAttribute("data-node-id"),data:u.outerHTML},{action:"update",data:g.parentElement.outerHTML,id:g.parentElement.getAttribute("data-node-id")}],[{action:"update",data:h,id:g.parentElement.getAttribute("data-node-id")},{action:"update",data:f,id:u.getAttribute("data-node-id")}]),fe(g.parentElement,n);return}if(!e.parentElement.previousElementSibling){if(e.parentElement.parentElement.classList.contains("protyle-wysiwyg"))return;lo(e,n,a),n.insertNode(document.createElement("wbr"));const u=e.parentElement.parentElement,f=u.outerHTML;e.parentElement.firstElementChild.remove(),e.parentElement.lastElementChild.remove();const g=document.createElement("div");g.innerHTML=e.parentElement.innerHTML;const h=[],m=[];Array.from(g.children).forEach((b,y)=>{h.push({action:"insert",id:b.getAttribute("data-node-id"),data:b.outerHTML,previousID:y===0?u.previousElementSibling?.getAttribute("data-node-id"):h[y-1].id,parentID:u.parentElement.getAttribute("data-node-id")||t.block.parentID}),m.push({action:"delete",id:b.getAttribute("data-node-id")})}),u.insertAdjacentHTML("beforebegin",e.parentElement.innerHTML),e.parentElement.remove(),u.getAttribute("data-subtype")==="o"&&it(u,parseInt(u.firstElementChild.getAttribute("data-marker"))-1),h.splice(0,0,{action:"update",id:u.getAttribute("data-node-id"),data:u.outerHTML}),m.push({action:"update",data:f,id:u.getAttribute("data-node-id")}),F(t,h,m),fe(t.wysiwyg.element,n);return}const i=e.parentElement;if(i.previousElementSibling&&i.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const s=i.getAttribute("data-node-id"),o=i.parentElement;lo(e,n,a),n.insertNode(document.createElement("wbr"));const l=o.outerHTML,r=[],c=[{action:"insert",id:s,data:"",previousID:i.previousElementSibling.getAttribute("data-node-id")}],d=i.previousElementSibling.lastElementChild;if(i.previousElementSibling.getAttribute("fold")==="1")if(ae(e).textContent.trim()===""&&e.nextElementSibling.classList.contains("protyle-attr"))r.push({action:"delete",id:s}),c[0].data=i.outerHTML,Xt(ae(i.previousElementSibling),n),n.collapse(!0),i.remove();else{Xt(ae(i.previousElementSibling),n),n.collapse(!0),Z(n),e.querySelector("wbr")?.remove();return}else{let u=d.previousElementSibling.getAttribute("data-node-id");Array.from(e.parentElement.children).forEach((f,g)=>{if(f.classList.contains("protyle-action")||f.classList.contains("protyle-attr"))return;const h=f.getAttribute("data-node-id");r.push({action:"move",id:h,previousID:u}),c.push({action:"move",id:h,previousID:g===1?void 0:u,parentID:s}),u=h,d.before(f)}),r.push({action:"delete",id:s}),c[0].data=i.outerHTML,i.remove()}o.classList.contains("protyle-wysiwyg")?F(t,r,c):(o.getAttribute("data-subtype")==="o"&&it(o),J(t,o.getAttribute("data-node-id"),o.outerHTML,l)),fe(d.parentElement,n)},rn=(t,e,n,a=!1)=>{ln(t);const i=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(i?.length>0){const m=[],b=[];let y=i[0].previousElementSibling||i[i.length-1].nextElementSibling,_,v;if(X(["select"],t),i.find(k=>{const L=be(k);v=L.parentElement;const C=L.getAttribute("data-node-id");if(m.push({action:"delete",id:C}),y=nt(L)||De(L)||L.parentElement||t.wysiwyg.element.firstElementChild,L.getAttribute("data-type")==="NodeHeading"&&L.getAttribute("fold")==="1"){zt(t,L,void 0,!0),b.push({action:"insert",data:L.outerHTML,id:C,previousID:i[0].previousElementSibling?i[0].previousElementSibling.getAttribute("data-node-id"):"",parentID:L.parentElement.getAttribute("data-node-id")||t.block.parentID}),L.firstElementChild.removeAttribute("contenteditable");const E=L.nextElementSibling;if(E){const T=E.getAttribute("data-type");if(T!=="NodeHeading"||T==="NodeHeading"&&E.getAttribute("data-subtype")>L.getAttribute("data-subtype"))return!0}}else{let E=L.outerHTML;(L.classList.contains("render-node")||L.querySelector("div.render-node"))&&(E=t.lute.SpinBlockDOM(L.outerHTML)),b.push({action:"insert",data:E,id:C,previousID:L.previousElementSibling?L.previousElementSibling.getAttribute("data-node-id"):"",parentID:L.parentElement.getAttribute("data-node-id")||t.block.parentID}),L.getAttribute("data-subtype")==="o"&&L.classList.contains("li")?_=L.parentElement:_=void 0,L.remove()}}),y)if(t.block.showAll&&y.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0)setTimeout(()=>{Vt({protyle:t,id:t.block.parent2ID,focusId:t.block.parent2ID})},p.Constants.TIMEOUT_INPUT*2+100);else{if(y.classList.contains("protyle-wysiwyg")&&t.wysiwyg.element.childElementCount===0){const k=Lute.NewNodeID(),L=Cn(!1,!0,k);y.insertAdjacentElement("afterbegin",L),m.push({action:"insert",data:L.outerHTML,id:k,parentID:y.getAttribute("data-node-id")||t.block.parentID}),b.push({action:"delete",id:k}),y=void 0,fe(L,n)}le(y),He(t,y),_&&(b.push({action:"update",id:_.getAttribute("data-node-id"),data:_.outerHTML}),it(_,1),m.push({action:"update",id:_.getAttribute("data-node-id"),data:_.outerHTML}))}if(m.length>0)if(v&&v.getAttribute("data-type")==="NodeSuperBlock"&&v.childElementCount===2){const k=ns(t,v);F(t,m.concat(k.doOperations),k.undoOperations.concat(b.reverse()))}else F(t,m,b.reverse());X(["util"],t);return}if(e.getAttribute("data-type")==="NodeCodeBlock"&&ae(e).textContent.trim()===""){e.classList.add("protyle-wysiwyg--select"),rn(t,e,n);return}if(e.getAttribute("data-type")==="NodeCodeBlock"||e.getAttribute("data-type")==="NodeTable"){e.previousElementSibling&&le(e.previousElementSibling,void 0,!1);return}if(e.getAttribute("data-type")==="NodeHeading"){aa({protyle:t,selectsElement:[e],type:"Blocks2Ps"});return}if(!e.previousElementSibling&&e.parentElement.getAttribute("data-type")==="NodeBlockquote"){n.insertNode(document.createElement("wbr"));const m=e.parentElement;m.insertAdjacentElement("beforebegin",e),m.childElementCount===1?(F(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:m.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"delete",id:m.getAttribute("data-node-id")}],[{action:"insert",id:m.getAttribute("data-node-id"),data:m.outerHTML,previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:m.parentElement.getAttribute("data-node-id")||t.block.parentID},{action:"move",id:e.getAttribute("data-node-id"),parentID:m.getAttribute("data-node-id")}]),m.remove()):F(t,[{action:"move",id:e.getAttribute("data-node-id"),previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:m.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:e.getAttribute("data-node-id"),parentID:m.getAttribute("data-node-id")}]),fe(e,n);return}if(e.parentElement.classList.contains("li")&&e.previousElementSibling.classList.contains("protyle-action")){Jw(t,e,n,a);return}if(e.previousElementSibling&&e.previousElementSibling.classList.contains("protyle-breadcrumb__bar"))return;const s=De(e);if(!s){if(t.wysiwyg.element.childElementCount>1&&ae(e).textContent===""){le(t.wysiwyg.element.firstElementChild.nextElementSibling);const m=be(e);F(t,[{action:"delete",id:m.getAttribute("data-node-id")}],[{action:"insert",data:m.outerHTML,id:m.getAttribute("data-node-id"),parentID:t.block.parentID}]),m.remove()}return}const o=e.parentElement,l=ae(e),r=Qe(s);if(n.toString()===""&&(0,I.tq)()&&r&&r.classList.contains("hr")&&yt(l).start===0){F(t,[{action:"delete",id:r.getAttribute("data-node-id")}],[{action:"insert",data:r.outerHTML,id:r.getAttribute("data-node-id"),previousID:r.previousElementSibling?.getAttribute("data-node-id"),parentID:r.parentElement.getAttribute("data-node-id")}]),r.remove();return}const c=r&&(r.classList.contains("table")||r.classList.contains("render-node")||r.classList.contains("iframe")||r.classList.contains("hr")||r.classList.contains("av")||r.classList.contains("code-block")),d=r.getAttribute("data-node-id");if(c){if(r.classList.contains("code-block")){if(l.textContent.trim()===""){const m=e.getAttribute("data-node-id"),b=[{action:"delete",id:m}],y=[{action:"insert",data:e.outerHTML,id:m,previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:e.parentElement.getAttribute("data-node-id")}];if(e.remove(),o.getAttribute("data-type")==="NodeSuperBlock"&&o.childElementCount===2){const _=ns(t,o);F(t,b.concat(_.doOperations),_.undoOperations.concat(y))}else F(t,b,y);le(t.wysiwyg.element.querySelector(`[data-node-id="${d}"]`),void 0,!1)}else le(r,void 0,!1);return}if(l.textContent!==""){le(r,void 0,!1);return}}const u=Ue(e),f=u.getAttribute("data-node-id");n.insertNode(document.createElement("wbr"));const g=[{action:"update",data:r.outerHTML,id:d},{action:"insert",data:u.outerHTML,id:f,previousID:e.previousElementSibling?.getAttribute("data-node-id"),parentID:o.getAttribute("data-node-id")}],h=[{action:"delete",id:f}];if(c)u.remove(),le(r,void 0,!1);else{const m=ae(r);if(l&&l.textContent!==""&&(n.setEndAfter(l.lastChild),(m?.lastElementChild?.getAttribute("data-type")||"").indexOf("inline-math")>-1)){const _=rt(m?.lastElementChild);_&&_.textContent===`
`&&_.remove()}const b=t.contentElement.scrollTop,y=n.extractContents();n.selectNodeContents(m),n.collapse(!1),n.insertNode(y),u.remove(),t.contentElement.scrollTop=b,t.scroll.lastScrollTop=b-1,h.push({action:"update",data:r.outerHTML,id:d})}if(o.getAttribute("data-type")==="NodeSuperBlock"&&o.childElementCount===2){const m=ns(t,o);F(t,h.concat(m.doOperations),m.undoOperations.concat(g))}else F(t,h,g);fe(t.wysiwyg.element,n)},lo=(t,e,n)=>{if(n){const a=De(t);if(a){const i=ae(Qe(a));i&&Xt(i,e,!1)}}},it=(t,e)=>{if(t.getAttribute("data-subtype")!=="o")return;let n;Array.from(t.children).forEach((a,i)=>{i===0?e?(n=e,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+"."):n=parseInt(a.getAttribute("data-marker")):a.classList.contains("li")&&(n++,a.setAttribute("data-marker",n+"."),a.querySelector(".protyle-action--order").textContent=n+".")})},bi=(t,e=0,n=!1)=>{const a=document.createElement("template"),i=t.getAttribute("data-subtype");if(i==="o"){const s=parseInt(t.getAttribute("data-marker"))+e;a.innerHTML=`<div data-marker="${s+1}." data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div contenteditable="false" class="protyle-action protyle-action--order" draggable="true">${s+1}.</div>${Wl(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`}else i==="t"?a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>${Wl(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`:a.innerHTML=`<div data-marker="*" data-subtype="${i}" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${Wl(!1,n)}<div class="protyle-attr" contenteditable="false"></div></div>`;return a.content.firstElementChild},jf=(t,e,n)=>{const a=e[0].previousElementSibling;if(!a)return;n.collapse(!1),n.insertNode(document.createElement("wbr")),e.forEach(s=>{s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end")});const i=a.parentElement.outerHTML;if(a.lastElementChild.previousElementSibling.getAttribute("data-type")==="NodeList"){const s=a.lastElementChild.previousElementSibling.outerHTML,o=[],l=[],r=a.lastElementChild.previousElementSibling.getAttribute("data-subtype");let c=a.lastElementChild.previousElementSibling.lastElementChild.previousElementSibling.getAttribute("data-node-id");e.forEach((d,u)=>{o.push({action:"move",id:d.getAttribute("data-node-id"),previousID:c}),l.push({action:"move",id:d.getAttribute("data-node-id"),previousID:u===0?a.getAttribute("data-node-id"):c}),c=d.getAttribute("data-node-id"),d.setAttribute("data-subtype",r);const f=d.querySelector(".protyle-action");r==="o"?(f.classList.add("protyle-action--order"),f.classList.remove("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(d)):r==="t"?(d.setAttribute("data-marker","*"),f.innerHTML='<svg><use xlink:href="#iconUncheck"></use></svg>',f.classList.remove("protyle-action--order"),f.classList.add("protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(d)):(d.setAttribute("data-marker","*"),f.innerHTML='<svg><use xlink:href="#iconDot"></use></svg>',f.classList.remove("protyle-action--order","protyle-action--task"),a.lastElementChild.previousElementSibling.lastElementChild.before(d))}),r==="o"?(it(a.lastElementChild.previousElementSibling),it(a.parentElement)):a.getAttribute("data-subtype")==="o"&&it(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")&&(o.push({action:"update",data:a.lastElementChild.previousElementSibling.outerHTML,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),l.push({action:"update",data:s,id:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}),F(t,o,l))}else{const s=a.outerHTML,o=e[0].getAttribute("data-subtype"),l=document.createElement("div"),r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.setAttribute("data-type","NodeList"),l.setAttribute("class","list"),l.setAttribute("data-subtype",o),l.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';const c=[{action:"insert",data:l.outerHTML,id:r,previousID:a.lastElementChild.previousElementSibling.getAttribute("data-node-id")}];a.lastElementChild.before(l);const d=[];let u;e.forEach((f,g)=>{c.push({action:"move",id:f.getAttribute("data-node-id"),parentID:r,previousID:u}),d.push({action:"move",id:f.getAttribute("data-node-id"),previousID:g===0?a.getAttribute("data-node-id"):u}),u=f.getAttribute("data-node-id"),l.lastElementChild.before(f)}),d.push({action:"delete",id:r}),o==="o"&&(it(l,1),it(a.parentElement)),a.parentElement.classList.contains("protyle-wysiwyg")&&(c.push({action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")}),d.push({action:"update",data:s,id:a.getAttribute("data-node-id")}),F(t,c,d))}a.parentElement.classList.contains("protyle-wysiwyg")||J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,i),fe(a,n)},Xw=(t,e,n)=>{const a=e.parentElement,i=a.getAttribute("data-node-id"),s=[],o=[];n.insertNode(document.createElement("wbr"));const l=Lute.NewNodeID();let r="",c=0;Array.from(a.parentElement.children).forEach(u=>{!c&&u.isSameNode(a)?c=1:c&&!u.classList.contains("protyle-attr")&&(o.push({id:u.getAttribute("data-node-id"),action:"move",previousID:i}),s.push({id:u.getAttribute("data-node-id"),action:"delete"}),u.getAttribute("data-subtype")==="o"&&(o.push({id:u.getAttribute("data-node-id"),action:"update",data:u.outerHTML}),u.setAttribute("data-marker",c+"."),u.firstElementChild.innerHTML=c+"."),r+=u.outerHTML,u.remove(),c++)}),o.reverse(),r=`<div data-subtype="${a.getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${Q().format("YYYYMMDDHHmmss")}">${r}<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`,a.parentElement.insertAdjacentHTML("afterend",r),s.push({id:l,action:"insert",previousID:a.parentElement.getAttribute("data-node-id"),data:r}),o.push({id:l,action:"delete"}),Array.from(a.children).reverse().forEach(u=>{!u.classList.contains("protyle-action")&&!u.classList.contains("protyle-attr")&&(s.push({id:u.getAttribute("data-node-id"),action:"move",previousID:a.parentElement.getAttribute("data-node-id")}),o.push({id:u.getAttribute("data-node-id"),action:"move",parentID:i}),a.parentElement.after(u))});const d=a.parentElement.getAttribute("data-node-id");a.parentElement.childElementCount===2?(o.splice(0,0,{id:d,action:"insert",data:a.parentElement.outerHTML,previousID:a.parentElement.previousElementSibling?.getAttribute("data-node-id"),parentID:a.parentElement.parentElement.getAttribute("data-node-id")||t.block.rootID}),a.parentElement.remove(),s.push({id:d,action:"delete"})):(o.splice(0,0,{id:i,action:"insert",data:a.outerHTML,previousID:a.previousElementSibling?.getAttribute("data-node-id"),parentID:d}),a.remove(),s.push({id:i,action:"delete"})),F(t,s,o),fe(t.wysiwyg.element,n)},Ul=(t,e,n,a=!1,i)=>{const s=e[0].parentElement,o=s.getAttribute("data-node-id");if(!o)return;const l=s.parentElement,r=l.parentElement;if(s.previousElementSibling?.classList.contains("protyle-action")&&!r.getAttribute("data-node-id"))return;if(l.classList.contains("protyle-wysiwyg")||l.classList.contains("sb")||l.classList.contains("bq")){const b=[],y=[];n.collapse(!1),lo(i,n,a),n.insertNode(document.createElement("wbr"));let _;!e[0].previousElementSibling&&s.getAttribute("data-subtype")==="o"&&(_=parseInt(e[0].getAttribute("data-marker")));let v=o,k=s,L=e[e.length-1].nextElementSibling,C=e[e.length-1].lastElementChild.previousElementSibling;if(e.forEach(T=>{T.classList.remove("protyle-wysiwyg--select"),T.removeAttribute("select-start"),T.removeAttribute("select-end"),Array.from(T.children).forEach((H,D)=>{const U=H.getAttribute("data-node-id");U&&(b.push({action:"move",id:U,previousID:v,parentID:l.getAttribute("data-node-id")||t.block.parentID}),y.push({action:"move",id:U,previousID:D===1?void 0:v,parentID:T.getAttribute("data-node-id"),data:H.contains(n.startContainer)?"focus":""}),v=U,k.after(H),k=H)})}),!window.siyuan.config.editor.listLogicalOutdent&&!L.classList.contains("protyle-attr")){let T;C.getAttribute("data-subtype")!==L.getAttribute("data-subtype")&&(T=Lute.NewNodeID(),C=document.createElement("div"),C.classList.add("list"),C.setAttribute("data-subtype",L.getAttribute("data-subtype")),C.setAttribute("data-node-id",T),C.setAttribute("data-type","NodeList"),C.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),C.innerHTML=`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`,k.after(C),b.push({action:"insert",id:T,data:C.outerHTML,previousID:k.getAttribute("data-node-id")}));let H;for(;L&&!L.classList.contains("protyle-attr");){b.push({action:"move",id:L.getAttribute("data-node-id"),previousID:H||C.lastElementChild.previousElementSibling?.getAttribute("data-node-id"),parentID:C.getAttribute("data-node-id")}),y.push({action:"move",id:L.getAttribute("data-node-id"),parentID:C.getAttribute("data-node-id"),previousID:H||L.previousElementSibling?.getAttribute("data-node-id")}),H=L.getAttribute("data-node-id");const D=L;L=L.nextElementSibling,C.lastElementChild.before(D)}C.getAttribute("data-subtype")==="o"&&(Array.from(C.children).forEach(D=>{const U=D.getAttribute("data-node-id");U&&y.push({action:"update",id:U,data:D.outerHTML})}),it(C,1),Array.from(C.children).forEach(D=>{const U=D.getAttribute("data-node-id");U&&b.push({action:"update",id:U,data:D.outerHTML})})),T&&y.push({action:"delete",id:T})}const E=s.outerHTML;e.forEach(T=>{T.remove()}),s.childElementCount===1?(b.push({action:"delete",id:o}),o===t.block.id&&(t.block.id=t.block.parentID),y.splice(0,0,{action:"insert",data:E,id:o,previousID:s.previousElementSibling?.getAttribute("data-node-id"),parentID:l.getAttribute("data-node-id")||t.block.parentID}),s.remove()):(s.getAttribute("data-subtype")==="o"&&it(s,_),b.push({action:"update",id:o,data:s.outerHTML}),y.splice(0,0,{action:"update",id:o,data:E})),F(t,b,y),fe(l,n);return}if(s.childElementCount===2&&l.childElementCount===3){n.collapse(!1),lo(i,n,a),n.insertNode(document.createElement("wbr"));const b=l.outerHTML;e[0].firstElementChild.remove(),e[0].lastElementChild.remove(),s.outerHTML=e[0].innerHTML,J(t,l.getAttribute("data-node-id"),l.outerHTML,b),fe(l,n);return}n.collapse(!1),lo(i,n,a),n.insertNode(document.createElement("wbr"));const c=[],d=[],u=e[0].previousElementSibling?.getAttribute("data-node-id");e.forEach(b=>{b.classList.remove("protyle-wysiwyg--select"),b.removeAttribute("select-start"),b.removeAttribute("select-end")});let f;!e[0].previousElementSibling&&s.getAttribute("data-subtype")==="o"&&(f=parseInt(e[0].getAttribute("data-marker")));const g=l.parentElement.outerHTML;let h=e[e.length-1].nextElementSibling,m=e[e.length-1].lastElementChild.previousElementSibling;if(e.reverse().forEach(b=>{const y=b.getAttribute("data-node-id");c.push({action:"move",id:y,previousID:l.getAttribute("data-node-id")}),d.push({action:"move",id:y,previousID:u,parentID:s.getAttribute("data-node-id")}),l.after(b),(b.getAttribute("data-subtype")==="o"||b.getAttribute("data-subtype")==="t")&&l.getAttribute("data-subtype")==="u"?(d.push({action:"update",id:y,data:b.outerHTML}),b.querySelector(".protyle-action").outerHTML='<div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>',b.setAttribute("data-subtype","u"),b.setAttribute("data-marker","*"),c.push({action:"update",id:y,data:b.outerHTML})):(b.getAttribute("data-subtype")==="u"||b.getAttribute("data-subtype")==="t")&&l.getAttribute("data-subtype")==="o"?(d.push({action:"update",id:y,data:b.outerHTML}),b.querySelector(".protyle-action").outerHTML='<div contenteditable="false" draggable="true" class="protyle-action protyle-action--order">1.</div>',b.setAttribute("data-subtype","o"),b.setAttribute("data-marker","1."),c.push({action:"update",id:y,data:b.outerHTML})):(b.getAttribute("data-subtype")==="u"||b.getAttribute("data-subtype")==="0")&&l.getAttribute("data-subtype")==="t"&&(d.push({action:"update",id:y,data:b.outerHTML}),b.querySelector(".protyle-action").outerHTML='<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div>',b.setAttribute("data-subtype","t"),b.setAttribute("data-marker","*"),c.push({action:"update",id:y,data:b.outerHTML}))}),!window.siyuan.config.editor.listLogicalOutdent&&!h.classList.contains("protyle-attr")){let b;m.classList.contains("list")||(b=Lute.NewNodeID(),m=document.createElement("div"),m.classList.add("list"),m.setAttribute("data-subtype",h.getAttribute("data-subtype")),m.setAttribute("data-node-id",b),m.setAttribute("data-type","NodeList"),m.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),m.innerHTML=`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`,c.push({action:"insert",id:b,data:m.outerHTML,previousID:e[0].lastElementChild.previousElementSibling.getAttribute("data-node-id")}),e[0].lastElementChild.before(m));let y;for(;h&&!h.classList.contains("protyle-attr");){const _=h.getAttribute("data-node-id");h.getAttribute("data-subtype")!==m.getAttribute("data-subtype")&&(d.push({action:"update",id:_,data:h.outerHTML}),h.querySelector(".protyle-action").outerHTML=m.querySelector(".protyle-action").outerHTML,h.setAttribute("data-subtype",m.getAttribute("data-subtype")),h.setAttribute("data-marker",m.getAttribute("data-marker")),c.push({action:"update",id:_,data:h.outerHTML})),c.push({action:"move",id:_,previousID:y||m.lastElementChild.previousElementSibling?.getAttribute("data-node-id"),parentID:m.getAttribute("data-node-id")}),d.push({action:"move",id:_,previousID:y||m.parentElement?.getAttribute("data-node-id")}),y=_;const v=h;h=h.nextElementSibling,m.lastElementChild.before(v)}m.getAttribute("data-subtype")==="o"&&(Array.from(m.children).forEach(_=>{const v=_.getAttribute("data-node-id");v&&d.push({action:"update",id:v,data:_.outerHTML})}),it(m,1),Array.from(m.children).forEach(_=>{const v=_.getAttribute("data-node-id");v&&c.push({action:"update",id:v,data:_.outerHTML})})),b&&d.push({action:"delete",id:b})}if(!window.siyuan.config.editor.listLogicalOutdent&&s.nextElementSibling){h=s.nextElementSibling;let b;for(;h&&!h.classList.contains("protyle-attr");){const y=h.getAttribute("data-node-id");c.push({action:"move",id:y,previousID:b||m.getAttribute("data-node-id")}),d.push({action:"move",id:y,previousID:b||s.getAttribute("data-node-id")}),b=y;const _=h;h=h.nextElementSibling,m.after(_),m=_}}s.childElementCount===1&&l.childElementCount===3?(c.push({action:"delete",id:l.getAttribute("data-node-id")}),d.splice(0,0,{action:"insert",id:l.getAttribute("data-node-id"),data:l.outerHTML,previousID:l.previousElementSibling?.getAttribute("data-node-id"),parentID:l.parentElement.getAttribute("data-node-id")}),l.remove()):s.childElementCount===1?(c.push({action:"delete",id:s.getAttribute("data-node-id")}),d.splice(0,0,{action:"insert",id:s.getAttribute("data-node-id"),data:s.outerHTML,previousID:s.previousElementSibling.getAttribute("data-node-id")}),s.remove()):s.getAttribute("data-subtype")==="o"&&(d.splice(0,0,{action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")}),it(s,f),c.push({action:"update",data:s.outerHTML,id:s.getAttribute("data-node-id")})),r.classList.contains("protyle-wysiwyg")?F(t,c,d):(l&&l.getAttribute("data-subtype")==="o"&&it(r),J(t,r.getAttribute("data-node-id"),r.outerHTML,g)),fe(r,n)},ns=(t,e)=>{const n=[],a=[];let i=e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0;e.classList.remove("protyle-wysiwyg--select"),e.removeAttribute("select-start"),e.removeAttribute("select-end");const s=e.getAttribute("data-node-id"),o=e.cloneNode();return o.innerHTML=e.lastElementChild.outerHTML,a.push({action:"insert",id:s,data:o.outerHTML,previousID:e.previousElementSibling?e.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:e.parentElement.getAttribute("data-node-id")||t.block.parentID}),Array.from(e.children).forEach((l,r)=>{if(r===e.childElementCount-1){n.push({action:"delete",id:s}),e.lastElementChild.remove(),e.outerHTML=e.innerHTML;return}n.push({action:"move",id:l.getAttribute("data-node-id"),previousID:i,parentID:e.parentElement.getAttribute("data-node-id")||t.block.parentID}),a.push({action:"move",id:l.getAttribute("data-node-id"),previousID:l.previousElementSibling?l.previousElementSibling.getAttribute("data-node-id"):void 0,parentID:s}),i=l.getAttribute("data-node-id")}),n.forEach(l=>{const r=t.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r&&r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Be(t,r))}),{doOperations:n,undoOperations:a,previousId:i}},Kf=(t,e,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",e||Lute.NewNodeID()),a.setAttribute("data-type","NodeSuperBlock"),a.setAttribute("class","sb"),a.setAttribute("data-sb-layout",t),a.innerHTML=n||`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`,a},Zf=(t,e)=>{const n=be(e);if(n){const a=A(n,"list")||A(n,"bq")||A(n,"sb")||n,i=nt(a);i?(le(i),He(t,i)):w("/api/block/getParentNextChildID",{id:e.getAttribute("data-node-id")},s=>{s.data.id&&Vt({protyle:t,id:s.data.id})})}},wn=(t,e,n)=>{const a=re(t.wysiwyg.element);let i;if(n)i=t.wysiwyg.element.querySelector(`[data-node-id="${n}"]`);else{const c=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");c.length>0?(e==="beforebegin"?i=c[0]:i=c[c.length-1],X(["select"],t)):(i=x(a.startContainer),i=be(i))}if(!i)return;let s=Cn(!1,!0),o=1;i.getAttribute("data-type")==="NodeListItem"&&(s=bi(i,0,!0),o=parseInt(i.parentElement.firstElementChild.getAttribute("data-marker")));const l=i.parentElement.outerHTML,r=s.getAttribute("data-node-id");if(i.insertAdjacentElement(e,s),i.getAttribute("data-type")==="NodeListItem"&&i.getAttribute("data-subtype")==="o"&&!s.parentElement.classList.contains("protyle-wysiwyg"))it(s.parentElement,o),J(t,s.parentElement.getAttribute("data-node-id"),s.parentElement.outerHTML,l);else{let c;e==="beforebegin"?c=[{action:"insert",data:s.outerHTML,id:r,nextID:i.getAttribute("data-node-id")}]:c=[{action:"insert",data:s.outerHTML,id:r,previousID:i.getAttribute("data-node-id")}],F(t,c,[{action:"delete",id:r}])}fe(t.wysiwyg.element,a),He(t)},Wl=(t=!0,e=!0,n)=>{let a="";return t&&(a=p.Constants.ZWSP),e&&(a+="<wbr>"),n&&(a+=n),`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${a}</div><div contenteditable="false" class="protyle-attr">${p.Constants.ZWSP}</div></div>`},Cn=(t=!0,e=!0,n)=>{const a=document.createElement("div");return a.setAttribute("data-node-id",n||Lute.NewNodeID()),a.setAttribute("data-type","NodeParagraph"),a.classList.add("p"),a.innerHTML=`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}">${t?p.Constants.ZWSP:""}${e?"<wbr>":""}</div><div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`,a},cd=(t,e,n)=>{if(t.getAttribute("custom-pinthead")==="true"){const a=t.querySelector("table");a.clientHeight+a.scrollTop<e.offsetTop+e.clientHeight?a.scrollTop=e.offsetTop-a.clientHeight+e.clientHeight+1:a.scrollTop>e.offsetTop-e.clientHeight&&(a.scrollTop=e.offsetTop-e.clientHeight+1)}else He(n,e)},xn=t=>{let e=t.previousElementSibling,n=0;for(;e;)n++,e=e.previousElementSibling;return n},Jf=(t,e,n=!0)=>{let a=t.previousElementSibling;return a||(t.parentElement.previousElementSibling?a=t.parentElement.previousElementSibling.lastElementChild:t.parentElement.parentElement.tagName==="TBODY"&&t.parentElement.parentElement.previousElementSibling?a=t.parentElement.parentElement.previousElementSibling.lastElementChild.lastElementChild:a=null),a&&(e.selectNodeContents(a),n||e.collapse(!1),Z(e)),a},ya=(t,e,n,a,i)=>{i.insertNode(document.createElement("wbr"));const s=n.outerHTML,o=n.querySelector("table"),l=o.rows[0].cells.length,r=o.rows.length,c=[];for(let d=0;d<r;d++){for(let u=0;u<l;u++)o.rows[d].cells[u].isSameNode(e[c.length])&&c.push(u);if(c.length>0)break}for(let d=0;d<r;d++)c.forEach(u=>{o.rows[d].cells[u].setAttribute("align",a)});J(t,n.getAttribute("data-node-id"),n.outerHTML,s),fe(o,i)},dd=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let o="";for(let r=0;r<n.parentElement.childElementCount;r++)o+=`<td align="${n.parentElement.children[r].getAttribute("align")||""}"></td>`;let l;if(n.tagName==="TH"){const r=a.querySelector("tbody");r?(r.insertAdjacentHTML("afterbegin",`<tr>${o}</tr>`),l=r.firstElementChild):(n.parentElement.parentElement.insertAdjacentHTML("afterend",`<tbody><tr>${o}</tr></tbody>`),l=n.parentElement.parentElement.nextElementSibling.firstElementChild)}else n.parentElement.insertAdjacentHTML("afterend",`<tr>${o}</tr>`),l=n.parentElement.nextElementSibling;e.selectNodeContents(l.cells[xn(n)]),e.collapse(!0),Z(e),J(t,a.getAttribute("data-node-id"),a.outerHTML,s),cd(a,l,t)},Xf=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();let o="",l=!1;for(let c=0;c<n.parentElement.childElementCount;c++){const d=n.parentElement.children[c];d.className==="fn__none"&&(l=!0),n.tagName==="TH"?o+=`<th class="${d.className}" colspan="${d.colSpan}" align="${d.getAttribute("align")}"></th>`:o+=`<td class="${d.className}" colspan="${d.colSpan}" align="${d.getAttribute("align")}"></td>`}if(l){let c=n.parentElement.previousElementSibling,d=1;for(;c;)d++,Array.from(c.children).forEach(u=>{u.rowSpan>=d&&u.rowSpan>1&&(u.rowSpan=u.rowSpan+1)}),c=c.previousElementSibling}let r;n.parentElement.parentElement.tagName==="THEAD"&&!n.parentElement.previousElementSibling?(n.parentElement.parentElement.insertAdjacentHTML("beforebegin",`<thead><tr>${o}</tr></thead>`),r=a.querySelector("thead tr"),n.parentElement.parentElement.nextElementSibling.insertAdjacentHTML("afterbegin",n.parentElement.parentElement.innerHTML),n.parentElement.parentElement.remove()):(n.parentElement.insertAdjacentHTML("beforebegin",`<tr>${o}</tr>`),r=n.parentElement.previousElementSibling),e.selectNodeContents(r.cells[xn(n)]),e.collapse(!0),Z(e),J(t,a.getAttribute("data-node-id"),a.outerHTML,s),cd(a,r,t)},Vl=(t,e,n,a,i)=>{const s=document.createElement("wbr");i.insertNode(s);const o=e.outerHTML;s.remove();const l=xn(n),r=e.querySelector("table");for(let c=0;c<r.rows.length;c++){const d=r.rows[c].cells[l],u=document.createElement(d.tagName);d.insertAdjacentElement(a,u),d.isSameNode(n)?(u.innerHTML="<wbr> ",u.offsetLeft+u.clientWidth>e.firstElementChild.scrollLeft+e.firstElementChild.clientWidth&&(e.firstElementChild.scrollLeft=u.offsetLeft+u.clientWidth-e.firstElementChild.clientWidth)):u.textContent=" "}r.querySelectorAll("col")[l].insertAdjacentHTML(a,"<col>"),fe(e,i),J(t,e.getAttribute("data-node-id"),e.outerHTML,o)},Qf=(t,e,n,a)=>{if(n.parentElement.parentElement.tagName!=="THEAD"){const i=document.createElement("wbr");e.insertNode(i);const s=a.outerHTML;i.remove();const o=xn(n),l=n.parentElement.parentElement;let r=l.previousElementSibling.lastElementChild;n.parentElement.previousElementSibling&&(r=n.parentElement.previousElementSibling),l.childElementCount===1?l.remove():n.parentElement.remove(),e.selectNodeContents(r.cells[o]),e.collapse(!0),Z(e),cd(a,r,t),J(t,a.getAttribute("data-node-id"),a.outerHTML,s)}},ep=(t,e,n,a)=>{const i=document.createElement("wbr");e.insertNode(i);const s=n.outerHTML;i.remove();const o=xn(a),l=a.previousElementSibling||a.nextElementSibling;l&&(e.selectNodeContents(l),e.collapse(!0),l.offsetLeft+l.clientWidth>n.firstElementChild.scrollLeft+n.firstElementChild.clientWidth&&(n.firstElementChild.scrollLeft=l.offsetLeft+l.clientWidth-n.firstElementChild.clientWidth));const r=n.querySelector("table");for(let c=0;c<r.rows.length;c++){const d=r.rows[c].cells;if(d.length===1){r.remove();break}d[o].remove()}n.querySelectorAll("col")[o]?.remove(),J(t,n.getAttribute("data-node-id"),n.outerHTML,s),Z(e)},tp=(t,e,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="THEAD")return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.previousElementSibling)i.after(i.previousElementSibling);else{const o=i.parentElement.previousElementSibling.firstElementChild;o.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.previousElementSibling.append(i)}J(t,a.getAttribute("data-node-id"),a.outerHTML,s),fe(a,e),He(t,i)},np=(t,e,n,a)=>{const i=n.parentElement;if(i.parentElement.tagName==="TBODY"&&!i.nextElementSibling||i.parentElement.tagName==="THEAD"&&!i.parentElement.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const s=a.outerHTML;if(i.nextElementSibling)i.before(i.nextElementSibling);else{const o=i.parentElement.nextElementSibling.firstElementChild;o.querySelectorAll("td").forEach(l=>{const r=document.createElement("th");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.querySelectorAll("th").forEach(l=>{const r=document.createElement("td");r.innerHTML=l.innerHTML,l.parentNode.replaceChild(r,l)}),i.after(o),i.parentElement.nextElementSibling.insertAdjacentElement("afterbegin",i)}J(t,a.getAttribute("data-node-id"),a.outerHTML,s),fe(a,e),He(t,i)},ap=(t,e,n,a)=>{if(!n.previousElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((l,r)=>{if(n.isSameNode(l))return s=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[s].after(l.cells[s-1])}),n.offsetLeft<a.firstElementChild.scrollLeft&&(a.firstElementChild.scrollLeft=n.offsetLeft);const o=a.querySelectorAll("col");o[s].after(o[s-1]),J(t,a.getAttribute("data-node-id"),a.outerHTML,i),fe(a,e)},ip=(t,e,n,a)=>{if(!n.nextElementSibling)return;e.insertNode(document.createElement("wbr"));const i=a.outerHTML;let s=0;Array.from(n.parentElement.children).find((l,r)=>{if(n.isSameNode(l))return s=r,!0}),a.querySelectorAll("tr").forEach(l=>{l.cells[s].before(l.cells[s+1])}),n.offsetLeft+n.clientWidth>a.firstElementChild.scrollLeft+a.firstElementChild.clientWidth&&(a.firstElementChild.scrollLeft=n.offsetLeft+n.clientWidth-a.firstElementChild.clientWidth);const o=a.querySelectorAll("col");o[s].before(o[s+1]),J(t,a.getAttribute("data-node-id"),a.outerHTML,i),fe(a,e)},Qw=(t,e,n)=>{const a=se(n.startContainer,"TD")||se(n.startContainer,"TH"),i=x(n.startContainer);if(!a||!i||i.classList.contains("protyle-wysiwyg--select"))return!1;if(e.key==="Enter"&&e.shiftKey&&R(e)&&!e.altKey){const L=document.createElement("wbr");n.insertNode(L);const C=i.outerHTML;if(L.remove(),a&&!a.innerHTML.endsWith("<br>")&&a.insertAdjacentHTML("beforeend","<br>"),n.extractContents(),t.toolbar.getCurrentType(n).includes("code")&&n.startContainer.nodeType!==3){const T=document.createElement("br");n.startContainer.after(T),n.setStartAfter(T)}else n.insertNode(document.createElement("br"));return n.collapse(!1),He(t),J(t,i.getAttribute("data-node-id"),i.outerHTML,C),e.preventDefault(),!0}if(R(e)&&!e.shiftKey&&!e.altKey&&e.key==="Enter"){e.preventDefault();const L=a.parentElement;if(!L.nextElementSibling&&L.parentElement.tagName==="TBODY"||L.parentElement.tagName==="THEAD"&&!L.parentElement.nextElementSibling)return!0;let C=L.nextElementSibling;return C||(C=L.parentElement.nextElementSibling.firstChild),C&&(n.selectNodeContents(C.cells[xn(a)]),n.collapse(!0),He(t)),!0}if(e.key==="ArrowRight"&&n.toString()===""&&!i.nextElementSibling&&a.isSameNode(i.querySelector("table").lastElementChild.lastElementChild.lastElementChild)&&yt(a,t.wysiwyg.element,n).start===a.textContent.length)return e.preventDefault(),wn(t,"afterend",i.getAttribute("data-node-id")),!0;if(e.key==="Tab"&&R(e)){if(e.shiftKey)return Jf(a,n),e.preventDefault(),!0;let L=a.nextElementSibling;return L||(a.parentElement.nextElementSibling?L=a.parentElement.nextElementSibling.firstElementChild:a.parentElement.parentElement.tagName==="THEAD"&&a.parentElement.parentElement.nextElementSibling?L=a.parentElement.parentElement.nextElementSibling.firstElementChild.firstElementChild:L=null),L?n.selectNodeContents(L):(dd(t,n,a,i),n.selectNodeContents(i.querySelector("tbody").lastElementChild.firstElementChild)),e.preventDefault(),!0}if(e.key==="ArrowUp"&&R(e)&&!e.shiftKey&&!e.altKey){const L=n.startContainer;let C;for(L.nodeType!==3&&(L.tagName==="TH"||L.tagName==="TD")?C=L.childNodes[Math.max(0,n.startOffset-1)]?.previousElementSibling:L.parentElement.tagName==="SPAN"?C=L.parentElement.previousElementSibling:C=L.previousElementSibling;C;){if(C.tagName==="BR")return!1;C=C.previousElementSibling}const E=a.parentElement;let T=E.previousElementSibling;return T||(T=E.parentElement.previousElementSibling.lastElementChild),!T||T?.tagName==="COL"?!1:(n.selectNodeContents(T.cells[xn(a)]),n.collapse(!1),He(t),e.preventDefault(),!0)}if(e.key==="ArrowDown"&&R(e)&&!e.shiftKey&&!e.altKey){const L=n.endContainer;let C;for(L.nodeType!==3&&(L.tagName==="TH"||L.tagName==="TD")?C=L.childNodes[Math.max(0,n.endOffset-1)]?.nextElementSibling:L.parentElement.tagName==="SPAN"?C=L.parentElement.nextElementSibling:C=L.nextElementSibling;C;){if(C.tagName==="BR"&&C.nextSibling)return!1;C=C.nextElementSibling}const E=a.parentElement;if(!E.nextElementSibling&&E.parentElement.tagName==="TBODY"||E.parentElement.tagName==="THEAD"&&!E.parentElement.nextElementSibling)return!1;let T=E.nextElementSibling;return T||(T=E.parentElement.nextElementSibling.firstChild),T?(n.selectNodeContents(T.cells[xn(a)]),n.collapse(!0),He(t),e.preventDefault(),!0):!1}if(R(e)&&!e.shiftKey&&!e.altKey&&e.key==="Backspace"&&yt(a,t.wysiwyg.element,n).start===0&&n.toString()===""&&(n.startOffset===0||n.startOffset===1&&a.querySelectorAll("br").length===1))return!Jf(a,n,!1)&&i.previousElementSibling&&le(i.previousElementSibling,void 0,!1),He(t),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.general.alignLeft.custom,e))return ya(t,[a],i,"left",n),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.general.alignCenter.custom,e))return ya(t,[a],i,"center",n),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.general.alignRight.custom,e))return ya(t,[a],i,"right",n),e.preventDefault(),!0;const s=i.querySelector("table"),o=a.parentElement.querySelector(".fn__none");let l=!1,r=!1;Array.from(a.parentElement.children).forEach(L=>{L.colSpan>1&&(l=!0),L.rowSpan>1&&(r=!0)});let c=!1,d=!1,u=!1,f=a.parentElement.previousElementSibling;!f&&a.parentElement.parentElement.tagName==="TBODY"&&(f=s.querySelector("thead").lastElementChild),f&&(c=f.querySelector(".fn__none"),Array.from(f.children).forEach(L=>{L.colSpan>1&&(d=!0),L.rowSpan>1&&(u=!0)}));let g=!1,h=!1,m=!1,b=a.parentElement.nextElementSibling;!b&&a.parentElement.parentElement.tagName==="THEAD"&&(b=s.querySelector("tbody")?.firstElementChild),b&&(g=b.querySelector(".fn__none"),Array.from(b.children).forEach(L=>{L.colSpan>1&&(h=!0),L.rowSpan>1&&(m=!0)}));const y=xn(a);let _=!0;Array.from(s.rows).find(L=>{const C=L.cells[y];if(C.classList.contains("fn__none")||C.colSpan>1||C.rowSpan>1)return _=!1,!0});let v=!0;Array.from(s.rows).find(L=>{const C=L.cells[y+1];if(C&&(C.classList.contains("fn__none")||C.colSpan>1||C.rowSpan>1))return v=!1,!0});let k=!0;if(Array.from(s.rows).find(L=>{const C=L.cells[y-1];if(C&&(C.classList.contains("fn__none")||C.colSpan>1||C.rowSpan>1))return k=!1,!0}),$(window.siyuan.config.keymap.editor.table.moveToUp.custom,e))return(!o||o&&!r&&l)&&(!c||c&&!u&&d)&&tp(t,n,a,i),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.table.moveToDown.custom,e))return(!o||o&&!r&&l)&&(!g||g&&!m&&h)&&np(t,n,a,i),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.table.moveToLeft.custom,e))return _&&k&&ap(t,n,a,i),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.table.moveToRight.custom,e))return _&&v&&ip(t,n,a,i),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.table.insertRowAbove.custom,e))return Xf(t,n,a,i),e.preventDefault(),e.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.table.insertRowBelow.custom,e))return(!g||g&&!m&&h)&&dd(t,n,a,i),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,e))return(_||k)&&Vl(t,i,a,"beforebegin",n),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.table.insertColumnRight.custom,e))return(_||v)&&Vl(t,i,a,"afterend",n),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.table["delete-row"].custom,e))return(!o&&!r||o&&!r&&l)&&Qf(t,n,a,i),e.preventDefault(),e.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.table["delete-column"].custom,e))return _&&ep(t,n,i,a),e.preventDefault(),!0},sp=t=>{const e=new me({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value="${t}"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()});const a=e.element.querySelector("input");e.bindInput(a,()=>{n[1].click()}),a.focus(),a.select(),n[1].addEventListener("click",()=>{w("/api/tag/renameTag",{oldLabel:t,newLabel:a.value})})},op=()=>window.siyuan.config.system.workspaceDir.replace(/^.*[\\\/]/,""),ot=(t,e)=>{t&&w("/api/block/checkBlockFold",{id:t},n=>{e(n.data,n.data?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL])})},zl=t=>({label:window.siyuan.languages.export,icon:"iconUpload",async click(){const e=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"showSaveDialog",defaultPath:Xc(t)+Le().extname(t),properties:["showOverwriteConfirmation"]});e.canceled||w("/api/file/copyFile",{src:t,dest:e.filePath})}}),lp=(t,e,n,a)=>{const i=[{icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,accelerator:`${K(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${K("\u2325Click")}`,click:()=>{n?de({app:t,id:e,position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]}):ot(e,(s,o)=>{de({app:t,id:e,position:"right",action:o,zoomIn:s})})}},{icon:"iconLayoutBottom",label:window.siyuan.languages.insertBottom,accelerator:"\u21E7Click",click:()=>{n?de({app:t,id:e,position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]}):ot(e,(s,o)=>{de({app:t,id:e,position:"bottom",action:o,zoomIn:s})})}}];window.siyuan.config.fileTree.openFilesUseCurrentTab&&i.push({label:window.siyuan.languages.openInNewTab,accelerator:"\u2325\u2318Click",click:()=>{n?de({app:t,id:e,action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],removeCurrentTab:!1}):ot(e,(s,o)=>{de({app:t,id:e,action:o,zoomIn:s,removeCurrentTab:!1})})}}),i.push({label:window.siyuan.languages.openByNewWindow,icon:"iconOpenWindow",click(){to(e)}}),i.push({type:"separator"}),i.push({icon:"iconPreview",label:window.siyuan.languages.preview,click:()=>{de({app:t,id:e,mode:"preview"})}}),i.push({type:"separator"}),i.push({icon:"iconFolder",label:window.siyuan.languages.showInFolder,click:()=>{n?Qn(kt.join(window.siyuan.config.system.dataDir,n,a)):w("/api/block/getBlockInfo",{id:e},s=>{Qn(kt.join(window.siyuan.config.system.dataDir,s.data.box,s.data.path))})}}),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:i}).element)},rp=t=>{if(at()){window.JSAndroid.writeImageClipboard(t.getAttribute("src"));return}else{const e=document.createElement("canvas"),n=document.createElement("img");n.onload=a=>{e.width=a.target.width,e.height=a.target.height,e.getContext("2d").drawImage(a.target,0,0,a.target.width,a.target.height),e.toBlob(i=>{navigator.clipboard.write([new ClipboardItem({["image/png"]:i})])},"image/png",1)},n.src=t.getAttribute("src")}},Bn=(t,e,n="b3-list-item--focus")=>{let a=t.querySelector("."+n);if(!a)return;const i=n.split("--")[0];if(e.key==="ArrowDown"){for(e.preventDefault(),e.stopPropagation(),a.classList.remove(n),a=a.nextElementSibling;a&&(a.classList.contains("fn__none")||!a.classList.contains(i));)a=a.nextElementSibling;if(!a)for(a=t.children[0];a&&(a.classList.contains("fn__none")||!a.classList.contains(i));)a=a.nextElementSibling;return a?(a.classList.add(n),(t.scrollTop<a.offsetTop-t.clientHeight+a.clientHeight||t.scrollTop>a.offsetTop)&&a.scrollIntoView(t.scrollTop>a.offsetTop),a):void 0}else if(e.key==="ArrowUp"){for(e.preventDefault(),e.stopPropagation(),a.classList.remove(n),a=a.previousElementSibling;a&&(a.classList.contains("fn__none")||!a.classList.contains(i));)a=a.previousElementSibling;if(!a)for(a=t.children[t.children.length-1];a&&(a.classList.contains("fn__none")||!a.classList.contains(i));)a=a.previousElementSibling;if(!a)return;a.classList.add(n);const s=t.scrollTop>a.offsetTop-(a.previousElementSibling?.clientHeight||0);return(t.scrollTop<a.offsetTop-t.clientHeight+a.clientHeight||s)&&a.scrollIntoView(s),a}},ey=t=>{let e="";switch(t.type){case"block":e=t.block.content;break;case"text":e=t.text.content;break;case"number":e=t.number.formattedContent||t.number.content.toString();break;case"date":t[t.type]&&t[t.type].isNotEmpty&&(e=Q(t[t.type].content).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),t[t.type]&&t[t.type].hasEndDate&&t[t.type].isNotEmpty&&t[t.type].isNotEmpty2&&(e+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Q(t[t.type].content2).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),e&&(e=`<span class="av__celltext">${e}</span>`);break;case"url":e=t.url.content?`<a class="fn__a" href="${t.url.content}" target="_blank">${t.url.content}</a>`:"";break;case"phone":e=t.phone.content?`<a class="fn__a" href="tel:${t.phone.content}" target="_blank">${t.phone.content}</a>`:"";break;case"email":e=t.email.content?`<a class="fn__a" href="mailto:${t.email.content}" target="_blank">${t.email.content}</a>`:"";break}return e},_a=t=>{let e="";switch(t.type){case"block":e=`<div class="fn__flex-1">${t.block.content}</div>`;break;case"text":e=`<textarea rows="${t.text.content.split(`
`).length}" class="b3-text-field b3-text-field--text fn__flex-1">${t.text.content}</textarea>`;break;case"number":e=`<input value="${t.number.content}" type="number" class="b3-text-field b3-text-field--text fn__flex-1">`;break;case"mSelect":case"select":t.mSelect?.forEach(n=>{e+=`<span class="b3-chip b3-chip--middle" style="background-color:var(--b3-font-background${n.color});color:var(--b3-font-color${n.color})">${n.content}</span>`});break;case"mAsset":t.mAsset?.forEach(n=>{n.type==="image"?e+=`<img class="av__cellassetimg" src="${n.content}">`:e+=`<span class="b3-chip b3-chip--middle av__celltext--url" data-url="${n.content}">${n.name}</span>`});break;case"date":e=`<span class="av__celltext" data-value='${JSON.stringify(t[t.type])}'>`,t[t.type]&&t[t.type].isNotEmpty&&(e+=Q(t[t.type].content).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),t[t.type]&&t[t.type].hasEndDate&&t[t.type].isNotEmpty&&t[t.type].isNotEmpty2&&(e+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Q(t[t.type].content2).format(t[t.type].isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),e+="</span>";break;case"created":case"updated":t[t.type].isNotEmpty&&(e=`<span data-content="${t[t.type].content}">${Q(t[t.type].content).format("YYYY-MM-DD HH:mm")}</span>`);break;case"url":e=`<input value="${t.url.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="${t.url.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconLink"></use></svg></a>`;break;case"phone":e=`<input value="${t.phone.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="tel:${t.phone.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconPhone"></use></svg></a>`;break;case"checkbox":e=`<svg class="av__checkbox" style="height: 17px;"><use xlink:href="#icon${t.checkbox.checked?"Check":"Uncheck"}"></use></svg>`;break;case"template":e=`<div class="fn__flex-1">${t.template.content}</div>`;break;case"email":e=`<input value="${t.email.content}" class="b3-text-field b3-text-field--text fn__flex-1">
<span class="fn__space"></span>
<a href="mailto:${t.email.content}" target="_blank" aria-label="${window.siyuan.languages.openBy}" class="block__icon block__icon--show fn__flex-center b3-tooltips__w b3-tooltips"><svg><use xlink:href="#iconEmail"></use></svg></a>`;break;case"relation":t.relation?.blockIDs.forEach((n,a)=>{e+=`<span class="av__celltext--url" style="margin-right: 8px" data-id="${n}">${t.relation?.contents[a]}</span>`});break;case"rollup":t?.rollup?.contents?.forEach((n,a)=>{const i=["select","mSelect","mAsset","checkbox","relation"].includes(n.type)?_a(n):ey(n);!i&&e?e=e.substring(0,e.length-2):e+=i+(a===t.rollup.contents.length-1||!i?"":",&nbsp;")});break}return e},ty=(t,e,n)=>{w("/api/av/getAttributeViewKeys",{id:e},a=>{let i="";a.data.forEach(s=>{i+=`<div data-av-id="${s.avID}" data-node-id="${e}" data-type="NodeAttributeView">
<div class="block__logo custom-attr__avheader popover__block" data-id='${JSON.stringify(s.blockIDs)}'>
    <svg><use xlink:href="#iconDatabase"></use></svg>
    <span>${s.avName||window.siyuan.languages.database}</span>
</div>`,s.keyValues?.forEach(o=>{i+=`<div class="block__icons av__row" data-id="${e}">
    <div class="block__logo">
        <svg><use xlink:href="#${Yt(o.key.type)}"></use></svg>
        <span>${o.key.name}</span>
    </div>
    <div data-av-id="${s.avID}" data-col-id="${o.values[0].keyID}" data-block-id="${o.values[0].blockID}" data-id="${o.values[0].id}" data-type="${o.values[0].type}" 
data-options="${o.key?.options?Ba(JSON.stringify(o.key.options)):"[]"}"
class="fn__flex-1 fn__flex${["url","text","number","email","phone"].includes(o.values[0].type)?"":" custom-attr__avvalue"}">
        ${_a(o.values[0])}
    </div>
</div>`}),i+="</div>"}),t.innerHTML=i,t.addEventListener("click",s=>{let o=s.target;for(;o&&!t.isSameNode(o);){const l=o.getAttribute("data-type");if(l==="date"){qn(n,[o],"date"),s.stopPropagation(),s.preventDefault();break}else if(l==="select"||l==="mSelect"){qn(n,[o],o.getAttribute("data-type")),s.stopPropagation(),s.preventDefault();break}else if(l==="mAsset"){qn(n,[o],"mAsset"),s.stopPropagation(),s.preventDefault();break}else if(l==="checkbox"){qn(n,[o],"checkbox"),s.stopPropagation(),s.preventDefault();break}else if(l==="relation"){qn(n,[o],"relation"),s.stopPropagation(),s.preventDefault();break}o=o.parentElement}}),t.querySelectorAll(".b3-text-field--text").forEach(s=>{s.addEventListener("change",()=>{let o;["url","text","email","phone"].includes(s.parentElement.dataset.type)?o={[s.parentElement.dataset.type]:{content:s.value}}:s.parentElement.dataset.type==="number"&&(o={number:{content:parseFloat(s.value)}}),w("/api/av/setAttributeViewBlockAttr",{avID:s.parentElement.dataset.avId,keyID:s.parentElement.dataset.colId,rowID:s.parentElement.dataset.blockId,cellID:s.parentElement.dataset.id,value:o})})})})},ud=(t,e)=>{let n="",a=!1;if(e&&e.forEach(i=>{(!t||t.toLowerCase().indexOf(i.name.toLowerCase())>-1||i.name.toLowerCase().indexOf(t.toLowerCase())>-1)&&(n+=`<button data-type="addColOptionOrCell" class="b3-menu__item${n?"":" b3-menu__item--current"}" draggable="true" data-name="${i.name}" data-color="${i.color}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${i.color});color:var(--b3-font-color${i.color})">
            <span class="fn__ellipsis">${i.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`),t===i.name&&(a=!0)}),!a&&t){const i=(e?.length||0)%13+1;n=`<button data-type="addColOptionOrCell" class="b3-menu__item${n?"":" b3-menu__item--current"}" data-name="${t}" data-color="${i}">
<svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
<div class="fn__flex-1">
    <span class="b3-chip" style="background-color:var(--b3-font-background${i});color:var(--b3-font-color${i})">
        <span class="fn__ellipsis">${t}</span>
    </span>
</div>
<span class="b3-menu__accelerator">Enter</span>
</button>${n}`}return n},cp=(t,e,n,a,i)=>{if(!a)return;const s=n[0].dataset.colId,o=[],l=[];n.forEach((r,c)=>{i.contains(r)||(r=n[c]=i.querySelector(`.av__cell[data-id="${r.dataset.id}"]`));const d=A(r,"av__row").dataset.id,u=jl(fo(r)||r.dataset.type,r),f=JSON.parse(JSON.stringify(u));c===0&&u.mSelect?.find((g,h)=>{if(g.content===a.dataset.content)return u.mSelect.splice(h,1),!0}),o.push({action:"updateAttrViewCell",id:u.id,keyID:s,rowID:d,avID:e.id,data:u}),l.push({action:"updateAttrViewCell",id:u.id,keyID:s,rowID:d,avID:e.id,data:f}),e.view.rows.find(g=>{if(g.id===d)return g.cells.find(h=>{if(h.id===u.id)return h.value=u,!0}),!0}),r.classList.contains("custom-attr__avvalue")?r.innerHTML=_a(u):cn(r,u)}),F(t,o,l),a.remove()},ny=(t,e,n,a,i)=>{const s=A(n,"b3-menu");if(!s)return;const o=i?i[0].dataset.colId:s.querySelector(".b3-menu__item").getAttribute("data-col-id");let l=n.parentElement.dataset.name,r=n.parentElement.dataset.color;const c=new At("av-col-option",()=>{if(l===u.value||!u.value)return;let f=!1;e.view.columns.find(g=>{if(g.id===o)return g.options.find(h=>{if(h.name===u.value)return f=!0,!0}),!0}),!f&&(F(t,[{action:"updateAttrViewColOption",id:o,avID:e.id,data:{newColor:r,oldName:l,newName:u.value}}],[{action:"updateAttrViewColOption",id:o,avID:e.id,data:{newColor:r,oldName:u.value,newName:l}}]),e.view.columns.find(g=>{if(g.id===o)return g.options.find(h=>{if(h.name===l)return h.name=u.value,!0}),!0}),i?(i.forEach(g=>{e.view.rows.find(h=>{if(h.id===A(g,"av__row").dataset.id)return h.cells.find(m=>{if(m.id===g.dataset.id)return m.value.mSelect.find(b=>{if(b.content===l)return b.content=u.value,!0}),g.classList.contains("custom-attr__avvalue")?g.innerHTML=_a(m.value):cn(g,m.value),!0}),!0})}),s.innerHTML=is(e.view,i),as(t,e,s,i,a)):(s.innerHTML=Sa({protyle:t,data:e,colId:o}),La({protyle:t,data:e,menuElement:s})))});if(c.isOpen)return;c.addItem({iconHTML:"",label:`<input class="b3-text-field" style="margin: 4px 0" value="${l}">`,bind(f){f.querySelector("input").addEventListener("keydown",g=>{g.isComposing||g.key==="Enter"&&c.close()})}}),c.addItem({label:window.siyuan.languages.delete,icon:"iconTrashcan",click(){Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmDelete,()=>{let f=[];e.view.columns.find(h=>{if(h.id===o)return f=h.options,!0});const g=n.parentElement.dataset.name;F(t,[{action:"removeAttrViewColOption",id:o,avID:e.id,data:g}],[{action:"updateAttrViewColOptions",id:o,avID:e.id,data:f}]),f.find((h,m)=>{if(h.name===g)return f.splice(m,1),!0}),i?(i.forEach(h=>{e.view.rows.find(m=>{if(m.id===A(h,"av__row").dataset.id)return m.cells.find(b=>{if(b.id===h.dataset.id)return b.value.mSelect.find((y,_)=>{if(y.content===g)return b.value.mSelect.splice(_,1),!0}),h.classList.contains("custom-attr__avvalue")?h.innerHTML=_a(b.value):cn(h,b.value),!0}),!0})}),s.innerHTML=is(e.view,i),as(t,e,s,i,a)):(s.innerHTML=Sa({protyle:t,data:e,colId:o}),La({protyle:t,data:e,menuElement:s}))})}}),c.addSeparator(),Array.from(Array(13).keys()).forEach(f=>{c.addItem({accelerator:parseInt(r)===f+1?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,iconHTML:"",label:`<span class="color__square"  style="padding: 5px;margin: 2px;color: var(--b3-font-color${f+1});background-color: var(--b3-font-background${f+1});">A</span>`,click(g){if(!g.lastElementChild.classList.contains("b3-menu__accelerator"))return g.parentElement.querySelector(".b3-menu__accelerator")?.remove(),g.insertAdjacentHTML("beforeend",'<span class="b3-menu__accelerator"><svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg></span>'),F(t,[{action:"updateAttrViewColOption",id:o,avID:e.id,data:{oldName:l,newName:u.value,oldColor:r,newColor:(f+1).toString()}}],[{action:"updateAttrViewColOption",id:o,avID:e.id,data:{oldName:u.value,newName:l,oldColor:(f+1).toString(),newColor:r}}]),e.view.columns.find(h=>{if(h.id===o)return h.options.find(m=>{if(m.name===l)return m.name=u.value,m.color=(f+1).toString(),!0}),!0}),i?(i.forEach(h=>{e.view.rows.find(m=>{if(m.id===A(h,"av__row").dataset.id)return m.cells.find(b=>{if(b.id===h.dataset.id)return b.value.mSelect.find(y=>{if(y.content===l)return y.content=u.value,y.color=(f+1).toString(),!0}),h.classList.contains("custom-attr__avvalue")?h.innerHTML=_a(b.value):cn(h,b.value),!0}),!0})}),s.innerHTML=is(e.view,i),as(t,e,s,i,a)):(s.innerHTML=Sa({protyle:t,data:e,colId:o}),La({protyle:t,data:e,menuElement:s})),l=u.value,r=(f+1).toString(),!0}})});const d=n.getBoundingClientRect();c.open({x:d.right,y:d.bottom,w:d.width,h:d.height});const u=window.siyuan.menus.menu.element.querySelector("input");u.select()},as=(t,e,n,a,i)=>{const s=n.querySelector("input"),o=a[0].dataset.colId;let l;e.view.columns.find(c=>{if(c.id===o){l=c;return}}),l.options||(l.options=[]);const r=n.lastElementChild.lastElementChild;s.addEventListener("input",c=>{c.isComposing||(r.innerHTML=ud(s.value,l.options))}),s.addEventListener("compositionend",c=>{c.isComposing||(r.innerHTML=ud(s.value,l.options))}),s.addEventListener("keydown",c=>{if(c.isComposing)return;let d=Bn(r,c,"b3-menu__item--current");c.key==="Enter"?(d||(d=n.querySelector(".b3-menu__item--current")),dp(t,e,a,d,n,i)):c.key==="Backspace"&&s.value===""&&cp(t,e,a,s.previousElementSibling,i)})},dp=(t,e,n,a,i,s)=>{let o=!1;if(Array.from(i.querySelectorAll(".b3-chips .b3-chip")).find(f=>{if(f.dataset.content===a.dataset.name)return o=!0,!0}),o){i.querySelector("input").focus();return}x(n[0])||n.forEach((f,g)=>{n[g]=s.querySelector(`.av__cell[data-id="${f.dataset.id}"]`)});const r=n[0].dataset.colId;let c;e.view.columns.find(f=>{if(f.id===r){c=f,c.options||(c.options=[]);return}});const d=[],u=[];n.forEach((f,g)=>{const h=A(f,"av__row");if(!h)return;const m=jl(c.type,f),b=JSON.parse(JSON.stringify(m));if(g===0)if(c.type==="mSelect"){let _=!1;m.mSelect.find(v=>{if(v.content===a.dataset.name)return _=!0,!0}),_||m.mSelect.push({color:a.dataset.color,content:a.dataset.name})}else m.mSelect=[{color:a.dataset.color,content:a.dataset.name}];const y=h.dataset.id;d.push({action:"updateAttrViewCell",id:m.id,keyID:r,rowID:y,avID:e.id,data:m}),u.push({action:"updateAttrViewCell",id:m.id,keyID:r,rowID:y,avID:e.id,data:b}),e.view.rows.find(_=>{if(_.id===y)return _.cells.find(v=>{if(v.id===m.id)return v.value=m,!0}),!0}),f.classList.contains("custom-attr__avvalue")?f.innerHTML=_a(m):cn(f,m)}),a.querySelector(".b3-menu__accelerator")?(c.options.push({color:a.dataset.color,name:a.dataset.name}),d.splice(0,0,{action:"updateAttrViewColOptions",id:r,avID:e.id,data:c.options}),F(t,d,[{action:"removeAttrViewColOption",id:r,avID:e.id,data:a.dataset.name}])):F(t,d,u),c.type==="select"?i.parentElement.remove():(i.innerHTML=is(e.view,n),as(t,e,i,n,s),i.querySelector("input").focus())},is=(t,e)=>{const n=e[0].dataset.colId,a=t.columns.find(o=>{if(o.id===n)return o});let i=[];t.rows.find(o=>{const l=A(e[0],"av__row");if(l&&l.dataset.id===o.id)return o.cells.find(r=>{if(r.id===e[0].dataset.id)return r.value&&r.value.mSelect&&(i=r.value.mSelect),!0}),!0});let s="";return i.forEach(o=>{s+=`<div class="b3-chip b3-chip--middle" data-content="${Ba(o.content)}" style="background-color:var(--b3-font-background${o.color});color:var(--b3-font-color${o.color})">${o.content}<svg class="b3-chip__close" data-type="removeCellOption"><use xlink:href="#iconCloseRound"></use></svg></div>`}),`<div class="b3-menu__items">
<div class="b3-chips">
    ${s}
    <input>
</div>
<div>${ud("",a.options)}</div>
</div>`},Yl=t=>{if(["select","number","date","created","updated"].includes(t))return"=";if(["checkbox"].includes(t))return"Is false";if(["rollup","relation","rollup","text","mSelect","url","block","email","phone","template"].includes(t))return"Contains"},up=(t,e,n)=>{const a=A(t,"b3-menu");a&&a.querySelectorAll("input, .b3-chip").forEach((i,s)=>{const o=A(i,"b3-menu__item");o&&(["date","updated","created"].includes(n)?e==="Is between"?o.classList.remove("fn__none"):e==="Is empty"||e==="Is not empty"?o.classList.add("fn__none"):s===0?o.classList.remove("fn__none"):o.classList.add("fn__none"):e!=="Is empty"&&e!=="Is not empty"?o.classList.remove("fn__none"):o.classList.add("fn__none"))})},fd=async t=>{let e=t.target.getBoundingClientRect();e.height===0&&(e=t.protyle.wysiwyg.element.querySelector(`[data-col-id="${t.target.dataset.colId}"]`).getBoundingClientRect());const n=new At("set-filter-"+t.filter.column,()=>{const r=JSON.parse(JSON.stringify(t.data.view.filters)),c=window.siyuan.menus.menu.element.querySelector(".b3-select");if(!c)return;const d=c.value;let u=!1,f;if(l.length>0)["date","updated","created"].includes(s)?f=za(s,{isNotEmpty2:l[1].value!=="",isNotEmpty:l[0].value!=="",content:l[0].value?new Date(l[0].value+" 00:00").getTime():null,content2:l[1].value?new Date(l[1].value+" 00:00").getTime():null,hasEndDate:d==="Is between",isNotTime:!0}):f=za(s,l[0].value);else if(s==="select"||s==="mSelect"){const b=[];window.siyuan.menus.menu.element.querySelectorAll("svg").forEach(y=>{if(y.firstElementChild.getAttribute("xlink:href")==="#iconCheck"){const _=y.nextElementSibling.firstElementChild;b.push({color:_.dataset.color,content:_.dataset.name})}}),f=za(s,b)}else f=za(s,void 0);const g={column:t.filter.column,value:f,operator:d};let h=!1;if(t.data.view.filters.find((b,y)=>{if(b.column===t.filter.column)return delete b.type,(0,I.MK)(b,g)?(h=!0,!0):(t.data.view.filters[y]=g,u=!0,!0)}),h||!u)return;F(t.protyle,[{action:"setAttrViewFilters",avID:t.data.id,data:t.data.view.filters}],[{action:"setAttrViewFilters",avID:t.data.id,data:r}]);const m=A(t.target,"b3-menu");m&&(m.innerHTML=Fa(t.data.view))});if(n.isOpen)return;let a="",i;t.data.view.columns.find(r=>{if(r.id===t.filter.column)return i=r,!0});let s=i.type;if(s==="rollup"){if(!i.rollup||!i.rollup.relationKeyID||!i.rollup.keyID){M(window.siyuan.languages.plsChoose),Zt({protyle:t.protyle,blockElement:t.blockElement,type:"edit",colId:i.id});return}let r="";t.data.view.columns.find(d=>{if(d.id===i.rollup.relationKeyID)return r=d.relation.avID,!0}),(await lt("/api/av/getAttributeView",{id:r})).data.av.keyValues.find(d=>{if(d.key.id===i.rollup.keyID)return s=d.key.type,!0}),t.data.view.filters.find(d=>{if(d.column===i.id&&d.type)return d.operator=Yl(s),d.value=za(s,""),delete d.type,!0})}switch(s){case"checkbox":a=`<option ${t.filter.operator==="Is true"?"selected":""} value="Is true">${window.siyuan.languages.checked}</option>
<option ${t.filter.operator==="Is false"?"selected":""} value="Is false">${window.siyuan.languages.unchecked}</option>`;break;case"block":case"text":case"url":case"phone":case"email":a=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${t.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"template":a=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Starts with"?"selected":""} value="Starts with">${window.siyuan.languages.filterOperatorStartsWith}</option>
<option ${t.filter.operator==="Ends with"?"selected":""} value="Ends with">${window.siyuan.languages.filterOperatorEndsWith}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>
<option ${t.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">&le;</option>`;break;case"date":case"created":case"updated":a=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator===">"?"selected":""} value=">">${window.siyuan.languages.filterOperatorIsAfter}</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">${window.siyuan.languages.filterOperatorIsBefore}</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">${window.siyuan.languages.filterOperatorIsOnOrAfter}</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">${window.siyuan.languages.filterOperatorIsOnOrBefore}</option>
<option ${t.filter.operator==="Is between"?"selected":""} value="Is between">${window.siyuan.languages.filterOperatorIsBetween}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"number":a=`<option ${t.filter.operator==="="?"selected":""} value="=">=</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">!=</option>
<option ${t.filter.operator===">"?"selected":""} value=">">&gt;</option>
<option ${t.filter.operator==="<"?"selected":""} value="<">&lt;</option>
<option ${t.filter.operator===">="?"selected":""} value=">=">&GreaterEqual;</option>
<option ${t.filter.operator==="<="?"selected":""} value="<=">&le;</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"mSelect":case"relation":a=`<option ${t.filter.operator==="Contains"?"selected":""} value="Contains">${window.siyuan.languages.filterOperatorContains}</option>
<option ${t.filter.operator==="Does not contains"?"selected":""} value="Does not contains">${window.siyuan.languages.filterOperatorDoesNotContain}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break;case"select":a=`<option ${t.filter.operator==="="?"selected":""} value="=">${window.siyuan.languages.filterOperatorIs}</option>
<option ${t.filter.operator==="!="?"selected":""} value="!=">${window.siyuan.languages.filterOperatorIsNot}</option>
<option ${t.filter.operator==="Is empty"?"selected":""} value="Is empty">${window.siyuan.languages.filterOperatorIsEmpty}</option>
<option ${t.filter.operator==="Is not empty"?"selected":""} value="Is not empty">${window.siyuan.languages.filterOperatorIsNotEmpty}</option>`;break}if(n.addItem({iconHTML:"",label:`<select style="margin: 4px 0" class="b3-select fn__size200">${a}</select>`}),s==="select"||s==="mSelect")i.options?.forEach(r=>{let c="iconUncheck";t.filter.value?.mSelect.find(d=>{d.content===r.name&&(c="iconCheck")}),n.addItem({icon:c,label:`<span class="b3-chip b3-chip--middle" data-name="${r.name}" data-color="${r.color}" style="margin:3px 0;background-color:var(--b3-font-background${r.color});color:var(--b3-font-color${r.color})">
    <span class="fn__ellipsis">${r.name}</span>
</span>`,bind(d){d.addEventListener("click",()=>{const u=d.querySelector("use");u.getAttribute("xlink:href")==="#iconUncheck"?u.setAttribute("xlink:href","#iconCheck"):u.setAttribute("xlink:href","#iconUncheck")})}})});else if(["text","url","block","email","phone","template","relation"].includes(s)){let r="";t.filter.value&&(s==="relation"?r=t.filter.value.relation.contents[0]||"":r=t.filter.value[s].content||""),n.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${r}" class="b3-text-field fn__size200">`})}else if(s==="number")n.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${t.filter.value?.number.isNotEmpty?t.filter.value.number.content:""}" class="b3-text-field fn__size200">`});else if(["date","updated","created"].includes(s)){const r=t.filter.value?t.filter.value[s]:null;n.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${r.isNotEmpty||s!=="date"?Q(r.content).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__size200">`}),n.addItem({iconHTML:"",label:`<input style="margin: 4px 0" value="${r.isNotEmpty2?Q(r.content2).format("YYYY-MM-DD"):""}" type="date" max="9999-12-31" class="b3-text-field fn__size200">`})}n.addItem({icon:"iconTrashcan",label:window.siyuan.languages.removeFilters,click(){const r=Object.assign([],t.data.view.filters);t.data.view.filters.find((d,u)=>{if(d.column===t.filter.column)return t.data.view.filters.splice(u,1),!0}),F(t.protyle,[{action:"setAttrViewFilters",avID:t.data.id,data:t.data.view.filters}],[{action:"setAttrViewFilters",avID:t.data.id,data:r}]);const c=A(t.target,"b3-menu");c&&(c.innerHTML=Fa(t.data.view))}});const o=window.siyuan.menus.menu.element.querySelector(".b3-select");o.addEventListener("change",()=>{up(o,o.value,s)});const l=window.siyuan.menus.menu.element.querySelectorAll(".b3-text-field");l.forEach(r=>{r.addEventListener("keydown",c=>{if(c.isComposing){c.preventDefault();return}c.key==="Enter"&&(n.close(),c.preventDefault())})}),up(o,o.value,s),n.open({x:e.left,y:e.bottom}),l.length>0&&l[0].select()},ay=t=>{const e=new At("av-add-filter");t.data.view.columns.forEach(n=>{let a=!1;t.data.view.filters.find(i=>{if(i.column===n.id)return a=!0,!0}),!a&&n.type!=="mAsset"&&e.addItem({label:n.name,iconHTML:n.icon?ie(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Yt(n.type)}"></use></svg>`,click:()=>{const i=za(n.type,"");t.data.view.filters.push({column:n.id,operator:Yl(n.type),value:i,type:n.type}),t.menuElement.innerHTML=Fa(t.data.view),ke(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height);const s=t.menuElement.querySelector(`[data-id="${n.id}"] .b3-chip`);fd({filter:{operator:Yl(n.type),column:n.id,value:i},protyle:t.protyle,data:t.data,target:s,blockElement:t.blockElement})}})}),e.open({x:t.rect.left,y:t.rect.bottom,h:t.rect.height})},Fa=t=>{let e="";const n=a=>{let i="";return t.columns.find(s=>{if(s.id===a.column){let o="";if(a.operator==="Is empty")o=": "+window.siyuan.languages.filterOperatorIsEmpty;else if(a.operator==="Is not empty")o=": "+window.siyuan.languages.filterOperatorIsNotEmpty;else if(a.operator==="Is false")o=": "+window.siyuan.languages.unchecked;else if(a.operator==="Is true")o=": "+window.siyuan.languages.checked;else if(a.value?.date?.content)a.value?.date?.content2&&a.operator==="Is between"?o=` ${window.siyuan.languages.filterOperatorIsBetween} ${Q(a.value.date.content).format("YYYY-MM-DD")} ${Q(a.value.date.content2).format("YYYY-MM-DD")}`:a.operator==="="?o=`: ${Q(a.value.date.content).format("YYYY-MM-DD")}`:[">","<"].includes(a.operator)?o=` ${a.operator} ${Q(a.value.date.content).format("YYYY-MM-DD")}`:a.operator===">="?o=` \u2265 ${Q(a.value.date.content).format("YYYY-MM-DD")}`:a.operator==="<="&&(o=` \u2264 ${Q(a.value.date.content).format("YYYY-MM-DD")}`);else if(a.value?.mSelect?.length>0){let l="";a.value.mSelect.forEach((r,c)=>{l+=r.content,c!==a.value.mSelect.length-1&&(l+=", ")}),a.operator==="Contains"?o=`: ${l}`:a.operator==="Does not contains"&&(o=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${l}`)}else if(a.value?.number?.content)["=","!=",">","<"].includes(a.operator)?o=` ${a.operator} ${a.value.number.content}`:a.operator===">="?o=` \u2265 ${a.value.number.content}`:a.operator==="<="&&(o=` \u2264 ${a.value.number.content}`);else if(a.value?.text?.content||a.value?.block?.content||a.value?.url?.content||a.value?.phone?.content||a.value?.email?.content||a.value?.relation?.contents.length>0){const l=a.value?.text?.content||a.value?.block?.content||a.value?.url?.content||a.value?.phone?.content||a.value?.email?.content||a.value?.relation?.contents[0];["=","Contains"].includes(a.operator)?o=`: ${l}`:a.operator==="Does not contains"?o=` ${window.siyuan.languages.filterOperatorDoesNotContain} ${l}`:a.operator==="!="?o=` ${window.siyuan.languages.filterOperatorIsNot} ${l}`:a.operator==="Starts with"?o=` ${window.siyuan.languages.filterOperatorStartsWith} ${l}`:a.operator==="Ends with"&&(o=` ${window.siyuan.languages.filterOperatorEndsWith} ${l}`)}return i+=`<span data-type="setFilter" class="b3-chip${o?" b3-chip--primary":""}">
    ${s.icon?ie(s.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${Yt(s.type)}"></use></svg>`}
    <span class="fn__ellipsis">${s.name}${o}</span>
</span>`,!0}}),i};return t.filters.forEach(a=>{e+=`<button class="b3-menu__item" draggable="true" data-id="${a.column}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">${n(a)}</div>
    <svg class="b3-menu__action" data-type="removeFilter"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.filter}</span>
</button>
<button class="b3-menu__separator"></button>
${e}
<button class="b3-menu__item${t.filters.length===t.columns.length?" fn__none":""}" data-type="addFilter">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.addFilter}</span>
</button>
<button class="b3-menu__item${e?"":" fn__none"}" data-type="removeFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.removeFilters}</span>
</button>
</div>`},iy=t=>{const e=new At("av-add-sort");t.data.view.columns.forEach(n=>{let a=!1;t.data.view.sorts.find(i=>{if(i.column===n.id)return a=!0,!0}),a||e.addItem({label:n.name,iconHTML:n.icon?ie(n.icon,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Yt(n.type)}"></use></svg>`,click:()=>{const i=Object.assign([],t.data.view.sorts);t.data.view.sorts.push({column:n.id,order:"ASC"}),F(t.protyle,[{action:"setAttrViewSorts",avID:t.data.id,data:t.data.view.sorts}],[{action:"setAttrViewSorts",avID:t.data.id,data:i}]),t.menuElement.innerHTML=os(t.data.view.columns,t.data.view.sorts),ss(t.protyle,t.menuElement,t.data),ke(t.menuElement,t.tabRect.right-t.menuElement.clientWidth,t.tabRect.bottom,t.tabRect.height)}})}),e.open({x:t.rect.left,y:t.rect.bottom,h:t.rect.height})},ss=(t,e,n)=>{e.querySelectorAll("select").forEach(a=>{a.addEventListener("change",()=>{const i=a.parentElement.getAttribute("data-id"),s=JSON.parse(JSON.stringify(n.view.sorts));a.previousElementSibling.classList.contains("b3-menu__icon")?n.view.sorts.find(o=>{if(o.column===i)return o.column=a.value,a.parentElement.setAttribute("data-id",a.value),!0}):n.view.sorts.find(o=>o.column===i).order=a.value,F(t,[{action:"setAttrViewSorts",avID:n.id,data:n.view.sorts}],[{action:"setAttrViewSorts",avID:n.id,data:s}])})})},os=(t,e)=>{let n="";const a=i=>{let s="";return t.forEach(o=>{s+=`<option value="${o.id}" ${o.id===i?"selected":""}>${o.name}</option>`}),s};return e.forEach(i=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${i.column}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <select class="b3-select" style="margin: 4px 0">
        ${a(i.column)}
    </select>
    <span class="fn__space"></span>
    <select class="b3-select" style="margin: 4px 0">
        <option value="ASC" ${i.order==="ASC"?"selected":""}>${window.siyuan.languages.asc}</option>
        <option value="DESC" ${i.order==="DESC"?"selected":""}>${window.siyuan.languages.desc}</option>
    </select>
    <svg class="b3-menu__action" data-type="removeSort"><use xlink:href="#iconTrashcan"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.sort}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
<button class="b3-menu__item${e.length===t.length?" fn__none":""}" data-type="addSort">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__item${n?"":" fn__none"}" data-type="removeSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`},sy=(t,e)=>{let n=!0,a;e.forEach(l=>{t.rows.find(r=>{if(A(l,"av__row").dataset.id===r.id)return r.cells.find(c=>{if(c.id===l.dataset.id)return(!c.value||!c.value.date||!c.value.date.hasEndDate)&&(n=!1),a=c,!0}),!0})}),a||(n=!1);const i=!a||a?.value?.date?.isNotTime;let s="";a?.value?.date?.isNotEmpty&&(s=Q(a.value.date.content).format(i?"YYYY-MM-DD":"YYYY-MM-DD HH:mm"));let o="";return a?.value?.date?.isNotEmpty2&&(o=Q(a.value.date.content2).format(i?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),`<div class="b3-menu__items">
<div>
    <input type="${i?"date":"datetime-local"}" max="${i?"9999-12-31":"9999-12-31 23:59"}" value="${s}" data-value="${s?Q(a.value.date.content).format("YYYY-MM-DD HH:mm"):""}" class="b3-text-field fn__size200" style="margin-top: 4px;"><br>
    <input type="${i?"date":"datetime-local"}" max="${i?"9999-12-31":"9999-12-31 23:59"}" value="${o}" data-value="${o?Q(a.value.date.content2).format("YYYY-MM-DD HH:mm"):""}" style="margin-top: 8px;margin-bottom: 4px" class="b3-text-field fn__size200${n?"":" fn__none"}">
    <button class="b3-menu__separator"></button>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.endDate}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${n?" checked":""}>
    </label>
    <label class="b3-menu__item">
        <span class="fn__flex-center">${window.siyuan.languages.includeTime}</span>
        <span class="fn__space fn__flex-1"></span>
        <input type="checkbox" class="b3-switch b3-switch--menu"${i?"":" checked"}>
    </label>
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="clearDate">
        <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.clear}</span>
    </button>
</div>
</div>`},oy=t=>{const e=t.menuElement.querySelectorAll("input");e[0].addEventListener("change",()=>{e[0].dataset.value=e[0].value.length>10?e[0].value:e[0].value+" 00:00",An(t.protyle,t.blockElement,{content:new Date(e[0].dataset.value).getTime(),isNotEmpty:e[0].value!=="",content2:new Date(e[1].dataset.value).getTime(),isNotEmpty2:e[1].value!=="",hasEndDate:e[2].checked,isNotTime:!e[3].checked},t.cellElements)}),e[1].addEventListener("change",()=>{e[1].dataset.value=e[1].value.length>10?e[1].value:e[1].value+" 00:00",An(t.protyle,t.blockElement,{content:new Date(e[0].dataset.value).getTime(),isNotEmpty:e[0].value!=="",content2:new Date(e[1].dataset.value).getTime(),isNotEmpty2:e[1].value!=="",hasEndDate:e[2].checked,isNotTime:!e[3].checked},t.cellElements)}),e[2].addEventListener("change",()=>{e[2].checked?e[1].classList.remove("fn__none"):e[1].classList.add("fn__none"),An(t.protyle,t.blockElement,{content:new Date(e[0].dataset.value).getTime(),isNotEmpty:e[0].value!=="",content2:new Date(e[1].dataset.value).getTime(),isNotEmpty2:e[1].value!=="",hasEndDate:e[2].checked,isNotTime:!e[3].checked},t.cellElements)}),e[3].addEventListener("change",()=>{e[3].checked?(e[0].setAttribute("type","datetime-local"),e[1].setAttribute("type","datetime-local"),e[0].setAttribute("max","9999-12-31 23:59"),e[1].setAttribute("max","9999-12-31 23:59"),e[0].value=e[0].dataset.value,e[1].value=e[1].dataset.value):(e[0].setAttribute("type","date"),e[1].setAttribute("type","date"),e[0].setAttribute("max","9999-12-31"),e[1].setAttribute("max","9999-12-31"),e[0].value=e[0].dataset.value.substring(0,10),e[1].value=e[1].dataset.value.substring(0,10)),An(t.protyle,t.blockElement,{content:new Date(e[0].dataset.value).getTime(),isNotEmpty:e[0].value!=="",content2:new Date(e[1].dataset.value).getTime(),isNotEmpty2:e[1].value!=="",hasEndDate:e[2].checked,isNotTime:!e[3].checked},t.cellElements)})},yn=t=>{t.menu.addItem({iconHTML:"",label:fp(t.format),click(){F(t.protyle,[{action:"updateAttrViewColNumberFormat",id:t.colId,avID:t.avID,format:t.format,type:"number"}],[{action:"updateAttrViewColNumberFormat",id:t.colId,avID:t.avID,format:t.oldFormat,type:"number"}]),t.avPanelElement.remove()}})},ly=t=>{const e=new At("av-col-format-number");yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"commas",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"percent",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"usDollar",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"yuan",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"euro",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"pound",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"yen",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"ruble",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"rupee",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"won",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"canadianDollar",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement}),yn({menu:e,protyle:t.protyle,colId:t.colId,avID:t.avID,format:"franc",oldFormat:t.oldFormat,avPanelElement:t.avPanelElement});const n=t.element.getBoundingClientRect();e.open({x:n.left,y:n.bottom,h:n.height,w:n.width,isLeft:!0})},fp=t=>{switch(t){case"":return window.siyuan.languages.numberFormatNone;case"commas":return window.siyuan.languages.numberFormatCommas;case"percent":return window.siyuan.languages.numberFormatPercent;case"usDollar":return window.siyuan.languages.numberFormatUSDollar;case"yuan":return window.siyuan.languages.numberFormatYuan;case"euro":return window.siyuan.languages.numberFormatEuro;case"pound":return window.siyuan.languages.numberFormatPound;case"yen":return window.siyuan.languages.numberFormatYen;case"ruble":return window.siyuan.languages.numberFormatRuble;case"rupee":return window.siyuan.languages.numberFormatRupee;case"won":return window.siyuan.languages.numberFormatWon;case"canadianDollar":return window.siyuan.languages.numberFormatCanadianDollar;case"franc":return window.siyuan.languages.numberFormatFranc}},pd=t=>{(0,ze.addScript)(`${p.Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{const e=document.createElement("ul");e.innerHTML=`<li><img src="${t}"></li>`,window.siyuan.viewer=new Viewer(e,{title:[1,(n,a)=>{let i=n.alt;return i||(i=n.src.substring(n.src.lastIndexOf("/")+1)),i=i.substring(0,i.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${i} [${a.naturalWidth} \xD7 ${a.naturalHeight}]`}],button:!1,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})},pp=(t,e)=>{(0,ze.addScript)(`${p.Constants.PROTYLE_CDN}/js/viewerjs/viewer.js?v=1.10.4`,"protyleViewerScript").then(()=>{w("/api/asset/getDocImageAssets",{id:e},n=>{const a=document.createElement("ul");let i="",s=-1;n.data.forEach((o,l)=>{o&&(i+=`<li><img src="${o}"></li>`,s===-1&&(t.endsWith(encodeURI(o))||t.endsWith(o))&&(s=l))}),a.innerHTML=i,window.siyuan.viewer=new Viewer(a,{title:[1,(o,l)=>{let r=o.alt;return r||(r=o.src.substring(o.src.lastIndexOf("/")+1)),r=r.substring(0,r.lastIndexOf(".")).replace(/-\d{14}-\w{7}$/,""),`${r} [${l.naturalWidth} \xD7 ${l.naturalHeight}]`}],button:!1,initialViewIndex:s,transition:!1,hidden:function(){window.siyuan.viewer.destroy()},toolbar:{zoomIn:!0,zoomOut:!0,oneToOne:!0,reset:!0,prev:!0,play:!0,next:!0,rotateLeft:!0,rotateRight:!0,flipHorizontal:!0,flipVertical:!0,close:function(){window.siyuan.viewer.destroy()}}}),window.siyuan.viewer.show()})})},gp=t=>{t.menuElement.querySelector("input").addEventListener("change",e=>{e.target.files.length!==0&&ka(t.protyle,e.target.files,e.target,n=>{const a=JSON.parse(n),i=[];Object.keys(a.data.succMap).forEach(s=>{i.push({name:s,content:a.data.succMap[s],type:p.Constants.SIYUAN_ASSETS_IMAGE.includes(Le().extname(a.data.succMap[s]).toLowerCase())?"image":"file"})}),wi({protyle:t.protyle,data:t.data,cellElements:t.cellElements,type:"addUpdate",addUpdateValue:i,blockElement:t.blockElement})})})},hp=(t,e)=>{const n=e[0].dataset.id,a=A(e[0],"av__row").dataset.id;let i;t.rows.find(o=>{if(o.id===a)return o.cells.find(l=>{if(l.id===n)return i=l,!0}),!0});let s="";return i?.value?.mAsset&&i.value.mAsset.forEach(o=>{if(!o.content)return;let l;o.type==="image"?l=`<span data-type="openAssetItem" class="fn__flex-1">
    <img style="max-height: 180px;max-width: 360px;border-radius: var(--b3-border-radius);margin: 4px 0;" src="${o.content}"/>
</span>`:l=`<span data-type="openAssetItem" class="fn__ellipsis b3-menu__label" style="max-width: 360px">${o.name}</span>`,s+=`<button class="b3-menu__item" draggable="true" data-name="${o.name}" data-type="${o.type}" data-content="${o.content}">
<svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
${l}
<svg class="b3-menu__action" data-type="editAssetItem"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
    ${s}
    <button data-type="addAssetExist" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconImage"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.assets}</span>
    </button>
    <button class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconDownload"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.insertAsset}</span> 
        <input multiple class="b3-form__upload" type="file">
    </button>
    <button data-type="addAssetLink" class="b3-menu__item">
        <svg class="b3-menu__icon"><use xlink:href="#iconLink"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.link}</span>
    </button>
</div>`},wi=t=>{const e=t.cellElements[0].dataset.colId,n=[],a=[];t.cellElements.forEach((s,o)=>{t.blockElement.contains(s)||(s=t.cellElements[o]=t.blockElement.querySelector(`.av__cell[data-id="${s.dataset.id}"]`));const l=jl(fo(s)||s.dataset.type,s),r=A(s,"av__row").dataset.id,c=JSON.parse(JSON.stringify(l));o===0&&(t.type==="remove"?l.mAsset.find((d,u)=>{if(d.content===t.removeContent)return l.mAsset.splice(u,1),!0}):t.type==="addUpdate"?t.addUpdateValue.forEach(d=>{if(!d.content)return;l.mAsset.find(f=>{if(f.content===d.content)return f.name=d.name,f.type=d.type,!0})||(d.type==="file"&&!d.name&&(d.name=d.content),l.mAsset.push(d))}):l.mAsset=t.replaceValue),n.push({action:"updateAttrViewCell",id:l.id,keyID:e,rowID:r,avID:t.data.id,data:l}),a.push({action:"updateAttrViewCell",id:l.id,keyID:e,rowID:r,avID:t.data.id,data:c}),t.data.view.rows.find(d=>{if(d.id===r)return d.cells.find(u=>{if(u.id===l.id)return u.value=l,!0}),!0}),s.classList.contains("custom-attr__avvalue")?s.innerHTML=_a(l):cn(s,l)}),F(t.protyle,n,a);const i=document.querySelector(".av__panel > .b3-menu");if(i){i.innerHTML=hp(t.data.view,t.cellElements),gp({protyle:t.protyle,data:t.data,menuElement:i,cellElements:t.cellElements,blockElement:t.blockElement});const s=(t.cellElements[0].classList.contains("custom-attr__avvalue")?t.cellElements[0]:t.protyle.wysiwyg.element.querySelector(`.av__cell[data-id="${t.cellElements[0].dataset.id}"]`)).getBoundingClientRect();setTimeout(()=>{ke(i,s.left,s.bottom,s.height)},p.Constants.TIMEOUT_LOAD)}},ry=(t,e,n,a,i)=>{const s=a.dataset.content,o=a.dataset.type,l=new At("av-asset-edit",()=>{!r||!r.value||r.value===a.dataset.name||wi({protyle:t,data:e,cellElements:n,type:"addUpdate",blockElement:i,addUpdateValue:[{content:s,name:r.value,type:o}]})});if(l.isOpen)return;o==="file"?l.addItem({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${(0,I.tq)()?"200":"360"}px" class="b3-text-field"></textarea>`}):l.addItem({icon:"iconPreview",label:window.siyuan.languages.cardPreview,click(){pd(s)}}),l.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){wi({protyle:t,data:e,cellElements:n,blockElement:i,type:"remove",removeContent:s})}}),Lo(t?t.app:window.siyuan.ws.app,s,!1,!0),s?.startsWith("assets/")&&window.siyuan.menus.menu.append(new S(zl(s)).element);const r=l.element.querySelector("textarea");r&&(r.value=a.dataset.name);const c=a.getBoundingClientRect();l.open({x:c.right,y:c.top,w:c.width,h:c.height})},cy=(t,e,n,a,i)=>{const s=new At("av-asset-link",()=>{const l=s.element.querySelectorAll("textarea");l[0].value&&wi({protyle:t,data:e,cellElements:n,blockElement:i,type:"addUpdate",addUpdateValue:[{type:"file",name:l[1].value,content:l[0].value}]})});if(s.isOpen)return;s.addItem({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${(0,I.tq)()?"200":"360"}px" class="b3-text-field" placeholder="${window.siyuan.languages.link}"></textarea>`}),s.addItem({iconHTML:"",label:`<textarea rows="1" style="margin:4px 0;width: ${(0,I.tq)()?"200":"360"}px" class="b3-text-field" placeholder="${window.siyuan.languages.title}"></textarea>`});const o=a.getBoundingClientRect();s.open({x:o.right,y:o.bottom,w:a.parentElement.clientWidth+8,h:o.height})},dy=(t,e,n,a)=>{const i=M(window.siyuan.languages.uploading,0);w("/api/asset/insertLocalAssets",{assetPaths:t,isUpload:!0,id:e.block.rootID},s=>{const o=x(n);if(o){W(i);const l=[];Object.keys(s.data.succMap).forEach(r=>{const c=Le().extname(r).toLowerCase(),d=r.substring(0,r.length-c.length);p.Constants.SIYUAN_ASSETS_IMAGE.includes(c)?l.push({type:"image",name:d,content:s.data.succMap[r]}):l.push({type:"file",name:d,content:s.data.succMap[r]})}),w("/api/av/renderAttributeView",{id:a,pageSize:parseInt(o.getAttribute("data-page-size"))||void 0},r=>{wi({protyle:e,blockElement:o,data:r.data,cellElements:[n],type:"addUpdate",addUpdateValue:l})})}})},ro=t=>{const e=new At("av-view");if(e.isOpen)return;e.addItem({icon:"iconEdit",label:window.siyuan.languages.rename,click(){document.querySelector(".av__panel")?.remove(),Zt({protyle:t.protyle,blockElement:t.blockElement,type:"config",cb:a=>{a.querySelector('.b3-text-field[data-type="name"]').focus()}})}}),e.addItem({icon:"iconSettings",label:window.siyuan.languages.config,click(){document.querySelector(".av__panel")?.remove(),Zt({protyle:t.protyle,blockElement:t.blockElement,type:"config"})}}),e.addSeparator(),e.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){document.querySelector(".av__panel")?.remove();const a=Lute.NewNodeID();F(t.protyle,[{action:"duplicateAttrViewView",avID:t.blockElement.dataset.avId,previousID:t.element.dataset.id,id:a}],[{action:"removeAttrViewView",avID:t.blockElement.dataset.avId,id:a}])}}),e.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){document.querySelector(".av__panel")?.remove(),t.blockElement.querySelectorAll(".layout-tab-bar .item").length===1?rn(t.protyle,t.blockElement,re(t.blockElement)):F(t.protyle,[{action:"removeAttrViewView",avID:t.blockElement.dataset.avId,id:t.element.dataset.id}])}});const n=t.element.getBoundingClientRect();e.open({x:n.left,y:n.bottom})},mp=t=>{const e=t.menuElement.querySelector('.b3-text-field[data-type="name"]');e.addEventListener("blur",()=>{e.value!==e.dataset.value&&(F(t.protyle,[{action:"setAttrViewViewName",avID:t.data.id,id:t.data.viewID,data:e.value}],[{action:"setAttrViewViewName",avID:t.data.id,id:t.data.viewID,data:e.dataset.value}]),e.dataset.value=e.value)}),e.select()},bp=t=>`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label ft__center">${window.siyuan.languages.config}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span style="padding: 5px;margin-right: 8px;width: 14px;font-size: 14px;" class="block__icon block__icon--show" data-icon="${t.icon}" data-type="update-view-icon">${t.icon?ie(t.icon):'<svg><use xlink:href="#iconTable"></use></svg>'}</span>
    <span class="b3-menu__label" style="padding: 4px;display: flex;"><input data-type="name" class="b3-text-field fn__block" type="text" value="${t.name}" data-value="${t.name}"></span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="go-properties">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
    <span class="b3-menu__accelerator">${t.columns.filter(e=>!e.hidden).length}/${t.columns.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goFilters">
    <svg class="b3-menu__icon"><use xlink:href="#iconFilter"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.filter}</span>
    <span class="b3-menu__accelerator">${t.filters.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSorts">
    <svg class="b3-menu__icon"><use xlink:href="#iconSort"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.sort}</span>
    <span class="b3-menu__accelerator">${t.sorts.length}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="set-page-size" data-size="${t.pageSize}">
    <svg class="b3-menu__icon"></svg>
    <span class="b3-menu__label">${window.siyuan.languages.pageCount}</span>
    <span class="b3-menu__accelerator">${t.pageSize}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="duplicate-view">
    <svg class="b3-menu__icon">
        <use xlink:href="#iconCopy"></use>
    </svg>
    <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
</button>
<button class="b3-menu__item" data-type="delete-view">
    <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
</button>
</div>`,uy=(t,e)=>{let n="";return t.forEach(a=>{n+=`<button draggable="true" class="b3-menu__item" data-id="${a.id}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
     <div class="fn__flex-1">
        <span class="b3-chip${a.id===e?" b3-chip--primary":""}">
            ${a.icon?ie(a.icon,"icon",!0):'<svg class="icon"><use xlink:href="#iconTable"></use></svg>'}
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="av-view-edit"><use xlink:href="#iconEdit"></use></svg>
</button>`}),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="av-add">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
<button class="b3-menu__separator"></button>
${n}
</div>`},wp=(t,e)=>{const n=Lute.NewNodeID(),a=e.getAttribute("data-av-id");F(t,[{action:"addAttrViewView",avID:a,id:n}],[{action:"removeAttrViewView",avID:a,id:n}])},ta=(t,e)=>{const n=A(t,"av__row");if(!n)return;const a=t.querySelector("use");n.classList.contains("av__row--header")||e==="unselectAll"?a.getAttribute("xlink:href")==="#iconCheck"?n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconUncheck");const s=A(i,"av__row");s&&s.classList.remove("av__row--select")}):n.parentElement.querySelectorAll(".av__firstcol").forEach(i=>{i.querySelector("use").setAttribute("xlink:href","#iconCheck");const s=A(i,"av__row");s&&s.classList.add("av__row--select")}):e==="select"||a.getAttribute("xlink:href")==="#iconUncheck"&&e==="toggle"?(n.classList.add("av__row--select"),a.setAttribute("xlink:href","#iconCheck")):(e==="unselect"||a.getAttribute("xlink:href")==="#iconCheck"&&e==="toggle")&&(n.classList.remove("av__row--select"),a.setAttribute("xlink:href","#iconUncheck")),le(x(n)),ls(n)},ls=t=>{const e=x(t);if(!e)return;const n=t.parentElement.querySelectorAll(".av__row--select:not(.av__row--header)").length,a=t.parentElement.childElementCount-3-n,i=t.parentElement.firstElementChild,s=i.querySelector("use"),o=e.querySelector(".av__counter"),l=e.querySelector(".av__header");if(a===0&&t.parentElement.childElementCount-3!==0)i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconCheck");else if(a===t.parentElement.childElementCount-3){i.classList.remove("av__row--select"),s.setAttribute("xlink:href","#iconUncheck"),o.classList.add("fn__none"),l.style.position="";return}else a>0&&(i.classList.add("av__row--select"),s.setAttribute("xlink:href","#iconIndeterminateCheck"));o.classList.remove("fn__none"),o.innerHTML=`${n} ${window.siyuan.languages.selected}`,l.style.position="sticky"},co=(t,e,n,a)=>{const i=t.querySelector(`.av__row[data-id="${n}"]`)||t.querySelector(".av__row--header");let s='<div style="width: 24px"></div>';const o=i.querySelectorAll(".av__colsticky .av__cell").length-1;o>-1&&(s='<div class="av__colsticky"><div style="width: 24px"></div>'),i.querySelectorAll(".av__cell").forEach((c,d)=>{s+=`<div class="av__cell" style="width: ${c.style.width}" ${c.getAttribute("data-block-id")||c.dataset.dtype==="block"?' data-detached="true"':""}><span class="av__pulse"></span></div>`,o===d&&(s+="</div>")});let l="";e.forEach(c=>{l+=`<div class="av__row" data-id="${c}" data-avid="${a}" data-previous-id="${n}">
    ${s}
</div>`}),i.insertAdjacentHTML("afterend",l);const r=parseInt(t.getAttribute("data-page-size"));if(r){const c=t.querySelectorAll(".av__row:not(.av__row--header)").length;r<c&&t.setAttribute("data-page-size",c.toString())}},Ua=(t,e,n)=>{if(t.querySelector(".av__title").getAttribute("contenteditable")==="false")return;const a=t.querySelector(".av__scroll").getBoundingClientRect(),i=t.querySelector(".av__row--header");if(i&&(n==="top"||n==="all")){const o=Math.floor(e.top-a.top);o>0&&o<a.height?i.style.transform=`translateY(${o}px)`:i.style.transform=""}const s=t.querySelector(".av__row--footer");if(s&&(n==="bottom"||n==="all"))if(s.querySelector(".av__calc--ashow")){const o=Math.ceil(e.bottom-s.parentElement.getBoundingClientRect().bottom);o<0&&-o<a.height?s.style.transform=`translateY(${o}px)`:s.style.transform=""}else s.style.transform=""},Gl=t=>{t.currentPageSize!==t.newPageSize&&(t.nodeElement.setAttribute("data-page-size",t.newPageSize),F(t.protyle,[{action:"setAttrViewPageSize",avID:t.avID,data:parseInt(t.newPageSize)}],[{action:"setAttrViewPageSize",data:parseInt(t.currentPageSize),avID:t.avID}]),document.querySelector(".av__panel")?.remove())},yp=t=>{const e=new At("av-page-size");if(e.isOpen)return;const n=t.target.dataset.size;e.addItem({iconHTML:"",label:"10",accelerator:n==="10"?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,click(){Gl({currentPageSize:n,newPageSize:"10",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",accelerator:n==="25"?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,label:"25",click(){Gl({currentPageSize:n,newPageSize:"25",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",accelerator:n==="50"?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,label:"50",click(){Gl({currentPageSize:n,newPageSize:"50",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}}),e.addItem({iconHTML:"",accelerator:n==="100"?'<svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg>':void 0,label:"100",click(){Gl({currentPageSize:n,newPageSize:"100",protyle:t.protyle,avID:t.avID,nodeElement:t.nodeElement})}});const a=t.target.getBoundingClientRect();e.open({x:a.left,y:a.bottom})},_p=(t,e)=>{const n=t.getAttribute("data-av-id"),a=[],i=t.querySelectorAll(".av__row--select:not(.av__row--header)"),s=[];i.forEach(o=>{s.push(o.querySelector(".av__cell[data-block-id]").getAttribute("data-block-id"))}),i.forEach(o=>{a.push({action:"insertAttrViewBlock",avID:n,previousID:o.previousElementSibling?.getAttribute("data-id")||"",srcIDs:[o.getAttribute("data-id")],isDetached:!!o.querySelector('.av__cell[data-detached="true"]')})}),F(e,[{action:"removeAttrViewBlock",srcIDs:s,avID:n}],a),i.forEach(o=>{o.remove()}),Ua(t,e.contentElement.getBoundingClientRect(),"all"),ls(t.querySelector(".av__row"))},vp=(t,e,n,a)=>{w("/api/av/searchAttributeView",{keyword:e},i=>{let s="";i.data.results.forEach((o,l)=>{s+=`<div class="b3-list-item b3-list-item--narrow${l===0?" b3-list-item--focus":""}" data-av-id="${o.avID}" data-block-id="${o.blockID}">
    <div class="b3-list-item--two fn__flex-1">
        <div class="b3-list-item__first">
            <span class="b3-list-item__text">${we(o.avName||window.siyuan.languages.title)}</span>
        </div>
        <div class="b3-list-item__meta b3-list-item__showall">${we(o.hPath)}</div>
    </div>
    <svg aria-label="${window.siyuan.languages.thisDatabase}" style="margin: 0 0 0 4px" class="b3-list-item__hinticon ariaLabel${o.avID===n?"":" fn__none"}"><use xlink:href="#iconInfo"></use></svg>
</div>`}),t.innerHTML=s,a&&a()})},Ep=(t,e,n)=>{e.dataset.avId=n.dataset.avId,e.dataset.blockId=n.dataset.blockId,e.querySelector(".b3-menu__accelerator").textContent=n.querySelector(".b3-list-item__hinticon").classList.contains("fn__none")?n.querySelector(".b3-list-item__text").textContent:window.siyuan.languages.thisDatabase;const a=A(e,"b3-menu__items");a&&uo(a,t,!0)},fy=(t,e)=>{window.siyuan.menus.menu.remove();const n=new At;n.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column" style = "min-width: 260px;max-width:420px;max-height: 50vh">
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(a){const i=a.querySelector(".b3-list"),s=a.querySelector("input");s.addEventListener("keydown",o=>{if(o.isComposing)return;Bn(i,o)&&o.stopPropagation(),o.key==="Enter"&&(o.preventDefault(),o.stopPropagation(),Ep(t,e,i.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),s.addEventListener("input",o=>{o.stopPropagation(),vp(i,s.value,t)}),a.lastElementChild.addEventListener("click",o=>{const l=A(o.target,"b3-list-item");l&&(o.stopPropagation(),Ep(t,e,l),window.siyuan.menus.menu.remove())}),vp(i,"",t,()=>{const o=e.getBoundingClientRect();n.open({x:o.left,y:o.bottom,h:o.height}),a.querySelector("input").focus()})}}),n.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},py=t=>{const e=t.avElement.querySelector('input[data-type="colName"]'),a=t.avElement.querySelector('.b3-menu__item[data-type="goSearchAV"]').getAttribute("data-av-id"),i=t.avElement.querySelector(".b3-menu__item").getAttribute("data-col-id");let s;t.colsData.find(l=>{if(l.id===i)return l.relation||(l.relation={}),s=l,!0});const o=t.avElement.querySelector('[data-type="name"]').value;F(t.protyle,[{action:"updateAttrViewColRelation",avID:t.avID,keyID:i,id:a||s.relation.avID,backRelationKeyID:s.relation.avID===a?s.relation.backKeyID:Lute.NewNodeID(),isTwoWay:t.avElement.querySelector(".b3-switch").checked,name:e.value,format:o}],[{action:"updateAttrViewColRelation",avID:t.avID,keyID:i,id:s.relation.avID,backRelationKeyID:s.relation.backKeyID,isTwoWay:s.relation.isTwoWay,name:e.dataset.oldValue,format:s.name}]),t.avElement.remove(),cn(t.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:o}),le(t.blockElement)},uo=(t,e,n=!1)=>{const a=t.querySelector('.b3-menu__item[data-type="goSearchAV"]'),i=a.nextElementSibling,s=i.querySelector(".b3-switch"),o=i.nextElementSibling,l=o.nextElementSibling,r=JSON.parse(a.dataset.oldValue);if(r.avID){const c=o.querySelector("input");n&&(a.dataset.avId!==r.avID?(c.value="",s.checked=!1):(c.value=c.dataset.oldValue,s.checked=r.isTwoWay)),a.dataset.avId===e&&r.avID===e&&r.isTwoWay?(i.classList.add("fn__none"),o.classList.add("fn__none")):(i.classList.remove("fn__none"),s.checked?o.classList.remove("fn__none"):o.classList.add("fn__none")),a.dataset.avId&&r.avID!==a.dataset.avId||r.isTwoWay!==s.checked||c.dataset.oldValue!==c.value?l.classList.remove("fn__none"):l.classList.add("fn__none")}else a.dataset.avId&&(i.classList.remove("fn__none"),s.checked?o.classList.remove("fn__none"):o.classList.add("fn__none"),l.classList.remove("fn__none"))},Wa=(t,e,n)=>{if(t==="selected")return`<button data-id="${e}" data-type="setRelationCell" class="b3-menu__item" draggable="true">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <span class="b3-menu__label">${n}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconMin"></use></svg>
</button>`;if(t==="empty")return`<button class="b3-menu__item">
    <span class="b3-menu__label">${window.siyuan.languages.emptyContent}</span>
</button>`;if(t=="unselect")return`<button data-id="${e}" class="b3-menu__item" data-type="setRelationCell">
    <span class="b3-menu__label">${n}</span>
    <svg class="b3-menu__action"><use xlink:href="#iconAdd"></use></svg>
</button>`},gy=t=>{const e=t.menuElement.textContent.split(",");w("/api/av/renderAttributeView",{id:t.menuElement.firstElementChild.getAttribute("data-av-id")},n=>{const a=n.data;let i=0;a.view.columns.find((l,r)=>{if(l.type==="block")return i=r,!0});let s="",o="";e.forEach(l=>{l&&a.view.rows.find(r=>{if(r.id===l)return o+=Wa("selected",r.id,r.cells[i].value.block.content||r.cells[i].value.block.id),!0})}),a.view.rows.forEach(l=>{e.includes(l.id)||(s+=Wa("unselect",l.id,l.cells[i].value.block.content||l.cells[i].value.block.id))}),t.menuElement.innerHTML=`<div class="b3-menu__items">${o||Wa("empty")}
<button class="b3-menu__separator"></button>
${s||Wa("empty")}</div>`})},hy=(t,e)=>{let n;if(t.view.columns.find(a=>{if(a.id===e[0].dataset.colId)return n=a.relation,!0}),n&&n.avID){let a="";return e[0].querySelectorAll("span").forEach(i=>{a+=`${i.getAttribute("data-id")},`}),`<span data-av-id="${n.avID}">${a}</span>`}else return""},kp=(t,e,n,a)=>{const i=A(n,"b3-menu__items");if(!i)return;const s={blockIDs:[],contents:[]};if(Array.from(i.children).forEach(o=>{const l=o.getAttribute("data-id");o.getAttribute("draggable")&&l&&(s.blockIDs.push(l),s.contents.push(o.textContent.trim()))}),n.classList.contains("b3-menu__item")){const o=n.getAttribute("data-id"),l=i.querySelector(".b3-menu__separator");if(n.getAttribute("draggable")){l.nextElementSibling.getAttribute("data-id")||l.nextElementSibling.remove();const r=s.blockIDs.indexOf(o);s.blockIDs.splice(r,1),s.contents.splice(r,1),l.after(n),n.outerHTML=Wa("unselect",o,n.querySelector(".b3-menu__label").textContent),l.previousElementSibling||l.insertAdjacentHTML("beforebegin",Wa("empty"))}else l.previousElementSibling.getAttribute("data-id")||l.previousElementSibling.remove(),s.blockIDs.push(o),s.contents.push(n.textContent.trim()),l.before(n),n.outerHTML=Wa("selected",o,n.querySelector(".b3-menu__label").textContent),l.nextElementSibling||l.insertAdjacentHTML("afterend",Wa("empty"))}An(t,e,s,a)},$t=t=>{t.menu.addItem({iconHTML:"",label:gd(t.operator,!!t.data),click(){if(!t.data)F(t.protyle,[{action:"setAttrViewColCalc",avID:t.avId,id:t.colId,data:{operator:t.operator}}],[{action:"setAttrViewColCalc",avID:t.avId,id:t.colId,data:{operator:t.oldOperator}}]);else{t.target.querySelector(".b3-menu__accelerator").textContent=gd(t.operator,!0);const e=t.data.view.columns.find(n=>{if(n.id===t.colId)return n.rollup||(n.rollup={}),!0});e.rollup.calc={operator:t.operator},F(t.protyle,[{action:"updateAttrViewColRollup",id:t.colId,avID:t.avId,parentID:e.rollup.relationKeyID,keyID:e.rollup.keyID,data:{calc:e.rollup.calc}}],[{action:"updateAttrViewColRollup",id:t.colId,avID:t.avId,parentID:e.rollup.relationKeyID,keyID:e.rollup.keyID,data:{calc:{operator:t.oldOperator}}}])}}})},Sp=(t,e,n,a)=>{let i,s,o,l,r;if(n)l=n.id,s=e.dataset.colType,r=e.dataset.calc,o=a;else{const u=x(e);if(!u||(i=A(e,"av__row--footer"),!i))return;i.classList.add("av__row--show"),s=e.dataset.dtype,o=e.dataset.colId,l=u.dataset.avId,r=e.dataset.operator}const c=new At("av-calc",()=>{i&&i.classList.remove("av__row--show")});if(c.isOpen)return;$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count all",data:n,target:e}),s!=="checkbox"?($t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count values",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count unique values",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count empty",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Count not empty",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Percent empty",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Percent not empty",data:n,target:e})):($t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Checked",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Unchecked",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Percent checked",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Percent unchecked",data:n,target:e})),["number","template"].includes(s)?($t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Sum",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Average",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Median",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Min",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Max",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Range",data:n,target:e})):["date","created","updated"].includes(s)&&($t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Earliest",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Latest",data:n,target:e}),$t({menu:c,protyle:t,colId:o,avId:l,oldOperator:r,operator:"Range",data:n,target:e}));const d=e.getBoundingClientRect();c.open({x:d.left,y:d.bottom,h:d.height})},my=t=>{if(!t.calc||!t.calc.result)return"";let e=t.calc.result.number;(t.calc.operator==="Earliest"||t.calc.operator==="Latest"||t.calc.operator==="Range"&&["date","created","updated"].includes(t.type))&&(e=t.calc.result[t.type]);let n="";switch(t.calc.operator){case"Count all":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountAll}`;break;case"Count values":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountValues}`;break;case"Count unique values":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountUniqueValues}`;break;case"Count empty":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountEmpty}`;break;case"Count not empty":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultCountNotEmpty}`;break;case"Percent empty":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultPercentEmpty}`;break;case"Percent not empty":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultPercentNotEmpty}`;break;case"Sum":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultSum}`;break;case"Average":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultAverage}`;break;case"Median":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultMedian}`;break;case"Min":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultMin}`;break;case"Max":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultMax}`;break;case"Range":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcResultRange}`;break;case"Earliest":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcOperatorEarliest}`;break;case"Latest":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.calcOperatorLatest}`;break;case"Checked":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.checked}`;break;case"Unchecked":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.unchecked}`;break;case"Percent checked":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.percentChecked}`;break;case"Percent unchecked":n=`<span>${e.formattedContent}</span>${window.siyuan.languages.percentUnchecked}`;break}return n},gd=(t,e)=>{switch(t){case"":return e?window.siyuan.languages.original:window.siyuan.languages.calcOperatorNone;case"Count all":return window.siyuan.languages.calcOperatorCountAll;case"Count values":return window.siyuan.languages.calcOperatorCountValues;case"Count unique values":return window.siyuan.languages.calcOperatorCountUniqueValues;case"Count empty":return window.siyuan.languages.calcOperatorCountEmpty;case"Count not empty":return window.siyuan.languages.calcOperatorCountNotEmpty;case"Percent empty":return window.siyuan.languages.calcOperatorPercentEmpty;case"Percent not empty":return window.siyuan.languages.calcOperatorPercentNotEmpty;case"Checked":return window.siyuan.languages.checked;case"Unchecked":return window.siyuan.languages.unchecked;case"Percent checked":return window.siyuan.languages.percentChecked;case"Percent unchecked":return window.siyuan.languages.percentUnchecked;case"Sum":return window.siyuan.languages.calcOperatorSum;case"Average":return window.siyuan.languages.calcOperatorAverage;case"Median":return window.siyuan.languages.calcOperatorMedian;case"Min":return window.siyuan.languages.calcOperatorMin;case"Max":return window.siyuan.languages.calcOperatorMax;case"Range":return window.siyuan.languages.calcOperatorRange;case"Earliest":return window.siyuan.languages.calcOperatorEarliest;case"Latest":return window.siyuan.languages.calcOperatorLatest;default:return""}},Lp=(t,e)=>{if(e.classList.contains("b3-list--empty"))return;t.target.querySelector(".b3-menu__accelerator").textContent=e.querySelector(".b3-list-item__text").textContent;const n=t.data.view.columns.find(i=>{if(i.id===t.colId)return i.rollup||(i.rollup={}),!0}),a=Object.assign({},n.rollup);t.isRelation?(n.rollup.relationKeyID=e.dataset.colId,t.target.nextElementSibling.setAttribute("data-av-id",e.dataset.targetAvId)):(n.rollup.keyID=e.dataset.colId,t.target.nextElementSibling.setAttribute("data-col-type",e.dataset.colType)),F(t.protyle,[{action:"updateAttrViewColRollup",id:t.colId,avID:t.data.id,parentID:n.rollup.relationKeyID,keyID:n.rollup.keyID,data:{calc:n.rollup.calc}}],[{action:"updateAttrViewColRollup",id:t.colId,avID:t.data.id,parentID:a.relationKeyID,keyID:a.keyID,data:{calc:a.calc}}])},Cp=(t,e,n,a,i)=>{if(!a&&!n){M(window.siyuan.languages.selectRelation);return}w(a?"/api/av/searchAttributeViewRelationKey":"/api/av/searchAttributeViewNonRelationKey",{avID:n,keyword:e},s=>{let o="";s.data.keys.forEach((l,r)=>{o+=`<div class="b3-list-item b3-list-item--narrow${r===0?" b3-list-item--focus":""}" data-col-id="${l.id}" ${a?`data-target-av-id="${l.relation.avID}"`:`data-col-type="${l.type}"`}>
        ${l.icon?ie(l.icon,"b3-list-item__graphic",!0):`<svg class="b3-list-item__graphic"><use xlink:href="#${Yt(l.type)}"></use></svg>`}
        ${wa()}
        <span class="b3-list-item__text">${we(l.name||window.siyuan.languages.title)}</span>
</div>`}),t.innerHTML=o||`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,i&&i()})},xp=t=>{window.siyuan.menus.menu.remove();const e=new At;e.addItem({iconHTML:"",type:"empty",label:`<div class="fn__flex-column" style = "min-width: 260px;max-width:420px;max-height: 50vh">
    <input class="b3-text-field fn__flex-shrink"/>
    <div class="fn__hr"></div>
    <div class="b3-list fn__flex-1 b3-list--background">
        <img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg">
    </div>
</div>`,bind(n){const a=n.querySelector(".b3-list"),i=n.querySelector("input");i.addEventListener("keydown",s=>{if(s.isComposing)return;Bn(a,s)&&s.stopPropagation(),s.key==="Enter"&&(s.preventDefault(),s.stopPropagation(),Lp(t,a.querySelector(".b3-list-item--focus")),window.siyuan.menus.menu.remove())}),i.addEventListener("input",s=>{s.stopPropagation(),Cp(a,i.value,t.isRelation?t.data.id:t.target.dataset.avId,t.isRelation)}),n.lastElementChild.addEventListener("click",s=>{const o=A(s.target,"b3-list-item");o&&(s.stopPropagation(),Lp(t,o),window.siyuan.menus.menu.remove())}),Cp(a,"",t.isRelation?t.data.id:t.target.dataset.avId,t.isRelation,()=>{const s=t.target.getBoundingClientRect();e.open({x:s.left,y:s.bottom,h:s.height}),n.querySelector("input").focus()})}}),e.element.querySelector(".b3-menu__items").setAttribute("style","overflow: initial")},Ap=t=>{let e;return t.colData?e=t.colData:t.data.view.columns.find(n=>{if(n.id===t.cellElements[0].dataset.colId)return e=n,!0}),`<button class="b3-menu__item" data-type="goSearchRollupCol" data-old-value='${JSON.stringify(e.rollup||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relation}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupTarget">
    <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
    <span class="b3-menu__accelerator"></span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<button class="b3-menu__item" data-type="goSearchRollupCalc">
    <span class="b3-menu__label">${window.siyuan.languages.calc}</span>
    <span class="b3-menu__accelerator">${gd(e.rollup?.calc?.operator,!0)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`},Tp=t=>{const e=t.menuElement.querySelector('[data-type="goSearchRollupCol"]');if(e){const n=JSON.parse(e.dataset.oldValue),a=t.menuElement.querySelector('[data-type="goSearchRollupTarget"]');let i="";n.relationKeyID&&t.data.view.columns.find(s=>{if(s.id===n.relationKeyID)return e.querySelector(".b3-menu__accelerator").textContent=s.name,i=s.relation.avID,a.dataset.avId=i,!0}),n.keyID&&i&&w("/api/av/getAttributeView",{id:i},s=>{s.data.av.keyValues.find(o=>{if(o.key.id===n.keyID){a.querySelector(".b3-menu__accelerator").textContent=o.key.name;const l=t.menuElement.querySelector('[data-type="goSearchRollupCalc"]');return l.dataset.colType=o.key.type,l.dataset.calc=n.calc.operator,!0}})})}},Zt=t=>{let e=document.querySelector(".av__panel");if(e){e.remove();return}window.siyuan.menus.menu.remove();const n=t.blockElement.getAttribute("data-av-id");w("/api/av/renderAttributeView",{id:n,pageSize:parseInt(t.blockElement.getAttribute("data-page-size"))||void 0},a=>{const i=a.data;let s;if(t.type==="config")s=bp(i.view);else if(t.type==="properties")s=yi(i.view);else if(t.type==="sorts")s=os(i.view.columns,i.view.sorts);else if(t.type==="switcher")s=uy(i.views,i.viewID);else if(t.type==="filters")s=Fa(i.view);else if(t.type==="select")s=is(i.view,t.cellElements);else if(t.type==="asset")s=hp(i.view,t.cellElements);else if(t.type==="edit")s=Sa({protyle:t.protyle,data:i,colId:t.colId});else if(t.type==="date")s=sy(i.view,t.cellElements);else if(t.type==="rollup")s=`<div class="b3-menu__items">${Ap({data:i,cellElements:t.cellElements})}</div>`;else if(t.type==="relation"&&(s=hy(i,t.cellElements),!s)){Zt({protyle:t.protyle,blockElement:t.blockElement,type:"edit",colId:t.cellElements[0].dataset.colId});return}document.body.insertAdjacentHTML("beforeend",`<div class="av__panel" style="z-index: ${++window.siyuan.zIndex}">
    <div class="b3-dialog__scrim" data-type="close"></div>
    <div class="b3-menu">${s}</div>
</div>`),e=document.querySelector(".av__panel");const o=e.lastElementChild,l=t.blockElement.querySelector(".av__views")?.getBoundingClientRect();if(["select","date","asset","relation","rollup"].includes(t.type)){const c=t.cellElements[t.cellElements.length-1].getBoundingClientRect();if(t.type==="select"?as(t.protyle,i,o,t.cellElements,t.blockElement):t.type==="date"?oy({protyle:t.protyle,data:i,menuElement:o,cellElements:t.cellElements,blockElement:t.blockElement}):t.type==="asset"?(gp({protyle:t.protyle,data:i,menuElement:o,cellElements:t.cellElements,blockElement:t.blockElement}),setTimeout(()=>{ke(o,c.left,c.bottom,c.height)},p.Constants.TIMEOUT_LOAD)):t.type==="relation"?gy({protyle:t.protyle,data:i,menuElement:o,cellElements:t.cellElements}):t.type==="rollup"&&Tp({protyle:t.protyle,data:i,menuElement:o}),["select","date","relation","rollup"].includes(t.type)){const d=o.querySelector("input");d&&(d.select(),d.focus()),ke(o,c.left,c.bottom,c.height)}}else ke(o,l.right-o.clientWidth,l.bottom,l.height),t.type==="sorts"?ss(t.protyle,o,i):t.type==="edit"?La({protyle:t.protyle,data:i,menuElement:o}):t.type==="config"&&mp({protyle:t.protyle,data:i,menuElement:o});t.cb&&t.cb(e),e.addEventListener("dragstart",c=>{window.siyuan.dragElement=c.target,window.siyuan.dragElement.style.opacity=".1"}),e.addEventListener("drop",c=>{window.siyuan.dragElement.style.opacity="";const d=window.siyuan.dragElement;if(window.siyuan.dragElement=void 0,t.protyle&&t.protyle.disabled){c.preventDefault(),c.stopPropagation();return}if(!t.protyle&&window.siyuan.config.readonly){c.preventDefault(),c.stopPropagation();return}const u=e.querySelector(".dragover__bottom, .dragover__top");if(!u)return;const f=u.classList.contains("dragover__top"),g=d.dataset.id,h=u.dataset.id;if(u.querySelector('[data-type="removeSort"]')){const b=i.view.sorts,y=Object.assign([],b);let _;b.find((v,k)=>{if(v.column===g)return _=b.splice(k,1)[0],!0}),b.find((v,k)=>{if(v.column===h)return f?b.splice(k,0,_):b.splice(k+1,0,_),!0}),F(t.protyle,[{action:"setAttrViewSorts",avID:n,data:b}],[{action:"setAttrViewSorts",avID:n,data:y}]),o.innerHTML=os(i.view.columns,i.view.sorts),ss(t.protyle,o,i);return}if(u.querySelector('[data-type="removeFilter"]')){const b=i.view.filters,y=Object.assign([],b);let _;b.find((v,k)=>{if(v.column===g)return _=b.splice(k,1)[0],!0}),b.find((v,k)=>{if(v.column===h)return f?b.splice(k,0,_):b.splice(k+1,0,_),!0}),F(t.protyle,[{action:"setAttrViewFilters",avID:n,data:b}],[{action:"setAttrViewFilters",avID:n,data:y}]),o.innerHTML=Fa(i.view);return}if(u.querySelector('[data-type="av-view-edit"]')){F(t.protyle,[{action:"sortAttrViewView",avID:n,id:g,previousID:f?u.previousElementSibling?.getAttribute("data-id"):u.getAttribute("data-id")}],[{action:"sortAttrViewView",avID:n,id:g,previousID:d.previousElementSibling?.getAttribute("data-id")}]),f?(u.before(d),u.classList.remove("dragover__top")):(u.after(d),u.classList.remove("dragover__bottom"));return}if(u.querySelector('[data-type="editAssetItem"]')){f?u.before(d):u.after(d);const b=[];Array.from(u.parentElement.children).forEach(y=>{y.dataset.content&&b.push({content:y.dataset.content,name:y.dataset.name,type:y.dataset.type})}),wi({protyle:t.protyle,data:i,cellElements:t.cellElements,type:"replace",replaceValue:b,blockElement:t.blockElement});return}if(u.querySelector('[data-type="setColOption"]')){const b=t.cellElements?t.cellElements[0].dataset.colId:o.querySelector(".b3-menu__item").getAttribute("data-col-id"),y=i.view.columns.find(k=>k.id===b).options,_=Object.assign([],y);let v;y.find((k,L)=>{if(k.name===d.dataset.name)return v=y.splice(L,1)[0],!0}),y.find((k,L)=>{if(k.name===u.dataset.name)return f?y.splice(L,0,v):y.splice(L+1,0,v),!0}),F(t.protyle,[{action:"updateAttrViewColOptions",id:b,avID:i.id,data:y}],[{action:"updateAttrViewColOptions",id:b,avID:i.id,data:_}]),t.cellElements?(o.innerHTML=is(i.view,t.cellElements),as(t.protyle,i,o,t.cellElements,t.blockElement)):(o.innerHTML=Sa({protyle:t.protyle,data:i,colId:b}),La({protyle:t.protyle,data:i,menuElement:o}));return}if(u.getAttribute("data-type")==="setRelationCell"){f?u.before(d):u.after(d),u.classList.remove("dragover__bottom","dragover__top"),kp(t.protyle,t.blockElement,d.parentElement,t.cellElements);return}F(t.protyle,[{action:"sortAttrViewCol",avID:n,previousID:(u.classList.contains("dragover__top")?u.previousElementSibling?.getAttribute("data-id"):u.getAttribute("data-id"))||"",id:g}],[{action:"sortAttrViewCol",avID:n,previousID:d.previousElementSibling?.getAttribute("data-id")||"",id:g}]);let m;i.view.columns.find((b,y)=>{if(b.id===g)return m=i.view.columns.splice(y,1)[0],!0}),i.view.columns.find((b,y)=>{if(b.id===h)return f?i.view.columns.splice(y,0,m):i.view.columns.splice(y+1,0,m),!0}),o.innerHTML=yi(i.view)});let r;e.addEventListener("dragover",c=>{const d=c.target;let u=q(d,"draggable","true");if(u||(u=q(document.elementFromPoint(c.clientX,c.clientY-1),"draggable","true")),!(!u||u.isSameNode(window.siyuan.dragElement))){if(c.preventDefault(),r&&u.isSameNode(r)){const f=u.getBoundingClientRect();u.classList.remove("dragover__bottom","dragover__top"),c.clientY>f.top+f.height/2?u.classList.add("dragover__bottom"):u.classList.add("dragover__top");return}r=u}}),e.addEventListener("dragleave",()=>{e.querySelectorAll(".dragover__bottom, .dragover__top").forEach(c=>{c.classList.remove("dragover__bottom","dragover__top")})}),e.addEventListener("dragend",()=>{window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)}),e.addEventListener("click",c=>{let d=c.target;for(;d&&!d.isSameNode(e);){const u=d.dataset.type;if(u==="close"){t.protyle.toolbar.subElement.classList.contains("fn__none")?window.siyuan.menus.menu.element.classList.contains("fn__none")?(e.remove(),le(t.blockElement)):window.siyuan.menus.menu.remove():X(["util"],t.protyle),window.siyuan.menus.menu.remove(),c.preventDefault(),c.stopPropagation();break}else if(u==="go-config"){o.innerHTML=bp(i.view),ke(o,l.right-o.clientWidth,l.bottom,l.height),mp({protyle:t.protyle,data:i,menuElement:o}),c.preventDefault(),c.stopPropagation();break}else if(u==="go-properties"){o.innerHTML=yi(i.view),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="goSorts"){o.innerHTML=os(i.view.columns,i.view.sorts),ss(t.protyle,o,i),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="removeSorts"){F(t.protyle,[{action:"setAttrViewSorts",avID:n,data:[]}],[{action:"setAttrViewSorts",avID:n,data:i.view.sorts}]),i.view.sorts=[],o.innerHTML=os(i.view.columns,i.view.sorts),ss(t.protyle,o,i),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="addSort"){iy({data:i,rect:d.getBoundingClientRect(),menuElement:o,tabRect:l,avId:n,protyle:t.protyle}),c.preventDefault(),c.stopPropagation();break}else if(u==="removeSort"){const f=Object.assign([],i.view.sorts);i.view.sorts.find((g,h)=>{if(g.column===d.parentElement.dataset.id)return i.view.sorts.splice(h,1),!0}),F(t.protyle,[{action:"setAttrViewSorts",avID:n,data:i.view.sorts}],[{action:"setAttrViewSorts",avID:n,data:f}]),o.innerHTML=os(i.view.columns,i.view.sorts),ss(t.protyle,o,i),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="goFilters"){o.innerHTML=Fa(i.view),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="removeFilters"){F(t.protyle,[{action:"setAttrViewFilters",avID:n,data:[]}],[{action:"setAttrViewFilters",avID:n,data:i.view.filters}]),i.view.filters=[],o.innerHTML=Fa(i.view),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="addFilter"){ay({data:i,rect:d.getBoundingClientRect(),menuElement:o,tabRect:l,avId:n,protyle:t.protyle,blockElement:t.blockElement}),c.preventDefault(),c.stopPropagation();break}else if(u==="removeFilter"){window.siyuan.menus.menu.remove();const f=Object.assign([],i.view.filters);i.view.filters.find((g,h)=>{if(g.column===d.parentElement.dataset.id)return i.view.filters.splice(h,1),!0}),F(t.protyle,[{action:"setAttrViewFilters",avID:n,data:i.view.filters}],[{action:"setAttrViewFilters",avID:n,data:f}]),o.innerHTML=Fa(i.view),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="setFilter"){i.view.filters.find(f=>{if(f.column===d.parentElement.parentElement.dataset.id)return fd({filter:f,protyle:t.protyle,data:i,target:d,blockElement:t.blockElement}),!0}),c.preventDefault(),c.stopPropagation();break}else if(u==="numberFormat"){ly({avPanelElement:e,element:d,protyle:t.protyle,oldFormat:d.dataset.format,colId:o.querySelector(".b3-menu__item").getAttribute("data-col-id"),avID:n}),c.preventDefault(),c.stopPropagation();break}else if(u==="newCol"){e.remove(),or(t.protyle,t.blockElement).open({x:l.right,y:l.bottom,h:l.height,isLeft:!0}),c.preventDefault(),c.stopPropagation();break}else if(u==="update-view-icon"){const f=d.getBoundingClientRect();fi("","av",{x:f.left,y:f.bottom,h:f.height,w:f.width},g=>{F(t.protyle,[{action:"setAttrViewViewIcon",avID:n,id:i.viewID,data:g}],[{action:"setAttrViewViewIcon",id:i.viewID,avID:n,data:d.dataset.icon}]),d.innerHTML=g?ie(g):'<svg><use xlink:href="#iconTable"></use></svg>',d.dataset.icon=g}),c.preventDefault(),c.stopPropagation();break}else if(u==="set-page-size"){yp({target:d,protyle:t.protyle,avID:n,nodeElement:t.blockElement}),c.preventDefault(),c.stopPropagation();break}else if(u==="duplicate-view"){const f=Lute.NewNodeID();F(t.protyle,[{action:"duplicateAttrViewView",avID:n,previousID:i.viewID,id:f}],[{action:"removeAttrViewView",avID:n,id:f}]),e.remove(),c.preventDefault(),c.stopPropagation();break}else if(u==="delete-view"){i.views.length===1?rn(t.protyle,t.blockElement,re(t.blockElement)):F(t.protyle,[{action:"removeAttrViewView",avID:n,id:i.viewID}]),e.remove(),c.preventDefault(),c.stopPropagation();break}else if(u==="update-icon"){const f=d.getBoundingClientRect();fi("","av",{x:f.left,y:f.bottom,h:f.height,w:f.width},g=>{const h=o.querySelector(".b3-menu__item").getAttribute("data-col-id");F(t.protyle,[{action:"setAttrViewColIcon",id:h,avID:n,data:g}],[{action:"setAttrViewColIcon",id:h,avID:n,data:d.dataset.icon}]),d.innerHTML=g?ie(g):`<svg><use xlink:href="#${Yt(d.dataset.colType)}"></use></svg>`,cn(t.blockElement.querySelector(`.av__row--header .av__cell[data-col-id="${h}"]`),void 0,{icon:g}),d.dataset.icon=g}),c.preventDefault(),c.stopPropagation();break}else if(u==="showAllCol"){const f=[],g=[];i.view.columns.forEach(h=>{h.hidden&&(f.push({action:"setAttrViewColHidden",id:h.id,avID:n,data:!1}),g.push({action:"setAttrViewColHidden",id:h.id,avID:n,data:!0}),h.hidden=!1)}),f.length>0&&(F(t.protyle,f,g),o.innerHTML=yi(i.view),ke(o,l.right-o.clientWidth,l.bottom,l.height)),c.preventDefault(),c.stopPropagation();break}else if(u==="hideAllCol"){const f=[],g=[];i.view.columns.forEach(h=>{!h.hidden&&h.type!=="block"&&(f.push({action:"setAttrViewColHidden",id:h.id,avID:n,data:!0}),g.push({action:"setAttrViewColHidden",id:h.id,avID:n,data:!1}),h.hidden=!0)}),f.length>0&&(F(t.protyle,f,g),o.innerHTML=yi(i.view),ke(o,l.right-o.clientWidth,l.bottom,l.height)),c.preventDefault(),c.stopPropagation();break}else if(u==="editCol"){o.innerHTML=Sa({protyle:t.protyle,data:i,colId:d.parentElement.dataset.id}),La({protyle:t.protyle,data:i,menuElement:o}),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="updateColType"){if(d.dataset.newType!==d.dataset.oldType){const f=d.dataset.name;F(t.protyle,[{action:"updateAttrViewCol",id:t.colId,avID:n,name:f,type:d.dataset.newType}],[{action:"updateAttrViewCol",id:t.colId,avID:n,name:f,type:d.dataset.oldType}])}e.remove(),c.preventDefault(),c.stopPropagation();break}else if(u==="goUpdateColType"){const f=A(d,"b3-menu");f&&(f.firstElementChild.classList.add("fn__none"),f.lastElementChild.classList.remove("fn__none")),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="goSearchAV"){fy(n,d),c.preventDefault(),c.stopPropagation();break}else if(u==="goSearchRollupCol"){xp({target:d,data:i,isRelation:!0,protyle:t.protyle,colId:t.colId||o.querySelector(".b3-menu__item").getAttribute("data-col-id")}),c.preventDefault(),c.stopPropagation();break}else if(u==="goSearchRollupTarget"){xp({target:d,data:i,isRelation:!1,protyle:t.protyle,colId:t.colId||o.querySelector(".b3-menu__item").getAttribute("data-col-id")}),c.preventDefault(),c.stopPropagation();break}else if(u==="goSearchRollupCalc"){Sp(t.protyle,d,i,t.colId),c.preventDefault(),c.stopPropagation();break}else if(u==="updateRelation"){py({protyle:t.protyle,avElement:e,avID:n,colsData:i.view.columns,blockElement:t.blockElement}),c.preventDefault(),c.stopPropagation();break}else if(u==="goEditCol"){const f=A(d,"b3-menu");f&&(f.firstElementChild.classList.remove("fn__none"),f.lastElementChild.classList.add("fn__none")),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="hideCol"){const f=o.querySelector('[data-type="go-properties"]'),g=f?o.querySelector(".b3-menu__item").getAttribute("data-col-id"):d.parentElement.getAttribute("data-id");F(t.protyle,[{action:"setAttrViewColHidden",id:g,avID:n,data:!0}],[{action:"setAttrViewColHidden",id:g,avID:n,data:!1}]),i.view.columns.find(h=>h.id===g).hidden=!0,f?(o.innerHTML=Sa({protyle:t.protyle,data:i,colId:g}),La({protyle:t.protyle,data:i,menuElement:o})):o.innerHTML=yi(i.view),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="showCol"){const f=o.querySelector('[data-type="go-properties"]'),g=f?o.querySelector(".b3-menu__item").getAttribute("data-col-id"):d.parentElement.getAttribute("data-id");F(t.protyle,[{action:"setAttrViewColHidden",id:g,avID:n,data:!1}],[{action:"setAttrViewColHidden",id:g,avID:n,data:!0}]),i.view.columns.find(h=>h.id===g).hidden=!1,f?(o.innerHTML=Sa({protyle:t.protyle,data:i,colId:g}),La({protyle:t.protyle,data:i,menuElement:o})):o.innerHTML=yi(i.view),ke(o,l.right-o.clientWidth,l.bottom,l.height),c.preventDefault(),c.stopPropagation();break}else if(u==="duplicateCol"){const f=o.querySelector(".b3-menu__item").getAttribute("data-col-id"),g=i.view.columns.find(h=>h.id===f);xg({protyle:t.protyle,type:g.type,avID:n,colId:f,icon:g.icon,newValue:g.name}),e.remove(),c.preventDefault(),c.stopPropagation();break}else if(u==="removeCol"){const f=o.querySelector(".b3-menu__item").getAttribute("data-col-id");let g;const h=i.view.columns.find((m,b)=>{if(m.id===f)return g=i.view.columns[b-1]?.id,!0});F(t.protyle,[{action:"removeAttrViewCol",id:f,avID:n}],[{action:"addAttrViewCol",name:h.name,avID:n,type:h.type,id:f,previousID:g}]),Mp(t.blockElement,f),e.remove(),c.preventDefault(),c.stopPropagation();break}else if(u==="setColOption"){ny(t.protyle,i,d,t.blockElement,t.cellElements),c.preventDefault(),c.stopPropagation();break}else if(u==="setRelationCell"){kp(t.protyle,t.blockElement,d,t.cellElements),c.preventDefault(),c.stopPropagation();break}else if(u==="addColOptionOrCell"){dp(t.protyle,i,t.cellElements,d,o,t.blockElement),window.siyuan.menus.menu.remove(),c.preventDefault(),c.stopPropagation();break}else if(u==="removeCellOption"){cp(t.protyle,i,t.cellElements,d.parentElement,t.blockElement),c.preventDefault(),c.stopPropagation();break}else if(u==="addAssetLink"){cy(t.protyle,i,t.cellElements,d,t.blockElement),c.preventDefault(),c.stopPropagation();break}else if(u==="addAssetExist"){const f=d.getBoundingClientRect();Bd(t.protyle,{x:f.right,y:f.bottom,w:d.parentElement.clientWidth+8,h:f.height},g=>{let h;p.Constants.SIYUAN_ASSETS_IMAGE.includes(Le().extname(g).toLowerCase())?h={type:"image",content:g,name:""}:h={type:"file",content:g,name:Le().basename(g).substring(0,p.Constants.SIZE_LINK_TEXT_MAX)},wi({protyle:t.protyle,data:i,cellElements:t.cellElements,type:"addUpdate",addUpdateValue:[h],blockElement:t.blockElement}),window.siyuan.menus.menu.remove()}),c.preventDefault(),c.stopPropagation();break}else if(u==="openAssetItem"){const f=d.parentElement.dataset.content,g=Le().extname(f);es(f)&&[".pdf"].concat(p.Constants.SIYUAN_ASSETS_AUDIO).concat(p.Constants.SIYUAN_ASSETS_VIDEO).includes(g)&&(g!==".pdf"||g===".pdf"&&!f.startsWith("file://"))?ks(t.protyle.app,f.trim(),parseInt((0,I.on)("page",f)),"right"):p.Constants.SIYUAN_ASSETS_IMAGE.includes(g)?pd(f):window.open(f),c.preventDefault(),c.stopPropagation();break}else if(u==="editAssetItem"){ry(t.protyle,i,t.cellElements,d.parentElement,t.blockElement),c.preventDefault(),c.stopPropagation();break}else if(u==="clearDate"){An(t.protyle,t.blockElement,{isNotEmpty2:!1,isNotEmpty:!1,content:null,content2:null,hasEndDate:!1,isNotTime:!0},t.cellElements),e.remove(),c.preventDefault(),c.stopPropagation();break}else if(u==="av-add"){window.siyuan.menus.menu.remove(),wp(t.protyle,t.blockElement),e.remove(),c.preventDefault(),c.stopPropagation();break}else if(u==="av-view-edit"){d.parentElement.querySelector(".b3-chip--primary")?ro({protyle:t.protyle,blockElement:t.blockElement,element:d.parentElement}):(t.blockElement.removeAttribute("data-render"),mt(t.blockElement,t.protyle,()=>{ro({protyle:t.protyle,blockElement:t.blockElement,element:d.parentElement}),e.querySelector(".b3-chip--primary").classList.remove("b3-chip--primary"),d.parentElement.querySelector(".b3-chip").classList.add("b3-chip--primary")},d.parentElement.dataset.id)),c.preventDefault(),c.stopPropagation();break}d=d.parentElement}})})},yi=t=>{let e="",n="";return t.columns.forEach(a=>{a.hidden?n+=`<button class="b3-menu__item" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip">
            ${a.icon?ie(a.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${Yt(a.type)}"></use></svg>`}
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="showCol"><use xlink:href="#iconEyeoff"></use></svg>
    <svg class="b3-menu__action" data-type="editCol"><use xlink:href="#iconEdit"></use></svg>
</button>`:e+=`<button class="b3-menu__item" draggable="true" data-id="${a.id}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip">
            ${a.icon?ie(a.icon,"icon",!0):`<svg class="icon"><use xlink:href="#${Yt(a.type)}"></use></svg>`}
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="hideCol"><use xlink:href="#iconEye"></use></svg>
    <svg class="b3-menu__action${a.type==="block"?" fn__none":""}" data-type="editCol"><use xlink:href="#iconEdit"></use></svg>
</button>`}),n&&(n=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.hideCol} 
    </span>
    <span class="block__icon" data-type="showAllCol">
        ${window.siyuan.languages.showAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEye"></use></svg>
    </span>
</button>
${n}`),`<div class="b3-menu__items">
<button class="b3-menu__item" data-type="nobg">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-config">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.attr}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span class="b3-menu__label">
        ${window.siyuan.languages.showCol} 
    </span>
    <span class="block__icon" data-type="hideAllCol">
        ${window.siyuan.languages.hideAll}
        <span class="fn__space"></span>
        <svg><use xlink:href="#iconEyeoff"></use></svg>
    </span>
</button>
${e}
${n}
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="newCol">
    <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.new}</span>
</button>
</div>`},_i=t=>{if(!t)return"";const e=Le().extname(t).toLowerCase();return p.Constants.SIYUAN_ASSETS_IMAGE.includes(e)?`<img style="max-height: 100%" src="${t}">`:p.Constants.SIYUAN_ASSETS_AUDIO.includes(e)?`<audio style="max-width: 100%" controls="controls" src="${t}"></audio>`:p.Constants.SIYUAN_ASSETS_VIDEO.includes(e)?`<video style="max-width: 100%" controls="controls" src="${t}"></video>`:t},by=()=>{Pe().asset.forEach(t=>{const e=t.pdfObject;if(!e)return;const{pdfDocument:n,pdfViewer:a}=e;if(!n)return;const i=t.element.querySelector("#viewerContainer");if(i.clientHeight===0)return;if(i){const o=i.getAttribute("data-scrolltop");o&&(i.scrollTo(0,parseInt(o)),i.removeAttribute("data-scrolltop"))}const s=a.currentScaleValue;(s==="auto"||s==="page-fit"||s==="page-width")&&(a.currentScaleValue=s),a.update()})},Ip=(t,e,n,a)=>{let i="";if(p.Constants.SIYUAN_ASSETS_AUDIO.includes(t))i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeAudio" class="iframe" updated="${Q().format("YYYYMMDDHHmmss")}"><div class="iframe-content"><audio controls="controls" src="${e}" data-src="${e}"></audio>${p.Constants.ZWSP}</div><div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`;else if(p.Constants.SIYUAN_ASSETS_IMAGE.includes(t)){let s="";e.startsWith("assets/")||(s='<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>'),i=`<span contenteditable="false" data-type="img" class="img"><span> </span><span><span class="protyle-action protyle-icons"><span class="protyle-icon protyle-icon--only"><svg><use xlink:href="#iconMore"></use></svg></span></span><img src="${e}" data-src="${e}" alt="${n}" /><span class="protyle-action__drag"></span>${s}<span class="protyle-action__title"></span></span><span> </span></span>`}else p.Constants.SIYUAN_ASSETS_VIDEO.includes(t)?i=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeVideo" class="iframe" updated="${Q().format("YYYYMMDDHHmmss")}"><div class="iframe-content">${p.Constants.ZWSP}<video controls="controls" src="${e}" data-src="${e}"></video><span class="protyle-action__drag" contenteditable="false"></span></div><div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`:i=`<span data-type="a" data-href="${e}">${a}</span>`;return i},wy=()=>{const t=new me({title:window.siyuan.languages.about5,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.about5}" value="${window.siyuan.config.accessAuthCode}">
    <div class="b3-label__text">${window.siyuan.languages.about6}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),e=t.element.querySelector("input"),n=t.element.querySelectorAll(".b3-button");t.bindInput(e,()=>{n[1].click()}),e.select(),n[0].addEventListener("click",()=>{t.destroy()}),n[1].addEventListener("click",()=>{w("/api/system/setAccessAuthCode",{accessAuthCode:e.value})})},Ut=t=>`${window.siyuan.config.cloudRegion===0?"https://ld246.com":"https://liuyun.io"}/${t}`,va=(t=window.siyuan.languages._kernel[29])=>window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1||window.siyuan.user.userSiYuanProExpireTime>0)?!1:(t&&(t===window.siyuan.languages._kernel[29]&&window.siyuan.config.system.container==="ios"?M(window.siyuan.languages._kernel[122]):(t===window.siyuan.languages._kernel[29]&&(t=window.siyuan.languages._kernel[29].replace("${url}",Ut("subscribe/siyuan"))),M(t))),!0),Ea=()=>window.siyuan.user&&(window.siyuan.user.userSiYuanSubscriptionStatus===0||window.siyuan.user.userSiYuanOneTimePayStatus===1),hd=(t,e)=>{const n=[{filter:["\u6A21\u7248","moban","mb","template"],value:p.Constants.ZWSP,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMarkdown"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.template}</span></div>`},{filter:["\u6302\u4EF6","widget","gj","guajian"],value:p.Constants.ZWSP+1,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBoth"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.widget}</span></div>`},{filter:["\u8D44\u6E90","assets","zy","ziyuan"],value:p.Constants.ZWSP+2,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></div>`},{filter:["\u5F15\u7528\u5757","yinyong","yy","block reference"],value:"((",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRef"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.ref}</span><span class="b3-list-item__meta">((</span></div>`},{filter:["\u5D4C\u5165\u5757","qianrukuai","qrk","embed block"],value:"{{",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSQL"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.blockEmbed}</span><span class="b3-list-item__meta">{{</span></div>`},{filter:["ai chat"],value:p.Constants.ZWSP+5,html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">AI Chat</span></div>'}];Ea()&&n.push({filter:["\u6570\u636E\u5E93","\u5C5E\u6027\u89C6\u56FE","shujuku","shuxingshitu","sjk","sxst","database","attribute view"],value:'<div data-type="NodeAttributeView" data-av-type="table"></div>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDatabase"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.database}</span></div>`}),[{filter:["\u6587\u6863","\u5B50\u6587\u6863","wendang","wd","ziwendang","zwd","xjwd"],value:p.Constants.ZWSP+4,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.general.newFile.custom)}</span></div>`},{value:"",html:"separator"},{filter:["yijibiaoti","\u4E00\u7EA7\u6807\u9898","yjbt","h1","heading"],value:"# "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH1"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading1}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.heading.heading1.custom)}</span></div>`},{filter:["erjibiaoti","\u4E8C\u7EA7\u6807\u9898","ejbt","h2","heading"],value:"## "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH2"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading2}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.heading.heading2.custom)}</span></div>`},{filter:["sanjibiaoti","\u4E09\u7EA7\u6807\u9898","sjbt","h3","heading"],value:"### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH3"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading3}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.heading.heading3.custom)}</span></div>`},{filter:["sijibiaoti","\u56DB\u7EA7\u6807\u9898","sjbt","h4","heading"],value:"#### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH4"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading4}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.heading.heading4.custom)}</span></div>`},{filter:["wujibiaoti","\u4E94\u7EA7\u6807\u9898","wjbt","h5","heading"],value:"##### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH5"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading5}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.heading.heading5.custom)}</span></div>`},{filter:["liujibiaoti","\u516D\u7EA7\u6807\u9898","ljbt","h6","heading"],value:"###### "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconH6"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.heading6}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.heading.heading6.custom)}</span></div>`},{filter:["\u65E0\u5E8F\u5217\u8868","wuxuliebiao","wxlb","unordered list"],value:"* "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.list}</span><span class="b3-list-item__meta">*&nbsp;</span></div>`},{filter:["\u6709\u5E8F\u5217\u8868","youxuliebiao","yxlb","ordered list"],value:"1. "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconOrderedList"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["ordered-list"]}</span><span class="b3-list-item__meta">1.&nbsp;</span></div>`},{filter:["\u4EFB\u52A1\u5217\u8868","renwuliebiao","rwlb","task list","todo list"],value:"* [ ] "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCheck"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.check}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.check.custom)}</span></div>`},{filter:["\u5F15\u8FF0","yinshu","ys","bq","blockquote"],value:"> "+Lute.Caret,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconQuote"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.quote}</span><span class="b3-list-item__meta">&gt;</span></div>`},{filter:["\u4EE3\u7801\u5757","daimakuai","dmk","code block"],value:"```",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.code}</span><span class="b3-list-item__meta">\`\`\`Enter</span></div>`},{filter:["\u8868\u683C","biaoge","bg","table"],value:`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTable"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.table}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.table.custom)}</span></div>`},{filter:["\u5206\u5272\u7EBF","\u5206\u9694\u7EBF","fengexian","fgx","divider","thematic","break"],value:"---",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLine"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.line}</span><span class="b3-list-item__meta">---</span></div>`},{filter:["\u6570\u5B66\u516C\u5F0F\u5757","shuxuegongshikuai","sxgsk","math block"],value:"$$",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.math}</span><span class="b3-list-item__meta">$$</span></div>`},{filter:["html"],value:"<div>",html:'<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconHTML5"></use></svg><span class="b3-list-item__text">HTML</span></div>'},{value:"",html:"separator"},{filter:["\u8868\u60C5","biaoqing","bq","emoji"],value:"emoji",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconEmoji"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.emoji}</span><span class="b3-list-item__meta">:</span></div>`},{filter:["\u94FE\u63A5","lianjie","lj","link","a"],value:"a",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLink"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.link}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.link.custom)}</span></div>`},{filter:["\u7C97\u4F53","cuti","ct","bold","strong"],value:"strong",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconBold"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bold}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.bold.custom)}</span></div>`},{filter:["\u659C\u4F53","xieti","xt","italic","em"],value:"em",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconItalic"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.italic}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.italic.custom)}</span></div>`},{filter:["\u4E0B\u5212\u7EBF","xiahuaxian","xhx","underline"],value:"u",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconUnderline"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.underline}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.underline.custom)}</span></div>`},{filter:["\u5220\u9664\u7EBF","shanchuxian","scx","strike"],value:"s",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconStrike"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.strike}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.strike.custom)}</span></div>`},{filter:["\u6807\u8BB0","biaoji","bj","mark"],value:"mark",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMark"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.mark}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.mark.custom)}</span></div>`},{filter:["\u4E0A\u6807","shangbiao","sb","superscript"],value:"sup",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSup"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sup}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.sup.custom)}</span></div>`},{filter:["\u4E0B\u6807","xiaobiao","xb","subscript"],value:"sub",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconSub"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.sub}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.sub.custom)}</span></div>`},{filter:["\u6807\u7B7E","biaoqian","bq","tag"],value:"tag",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconTags"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.tag}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert.tag.custom)}</span></div>`},{filter:["\u884C\u5185\u4EE3\u7801","hangneidaima","hndm","inline code"],value:"code",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconInlineCode"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-code"]}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert["inline-code"].custom)}</span></div>`},{filter:["\u884C\u5185\u6570\u5B66\u516C\u5F0F","hangneishuxuegongshi","hnsxgs","inline math"],value:"inline-math",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconMath"></use></svg><span class="b3-list-item__text">${window.siyuan.languages["inline-math"]}</span><span class="b3-menu__accelerator">${K(window.siyuan.config.keymap.editor.insert["inline-math"].custom)}</span></div>`},{value:"",html:"separator"},{filter:["\u63D2\u5165\u56FE\u7247\u6216\u6587\u4EF6","upload","\u4E0A\u4F20","crtphwj","sc"],value:p.Constants.ZWSP+3,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconDownload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAsset}</span>
<input class="b3-form__upload" type="file" ${e.options.upload.accept?'multiple="'+e.options.upload.accept+'"':""}></div>`},{filter:["iframe","\u5D4C\u5165\u7F51\u5740","qianruwangzhan","qrwz"],value:'<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconLanguage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertIframeURL}</span></div>`},{filter:["\u63D2\u5165\u56FE\u7247\u94FE\u63A5","insert image link","charutupianlianjie","crtptp"],value:"![]()",html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertImgURL}</span></div>`},{filter:["\u63D2\u5165\u89C6\u9891\u94FE\u63A5","charushipinlianjie","crsplj","insert video url"],value:'<video controls="controls" src=""></video>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconVideo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertVideoURL}</span></div>`},{filter:["\u63D2\u5165\u97F3\u9891\u94FE\u63A5","charuyinpinlianjie","cryplj","insert audio url"],value:'<audio controls="controls" src=""></audio>',html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconRecord"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.insertAudioURL}</span></div>`},{value:"",html:"separator"},{filter:["\u4E94\u7EBF\u8C31","wuxianpu","wxp","staff"],value:"```abc\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">ABC</span><span class="b3-list-item__meta">${window.siyuan.languages.staff}</span></div>`},{filter:["\u56FE\u8868","tubiao","tb","chart"],value:"```echarts\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Chart</span><span class="b3-list-item__meta">${window.siyuan.languages.chart}</span></div>`},{filter:["\u6D41\u7A0B\u56FE","liuchengtu","lct","flow chart"],value:"```flowchart\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">FlowChart</span><span class="b3-list-item__meta">Flow Chart</span></div>'},{filter:["\u72B6\u6001\u56FE","zhuangtaitu","ztt","graph viz"],value:"```graphviz\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Graphviz</span><span class="b3-list-item__meta">Graph</span></div>'},{filter:["\u6D41\u7A0B\u56FE","\u65F6\u5E8F\u56FE","\u7518\u7279\u56FE","liuchengtu","shixutu","gantetu","lct","sxt","gtt","mermaid"],value:"```mermaid\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">Mermaid</span><span class="b3-list-item__meta">Mermaid</span></div>'},{filter:["\u8111\u56FE","naotu","nt","mind map"],value:"```mindmap\n```",html:`<div class="b3-list-item__first"><span class="b3-list-item__text">Mind map</span><span class="b3-list-item__meta">${window.siyuan.languages.mindmap}</span></div>`},{filter:["\u7EDF\u4E00\u5EFA\u6A21\u8BED\u8A00","tongyijianmoyuyan","tyjmyy","plant uml"],value:"```plantuml\n```",html:'<div class="b3-list-item__first"><span class="b3-list-item__text">PlantUML</span><span class="b3-list-item__meta">UML</span></div>'},{value:"",html:"separator"},{filter:["\u4FE1\u606F\u6837\u5F0F","xinxiyangshi","xxys","info style"],value:`style${p.Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.infoStyle}</span></div>`},{filter:["\u6210\u529F\u6837\u5F0F","chenggongyangshi","cgys","success style"],value:`style${p.Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.successStyle}</span></div>`},{filter:["\u8B66\u544A\u6837\u5F0F","jinggaoyangshi","jgys","warning style"],value:`style${p.Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.warningStyle}</span></div>`},{filter:["\u9519\u8BEF\u6837\u5F0F","cuowuyangshi","cwys","error style"],value:`style${p.Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,html:`<div class="b3-list-item__first"><div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.errorStyle}</span></div>`},{filter:["\u79FB\u9664\u6837\u5F0F","yichuyangshi","ycys","remove style"],value:`style${p.Constants.ZWSP}`,html:`<div class="b3-list-item__first"><div class="color__square">A</div><span class="b3-list-item__text">${window.siyuan.languages.clearFontStyle}</span></div>`}].forEach(i=>{n.push(i)}),n.push({value:"",html:"separator"});let a=!1;return e.app.plugins.forEach(i=>{i.protyleSlash.forEach(s=>{n.push({filter:s.filter,value:`plugin${p.Constants.ZWSP}${i.name}${p.Constants.ZWSP}${s.id}`,html:s.html}),a=!0})}),a||n.pop(),t===""?n:n.filter(i=>i.filter?!!i.filter.find(o=>{if(o.indexOf(t.toLowerCase())>-1)return!0}):!1)},yy=(t,e)=>(e.hint.genLoading(e),w("/api/search/searchTag",{k:t},n=>{const a=[];let i=!1;n.data.tags.forEach(s=>{const o=s.replace(/<mark>/g,"").replace(/<\/mark>/g,"");a.push({value:`#${o}#`,html:s}),o===n.data.k&&(i=!0)}),n.data.k&&!i&&(a.splice(0,0,{value:`#${n.data.k}#`,html:`${window.siyuan.languages.new} <mark>${we(n.data.k)}</mark>`}),a.length>1&&(a[1].focus=!0)),e.hint.genHTML(a,e,!0,"hint")}),[]),md=t=>{let e;t.type==="NodeDocument"&&t.ial.icon?(e=ie(t.ial.icon,"b3-list-item__graphic popover__block",!0),e=e.replace('popover__block"',`popover__block" data-id="${t.id}"`)):e=`<svg class="b3-list-item__graphic popover__block" data-id="${t.id}"><use xlink:href="#${bn(t.type)}"></use></svg>`;let n="";return t.name&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span>${t.name}</span></span><span class="fn__space"></span>`),t.alias&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span>${t.alias}</span></span><span class="fn__space"></span>`),t.memo&&(n+=`<span class="fn__flex"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span>${t.memo}</span></span>`),n&&(n=`<div class="fn__flex b3-list-item__meta b3-list-item__showall">${n}</div>`),`${n}<div class="b3-list-item__first">
    ${e}
    <span class="b3-list-item__text">${t.content}</span>
</div>
<div class="b3-list-item__meta b3-list-item__showall">${t.hPath}</div>`},Va=(t,e,n)=>{const a=x(re(e.wysiwyg.element).startContainer);return e.hint.genLoading(e),w("/api/search/searchRefBlock",{k:t,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:e.block.rootID,isSquareBrackets:["[[","\u3010\u3010"].includes(e.hint.splitChar)},i=>{const s=[];if(i.data.newDoc){const o=Lute.UnEscapeHTMLStr(mn(i.data.k));s.push({value:`((newFile "${o}"${p.Constants.ZWSP}'${o}${Lute.Caret}'))`,html:`<div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${i.data.k}</mark></span></div>`})}i.data.blocks.forEach(o=>{let l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="d">${o.name||o.refText}</span>`;n==="search"&&(l=`<span data-type="block-ref" data-id="${o.id}" data-subtype="s">${t}${p.Constants.ZWSP}${o.name||o.refText}</span>`),s.push({value:l,html:md(o)})}),n==="search"&&(e.hint.splitChar="((",e.hint.lastIndex=-1),s.length===0?s.push({value:"",html:window.siyuan.languages.emptyContent}):i.data.newDoc&&s.length>1&&(s[1].focus=!0),e.hint.genHTML(s,e,!0,n)}),[]},rs=(t,e)=>{if(t.endsWith("}}")||t.endsWith("\u300D\u300D"))return[];e.hint.genLoading(e);const n=x(re(e.wysiwyg.element).startContainer);return w("/api/search/searchRefBlock",{k:t,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),id:n?n.getAttribute("data-node-id"):e.block.parentID,rootID:e.block.rootID},a=>{const i=[];a.data.blocks.forEach(s=>{i.push({value:`{{select * from blocks where id='${s.id}'}}`,html:md(s)})}),i.length===0&&i.push({value:"",html:window.siyuan.languages.emptyContent}),e.hint.genHTML(i,e,!0,"hint")}),[]},Dp=(t,e,n)=>{w("/api/template/render",{id:e.block.parentID,path:t},a=>{Z(e.toolbar.range);const i=ae(n);i&&i.textContent.trim()===""?wt(a.data.content,e,!0):wt(a.data.content,e),e.wysiwyg.element.querySelectorAll('[status="temp"]').forEach(s=>{s.remove()}),Be(e,e.wysiwyg.element),bt(e.wysiwyg.element),qe(e.wysiwyg.element),mt(e.wysiwyg.element,e),X(["util"],e)})},$p=(t,e)=>{Z(e.toolbar.range),wt(e.lute.SpinBlockDOM(`<iframe src="/widgets/${t}" data-subtype="widget" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>`),e,!0),X(["util"],e)},Pp=(t,e)=>{Z(e.toolbar.range);const n=Le().extname(t).toLowerCase(),a=t.startsWith("assets/")?Xc(t):t;wt(Ip(n,t,a,t.startsWith("assets/")?a+n:t),e),X(["util"],e)},bd=(t,e,n)=>{if(t==="/")return;const a=ft(t,!0,!0);if(n.block.rootID===a)return;const i=[];let s;const o=e[0].parentElement;let l;if(e.forEach((r,c)=>{c===e.length-1&&r.parentElement&&(s=be(r),l=s.nextElementSibling||s.previousElementSibling,s.isSameNode(r)&&(s=void 0)),i.push({action:"append",id:r.getAttribute("data-node-id"),parentID:a}),r.remove()}),s)i.push({action:"delete",id:s.getAttribute("data-node-id")}),s.remove();else if(o.classList.contains("list")&&o.getAttribute("data-subtype")==="o"&&o.childElementCount>1)it(o,1),Array.from(o.children).forEach(r=>{r.classList.contains("protyle-attr")||i.push({action:"update",id:r.getAttribute("data-node-id"),data:r.outerHTML})});else if(n.block.showAll&&o.classList.contains("protyle-wysiwyg")&&o.childElementCount===0)setTimeout(()=>{Vt({protyle:n,id:n.block.parent2ID,focusId:n.block.parent2ID})},p.Constants.TIMEOUT_INPUT*2+100);else if(o.classList.contains("protyle-wysiwyg")&&o.innerHTML===""&&!A(o,"block__edit",!0)&&n.block.id===n.block.rootID){const r=Lute.NewNodeID(),c=Cn(!1,!1,r);i.splice(0,0,{action:"insert",id:r,data:c.outerHTML,parentID:n.block.parentID}),o.innerHTML=c.outerHTML,le(c)}else l&&le(l);F(n,i)},wd=t=>{if(!t)return"";let e="";const n=t.querySelector(".av__celltext");return n?n.querySelector(".av__cellicon")?e=`${n.firstChild.textContent} \u2192 ${n.lastChild.textContent}`:e=n.textContent:e=t.textContent,e},jl=(t,e)=>{const n={type:t,id:e.dataset.id};if(t==="number"){const a=e.querySelector(".av__celltext").getAttribute("data-content");n.number={content:parseFloat(a)||0,isNotEmpty:!!a}}else if(["text","block","url","phone","email","template"].includes(t))n[t]={content:e.querySelector(".av__celltext").textContent.trim()};else if(t==="mSelect"||t==="select"){const a=[];e.querySelectorAll(".b3-chip").forEach(i=>{a.push({content:i.textContent.trim(),color:i.style.color.replace("var(--b3-font-color","").replace(")","")})}),n.mSelect=a}else if(["date","created","updated"].includes(t))n[t]=JSON.parse(e.querySelector(".av__celltext").getAttribute("data-value"));else if(t==="checkbox")n.checkbox={checked:e.querySelector("use").getAttribute("xlink:href")==="#iconCheck"};else if(t==="relation")n.relation={blockIDs:Array.from(e.querySelectorAll("span")).map(a=>a.getAttribute("data-id")),contents:Array.from(e.querySelectorAll("span")).map(a=>a.textContent)};else if(t==="mAsset"){const a=[];Array.from(e.children).forEach(i=>{const s=i.classList.contains("av__cellassetimg");a.push({type:s?"image":"file",content:s?i.getAttribute("src"):i.getAttribute("data-url"),name:s?"":i.textContent})}),n.mAsset=a}return t==="block"&&(n.isDetached=e.dataset.detached==="true"),n},za=(t,e)=>{let n={type:t,[t==="select"?"mSelect":t]:e};return typeof e=="string"&&e&&t!=="mAsset"?t==="number"?n={type:t,number:{content:parseFloat(e)||0,isNotEmpty:!0}}:["text","block","url","phone","email","template"].includes(t)?n={type:t,[t]:{content:e}}:t==="mSelect"||t==="select"?n={type:t,mSelect:[{content:e,color:"1"}]}:t==="checkbox"?n={type:t,checkbox:{checked:!0}}:t==="relation"&&(n={type:t,relation:{blockIDs:[],contents:[e]}}):(typeof e>"u"||!e)&&(t==="number"?n={type:t,number:{content:0,isNotEmpty:!0}}:["text","block","url","phone","email","template"].includes(t)?n={type:t,[t]:{content:""}}:t==="mSelect"||t==="select"||t==="mAsset"?n={type:t,[t==="select"?"mSelect":t]:[]}:["date","created","updated"].includes(t)?n={type:t,[t]:{content:null,isNotEmpty:!1,content2:null,isNotEmpty2:!1,hasEndDate:!1,isNotTime:!0}}:t==="checkbox"?n={type:t,checkbox:{checked:!1}}:t==="relation"&&(n={type:t,relation:{blockIDs:[],contents:[]}})),t==="block"&&(n.isDetached=!0),n},vi=(t,e,n=!0)=>{const a=e.getBoundingClientRect();if(!n){const s=t.querySelector(".av__scroll");if(s){const o=s.getBoundingClientRect();if(o.right<a.right)s.scrollLeft=s.scrollLeft+a.right-o.right;else{const l=A(e,"av__row");if(l){const r=l.querySelector(".av__colsticky");if(r){const c=r.getBoundingClientRect().right;c>a.left&&(s.scrollLeft=s.scrollLeft+a.left-c)}else o.left>a.left&&(s.scrollLeft=s.scrollLeft+a.left-o.left)}}}}if(!t.querySelector(".av__header"))return;const i=t.querySelector(".av__row--header").getBoundingClientRect();if(i.bottom>a.top){const s=A(t,"protyle-content",!0);s&&(s.scrollTop=s.scrollTop+a.top-i.bottom)}else{const s=t.querySelector(".av__row--footer").getBoundingClientRect();if(s.top<a.bottom){const o=A(t,"protyle-content",!0);o&&(o.scrollTop=o.scrollTop+a.bottom-s.top)}}},fo=t=>{const e=A(t,"av__scroll");if(e)return e.querySelector(".av__row--header").querySelector(`[data-col-id="${t.getAttribute("data-col-id")}"]`).getAttribute("data-dtype")},qn=(t,e,n)=>{if(e.length===0||e.length===1&&!e[0]||(n||(n=fo(e[0])),n==="updated"||n==="created"||document.querySelector(".av__mask"))||n==="block"&&(e.length>1||!e[0].getAttribute("data-detached")))return;const a=x(e[0]);let i=e[0].getBoundingClientRect();a&&vi(a,e[0],!1),i=e[0].getBoundingClientRect();let s="";const o=`style="padding-top: 6.5px;position:absolute;left: ${i.left}px;top: ${i.top}px;width:${Math.max(i.width,25)}px;height: ${i.height}px"`;if(["text","url","email","phone","block","template"].includes(n))s=`<textarea ${o} class="b3-text-field">${e[0].firstElementChild.textContent}</textarea>`;else if(n==="number")s=`<input type="number" value="${e[0].firstElementChild.getAttribute("data-content")}" ${o} class="b3-text-field">`;else if(a){["select","mSelect"].includes(n)?Zt({protyle:t,blockElement:a,type:"select",cellElements:e}):n==="mAsset"?(Zt({protyle:t,blockElement:a,type:"asset",cellElements:e}),le(a)):n==="date"?Zt({protyle:t,blockElement:a,type:"date",cellElements:e}):n==="checkbox"?yd(t,n,e):n==="relation"?Zt({protyle:t,blockElement:a,type:"relation",cellElements:e}):n==="rollup"&&Zt({protyle:t,blockElement:a,type:"rollup",cellElements:e,colId:e[0].dataset.colId}),A(e[0],"custom-attr")||e[0].classList.add("av__cell--select");return}window.siyuan.menus.menu.remove(),document.body.insertAdjacentHTML("beforeend",`<div class="av__mask" style="z-index: ${++window.siyuan.zIndex}">
    ${s}
</div>`);const l=document.querySelector(".av__mask"),r=l.querySelector(".b3-text-field");r&&(r.select(),r.focus(),a&&n==="template"&&w("/api/av/renderAttributeView",{id:a.dataset.avId},c=>{c.data.view.columns.find(d=>{if(d.id===e[0].dataset.colId)return r.value=d.template,r.dataset.template=d.template,!0})}),n==="block"&&r.addEventListener("input",c=>{p.Constants.BLOCK_HINT_KEYS.includes(r.value.substring(0,2))&&(t.toolbar.range=document.createRange(),t.toolbar.range.selectNodeContents(e[0].lastChild),Z(t.toolbar.range),Va(r.value.substring(2),t,"av"),l?.remove(),c.preventDefault(),c.stopPropagation())}),r.addEventListener("keydown",c=>{c.isComposing||(c.key==="Escape"||c.key==="Tab"||c.key==="Enter"&&!c.shiftKey&&R(c))&&(yd(t,n,e),c.key==="Tab"&&t.wysiwyg.element.dispatchEvent(new KeyboardEvent("keydown",{shiftKey:c.shiftKey,ctrlKey:c.ctrlKey,altKey:c.altKey,metaKey:c.metaKey,key:"Tab",keyCode:9})),c.preventDefault(),c.stopPropagation())})),l.addEventListener("click",c=>{c.target.classList.contains("av__mask")&&(yd(t,n,e),l?.remove())})},yd=(t,e,n)=>{const a=A(n[0],"av__row");if(!a)return;if(!document.contains(n[0])&&n.length===1){const d=a.dataset.avid;if(d){const u=a.dataset.previousId;n[0]=t.wysiwyg.element.querySelector(u?`[data-av-id="${d}"] .av__row[data-id="${u}"]`:`[data-av-id="${d}"] .av__row--header`).nextElementSibling.querySelector('[data-detached="true"]')}else{let u=t.wysiwyg.element.querySelector(`.av__cell[data-id="${n[0].dataset.id}"]`);if(u||(u=t.wysiwyg.element.querySelector(`.av__row[data-id="${a.dataset.id}"] .av__cell[data-col-id="${n[0].dataset.colId}"]`)),!u)return;n[0]=u}}if(n.length===1&&n[0].dataset.detached==="true"&&!a.dataset.id)return;const i=x(n[0]);if(!i)return;const s=document.querySelector(".av__mask"),o=[],l=[],r=i.getAttribute("data-av-id"),c=i.getAttribute("data-node-id");if(e==="template"){const d=n[0].getAttribute("data-col-id"),u=s.querySelector(".b3-text-field");u.value!==u.dataset.template&&F(t,[{action:"updateAttrViewColTemplate",id:d,avID:r,data:u.value,type:"template"}],[{action:"updateAttrViewColTemplate",id:d,avID:r,data:u.dataset.template,type:"template"}])}else n.forEach(d=>{const u=A(d,"av__row");if(!u)return;const f=u.getAttribute("data-id"),g=d.getAttribute("data-id"),h=d.getAttribute("data-col-id"),m={},b={};if(e==="number")b.content=parseFloat(d.textContent.trim()),b.isNotEmpty=typeof b.content=="number"&&!isNaN(b.content),m.content=parseFloat(s.querySelector(".b3-text-field").value),m.isNotEmpty=typeof m.content=="number"&&!isNaN(m.content),m.isNotEmpty||(m.content=0);else if(e==="checkbox"){const y=d.querySelector("use");m.checked=y.getAttribute("xlink:href")==="#iconUncheck",b.checked=!m.checked,y.setAttribute("xlink:href",m.checked?"#iconCheck":"#iconUncheck")}else m.content=s.querySelector(".b3-text-field").value,b.content=e==="block"?d.firstElementChild.textContent.trim():d.textContent.trim();(0,I.MK)(m,b)||(o.push({action:"updateAttrViewCell",id:g,avID:r,keyID:h,rowID:f,data:{[e]:m,isDetached:!0}},{action:"doUpdateUpdated",id:c,data:Q().format("YYYYMMDDHHmmss")}),l.push({action:"updateAttrViewCell",id:g,avID:r,keyID:h,rowID:f,data:{[e]:b,isDetached:!0}},{action:"doUpdateUpdated",id:c,data:i.getAttribute("updated")}),A(n[0],"custom-attr")||cn(d,{[e]:m,isDetached:!0,type:e}))});o.length>0&&F(t,o,l),A(n[0],"custom-attr")||n[0].classList.add("av__cell--select"),i&&!document.querySelector(".b3-dialog")&&le(i),document.querySelectorAll(".av__mask").forEach(d=>{d.remove()})},An=(t,e,n,a)=>{const i=[],s=[],o=e.dataset.avId,l=e.dataset.nodeId;let r="",c;return a?.length>0?c=a:(c=Array.from(e.querySelectorAll(".av__cell--select")),c.length===0&&e.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(d=>{d.querySelectorAll(".av__cell").forEach(u=>{c.push(u)})})),c.forEach((d,u)=>{e.contains(d)||(d=c[u]=e.querySelector(`.av__cell[data-id="${d.dataset.id}"]`));const f=A(d,"av__row");if(!f)return;const g=fo(d)||d.dataset.type;if(["created","updated","template"].includes(g))return;const h=f.getAttribute("data-id"),m=d.getAttribute("data-id"),b=d.getAttribute("data-col-id");r+=wd(d);const y=jl(g,d);if(g==="mAsset"){if(Array.isArray(n))n=y.mAsset.concat(n);else if(typeof n<"u")return}else g==="mSelect"&&typeof n=="string"&&(n=y.mSelect.concat({content:n,color:(y.mSelect.length+1).toString()}));const _=za(g,n);i.push({action:"updateAttrViewCell",id:m,avID:o,keyID:b,rowID:h,data:_}),s.push({action:"updateAttrViewCell",id:m,avID:o,keyID:b,rowID:h,data:y}),A(c[0],"custom-attr")?d.innerHTML=_a(_):cn(d,_)}),i.length>0&&(i.push({action:"doUpdateUpdated",id:l,data:Q().format("YYYYMMDDHHmmss")}),s.push({action:"doUpdateUpdated",id:l,data:e.getAttribute("updated")}),F(t,i,s)),r},_d=(t,e)=>{let n="";if(["text","template"].includes(t.type))n=`<span class="av__celltext">${t&&t[t.type].content||""}</span>`;else if(["url","email","phone"].includes(t.type)){const a=t?t[t.type].content:"";let i="";t.type==="url"&&(i=` data-href="${a}"`),n=`<span class="av__celltext av__celltext--url" data-type="${t.type}"${i}>${a}</span>`}else if(t.type==="block")t?.isDetached?n=`<span class="av__celltext">${t.block.content||""}</span>
<span class="b3-chip b3-chip--info b3-chip--small" data-type="block-more">${window.siyuan.languages.more}</span>`:n=`<span data-type="block-ref" data-id="${t.block.id}" data-subtype="s" class="av__celltext av__celltext--ref">${t.block.content||""}</span>
<span class="b3-chip b3-chip--info b3-chip--small popover__block" data-id="${t.block.id}" data-type="block-more">${window.siyuan.languages.update}</span>`;else if(t.type==="number")n=`<span style="float: right;${e?"word-break: break-word;":""}" class="av__celltext" data-content="${t?.number.isNotEmpty?t?.number.content:""}">${t?.number.formattedContent||t?.number.content||""}</span>`;else if(t.type==="mSelect"||t.type==="select")t?.mSelect?.forEach(a=>{n+=`<span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">${a.content}</span>`});else if(t.type==="date"){const a=t?t.date:null;n=`<span class="av__celltext" data-value='${JSON.stringify(a)}'>`,a&&a.isNotEmpty&&(n+=Q(a.content).format(a.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),a&&a.hasEndDate&&a.isNotEmpty&&a.isNotEmpty2&&(n+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Q(a.content2).format(a.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),n+="</span>"}else if(["created","updated"].includes(t.type)){const a=t?t[t.type]:null;n=`<span class="av__celltext" data-value='${JSON.stringify(a)}'>`,a&&a.isNotEmpty&&(n+=Q(a.content).format("YYYY-MM-DD HH:mm")),n+="</span>"}else t.type==="mAsset"?t?.mAsset?.forEach(a=>{a.type==="image"?n+=`<img class="av__cellassetimg" src="${a.content}">`:n+=`<span class="b3-chip av__celltext--url" data-url="${a.content}">${a.name}</span>`}):t.type==="checkbox"?n+=`<svg class="av__checkbox"><use xlink:href="#icon${t?.checkbox?.checked?"Check":"Uncheck"}"></use></svg>`:t.type==="rollup"?t?.rollup?.contents?.forEach((a,i)=>{const s=["select","mSelect","mAsset","checkbox","relation"].includes(a.type)?_d(a,e):_y(a);!s&&n?n=n.substring(0,n.length-2):n+=s+(i===t.rollup.contents.length-1||!s?"":", ")}):t.type==="relation"&&t?.relation?.contents?.forEach((a,i)=>{n+=`<span class="av__celltext--ref" style="margin-right: 8px" data-id="${t?.relation?.blockIDs[i]}">${a}</span>`});return["text","template","url","email","phone","number","date","created","updated"].includes(t.type)&&t&&t[t.type].content&&(n+=`<span ${t.type!=="number"?"":'style="right:auto;left:5px"'} data-type="copy" class="block__icon"><svg><use xlink:href="#iconCopy"></use></svg></span>`),n},_y=t=>{let e="";if(["text"].includes(t.type))e=t&&t[t.type].content||"";else if(["url","email","phone"].includes(t.type)){const n=t?t[t.type].content:"";if(n){let a="";t.type==="url"&&(a=` data-href="${n}"`),e=`<span class="av__celltext av__celltext--url" data-type="${t.type}"${a}>${n}</span>`}}else if(t.type==="block")t?.isDetached?e=`<span class="av__celltext">${t.block?.content||""}</span>`:e=`<span data-type="block-ref" data-id="${t.block?.id}" data-subtype="s" class="av__celltext av__celltext--ref">${t.block?.content||""}</span>`;else if(t.type==="number")e=t?.number.formattedContent||t?.number.content.toString()||"";else if(t.type==="date"){const n=t?t.date:null;n&&n.isNotEmpty&&(e+=Q(n.content).format(n.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")),n&&n.hasEndDate&&n.isNotEmpty&&n.isNotEmpty2&&(e+=`<svg class="av__cellicon"><use xlink:href="#iconForward"></use></svg>${Q(n.content2).format(n.isNotTime?"YYYY-MM-DD":"YYYY-MM-DD HH:mm")}`),e&&(e=`<span class="av__celltext">${e}</span>`)}return e},vy=(t,e)=>{if(typeof e.icon<"u"&&(t.dataset.icon=e.icon,t.querySelector(".av__cellheadericon").outerHTML=e.icon?ie(e.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Yt(t.dataset.dtype)}"></use></svg>`),typeof e.name<"u"&&(t.querySelector(".av__celltext").textContent=e.name),typeof e.pin<"u"){const n=t.querySelector(".av__celltext");e.pin?n.nextElementSibling||n.insertAdjacentHTML("afterend",'<div class="fn__flex-1"></div><svg class="av__cellheadericon"><use xlink:href="#iconPin"></use></svg>'):n.nextElementSibling&&(n.nextElementSibling.nextElementSibling.remove(),n.nextElementSibling.remove())}};class Ey{constructor(e=""){this.eventTarget=document.appendChild(document.createComment(e))}on(e,n){e==="loaded-protyle"&&console.warn("0.8.8 \u5C06\u79FB\u9664 loaded-protyle, \u8BF7\u4F7F\u7528 loaded-protyle-static \u8FDB\u884C\u66FF\u4EE3"),this.eventTarget.addEventListener(e,n)}once(e,n){this.eventTarget.addEventListener(e,n,{once:!0})}off(e,n){this.eventTarget.removeEventListener(e,n)}emit(e,n){return this.eventTarget.dispatchEvent(new CustomEvent(e,{detail:n,cancelable:!0}))}}const en=t=>{const e=new jw;t.detail.menu=e,t.plugins.forEach(n=>{n.eventBus.emit(t.type,t.detail)}),e.menus.length>0&&(t.separatorPosition==="top"&&window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.plugin,icon:"iconPlugin",type:"submenu",submenu:e.menus}).element),t.separatorPosition==="bottom"&&window.siyuan.menus.menu.append(new S({type:"separator"}).element))},ky=(t,e)=>{const n=x(e.target);if(!n)return!1;if(e.shiftKey){const s=A(e.target,"av__row");if(s&&!s.classList.contains("av__row--header"))return ta(s.querySelector(".av__firstcol"),"toggle"),!0}const a=q(e.target,"data-type","copy");if(a)return G(wd(A(a,"av__cell"))),M(window.siyuan.languages.copied),e.preventDefault(),e.stopPropagation(),!0;if(t.disabled)return!1;let i=e.target;for(;i&&!i.isEqualNode(n);){const s=i.getAttribute("data-type");if(s==="av-header-add"){const o=or(t,n),l=i.getBoundingClientRect();return o.open({x:l.left,y:l.bottom,h:l.height}),e.preventDefault(),e.stopPropagation(),!0}else{if(s==="av-header-more")return Zt({protyle:t,blockElement:n,type:"properties"}),e.preventDefault(),e.stopPropagation(),!0;if(s==="av-add-more"){const o=n.getAttribute("data-av-id"),l=[Lute.NewNodeID()];return F(t,[{action:"insertAttrViewBlock",avID:o,srcIDs:l,isDetached:!0}],[{action:"removeAttrViewBlock",srcIDs:l,avID:o}]),co(n,l,void 0,o),e.preventDefault(),e.stopPropagation(),!0}else{if(s==="av-more")return Zt({protyle:t,blockElement:n,type:"config"}),e.preventDefault(),e.stopPropagation(),!0;if(s==="av-switcher")return Zt({protyle:t,blockElement:n,type:"switcher"}),e.preventDefault(),e.stopPropagation(),!0;if(s==="av-sort")return Zt({protyle:t,blockElement:n,type:"sorts"}),e.preventDefault(),e.stopPropagation(),!0;if(s==="av-filter")return Zt({protyle:t,blockElement:n,type:"filters"}),e.preventDefault(),e.stopPropagation(),!0;if(s==="av-add")return wp(t,n),e.preventDefault(),e.stopPropagation(),!0;if(s==="block-more")return t.toolbar.range=document.createRange(),t.toolbar.range.selectNodeContents(i),Z(t.toolbar.range),Va(i.previousElementSibling.textContent.trim(),t,"av"),e.preventDefault(),e.stopPropagation(),!0;if(s==="av-load-more")return n.querySelector(".av__row--footer").style.transform="",n.removeAttribute("data-render"),n.dataset.pageSize=(parseInt(n.dataset.pageSize)+parseInt(n.querySelector('[data-type="set-page-size"]').getAttribute("data-size"))).toString(),mt(n,t),e.preventDefault(),e.stopPropagation(),!0;if(s==="set-page-size")return yp({target:i,protyle:t,avID:n.getAttribute("data-av-id"),nodeElement:n}),e.preventDefault(),e.stopPropagation(),!0;if(s==="av-add-bottom"){const o=n.getAttribute("data-av-id"),l=[Lute.NewNodeID()],r=n.querySelector(".av__row--util").previousElementSibling.getAttribute("data-id")||"";return F(t,[{action:"insertAttrViewBlock",avID:o,previousID:r,srcIDs:l,isDetached:!0}],[{action:"removeAttrViewBlock",srcIDs:l,avID:o}]),co(n,l,r,o),e.preventDefault(),e.stopPropagation(),!0}else{if(i.classList.contains("av__firstcol"))return window.siyuan.menus.menu.remove(),ta(i,"toggle"),e.preventDefault(),e.stopPropagation(),!0;if(i.classList.contains("av__celltext--url")){let o=i.textContent.trim();i.dataset.type==="phone"?o="tel:"+o:i.dataset.type==="email"?o="mailto:"+o:i.classList.contains("b3-chip")&&(o=i.dataset.url);const l=Le().extname(o);return es(o)&&[".pdf"].concat(p.Constants.SIYUAN_ASSETS_AUDIO).concat(p.Constants.SIYUAN_ASSETS_VIDEO).includes(l)&&(l!==".pdf"||l===".pdf"&&!o.startsWith("file://"))?ks(t.app,o.trim(),parseInt((0,I.on)("page",o)),"right"):window.open(o),e.preventDefault(),e.stopPropagation(),!0}else{if(i.classList.contains("av__cellassetimg"))return pd(i.src),e.preventDefault(),e.stopPropagation(),!0;if(i.classList.contains("av__cellheader"))return Tg(t,n,i.parentElement),e.preventDefault(),e.stopPropagation(),!0;if(i.classList.contains("av__cell")){if(!A(i,"av__row--header")){const o=A(i,"av__scroll");if(!o||i.querySelector(".av__pulse"))return;const l=A(i,"av__row");if(!l)return;const r=fo(i);r==="updated"||r==="created"||r==="block"&&!i.getAttribute("data-detached")?ta(l.querySelector(".av__firstcol"),"toggle"):(o.querySelectorAll(".av__row--select").forEach(c=>{c.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),c.classList.remove("av__row--select")}),ls(l),qn(t,[i]))}return e.preventDefault(),e.stopPropagation(),!0}else{if(i.classList.contains("av__calc"))return Sp(t,i),e.preventDefault(),e.stopPropagation(),!0;if(i.classList.contains("item")&&i.parentElement.classList.contains("layout-tab-bar"))return i.classList.contains("item--focus")?ro({protyle:t,blockElement:n,element:i}):(n.removeAttribute("data-render"),mt(n,t,void 0,i.dataset.id)),e.preventDefault(),e.stopPropagation(),!0}}}}}i=i.parentElement}return!1},Kl=(t,e,n)=>{if(e.classList.contains("av__row--header"))return!1;const a=x(e);if(!a)return!1;a.querySelectorAll(".av__cell--select").forEach(o=>{o.classList.remove("av__cell--select")}),e.classList.contains("av__row--select")||(a.querySelectorAll(".av__row--select").forEach(o=>{o.classList.remove("av__row--select")}),a.querySelectorAll(".av__firstcol use").forEach(o=>{o.setAttribute("xlink:href","#iconUncheck")}));const i=new At("av-row-menu");if(i.isOpen)return!0;e.classList.add("av__row--select"),e.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconCheck");const s=a.querySelectorAll(".av__row--select:not(.av__row--header)");if(ls(e),t.disabled||i.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){_p(a,t)}}),s.length===1&&!s[0].querySelector('[data-detached="true"]')&&(t.disabled||i.addSeparator(),lp(t.app,s[0].getAttribute("data-id")),i.addItem({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:Li(s[0].getAttribute("data-id"))})),!t.disabled){i.addSeparator();const o=[];e.parentElement.querySelectorAll(".av__row--header .av__cell").forEach(l=>{let r=!1;const c=Array.from(a.querySelectorAll(`.av__row--select:not(.av__row--header) .av__cell[data-col-id="${l.dataset.colId}"]`));l.dataset.dtype==="block"&&c.find(u=>{if(!u.dataset.detached)return r=!0,!0});const d=l.getAttribute("data-dtype");if(!r&&!["updated","created"].includes(d)){const u=l.dataset.icon;o.push({iconHTML:u?ie(u,"b3-menu__icon",!0):`<svg class="b3-menu__icon"><use xlink:href="#${Yt(d)}"></use></svg>`,label:l.querySelector(".av__celltext").textContent.trim(),click(){qn(t,c)}})}}),i.addItem({icon:"iconAttr",label:window.siyuan.languages.attr,type:"submenu",submenu:o})}return t?.app?.plugins&&en({plugins:t.app.plugins,type:"open-menu-av",detail:{protyle:t,element:a,selectRowElements:s},separatorPosition:"top"}),i.open(n),!0},vd=(t,e)=>{const n=e.getAttribute("data-av-id"),a=e.getAttribute("data-node-id"),i=e.querySelector(".av__title"),s=i.textContent.trim();if(s===i.dataset.title.trim())return;const o=Q().format("YYYYMMDDHHmmss");F(t,[{action:"setAttrViewName",id:n,data:s},{action:"doUpdateUpdated",id:a,data:o}],[{action:"setAttrViewName",id:n,data:i.dataset.title},{action:"doUpdateUpdated",id:a,data:e.getAttribute("updated")}]),e.setAttribute("updated",o),i.dataset.title=s,Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${n}"]`)).forEach(l=>{if(e.isSameNode(l))return;const r=l.querySelector(".av__title");r&&(r.textContent=s,r.dataset.title=s)})},cn=(t,e,n)=>{n?vy(t,n):t.innerHTML=_d(e,t.dataset.wrap==="true")},Mp=(t,e)=>{t.querySelectorAll(`.av__cell[data-col-id="${e}"]`).forEach(n=>{n.remove()})},Sy=(t,e,n,a)=>{const i=n.lute.BlockDOM2StdMd(e),s=Array.from(a.querySelectorAll(".av__cell--select"));a.querySelector(".av__row--select")?An(n,a,i):s.length>0?An(n,a,i,s):(t.insertNode(document.createTextNode(i)),t.collapse(!1),vd(n,a))},wt=(t,e,n=!1,a=!1)=>{if(t==="")return;const i=a?e.toolbar.range:re(e.wysiwyg.element);Du(i);let s;q(i.startContainer,"data-type","NodeTable")&&!n&&(se(i.startContainer,"TABLE")?s=e.lute.BlockDOM2InlineBlockDOM(t):n=!0);let o=x(i.startContainer);if(o||(e.toolbar.range?o=x(e.toolbar.range.startContainer):o=e.wysiwyg.element.firstElementChild),!o)return;if(o.classList.contains("av")){i.deleteContents(),Sy(i,t,e,o);return}let l=o.getAttribute("data-node-id");i.insertNode(document.createElement("wbr"));let r=o.outerHTML;const c=o.getAttribute("data-type")==="NodeCodeBlock";if(!n&&(c||e.toolbar.getCurrentType(i).includes("code"))){i.deleteContents(),i.insertNode(document.createTextNode(t.replace(/\r\n|\r|\u2028|\u2029/g,`
`))),i.collapse(!1),i.insertNode(document.createElement("wbr")),c?(ae(o).removeAttribute("data-render"),qe(o)):fe(o,i),o.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(e,l,o.outerHTML,r),setTimeout(()=>{He(e,o,!1,"smooth")},p.Constants.TIMEOUT_LOAD);return}const d=[],u=[];if(i.toString()!==""){const y=q(i.commonAncestorContainer,"data-type","inline-math");y?y.remove():(i.startContainer.nodeType===3&&i.startContainer.parentElement.getAttribute("data-type")?.indexOf("block-ref")>-1&&i.startContainer.parentElement.remove(),i.deleteContents()),i.insertNode(document.createElement("wbr")),d.push({action:"update",id:l,data:r}),u.push({action:"update",id:l,data:o.outerHTML})}const f=document.createElement("template");f.innerHTML=s||e.lute.SpinBlockDOM(t)||t;const g=ae(o);if(!n&&(f.content.firstChild.nodeType===3||f.content.firstChild.nodeType!==3&&(f.content.firstElementChild.classList.contains("p")&&f.content.childElementCount===1||f.content.firstElementChild.tagName!=="DIV"))){f.content.firstChild.nodeType!==3&&f.content.firstElementChild.classList.contains("p")&&(f.innerHTML=f.content.firstElementChild.firstElementChild.innerHTML.trim());const y=i.startContainer.nodeType===3?i.startContainer.parentElement:i.startContainer;if(y.tagName==="SPAN"&&y.isSameNode(i.endContainer.nodeType===3?i.endContainer.parentElement:i.endContainer)&&f.content.querySelector("span, img")){const k=document.createElement("span"),L=y.attributes;for(let C=0;C<L.length;C++)k.setAttribute(L[C].name,L[C].value);i.setEnd(y.lastChild,y.lastChild.textContent.length),k.append(i.extractContents()),y.after(k),i.setStartBefore(k),i.collapse(!0)}i.insertNode(f.content.cloneNode(!0)),i.collapse(!1),o.setAttribute("updated",Q().format("YYYYMMDDHHmmss"));const _=g?g.innerHTML.trimStart():"";if(g&&(_.startsWith("```")||_.startsWith("~~~")||_.startsWith("\xB7\xB7\xB7")||_.indexOf("\n```")>-1||_.indexOf(`
~~~`)>-1||_.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(_.indexOf(`
`)===-1&&_.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let k=g.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();k.endsWith("\n```")||(k+="\n```");const L=k.indexOf("```")+3;k=k.substring(0,L)+(localStorage["local-codelang"]||"")+k.substring(L),g.innerHTML=k}const v=g.querySelector("wbr");if(v&&g&&!_.endsWith(`
`)){const k=Ke(v);k&&k.nodeType!==3&&(k.dataset.type||"").indexOf("inline-math")>-1&&!rt(v)&&v.insertAdjacentText("afterend",`
`)}Ln(o),J(e,l,o.outerHTML,r),fe(e.wysiwyg.element,i);return}const h=A(o,"li");if(f.content.children[0]?.getAttribute("data-type")==="NodeListItem")if(h)o=h,l=o.getAttribute("data-node-id"),r=o.outerHTML;else{const _=f.content.children[0].getAttribute("data-subtype");f.innerHTML=`<div${_==="o"?' data-marker="1."':""} data-subtype="${_}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${t}<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`}let m;Array.from(f.content.children).reverse().forEach(y=>{let _=y.getAttribute("data-node-id");if(_===l)u.push({action:"update",data:y.outerHTML,id:_}),d.push({action:"update",id:_,data:r});else{if(y.classList.contains("li")&&!o.parentElement.classList.contains("list")){_=Lute.NewNodeID();const v=document.createElement("div");v.setAttribute("data-subtype",y.getAttribute("data-subtype")),v.setAttribute("data-node-id",_),v.setAttribute("data-type","NodeList"),v.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),v.classList.add("list"),v.append(y),y=v}u.push({action:"insert",data:y.outerHTML,id:_,previousID:l}),d.push({action:"delete",id:_})}o.after(y),m||(m=y)}),g&&g.textContent===""&&o.classList.contains("p")&&(u.find((y,_)=>{if(y.id===l)return u.splice(_,1),!0}),u.push({action:"delete",id:l}),d.find((y,_)=>{if(y.id===l&&y.action==="update")return d.splice(_,1),!0}),d.push({action:"insert",data:r,id:l,previousID:o.previousElementSibling?o.previousElementSibling.getAttribute("data-node-id"):"",parentID:o.parentElement.getAttribute("data-node-id")||e.block.parentID}),o.remove()),m&&le(m,void 0,!1);const b=e.wysiwyg.element.querySelector("wbr");b&&b.remove(),F(e,u,d)},Np=t=>{if(t){X(["util"],t),t.observer?.disconnect(),t.observerLoad?.disconnect(),t.element.classList.remove("protyle"),t.element.removeAttribute("style"),t.wysiwyg&&(t.wysiwyg.lastHTMLs={}),t.undo&&t.undo.clear();try{t.ws.send("closews",{})}catch{setTimeout(()=>{t.ws.send("closews",{})},10240)}t.app.plugins.forEach(e=>{e.eventBus.emit("destroy-protyle",{protyle:t})})}};class Ly{constructor(){this.isUploading=!1,this.element=document.createElement("div"),this.element.className="protyle-upload"}}const Cy=(t,e)=>{const n=[];let a="",i="";for(let o=e.length,l=0;l<o;l++){const r=e[l];let c=!0;r.name||(a+=`<li>${window.siyuan.languages.nameEmpty}</li>`,c=!1),r.size>t.options.upload.max&&(a+=`<li>${r.name} ${window.siyuan.languages.over} ${t.options.upload.max/1024/1024}M</li>`,c=!1);const d=r.name.lastIndexOf("."),u=d===-1?"":r.name.substr(d),f=d===-1?r.name:t.options.upload.filename(r.name.substr(0,d))+u;t.options.upload.accept&&(t.options.upload.accept.split(",").some(h=>{const m=h.trim();if(m.indexOf(".")===0){if(u.toLowerCase()===m.toLowerCase())return!0}else if(r.type.split("/")[0]===m.split("/")[0])return!0;return!1})||(a+=`<li>${r.name} ${window.siyuan.languages.fileTypeError}</li>`,c=!1)),c&&(n.push(r),i+=`<li>${f} ${window.siyuan.languages.uploading}</li>`)}let s;return(a!==""||i!=="")&&(s=M(`<ul>${a}${i}</ul>`,-1)),{files:n,msgId:s}},Hp=(t,e)=>{const n=JSON.parse(t);let a="";n.code===1&&(a=`${n.msg}`),n.data.errFiles&&n.data.errFiles.length>0&&(a=`<ul><li>${a}</li>`,n.data.errFiles.forEach(d=>{const u=d.lastIndexOf("."),f=u===-1?d:e.options.upload.filename(d.substr(0,u))+d.substr(u);a+=`<li>${f} ${window.siyuan.languages.uploadError}</li>`}),a+="</ul>"),a&&M(a);let i=!0;const s=re(e.wysiwyg.element);s.toString()===""&&s.startContainer.nodeType===3&&e.toolbar.getCurrentType(s).length>0&&(s.setEndAfter(s.startContainer.parentElement),s.collapse(!1));const o=x(s.startContainer);if(o)if(o.classList.contains("table"))i=!1;else{const d=ae(o);d&&d.textContent!==""&&o.classList.contains("p")&&(i=!1)}let l="";const r=Object.keys(n.data.succMap),c=[];if(r.forEach((d,u)=>{const f=n.data.succMap[d],g=Le().extname(d).toLowerCase(),h=e.options.upload.filename(d),m=h.substring(0,h.length-g.length);c.push({type:p.Constants.SIYUAN_ASSETS_IMAGE.includes(g)?"image":"file",content:f,name:m}),l+=Ip(g,f,m,h),!p.Constants.SIYUAN_ASSETS_AUDIO.includes(g)&&!p.Constants.SIYUAN_ASSETS_VIDEO.includes(g)&&r.length-1!==u&&(o&&o.classList.contains("table")?l+="<br>":i?l+=`

`:l+=`
`)}),o&&o.classList.contains("av")){An(e,o,c),document.querySelector(".av__panel")?.remove();return}if(document.querySelector(".av__panel")){const d=x(e.wysiwyg.element.querySelector(".av__cell--select"));if(d){An(e,d,c),document.querySelector(".av__panel")?.remove();return}}wt(l,e,i)},po=(t,e,n)=>{const a=M(window.siyuan.languages.uploading,0);w("/api/asset/insertLocalAssets",{assetPaths:t,isUpload:n,id:e.block.rootID},i=>{W(a),Hp(JSON.stringify(i),e)})},ka=(t,e,n,a)=>{if(!t){const d=new FormData;for(let f=0,g=e.length;f<g;f++)d.append("file[]",e[f]);const u=new XMLHttpRequest;u.open("POST",p.Constants.UPLOAD_ADDRESS),u.onreadystatechange=()=>{u.readyState===XMLHttpRequest.DONE&&(u.status===200?a(u.responseText):u.status===0?M(window.siyuan.languages.fileTypeError):M(u.responseText),n&&(n.value=""))},u.send(d);return}let i=[];for(let d=0;d<e.length;d++){let u=e[d];u instanceof DataTransferItem&&(u=u.getAsFile()),u.size===0&&u.type===""&&u.name.indexOf(".")===-1?po([u.path],t,!1):i.push(u)}if(t.options.upload.handler){const d=t.options.upload.handler(i);if(typeof d=="string"){M(d);return}return}if(!t.options.upload.url||!t.upload){n&&(n.value=""),M("please config: options.upload.url");return}if(t.options.upload.file&&(i=t.options.upload.file(i)),t.options.upload.validate){const d=t.options.upload.validate(i);if(typeof d=="string"){M(d);return}}const s=t.wysiwyg.element,o=Cy(t,i);if(o.files.length===0){n&&(n.value="");return}const l=new FormData,r=t.options.upload.extraData;for(const d of Object.keys(r))l.append(d,r[d]);for(let d=0,u=o.files.length;d<u;d++)l.append(t.options.upload.fieldName,o.files[d]);l.append("id",t.block.rootID);const c=new XMLHttpRequest;c.open("POST",t.options.upload.url),t.options.upload.token&&c.setRequestHeader("X-Upload-Token",t.options.upload.token),t.options.upload.withCredentials&&(c.withCredentials=!0),t.upload.isUploading=!0,c.onreadystatechange=()=>{if(c.readyState===XMLHttpRequest.DONE){if(t.upload.isUploading=!1,!document.body.contains(t.element)){Np(t);return}if(c.status===200)if(W(o.msgId),t.options.upload.success)t.options.upload.success(s,c.responseText);else if(a)a(c.responseText);else{let d=c.responseText;t.options.upload.format&&(d=t.options.upload.format(e,c.responseText)),Hp(d,t)}else c.status===0?M(window.siyuan.languages.fileTypeError):t.options.upload.error?t.options.upload.error(c.responseText):M(c.responseText);n&&(n.value=""),t.upload.element.style.display="none"}},c.upload.onprogress=d=>{if(!d.lengthComputable)return;const u=d.loaded/d.total*100;t.upload.element.style.display="block";const f=t.upload.element;f.style.width=u+"%"},c.send(l)},Op=async(t,e)=>{try{let n=await ce();n=n.replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/_/g,"\\_").replace(/\[/g,"\\[").replace(/]/g,"\\]").replace(/!/g,"\\!").replace(/`/g,"\\`").replace(/</g,"\\<").replace(/>/g,"\\>").replace(/&/g,"\\&").replace(/~/g,"\\~").replace(/\{/g,"\\{").replace(/}/g,"\\}").replace(/\(/g,"\\(").replace(/\)/g,"\\)").replace(/=/g,"\\=").replace(/#/g,"\\#").replace(/\$/g,"\\$").replace(/\^/g,"\\^").replace(/\|/g,"\\|"),kd(t,n,e)}catch(n){console.log(n)}},go=(t,e)=>{let n=!0;t.options.hint.extend.find(a=>{if(a.key===e)return n=!1,!0}),n&&t.hint.render(t)},Ed=async t=>{let e=[];if(window.siyuan.config.system.os==="darwin"){const n=te.clipboard.read("NSFilenamesPboardType"),i=new DOMParser().parseFromString(n,"application/xml");Array.from(i.getElementsByTagName("string")).forEach(s=>{e.push(s.childNodes[0].nodeValue)})}else{const n=await lt("/api/clipboard/readFilePaths",{});n.data.length>0&&(e=n.data)}e.length>0&&(po(e,t,!1),G("")),e.length===0&&navigator.clipboard.readText().then(n=>{wt(t.lute.BlockDOM2EscapeMarkerContent(t.lute.Md2BlockDOM(n)),t),go(t,n)})},kd=(t,e,n)=>{const a=re(t.wysiwyg.element);if(n.getAttribute("data-type")==="NodeCodeBlock"){wt(e,t);return}a.toString()!==""&&((0,I.Y$)(e)?e=e.replace(/'.+'\)\)$/,` "${a.toString()}"))`):(0,I.rJ)(e)?e=e.replace(/".+">>$/,`"${a.toString()}">>`):t.lute.IsValidLinkDest(e)&&(e=`[${a.toString()}](${e})`)),wt(t.lute.Md2BlockDOM(e),t),Be(t,t.wysiwyg.element),bt(t.wysiwyg.element),qe(t.wysiwyg.element),mt(t.wysiwyg.element,t),go(t,e),He(t,void 0,!1,"smooth")},Rp=async(t,e)=>{e.stopPropagation(),e.preventDefault();let n,a,i,s;if("clipboardData"in e?(n=e.clipboardData.getData("text/html"),a=e.clipboardData.getData("text/plain"),i=e.clipboardData.getData("text/siyuan"),s=e.clipboardData.files):(n=e.dataTransfer.getData("text/html"),a=e.dataTransfer.getData("text/plain"),i=e.dataTransfer.getData("text/siyuan"),e.dataTransfer.types[0]==="Files"&&(s=e.dataTransfer.items)),!i&&!n&&!a&&"clipboardData"in e)if(window.siyuan.config.system.os==="darwin"){const c=te.clipboard.read("NSFilenamesPboardType"),u=new DOMParser().parseFromString(c,"application/xml"),f=[];if(Array.from(u.getElementsByTagName("string")).forEach(g=>{f.push(g.childNodes[0].nodeValue)}),f.length>0){po(f,t,!0),G("");return}}else{const c=await lt("/api/clipboard/readFilePaths",{});if(c.data.length>0){po(c.data,t,!0),G("");return}}if((n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<a href="${a}">${a}</a>`||n.replace(/&amp;/g,"&").replace(/<(|\/)(html|body|meta)[^>]*?>/ig,"").trim()===`<!--StartFragment--><a href="${a}">${a}</a><!--EndFragment-->`)&&(n=""),a.endsWith(p.Constants.ZWSP)&&!n&&!i&&(i=a.substr(0,a.length-1)),!i){const c=new DOMParser().parseFromString(n,"text/html");c.body&&c.body.innerHTML&&(n=c.body.innerHTML),n.startsWith(`
<!--StartFragment-->`)&&n.endsWith(`<!--EndFragment-->

`)&&(n=c.body.innerHTML.trim().replace("<!--StartFragment-->","").replace("<!--EndFragment-->","")),n=Lute.Sanitize(n)}if(t&&t.app&&t.app.plugins)for(let c=0;c<t.app.plugins.length;c++){const d=await new Promise(u=>{t.app.plugins[c].eventBus.emit("paste",{protyle:t,resolve:u,textHTML:n,textPlain:a,siyuanHTML:i,files:s})&&u(void 0)});d?.textHTML&&(n=d.textHTML),d?.textPlain&&(a=d.textPlain),d?.siyuanHTML&&(i=d.siyuanHTML),d?.files&&(s=d.files)}const o=x(e.target);if(!o){s&&s.length>0&&ka(t,s);return}X(["select"],t),t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(c=>{c.classList.remove("protyle-wysiwyg--hl")});const l=Zw(n,a),r=re(t.wysiwyg.element);if(o.getAttribute("data-type")==="NodeCodeBlock"||t.toolbar.getCurrentType(r).includes("code")){o.querySelector(".protyle-action")?.contains(r.startContainer)&&r.setStart(o.querySelector(".hljs").firstChild,0),wt(a,t);return}else if(i){const c=document.createElement("div");c.innerHTML=i;let d=!1;c.querySelectorAll("[data-node-id]").forEach(f=>{const g=Lute.NewNodeID();f.setAttribute("data-node-id",g),f.removeAttribute(p.Constants.CUSTOM_RIFF_DECKS),f.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),f.setAttribute("updated",g.split("-")[0]),d=!0}),o.classList.contains("table")&&(d=!1),c.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(f=>{f.setAttribute("contenteditable","true")});const u=c.innerHTML;wt(u,t,d),go(t,t.lute.BlockDOM2StdMd(u)),Be(t,t.wysiwyg.element),bt(t.wysiwyg.element),qe(t.wysiwyg.element),mt(t.wysiwyg.element,t)}else if(l)l.startsWith('<div data-type="NodeCodeBlock" class="code-block" data-node-id="')?(wt(l,t,!0),qe(t.wysiwyg.element)):wt(l,t),X(["hint"],t);else{let c=!1;if(n.replace("<!--StartFragment--><!--EndFragment-->","").trim()!==""&&(n=n.replace("<!--StartFragment-->","").replace("<!--EndFragment-->","").trim(),s&&s.length===1&&(n.startsWith("<img")||n.startsWith("<table")&&n.indexOf("<img")>-1)?c=!1:c=!0),c){const d=document.createElement("div");d.innerHTML=n,d.querySelectorAll("[style]").forEach(u=>{u.removeAttribute("style")}),d.querySelectorAll("a").forEach(u=>{u.innerHTML.trim()===""&&u.remove()}),w("/api/lute/html2BlockDOM",{dom:d.innerHTML},u=>{wt(u.data,t),t.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(f=>{f.textContent===""&&w("/api/block/getRefText",{id:f.getAttribute("data-id")},g=>{f.innerHTML=g.data})}),Be(t,t.wysiwyg.element),bt(t.wysiwyg.element),qe(t.wysiwyg.element),mt(t.wysiwyg.element,t),go(t,u.data),He(t,void 0,!1,"smooth")});return}else if(s&&s.length>0)ka(t,s);else if(a.trim()!==""&&s&&s.length===0){if(r.toString()!==""){const u=a.split(`
`)[0];if((0,I.Y$)(a)){t.toolbar.setInlineMark(t,"block-ref","range",{type:"id",color:`${a.substring(2,22+2)}${p.Constants.ZWSP}s${p.Constants.ZWSP}${r.toString()}`});return}else if((0,I.rJ)(u)){t.toolbar.setInlineMark(t,"file-annotation-ref","range",{type:"file-annotation-ref",color:u.substring(2).replace(/ ".+">>$/,"")});return}else if(t.lute.IsValidLinkDest(a)){t.toolbar.setInlineMark(t,"a","range",{type:"a",color:a});return}}const d=t.lute.Md2BlockDOM(a);wt(d,t),go(t,a)}Be(t,t.wysiwyg.element),bt(t.wysiwyg.element),qe(t.wysiwyg.element),mt(t.wysiwyg.element,t)}He(t,void 0,!1,"smooth")},cs=(t,e=!1)=>{if(!t.wysiwyg.element.firstElementChild||window.siyuan.config.readonly)return;const n={rootId:t.block.rootID,startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),scrollTop:t.contentElement.scrollTop||parseInt(t.contentElement.getAttribute("data-scrolltop"))||0};let a;if(getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0)),(!a||!t.wysiwyg.element.contains(a.startContainer))&&(a=t.toolbar.range),a&&t.wysiwyg.element.contains(a.startContainer)){const i=x(a.startContainer);if(i){const s=yt(i,void 0,a);n.focusId=i.getAttribute("data-node-id"),n.focusStart=s.start,n.focusEnd=s.end}}if(t.block.showAll&&(n.zoomInId=t.block.id),e)return n;window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION][t.block.rootID]=n,pe(p.Constants.LOCAL_FILEPOSITION,window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION])},Sd=t=>{let e=[];if(t.mergedOptions?e=t.mergedOptions.action:t.focus?e=[p.Constants.CB_GET_UNUNDO,p.Constants.CB_GET_FOCUS]:e=[p.Constants.CB_GET_UNUNDO],t.scrollAttr.zoomInId){w("/api/filetree/getDoc",{id:t.scrollAttr.zoomInId,size:p.Constants.SIZE_GET_MAX},n=>{e.push(p.Constants.CB_GET_ALL),st({data:n,protyle:t.protyle,action:e,scrollAttr:t.scrollAttr,afterCB:t.cb})});return}w("/api/filetree/getDoc",{id:t.scrollAttr.rootId||t.mergedOptions?.blockId||t.protyle.block?.rootID||t.scrollAttr.startId,startID:t.scrollAttr.startId,endID:t.scrollAttr.endId},n=>{st({data:n,protyle:t.protyle,action:e,scrollAttr:t.scrollAttr,afterCB:t.cb})})},na=(t,e)=>{if(!t.preview.element.classList.contains("fn__none")){t.preview.render(t);return}if(window.siyuan.config.editor.displayBookmarkIcon?t.wysiwyg.element.classList.add("protyle-wysiwyg--attr"):t.wysiwyg.element.classList.remove("protyle-wysiwyg--attr"),t.title&&(t.title.element.setAttribute("spellcheck",window.siyuan.config.editor.spellcheck.toString()),window.siyuan.config.editor.displayBookmarkIcon?t.title.element.classList.add("protyle-wysiwyg--attr"):t.title.element.classList.remove("protyle-wysiwyg--attr")),t.lute.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),t.lute.SetSpellcheck(window.siyuan.config.editor.spellcheck),$i(t),t.options.backlinkData){const n=t.element.getAttribute("data-ismention")==="true",a=A(t.element,"sy__backlink");if(a){const i=a.querySelectorAll(".b3-form__icon-input");w(n?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:t.element.getAttribute("data-defid"),refTreeID:t.block.rootID,keyword:n?i[1].value:i[0].value},s=>{t.options.backlinkData=n?s.data.backmentions:s.data.backlinks,Dg(t,t.options.backlinkData)})}}else ln(t),Sd({protyle:t,focus:e,scrollAttr:cs(t,!0)})},xy=(t,e)=>{const n=new me({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconMath"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.math}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="mathBlock" type="checkbox"${t.types.mathBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconTable"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.table}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="table" type="checkbox"${t.types.table?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconQuote"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.quote}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="blockquote" type="checkbox"${t.types.blockquote?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSuper"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.superBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="superBlock" type="checkbox"${t.types.superBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconParagraph"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.paragraph}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="paragraph" type="checkbox"${t.types.paragraph?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconFile"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.doc}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="document" type="checkbox"${t.types.document?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHeadings"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.headings}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="heading" type="checkbox"${t.types.heading?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconList"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.list1}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="list" type="checkbox"${t.types.list?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconListItem"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.listItem}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="listItem" type="checkbox"${t.types.listItem?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconCode"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.code}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="codeBlock" type="checkbox"${t.types.codeBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconHTML5"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            HTML
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="htmlBlock" type="checkbox"${t.types.htmlBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconSQL"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.embedBlock}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="embedBlock" type="checkbox"${t.types.embedBlock?" checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <svg class="ft__on-surface svg fn__flex-center"><use xlink:href="#iconDatabase"></use></svg>
        <span class="fn__space"></span>
        <div class="fn__flex-1 fn__flex-center">
            ${window.siyuan.languages.database}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="databaseBlock" type="checkbox"${t.types.databaseBlock?" checked":""}>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px",height:"70vh"}),a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{t.types[i.getAttribute("data-type")]=i.checked}),e(),n.destroy()})},Ay=t=>{let e="";Object.keys(p.Constants.SIYUAN_DEFAULT_REPLACETYPES).forEach(i=>{e+=`<label class="fn__flex b3-label">
    <span class="fn__space"></span>
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.replaceTypes[i]}
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" data-type="${i}" type="checkbox"${t.replaceTypes[i]?" checked":""}>
</label>`});const n=new me({title:window.siyuan.languages.replaceType,content:`<div class="b3-dialog__content">${e}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px",height:"70vh"}),a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{t.replaceTypes[i.getAttribute("data-type")]=i.checked}),n.destroy()})},Ty=(t,e)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMethod"),window.siyuan.menus.menu.append(new S({iconHTML:"",label:window.siyuan.languages.keyword,current:t.method===0,click(){t.method=0,e()}}).element),window.siyuan.menus.menu.append(new S({iconHTML:"",label:window.siyuan.languages.querySyntax,current:t.method===1,click(){t.method=1,e()}}).element),window.siyuan.menus.menu.append(new S({iconHTML:"",label:"SQL",current:t.method===2,click(){t.method=2,e()}}).element),window.siyuan.menus.menu.append(new S({iconHTML:"",label:window.siyuan.languages.regex,current:t.method===3,click(){t.method=3,e()}}).element)},Zl=(t,e,n,a,i)=>{t.removed=!1;const s=t;s.name=a,e.push(Object.assign({},s)),window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]=Object.assign({},t),pe(p.Constants.LOCAL_SEARCHDATA,window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]),w("/api/storage/setCriterion",{criterion:s},()=>{i.destroy();const o=n.querySelector("#criteria").firstElementChild;o.classList.remove("fn__none"),o.querySelector(".b3-chip--current")?.classList.remove("b3-chip--current"),o.insertAdjacentHTML("beforeend",`<div data-type="set-criteria" class="b3-chip b3-chip--current b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][o.childElementCount%7]}">${s.name}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`)})},Bp=(t,e,n)=>{const a=new me({title:window.siyuan.languages.saveCriterion,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),i=a.element.querySelectorAll(".b3-button");a.bindInput(a.element.querySelector("input"),()=>{i[1].dispatchEvent(new CustomEvent("click"))}),i[0].addEventListener("click",()=>{a.destroy()}),i[1].addEventListener("click",()=>{const s=a.element.querySelector("input").value.trim();if(!s){M(window.siyuan.languages._kernel[142]);return}(0,I.tq)()?(t.k=document.querySelector("#toolbarSearch").value,t.r=n.querySelector("#toolbarReplace").value):(t.k=n.querySelector("#searchInput").value,t.r=n.querySelector("#replaceInput").value);const o=n.querySelector("#criteria").firstElementChild;let l="",r="";if(e.forEach(c=>{c.name===s&&(l=c.name),qp(c,t)&&(r=c.name)}),l&&!r)Ne(window.siyuan.languages.confirm,window.siyuan.languages.searchOverwrite,()=>{Array.from(o.children).forEach(c=>{c.textContent===s&&c.remove()}),e.find((c,d)=>{if(c.name===s)return e.splice(d,1),!0}),Zl(t,e,n,s,a)});else if(l&&r)if(l===r)a.destroy();else{const c=l===s?r:l;Ne(window.siyuan.languages.confirm,window.siyuan.languages.searchRemoveName.replace("${x}",c).replace("${y}",s),()=>{Array.from(o.children).forEach(d=>{(d.textContent===r||d.textContent===l)&&d.remove()}),e.find((d,u)=>{if(d.name===c||d.name===l)return w("/api/storage/removeCriterion",{name:c}),e.splice(u,1),!0}),Zl(t,e,n,s,a)})}else!l&&r?Ne(window.siyuan.languages.confirm,window.siyuan.languages.searchUpdateName.replace("${x}",r).replace("${y}",s),()=>{Array.from(o.children).forEach(c=>{c.textContent===r&&c.remove()}),e.find((c,d)=>{if(c.name===r)return w("/api/storage/removeCriterion",{name:r}),e.splice(d,1),!0}),Zl(t,e,n,s,a)}):Zl(t,e,n,s,a)})},Iy=async(t,e,n,a,i,s)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchMore");const o=[{iconHTML:"",label:window.siyuan.languages.type,current:t.sort===0,click(){t.sort=0,a()}},{iconHTML:"",label:window.siyuan.languages.createdASC,current:t.sort===1,click(){t.sort=1,a()}},{iconHTML:"",label:window.siyuan.languages.createdDESC,current:t.sort===2,click(){t.sort=2,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedASC,current:t.sort===3,click(){t.sort=3,a()}},{iconHTML:"",label:window.siyuan.languages.modifiedDESC,current:t.sort===4,click(){t.sort=4,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankAsc,current:t.sort===6,click(){t.sort=6,a()}},{iconHTML:"",label:window.siyuan.languages.sortByRankDesc,current:t.sort===7,click(){t.sort=7,a()}}];t.group===1&&o.push({iconHTML:"",label:window.siyuan.languages.sortByContent,current:t.sort===5,click(){t.sort=5,a()}}),window.siyuan.menus.menu.append(new S({iconHTML:"",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element),window.siyuan.menus.menu.append(new S({iconHTML:"",label:window.siyuan.languages.group,type:"submenu",submenu:[{iconHTML:"",label:window.siyuan.languages.noGroupBy,current:t.group===0,click(){(0,I.tq)()?(n.querySelector('[data-type="expand"]').classList.add("fn__none"),n.querySelector('[data-type="contract"]').classList.add("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.add("fn__none"),t.group=0,t.sort===5&&(t.sort=0),a()}},{iconHTML:"",label:window.siyuan.languages.groupByDoc,current:t.group===1,click(){(0,I.tq)()?(n.querySelector('[data-type="expand"]').classList.remove("fn__none"),n.querySelector('[data-type="contract"]').classList.remove("fn__none")):n.querySelector("#searchCollapse").parentElement.classList.remove("fn__none"),t.group=1,a()}}]}).element),s&&s(),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.saveCriterion,iconHTML:"",click(){Bp(t,e,n)}}).element),window.siyuan.menus.menu.append(new S({iconHTML:"",label:window.siyuan.languages.removeCriterion,click(){i()}}).element)},qp=(t,e)=>!!(e.group===t.group&&e.hPath===t.hPath&&e.hasReplace===t.hasReplace&&e.k===t.k&&e.method===t.method&&e.r===t.r&&e.sort===t.sort&&(0,I.MK)(e.types,t.types)&&(0,I.MK)(e.replaceTypes,t.replaceTypes)&&(0,I.MK)(e.idPath,t.idPath)),Dy=(t,e,n)=>{w("/api/storage/getCriteria",{},a=>{let i="";a.data.forEach((s,o)=>{e.push(s);let l=!1;qp(s,n)&&(l=!0),i+=`<div data-type="set-criteria" class="${l?"b3-chip--current ":""}b3-chip b3-chip--middle b3-chip--pointer b3-chip--${["secondary","primary","info","success","warning","error",""][o%7]}">${we(s.name)}<svg class="b3-chip__close" data-type="remove-criteria"><use xlink:href="#iconCloseRound"></use></svg></div>`}),t.innerHTML=`<div class="b3-chips">
    ${i}
</div>
<span class="fn__flex-1"></span>
<button data-type="saveCriterion" class="b3-button b3-button--small b3-button--outline fn__flex-center">${window.siyuan.languages.saveCriterion}</button>
<span class="fn__space"></span>
<button data-type="removeCriterion" aria-label="${window.siyuan.languages.useCriterion}" class="ariaLabel b3-button b3-button--small b3-button--outline fn__flex-center fn__flex-shrink" data-position="9bottom">${window.siyuan.languages.removeCriterion}</button>
<span class="fn__space"></span>`})},$y=t=>{const e=[];return t.querySelectorAll("mark").forEach(n=>{e.push(n.textContent)}),[...new Set(e)].join(" ")},Ld=(t,e,n)=>{t.value===""?(e.classList.add("fn__none"),n&&(t.style.paddingRight="")):(e.classList.remove("fn__none"),n&&t.style.setProperty("padding-right",`${n*2+e.clientWidth}px`,"important"))},Cd=t=>{t.inputElement.insertAdjacentHTML("afterend",`<svg class="${t.className||"b3-form__icon-clear"} ariaLabel" aria-label="${window.siyuan.languages.clear}" style="${t.right?"right: "+t.right+"px;":""}${t.height?"height:"+t.height+"px":""}">
<use xlink:href="#iconCloseRound"></use></svg>`);const e=t.inputElement.nextElementSibling;e.addEventListener("click",()=>{t.inputElement.value="",t.inputElement.focus(),Ld(t.inputElement,e,t.right),t.clearCB&&t.clearCB()}),t.inputElement.addEventListener("input",()=>{Ld(t.inputElement,e,t.right)}),Ld(t.inputElement,e,t.right)},Py=(t,e)=>{if(window.siyuan.menus.menu.remove(),t.previousElementSibling.classList.add("fn__none"),t.classList.remove("fn__none"),t.innerHTML){t.querySelector("#searchAssetInput").select();return}const n=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET];t.nextElementSibling.classList.remove("fn__none");let i="";if(i=`<kbd>Enter/Double Click</kbd> ${window.siyuan.languages.showInFolder}`,t.innerHTML=`<div class="block__icons">
    <span data-type="assetPrevious" class="block__icon block__icon--show ariaLabel" data-position="9bottom" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="assetNext" class="block__icon block__icon--show ariaLabel" data-position="9bottom" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
    <span class="fn__space"></span>
    <span id="searchAssetResult" class="ft__selectnone"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span id="assetMore" aria-label="${window.siyuan.languages.more}" class="block__icon block__icon--show ariaLabel" data-position="9bottom">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span id="searchAssetClose" aria-label="${e?window.siyuan.languages.stickSearch:window.siyuan.languages.globalSearch}" class="block__icon block__icon--show ariaLabel" data-position="9bottom">
        <svg><use xlink:href="#iconBack"></use></svg>
    </span>
</div>
<div class="b3-form__icon search__header">
    <div class="fn__flex-1" style="position: relative">
        <span class="search__history-icon ariaLabel" id="assetHistoryBtn" aria-label="${K("\u2325\u2193")}">
            <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
            <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
        </span>
        <input id="searchAssetInput" value="${n.k}" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.keyword}">
    </div>
    <div class="block__icons">
        <span data-type="assetRefresh" aria-label="${window.siyuan.languages.refresh}" class="block__icon ariaLabel" data-position="9bottom">
            <svg><use xlink:href="#iconRefresh"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="assetSyntaxCheck" aria-label="${Xl(n.method)}" class="block__icon ariaLabel" data-position="9bottom">
            <svg><use xlink:href="#iconRegex"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="assetFilter" aria-label="${window.siyuan.languages.type}" class="block__icon ariaLabel" data-position="9bottom">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </span>
    </div>
</div>
<div class="search__layout${n.layout===1?" search__layout--row":""}">
    <div id="searchAssetList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
    <div class="search__drag"></div>
    <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px"></div>
</div>
<div class="search__tip${e?" fn__none":""}">
    <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
    ${i}
    <kbd>Click</kbd> ${window.siyuan.languages.searchTip3}
    <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
</div>`,t.querySelector("#searchAssetList").innerHTML!=="")return;const s=t.querySelector("#searchAssetPreview");n.layout===1?n.col&&(s.style.width=n.col,s.classList.remove("fn__flex-1")):n.row&&(s.classList.remove("fn__flex-1"),s.style.height=n.row);const o=t.querySelector("#searchAssetInput");o.select(),o.addEventListener("compositionend",r=>{r.isComposing||dn(t,n)}),o.addEventListener("input",r=>{r.isComposing||dn(t,n)}),o.addEventListener("blur",()=>{if(!o.value)return;let r=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].keys;r.splice(0,0,o.value),r=Array.from(new Set(r)),r.length>window.siyuan.config.search.limit&&r.splice(window.siyuan.config.search.limit,r.length-window.siyuan.config.search.limit),window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].k=o.value,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].keys=r,pe(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET])}),dn(t,n),Cd({right:8,height:o.clientHeight,inputElement:o,clearCB(){dn(t,n)}});const l=t.querySelector(".search__drag");l.addEventListener("mousedown",r=>{const c=document,d=l.nextElementSibling,u=l.previousElementSibling,f=n.layout===1?"lr":"tb",g=r[f==="lr"?"clientX":"clientY"],h=f==="lr"?u.clientWidth:u.clientHeight,m=f==="lr"?d.clientWidth:d.clientHeight;d.classList.remove("fn__flex-1"),d.style[f==="lr"?"width":"height"]=m+"px",c.onmousemove=b=>{b.preventDefault(),b.stopPropagation();const y=h+(b[f==="lr"?"clientX":"clientY"]-g),_=m-(b[f==="lr"?"clientX":"clientY"]-g);y<120||_<120||(d.style[f==="lr"?"width":"height"]=_+"px")},c.onmouseup=()=>{c.onmousemove=null,c.onmouseup=null,c.ondragstart=null,c.onselectstart=null,c.onselect=null,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET][f==="lr"?"col":"row"]=d[f==="lr"?"clientWidth":"clientHeight"]+"px",pe(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET])}})};let Fp;const dn=(t,e,n=1)=>{if(!Ea()){t.nextElementSibling.classList.add("fn__none"),t.querySelector(".search__drag")?.classList.add("fn__none"),t.querySelector("#searchAssetPreview").classList.add("fn__none"),t.querySelector("#searchAssetList").innerHTML=`<div class="search__empty">
    ${window.siyuan.languages._kernel[214]}
</div>`;return}t.nextElementSibling.classList.remove("fn__none"),clearTimeout(Fp),Fp=window.setTimeout(()=>{e||(e=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET]);const a=t.querySelector('[data-type="assetPrevious"]');n>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const i=t.querySelector("#searchAssetInput");w("/api/search/fullTextSearchAssetContent",{page:n,query:i.value,types:e.types,method:e.method,orderBy:e.sort},s=>{t.nextElementSibling.classList.add("fn__none");const o=t.querySelector('[data-type="assetNext"]');n<s.data.pageCount?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled");let l="";s.data.assetContents.forEach((c,d)=>{l+=`<div data-type="search-item" class="b3-list-item${d===0?" b3-list-item--focus":""}" data-id="${c.id}">
<span class="ft__on-surface">${c.ext}</span>
<span class="fn__space"></span>
<span class="b3-list-item__text">${c.content}</span>
<span class="b3-list-item__meta">${c.hSize}</span>
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${qa(c.path)}">${c.name}</span>
</div>`});const r=t.querySelector("#searchAssetPreview");s.data.assetContents.length>0?(r.classList.remove("fn__none"),t.querySelector(".search__drag")?.classList.remove("fn__none"),Jl(r,s.data.assetContents[0].id,i.value,e.method)):(r.classList.add("fn__none"),t.querySelector(".search__drag")?.classList.add("fn__none")),t.querySelector("#searchAssetResult").innerHTML=`<span class="fn__flex-center">${n}/${s.data.pageCount||1}</span><span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.total} ${s.data.matchedAssetCount}</span>`,t.querySelector("#searchAssetList").innerHTML=l||`<div class="search__empty">
    ${window.siyuan.languages.emptyContent}
</div>`})},p.Constants.TIMEOUT_INPUT)},Up=t=>{const e=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].keys;if(!e||e.length===0)return;const n=new At("search-asset-history");if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].keys=[],pe(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET])}});const a=n.addSeparator(1);let i=!0;const s=t.querySelector("#searchAssetInput");e.forEach(l=>{if(l!==s.value&&l){const r=n.addItem({iconHTML:"",label:we(l),action:"iconCloseRound",bind(c){c.addEventListener("click",d=>{A(d.target,"b3-menu__action")?(e.find((u,f)=>{if(u===l)return e.splice(f,1),!0}),window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].keys=e,pe(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET]),c.previousElementSibling?.classList.contains("b3-menu__separator")&&!c.nextElementSibling?window.siyuan.menus.menu.remove():c.remove()):(s.value=c.textContent,dn(t),window.siyuan.menus.menu.remove()),d.preventDefault(),d.stopPropagation()})}});i&&r.classList.add("b3-menu__item--current"),i=!1}}),i&&a.remove();const o=s.getBoundingClientRect();n.open({x:o.left,y:o.bottom})},Jl=(t,e,n,a)=>{w("/api/search/getAssetContent",{id:e,query:n,queryMethod:a},i=>{t.innerHTML=`<p style="white-space: pre-wrap;">${i.data.assetContent.content}</p>`;const s=t.querySelector("mark");if(s){s.classList.add("mark--hl");const o=t.getBoundingClientRect();t.scrollTop=t.scrollTop+s.getBoundingClientRect().top-o.top-o.height/2}})},My=t=>{let e;const n=Array.from(t.querySelectorAll("mark"));if(n.find((a,i)=>{if(a.classList.contains("mark--hl")){a.classList.remove("mark--hl"),e=n[i+1];return}}),e||(e=n[0]),e){e.classList.add("mark--hl");const a=t.getBoundingClientRect();t.scrollTop=t.scrollTop+e.getBoundingClientRect().top-a.top-a.height/2}},Ny=(t,e)=>{const n=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method;if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMethod"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMethod"),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.keyword,current:n===0,click(){window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method=0,e()}}).element),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.querySyntax,current:n===1,click(){window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method=1,e()}}).element),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.regex,current:n===3,click(){window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method=3,e()}}).element);const a=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:a.right,y:a.bottom,isLeft:!0})},Hy=t=>{let e="";return p.Constants.SIYUAN_ASSETS_SEARCH.sort((n,a)=>n.localeCompare(a)).forEach(n=>{e+=`<label class="fn__flex b3-label">
        <div class="fn__flex-1 fn__flex-center">
            ${n}
        </div>
        <span class="fn__space"></span>
        <input class="b3-switch fn__flex-center" data-type="${n}" type="checkbox" ${t[n]?" checked":""}>
    </label>`}),e},Oy=t=>{const e=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].types,n=new me({title:window.siyuan.languages.type,content:`<div class="b3-dialog__content">${Hy(e)}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px",height:"70vh"}),a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{n.element.querySelectorAll(".b3-switch").forEach(i=>{e[i.getAttribute("data-type")]=i.checked}),dn(t),pe(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET]),n.destroy()})},Ry=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="searchAssetMore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","searchAssetMore");const a=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET],i=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.sortByRankAsc,current:a.sort===1,click(){a.sort=1,n()}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.sortByRankDesc,current:a.sort===0,click(){a.sort=0,n()}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.modifiedASC,current:a.sort===3,click(){a.sort=3,n()}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.modifiedDESC,current:a.sort===2,click(){a.sort=2,n()}}];window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.sort,type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.topBottomLayout,current:a.layout===0,click(){e.querySelector(".search__layout").classList.remove("search__layout--row");const o=e.querySelector("#searchAssetPreview");o.style.width="",a.row?(o.style.height=a.row,o.classList.remove("fn__flex-1")):o.classList.add("fn__flex-1"),a.layout=0,pe(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET])}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.leftRightLayout,current:a.layout===1,click(){const o=e.querySelector("#searchAssetPreview");e.querySelector(".search__layout").classList.add("search__layout--row"),o.style.height="",a.col?(o.style.width=a.col,o.classList.remove("fn__flex-1")):o.classList.add("fn__flex-1"),a.layout=1,pe(p.Constants.LOCAL_SEARCHASSET,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET])}}]}).element),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.rebuildIndex,click(){if(!Ea()){M(window.siyuan.languages._kernel[214]);return}e.nextElementSibling.classList.remove("fn__none"),w("/api/asset/fullReindexAssetContent",{},()=>{dn(e,a)})}}).element);const s=t.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.right,y:s.bottom,isLeft:!0})},Wp=t=>{const e=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS];if(!e.replaceKeys||e.replaceKeys.length===0)return;const n=new At("search-replace-history");if(n.isOpen)return;n.element.classList.add("b3-menu--list"),n.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS].replaceKeys=[],pe(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS])}});const a=n.addSeparator(1);let i=!0;const s=t.querySelector("#replaceInput");e.replaceKeys.forEach(l=>{if(l!==s.value&&l){const r=n.addItem({iconHTML:"",label:we(l),action:"iconCloseRound",bind(c){c.addEventListener("click",d=>{A(d.target,"b3-menu__action")?(e.replaceKeys.find((u,f)=>{if(u===l)return e.replaceKeys.splice(f,1),!0}),window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS].replaceKeys=e.replaceKeys,pe(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS]),c.previousElementSibling?.classList.contains("b3-menu__separator")&&!c.nextElementSibling?window.siyuan.menus.menu.remove():c.remove()):(s.value=c.textContent,window.siyuan.menus.menu.remove()),d.preventDefault(),d.stopPropagation()})}});i&&r.classList.add("b3-menu__item--current"),i=!1}}),i&&a.remove();const o=s.getBoundingClientRect();n.open({x:o.left,y:o.bottom})},Vp=(t,e,n)=>{const a=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS];if(!a.keys||a.keys.length===0)return;const i=new At("search-history");if(i.isOpen)return;i.element.classList.add("b3-menu--list"),i.addItem({iconHTML:"",label:window.siyuan.languages.clearHistory,click(){window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS].keys=[],pe(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS])}});const s=i.addSeparator(1);let o=!0;const l=t.querySelector("#searchInput");a.keys.forEach(c=>{if(c!==l.value&&c){const d=i.addItem({iconHTML:"",label:we(c),action:"iconCloseRound",bind(u){u.addEventListener("click",f=>{A(f.target,"b3-menu__action")?(a.keys.find((g,h)=>{if(g===c)return a.keys.splice(h,1),!0}),window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS].keys=a.keys,pe(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS]),u.previousElementSibling?.classList.contains("b3-menu__separator")&&!u.nextElementSibling?window.siyuan.menus.menu.remove():u.remove()):(l.value=u.textContent,e.page=1,Wt(t,e,n,!0),window.siyuan.menus.menu.remove()),f.preventDefault(),f.stopPropagation()})}});o&&d.classList.add("b3-menu__item--current"),o=!1}}),o&&s.remove();const r=l.getBoundingClientRect();i.open({x:r.left,y:r.bottom})},zp=(t,e)=>{let n=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS][t];n.splice(0,0,e),n=Array.from(new Set(n)),n.length>window.siyuan.config.search.limit&&n.splice(window.siyuan.config.search.limit,n.length-window.siyuan.config.search.limit),window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS][t]=n,pe(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS])},Fn=(t,e,n)=>{if(e=e.trim(),Pe().search.find(s=>(s.parent.parent.switchTab(s.parent.headElement),s.updateSearch(e,n),!0)))return;const i=window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA];Dn({app:t,searchData:{k:e,r:"",hasReplace:!1,method:i.method,hPath:"",idPath:[],group:i.group,sort:i.sort,types:Object.assign({},i.types),replaceTypes:Object.assign({},i.replaceTypes),removed:i.removed,page:1},position:window.siyuan.layout.centerLayout.children.length>1||window.innerWidth>1024?"right":void 0})},Yp=(t,e,n,a)=>{let i=window.siyuan.languages.keyword;e.method===1?i=window.siyuan.languages.querySyntax:e.method===2?i="SQL":e.method===3&&(i=window.siyuan.languages.regex);let s=!0,o=!1;e.idPath.forEach(_=>{_.endsWith(".sy")&&(s=!1),_.split("/").length>1&&(o=!0)});const l=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS];n.innerHTML=`<div class="fn__flex-column" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}">
    <div class="block__icons" style="overflow: auto">
        <span data-position="9bottom" data-type="previous" class="block__icon block__icon--show ariaLabel" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-position="9bottom" data-type="next" class="block__icon block__icon--show ariaLabel" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span id="searchResult" class="fn__flex-shrink ft__selectnone"></span>
        <span class="fn__space"></span>
        <span class="fn__flex-1${a?" resize__move":""}" style="min-height: 100%"></span>
        <span id="searchPathInput" data-position="9bottom" class="search__path ft__on-surface fn__flex-center ft__smaller fn__ellipsis ariaLabel" aria-label="${qa(e.hPath)}">
            ${we(e.hPath)}
            <svg class="search__rmpath${e.hPath?"":" fn__none"}"><use xlink:href="#iconCloseRound"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-position="9bottom" id="searchInclude" ${o?"":"disabled"} aria-label="${window.siyuan.languages.includeChildDoc}" class="block__icon block__icon--show ariaLabel">
            <svg${s?' class="ft__primary"':""}><use xlink:href="#iconCopy"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchPath" aria-label="${window.siyuan.languages.specifyPath}" class="block__icon block__icon--show ariaLabel" data-position="9bottom">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchMore" aria-label="${window.siyuan.languages.more}" class="block__icon block__icon--show ariaLabel" data-position="9bottom">
            <svg><use xlink:href="#iconMore"></use></svg>
        </span>
        <span class="${a?"":"fn__none "}fn__space"></span>
        <span id="searchOpen" aria-label="${window.siyuan.languages.openInNewTab}" class="${a?"":"fn__none "}block__icon block__icon--show ariaLabel" data-position="9bottom">
            <svg><use xlink:href="#iconLayoutRight"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span id="searchAsset" aria-label="${window.siyuan.languages.searchAssetContent}" class="block__icon block__icon--show ariaLabel" data-position="9bottom">
            <svg><use xlink:href="#iconExact"></use></svg>
        </span>
    </div>
    <div class="b3-form__icon search__header">
        <div style="position: relative" class="fn__flex-1">
             <span class="search__history-icon ariaLabel" id="searchHistoryBtn" aria-label="${K("\u2325\u2193")}">
                <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="searchInput" class="b3-text-field b3-text-field--text" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}">
        </div>
        <div class="block__icons">
            <span id="searchRefresh" aria-label="${window.siyuan.languages.refresh}" class="block__icon ariaLabel" data-position="9bottom">
                <svg><use xlink:href="#iconRefresh"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchReplace" aria-label="${window.siyuan.languages.replace}" class="block__icon ariaLabel" data-position="9bottom">
                <svg><use xlink:href="#iconReplace"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchSyntaxCheck" aria-label="${window.siyuan.languages.searchMethod} ${i}" class="block__icon ariaLabel" data-position="9bottom">
                <svg><use xlink:href="#iconRegex"></use></svg>
            </span>
            <span class="fn__space"></span>
            <span id="searchFilter" aria-label="${window.siyuan.languages.type}" class="block__icon ariaLabel" data-position="9bottom">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span> 
            <div class="fn__flex${e.group===0?" fn__none":""}">
                <span class="fn__space"></span>
                <span id="searchExpand" class="block__icon block__icon--show ariaLabel" data-position="9bottom" aria-label="${window.siyuan.languages.expand}">
                    <svg><use xlink:href="#iconExpand"></use></svg>
                </span>
                <span class="fn__space"></span>
                <span id="searchCollapse" class="block__icon block__icon--show ariaLabel" data-position="9bottom" aria-label="${window.siyuan.languages.collapse}">
                    <svg><use xlink:href="#iconContract"></use></svg>
                </span>
            </div>
        </div>
    </div>
    <div class="b3-form__icon search__header${e.hasReplace?"":" fn__none"}">
        <div class="fn__flex-1" style="position: relative">
            <span class="search__history-icon ariaLabel" id="replaceHistoryBtn" aria-label="${K("\u2325\u2193")}">
                <svg data-menu="true" class="b3-form__icon-icon"><use xlink:href="#iconReplace"></use></svg>
                <svg class="search__arrowdown"><use xlink:href="#iconDown"></use></svg>
            </span>
            <input id="replaceInput" class="b3-text-field b3-text-field--text">
        </div>
        <div class="fn__space"></div>
        <svg class="fn__rotate fn__none svg" style="padding: 0 8px;align-self: center;margin-right: 8px"><use xlink:href="#iconRefresh"></use></svg>
        <span id="replaceFilter" aria-label="${window.siyuan.languages.replaceType}" class="block__icon ariaLabel fn__flex-center" data-position="9bottom">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </span>
        <span class="fn__space"></span>
        <button id="replaceAllBtn" class="b3-button b3-button--small b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button id="replaceBtn" class="b3-button b3-button--small b3-button--outline fn__flex-center">\u21B5 ${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" class="search__header"></div>
    <div class="search__layout${(a?l.layout===1:l.layoutTab===1)?" search__layout--row":""}">
        <div id="searchList" class="fn__flex-1 search__list b3-list b3-list--background"></div>
        <div class="search__drag"></div>
        <div id="searchPreview" class="fn__flex-1 search__preview"></div>
    </div>
    <div class="search__tip${a?"":" fn__none"}">
        <kbd>\u2191/\u2193/PageUp/PageDown</kbd> ${window.siyuan.languages.searchTip1}
        <kbd>${K(window.siyuan.config.keymap.general.newFile.custom)}</kbd> ${window.siyuan.languages.new}
        <kbd>Enter/Double Click</kbd> ${window.siyuan.languages.searchTip2}
        <kbd>Click</kbd> ${window.siyuan.languages.searchTip3}
        <kbd>${K(window.siyuan.config.keymap.editor.general.insertRight.custom)}/${K("\u2325Click")}</kbd> ${window.siyuan.languages.searchTip4}
        <kbd>Esc</kbd> ${window.siyuan.languages.searchTip5}
    </div>
</div>
<div class="fn__flex-column fn__none" id="searchAssets" style="height: 100%;${a?"border-radius: var(--b3-border-radius-b);overflow: hidden;":""}"></div>
<div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>`;const r=[];Dy(n.querySelector("#criteria"),r,e);const c=n.querySelector("#searchList"),d=n.querySelector("#searchInput"),u=n.querySelector("#replaceInput"),f=new pn(t,n.querySelector("#searchPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}});a?l.layout===1?l.col&&(f.protyle.element.style.width=l.col,f.protyle.element.classList.remove("fn__flex-1")):l.row&&(f.protyle.element.classList.remove("fn__flex-1"),f.protyle.element.style.height=l.row):l.layoutTab===1?l.colTab&&(f.protyle.element.style.width=l.colTab,f.protyle.element.classList.remove("fn__flex-1")):l.rowTab&&(f.protyle.element.classList.remove("fn__flex-1"),f.protyle.element.style.height=l.rowTab);let g,h=new Date().getTime();d.value=e.k||"",u.value=e.r||"",d.select();const m=n.querySelector(".search__drag");m.addEventListener("mousedown",_=>{const v=document,k=m.nextElementSibling,L=m.previousElementSibling,C=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS][a?"layout":"layoutTab"]===1?"lr":"tb",E=_[C==="lr"?"clientX":"clientY"],T=C==="lr"?L.clientWidth:L.clientHeight,H=C==="lr"?k.clientWidth:k.clientHeight;k.classList.remove("fn__flex-1"),k.style[C==="lr"?"width":"height"]=H+"px",v.onmousemove=D=>{D.preventDefault(),D.stopPropagation();const U=T+(D[C==="lr"?"clientX":"clientY"]-E),ye=H-(D[C==="lr"?"clientX":"clientY"]-E);U<120||ye<120||(k.style[C==="lr"?"width":"height"]=ye+"px")},v.onmouseup=()=>{v.onmousemove=null,v.onmouseup=null,v.ondragstart=null,v.onselectstart=null,v.onselect=null,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS][C==="lr"?a?"col":"colTab":a?"row":"rowTab"]=k[C==="lr"?"clientWidth":"clientHeight"]+"px",pe(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS]),C==="lr"&&qt(f.protyle)}});const b=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET],y=n.querySelector("#searchAssets");return n.addEventListener("click",_=>{let v=_.target;const k=n.querySelector("#searchPathInput");for(;v&&!v.isSameNode(n);){const L=v.getAttribute("data-type");if(L==="removeCriterion"){xd(n,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},p.Constants.SIYUAN_DEFAULT_REPLACETYPES)},e,f),n.querySelector(".b3-chip--current")?.classList.remove("b3-chip--current"),_.stopPropagation(),_.preventDefault();break}else if(L==="saveCriterion"){Bp(e,r,n),_.stopPropagation(),_.preventDefault();break}else if(L==="next"){v.getAttribute("disabled")||e.page<parseInt(v.parentElement.querySelector("#searchResult").getAttribute("data-pagecount"))&&(e.page++,Wt(n,e,f)),_.stopPropagation(),_.preventDefault();break}else if(L==="previous"){v.getAttribute("disabled")||e.page>1&&(e.page--,Wt(n,e,f)),_.stopPropagation(),_.preventDefault();break}else if(v.classList.contains("b3-chip")&&L==="set-criteria"){e.removed=!1,v.parentElement.querySelector(".b3-chip--current")?.classList.remove("b3-chip--current"),v.classList.add("b3-chip--current"),r.find(C=>{if(C.name===v.innerText.trim())return xd(n,C,e,f),!0}),_.stopPropagation(),_.preventDefault();break}else if(v.classList.contains("b3-chip__close")&&L==="remove-criteria"){const C=v.parentElement.textContent;w("/api/storage/removeCriterion",{name:C}),r.find((E,T)=>{if(E.name===C)return r.splice(T,1),!0}),v.parentElement.remove(),_.stopPropagation(),_.preventDefault();break}else if(v.classList.contains("search__rmpath")){e.idPath=[],e.hPath="",e.page=1,k.innerHTML=e.hPath,k.setAttribute("aria-label",""),Wt(n,e,f,!0);const C=n.querySelector("#searchInclude");C.firstElementChild.classList.add("ft__primary"),C.setAttribute("disabled","disabled"),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchExpand"){Array.from(c.children).forEach(C=>{C.classList.contains("b3-list-item")&&(C.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),C.nextElementSibling.classList.remove("fn__none"))}),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchCollapse"){Array.from(c.children).forEach(C=>{C.classList.contains("b3-list-item")&&(C.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),C.nextElementSibling.classList.add("fn__none"))}),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchPath"){ga((C,E)=>{w("/api/filetree/getHPathsByPaths",{paths:C},T=>{e.idPath=[];const H=[];let D=!1;C.forEach((ye,Fe)=>{ye==="/"?(e.idPath.push(E[Fe]),H.push(ea(E[Fe]))):(D=!0,e.idPath.push(Le().join(E[Fe],ye.replace(".sy",""))))}),T.data&&H.push(...T.data),e.hPath=H.join(" "),e.page=1,k.innerHTML=`${we(e.hPath)}<svg class="search__rmpath"><use xlink:href="#iconCloseRound"></use></svg>`,k.setAttribute("aria-label",we(e.hPath));const U=n.querySelector("#searchInclude");U.firstElementChild.classList.add("ft__primary"),D?U.removeAttribute("disabled"):U.setAttribute("disabled","disabled"),Wt(n,e,f,!0)})},[],void 0,window.siyuan.languages.specifyPath),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchInclude"){const C=v.firstElementChild;C.classList.toggle("ft__primary"),C.classList.contains("ft__primary")?e.idPath.forEach((E,T)=>{E.endsWith(".sy")&&(e.idPath[T]=E.replace(".sy",""))}):e.idPath.forEach((E,T)=>{!E.endsWith(".sy")&&E.split("/").length>1&&(e.idPath[T]=E+".sy")}),e.page=1,Wt(n,e,f,!0),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchReplace"){e.hasReplace=!e.hasReplace,n.querySelectorAll(".search__header")[1].classList.toggle("fn__none"),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchAsset"){Py(y,!a),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchAssetClose"){window.siyuan.menus.menu.remove(),y.classList.add("fn__none"),y.previousElementSibling.classList.remove("fn__none"),d.select(),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchOpen"){e.k=d.value,e.r=u.value,Dn({app:t,searchData:e,position:window.siyuan.layout.centerLayout.children.length>1||window.innerWidth>1024?"right":void 0}),a&&a(),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchRefresh"){Wt(n,e,f),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchMore"){Iy(e,r,n,()=>{e.page=1,Wt(n,e,f,!0)},()=>{xd(n,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},p.Constants.SIYUAN_DEFAULT_REPLACETYPES)},e,f),n.querySelector("#criteria .b3-chip--current")?.classList.remove("b3-chip--current")},()=>{const E=window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS],T=A(n,"b3-dialog__container");window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.layout,type:"submenu",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.topBottomLayout,current:T?E.layout===0:E.layoutTab===0,click(){n.querySelector(".search__layout").classList.remove("search__layout--row"),f.protyle.element.style.width="",T&&E.row||!T&&E.rowTab?(f.protyle.element.style.height=T?E.row:E.rowTab,f.protyle.element.classList.remove("fn__flex-1")):f.protyle.element.classList.add("fn__flex-1"),qt(f.protyle),T?E.layout=0:E.layoutTab=0,pe(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS])}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.leftRightLayout,current:T?E.layout===1:E.layoutTab===1,click(){n.querySelector(".search__layout").classList.add("search__layout--row"),f.protyle.element.style.height="",T&&E.col||!T&&E.colTab?(f.protyle.element.style.width=T?E.col:E.colTab,f.protyle.element.classList.remove("fn__flex-1")):f.protyle.element.classList.add("fn__flex-1"),qt(f.protyle),T?E.layout=1:E.layoutTab=1,pe(p.Constants.LOCAL_SEARCHKEYS,window.siyuan.storage[p.Constants.LOCAL_SEARCHKEYS])}}]}).element)});const C=v.getBoundingClientRect();window.siyuan.menus.menu.popup({x:C.right,y:C.bottom,isLeft:!0}),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchFilter"){window.siyuan.menus.menu.remove(),xy(e,()=>{e.page=1,Wt(n,e,f,!0)}),_.stopPropagation(),_.preventDefault();break}else if(v.id==="replaceFilter"){window.siyuan.menus.menu.remove(),Ay(e),_.stopPropagation(),_.preventDefault();break}else if(L==="assetPrevious"){if(!v.getAttribute("disabled")){let C=parseInt(y.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);C>1&&(C--,dn(y,b,C))}_.stopPropagation(),_.preventDefault();break}else if(L==="assetNext"){if(!v.getAttribute("disabled")){let C=parseInt(y.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);C<parseInt(y.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])&&(C++,dn(y,b,C))}_.stopPropagation(),_.preventDefault();break}else if(v.id==="assetMore"){Ry(v,y,()=>{dn(y),pe(p.Constants.LOCAL_SEARCHASSET,b)}),_.stopPropagation(),_.preventDefault();break}else if(v.id==="assetFilter"){Oy(y),_.stopPropagation(),_.preventDefault();break}else if(v.id==="assetSyntaxCheck"){Ny(v,()=>{n.querySelector("#assetSyntaxCheck").setAttribute("aria-label",Xl(b.method)),dn(y,b),pe(p.Constants.LOCAL_SEARCHASSET,b)}),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchSyntaxCheck"){Ty(e,()=>{n.querySelector("#searchSyntaxCheck").setAttribute("aria-label",Xl(e.method)),e.page=1,Wt(n,e,f,!0)});const C=v.getBoundingClientRect();window.siyuan.menus.menu.popup({x:C.right,y:C.bottom,isLeft:!0}),_.stopPropagation(),_.preventDefault();break}else if(v.id==="searchHistoryBtn"){Vp(n,e,f),_.stopPropagation(),_.preventDefault();return}else if(v.id==="assetHistoryBtn"){Up(y),_.stopPropagation(),_.preventDefault();return}else if(v.id==="replaceHistoryBtn"){Wp(n),_.stopPropagation(),_.preventDefault();return}else if(v.id==="replaceAllBtn"){Ad(n,e,f,!0),_.stopPropagation(),_.preventDefault();break}else if(L==="assetRefresh"){dn(y),_.stopPropagation(),_.preventDefault();break}else if(v.id==="replaceBtn"){Ad(n,e,f,!1),_.stopPropagation(),_.preventDefault();break}else if(v.classList.contains("b3-list-item__toggle")){v.parentElement.nextElementSibling.classList.toggle("fn__none"),v.firstElementChild.classList.toggle("b3-list-item__arrow--open"),_.stopPropagation(),_.preventDefault();break}else if(v.classList.contains("b3-list-item")){const C=n.querySelector("#searchAssetInput");if(L==="search-new")e.method==0&&ld(t,d.value);else if(L==="search-item"){const E=v.dataset.id;let T=_.detail===1,H=_.detail===2;if(T)g=window.setTimeout(()=>{if(E)v.classList.contains("b3-list-item--focus")?v.classList.contains("b3-list-item--focus")&&(My(n.querySelector("#searchAssetPreview")),C.focus()):(y.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),v.classList.add("b3-list-item--focus"),Jl(n.querySelector("#searchAssetPreview"),v.dataset.id,C.value,window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET].method),C.focus());else if(_.altKey){const D=v.getAttribute("data-node-id");ot(D,(U,ye)=>{de({app:t,id:D,action:ye,zoomIn:U,position:"right"}),a&&a()})}else v.classList.contains("b3-list-item--focus")?v.classList.contains("b3-list-item--focus")&&(By({edit:f,id:v.getAttribute("data-node-id"),target:v}),d.focus()):(c.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),v.classList.add("b3-list-item--focus"),ds({edit:f,id:v.getAttribute("data-node-id"),config:e,value:d.value}),d.focus())},p.Constants.TIMEOUT_DBLCLICK);else if(H&&R(_))if(clearTimeout(g),E)Qn(kt.join(window.siyuan.config.system.dataDir,v.lastElementChild.getAttribute("aria-label")));else{const D=v.getAttribute("data-node-id");ot(D,(U,ye)=>{de({app:t,id:D,action:ye,zoomIn:U}),a&&a()})}window.siyuan.menus.menu.remove()}else v.querySelector(".b3-list-item__toggle")&&(v.nextElementSibling.classList.toggle("fn__none"),v.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));_.stopPropagation(),_.preventDefault();break}v=v.parentElement}},!1),d.addEventListener("compositionend",_=>{e.page=1,!_.isComposing&&Wt(n,e,f,!0)}),d.addEventListener("input",_=>{e.page=1,!_.isComposing&&Wt(n,e,f,!0)}),d.addEventListener("blur",()=>{e.removed&&(e.k=d.value,window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]=Object.assign({},e),pe(p.Constants.LOCAL_SEARCHDATA,window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA])),zp("keys",d.value)}),Cd({inputElement:d,right:8,height:d.clientHeight,clearCB(){e.page=1,Wt(n,e,f)}}),Cd({right:8,inputElement:u,height:d.clientHeight}),Wt(n,e,f),f},Xl=t=>{let e=window.siyuan.languages.searchMethod+" ";switch(t){case 0:e+=window.siyuan.languages.keyword;break;case 1:e+=window.siyuan.languages.querySyntax;break;case 2:e+="SQL";break;case 3:e+=window.siyuan.languages.regex;break}return e},xd=(t,e,n,a)=>{const i=A(t,"b3-dialog--open");if(i&&i.getAttribute("data-key")===p.Constants.DIALOG_SEARCH&&(e.hPath=n.hPath,e.idPath=n.idPath.join(",").split(",")),n.hasReplace!==e.hasReplace){const c=t.querySelectorAll(".search__header")[1];e.hasReplace?c.classList.remove("fn__none"):c.classList.add("fn__none")}const s=t.querySelector("#searchPathInput");e.hPath?(s.innerHTML=`${we(e.hPath)}<svg class="search__rmpath"><use xlink:href="#iconCloseRound"></use></svg>`,s.setAttribute("aria-label",we(e.hPath))):(s.innerHTML="",s.setAttribute("aria-label","")),n.group!==e.group&&(e.group===0?t.querySelector("#searchExpand").parentElement.classList.add("fn__none"):t.querySelector("#searchExpand").parentElement.classList.remove("fn__none"));let o=!0,l=!1;e.idPath.forEach(c=>{c.endsWith(".sy")&&(o=!1),c.split("/").length>1&&(l=!0)});const r=t.querySelector("#searchInclude");o?r.firstElementChild.classList.add("ft__primary"):r.firstElementChild.classList.remove("ft__primary"),l?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),t.querySelector("#searchInput").value=e.k,t.querySelector("#replaceInput").value=e.r,t.querySelector("#searchSyntaxCheck").setAttribute("aria-label",Xl(e.method)),Object.assign(n,e),window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]=Object.assign({},n),pe(p.Constants.LOCAL_SEARCHDATA,window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA]),Wt(t,n,a),window.siyuan.menus.menu.remove()},By=t=>{let e;const n=Array.from(t.edit.protyle.wysiwyg.element.querySelectorAll(`div[data-node-id="${t.id}"] span[data-type~="search-mark"]`));if(n.find((a,i)=>{if(a.classList.contains("search-mark--hl")){a.classList.remove("search-mark--hl"),e=n[i+1];return}}),e||(e=n[0]),e){e.classList.add("search-mark--hl");const a=t.edit.protyle.contentElement.getBoundingClientRect();t.edit.protyle.contentElement.scrollTop=t.edit.protyle.contentElement.scrollTop+e.getBoundingClientRect().top-a.top-a.height/2}},ds=t=>{ot(t.id,e=>{t.edit.protyle.scroll.lastScrollTop=0,$i(t.edit.protyle),w("/api/filetree/getDoc",{id:t.id,query:t.value,queryMethod:t.config.method,queryTypes:t.config.types,mode:e?0:3,size:e?p.Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,zoom:e},n=>{st({data:n,protyle:t.edit.protyle,action:e?[p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_HTML]});const a=t.edit.protyle.wysiwyg.element.querySelector(`div[data-node-id="${t.id}"] span[data-type~="search-mark"]`);if(a){a.classList.add("search-mark--hl");const i=t.edit.protyle.contentElement.getBoundingClientRect();t.edit.protyle.contentElement.scrollTop=t.edit.protyle.contentElement.scrollTop+a.getBoundingClientRect().top-i.top-i.height/2}})})},Ad=(t,e,n,a)=>{if(e.method===1||e.method===2){M(window.siyuan.languages._kernel[132]);return}const i=t.querySelector("#searchList"),s=t.querySelector("#replaceInput"),o=t.querySelector("#searchInput"),l=t.querySelector("svg.fn__rotate");if(!l.classList.contains("fn__none"))return;zp("replaceKeys",s.value);let r=i.querySelector(".b3-list-item--focus");!r||r.dataset.type==="search-new"||(l.classList.remove("fn__none"),w("/api/search/findReplace",{k:e.method===0?$y(r):o.value,r:s.value,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page,ids:a?[]:[r.getAttribute("data-node-id")],replaceTypes:e.replaceTypes},c=>{if(l.classList.add("fn__none"),c.code===1){M(c.msg);return}if(a)return;const d=r.getAttribute("data-root-id");if(Pe().editor.forEach(u=>{d===u.editor.protyle.block.rootID&&na(u.editor.protyle,!1)}),r.nextElementSibling?r.nextElementSibling.classList.add("b3-list-item--focus"):r.previousElementSibling&&r.previousElementSibling.classList.add("b3-list-item--focus"),e.group===1)if(r.nextElementSibling||r.previousElementSibling)r.remove();else{const u=r.parentElement.nextElementSibling||r.parentElement.previousElementSibling.previousElementSibling?.previousElementSibling;u&&(u.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),u.nextElementSibling.classList.remove("fn__none"),u.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),r.parentElement.previousElementSibling.remove(),r.parentElement.remove()}else r.remove();if(r=i.querySelector(".b3-list-item--focus"),!r){i.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`,n.protyle.element.classList.add("fn__none"),t.querySelector(".search__drag").classList.add("fn__none");return}(i.scrollTop<r.offsetTop-i.clientHeight+30||i.scrollTop>r.offsetTop)&&(i.scrollTop=r.offsetTop-i.clientHeight+30),ds({edit:n,id:r.getAttribute("data-node-id"),config:e,value:o.value})}))},Wt=(t,e,n,a=!1)=>{let i=parseInt(t.getAttribute("data-timeout")||"0");clearTimeout(i),i=window.setTimeout(()=>{a&&t.querySelector("#criteria .b3-chip--current")?.classList.remove("b3-chip--current");const s=t.querySelector("#searchInput"),o=t.querySelector(".fn__loading--top");o.classList.remove("fn__none");const l=s.value;t.querySelector("#searchList").scrollTo(0,0);const r=t.querySelector('[data-type="previous"]'),c=t.querySelector('[data-type="next"]');n.protyle?.app.plugins.forEach(u=>{u.eventBus.emit("input-search",{protyle:n,config:e,searchElement:s})});const d=t.querySelector("#searchResult");l===""&&(!e.idPath||e.idPath.length===0)?w("/api/block/getRecentUpdatedBlocks",{},u=>{jp(u.data,n,t,e),o.classList.add("fn__none"),d.innerHTML="",r.setAttribute("disabled","true"),c.setAttribute("disabled","true")}):(e.page>1?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled"),w("/api/search/fullTextSearchBlock",{query:l,method:e.method,types:e.types,paths:e.idPath||[],groupBy:e.group,orderBy:e.sort,page:e.page||1},u=>{e.page||(e.page=1),e.page<u.data.pageCount?c.removeAttribute("disabled"):c.setAttribute("disabled","disabled"),jp(u.data.blocks,n,t,e),d.innerHTML=`${e.page}/${u.data.pageCount||1}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.findInDoc.replace("${x}",u.data.matchedRootCount).replace("${y}",u.data.matchedBlockCount)}</span>`,o.classList.add("fn__none"),d.setAttribute("data-pagecount",u.data.pageCount||1)}))},p.Constants.TIMEOUT_INPUT),t.setAttribute("data-timeout",i.toString())},Gp=t=>{let e="";return t.name&&(e+=`<span class="b3-list-item__meta fn__flex" style="max-width: 30%"><svg class="b3-list-item__hinticon"><use xlink:href="#iconN"></use></svg><span class="b3-list-item__hinttext">${t.name}</span></span>`),t.alias&&(e+=`<span class="b3-list-item__meta fn__flex" style="max-width: 30%"><svg class="b3-list-item__hinticon"><use xlink:href="#iconA"></use></svg><span class="b3-list-item__hinttext">${t.alias}</span></span>`),t.memo&&(e+=`<span class="b3-list-item__meta fn__flex" style="max-width: 30%"><svg class="b3-list-item__hinticon"><use xlink:href="#iconM"></use></svg><span class="b3-list-item__hinttext">${t.memo}</span></span>`),e},jp=(t,e,n,a)=>{let i="";if(t.forEach((s,o)=>{const l=ea(s.box)+ft(s.hPath,!1);s.children?(i+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${ie(Fw(s.box)||p.Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text ariaLabel" style="color: var(--b3-theme-on-surface)" aria-label="${qa(l)}">${no(l)}</span>
</div><div>`,s.children.forEach((r,c)=>{i+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${c===0&&o===0?" b3-list-item--focus":""}" data-node-id="${r.id}" data-root-id="${r.rootID}">
<svg class="b3-list-item__graphic"><use xlink:href="#${bn(r.type)}"></use></svg>
${ie(r.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${r.content}</span>
${Gp(r)}
</div>`}),i+="</div>"):i+=`<div data-type="search-item" class="b3-list-item${o===0?" b3-list-item--focus":""}" data-node-id="${s.id}" data-root-id="${s.rootID}">
<svg class="b3-list-item__graphic"><use xlink:href="#${bn(s.type)}"></use></svg>
${ie(s.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${s.content}</span>
${Gp(s)}
<span class="b3-list-item__meta b3-list-item__meta--ellipsis ariaLabel" aria-label="${qa(l)}">${no(l)}</span>
</div>`}),t[0]){e.protyle.element.classList.remove("fn__none"),n.querySelector(".search__drag").classList.remove("fn__none");const s=n.querySelector("#searchInput");t[0].children?ds({edit:e,id:t[0].children[0].id,config:a,value:s.value}):ds({edit:e,id:t[0].id,config:a,value:s.value})}else e.protyle.element.classList.add("fn__none"),n.querySelector(".search__drag").classList.add("fn__none");n.querySelector("#searchList").innerHTML=i||(a.method===0?`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${n.querySelector("#searchInput").value}</mark>
    </span>
    <kbd class="b3-list-item__meta">${window.siyuan.languages.enterNew}</kbd>
</div>
<div class="search__empty">
    ${window.siyuan.languages.enterNewTip}
</div>`:`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <span class="b3-list-item__text">
        ${window.siyuan.languages.emptyContent}
    </span>
</div>`)},Kp=t=>{const e=parseInt(t.getAttribute("data-subtype").substr(1));let n=t.nextElementSibling;for(;n;){const a=parseInt(n.getAttribute("data-subtype")?.substr(1));if(!n.classList.contains("protyle-attr")&&(isNaN(a)||a>e)){const i=n;n=n.nextElementSibling,i.remove()}else break}};class qy{constructor(){this.hasUndo=!1,this.redoStack=[],this.undoStack=[]}undo(e){if(e.disabled||this.undoStack.length===0)return;const n=this.undoStack.pop();this.render(e,n,!1),this.hasUndo=!0,this.redoStack.push(n)}redo(e){if(e.disabled||this.redoStack.length===0)return;const n=this.redoStack.pop();this.render(e,n,!0),this.undoStack.push(n)}render(e,n,a){X(["hint","gutter"],e),e.wysiwyg.lastHTMLs={},a?(n.doOperations.forEach(i=>{Yd(e,i,!0)}),F(e,n.doOperations)):(n.undoOperations.forEach(i=>{Yd(e,i,!0)}),F(e,n.undoOperations)),ln(e),He(e)}replace(e){this.hasUndo&&this.redoStack.length>0&&(this.undoStack.push(this.redoStack.pop()),this.redoStack=[],this.hasUndo=!1),this.undoStack.length>0&&(this.undoStack[this.undoStack.length-1].doOperations=e)}add(e,n){this.undoStack.push({undoOperations:n,doOperations:e}),this.undoStack.length>p.Constants.SIZE_UNDO&&this.undoStack.shift(),this.hasUndo&&(this.redoStack=[],this.hasUndo=!1)}clear(){this.undoStack=[],this.redoStack=[]}}const Ya=t=>$(window.siyuan.config.keymap.editor.general.undo.custom,t)?(te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"undo"),t.preventDefault(),t.stopPropagation(),!0):$(window.siyuan.config.keymap.editor.general.redo.custom,t)?(te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"redo"),t.preventDefault(),t.stopPropagation(),!0):!1,Fy=(t,e,n)=>{let a,i="",s=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(s.length===0){let l=be(e);const r=q(l,"fold","1");r&&(l=r),l.previousElementSibling?.classList.contains("protyle-action")&&(l=be(l.parentElement)),s=[l]}const o=s[0].getAttribute("data-type");if(o==="NodeListItem"&&!s[0].previousElementSibling&&s[0].parentElement.previousElementSibling?.previousElementSibling?.classList.contains("protyle-action"))if(s[0].parentElement.parentElement.previousElementSibling?.classList.contains("li")){if(a=s[0].parentElement.parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),i=s[0].parentElement.parentElement.parentElement.outerHTML,!a){const l=Lute.NewNodeID();s[0].parentElement.parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${s[0].getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),a=s[0].parentElement.parentElement.previousElementSibling.querySelector(".list")}}else return;if(o==="NodeList"&&s[0].previousElementSibling?.previousElementSibling?.classList.contains("protyle-action"))if(s[0].parentElement.previousElementSibling?.classList.contains("li")){if(a=s[0].parentElement.previousElementSibling.querySelector(".list"),n.insertNode(document.createElement("wbr")),i=s[0].parentElement.parentElement.outerHTML,!a){const l=Lute.NewNodeID();s[0].parentElement.previousElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${s[0].getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div id="moveTempLi"></div><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),a=s[0].parentElement.previousElementSibling.querySelector(".list")}}else return;if(a){a=a.lastElementChild.previousElementSibling;const l=s[0].classList.contains("list")?s[0]:s[0].parentElement;s.reverse().forEach(r=>{r.classList.contains("list")?a.after(r.firstElementChild):a.after(r)}),a.id==="moveTempLi"&&(a=a.nextElementSibling,a.previousElementSibling.remove()),l.childElementCount===1?l.remove():l.getAttribute("data-subtype")==="o"&&l.classList.contains("list")&&it(l,1),a.getAttribute("data-subtype")==="o"&&it(a.parentElement),J(t,a.parentElement.parentElement.parentElement.getAttribute("data-node-id"),a.parentElement.parentElement.parentElement.outerHTML,i),ln(t),He(t),fe(a.parentElement,n);return}if(!(!s[0].previousElementSibling||s[0].previousElementSibling?.classList.contains("protyle-action"))){if(a=s[0].previousElementSibling,s[0].getAttribute("data-subtype")==="o"&&o==="NodeListItem"){const l=s[0].parentElement.outerHTML;s[s.length-1].after(a),it(s[0].parentElement,1),J(t,s[0].parentElement.getAttribute("data-node-id"),s[0].parentElement.outerHTML,l)}else{const l=a.getAttribute("data-node-id");F(t,[{action:"move",id:l,previousID:s[s.length-1].getAttribute("data-node-id")}],[{action:"move",id:l,previousID:a.previousElementSibling?.getAttribute("data-node-id"),parentID:a.parentElement.getAttribute("data-node-id")||t.block.parentID}]),s[s.length-1].after(a)}ln(t),He(t)}},Uy=(t,e,n)=>{let a,i="",s=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(s.length===0){let l=be(e);const r=q(l,"fold","1");r&&(l=r),l.previousElementSibling?.classList.contains("protyle-action")&&(l=be(l.parentElement)),s=[l]}const o=s[0].getAttribute("data-type");if(o==="NodeListItem"&&s[s.length-1].nextElementSibling.classList.contains("protyle-attr")&&s[0].parentElement.parentElement?.classList.contains("li"))if(s[0].parentElement.parentElement.nextElementSibling?.classList.contains("li")){if(a=s[0].parentElement.parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),i=s[0].parentElement.parentElement.parentElement.outerHTML,!a){const l=Lute.NewNodeID();s[0].parentElement.parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${s[0].getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),a=s[0].parentElement.parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(o==="NodeList"&&s[s.length-1].nextElementSibling.classList.contains("protyle-attr")&&s[0].parentElement?.classList.contains("li"))if(s[0].parentElement.nextElementSibling?.classList.contains("li")){if(a=s[0].parentElement.nextElementSibling.querySelector(".list > .li"),n.insertNode(document.createElement("wbr")),i=s[0].parentElement.parentElement.outerHTML,!a){const l=Lute.NewNodeID();s[0].parentElement.nextElementSibling.lastElementChild.insertAdjacentHTML("beforebegin",`<div data-subtype="${s[0].getAttribute("data-subtype")}" data-node-id="${l}" data-type="NodeList" class="list" updated="${l.split("-")[0]}"><div class="protyle-attr" contenteditable="false">&ZeroWidthSpace;</div></div>`),a=s[0].parentElement.nextElementSibling.querySelector(".list > div")}}else return;if(a){const l=s[0].classList.contains("list")?s[0]:s[0].parentElement;s.forEach(r=>{r.classList.contains("list")?a.before(r.firstElementChild):a.before(r)}),l.childElementCount===1?l.remove():l.getAttribute("data-subtype")==="o"&&l.classList.contains("list")&&it(l,1),a.getAttribute("data-subtype")==="o"&&it(a.parentElement,1),J(t,a.parentElement.parentElement.parentElement.getAttribute("data-node-id"),a.parentElement.parentElement.parentElement.outerHTML,i),ln(t),He(t),fe(a.parentElement,n);return}if(!(!s[s.length-1].nextElementSibling||s[s.length-1].nextElementSibling?.classList.contains("protyle-attr"))){if(a=s[s.length-1].nextElementSibling,a.getAttribute("data-subtype")==="o"&&a.getAttribute("data-type")==="NodeListItem"){const l=a.parentElement.outerHTML;s[0].before(a),it(a.parentElement,1),J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,l)}else{const l=a.getAttribute("data-node-id");F(t,[{action:"move",id:l,previousID:s[0].previousElementSibling?.getAttribute("data-node-id"),parentID:a.parentElement.getAttribute("data-node-id")||t.block.parentID}],[{action:"move",id:l,previousID:s[s.length-1].getAttribute("data-node-id")}]),s[0].before(a)}ln(t),He(t)}},Ql=(t,e)=>{w("/api/filetree/createDailyNote",{notebook:e,app:p.Constants.SIYUAN_APPID},n=>{de({app:t,id:n.data.id,action:[p.Constants.CB_GET_FOCUS]})})},Zp=t=>{if(window.siyuan.dialogs.find(s=>{if(s.element.getAttribute("data-key")===p.Constants.DIALOG_DIALYNOTE)return s.destroy(),!0}))return;const n=nd();if(n===0){M(window.siyuan.languages.newFileTip);return}if(n===1){let s="";window.siyuan.notebooks.find(o=>{o.closed||(s=o.id)}),Ql(t,s);return}const a=window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID],i=window.siyuan.notebooks.find(s=>{if(s.id===a&&!s.closed)return!0});if(a&&i&&!(0,I.tq)())Ql(t,a);else{let s="";window.siyuan.notebooks.forEach(c=>{c.closed||(s+=`<option value="${c.id}">${c.name}</option>`)});const o=new me({positionId:p.Constants.DIALOG_DIALYNOTE,title:window.siyuan.languages.plsChoose,content:`<div class="b3-dialog__content">
    <select class="b3-select fn__block">${s}</select>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"});o.element.setAttribute("data-key",p.Constants.DIALOG_DIALYNOTE);const l=o.element.querySelectorAll(".b3-button"),r=o.element.querySelector(".b3-select");r.value=a,l[0].addEventListener("click",()=>{o.destroy()}),l[1].addEventListener("click",()=>{const c=r.value;window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID]=c,pe(p.Constants.LOCAL_DAILYNOTEID,window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID]),Ql(t,c),o.destroy()})}},er=()=>{const t=p.Constants.HELP_PATH[window.siyuan.config.appearance.lang];w("/api/notebook/removeNotebook",{notebook:t,callback:p.Constants.CB_MOUNT_REMOVE},()=>{w("/api/notebook/openNotebook",{notebook:t})})},Jp=()=>{const t=new me({title:window.siyuan.languages.newNotebook,content:`<div class="b3-dialog__content">
    <input placeholder="${window.siyuan.languages.notebookName}" class="b3-text-field fn__block">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),e=t.element.querySelectorAll(".b3-button");t.bindInput(t.element.querySelector("input"),()=>{e[1].dispatchEvent(new CustomEvent("click"))}),e[0].addEventListener("click",()=>{t.destroy()}),e[1].addEventListener("click",()=>{const n=t.element.querySelector("input").value;if(!Fl(n))return!1;w("/api/notebook/createNotebook",{name:n}),t.destroy()})},Xp=(t,e,n)=>{if(e.method===1||e.method===2){showMessage(window.siyuan.languages._kernel[132]);return}const a=t.querySelector("#searchList"),i=t.querySelector("#toolbarReplace"),s=i.parentElement.querySelector(".fn__rotate");if(!s.classList.contains("fn__none"))return;let o=a.querySelector(".b3-list-item--focus");if(!o)return;s.classList.remove("fn__none"),s.nextElementSibling.classList.add("fn__none");let l=[];n?a.querySelectorAll('.b3-list-item[data-type="search-item"]').forEach(r=>{l.push(r.getAttribute("data-node-id"))}):l=[o.getAttribute("data-node-id")],fetchPost("/api/search/findReplace",{k:e.method===0?getKeyByLiElement(o):document.querySelector("#toolbarSearch").value,r:i.value,ids:l,types:e.types,method:e.method,replaceTypes:e.replaceTypes},r=>{if(s.classList.add("fn__none"),s.nextElementSibling.classList.remove("fn__none"),r.code===1){showMessage(r.msg);return}if(!(l.length>1)){if(reloadProtyle(window.siyuan.mobile.editor.protyle,!1),o.nextElementSibling?o.nextElementSibling.classList.add("b3-list-item--focus"):o.previousElementSibling&&o.previousElementSibling.classList.add("b3-list-item--focus"),e.group===1)if(o.nextElementSibling||o.previousElementSibling)o.remove();else{const c=o.parentElement.nextElementSibling||o.parentElement.previousElementSibling.previousElementSibling?.previousElementSibling;c&&(c.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"),c.nextElementSibling.classList.remove("fn__none"),c.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open")),o.parentElement.previousElementSibling.remove(),o.parentElement.remove()}else o.remove();if(o=a.querySelector(".b3-list-item--focus"),!o){a.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`;return}(a.scrollTop<o.offsetTop-a.clientHeight+30||a.scrollTop>o.offsetTop)&&(a.scrollTop=o.offsetTop-a.clientHeight+30)}})},Qp=(t,e,n)=>{n.hasReplace!==e.hasReplace&&(e.hasReplace?(t.querySelector('[data-type="toggle-replace"]').classList.add("toolbar__icon--active"),t.querySelector(".toolbar").classList.remove("fn__none")):(t.querySelector('[data-type="toggle-replace"]').classList.remove("toolbar__icon--active"),t.querySelector(".toolbar").classList.add("fn__none")));const a=t.querySelector("#searchPath");e.hPath?(a.classList.remove("fn__none"),a.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(e.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`):a.classList.add("fn__none"),n.group!==e.group&&(e.group===0?(t.querySelector('[data-type="expand"]').classList.add("fn__none"),t.querySelector('[data-type="contract"]').classList.add("fn__none")):(t.querySelector('[data-type="expand"]').classList.remove("fn__none"),t.querySelector('[data-type="contract"]').classList.remove("fn__none")));let i=!0,s=!1;e.idPath.forEach(l=>{l.endsWith(".sy")&&(i=!1),l.split("/").length>1&&(s=!0)});const o=t.querySelector('[data-type="include"]');i?o.classList.add("toolbar__icon--active"):o.classList.remove("toolbar__icon--active"),s?o.removeAttribute("disabled"):o.setAttribute("disabled","disabled"),document.querySelector("#toolbarSearch").value=e.k,t.querySelector("#toolbarReplace").value=e.r,Object.assign(n,e),window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]),Tn(n,t),window.siyuan.menus.menu.remove()},eg=(t,e,n)=>{const a=document.querySelector("#searchList");let i="";t.forEach((o,l)=>{const r=getNotebookName(o.box)+getDisplayName(o.hPath,!1);o.children?(i+=`<div class="b3-list-item">
<span class="b3-list-item__toggle b3-list-item__toggle--hl">
    <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
</span>
${unicode2Emoji(getNotebookIcon(o.box)||Constants.SIYUAN_IMAGE_NOTE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text" style="color: var(--b3-theme-on-surface)">${escapeGreat(r)}</span>
</div><div>`,o.children.forEach((c,d)=>{i+=`<div style="padding-left: 36px" data-type="search-item" class="b3-list-item${d===0&&l===0?" b3-list-item--focus":""}" data-node-id="${c.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(c.type)}"></use></svg>
${unicode2Emoji(c.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${c.content}</span>
</div>`}),i+="</div>"):i+=`<div class="b3-list-item b3-list-item--two${l===0?" b3-list-item--focus":""}" data-type="search-item" data-node-id="${o.id}">
<div class="b3-list-item__first">
    <svg class="b3-list-item__graphic"><use xlink:href="#${getIconByType(o.type)}"></use></svg>
    ${unicode2Emoji(o.ial.icon,"b3-list-item__graphic",!0)}
    <span class="b3-list-item__text">${o.content}</span>
</div>
<span class="b3-list-item__text b3-list-item__meta">${escapeGreat(r)}</span>
</div>`}),a.innerHTML=i||`<div class="b3-list-item b3-list-item--focus" data-type="search-new">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
    <span class="b3-list-item__text">
        ${window.siyuan.languages.newFile} <mark>${document.querySelector("#toolbarSearch").value}</mark>
    </span>
</div>`,a.scrollTop=0;let s="";n&&(s=`<span class="fn__flex-center">${window.siyuan.languages.findInDoc.replace("${x}",n.data.matchedRootCount).replace("${y}",n.data.matchedBlockCount)}</span>
<span class="fn__flex-1"></span>
<span class="fn__flex-center">${e.page}/${n.data.pageCount||1}</span>`),a.previousElementSibling.querySelector('[data-type="result"]').innerHTML=s};let tg=0;const Tn=(t,e,n=!1)=>{clearTimeout(tg),tg=window.setTimeout(()=>{n&&e.querySelector("#criteria .b3-chip--current")?.classList.remove("b3-chip--current");const a=e.querySelector(".fn__loading--top");a.classList.remove("fn__none");const i=e.querySelector('[data-type="previous"]'),s=e.querySelector('[data-type="next"]'),o=document.getElementById("toolbarSearch");o.value===""&&(!t.idPath||t.idPath.length===0)?fetchPost("/api/block/getRecentUpdatedBlocks",{},l=>{eg(l.data,t),a.classList.add("fn__none"),i.setAttribute("disabled","true"),s.setAttribute("disabled","true")}):(t.page||(t.page=1),t.page>1?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),fetchPost("/api/search/fullTextSearchBlock",{query:o.value,method:t.method,types:t.types,paths:t.idPath||[],groupBy:t.group,orderBy:t.sort,page:t.page},l=>{eg(l.data.blocks,t,l),a.classList.add("fn__none"),t.page<l.data.pageCount?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled")}))},Constants.TIMEOUT_INPUT)},Wy=(t,e,n)=>{const a=document.getElementById("toolbarSearch");a.value=n.k||"",a.addEventListener("compositionend",c=>{c&&c.isComposing||(n.page=1,Tn(n,e,!0))}),a.addEventListener("input",c=>{c&&c.isComposing||(n.page=1,Tn(n,e,!0))}),a.addEventListener("blur",()=>{n.removed&&(n.k=a.value,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]=Object.assign({},n),setStorageVal(Constants.LOCAL_SEARCHDATA,window.siyuan.storage[Constants.LOCAL_SEARCHDATA]))}),addClearButton({inputElement:a,className:"toolbar__icon",clearCB(){n.page=1,Tn(n,e)}});const i=e.querySelector(".toolbar .toolbar__title");i.value=n.r||"",addClearButton({inputElement:i,className:"toolbar__icon"});const s=[];initCriteriaMenu(e.querySelector("#criteria"),s,n);const o=document.querySelector("#searchAssetsPanel"),l=e.querySelector("#searchList"),r=window.siyuan.storage[Constants.LOCAL_SEARCHASSET];e.addEventListener("click",c=>{let d=c.target;for(;d&&!d.isSameNode(e);){const u=d.getAttribute("data-type");if(u==="previous"){d.getAttribute("disabled")||(n.page--,Tn(n,e)),c.stopPropagation(),c.preventDefault();break}else if(u==="next"){d.getAttribute("disabled")||(n.page++,Tn(n,e)),c.stopPropagation(),c.preventDefault();break}else if(u==="set-criteria"){n.removed=!1,d.parentElement.querySelector(".b3-chip--current")?.classList.remove("b3-chip--current"),d.classList.add("b3-chip--current"),s.find(f=>{if(f.name===d.innerText.trim())return Qp(e,f,n),!0}),c.stopPropagation(),c.preventDefault();break}else if(u==="remove-criteria"){const f=d.parentElement.innerText.trim();fetchPost("/api/storage/removeCriterion",{name:f}),s.find((g,h)=>{if(g.name===f)return s.splice(h,1),!0}),d.parentElement.parentElement.childElementCount===1&&d.parentElement.parentElement.classList.add("fn__none"),d.parentElement.remove(),c.stopPropagation(),c.preventDefault();break}else if(u==="remove-path"){n.idPath=[],n.hPath="",e.querySelector("#searchPath").classList.add("fn__none"),n.page=1,Tn(n,e,!0);const f=e.querySelector('[data-type="include"]');f.classList.remove("toolbar__icon--active"),f.setAttribute("disabled","disabled"),c.stopPropagation(),c.preventDefault();break}else if(u==="expand"){Array.from(l.children).forEach(f=>{f.classList.contains("b3-list-item")&&(f.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),f.nextElementSibling.classList.remove("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(u==="contract"){Array.from(l.children).forEach(f=>{f.classList.contains("b3-list-item")&&(f.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),f.nextElementSibling.classList.add("fn__none"))}),c.stopPropagation(),c.preventDefault();break}else if(u==="currentPath"&&!d.hasAttribute("disabled")){const f=getCurrentEditor().protyle;fetchPost("/api/filetree/getHPathsByPaths",{paths:[f.path]},g=>{n.idPath=[pathPosix().join(f.notebookId,f.path)],n.hPath=g.data[0];const h=e.querySelector("#searchPath");h.classList.remove("fn__none"),h.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const m=e.querySelector('[data-type="include"]');m.classList.remove("toolbar__icon--active"),m.removeAttribute("disabled"),n.page=1,Tn(n,e,!0)}),c.stopPropagation(),c.preventDefault();break}else if(u==="path"){movePathTo((f,g)=>{fetchPost("/api/filetree/getHPathsByPaths",{paths:f},h=>{n.idPath=[];const m=[];let b=!1;f.forEach((v,k)=>{v==="/"?(n.idPath.push(g[k]),m.push(getNotebookName(g[k]))):(b=!0,n.idPath.push(pathPosix().join(g[k],v.replace(".sy",""))))}),h.data&&m.push(...h.data),n.hPath=m.join(" ");const y=e.querySelector("#searchPath");y.classList.remove("fn__none"),y.innerHTML=`<div class="b3-chip b3-chip--middle">${escapeHtml(n.hPath)}<svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg></div>`;const _=e.querySelector('[data-type="include"]');_.classList.add("toolbar__icon--active"),b?_.removeAttribute("disabled"):_.setAttribute("disabled","disabled"),n.page=1,Tn(n,e,!0)})},[],void 0,window.siyuan.languages.specifyPath),c.stopPropagation(),c.preventDefault();break}else if(u==="include"&&!d.hasAttribute("disabled")){d.classList.toggle("toolbar__icon--active"),d.classList.contains("toolbar__icon--active")?n.idPath.forEach((f,g)=>{f.endsWith(".sy")&&(n.idPath[g]=f.replace(".sy",""))}):n.idPath.forEach((f,g)=>{!f.endsWith(".sy")&&f.split("/").length>1&&(n.idPath[g]=f+".sy")}),n.page=1,Tn(n,e,!0),c.stopPropagation(),c.preventDefault();break}else if(u==="toggle-replace"){n.hasReplace=!n.hasReplace,i.parentElement.classList.toggle("fn__none"),d.classList.toggle("toolbar__icon--active"),c.stopPropagation(),c.preventDefault();break}else if(u==="more"){moreMenu(n,s,e,()=>{n.page=1,Tn(n,e,!0)},()=>{Qp(e,{removed:!0,sort:0,group:0,hasReplace:!1,method:0,hPath:"",idPath:[],k:"",r:"",page:1,types:{document:window.siyuan.config.search.document,heading:window.siyuan.config.search.heading,list:window.siyuan.config.search.list,listItem:window.siyuan.config.search.listItem,codeBlock:window.siyuan.config.search.codeBlock,htmlBlock:window.siyuan.config.search.htmlBlock,mathBlock:window.siyuan.config.search.mathBlock,table:window.siyuan.config.search.table,blockquote:window.siyuan.config.search.blockquote,superBlock:window.siyuan.config.search.superBlock,paragraph:window.siyuan.config.search.paragraph,embedBlock:window.siyuan.config.search.embedBlock,databaseBlock:window.siyuan.config.search.databaseBlock},replaceTypes:Object.assign({},Constants.SIYUAN_DEFAULT_REPLACETYPES)},n)}),window.siyuan.menus.menu.fullscreen(),c.stopPropagation(),c.preventDefault();break}else if(u==="replace-all"){Xp(e,n,!0),c.stopPropagation(),c.preventDefault();break}else if(u==="queryAsset"){assetMethodMenu(d,()=>{assetInputEvent(o,r),setStorageVal(Constants.LOCAL_SEARCHASSET,r)}),c.stopPropagation(),c.preventDefault();break}else if(u==="filterAsset"){assetFilterMenu(o),c.stopPropagation(),c.preventDefault();break}else if(u==="moreAsset"){assetMoreMenu(d,o,()=>{assetInputEvent(o),setStorageVal(Constants.LOCAL_SEARCHASSET,r)}),c.stopPropagation(),c.preventDefault();break}else if(u==="goAsset"){Vy(),c.stopPropagation(),c.preventDefault();break}else if(u==="goSearch"){o.classList.add("fn__none"),c.stopPropagation(),c.preventDefault();break}else if(u==="assetPrevious"){d.getAttribute("disabled")||assetInputEvent(o,r,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])-1),c.stopPropagation(),c.preventDefault();break}else if(u==="assetNext"){d.getAttribute("disabled")||assetInputEvent(o,r,parseInt(o.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[1])+1),c.stopPropagation(),c.preventDefault();break}else if(u==="replace"){Xp(e,n,!1),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item__toggle")){d.parentElement.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")){if(d.getAttribute("data-type")==="search-new")newFileByName(t,a.value);else if(d.getAttribute("data-type")==="search-item"){const f=d.getAttribute("data-node-id");f?(window.siyuan.mobile.editor?.protyle&&preventScroll(window.siyuan.mobile.editor.protyle),checkFold(f,g=>{openMobileFileById(t,f,g?[Constants.CB_GET_ALL,Constants.CB_GET_HL]:[Constants.CB_GET_HL,Constants.CB_GET_CONTEXT,Constants.CB_GET_ROOTSCROLL])}),closePanel()):d.classList.contains("b3-list-item--focus")?d.classList.contains("b3-list-item--focus")&&renderNextAssetMark(e.querySelector("#searchAssetPreview")):(e.querySelector("#searchAssetList .b3-list-item--focus").classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus"),renderPreview(e.querySelector("#searchAssetPreview"),d.dataset.id,e.querySelector("#searchAssetInput").value,window.siyuan.storage[Constants.LOCAL_SEARCHASSET].method))}else d.querySelector(".b3-list-item__toggle")&&(d.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"));c.stopPropagation(),c.preventDefault();break}d=d.parentElement}},!1)},Pk=(t,e=window.siyuan.storage[Constants.LOCAL_SEARCHDATA])=>{activeBlur(),hideKeyboardToolbar();let n=!0,a=!1;e.idPath.forEach(i=>{i.endsWith(".sy")&&(n=!1),i.split("/").length>1&&(a=!0)}),openModel({title:`<div class="fn__flex">
    <input id="toolbarSearch" placeholder="${window.siyuan.languages.showRecentUpdatedBlocks}" class="toolbar__title fn__block">
    <svg id="toolbarSearchNew" class="toolbar__icon"><use xlink:href="#iconFile"></use></svg>
</div>`,icon:"iconSearch",html:`<div class="fn__flex-column" style="height: 100%">
    <div class="toolbar toolbar--border${e.hasReplace?"":" fn__none"}">
        <svg class="toolbar__icon"><use xlink:href="#iconReplace"></use></svg>
        <input id="toolbarReplace" class="toolbar__title">
        <svg class="fn__rotate fn__none toolbar__icon"><use xlink:href="#iconRefresh"></use></svg>
        <div class="fn__space"></div>
        <button data-type="replace-all" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replaceAll}</button>
        <div class="fn__space"></div>
        <button data-type="replace" class="b3-button b3-button--outline fn__flex-center">${window.siyuan.languages.replace}</button>
        <div class="fn__space"></div>
    </div>
    <div id="criteria" style="background-color: var(--b3-theme-background);"></div>
    <div class="toolbar">
        <span class="fn__space"></span>
        <span data-type="result" class="fn__flex-1 fn__flex"></span>
        <span class="fn__space"></span>
        <svg data-type="previous" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
        <svg data-type="next" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
    </div>
    <div id="searchList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
    <div id="searchPath" class="b3-chips${e.hPath?"":" fn__none"}" style="background-color: var(--b3-theme-background);">
        <div class="b3-chip b3-chip--middle">
            ${escapeHtml(e.hPath)}
            <svg data-type="remove-path" class="b3-chip__close"><use xlink:href="#iconCloseRound"></use></svg>
        </div>
    </div>
    <div class="toolbar">
        <span class="fn__flex-1"></span>
        <svg data-type="toggle-replace" class="toolbar__icon${e.hasReplace?" toolbar__icon--active":""}"><use xlink:href="#iconReplace"></use></svg>
        <svg ${a?"":"disabled"} data-type="include" class="toolbar__icon${n?" toolbar__icon--active":""}"><use xlink:href="#iconCopy"></use></svg>
        <svg data-type="path" class="toolbar__icon"><use xlink:href="#iconFolder"></use></svg>
        <svg ${document.querySelector("#empty").classList.contains("fn__none")?"":"disabled"} data-type="currentPath" class="toolbar__icon"><use xlink:href="#iconFocus"></use></svg>
        <svg data-type="expand" class="toolbar__icon${e.group===0?" fn__none":""}"><use xlink:href="#iconExpand"></use></svg>
        <svg data-type="contract" class="toolbar__icon${e.group===0?" fn__none":""}"><use xlink:href="#iconContract"></use></svg>
        <svg data-type="more" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
        <svg data-type="goAsset" class="toolbar__icon"><use xlink:href="#iconExact"></use></svg>
        <span class="fn__flex-1"></span>
     </div>
     <div class="fn__none fn__flex-column" style="position: fixed;top: 0;width: 100%;background: var(--b3-theme-surface);height: 100%;" id="searchAssetsPanel">
        <div class="toolbar toolbar--border">
            <svg class="toolbar__icon"><use xlink:href="#iconSearch"></use></svg>
            <input id="searchAssetInput" placeholder="${window.siyuan.languages.keyword}" class="toolbar__title fn__block">
        </div>
        <div class="toolbar">
            <span class="fn__space"></span>
            <span id="searchAssetResult" class="fn__flex-1 fn__flex"><span class="fn__flex-1"></span></span>
            <span class="fn__space"></span>
            <svg data-type="assetPrevious" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconLeft"></use></svg>
            <svg data-type="assetNext" disabled="disabled" class="toolbar__icon"><use xlink:href="#iconRight"></use></svg>
        </div>
        <div id="searchAssetList" style="overflow:auto;" class="fn__flex-1 b3-list b3-list--background"></div>
        <div id="searchAssetPreview" class="fn__flex-1 search__preview b3-typography" style="padding: 8px;border-bottom: 1px solid var(--b3-border-color);"></div>
        <div class="toolbar">
            <span class="fn__flex-1"></span>
            <svg data-type="queryAsset" class="toolbar__icon"><use xlink:href="#iconRegex"></use></svg>
            <svg data-type="filterAsset" class="toolbar__icon"><use xlink:href="#iconFilter"></use></svg>
            <svg data-type="moreAsset" class="toolbar__icon"><use xlink:href="#iconMore"></use></svg>
            <svg data-type="goSearch" class="toolbar__icon"><use xlink:href="#iconBack"></use></svg>
            <span class="fn__flex-1"></span>
         </div>
    </div>
     <div class="fn__loading fn__loading--top"><img width="120px" src="/stage/loading-pure.svg"></div>
</div>`,bindEvent(i){document.querySelector("#toolbarSearchNew").addEventListener("click",()=>{newFileByName(t,document.querySelector("#toolbarSearch").value)}),Wy(t,i.firstElementChild,e),Tn(e,i)}})},Vy=()=>{const t=document.querySelector("#searchAssetsPanel");if(t.classList.remove("fn__none"),t.querySelector("#searchAssetList").innerHTML)return;const n=window.siyuan.storage[Constants.LOCAL_SEARCHASSET],a=t.querySelector("input");a.value=n.k,a.addEventListener("compositionend",i=>{i.isComposing||assetInputEvent(t,n)}),a.addEventListener("input",i=>{i.isComposing||assetInputEvent(t,n)}),assetInputEvent(t,n),addClearButton({inputElement:a,className:"toolbar__icon",clearCB(){assetInputEvent(t,n)}})},Mk=t=>{fetchPost("/api/storage/getRecentDocs",{},e=>{let n="";e.data.forEach((a,i)=>{n+=`<li data-index="${i}" data-node-id="${a.rootID}" class="b3-list-item${i===0?" b3-list-item--focus":""}">
${unicode2Emoji(a.icon||Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${escapeHtml(a.title)}</span>
</li>`}),openModel({title:window.siyuan.languages.recentDocs,icon:"iconList",html:`<ul class="b3-list b3-list--mobile">${n}</ul>`,bindEvent(a){a.firstElementChild.addEventListener("click",i=>{const s=hasClosestByClassName(i.target,"b3-list-item");s&&openMobileFileById(t,s.dataset.nodeId,[Constants.CB_GET_SCROLL,Constants.CB_GET_HL])})}})})},Td=(t,e)=>{if(!t||t.length===0)return`<li style="padding-left: 40px;" class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;let n="";return t.forEach((a,i)=>{let s="";e&&(s=`data-id2="${e[i].fileID}"`),n+=`<li style="padding-left: 40px;" class="b3-list-item" ${s} data-id="${a.fileID}">
    <span class="b3-list-item__text" title="${Ba(a.path)} ${a.hSize}">${we(a.title)}</span>
</li>`}),n};let Ei,us;const zy=(t,e)=>{const n=A(e,"history__diff");if(!n)return;const a=A(e,"b3-dialog__container");if(!a)return;const i=n.nextElementSibling.firstElementChild,s=n.nextElementSibling.lastElementChild;Ei||(Ei=new pn(t,i.lastElementChild,{blockId:"",history:{snapshot:""},action:[p.Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),ia(Ei.protyle),us=new pn(t,s.lastElementChild,{blockId:"",action:[p.Constants.CB_GET_HISTORY],history:{snapshot:""},render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),ia(us.protyle)),w("/api/repo/openRepoSnapshotDoc",{id:e.getAttribute("data-id")},l=>{i.classList.remove("fn__none");const r=i.querySelector("textarea"),c=Le().extname(l.data.content).toLowerCase();p.Constants.SIYUAN_ASSETS_IMAGE.concat(p.Constants.SIYUAN_ASSETS_AUDIO).concat(p.Constants.SIYUAN_ASSETS_VIDEO).includes(c)?(r.previousElementSibling.innerHTML=_i(l.data.content),r.previousElementSibling.classList.remove("fn__none"),r.classList.add("fn__none"),i.lastElementChild.classList.add("fn__none")):l.data.isProtyleDoc?(r.value=l.data.content,r.classList.remove("fn__none"),i.lastElementChild.classList.add("fn__none"),r.previousElementSibling.classList.add("fn__none")):(r.classList.add("fn__none"),i.lastElementChild.classList.remove("fn__none"),r.previousElementSibling.classList.add("fn__none"),Ei.protyle.options.history.snapshot=a.querySelector(".b3-dialog__header code").getAttribute("data-snapshot"),st({data:l,protyle:Ei.protyle,action:[p.Constants.CB_GET_HISTORY,p.Constants.CB_GET_HTML]})),i.querySelector(".history__date").textContent=Q(l.data.updated).format("YYYY-MM-DD HH:mm")});const o=e.getAttribute("data-id2");o?(s.classList.remove("fn__none"),w("/api/repo/openRepoSnapshotDoc",{id:o},l=>{const r=s.querySelector("textarea"),c=Le().extname(l.data.content).toLowerCase();p.Constants.SIYUAN_ASSETS_IMAGE.concat(p.Constants.SIYUAN_ASSETS_AUDIO).concat(p.Constants.SIYUAN_ASSETS_VIDEO).includes(c)?(r.previousElementSibling.innerHTML=_i(l.data.content),r.previousElementSibling.classList.remove("fn__none"),r.classList.add("fn__none"),s.lastElementChild.classList.add("fn__none")):l.data.isProtyleDoc?(r.value=l.data.content,r.classList.remove("fn__none"),s.lastElementChild.classList.add("fn__none"),r.previousElementSibling.classList.add("fn__none")):(r.classList.add("fn__none"),s.lastElementChild.classList.remove("fn__none"),r.previousElementSibling.classList.add("fn__none"),us.protyle.options.history.snapshot=a.querySelectorAll(".b3-dialog__header code")[1].getAttribute("data-snapshot"),st({data:l,protyle:us.protyle,action:[p.Constants.CB_GET_HISTORY,p.Constants.CB_GET_HTML]})),s.querySelector(".history__date").textContent=Q(l.data.updated).format("YYYY-MM-DD HH:mm")})):s.classList.add("fn__none")},Yy=(t,e)=>{if(e.length!==2)return;let n,a;e[0].time>e[1].time?(n=e[1].id,a=e[0].id):(n=e[0].id,a=e[1].id);const i=new me({title:window.siyuan.languages.compare,content:"",width:(0,I.tq)()?"92vw":"90vw",height:"80vh",destroyCallback(){Ei=void 0,us=void 0}});i.element.addEventListener("click",s=>{let o=s.target;for(;o&&o!==i.element;){if(o.classList.contains("b3-list-item")&&!o.dataset.id){o.nextElementSibling.classList.toggle("fn__none"),o.querySelector("svg").classList.toggle("b3-list-item__arrow--open"),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("b3-list-item")&&o.dataset.id){if(o.classList.contains("b3-list-item--focus"))return;i.element.querySelector(".history__diff .b3-list-item--focus")?.classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),zy(t,o),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("block__icon")){o.getAttribute("data-direct")==="left"?(o.setAttribute("data-direct","right"),Id(a,n,i,"right")):(o.setAttribute("data-direct","left"),Id(n,a,i,"left")),s.preventDefault(),s.stopPropagation();break}o=o.parentElement}}),Id(n,a,i,"left")},Id=(t,e,n,a)=>{Ei=void 0,us=void 0;const i=(0,I.tq)();w("/api/repo/diffRepoSnapshots",{left:t,right:e},s=>{const o=n.element.querySelector(".b3-dialog__header");o.innerHTML=`<div style="padding: 0;min-height: auto;" class="block__icons">
    <span class="fn__flex-1"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${t}">${t.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${Q(s.data.left.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__space"></span>
    <span class="block__icon block__icon--show b3-tooltips b3-tooltips__s" aria-label="${window.siyuan.languages.switchDirect}" data-direct="${a}"><svg><use xlink:href="#iconScrollHoriz"></use></svg></span>
    <span class="fn__space"></span>
    <code class="fn__code${i?" fn__none":""}" data-snapshot="${e}">${e.substring(0,7)}</code>
    ${i?"":'<span class="fn__space"></span>'}
    ${Q(s.data.right.created).format("YYYY-MM-DD HH:mm")}
    <span class="fn__flex-1"></span>
</div>`,o.nextElementSibling.innerHTML=`<div class="fn__flex history__panel" style="height: 100%">
    <div class="history__diff">
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.update}</span>
                <span class="counter${s.data.updatesLeft.length===0?" fn__none":""}">${s.data.updatesLeft.length}</span>
            </li>
            <ul class="fn__none">${Td(s.data.updatesLeft,s.data.updatesRight)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.addAttr}</span>
                <span class="counter${s.data.addsLeft.length===0?" fn__none":""}">${s.data.addsLeft.length}</span>
            </li>
            <ul class="fn__none">${Td(s.data.addsLeft)}</ul>
        </ul>
        <ul class="b3-list b3-list--background">
            <li class="b3-list-item">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span style="padding-left: 4px" class="b3-list-item__text">${window.siyuan.languages.remove}</span>
                <span class="counter${s.data.removesRight.length===0?" fn__none":""}">${s.data.removesRight.length}</span>
            </li>
            <ul class="fn__none">${Td(s.data.removesRight)}</ul>
        </ul>
    </div>
    <div class="fn__flex-1 fn__flex">
        <div class="fn__none fn__flex-1 fn__flex-column">
            <div class="history__date">${Q(s.data.left.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
        <div class="fn__none fn__flex-1 fn__flex-column" style="border-left: 1px solid var(--b3-border-color);">
            <div class="history__date">${Q(s.data.right.created).format("YYYY-MM-DD HH:mm")}</div>
            <div class="ft__center"></div>
            <textarea class="history__text fn__none fn__flex-1" readonly></textarea>
            <div class="fn__flex-1"></div>
        </div>
    </div>
</div>`})},ng=t=>{const e=document.getElementById("model");e.style.transform="translateY(0px)",e.querySelector(".toolbar__icon use").setAttribute("xlink:href","#"+t.icon),e.querySelector(".toolbar__text").innerHTML=t.title;const n=e.querySelector("#modelMain");n.innerHTML=t.html,t.bindEvent(n)};let fs;const ho=(t,e)=>{const n=t.querySelector('[data-type="docprevious"]'),a=t.querySelector('[data-type="docnext"]');t.setAttribute("data-page",e.toString()),e>1?n.removeAttribute("disabled"):n.setAttribute("disabled","disabled");const i=t.querySelector(".b3-text-field"),s=t.querySelector('.b3-select[data-type="opselect"]'),o=t.querySelector('.b3-select[data-type="typeselect"]'),l=t.querySelector('.b3-select[data-type="notebookselect"]');window.siyuan.storage[p.Constants.LOCAL_HISTORYNOTEID]=l.value,pe(p.Constants.LOCAL_HISTORYNOTEID,window.siyuan.storage[p.Constants.LOCAL_HISTORYNOTEID]);const r=t.querySelector('.history__text[data-type="docPanel"]'),c=t.querySelector('.history__text[data-type="assetPanel"]'),d=t.querySelector('.history__text[data-type="mdPanel"]');r.classList.add("fn__none"),d.classList.add("fn__none"),o.value==="0"||o.value==="1"?(s.removeAttribute("disabled"),l.removeAttribute("disabled"),c.classList.add("fn__none")):(s.setAttribute("disabled","disabled"),l.setAttribute("disabled","disabled"),c.classList.remove("fn__none")),w("/api/history/searchHistory",{notebook:l.value,query:i.value,page:e,op:s.value,type:parseInt(o.value)},u=>{if(e<u.data.pageCount?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),a.nextElementSibling.nextElementSibling.textContent=`${e}/${u.data.pageCount||1}`,u.data.histories.length===0){t.lastElementChild.lastElementChild.previousElementSibling.classList.add("fn__none"),t.lastElementChild.lastElementChild.classList.add("fn__none"),t.lastElementChild.firstElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let f="";u.data.histories.forEach(g=>{f+=`<li class="b3-list-item" data-type="toggle" data-created="${g}">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
    <span style="padding-left: 4px" class="b3-list-item__text">${Q(parseInt(g)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
</li>`}),t.lastElementChild.firstElementChild.innerHTML=f})},ag=(t,e,n)=>{if(t.data.snapshots.length===0){e.lastElementChild.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let a="";n==="getCloudRepoTagSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="downloadSnapshot" aria-label="${window.siyuan.languages.download}"><svg><use xlink:href="#iconDownload"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeCloudRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:n==="getCloudRepoSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="downloadSnapshot" aria-label="${window.siyuan.languages.download}"><svg><use xlink:href="#iconDownload"></use></svg></span>`:n==="getRepoTagSnapshots"?a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="uploadSnapshot" aria-label="${window.siyuan.languages.upload}"><svg><use xlink:href="#iconUpload"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="removeRepoTagSnapshot" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>`:n==="getRepoSnapshots"&&(a=`<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="genTag" aria-label="${window.siyuan.languages.tagSnapshot}"><svg><use xlink:href="#iconTags"></use></svg></span>
<span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}"><svg><use xlink:href="#iconUndo"></use></svg></span>`);let i="";const s=(0,I.tq)();t.data.snapshots.forEach(o=>{let l="";o.typesCount&&(l=`<div class="b3-list-item__meta${s?" fn__none":""}">
${window.siyuan.languages.fileCount} ${o.count}<span class="fn__space"></span>`,o.typesCount.forEach(c=>{l+=`${c.type} ${c.count}<span class="fn__space"></span>`}),l+="</div>");const r=`<div${s?' style="padding-top:8px"':""}>
    <span data-type="hCreated">${o.hCreated}</span>
    <span class="fn__space"></span>
    ${o.hSize}
    <span class="fn__space"></span>
    ${o.systemOS}${o.systemName&&o.systemOS?"/":""}${o.systemName}
    <span class="fn__space"></span>
    <span class="b3-chip b3-chip--secondary b3-chip--small${o.tag?"":" fn__none"}">${o.tag}</span>
</div>
<div class="b3-list-item__meta${s?" fn__none":""}">
    ${we(o.memo)}
    <span class="fn__space"></span>
    <code class="fn__code">${o.id.substring(0,7)}</code>
</div>
${l}`;i+=`<li class="b3-list-item b3-list-item--hide-action" data-type="repoitem" data-id="${o.id}" data-tag="${o.tag}">
<div class="fn__flex-1">${r}</div>
${a}
</li>`}),e.lastElementChild.innerHTML=`${i}`},ki=(t,e)=>{const n=t.querySelector(".b3-select").value;t.lastElementChild.innerHTML='<li style="position: relative;height: 100%;"><div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div></li>';const a=t.querySelector('[data-type="previous"]'),i=t.querySelector('[data-type="next"]'),s=i.nextElementSibling.nextElementSibling;t.setAttribute("data-init","true"),n==="getRepoTagSnapshots"||n==="getCloudRepoTagSnapshots"?(w(`/api/repo/${n}`,{},o=>{ag(o,t,n)}),a.classList.add("fn__none"),i.classList.add("fn__none"),s.classList.add("fn__none")):(a.classList.remove("fn__none"),i.classList.remove("fn__none"),s.classList.remove("fn__none"),t.setAttribute("data-page",e.toString()),e>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled"),i.setAttribute("disabled","disabled"),w(`/api/repo/${n}`,{page:e},o=>{e<o.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),s.textContent=`${e}/${o.data.pageCount||1}`,ag(o,t,n)}))},Gy=t=>{t.setAttribute("data-init","true"),w("/api/history/getNotebookHistory",{},e=>{if(e.data.histories.length===0){t.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let n="";e.data.histories.forEach((a,i)=>{n+=`<li class="b3-list-item" style="padding-left: 0" data-type="rmtoggle">
    <span style="padding-left: 8px" class="b3-list-item__toggle"><svg class="b3-list-item__arrow${i===0?" b3-list-item__arrow--open":""}${a.items.length>0?"":" fn__hidden"}"><use xlink:href="#iconRight"></use></svg></span>
    <span class="b3-list-item__text">${a.hCreated}</span>
</li>`,a.items.length>0&&(n+=`<ul class="${i===0?"":"fn__none"}">`,a.items.forEach(s=>{n+=`<li data-type="notebook" data-path="${s.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 32px">
    <span class="b3-list-item__text">${we(s.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),n+="</ul>")}),t.innerHTML=n})},Dd=t=>{if(window.siyuan.config.readonly||window.siyuan.dialogs.find(i=>{if(i.element.querySelector("#historyContainer"))return i.destroy(),!0}))return;let n="";window.siyuan.notebooks.forEach(i=>{i.closed||(n+=` <option value="${i.id}"${i.id===window.siyuan.storage[p.Constants.LOCAL_HISTORYNOTEID]?" selected":""}>${we(i.name)}</option>`)});const a=`<div class="fn__flex-column" style="height: 100%;">
    <div class="layout-tab-bar fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div data-type="doc" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.fileHistory}</span><span class="fn__flex-1"></span></div>
        <div data-type="notebook" style="min-width: 160px" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.removedNotebook}</span><span class="fn__flex-1"></span></div>
        <div data-type="repo" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.dataSnapshot}</span><span class="fn__flex-1"></span></div>
    </div>
    <div class="fn__flex-1 fn__flex" id="historyContainer">
        <div data-type="doc" class="history__repo fn__block" data-init="true">
            <div style="overflow:auto;">
                <div class="block__icons">
                    <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <div style="position: relative">
                        <svg class="b3-form__icon-icon ft__on-surface"><use xlink:href="#iconSearch"></use></svg>
                        <input class="b3-text-field b3-form__icon-input ${(0,I.tq)()?"fn__size96":"fn__size200"}">
                    </div>
                    <span class="fn__space"></span>
                    <select data-type="typeselect" class="b3-select ${(0,I.tq)()?"fn__size96":"fn__size200"}">
                        <option value="0" selected>${window.siyuan.languages.docName}</option>
                        <option value="1">${window.siyuan.languages.docNameAndContent}</option>
                        <option value="2">${window.siyuan.languages.assets}</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="opselect" class="b3-select${(0,I.tq)()?" fn__size96":""}">
                        <option value="all" selected>${window.siyuan.languages.allOp}</option>
                        <option value="clean">clean</option>
                        <option value="update">update</option>
                        <option value="delete">delete</option>
                        <option value="format">format</option>
                        <option value="sync">sync</option>
                        <option value="replace">replace</option>
                    </select>
                    <span class="fn__space"></span>
                    <select data-type="notebookselect" class="b3-select ${(0,I.tq)()?"fn__size96":"fn__size200"}">
                        ${n}
                    </select>
                    <span class="fn__space"></span>
                    <button data-type="rebuildIndex" class="b3-button b3-button--outline">${window.siyuan.languages.rebuildIndex}</button>
                </div>
            </div>
            <div class="fn__flex fn__flex-1 history__panel">
                <ul class="b3-list b3-list--background" style="overflow:auto;">
                    <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
                </ul>
                <div class="fn__flex-1 history__text fn__none" data-type="assetPanel"></div>
                <textarea class="fn__flex-1 history__text fn__none" data-type="mdPanel"></textarea>
                <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
            </div>
        </div>
        <ul data-type="notebook" style="padding: 8px 0;" class="fn__none b3-list b3-list--background">
            <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
        </ul>
        <div data-type="repo" class="fn__none history__repo">
            <div style="overflow: auto"">
                <div class="block__icons">
                    <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
                    <span class="fn__space"></span>
                    <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
                    <span class="fn__space"></span>
                    <span>1/1</span>
                    <span class="fn__space"></span>
                    <div class="fn__flex-1"></div>
                    <select class="b3-select ${(0,I.tq)()?"fn__size96":"fn__size200"}">
                        <option value="getRepoSnapshots">${window.siyuan.languages.localSnapshot}</option>
                        <option value="getRepoTagSnapshots">${window.siyuan.languages.localTagSnapshot}</option>
                        <option value="getCloudRepoSnapshots">${window.siyuan.languages.cloudSnapshot}</option>
                        <option value="getCloudRepoTagSnapshots">${window.siyuan.languages.cloudTagSnapshot}</option>
                    </select>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" disabled data-type="compare">${window.siyuan.languages.compare}</button>
                    <span class="fn__space"></span>
                    <button class="b3-button b3-button--outline" data-type="genRepo">
                        <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.createSnapshot}
                    </button>
                </div>    
            </div>
            <ul class="b3-list b3-list--background fn__flex-1" style="padding-bottom: 8px">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
        </div>
    </div>
</div>`;if((0,I.tq)())ng({html:a,icon:"iconHistory",title:window.siyuan.languages.dataHistory,bindEvent(i){ig(t,i.firstElementChild)}});else{const i=new me({content:a,width:"90vw",height:"80vh",destroyCallback(){fs=void 0}});ig(t,i.element,i)}},ig=(t,e,n)=>{const a=e.querySelector("#historyContainer [data-type=doc]");a.querySelectorAll(".b3-select").forEach(c=>{c.addEventListener("change",()=>{ho(a,1)})}),a.querySelector(".b3-text-field").addEventListener("input",c=>{c.isComposing||ho(a,1)}),a.querySelector(".b3-text-field").addEventListener("compositionend",()=>{ho(a,1)});const i=a.querySelector('.history__text[data-type="docPanel"]'),s=a.querySelector('.history__text[data-type="assetPanel"]'),o=a.querySelector('.history__text[data-type="mdPanel"]');ho(a,1),fs=new pn(t,i,{blockId:"",history:{created:""},action:[p.Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),ia(fs.protyle);const l=e.querySelector('#historyContainer [data-type="repo"]'),r=l.querySelector(".b3-select");r.addEventListener("change",()=>{ki(l,1);const c=e.querySelector(".b3-button[data-type='compare']");c.setAttribute("disabled","disabled"),c.removeAttribute("data-ids")}),e.addEventListener("click",c=>{let d=c.target;for(;d&&!d.isEqualNode(e);){const u=d.getAttribute("data-type");if(d.classList.contains("item")){d.parentElement.querySelector(".item--focus").classList.remove("item--focus"),Array.from(e.querySelector("#historyContainer").children).forEach(f=>{f.getAttribute("data-type")===u?(f.classList.remove("fn__none"),f.classList.add("fn__block"),d.classList.add("item--focus"),f.getAttribute("data-init")!=="true"&&(u==="notebook"?Gy(f):u==="repo"&&ki(f,1))):(f.classList.add("fn__none"),f.classList.remove("fn__block"))}),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item__action")&&u==="rollback"&&!window.siyuan.config.readonly){Ne("\u26A0\uFE0F "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",d.parentElement.textContent.trim())}`,()=>{const f=d.parentElement.getAttribute("data-type");f==="assets"?w("/api/history/rollbackAssetsHistory",{historyPath:d.parentElement.getAttribute("data-path")}):f==="doc"?w("/api/history/rollbackDocHistory",{notebook:a.querySelector('.b3-select[data-type="notebookselect"]').value,historyPath:d.parentElement.getAttribute("data-path")}):f==="notebook"?w("/api/history/rollbackNotebookHistory",{historyPath:d.parentElement.getAttribute("data-path")}):w("/api/repo/checkoutRepo",{id:d.parentElement.getAttribute("data-id")})}),c.stopPropagation(),c.preventDefault();break}else if(u==="more"){d.parentElement.parentElement.querySelectorAll(".b3-list-item__meta").forEach(f=>{f.classList.toggle("fn__none")}),c.stopPropagation(),c.preventDefault();break}else if(u==="toggle"){const f=d.firstElementChild.firstElementChild;if(f.classList.contains("b3-list-item__arrow--open"))d.nextElementSibling.classList.add("fn__none"),f.classList.remove("b3-list-item__arrow--open");else if(d.nextElementSibling&&d.nextElementSibling.tagName==="UL")d.nextElementSibling.classList.remove("fn__none"),f.classList.add("b3-list-item__arrow--open");else{const g=a.querySelector(".b3-text-field"),h=a.querySelector('.b3-select[data-type="opselect"]'),m=a.querySelector('.b3-select[data-type="typeselect"]'),b=a.querySelector('.b3-select[data-type="notebookselect"]'),y=d.getAttribute("data-created");w("/api/history/getHistoryItems",{notebook:b.value,query:g.value,op:h.value,type:parseInt(m.value),created:y},_=>{f.classList.add("b3-list-item__arrow--open");let v="";_.data.items.forEach(k=>{v+=`<li title="${Ba(k.title)}" data-created="${y}" data-type="${m.value==="2"?"assets":"doc"}" data-path="${k.path}" class="b3-list-item b3-list-item--hide-action" style="padding-left: 40px">
    <span class="b3-list-item__text">${we(k.title)}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),d.insertAdjacentHTML("afterend",`<ul>${v}</ul>`)})}c.stopPropagation(),c.preventDefault();break}else if(u==="rmtoggle"){d.nextElementSibling.classList.toggle("fn__none"),d.firstElementChild.firstElementChild.classList.toggle("b3-list-item__arrow--open"),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")&&u==="repoitem"&&["getRepoSnapshots","getRepoTagSnapshots"].includes(r.value)){const f=e.querySelector(".b3-button[data-type='compare']"),g=JSON.parse(f.getAttribute("data-ids")||"[]"),h=d.getAttribute("data-id");if(d.classList.contains("b3-list-item--focus"))d.classList.remove("b3-list-item--focus"),g.forEach((m,b)=>{h===m.id&&g.splice(b,1)});else{for(d.classList.add("b3-list-item--focus");g.length>1;)g[0].id!==h&&d.parentElement.querySelector(`.b3-list-item[data-id="${g.splice(0,1)[0].id}"]`)?.classList.remove("b3-list-item--focus");g.push({id:h,time:d.querySelector('[data-type="hCreated"]').textContent})}g.length===2?f.removeAttribute("disabled"):f.setAttribute("disabled","disabled"),f.setAttribute("data-ids",JSON.stringify(g)),c.stopPropagation(),c.preventDefault();break}else if(d.classList.contains("b3-list-item")&&(u==="assets"||u==="doc")){const f=d.getAttribute("data-path");u==="assets"?s.innerHTML=_i(f):u==="doc"&&w("/api/history/getDocHistoryContent",{historyPath:f,k:a.querySelector(".b3-text-field").value},h=>{h.data.isLargeDoc?(o.value=h.data.content,o.classList.remove("fn__none"),i.classList.add("fn__none")):(o.classList.add("fn__none"),i.classList.remove("fn__none"),fs.protyle.options.history.created=d.dataset.created,st({data:h,protyle:fs.protyle,action:[p.Constants.CB_GET_HISTORY,p.Constants.CB_GET_HTML]}))});let g=A(d,"b3-list");g&&(g=g.querySelector(".b3-list-item--focus"),g&&g.classList.remove("b3-list-item--focus")),d.classList.add("b3-list-item--focus"),c.stopPropagation(),c.preventDefault();break}else if(u==="genRepo"){const f=new me({title:window.siyuan.languages.snapshotMemo,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.snapshotMemoTip}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),g=f.element.querySelector("textarea");g.focus();const h=f.element.querySelectorAll(".b3-button");f.bindInput(g,()=>{h[1].click()}),h[0].addEventListener("click",()=>{f.destroy()}),h[1].addEventListener("click",()=>{w("/api/repo/createSnapshot",{memo:g.value},()=>{ki(l,1)}),f.destroy()}),c.stopPropagation(),c.preventDefault();break}else if(u==="removeRepoTagSnapshot"||u==="removeCloudRepoTagSnapshot"){const f=d.parentElement.getAttribute("data-tag");Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <i>${f}</i>?`,()=>{w("/api/repo/"+u,{tag:f},()=>{ki(l,1)})}),c.stopPropagation(),c.preventDefault();break}else if(u==="uploadSnapshot"){w("/api/repo/uploadCloudSnapshot",{tag:d.parentElement.getAttribute("data-tag"),id:d.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(u==="downloadSnapshot"){w("/api/repo/downloadCloudSnapshot",{tag:d.parentElement.getAttribute("data-tag"),id:d.parentElement.getAttribute("data-id")}),c.stopPropagation(),c.preventDefault();break}else if(u==="genTag"){const f=new me({title:window.siyuan.languages.tagSnapshot,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="${Q().format("YYYYMMDDHHmmss")}" placeholder="${window.siyuan.languages.tagSnapshotTip}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshot}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.tagSnapshotUpload}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),g=f.element.querySelector(".b3-text-field");g.select();const h=f.element.querySelectorAll(".b3-button");h[0].addEventListener("click",()=>{f.destroy()}),h[2].addEventListener("click",()=>{w("/api/repo/tagSnapshot",{id:d.parentElement.getAttribute("data-id"),name:g.value},()=>{w("/api/repo/uploadCloudSnapshot",{tag:g.value,id:d.parentElement.getAttribute("data-id")},()=>{ki(l,1)})}),f.destroy()}),h[1].addEventListener("click",()=>{w("/api/repo/tagSnapshot",{id:d.parentElement.getAttribute("data-id"),name:g.value},()=>{ki(l,1)}),f.destroy()}),c.stopPropagation(),c.preventDefault();break}else if((u==="previous"||u==="next")&&d.getAttribute("disabled")!=="disabled"){const f=parseInt(l.getAttribute("data-page"));ki(l,u==="previous"?f-1:f+1),c.stopPropagation(),c.preventDefault();break}else if((u==="docprevious"||u==="docnext")&&d.getAttribute("disabled")!=="disabled"){const f=parseInt(a.getAttribute("data-page"));ho(a,u==="docprevious"?f-1:f+1),c.stopPropagation(),c.preventDefault();break}else if(u==="rebuildIndex"){w("/api/history/reindexHistory"),n?n.destroy():(a_(),fs=void 0),c.stopPropagation(),c.preventDefault();break}else if(u==="compare"&&!d.getAttribute("disabled")){Yy(t,JSON.parse(d.getAttribute("data-ids")||"[]")),c.stopPropagation(),c.preventDefault();break}d=d.parentElement}})},Nk=t=>{setTitle(window.siyuan.languages.siyuanNote),document.getElementById("toolbarName").classList.add("fn__hidden"),document.getElementById("editor").classList.add("fn__none");const e=document.getElementById("empty");e.classList.remove("fn__none"),e.innerHTML===""&&(e.innerHTML=`<div id="emptySearch" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.search}</span>
</div>
<div id="emptyRecent" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.recentDocs}</span>
</div>
<div id="emptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.dataHistory}</span>
</div>
<div id="emptyNewFile" class="b3-list-item${getOpenNotebookCount()>0||!window.siyuan.config.readonly?"":" fn__none"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newFile}</span>
</div>
<div class="b3-list-item" id="emptyNewNotebook${window.siyuan.config.readonly?" fn__none":""}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.newNotebook}</span>
</div>
<div class="b3-list-item" id="emptyHelp">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg><span class="fn__space"></span><span class="b3-list-item__text">${window.siyuan.languages.help}</span>
</div>`,e.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e);){if(a.id==="emptySearch"){popSearch(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyRecent"){getRecentDocs(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHistory"){openHistory(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewFile"){newFile({app:t,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyNewNotebook"){newNotebook(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="emptyHelp"){mountHelp(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}))},jy=()=>{const t=document.getElementById("toolbarName");Bo(t.value),t.classList.remove("fn__hidden"),document.getElementById("editor").classList.remove("fn__none"),document.getElementById("empty").classList.add("fn__none")},tr=()=>window.siyuan.mobile.popEditor||window.siyuan.mobile.editor,Ky=(t,e,n=[p.Constants.CB_GET_HL])=>{if(window.siyuan.storage[p.Constants.LOCAL_DOCINFO]={id:e},pe(p.Constants.LOCAL_DOCINFO,window.siyuan.storage[p.Constants.LOCAL_DOCINFO]),window.siyuan.mobile.editor){cs(window.siyuan.mobile.editor.protyle),X(["toolbar","hint","util"],window.siyuan.mobile.editor.protyle),window.siyuan.mobile.editor.protyle.contentElement.classList.contains("fn__none")&&Di(window.siyuan.mobile.editor.protyle,"wysiwyg");let a;if(Array.from(window.siyuan.mobile.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e}"]`)).find(i=>{if(!q(i.parentElement,"data-type","NodeBlockQueryEmbed"))return a=i,!0}),a){Hd(),He(window.siyuan.mobile.editor.protyle,a,!0),cg();return}}w("/api/block/getBlockInfo",{id:e},a=>{if(a.code===3){M(a.msg);return}const i={blockId:e,rootId:a.data.rootID,action:n,render:{scroll:!0,background:!0,gutter:!0},typewriterMode:!0,preview:{actions:["mp-wechat","zhihu"]}};window.siyuan.mobile.editor?(Hd(),$i(window.siyuan.mobile.editor.protyle),n.includes(p.Constants.CB_GET_SCROLL)&&window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION][a.data.rootID]?Sd({protyle:window.siyuan.mobile.editor.protyle,scrollAttr:window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION][a.data.rootID],mergedOptions:i}):w("/api/filetree/getDoc",{id:e,size:n.includes(p.Constants.CB_GET_ALL)?p.Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks,mode:n.includes(p.Constants.CB_GET_CONTEXT)?3:0},s=>{st({data:s,protyle:window.siyuan.mobile.editor.protyle,action:n})}),window.siyuan.mobile.editor.protyle.undo.clear()):window.siyuan.mobile.editor=new pn(t,document.getElementById("editor"),i),document.getElementById("toolbarName").value=a.data.rootTitle==="Untitled"?"":a.data.rootTitle,jy(),cg()})};class ps{constructor(e,n){this.element=document.createElement("button");const a=n.hotkey?` ${K(n.hotkey)}`:"",i=n.tip||window.siyuan.languages[n.lang];this.element.classList.add("protyle-toolbar__item","b3-tooltips",`b3-tooltips__${n.tipPosition}`),this.element.setAttribute("data-type",n.name),this.element.setAttribute("aria-label",i+a),this.element.innerHTML=`<svg><use xlink:href="#${n.icon}"></use></svg>`,!["text","a","block-ref","inline-math","inline-memo"].includes(n.name)&&this.element.addEventListener(z(),s=>{s.preventDefault(),e.toolbar.setInlineMark(e,n.name,"toolbar")})}}class Zy extends ps{constructor(e,n){super(e,n),this.element.addEventListener("click",()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append($d(e,sg(e))),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0,Z(e.toolbar.range);const a=$n(e.wysiwyg.element,e.toolbar.range);ke(e.toolbar.subElement,a.left,a.top+18,26)})}}const $d=(t,e)=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach(d=>{n+=`<button class="color__square" data-type="color" style="color:${d}">A</button>`});let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach(d=>{a+=`<button class="color__square" data-type="backgroundColor" style="background-color:${d}"></button>`});const i=document.createElement("div");i.classList.add("protyle-font");let s=!1;e?.find(d=>{if(d.classList.contains("list")||d.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES];l.length>0&&(o=`<div class="fn__flex">
    ${window.siyuan.languages.lastUsed}
    <span class="fn__space"></span>
    <kbd class="ft__on-surface fn__flex-center">${K(window.siyuan.config.keymap.editor.insert.lastUsed.custom)}</kbd>
</div>
<div class="fn__hr--small"></div>
<div class="fn__flex" style="align-items: center">`,l.forEach(d=>{const u=d.split(p.Constants.ZWSP);switch(u[0]){case"color":o+=`<button class="color__square" data-type="${u[0]}" style="color:${u[1]}">A</button>`;break;case"backgroundColor":o+=`<button class="color__square" data-type="${u[0]}" style="background-color:${u[1]}"></button>`;break;case"style2":o+=`<button data-type="${u[0]}" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>`;break;case"style4":o+=`<button data-type="${u[0]}" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>`;break;case"fontSize":s||(o+=`<button data-type="${u[0]}" class="protyle-font__style">${u[1]}</button>`);break;case"style1":o+=`<button data-type="${u[0]}" style="background-color:${u[1]};color:${u[2]}" class="color__square">A</button>`;break;case"clear":o+=`<button data-type="${u[0]}" class="protyle-font__style">${window.siyuan.languages.clearFontStyle}</button>`;break}}),o+="</div>");let r,c="16px";return e&&e.length>0?r=e[0]:(r=t.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=q(t.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px"),i.innerHTML=`${o}
<div class="fn__hr"></div>
<div>${window.siyuan.languages.color}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button class="color__square" data-type="style1" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</button>
    <button class="color__square" data-type="style1" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</button>
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorFont}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${n}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.colorPrimary}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    ${a}
</div>
<div class="fn__hr"></div>
<div>${window.siyuan.languages.fontStyle}</div>
<div class="fn__hr--small"></div>
<div class="fn__flex">
    <button data-type="style2" class="protyle-font__style" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</button>
    <button data-type="style4" class="protyle-font__style" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</button>
</div>
<div class="fn__hr${s?" fn__none":""}"></div>
<div class="${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="fn__hr--small${s?" fn__none":""}"></div>
<div class="fn__flex${s?" fn__none":""}">
    <select class="b3-select fn__block">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>
<div class="fn__hr"></div>
<button class="b3-button b3-button--cancel" data-type="clear">
    <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.clearFontStyle}
</button>`,i.addEventListener("click",function(d){let u=d.target;for(;u&&!u.isEqualNode(i);){const f=u.getAttribute("data-type");if(u.tagName==="BUTTON"){f==="style1"?Ga(t,e,f,u.style.backgroundColor+p.Constants.ZWSP+u.style.color):f==="fontSize"?Ga(t,e,f,u.textContent.trim()):f==="backgroundColor"?Ga(t,e,f,u.style.backgroundColor):f==="color"?Ga(t,e,f,u.style.color):Ga(t,e,f);break}u=u.parentElement}}),i.querySelector("select").addEventListener("change",function(d){Ga(t,e,"fontSize",d.target.value)}),i},Ga=(t,e,n,a)=>{let i=window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES];if(n)i.splice(0,0,`${n}${p.Constants.ZWSP}${a}`),i=[...new Set(i)],i.length>8&&i.splice(8,1),window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES]=i,pe(p.Constants.LOCAL_FONTSTYLES,window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES]);else if(i.length===0)n="style1",a="var(--b3-card-error-color)"+p.Constants.ZWSP+"var(--b3-card-error-background)";else{const s=i[0].split(p.Constants.ZWSP);n=s[0],a=s[1]}e&&e.length>0?(bs(e,t,s=>{if(n==="clear")s.style.color="",s.style.webkitTextFillColor="",s.style.webkitTextStroke="",s.style.textShadow="",s.style.backgroundColor="",s.style.fontSize="",s.classList.contains("av")&&s.querySelector(".av__container").setAttribute("style","--av-background:var(--b3-theme-background)");else if(n==="style1"){const o=a.split(p.Constants.ZWSP);s.style.backgroundColor=o[0],s.style.color=o[1],s.classList.contains("av")&&s.querySelector(".av__container").setAttribute("style",`--av-background:${o[0]}`)}else n==="style2"?(s.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",s.style.webkitTextFillColor="transparent"):n==="style4"?s.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)":n==="color"?s.style.color=a:n==="backgroundColor"?(s.style.backgroundColor=a,s.classList.contains("av")&&s.querySelector(".av__container").setAttribute("style",`--av-background:${a}`)):n==="fontSize"&&(s.style.fontSize=a);(n==="fontSize"||n==="clear")&&s.getAttribute("data-type")==="NodeCodeBlock"&&So(s.querySelector(".hljs"))}),Z(t.toolbar.range)):n==="clear"?t.toolbar.setInlineMark(t,"clear","range",{type:"text"}):t.toolbar.setInlineMark(t,"text","range",{type:n,color:a})},Pd=(t,e)=>{const n=s=>{const o=s.split(p.Constants.ZWSP);t.setAttribute("data-id",o.splice(0,1)[0]),t.setAttribute("data-subtype",o.splice(0,1)[0]),t.removeAttribute("data-href"),t.innerText=o.join("")},a=s=>{const o=s.split(p.Constants.ZWSP);t.setAttribute("data-href",o[0]),t.removeAttribute("data-subtype"),t.removeAttribute("data-id"),o[1]&&(t.textContent=o[1])},i=s=>{const o=s.split(p.Constants.ZWSP);t.setAttribute("data-id",o[0]),t.removeAttribute("data-href"),t.removeAttribute("data-subtype"),o[1]&&(t.textContent=o[1])};if(e)switch(e.type){case"color":t.style.color=e.color;break;case"fontSize":t.style.fontSize=e.color;break;case"backgroundColor":t.style.backgroundColor=e.color;break;case"style1":t.style.backgroundColor=e.color.split(p.Constants.ZWSP)[0],t.style.color=e.color.split(p.Constants.ZWSP)[1];break;case"style2":t.style.webkitTextStroke="0.2px var(--b3-theme-on-background)",t.style.webkitTextFillColor="transparent";break;case"style4":t.style.textShadow="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)";break;case"id":n(e.color);break;case"inline-math":t.className="render-node",t.setAttribute("contenteditable","false"),t.setAttribute("data-subtype","math"),t.setAttribute("data-content",t.textContent.replace(p.Constants.ZWSP,"")),t.removeAttribute("data-render"),t.textContent="";break;case"a":a(e.color);break;case"file-annotation-ref":i(e.color);break;case"inline-memo":t.removeAttribute("contenteditable"),t.removeAttribute("data-subtype"),t.removeAttribute("data-content");break}},gs=(t,e,n)=>{if(!n)return!0;if(n.type==="inline-math"||n.type==="inline-memo"||n.type==="a")return!1;if(n.type==="id"){if(t.nodeType!==3)return t.getAttribute("data-id")===e.getAttribute("data-id")&&t.getAttribute("data-subtype")===e.getAttribute("data-subtype")&&t.textContent===e.textContent;const c=n.color.split(p.Constants.ZWSP);return c[0]===e.getAttribute("data-id")&&c[1]===e.getAttribute("data-subtype")&&c[2]===e.textContent}if(n.type==="file-annotation-ref")return t.nodeType!==3?t.getAttribute("data-id")===e.getAttribute("data-id")&&t.textContent===e.textContent:n.color===e.getAttribute("data-id");let a="",i="",s="",o="",l="",r="";return t.nodeType!==3&&(a=t.style.color,i=t.style.webkitTextFillColor,s=t.style.webkitTextStroke,o=t.style.textShadow,l=t.style.backgroundColor,r=t.style.fontSize),n.type==="text"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:n.type==="color"?n.color===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:n.type==="backgroundColor"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&n.color===e.style.backgroundColor:n.type==="style1"?n.color.split(p.Constants.ZWSP)[0]===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&r===e.style.fontSize&&n.color.split(p.Constants.ZWSP)[1]===e.style.backgroundColor:n.type==="style2"?a===e.style.color&&e.style.webkitTextFillColor==="transparent"&&e.style.webkitTextStroke==="0.2px var(--b3-theme-on-background)"&&o===e.style.textShadow&&r===e.style.fontSize&&l===e.style.backgroundColor:n.type==="style4"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&r===e.style.fontSize&&e.style.textShadow==="1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)"&&l===e.style.backgroundColor:n.type==="fontSize"?a===e.style.color&&i===e.style.webkitTextFillColor&&s===e.style.webkitTextStroke&&o===e.style.textShadow&&n.color===e.style.fontSize&&l===e.style.backgroundColor:!0},sg=t=>{let e;if(t.toolbar.range.toString()===""&&(e=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0)){const n=x(t.toolbar.range.startContainer);n&&(e=[n])}return e},Jy=(t,e,n)=>{const a=e.parentElement,i=ae(e);if(["",`
`].includes(i.textContent)&&e.previousElementSibling.classList.contains("protyle-action")&&!e.querySelector("img")){if(a.nextElementSibling?.classList.contains("protyle-attr"))return Ul(t,[e.parentElement],n),!0;if(!a.parentElement.classList.contains("protyle-wysiwyg"))return Xw(t,e,n),!0}const s=yt(i,t.wysiwyg.element,n);if(n.toString()===""&&s.start===0&&!Ke(n.startContainer)){if(a.parentElement.classList.contains("protyle-wysiwyg"))return!0;const u=document.createElement("wbr");n.insertNode(u);const f=a.parentElement.outerHTML;u.remove();let g=bi(a,-1,!0);if(e.previousElementSibling.classList.contains("protyle-action"))ae(e).textContent===""?a.insertAdjacentElement("afterend",g):a.insertAdjacentElement("beforebegin",g);else{if(ae(e).textContent!=="")return!1;e.remove(),g=bi(a,-1,!0),a.insertAdjacentElement("afterend",g)}return a.getAttribute("data-subtype")==="o"&&it(a.parentElement),J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,f),fe(g,n),He(t),mo(g),!0}const o=a.querySelector(".list");let l;if(o&&a.getAttribute("fold")!=="1"&&e.nextElementSibling.isSameNode(o)){if(s.end>=i.textContent.length-(i.textContent.endsWith(p.Constants.ZWSP)?1:0)){n.insertNode(document.createElement("wbr"));const u=o.outerHTML;e.querySelector("wbr").remove(),l=bi(o.firstElementChild,-1,!0),o.firstElementChild.before(l),o.getAttribute("data-subtype")==="o"&&it(o),J(t,o.getAttribute("data-node-id"),o.outerHTML,u),fe(a,n),He(t)}else{n.insertNode(document.createElement("wbr"));const u=a.outerHTML,f=a.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(i.lastChild),l=bi(a,0,!1);const g=ae(l);g.appendChild(n.extractContents()),g.parentElement.after(o),a.insertAdjacentElement("afterend",l),a.getAttribute("data-subtype")==="o"&&it(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")?F(t,[{action:"update",data:a.outerHTML,id:a.getAttribute("data-node-id")},{action:"insert",id:l.getAttribute("data-node-id"),data:l.outerHTML,previousID:a.getAttribute("data-node-id")}],[{action:"delete",id:l.getAttribute("data-node-id")},{action:"update",data:u,id:a.getAttribute("data-node-id")}]):J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,f),fe(l,n),He(t)}return mo(l),!0}(n.toString()===""||n.toString()===p.Constants.ZWSP)&&n.startContainer.nodeType===3&&n.startContainer.textContent===p.Constants.ZWSP&&n.startOffset===0&&(n.setStart(n.startContainer,1),n.collapse(!1)),n.insertNode(document.createElement("wbr"));const r=a.outerHTML,c=a.parentElement.outerHTML;n.toString()!==""&&(n.extractContents(),n.insertNode(document.createElement("wbr"))),n.setEndAfter(i.lastChild),l=bi(a,0,!1);const d=n.extractContents();return d.firstChild.nodeType!==3&&d.firstChild.textContent===""&&(d.firstChild.after(document.createElement("wbr")),d.firstChild.remove()),(i?.lastElementChild?.getAttribute("data-type")||"").indexOf("inline-math")>-1&&!rt(i?.lastElementChild)&&i.insertAdjacentText("beforeend",`
`),ae(l).appendChild(d),a.insertAdjacentElement("afterend",l),a.getAttribute("data-subtype")==="o"&&it(a.parentElement),a.parentElement.classList.contains("protyle-wysiwyg")?F(t,[{action:"update",id:a.getAttribute("data-node-id"),data:a.outerHTML},{action:"insert",id:l.getAttribute("data-node-id"),data:l.outerHTML,previousID:a.getAttribute("data-node-id")}],[{action:"delete",id:l.getAttribute("data-node-id")},{action:"update",id:a.getAttribute("data-node-id"),data:r}]):J(t,a.parentElement.getAttribute("data-node-id"),a.parentElement.outerHTML,c),fe(l,n),He(t),mo(l),!0},Xy=(t,e,n)=>{const a=Ft(t);if(!a&&t.classList.contains("protyle-wysiwyg--select")){Xt(ae(t),e,!1),e.collapse(!1),X(["select"],n);return}if(a){if(t.parentElement.classList.contains("li")){const m=t.parentElement.parentElement.outerHTML,b=bi(t.parentElement,0,!0);t.parentElement.insertAdjacentElement("afterend",b),J(n,t.parentElement.parentElement.getAttribute("data-node-id"),t.parentElement.parentElement.outerHTML,m),fe(b,e),mo(b),He(n);return}if(t.classList.contains("hr")){wn(n,"afterend");return}t.classList.contains("protyle-wysiwyg--select")&&t.classList.contains("render-node")?n.toolbar.showRender(n,t):wn(n,"afterend");return}const i=ae(t);if(i.querySelectorAll(".img--select").forEach(m=>{m.classList.remove("img--select")}),t.getAttribute("data-type")==="NodeAttributeView")return!0;const s=i.innerHTML.trimStart();if((s.startsWith("```")||s.startsWith("\xB7\xB7\xB7")||s.startsWith("~~~")||s.indexOf("\n```")>-1||s.indexOf(`
~~~`)>-1||s.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(s.indexOf(`
`)===-1&&s.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){if(t.classList.contains("p")){const m=t.outerHTML;let b=i.innerHTML.replace(/\n(~|·|`){3,}/g,"\n```").trim().replace(/^(~|·|`){3,}/g,"```");b.endsWith("\n```")||(b+="<wbr>\n```"),i.innerHTML=b,t.outerHTML=n.lute.SpinBlockDOM(t.outerHTML),t=n.wysiwyg.element.querySelector(`[data-node-id="${t.getAttribute("data-node-id")}"]`);const y=t.querySelector(".protyle-action__language");return y?(window.siyuan.storage[p.Constants.LOCAL_CODELANG]&&y.textContent===""?y.textContent=window.siyuan.storage[p.Constants.LOCAL_CODELANG]:(window.siyuan.storage[p.Constants.LOCAL_CODELANG]=y.textContent,pe(p.Constants.LOCAL_CODELANG,window.siyuan.storage[p.Constants.LOCAL_CODELANG])),qe(t)):n.toolbar.showRender(n,t),J(n,t.getAttribute("data-node-id"),t.outerHTML,m),!0}}if(t.getAttribute("data-type")==="NodeCodeBlock"){const m=document.createElement("wbr");e.insertNode(m);const b=t.outerHTML;return m.remove(),e.extractContents(),i.textContent.endsWith(`
`)||i.insertAdjacentText("beforeend",`
`),e.insertNode(document.createTextNode(`
`)),e.collapse(!1),e.insertNode(m),i.removeAttribute("data-render"),qe(t),J(n,t.getAttribute("data-node-id"),t.outerHTML,b),!0}if(i.textContent.replace(p.Constants.ZWSP,"").replace(`
`,"")===""&&t.nextElementSibling&&t.nextElementSibling.classList.contains("protyle-attr")&&t.parentElement.getAttribute("data-type")==="NodeBlockquote"){e.insertNode(document.createElement("wbr"));const m=Ue(t),b=t.getAttribute("data-node-id"),y=m.getAttribute("data-node-id"),_={action:"insert",id:b,data:t.outerHTML},v={action:"insert",id:y,data:m.outerHTML};return y===b?(_.previousID=t.parentElement.getAttribute("data-node-id"),v.previousID=t.previousElementSibling.getAttribute("data-node-id"),t.parentElement.after(t)):(_.previousID=m.previousElementSibling?m.previousElementSibling.getAttribute("data-node-id"):void 0,_.parentID=m.parentElement.getAttribute("data-node-id")||n.block.parentID,v.previousID=_.previousID,v.parentID=_.parentID,m.after(t),m.remove()),F(n,[{action:"delete",id:y},_],[{action:"delete",id:b},v]),fe(t,e),!0}const o=yt(i,n.wysiwyg.element,e);if(t.parentElement.getAttribute("data-type")==="NodeListItem"&&(t.nextElementSibling.classList.contains("protyle-attr")||t.nextElementSibling.classList.contains("list")&&t.previousElementSibling?.classList.contains("protyle-action")||o.start===0&&t.previousElementSibling.classList.contains("protyle-action")||t.parentElement.getAttribute("fold")==="1")&&Jy(n,t,e))return!0;if(i.textContent!==""&&e.toString()===""&&o.start===0){const m=Cn(!1,!0),b=m.getAttribute("data-node-id");return F(n,[{action:"insert",data:m.outerHTML,id:b,previousID:t.previousElementSibling?t.previousElementSibling.getAttribute("data-node-id"):"",parentID:t.parentElement.getAttribute("data-node-id")||n.block.parentID}],[{action:"delete",id:b}]),m.querySelector("wbr").remove(),t.insertAdjacentElement("beforebegin",m),mo(m),!0}const l=document.createElement("wbr");e.insertNode(l);const r=t.outerHTML;l.remove(),e.toString()!==""&&e.extractContents(),i.lastChild&&e.setEndAfter(i.lastChild);const c=t.getAttribute("data-node-id"),d=document.createElement("div");d.appendChild(Cn(!1,!1)),d.querySelector('[contenteditable="true"]').appendChild(e.extractContents()),d.innerHTML=n.lute.SpinBlockDOM(d.innerHTML);const u=document.createElement("div");u.innerHTML=n.lute.SpinBlockDOM(i.parentElement.outerHTML);const f=[],g=[];Array.from(u.children).forEach(m=>{m.dataset.nodeId===c?(i.innerHTML=m.querySelector('[contenteditable="true"]').innerHTML,f.push({action:"update",data:t.outerHTML,id:c}),g.push({action:"update",data:r,id:c}),Ln(i)):(f.push({action:"insert",data:m.outerHTML,id:m.dataset.nodeId,nextID:c}),t.insertAdjacentElement("beforebegin",m),g.push({action:"delete",id:m.dataset.nodeId}),Ln(m))});let h=t;return Array.from(d.children).forEach(m=>{const b=m.getAttribute("data-node-id");f.push({action:"insert",data:m.outerHTML,id:b,previousID:h.getAttribute("data-node-id")}),g.push({action:"delete",id:b}),h.insertAdjacentElement("afterend",m),Ln(h.nextElementSibling),h=m}),F(n,f,g),le(t.nextElementSibling),He(n),!0},mo=t=>{const e=ae(t).childNodes;for(let n=0;n<e.length;n++)e[n].nodeType===3&&e[n].textContent.length===0&&(e[n].remove(),n--)},Qy=(t,e,n)=>{let a=t.startContainer;const i=rt(a);if(i&&i.nodeType!==3&&i.classList.contains("img")){i.insertAdjacentHTML("beforebegin","<wbr>");const s=e.outerHTML;i.previousElementSibling.remove();const o=document.createTextNode(`
`);return a.after(document.createTextNode(p.Constants.ZWSP)),a.after(o),t.selectNode(o),t.collapse(!1),J(n,e.getAttribute("data-node-id"),e.outerHTML,s),!0}if(a.nodeType===3&&(a=a.parentElement),a&&n.toolbar.getCurrentType(t).length>0&&yt(a,a,t).end===a.textContent.length)return og(t,e,n,a),!0;if(ht()||(0,I.tq)()){a=t.startContainer;const s=rt(a);return s&&s.textContent.trim()!==""?(document.execCommand("insertHTML",!1,`
`),!0):(og(t,e,n,a),!0)}return!1},og=(t,e,n,a)=>{const i=document.createElement("wbr");a.nodeType===3?t.insertNode(i):a.insertAdjacentElement("afterend",i);const s=e.outerHTML;i.remove();let o;rt(a)||(o=document.createTextNode(`
`),a.after(o));const l=document.createTextNode(`
`);a.after(l),o?t.setStart(o,0):t.setStart(l,1),t.collapse(!0),Z(t),J(n,e.getAttribute("data-node-id"),e.outerHTML,s)};let lg,bo=!1;const ve=(t,e,n,a="false")=>{let i;return e&&e.startsWith("icon")?i=`<svg class="keyboard__slash-icon"><use xlink:href="#${e}"></use></svg>`:i=e,`<button class="keyboard__slash-item" data-focus="${a}" data-value="${encodeURIComponent(t)}">
    ${i}
    <span class="keyboard__slash-text">${n}</span>
</button>`},rg=(t,e)=>{let n="";["var(--b3-font-color1)","var(--b3-font-color2)","var(--b3-font-color3)","var(--b3-font-color4)","var(--b3-font-color5)","var(--b3-font-color6)","var(--b3-font-color7)","var(--b3-font-color8)","var(--b3-font-color9)","var(--b3-font-color10)","var(--b3-font-color11)","var(--b3-font-color12)","var(--b3-font-color13)"].forEach((u,f)=>{n+=`<button class="keyboard__slash-item" data-type="color">
    <span class="keyboard__slash-icon" style="color:${u}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${f+1}</span>
</button>`});let a="";["var(--b3-font-background1)","var(--b3-font-background2)","var(--b3-font-background3)","var(--b3-font-background4)","var(--b3-font-background5)","var(--b3-font-background6)","var(--b3-font-background7)","var(--b3-font-background8)","var(--b3-font-background9)","var(--b3-font-background10)","var(--b3-font-background11)","var(--b3-font-background12)","var(--b3-font-background13)"].forEach((u,f)=>{a+=`<button class="keyboard__slash-item" data-type="backgroundColor">
    <span class="keyboard__slash-icon" style="background-color:${u}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${f+1}</span>
</button>`});const i=sg(t);let s=!1;i?.find(u=>{if(u.classList.contains("list")||u.classList.contains("li"))return s=!0,!0});let o="";const l=window.siyuan.storage[p.Constants.LOCAL_FONTSTYLES];l.length>0&&(o=`<div class="keyboard__slash-title">
    ${window.siyuan.languages.lastUsed}
</div>
<div class="keyboard__slash-block">`,l.forEach(u=>{const f=u.split(p.Constants.ZWSP);switch(f[0]){case"color":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="color:${f[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorFont} ${parseInt(f[1].replace("var(--b3-font-color",""))+1}</span>
</button>`;break;case"backgroundColor":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="background-color:${f[1]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages.colorPrimary} ${parseInt(f[1].replace("var(--b3-font-background",""))+1}</span>
</button>`;break;case"style2":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
</button>`;break;case"style4":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
</button>`;break;case"fontSize":s||(o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text">${f[1]}</span>
</button>`);break;case"style1":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-icon" style="background-color:${f[1]};color:${f[2]}">A</span>
    <span class="keyboard__slash-text">${window.siyuan.languages[f[2].replace("var(--b3-card-","").replace("-color)","")+"Style"]}</span>
</button>`;break;case"clear":o+=`<button class="keyboard__slash-item" data-type="${f[0]}">
    <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
</button>`;break}}),o+="</div>");let r,c="16px";i&&i.length>0?r=i[0]:(r=t.toolbar.range.cloneContents().querySelector('[data-type~="text"]'),r||(r=q(t.toolbar.range.startContainer,"data-type","text"))),r&&(c=r.style.fontSize||"16px");const d=e.querySelector(".keyboard__util");d.innerHTML=`${o}
<div class="keyboard__slash-title">${window.siyuan.languages.color}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.errorStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.warningStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.infoStyle}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style1">
        <span class="keyboard__slash-icon" style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);">A</span>
        <span class="keyboard__slash-text">${window.siyuan.languages.successStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorFont}</div>
<div class="keyboard__slash-block">
    ${n}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.colorPrimary}</div>
<div class="keyboard__slash-block">
    ${a}
</div>
<div class="keyboard__slash-title">${window.siyuan.languages.fontStyle}</div>
<div class="keyboard__slash-block">
    <button class="keyboard__slash-item" data-type="style2">
        <span class="keyboard__slash-text" style="-webkit-text-stroke: 0.2px var(--b3-theme-on-background);-webkit-text-fill-color : transparent;">${window.siyuan.languages.hollow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="style4">
        <span class="keyboard__slash-text" style="text-shadow: 1px 1px var(--b3-theme-surface-lighter), 2px 2px var(--b3-theme-surface-lighter), 3px 3px var(--b3-theme-surface-lighter), 4px 4px var(--b3-theme-surface-lighter)">${window.siyuan.languages.shadow}</span>
    </button>
    <button class="keyboard__slash-item" data-type="clear">
        <svg class="keyboard__slash-icon"><use xlink:href="#iconTrashcan"></use></svg>
        <span class="keyboard__slash-text">${window.siyuan.languages.clearFontStyle}</span>
    </button>
</div>
<div class="keyboard__slash-title${s?" fn__none":""}">${window.siyuan.languages.fontSize}</div>
<div class="keyboard__slash-block${s?" fn__none":""}">
    <select class="b3-select fn__block" style="width: calc(50% - 8px);margin: 4px 0 8px 0;">
        <option ${c==="12px"?"selected":""} value="12px">12px</option>
        <option ${c==="13px"?"selected":""} value="13px">13px</option>
        <option ${c==="14px"?"selected":""} value="14px">14px</option>
        <option ${c==="15px"?"selected":""} value="15px">15px</option>
        <option ${c==="16px"?"selected":""} value="16px">16px</option>
        <option ${c==="19px"?"selected":""} value="19px">19px</option>
        <option ${c==="22px"?"selected":""} value="22px">22px</option>
        <option ${c==="24px"?"selected":""} value="24px">24px</option>
        <option ${c==="29px"?"selected":""} value="29px">29px</option>
        <option ${c==="32px"?"selected":""} value="32px">32px</option>
        <option ${c==="40px"?"selected":""} value="40px">40px</option>
        <option ${c==="48px"?"selected":""} value="48px">48px</option>
    </select>
</div>`,d.querySelector("select").addEventListener("change",function(u){Ga(t,i,"fontSize",u.target.value)})},e_=(t,e)=>{t.hint.splitChar="/",t.hint.lastIndex=-1;const n=e.querySelector(".keyboard__util");n.innerHTML=`<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ve(Constants.ZWSP,"iconMarkdown",window.siyuan.languages.template)}
    ${ve(Constants.ZWSP+1,"iconBoth",window.siyuan.languages.widget)}
    ${ve(Constants.ZWSP+2,"iconImage",window.siyuan.languages.assets)}
    ${ve("((","iconRef",window.siyuan.languages.ref,"true")}
    ${ve("{{","iconSQL",window.siyuan.languages.blockEmbed,"true")}
    ${ve(Constants.ZWSP+5,"iconSparkles","AI Chat")}
    ${ve(Constants.ZWSP+4,"iconFile",window.siyuan.languages.newSubDoc)}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ve("# "+Lute.Caret,"iconH1",window.siyuan.languages.heading1,"true")}
    ${ve("## "+Lute.Caret,"iconH2",window.siyuan.languages.heading2,"true")}
    ${ve("### "+Lute.Caret,"iconH3",window.siyuan.languages.heading3,"true")}
    ${ve("#### "+Lute.Caret,"iconH4",window.siyuan.languages.heading4,"true")}
    ${ve("##### "+Lute.Caret,"iconH5",window.siyuan.languages.heading5,"true")}
    ${ve("###### "+Lute.Caret,"iconH6",window.siyuan.languages.heading6,"true")}
    ${ve("* "+Lute.Caret,"iconList",window.siyuan.languages.list,"true")}
    ${ve("1. "+Lute.Caret,"iconOrderedList",window.siyuan.languages["ordered-list"],"true")}
    ${ve("* [ ] "+Lute.Caret,"iconCheck",window.siyuan.languages.check,"true")}
    ${ve("> "+Lute.Caret,"iconQuote",window.siyuan.languages.quote,"true")}
    ${ve("```","iconCode",window.siyuan.languages.code,"true")}
    ${ve(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,"iconTable",window.siyuan.languages.table,"true")}
    ${ve("---","iconLine",window.siyuan.languages.line,"true")}
    ${ve("$$","iconMath",window.siyuan.languages.math)}
    ${ve("<div>","iconHTML5","HTML")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ve("emoji","iconEmoji",window.siyuan.languages.emoji,"true")}
    ${ve("a","iconLink",window.siyuan.languages.link)}
    ${ve("strong","iconBold",window.siyuan.languages.bold,"true")}
    ${ve("em","iconItalic",window.siyuan.languages.italic,"true")}
    ${ve("u","iconUnderline",window.siyuan.languages.underline,"true")}
    ${ve("s","iconStrike",window.siyuan.languages.strike,"true")}
    ${ve("mark","iconMark",window.siyuan.languages.mark,"true")}
    ${ve("sup","iconSup",window.siyuan.languages.sup,"true")}
    ${ve("sub","iconSub",window.siyuan.languages.sub,"true")}
    ${ve("tag","iconTags",window.siyuan.languages.tag,"true")}
    ${ve("code","iconInlineCode",window.siyuan.languages["inline-code"],"true")}
    ${ve("inline-math","iconMath",window.siyuan.languages["inline-math"])}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ve(Constants.ZWSP+3,"iconDownload",window.siyuan.languages.insertAsset+'<input class="b3-form__upload" type="file"'+(t.options.upload.accept?' multiple="'+t.options.upload.accept+'"':"")+"/>","true")}
    ${ve('<iframe sandbox="allow-forms allow-presentation allow-same-origin allow-scripts allow-modals" src="" border="0" frameborder="no" framespacing="0" allowfullscreen="true"></iframe>',"iconLanguage",window.siyuan.languages.insertIframeURL,"true")}
    ${ve("![]()","iconImage",window.siyuan.languages.insertImgURL,"true")}
    ${ve('<video controls="controls" src=""></video>',"iconVideo",window.siyuan.languages.insertVideoURL,"true")}
    ${ve('<audio controls="controls" src=""></audio>',"iconRecord",window.siyuan.languages.insertAudioURL,"true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ve("```abc\n```","",window.siyuan.languages.staff,"true")}
    ${ve("```echarts\n```","",window.siyuan.languages.chart,"true")}
    ${ve("```flowchart\n```","","Flow Chart","true")}
    ${ve("```graphviz\n```","","Graph","true")}
    ${ve("```mermaid\n```","","Mermaid","true")}
    ${ve("```mindmap\n```","",window.siyuan.languages.mindmap,"true")}
    ${ve("```plantuml\n```","","UML","true")}
</div>
<div class="keyboard__slash-title"></div>
<div class="keyboard__slash-block">
    ${ve(`style${Constants.ZWSP}color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);`,'<div style="color: var(--b3-card-info-color);background-color: var(--b3-card-info-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.infoStyle,"true")}
    ${ve(`style${Constants.ZWSP}color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);`,'<div style="color: var(--b3-card-success-color);background-color: var(--b3-card-success-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.successStyle,"true")}
    ${ve(`style${Constants.ZWSP}color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);`,'<div style="color: var(--b3-card-warning-color);background-color: var(--b3-card-warning-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.warningStyle,"true")}
    ${ve(`style${Constants.ZWSP}color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);`,'<div style="color: var(--b3-card-error-color);background-color: var(--b3-card-error-background);" class="keyboard__slash-icon">A</div>',window.siyuan.languages.errorStyle,"true")}
    ${ve(`style${Constants.ZWSP}`,'<div class="keyboard__slash-icon">A</div>',window.siyuan.languages.clearFontStyle,"true")}
</div>`,t.hint.bindUploadEvent(t,n)},Md=t=>{window.siyuan.menus.menu.remove(),bo=!0;const e=document.getElementById("keyboardToolbar");let n=e.getAttribute("data-keyboardheight");n=(n?parseInt(n)+42:window.outerHeight/2)+"px";const a=tr();a&&(a.protyle.element.parentElement.style.paddingBottom=n,a.protyle.contentElement.scrollTop=t),setTimeout(()=>{e.style.height=n},p.Constants.TIMEOUT_TRANSITION),setTimeout(()=>{bo=!1},1e3)},wo=()=>{const t=document.getElementById("keyboardToolbar");t.style.height="";const e=getCurrentEditor();e&&(e.protyle.element.parentElement.style.paddingBottom="42px"),t.querySelector('.keyboard__action[data-type="add"]').classList.remove("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="text"]').classList.remove("protyle-toolbar__item--current"),t.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconKeyboardHide")},t_=()=>{clearTimeout(lg),lg=window.setTimeout(()=>{if(getSelection().rangeCount===0||window.siyuan.config.readonly||document.getElementById("toolbarName").getAttribute("readonly")==="readonly"||window.screen.height-window.innerHeight<160||!document.activeElement||document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&!document.activeElement.classList.contains("protyle-wysiwyg")&&document.activeElement.getAttribute("contenteditable")!=="true"){yo();return}if(document.activeElement&&!["INPUT","TEXTAREA"].includes(document.activeElement.tagName)&&(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("model").style.transform==="translateY(0px)")){yo();return}bo||wo(),n_();const t=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic"),e=getSelection().getRangeAt(0);if(!hasClosestByClassName(e.startContainer,"protyle-wysiwyg",!0)){t[0].classList.add("fn__none"),t[1].classList.add("fn__none");return}e.toString()||t[0].querySelector('[data-type="goinline"]').classList.contains("protyle-toolbar__item--current")?(t[0].classList.add("fn__none"),t[1].classList.remove("fn__none")):(t[0].classList.remove("fn__none"),t[1].classList.add("fn__none"));const i=getCurrentEditor().protyle;if(!t[0].classList.contains("fn__none")){i.undo.undoStack.length===0?t[0].querySelector('[data-type="undo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="undo"]').removeAttribute("disabled"),i.undo.redoStack.length===0?t[0].querySelector('[data-type="redo"]').setAttribute("disabled","disabled"):t[0].querySelector('[data-type="redo"]').removeAttribute("disabled");const s=hasClosestBlock(e.startContainer);if(s){const o=t[0].querySelector('[data-type="outdent"]');s.parentElement.classList.contains("li")?(o.classList.remove("fn__none"),o.nextElementSibling.classList.remove("fn__none")):(o.classList.add("fn__none"),o.nextElementSibling.classList.add("fn__none"))}}t[1].classList.contains("fn__none")||(t[1].querySelectorAll(".protyle-toolbar__item--current").forEach(o=>{o.classList.remove("protyle-toolbar__item--current")}),i.toolbar.getCurrentType(e).forEach(o=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(o))return;const l=t[1].querySelector(`[data-type="${o}"]`);l&&l.classList.add("protyle-toolbar__item--current")}))},620)},n_=()=>{bo||wo();const t=document.getElementById("keyboardToolbar");if(!t.classList.contains("fn__none"))return;t.classList.remove("fn__none"),t.style.zIndex=(++window.siyuan.zIndex).toString();const e=document.getElementById("model");e.style.transform==="translateY(0px)"&&(e.style.paddingBottom="42px");const n=getSelection().getRangeAt(0),a=getCurrentEditor();a&&a.protyle.wysiwyg.element.contains(n.startContainer)&&(a.protyle.element.parentElement.style.paddingBottom="42px"),getCurrentEditor().protyle.app.plugins.forEach(i=>{i.eventBus.emit("mobile-keyboard-show")}),setTimeout(()=>{const i=hasClosestByClassName(n.startContainer,"protyle-content",!0);if(i){const s=i.getBoundingClientRect().top,o=getSelectionPosition(i).top;if(o<window.innerHeight-42&&o>s)return;i.scroll({top:i.scrollTop+o-window.innerHeight+42+26,left:i.scrollLeft,behavior:"smooth"})}},Constants.TIMEOUT_TRANSITION)},yo=()=>{if(bo)return;const t=document.getElementById("keyboardToolbar");if(t.classList.contains("fn__none"))return;t.classList.add("fn__none"),t.style.height="";const e=tr();e&&(e.protyle.element.parentElement.style.paddingBottom="");const n=document.getElementById("model");n.style.transform==="translateY(0px)"&&(n.style.paddingBottom=""),tr().protyle.app.plugins.forEach(a=>{a.eventBus.emit("mobile-keyboard-hide")})},nr=()=>{document.activeElement.blur()},Hk=()=>{let t=!1;document.addEventListener("selectionchange",()=>{t||t_()},!1);const e=document.getElementById("keyboardToolbar");e.innerHTML=`<div class="fn__flex keyboard__bar">
    <div class="fn__flex-1">
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="add"><svg><use xlink:href="#iconAdd"></use></svg></button>
            <button class="keyboard__action" data-type="block"><svg><use xlink:href="#iconParagraph"></use></svg></button>
            <button class="keyboard__action" data-type="goinline"><svg class="keyboard__svg--big"><use xlink:href="#iconBIU"></use></svg></button>
            <button class="keyboard__action" data-type="softLine"><svg><use xlink:href="#iconSoftWrap"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="undo"><svg><use xlink:href="#iconUndo"></use></svg></button>
            <button class="keyboard__action" data-type="redo"><svg><use xlink:href="#iconRedo"></use></svg></button>
            <span class="keyboard__split"></span>
            <button class="keyboard__action" data-type="outdent"><svg><use xlink:href="#iconOutdent"></use></svg></button>
            <button class="keyboard__action" data-type="indent"><svg><use xlink:href="#iconIndent"></use></svg></button>
            <button class="keyboard__action" data-type="moveup"><svg><use xlink:href="#iconUp"></use></svg></button>
            <button class="keyboard__action" data-type="movedown"><svg><use xlink:href="#iconDown"></use></svg></button>
        </div>
        <div class="fn__none keyboard__dynamic">
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconBack"></use></svg></button>
            <button class="keyboard__action" data-type="block-ref"><svg><use xlink:href="#iconRef"></use></svg></button>
            <button class="keyboard__action" data-type="a"><svg><use xlink:href="#iconLink"></use></svg></button>
            <button class="keyboard__action" data-type="text"><svg><use xlink:href="#iconFont"></use></svg></button>
            <button class="keyboard__action" data-type="strong"><svg><use xlink:href="#iconBold"></use></svg></button>
            <button class="keyboard__action" data-type="em"><svg><use xlink:href="#iconItalic"></use></svg></button>
            <button class="keyboard__action" data-type="u"><svg><use xlink:href="#iconUnderline"></use></svg></button>
            <button class="keyboard__action" data-type="s"><svg><use xlink:href="#iconStrike"></use></svg></button>
            <button class="keyboard__action" data-type="mark"><svg><use xlink:href="#iconMark"></use></svg></button>
            <button class="keyboard__action" data-type="sup"><svg><use xlink:href="#iconSup"></use></svg></button>
            <button class="keyboard__action" data-type="sub"><svg><use xlink:href="#iconSub"></use></svg></button>
            <button class="keyboard__action" data-type="clear"><svg><use xlink:href="#iconClear"></use></svg></button>
            <button class="keyboard__action" data-type="code"><svg><use xlink:href="#iconInlineCode"></use></svg></button>
            <button class="keyboard__action" data-type="kbd"<use xlink:href="#iconKeymap"></use></svg></button>
            <button class="keyboard__action" data-type="tag"><svg><use xlink:href="#iconTags"></use></svg></button>
            <button class="keyboard__action" data-type="inline-math"><svg><use xlink:href="#iconMath"></use></svg></button>
            <button class="keyboard__action" data-type="inline-memo"><svg><use xlink:href="#iconM"></use></svg></button>
            <button class="keyboard__action" data-type="goback"><svg><use xlink:href="#iconCloseRound"></use></svg></button>
        </div>
    </div>
    <span class="keyboard__split"></span>
    <button class="keyboard__action" data-type="done"><svg style="width: 36px"><use xlink:href="#iconKeyboardHide"></use></svg></button>
</div>
<div class="keyboard__util"></div>`,e.addEventListener("click",n=>{const a=getCurrentEditor()?.protyle,i=n.target,s=hasClosestByClassName(n.target,"keyboard__slash-item");if(s&&!s.getAttribute("data-type")){const d=decodeURIComponent(s.getAttribute("data-value"));a.hint.fill(d,a,!1),d!==Constants.ZWSP+3&&(n.preventDefault(),n.stopPropagation()),s.getAttribute("data-focus")==="true"&&focusByRange(a.toolbar.range);return}const o=hasClosestByMatchTag(i,"BUTTON");if(!o||o.getAttribute("disabled"))return;const l=o.getAttribute("data-type");if(["clear","style2","style4","color","backgroundColor","fontSize","style1"].includes(l)){const d=getFontNodeElements(a),u=o.firstElementChild;l==="style1"?fontEvent(a,d,l,u.style.backgroundColor+Constants.ZWSP+u.style.color):l==="fontSize"?fontEvent(a,d,l,u.textContent.trim()):l==="backgroundColor"?fontEvent(a,d,l,u.style.backgroundColor):l==="color"?fontEvent(a,d,l,u.style.color):fontEvent(a,d,l)}if(n.preventDefault(),n.stopPropagation(),getSelection().rangeCount===0)return;const r=getSelection().getRangeAt(0);if(l==="done"){e.clientHeight>100?(wo(),focusByRange(r)):(nr(),yo());return}if(window.siyuan.config.readonly||!a||a.disabled)return;if(l==="undo"){a.undo.undo(a);return}else if(l==="redo"){a.undo.redo(a);return}if(getSelection().rangeCount===0)return;const c=hasClosestBlock(r.startContainer);if(c){if(l==="goback"){e.querySelector('.keyboard__action[data-type="goinline"]').classList.remove("protyle-toolbar__item--current");const d=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");d[0].classList.remove("fn__none"),d[1].classList.add("fn__none"),focusByRange(r),t=!0,setTimeout(()=>{t=!1},1e3);return}else if(l==="goinline"){o.classList.add("protyle-toolbar__item--current");const d=document.querySelectorAll("#keyboardToolbar .keyboard__dynamic");d[1].classList.remove("fn__none"),d[0].classList.add("fn__none"),focusByRange(r);return}else if(["a","block-ref","inline-math","inline-memo"].includes(l)){hasClosestByAttribute(r.startContainer,"data-type","NodeCodeBlock")||(hideElements(["util"],a),a.toolbar.element.querySelector(`[data-type="${l}"]`).dispatchEvent(new CustomEvent("click")));return}else if(o.classList.contains("keyboard__action")&&["strong","em","s","code","mark","tag","u","sup","clear","sub","kbd"].includes(l)){hasClosestByAttribute(r.startContainer,"data-type","NodeCodeBlock")||a.toolbar.setInlineMark(a,l,"toolbar");return}else if(l==="text"){if(o.classList.contains("protyle-toolbar__item--current"))wo(),focusByRange(r);else{o.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const d=a.contentElement.scrollTop;rg(a,e),Md(d)}return}else if(l==="moveup"){moveToUp(a,c,r),focusByRange(r);return}else if(l==="movedown"){moveToDown(a,c,r),focusByRange(r);return}else if(l==="softLine"){r.extractContents(),softEnter(r,c,a),focusByRange(r);return}else if(l==="add"){if(o.classList.contains("protyle-toolbar__item--current"))wo(),focusByRange(r);else{o.classList.add("protyle-toolbar__item--current"),e.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound");const d=a.contentElement.scrollTop;e_(a,e),Md(d)}return}else if(l==="block"){a.gutter.renderMenu(a,c),window.siyuan.menus.menu.fullscreen(),nr(),yo();return}else if(l==="outdent"){listOutdent(a,[c.parentElement],r),focusByRange(r);return}else if(l==="indent"){listIndent(a,[c.parentElement],r),focusByRange(r);return}}})},cg=()=>{document.getElementById("menu").style.transform="",document.getElementById("sidebar").style.transform="",document.getElementById("model").style.transform="";const t=document.querySelector(".side-mask");t.classList.add("fn__none"),t.style.opacity="",window.siyuan.menus.menu.remove()},a_=()=>{document.getElementById("model").style.transform="",nr(),yo()},Nd=null,i_=t=>{const e=getCurrentEditor().protyle;if(window.siyuan.storage[Constants.LOCAL_DOCINFO]={id:t.id},setStorageVal(Constants.LOCAL_DOCINFO,window.siyuan.storage[Constants.LOCAL_DOCINFO]),hideElements(["toolbar","hint","util"],e),e.contentElement.classList.contains("fn__none")&&setEditMode(e,"wysiwyg"),e.notebookId=t.data.notebookId,e.path=t.data.path,t.data.startId===e.wysiwyg.element.firstElementChild.getAttribute("data-node-id")&&t.data.endId===e.wysiwyg.element.lastElementChild.getAttribute("data-node-id")){e.contentElement.scrollTo({top:t.scrollTop,behavior:"smooth"});return}if(t.id!==e.block.rootID&&fetchPost("/api/block/getDocInfo",{id:t.id},n=>{setTitle(n.data.name),document.getElementById("toolbarName").value=n.data.name==="Untitled"?"":n.data.name,e.background.render(n.data.ial,e.block.rootID),e.wysiwyg.renderCustom(n.data.ial)}),t.zoomId){t.zoomId!==e.block.id?fetchPost("/api/block/checkBlockExist",{id:t.id},n=>{n.data&&zoomOut({protyle:e,id:t.id,isPushBack:!1,callback:()=>{e.contentElement.scrollTop=t.scrollTop}})}):e.contentElement.scrollTop=t.scrollTop;return}fetchPost("/api/filetree/getDoc",{id:t.id,startID:t.data.startId,endID:t.data.endId},n=>{e.block.parentID=n.data.parentID,e.block.parent2ID=n.data.parent2ID,e.block.rootID=n.data.rootID,e.block.showAll=!1,e.block.mode=n.data.mode,e.block.blockCount=n.data.blockCount,e.block.id=n.data.id,e.block.action=t.callback,e.wysiwyg.element.setAttribute("data-doc-type",n.data.type),e.wysiwyg.element.innerHTML=n.data.content,processRender(e.wysiwyg.element),highlightRender(e.wysiwyg.element),avRender(e.wysiwyg.element,e),blockRender(e,e.wysiwyg.element,t.scrollTop),n.data.isSyncing?disabledForeverProtyle(e):setReadonlyByConfig(e),e.contentElement.scrollTop=t.scrollTop})},Hd=()=>{const t=tr().protyle;t.wysiwyg.element.firstElementChild&&window.siyuan.backStack.push({id:t.block.showAll?t.block.id:t.block.rootID,data:{startId:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:t.notebookId,path:t.path},scrollTop:t.contentElement.scrollTop,callback:t.block.action,zoomId:t.block.showAll?t.block.id:void 0})},Ok=()=>{const t=getCurrentEditor();if(window.siyuan.menus.menu.element.classList.contains("b3-menu--fullscreen")&&!window.siyuan.menus.menu.element.classList.contains("fn__none")){window.siyuan.menus.menu.element.dispatchEvent(new CustomEvent("click",{detail:"back"}));return}else if(document.getElementById("model").style.transform==="translateY(0px)"){const n=document.getElementById("searchAssetsPanel");!n||n.classList.contains("fn__none")?document.getElementById("model").style.transform="":n.classList.add("fn__none");return}else if(window.siyuan.viewer&&!window.siyuan.viewer.destroyed){window.siyuan.viewer.destroy();return}else if(document.getElementById("menu").style.transform==="translateX(0px)"||document.getElementById("sidebar").style.transform==="translateX(0px)"){closePanel();return}else if(t&&!t.protyle.toolbar.subElement.classList.contains("fn__none")){hideElements(["util"],t.protyle),closePanel();return}else if(window.siyuan.dialogs.length!==0){hideElements(["dialog"]),closePanel();return}if(window.JSAndroid&&window.siyuan.backStack.length<1){document.querySelector('#message [data-id="exitTip"]')?window.JSAndroid.returnDesktop():showMessage(window.siyuan.languages.returnDesktop,3e3,"info","exitTip");return}if(window.siyuan.backStack.length<1)return;if(Nd.length===0&&t){const n=t.protyle;Nd.push({id:n.block.showAll?n.block.id:n.block.rootID,data:{startId:n.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),endId:n.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),notebookId:n.notebookId,path:n.path},scrollTop:n.contentElement.scrollTop,callback:n.block.action,zoomId:n.block.showAll?n.block.id:void 0})}const e=window.siyuan.backStack.pop();Nd.push(e),i_(e)},hs=(t,e,n)=>{if(!t){e.innerHTML="";return}w("/api/template/render",{id:n,path:t,preview:!0},a=>{e.innerHTML=`<div class="protyle-wysiwyg" style="padding: 8px">${a.data.content.replace(/contenteditable="true"/g,"")}</div>`})},dg=(t,e,n=!0)=>{if(!t.getAttribute("data-type")||!e.getAttribute("data-type"))return!1;t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim()),e.setAttribute("data-type",e.getAttribute("data-type").replace("search-mark","").trim());const a=t.attributes;let i=!0;for(let s=0;s<a.length;s++)e.getAttribute(a[s].name)!==a[s].value&&(i=!1);return i&&(n?t.innerHTML=t.innerHTML+e.innerHTML:t.innerHTML=e.innerHTML+t.innerHTML,e.remove()),i},ug=t=>{let e=t.previousSibling;for(;e&&e.nodeType!==3&&dg(t,e,!1);)e=t.previousSibling;let n=t.nextSibling;for(;n&&n.nodeType!==3&&dg(t,n);)n=t.nextSibling;(t.getAttribute("data-type")||"").includes("search-mark")&&t.setAttribute("data-type",t.getAttribute("data-type").replace("search-mark","").trim())},Od=(t,e,n)=>{const a=t.getAttribute("data-type").split(" ");if(a.length===1){const i=t.parentElement;t.outerHTML=t.innerHTML.replace(p.Constants.ZWSP,"")+"<wbr>",n&&fe(i,n)}else a.find((i,s)=>{if(e===i)return a.splice(s,1),!0}),t.setAttribute("data-type",a.join(" ")),e==="a"?t.removeAttribute("data-href"):e==="file-annotation-ref"?t.removeAttribute("data-id"):e==="block-ref"&&(t.removeAttribute("data-id"),t.removeAttribute("data-subtype")),n&&(n.selectNodeContents(t),n.collapse(!1),Z(n))},ar=(t,e)=>{t.element.querySelector(".wysiwygLoading")||($i(t),X(["toolbar"],t),w(`/api/format/net${e}2LocalAssets`,{id:t.block.rootID},()=>{Pe().editor.forEach(n=>{n.editor.protyle.block.rootID===t.block.rootID&&na(n.editor.protyle,n.editor.protyle.element.isSameNode(t.element))})}))},_o=(t,e)=>{setTimeout(()=>{Ja(["gutter"])},p.Constants.TIMEOUT_TRANSITION);const n=t.className.includes("fullscreen");if(n?(t.classList.remove("fullscreen"),document.getElementById("drag")?.classList.remove("fn__hidden")):(t.classList.add("fullscreen"),document.getElementById("drag")?.classList.add("fn__hidden")),e){n?e.querySelector("use").setAttribute("xlink:href","#iconFullscreen"):e.querySelector("use").setAttribute("xlink:href","#iconFullscreenExit");const a=A(t,"layout--float");a&&(n?(a.setAttribute("data-temp",a.style.transform),a.style.transform="none"):(a.style.transform=a.getAttribute("data-temp"),a.removeAttribute("data-temp")));return}t.classList.contains("protyle")&&(window.siyuan.editorIsFullscreen=!n),Pe().editor.forEach(a=>{t.isSameNode(a.element)||(window.siyuan.editorIsFullscreen,a.element.classList.contains("fullscreen")&&(a.element.classList.remove("fullscreen"),qt(a.editor.protyle)))})},fg=(t,e,n)=>{if($(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return w("/api/filetree/getHPathByID",{id:t.block.rootID},i=>{G(i.data)}),e.preventDefault(),e.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,e))return ar(t,"Img"),e.preventDefault(),e.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,e))return ar(t,"Assets"),e.preventDefault(),e.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.optimizeTypography.custom,e))return w("/api/format/autoSpace",{id:t.block.rootID}),e.preventDefault(),e.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e)||$(window.siyuan.config.keymap.general.dailyNote.custom,e))return e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e)){const i=n?n.getAttribute("data-node-id"):t.block.rootID;return w("/api/block/getRefText",{id:i},s=>{G(`[${s.data}](siyuan://blocks/${i})`)}),e.preventDefault(),e.stopPropagation(),!0}let a=!1;if(t.app.plugins.find(i=>{if(i.commands.find(s=>{if(s.editorCallback&&$(s.customHotkey,e))return a=!0,s.editorCallback(t),!0}),a)return!0}),a)return!0},pg=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else if(yt(t.nodeElement,t.editorElement,t.range).start!==0){const a=ae(t.nodeElement);if(a.tagName==="TABLE"){const i=se(t.range.startContainer,"TH")||se(t.range.startContainer,"TD")||a.querySelector("th, td");if(yt(i,i,t.range).start!==0){Uo(i,t.range),t.event.stopPropagation(),t.event.preventDefault();return}}else return}t.range.collapse(!0),X(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Gt(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},gg=t=>{const e=t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(e.length>0)t.event.stopPropagation(),t.event.preventDefault();else if(yt(t.nodeElement,t.editorElement,t.range).end<ae(t.nodeElement).textContent.length)return;t.range.collapse(!1),X(["toolbar"],t.protyle),e.length===0?t.nodeElement.classList.add("protyle-wysiwyg--select"):t.cb(e);const n=[];t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{n.push(a.getAttribute("data-node-id"))}),Gt(n,t.protyle.block.rootID),t.event.stopPropagation(),t.event.preventDefault()},ir=t=>{let e,n;return t.forEach(a=>{a.getAttribute("select-start")&&(e=a),a.getAttribute("select-end")&&(n=a)}),e||(e=t[0],e.setAttribute("select-start","true")),n||(n=t[t.length-1],n.setAttribute("select-end","true")),{startElement:e,endElement:n}},Rd=(t,e)=>{let n;const a=[],i=[];t.reverse().forEach((s,o)=>{const l=s.cloneNode(!0);o===0&&(n=l);const r=Lute.NewNodeID();l.setAttribute("data-node-id",r),l.querySelectorAll("[data-node-id]").forEach(c=>{c.setAttribute("data-node-id",Lute.NewNodeID())}),s.classList.remove("protyle-wysiwyg--select"),t[0].after(l),a.push({action:"insert",data:l.outerHTML,id:r,previousID:t[0].getAttribute("data-node-id")}),i.push({action:"delete",id:r})}),F(e,a,i),le(n),He(e)},hg=t=>{t.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0"||t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.options.backlinkData?(le(t.wysiwyg.element.firstElementChild),t.contentElement.scrollTop=0,t.scroll.lastScrollTop=1):w("/api/filetree/getDoc",{id:t.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{st({data:e,protyle:t,action:[p.Constants.CB_GET_FOCUS]})})},mg=t=>{!t.scroll.element.classList.contains("fn__none")&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"?w("/api/filetree/getDoc",{id:t.block.rootID,mode:4,size:window.siyuan.config.editor.dynamicLoadBlocks},e=>{st({data:e,protyle:t,action:[p.Constants.CB_GET_FOCUS],afterCB(){le(t.wysiwyg.element.lastElementChild,void 0,!1)}})}):(t.contentElement.scrollTop=t.contentElement.scrollHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop,le(t.wysiwyg.element.lastElementChild,void 0,!1))},bg=(t,e,n,a,i)=>{e.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.style.display="block";let o=s.nextSibling;for(;o;)if(o.textContent==="")o=o.nextSibling;else if(o.textContent===p.Constants.ZWSP){o.textContent="";break}else break;let l=s.previousSibling;for(;l;)if(l.textContent==="")l=l.previousSibling;else if(l.textContent===p.Constants.ZWSP){l.textContent="";break}else break}),J(t,a,e.outerHTML,i)},wg=(t,e,n,a,i)=>{e.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),n.forEach(s=>{s.style.display="",rt(s)||s.insertAdjacentText("afterend",p.Constants.ZWSP),Ke(s)||s.insertAdjacentText("beforebegin",p.Constants.ZWSP)}),J(t,a,e.outerHTML,i)},yg=(t,e,n,a=[])=>{w("/api/search/searchAsset",{k:e,exts:a},i=>{let s="";i.data.forEach((c,d)=>{s+=`<div data-value="${c.path}" class="b3-list-item${d===0?" b3-list-item--focus":""}"><div class="b3-list-item__text">${c.hName}</div></div>`});const o=t.querySelector(".b3-list"),l=t.querySelector("#preview"),r=t.querySelector("input");o.innerHTML=s||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,i.data.length>0?l.innerHTML=_i(i.data[0].path):l.innerHTML=window.siyuan.languages.emptyContent,window.siyuan.menus.menu.popup(n),e||r.select()})},Bd=(t,e,n,a)=>{window.siyuan.menus.menu.remove(),new At().addItem({iconHTML:"",type:"readonly",label:`<div class="fn__flex" style="max-height: 50vh">
<div class="fn__flex-column" style="${(0,I.tq)()?"width:100%":"min-width: 260px;max-width:420px"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div id="preview" style="width: 360px;display: ${(0,I.tq)()||window.outerWidth<window.outerWidth/2+260?"none":"flex"};padding: 8px;overflow: auto;justify-content: center;align-items: center;word-break: break-all;"></div>
</div>`,bind(s){s.style.maxWidth="none";const o=s.querySelector(".b3-list"),l=s.querySelector("#preview");o.addEventListener("mouseover",c=>{const d=c.target,u=A(d,"b3-list-item");u&&(l.innerHTML=_i(u.getAttribute("data-value")))});const r=s.querySelector("input");r.addEventListener("keydown",c=>{if(c.isComposing)return;const d=s.querySelector(".b3-list--empty");if(!d){const u=Bn(o,c);u&&(l.innerHTML=_i(u.getAttribute("data-value")),c.stopPropagation())}if(c.key==="Enter"){if(d)n||(window.siyuan.menus.menu.remove(),Z(t.toolbar.range));else{const u=s.querySelector(".b3-list-item--focus").getAttribute("data-value");n?n(u):(Pp(u,t),window.siyuan.menus.menu.remove())}c.preventDefault(),c.stopPropagation()}else c.key==="Escape"&&(n||Z(t.toolbar.range))}),r.addEventListener("input",c=>{c.stopPropagation(),yg(s,r.value,e,a)}),s.lastElementChild.addEventListener("click",c=>{const d=c.target;if(q(d,"data-type","previous")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),c.stopPropagation();return}if(q(d,"data-type","next")){r.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),c.stopPropagation();return}const g=A(d,"b3-list-item");if(g){c.stopPropagation();const h=g.getAttribute("data-value");n?n(h):(Pp(h,t),window.siyuan.menus.menu.remove())}}),yg(s,"",e,a)}})},qd=(t,e)=>{const n=x(e);if(!n)return;X(["util","toolbar","hint"],t);const a=n.getAttribute("data-node-id");let i=n.outerHTML;window.siyuan.menus.menu.remove();let s;window.siyuan.menus.menu.append(new S({iconHTML:"",type:"readonly",label:`<div class="b3-menu__label">ID</div>
<textarea rows="1" style="margin:4px 0;width: ${(0,I.tq)()?"200":"360"}px" class="b3-text-field" readonly>${e.getAttribute("data-id")||""}</textarea>
<div class="fn__hr"></div>
<div class="b3-menu__label">${window.siyuan.languages.anchor}</div>
<textarea rows="1" style="margin:4px 0;width: ${(0,I.tq)()?"200":"360"}px" class="b3-text-field"></textarea>`,bind(l){l.style.maxWidth="none",s=l.querySelectorAll(".b3-text-field")[1],s.value=e.textContent;const r=()=>{s.value?e.innerHTML=Lute.EscapeHTMLStr(s.value):e.innerHTML="*"};s.addEventListener("input",c=>{c.isComposing||(r(),c.stopPropagation())}),s.addEventListener("compositionend",c=>{c.isComposing||(r(),c.stopPropagation())}),s.addEventListener("keydown",c=>{if(!c.isComposing){if(c.key==="Enter"&&!c.isComposing)window.siyuan.menus.menu.remove();else if(Ya(c))return}})}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),Od(e,"file-annotation-ref",t.toolbar.range),J(t,a,n.outerHTML,i),i=n.outerHTML}}).element),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,i),fe(n,t.toolbar.range),i=n.outerHTML}}).element),t?.app?.plugins&&en({plugins:t.app.plugins,type:"open-menu-fileannotationref",detail:{protyle:t,element:e},separatorPosition:"top"});const o=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26}),window.siyuan.menus.menu.element.setAttribute("data-from",A(t.element,"block__edit")?"popover":"app"),s.select(),window.siyuan.menus.menu.removeCB=()=>{n.outerHTML!==i&&(n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,i));const l=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);l&&!t.element.contains(l.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range))}},Fd=(t,e)=>{const n=x(e);if(!n)return;X(["util","toolbar","hint"],t);const a=e.getAttribute("data-id"),i=n.getAttribute("data-node-id");let s=n.outerHTML;if(window.siyuan.menus.menu.remove(),t.disabled||(window.siyuan.menus.menu.append(new S({iconHTML:"",type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.anchor}">`,bind(l){const r=l.querySelector("input");r.value=e.getAttribute("data-subtype")==="d"?"":e.textContent,r.addEventListener("input",()=>{r.value?e.innerHTML=Lute.EscapeHTMLStr(r.value):w("/api/block/getRefText",{id:a},c=>{e.innerHTML=c.data}),e.setAttribute("data-subtype",r.value?"s":"d")}),r.addEventListener("keydown",c=>{if(!c.isComposing){if(c.key==="Enter"&&!c.isComposing)window.siyuan.menus.menu.remove();else if(Ya(c))return}})}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element)),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.openBy,icon:"iconOpen",accelerator:window.siyuan.config.keymap.editor.general.openBy.custom+"/Click",click(){ot(a,(l,r)=>{de({app:t.app,id:a,action:r,zoomIn:l})})}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.refTab,icon:"iconEyeoff",accelerator:window.siyuan.config.keymap.editor.general.refTab.custom+"/\u2318Click",click(){ot(a,l=>{de({app:t.app,id:a,action:l?[p.Constants.CB_GET_HL,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],keepCursor:!0,zoomIn:l})})}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.insertRight,icon:"iconLayoutRight",accelerator:window.siyuan.config.keymap.editor.general.insertRight.custom+"/\u2325Click",click(){ot(a,(l,r)=>{de({app:t.app,id:a,position:"right",action:r,zoomIn:l})})}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.insertBottom,icon:"iconLayoutBottom",accelerator:window.siyuan.config.keymap.editor.general.insertBottom.custom+(window.siyuan.config.keymap.editor.general.insertBottom.custom?"/":"")+"\u21E7Click",click(){ot(a,(l,r)=>{de({app:t.app,id:a,position:"bottom",action:r,zoomIn:l})})}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.openByNewWindow,icon:"iconOpenWindow",click(){to(a)}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({icon:"iconLink",label:window.siyuan.languages.backlinks,accelerator:window.siyuan.config.keymap.editor.general.backlinks.custom,click:()=>{rr({app:t.app,blockId:a})}}).element),window.siyuan.menus.menu.append(new S({icon:"iconGraph",label:window.siyuan.languages.graphView,accelerator:window.siyuan.config.keymap.editor.general.graphView.custom,click:()=>{cr({app:t.app,blockId:a})}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),!t.disabled){let l=[];e.getAttribute("data-subtype")==="s"?l.push({label:window.siyuan.languages.turnToDynamic,click(){e.setAttribute("data-subtype","d"),w("/api/block/getRefText",{id:a},r=>{e.innerHTML=r.data,n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),s=n.outerHTML}),Z(t.toolbar.range)}}):l.push({label:window.siyuan.languages.turnToStatic,click(){e.setAttribute("data-subtype","s"),n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),Z(t.toolbar.range),s=n.outerHTML}}),l=l.concat([{label:window.siyuan.languages.text,click(){n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),Od(e,"block-ref",t.toolbar.range),J(t,i,n.outerHTML,s),s=n.outerHTML}},{label:"*",click(){e.setAttribute("data-subtype","s"),e.textContent="*",n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),Z(t.toolbar.range),s=n.outerHTML}},{label:window.siyuan.languages.text+" *",click(){e.insertAdjacentHTML("beforebegin",e.innerHTML+" "),e.setAttribute("data-subtype","s"),e.textContent="*",n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),Z(t.toolbar.range),s=n.outerHTML}},{label:window.siyuan.languages.link,icon:"iconLink",click(){e.outerHTML=`<span data-type="a" data-href="siyuan://blocks/${e.getAttribute("data-id")}">${e.innerHTML}</span><wbr>`,n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),fe(n,t.toolbar.range),s=n.outerHTML}}]),e.parentElement.textContent.trim()===e.textContent.trim()&&e.parentElement.tagName==="DIV"&&l.push({label:window.siyuan.languages.blockEmbed,icon:"iconSQL",click(){const r=`<div data-content="select * from blocks where id='${a}'" data-node-id="${i}" data-type="NodeBlockQueryEmbed" class="render-node" updated="${Q().format("YYYYMMDDHHmmss")}">${n.querySelector(".protyle-attr").outerHTML}</div>`;n.outerHTML=r,J(t,i,r,s),Be(t,t.wysiwyg.element),s=n.outerHTML}}),l.push({label:window.siyuan.languages.defBlock,click(){w("/api/block/swapBlockRef",{refID:i,defID:a,includeChildren:!1})}}),l.push({label:window.siyuan.languages.defBlockChildren,click(){w("/api/block/swapBlockRef",{refID:i,defID:a,includeChildren:!0})}}),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.turnInto,icon:"iconRefresh",submenu:l}).element)}window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy,icon:"iconCopy",click(){const l=e.getAttribute("data-subtype")==="s"?'"':"'";G(`((${a} ${l}${e.textContent}${l}))`)}}).element),t.disabled||window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.remove,icon:"iconTrashcan",click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s),fe(n,t.toolbar.range),s=n.outerHTML}}).element),t?.app?.plugins&&en({plugins:t.app.plugins,type:"open-menu-blockref",detail:{protyle:t,element:e},separatorPosition:"top"});const o=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+26,h:26}),window.siyuan.menus.menu.element.setAttribute("data-from",A(t.element,"block__edit")?"popover":"app"),t.disabled||(window.siyuan.menus.menu.element.querySelector("input").select(),window.siyuan.menus.menu.removeCB=()=>{n.outerHTML!==s&&(n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,n.outerHTML,s));const l=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);l&&!t.element.contains(l.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range))})},s_=(t,e)=>{const n=re(e);if(window.siyuan.menus.menu.remove(),n.toString()!==""||n.cloneContents().childNodes[0]?.classList?.contains("emoji")){if(window.siyuan.menus.menu.append(new S({icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click(){Z(re(e)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){Z(re(e)),ee(getSelection().getRangeAt(0).toString())}}).element),t.disabled)return;window.siyuan.menus.menu.append(new S({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){Z(re(e)),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click(){const a=re(e);a.insertNode(document.createElement("wbr"));const i=e.outerHTML;a.extractContents(),fe(e,a),Z(a),J(t,e.getAttribute("data-node-id"),e.outerHTML,i)}}).element)}else{const a=se(n.startContainer,"SPAN");if(a){const i=t.toolbar.getCurrentType(n);(i.includes("code")||i.includes("kbd"))&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copyInline,click(){ee(a.textContent)}}).element)}}if(t.disabled||(window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.paste,icon:"iconPaste",accelerator:"\u2318V",async click(){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const a=await ce();kd(t,a,e)}catch(a){console.log(a)}}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.pasteAsPlainText,accelerator:"\u21E7\u2318V",click(){Z(re(e)),Ed(t)}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.pasteEscaped,click(){Op(t,e)}}).element)),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.selectAll,icon:"iconSelect",accelerator:"\u2318A",click(){Fo(t,e,n)}}).element),e.classList.contains("table")){const a=se(n.startContainer,"TD")||se(n.startContainer,"TH");a&&window.siyuan.menus.menu.append(new S({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:_g(t,e,a,n)}).element)}t?.app?.plugins&&en({plugins:t.app.plugins,type:"open-menu-content",detail:{protyle:t,range:n,element:e},separatorPosition:"top"})},Ud=(t,e)=>{if(t.block.showAll)Vt({protyle:t,id:t.block.parent2ID,focusId:e});else{const n=t.path.split("/");n.length>2&&de({app:t.app,id:n[n.length-2],action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]})}},Vt=t=>{if(t.protyle.options.backlinkData)return;typeof t.isPushBack>"u"&&(t.isPushBack=!0),typeof t.reload>"u"&&(t.reload=!1);const e=t.protyle.breadcrumb?.element.querySelector(".protyle-breadcrumb__item--active");if(!t.reload&&e&&e.getAttribute("data-node-id")===t.id){if(t.id===t.protyle.block.rootID)return;const n=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId||t.id}"]`);if(n){le(n),n.scrollIntoView();return}}window.siyuan.mobile?.editor&&(window.siyuan.storage[p.Constants.LOCAL_DOCINFO]={id:t.id},pe(p.Constants.LOCAL_DOCINFO,window.siyuan.storage[p.Constants.LOCAL_DOCINFO]),t.isPushBack&&Hd()),w("/api/filetree/getDoc",{id:t.id,size:t.id===t.protyle.block.rootID?window.siyuan.config.editor.dynamicLoadBlocks:p.Constants.SIZE_GET_MAX},n=>{if(t.isPushBack?st({data:n,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_HTML],afterCB:t.callback}):st({data:n,protyle:t.protyle,action:t.id===t.protyle.block.rootID?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_HTML,p.Constants.CB_GET_UNUNDO]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_UNUNDO,p.Constants.CB_GET_HTML],afterCB:t.callback}),t.focusId){const a=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId}"]`);if(a)le(a),a.scrollIntoView();else if(t.id===t.protyle.block.rootID){w("/api/filetree/getDoc",{id:t.focusId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{st({data:i,protyle:t.protyle,action:t.isPushBack?[p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_UNUNDO]})});return}}else t.id!==t.protyle.block.rootID&&(t.protyle.wysiwyg.element.classList.add("protyle-wysiwyg--animate"),setTimeout(()=>{t.protyle.wysiwyg.element.classList.remove("protyle-wysiwyg--animate")},365));if(t.protyle.model){const a=Pe();a.outline.forEach(i=>{i.blockId===t.protyle.block.rootID&&i.setCurrent(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.focusId||t.id}"]`))}),xu(a,t.protyle)}})},Wd=(t,e,n,a)=>{window.siyuan.menus.menu.remove();const i=x(n);if(!i)return;X(["util","toolbar","hint"],t);const s=i.getAttribute("data-node-id"),o=n.querySelector("img"),l=n.querySelector(".protyle-action__title"),r=i.outerHTML;if(t.disabled||(window.siyuan.menus.menu.append(new S({iconHTML:"",type:"readonly",label:`<div class="b3-menu__label">${window.siyuan.languages.imageURL}</div>
<textarea style="margin:4px 0;width: ${(0,I.tq)()?"200":"360"}px" rows="1" class="b3-text-field">${o.getAttribute("src")}</textarea>
<div class="fn__hr"></div>
<div class="b3-menu__label">${window.siyuan.languages.title}</div>
<textarea style="margin:4px 0;width: ${(0,I.tq)()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="b3-menu__label">${window.siyuan.languages.tooltipText}</div>
<textarea style="margin:4px 0;width: ${(0,I.tq)()?"200":"360"}px" rows="1" class="b3-text-field"></textarea>`,bind(d){d.style.maxWidth="none";const u=d.querySelectorAll("textarea");u[0].addEventListener("input",f=>{if(f.isComposing)return;const g=f.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");if(o.setAttribute("src",g),o.setAttribute("data-src",g),g.startsWith("assets/")){const h=n.querySelector(".img__net");h&&h.remove()}else window.siyuan.config.editor.displayNetImgMark&&n.querySelector(".protyle-action__drag").insertAdjacentHTML("afterend",'<span class="img__net"><svg><use xlink:href="#iconLanguage"></use></svg></span>')}),u[1].value=l.textContent,u[1].addEventListener("input",f=>{const g=f.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"");o.setAttribute("title",g),l.textContent=g,Ln(l)}),u[2].value=o.getAttribute("alt")||""}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element)),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy,accelerator:"\u2318C",icon:"iconCopy",click(){G(t.lute.BlockDOM2StdMd(n.outerHTML))}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy+" PNG",accelerator:window.siyuan.config.keymap.editor.general.copyBlockRef.custom,icon:"iconImage",click(){rp(o)}}).element),!t.disabled){window.siyuan.menus.menu.append(new S({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click(){G(t.lute.BlockDOM2StdMd(n.outerHTML)),n.outerHTML="<wbr>",i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r),fe(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:function(){n.outerHTML="<wbr>",i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r),fe(t.wysiwyg.element,e)}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element);const d=o.getAttribute("data-src");d.startsWith("assets/")&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.rename,icon:"iconEdit",click(){sd(d)}}).element),window.siyuan.menus.menu.append(new S({label:"OCR",submenu:[{iconHTML:"",type:"readonly",label:`<textarea data-type="ocr" style="margin: 4px 0" rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.ocrResult}"></textarea>`,bind(f){f.style.maxWidth="none",w("/api/asset/getImageOCRText",{path:o.getAttribute("src"),force:!1},g=>{f.querySelector("textarea").value=g.data.text})}},{type:"separator"},{iconHTML:"",label:window.siyuan.languages.reOCR,click(){w("/api/asset/getImageOCRText",{path:o.getAttribute("src"),force:!0})}}]}).element),window.siyuan.menus.menu.append(new S({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click(){bg(t,i,[n],s,r)}}).element),window.siyuan.menus.menu.append(new S({icon:"iconAlignLeft",label:window.siyuan.languages.alignLeft,accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click(){wg(t,i,[n],s,r)}}).element);const u=n.style.width.endsWith("%")?parseInt(n.style.width):0;window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.width,submenu:[Si("25%",n,o,t,s,i,r),Si("33%",n,o,t,s,i,r),Si("50%",n,o,t,s,i,r),Si("67%",n,o,t,s,i,r),Si("75%",n,o,t,s,i,r),Si("100%",n,o,t,s,i,r),{type:"separator"},{iconHTML:"",type:"readonly",label:`<div style="margin: 4px 0;" aria-label="${u===0?window.siyuan.languages.default:u+"%"}" class="b3-tooltips b3-tooltips__n${(0,I.tq)()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${u}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(f){const g=f.querySelector("input");g.addEventListener("input",()=>{n.style.width=g.value+"%",o.style.width="10000px",g.parentElement.setAttribute("aria-label",`${g.value}%`)}),g.addEventListener("change",()=>{i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r),window.siyuan.menus.menu.remove(),le(i)})}},{type:"separator"},Si(window.siyuan.languages.default,n,o,t,s,i,r)]}).element)}const c=o.getAttribute("src");if(c&&(window.siyuan.menus.menu.append(new S({type:"separator"}).element),Lo(t.app,c,!1,!1)),window.siyuan.menus.menu.append(new S(zl(o.getAttribute("data-src"))).element),t?.app?.plugins&&en({plugins:t.app.plugins,type:"open-menu-image",detail:{protyle:t,element:n},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY}),window.siyuan.menus.menu.element.setAttribute("data-from",A(t.element,"block__edit")?"popover":"app"),!t.disabled){const d=window.siyuan.menus.menu.element.querySelectorAll("textarea");d[0].focus(),window.siyuan.menus.menu.removeCB=()=>{const u=window.siyuan.menus.menu.element.querySelector('[data-type="ocr"]');u&&w("/api/asset/setImageOCRText",{path:o.getAttribute("src"),text:u.value}),o.setAttribute("alt",d[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),i.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,s,i.outerHTML,r)}}},vo=(t,e,n=!1)=>{window.siyuan.menus.menu.remove();const a=x(e);if(!a)return;X(["util","toolbar","hint"],t);const i=a.getAttribute("data-node-id");let s=a.outerHTML;const o=e.getAttribute("data-href");let l;window.siyuan.menus.menu.append(new S({iconHTML:"",type:"readonly",label:`<div class="b3-menu__label">${window.siyuan.languages.link}</div>
<textarea rows="1" style="margin:4px 0;width: ${(0,I.tq)()?"200":"360"}px" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="b3-menu__label">${window.siyuan.languages.anchor}</div>
<textarea style="width: ${(0,I.tq)()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>
<div class="fn__hr"></div>
<div class="b3-menu__label">${window.siyuan.languages.title}</div>
<textarea style="width: ${(0,I.tq)()?"200":"360"}px;margin: 4px 0;" rows="1" class="b3-text-field"></textarea>`,bind(c){c.style.maxWidth="none",l=c.querySelectorAll("textarea"),l[0].value=Lute.UnEscapeHTMLStr(o)||"",l[0].addEventListener("keydown",u=>{if((u.key==="Enter"||u.key==="Escape")&&!u.isComposing)u.preventDefault(),u.stopPropagation(),window.siyuan.menus.menu.remove();else if(u.key==="Tab"&&!u.isComposing)u.preventDefault(),u.stopPropagation(),l[1].focus();else if(Ya(u))return});let d=e.textContent.replace(p.Constants.ZWSP,"");!d&&o&&(d=o.replace("https://","").replace("http://",""),d.length>24&&(d=d.substring(0,p.Constants.SIZE_LINK_TEXT_MAX)+"..."),e.innerHTML=Lute.EscapeHTMLStr(d)),l[1].value=d,l[1].addEventListener("compositionend",()=>{e.innerHTML=Lute.EscapeHTMLStr(l[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")||"*")}),l[1].addEventListener("input",u=>{u.isComposing||(e.innerHTML=Lute.EscapeHTMLStr(l[1].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))||"*")}),l[1].addEventListener("keydown",u=>{if((u.key==="Enter"||u.key==="Escape")&&!u.isComposing)u.preventDefault(),u.stopPropagation(),window.siyuan.menus.menu.remove();else if(u.key==="Tab"&&!u.isComposing)u.preventDefault(),u.stopPropagation(),u.shiftKey?l[0].focus():l[2].focus();else if(Ya(u))return}),l[2].value=Lute.UnEscapeHTMLStr(e.getAttribute("data-title")||""),l[2].addEventListener("keydown",u=>{if((u.key==="Enter"||u.key==="Escape")&&!u.isComposing)u.preventDefault(),u.stopPropagation(),window.siyuan.menus.menu.remove();else if(u.key==="Tab"&&u.shiftKey&&!u.isComposing)u.preventDefault(),u.stopPropagation(),l[1].focus();else if(Ya(u))return})}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),o&&(Lo(t.app,o,!1,!0),o?.startsWith("assets/")&&window.siyuan.menus.menu.append(new S(zl(o)).element)),o?.startsWith("assets/")&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.rename,icon:"iconEdit",click(){sd(o)}}).element),o?.startsWith("siyuan://blocks/")&&window.siyuan.menus.menu.append(new S({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.ref}</b>`,icon:"iconRef",click(){e.setAttribute("data-subtype","s");const c=e.getAttribute("data-type").split(" ");c.push("block-ref"),c.splice(c.indexOf("a"),1),e.setAttribute("data-type",c.join(" ")),e.setAttribute("data-id",l[0].value.replace("siyuan://blocks/","")),l[0].value="",l[2].value="",e.removeAttribute("data-href"),e.removeAttribute("data-title"),a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,a.outerHTML,s),t.toolbar.range.selectNode(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range),s=a.outerHTML}}).element),window.siyuan.menus.menu.append(new S({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){l[0].value="",l[2].value="",a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),Od(e,"a",t.toolbar.range),J(t,i,a.outerHTML,s),s=a.outerHTML}}).element),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,a.outerHTML,s),fe(a,t.toolbar.range),s=a.outerHTML}}).element),t?.app?.plugins&&en({plugins:t.app.plugins,type:"open-menu-link",detail:{protyle:t,element:e},separatorPosition:"top"});const r=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:r.left,y:r.top+26,h:26}),window.siyuan.menus.menu.element.setAttribute("data-from",A(t.element,"block__edit")?"popover":"app"),n||t.lute.IsValidLinkDest(o)?l[1].select():l[0].select(),window.siyuan.menus.menu.removeCB=()=>{l[2].value?e.setAttribute("data-title",Lute.EscapeHTMLStr(l[2].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):e.removeAttribute("data-title"),e.getAttribute("data-type").indexOf("a")>-1?e.setAttribute("data-href",Lute.EscapeHTMLStr(l[0].value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""))):e.removeAttribute("data-href");const c=getSelection().rangeCount===0?void 0:getSelection().getRangeAt(0);c&&!t.element.contains(c.startContainer)&&(t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range)),s!==a.outerHTML&&(a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,i,a.outerHTML,s))}},Vd=(t,e)=>{window.siyuan.menus.menu.remove();const n=x(e);if(!n)return;X(["util","toolbar","hint"],t);const a=n.getAttribute("data-node-id");let i=n.outerHTML;window.siyuan.menus.menu.append(new S({iconHTML:"",type:"readonly",label:`<input class="b3-text-field fn__size200" style="margin: 4px 0" placeholder="${window.siyuan.languages.tag}">`,bind(o){const l=o.querySelector("input");l.value=e.textContent.replace(p.Constants.ZWSP,""),l.addEventListener("change",()=>{J(t,a,n.outerHTML,i),i=n.outerHTML}),l.addEventListener("compositionend",()=>{e.innerHTML=p.Constants.ZWSP+Lute.EscapeHTMLStr(l.value||"")}),l.addEventListener("input",r=>{r.isComposing||(e.innerHTML=p.Constants.ZWSP+Lute.EscapeHTMLStr(l.value||""))}),l.addEventListener("keydown",r=>{if((r.key==="Enter"||r.key==="Escape")&&!r.isComposing){if(r.preventDefault(),r.stopPropagation(),l.value)t.toolbar.range.selectNodeContents(e),t.toolbar.range.collapse(!1),Z(t.toolbar.range);else{const c=n.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,c),fe(n,t.toolbar.range)}window.siyuan.menus.menu.remove()}else if(Ya(r))return})}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.search,accelerator:"Click",icon:"iconSearch",click(){Fn(t.app,`#${e.textContent}#`,!1)}}).element),window.siyuan.menus.menu.append(new S({label:`${window.siyuan.languages.turnInto} <b>${window.siyuan.languages.text}</b>`,icon:"iconRefresh",click(){t.toolbar.range.setStart(e.firstChild,0),t.toolbar.range.setEnd(e.lastChild,e.lastChild.textContent.length),t.toolbar.setInlineMark(t,"tag","range")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.rename,icon:"iconEdit",click(){sp(e.textContent.replace(p.Constants.ZWSP,""))}}).element),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:window.siyuan.languages.remove,click(){const o=n.outerHTML;e.insertAdjacentHTML("afterend","<wbr>"),e.remove(),n.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,a,n.outerHTML,o),fe(n,t.toolbar.range)}}).element),t?.app?.plugins&&en({plugins:t.app.plugins,type:"open-menu-tag",detail:{protyle:t,element:e},separatorPosition:"top"});const s=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:s.left,y:s.top+26,h:26}),window.siyuan.menus.menu.element.setAttribute("data-from",A(t.element,"block__edit")?"popover":"app"),window.siyuan.menus.menu.element.querySelector("input").select()},Si=(t,e,n,a,i,s,o)=>({iconHTML:"",label:t,click(){if(s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),t===window.siyuan.languages.default){const l=e.style.display==="block";e.removeAttribute("style"),n.removeAttribute("style"),l&&(e.style.display="block")}else e.style.width=t,n.style.width="10000px";J(a,i,s.outerHTML,o),le(s)}}),o_=(t,e)=>{const n=e.getAttribute("data-node-id"),a=e.querySelector("iframe");let i=e.outerHTML;const s=[{iconHTML:"",type:"readonly",label:`<textarea rows="1" class="b3-text-field fn__size200" placeholder="${window.siyuan.languages.link}" style="margin: 4px 0">${a.getAttribute("src")||""}</textarea>`,bind(l){l.style.maxWidth="none",l.querySelector("textarea").addEventListener("change",r=>{const c=r.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,""),d=c.match(/(?:www\.|\/\/)bilibili\.com\/video\/(\w+)/);if(c.indexOf("bilibili.com")>-1&&(c.indexOf("bvid=")>-1||d&&d[1])){const u={bvid:(0,I.on)("bvid",c)||d&&d[1],page:"1",high_quality:"1",as_wide:"1",allowfullscreen:"true"};new URL(c.startsWith("http")?c:"https:"+c).search.split("&").forEach((h,m)=>{m===0&&(h=h.substr(1));const b=h.split("=");u[b[0]]=b[1]});let f="https://player.bilibili.com/player.html?";const g=Object.keys(u);g.forEach((h,m)=>{f+=`${h}=${u[h]}`,m<g.length-1&&(f+="&")}),a.setAttribute("src",f),a.setAttribute("sandbox","allow-top-navigation-by-user-activation allow-same-origin allow-forms allow-scripts allow-popups"),a.style.height||(a.style.height="360px"),a.style.width||(a.style.width="640px")}else a.setAttribute("src",c);J(t,n,e.outerHTML,i),i=e.outerHTML,r.stopPropagation()})}}],o=a.getAttribute("src");return o?(s.push({type:"separator"}),s.concat(Lo(t.app,o,!0,!1))):s},l_=(t,e,n)=>{const a=e.getAttribute("data-node-id"),i=e.querySelector(n==="NodeVideo"?"video":"audio");let s=e.outerHTML;const o=[{iconHTML:"",type:"readonly",label:`<textarea rows="1" style="margin: 4px 0" class="b3-text-field" placeholder="${window.siyuan.languages.link}">${i.getAttribute("src")}</textarea>`,bind(c){c.style.maxWidth="none",c.querySelector("textarea").addEventListener("change",d=>{i.setAttribute("src",d.target.value.replace(/\n|\r\n|\r|\u2028|\u2029/g,"")),J(t,a,e.outerHTML,s),s=e.outerHTML,d.stopPropagation()})}}],l=i.getAttribute("src");l.startsWith("assets/")&&(o.push({type:"separator"}),o.push({label:window.siyuan.languages.rename,icon:"iconEdit",click(){sd(l)}}));const r=i.getAttribute("src");return r&&o.push({label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:Lo(t.app,r,!0,!1)}),o.push(zl(l)),o},_g=(t,e,n,a)=>{const i=[],s=xn(n);(n.rowSpan>1||n.colSpan>1)&&i.push({label:window.siyuan.languages.cancelMerged,click:()=>{const E=e.outerHTML;let T=n.rowSpan,H=n.parentElement;const D=n.colSpan;for(;T>0&&H;){let U=H.children[s],ye=D;for(;ye>0&&U;)U.classList.remove("fn__none"),U.colSpan=1,U.rowSpan=1,U=U.nextElementSibling,ye--;H=H.nextElementSibling,T--}if(n.rowSpan=1,n.colSpan=1,n.tagName==="TH"){let U;if(Array.from(e.querySelectorAll("thead tr")).find(ye=>{if(U=ye,Array.from(ye.children).forEach(Fe=>{(Fe.rowSpan!==1||Fe.classList.contains("fn__none"))&&(U=void 0)}),U)return!0}),U){const ye=e.querySelector("tbody"),Fe=e.querySelector("thead");for(;!U.isSameNode(Fe.lastElementChild);)ye.insertAdjacentElement("afterbegin",Fe.lastElementChild)}}Z(a),J(t,e.getAttribute("data-node-id"),e.outerHTML,E)}});const o=e.querySelectorAll("col")[s];(o.style.width||o.style.minWidth)&&i.push({label:window.siyuan.languages.useDefaultWidth,click:()=>{const E=e.outerHTML;o.style.width="",o.style.minWidth="",J(t,e.getAttribute("data-node-id"),e.outerHTML,E)}});const l=e.getAttribute("custom-pinthead");i.push({icon:l?"iconUnpin":"iconPin",label:l?window.siyuan.languages.unpinTableHead:window.siyuan.languages.pinTableHead,click:()=>{const E=e.outerHTML;l?e.removeAttribute("custom-pinthead"):e.setAttribute("custom-pinthead","true"),J(t,e.getAttribute("data-node-id"),e.outerHTML,E)}}),i.push({type:"separator"}),i.push({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{ya(t,[n],e,"left",a)}}),i.push({icon:"iconAlignCenter",label:window.siyuan.languages.alignCenter,accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{ya(t,[n],e,"center",a)}}),i.push({icon:"iconAlignRight",label:window.siyuan.languages.alignRight,accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{ya(t,[n],e,"right",a)}}),i.push({type:"separator"});const r=e.querySelector("table"),c=n.parentElement.querySelector(".fn__none");let d=!1,u=!1;Array.from(n.parentElement.children).forEach(E=>{E.colSpan>1&&(d=!0),E.rowSpan>1&&(u=!0)});let f=!1,g=!1,h=!1,m=n.parentElement.previousElementSibling;!m&&n.parentElement.parentElement.tagName==="TBODY"&&(m=r.querySelector("thead").lastElementChild),m&&(f=m.querySelector(".fn__none"),Array.from(m.children).forEach(E=>{E.colSpan>1&&(g=!0),E.rowSpan>1&&(h=!0)}));let b=!1,y=!1,_=!1,v=n.parentElement.nextElementSibling;!v&&n.parentElement.parentElement.tagName==="THEAD"&&(v=r.querySelector("tbody")?.firstElementChild),v&&(b=v.querySelector(".fn__none"),Array.from(v.children).forEach(E=>{E.colSpan>1&&(y=!0),E.rowSpan>1&&(_=!0)}));let k=!0;Array.from(r.rows).find(E=>{const T=E.cells[s];if(T.classList.contains("fn__none")||T.colSpan>1||T.rowSpan>1)return k=!1,!0});let L=!0;Array.from(r.rows).find(E=>{const T=E.cells[s+1];if(T&&(T.classList.contains("fn__none")||T.colSpan>1||T.rowSpan>1))return L=!1,!0});let C=!0;return Array.from(r.rows).find(E=>{const T=E.cells[s-1];if(T&&(T.classList.contains("fn__none")||T.colSpan>1||T.rowSpan>1))return C=!1,!0}),i.push({icon:"iconBefore",label:window.siyuan.languages.insertRowAbove,accelerator:window.siyuan.config.keymap.editor.table.insertRowAbove.custom,click:()=>{Xf(t,a,n,e)}}),(!b||b&&!_&&y)&&i.push({icon:"iconAfter",label:window.siyuan.languages.insertRowBelow,accelerator:window.siyuan.config.keymap.editor.table.insertRowBelow.custom,click:()=>{dd(t,a,n,e)}}),(k||C)&&i.push({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,accelerator:window.siyuan.config.keymap.editor.table.insertColumnLeft.custom,click:()=>{Vl(t,e,n,"beforebegin",a)}}),(k||L)&&i.push({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,accelerator:window.siyuan.config.keymap.editor.table.insertColumnRight.custom,click:()=>{Vl(t,e,n,"afterend",a)}}),((!c||c&&!u&&d)&&(!f||f&&!h&&g)||(!c||c&&!u&&d)&&(!b||b&&!_&&y)||k&&C||k&&L)&&i.push({type:"separator"}),(!c||c&&!u&&d)&&(!f||f&&!h&&g)&&i.push({icon:"iconUp",label:window.siyuan.languages.moveToUp,accelerator:window.siyuan.config.keymap.editor.table.moveToUp.custom,click:()=>{tp(t,a,n,e)}}),(!c||c&&!u&&d)&&(!b||b&&!_&&y)&&i.push({icon:"iconDown",label:window.siyuan.languages.moveToDown,accelerator:window.siyuan.config.keymap.editor.table.moveToDown.custom,click:()=>{np(t,a,n,e)}}),k&&C&&i.push({icon:"iconLeft",label:window.siyuan.languages.moveToLeft,accelerator:window.siyuan.config.keymap.editor.table.moveToLeft.custom,click:()=>{ap(t,a,n,e)}}),k&&L&&i.push({icon:"iconRight",label:window.siyuan.languages.moveToRight,accelerator:window.siyuan.config.keymap.editor.table.moveToRight.custom,click:()=>{ip(t,a,n,e)}}),(n.parentElement.parentElement.tagName!=="THEAD"&&(!c&&!u||c&&!u&&d)||k)&&i.push({type:"separator"}),n.parentElement.parentElement.tagName!=="THEAD"&&(!c&&!u||c&&!u&&d)&&i.push({icon:"iconDeleteRow",label:window.siyuan.languages["delete-row"],accelerator:window.siyuan.config.keymap.editor.table["delete-row"].custom,click:()=>{Qf(t,a,n,e)}}),k&&i.push({icon:"iconDeleteColumn",label:window.siyuan.languages["delete-column"],accelerator:window.siyuan.config.keymap.editor.table["delete-column"].custom,click:()=>{ep(t,a,e,n)}}),i},zt=(t,e,n,a)=>{if(e.getAttribute("data-type")==="NodeListItem"&&e.childElementCount<4||e.getAttribute("data-type")==="NodeThematicBreak")return-1;let i="0";if(e.getAttribute("fold")==="1"){if(typeof n=="boolean"&&!n)return-1;e.removeAttribute("fold"),e.querySelectorAll(".protyle-linenumber").forEach(o=>{So(o)})}else{if(typeof n=="boolean"&&n)return-1;if(i="1",e.setAttribute("fold","1"),getSelection().rangeCount>0){const o=getSelection().getRangeAt(0),l=x(o.startContainer);l&&l.getBoundingClientRect().width===0&&le(e,void 0,!1)}e.querySelectorAll(".img--select, .av__cell--select, .av__row--select").forEach(o=>{o.classList.contains("av__row--select")?(o.classList.remove("av__row--select"),o.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),ls(o)):o.classList.remove("img--select","av__cell--select")})}const s=e.getAttribute("data-node-id");return e.getAttribute("data-type")==="NodeHeading"?i==="0"?(e.insertAdjacentHTML("beforeend",'<div spin="1" style="text-align: center"><img width="24px" src="/stage/loading-pure.svg"></div>'),F(t,[{action:"unfoldHeading",id:s,data:a?"remove":void 0}],[{action:"foldHeading",id:s}])):(F(t,[{action:"foldHeading",id:s}],[{action:"unfoldHeading",id:s}]),Kp(e)):F(t,[{action:"setAttrs",id:s,data:JSON.stringify({fold:i})}],[{action:"setAttrs",id:s,data:JSON.stringify({fold:i==="0"?"1":"0"})}]),ln(t),i},vg=(t,e)=>{const n=be(t),a=[];if(n.isSameNode(t)||(t.remove(),a.push({action:"delete",id:n.getAttribute("data-node-id")})),n.remove(),e.block.rootID===e.block.id&&e.wysiwyg.element.childElementCount===0){const i=Lute.NewNodeID(),s=Cn(!1,!1,i);a.push({action:"insert",data:s.outerHTML,id:i,parentID:e.block.parentID}),e.wysiwyg.element.innerHTML=s.outerHTML}a.length>0&&F(e,a,[])},Eg=()=>{if(window.siyuan.transactions.length===0)return;const t=window.siyuan.transactions[0].protyle,e=window.siyuan.transactions[0].doOperations,n=window.siyuan.transactions[0].undoOperations;window.siyuan.transactions.splice(0,1),w("/api/transactions",{session:t.id,app:p.Constants.SIYUAN_APPID,transactions:[{doOperations:e,undoOperations:n}]},a=>{if(window.siyuan.transactions.length===0?Gt([],t.block.rootID,!0):Eg(),a.data[0].doOperations[0].action==="setAttrs"){const s=t.gutter.element.querySelector('[data-type="fold"]');s&&s.removeAttribute("disabled"),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${a.data[0].doOperations[0].id}"]`)&&(o.removeAttribute("data-render"),Be(t,o))});return}let i;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0)),a.data[0].doOperations.forEach(s=>{if(s.action==="unfoldHeading"||s.action==="foldHeading"){const o=t.gutter.element.querySelector('[data-type="fold"]');if(o&&o.removeAttribute("disabled"),s.action==="unfoldHeading"){const l=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(r=>{if(r.lastElementChild.classList.contains("protyle-attr")||r.lastElementChild.remove(),Lg(s.retData,t),r.insertAdjacentHTML("afterend",s.retData),s.data==="remove"){const c=getSelection();c.rangeCount>0&&r.contains(c.getRangeAt(0).startContainer)&&le(r.nextElementSibling,void 0,!0),r.remove()}}),bt(t.wysiwyg.element),qe(t.wysiwyg.element),mt(t.wysiwyg.element,t),Be(t,t.wysiwyg.element),t.contentElement.scrollTop=l,t.scroll.lastScrollTop=l;return}t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&!t.scroll.element.classList.contains("fn__none")&&t.contentElement.scrollHeight-t.contentElement.scrollTop<t.contentElement.clientHeight*2&&w("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{st({data:l,protyle:t,action:[p.Constants.CB_GET_APPEND,p.Constants.CB_GET_UNCHANGEID]})});return}if(s.action==="update"){t.options.backlinkData&&(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{(o.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(o,"data-type","NodeBlockQueryEmbed"))&&(i&&(o.isSameNode(i.startContainer)||o.contains(i.startContainer))||(o.outerHTML=s.data.replace("<wbr>","")))}),bt(t.wysiwyg.element),qe(t.wysiwyg.element),mt(t.wysiwyg.element,t),Be(t,t.wysiwyg.element)),zd(t,s),ms(t,s.id);return}if(s.action==="delete"||s.action==="append"){t.options.backlinkData&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(o=>{q(o,"data-type","NodeBlockQueryEmbed")||o.remove()}),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"]`)&&(o.removeAttribute("data-render"),Be(t,o))});return}if(s.action==="move"){if(t.options.backlinkData){const o=[];Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`)).forEach(r=>{if(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(r,"data-type","NodeBlockQueryEmbed")){o.push(r);return}});let l=!1;s.previousID&&o.length>0?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(r=>{(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&(r.after(o[0].cloneNode(!0)),l=!0)}):o.length>0&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(r=>{(r.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(r.parentElement,"data-type","NodeBlockQueryEmbed"))&&(r.firstElementChild?.classList.contains("protyle-action")?r.firstElementChild.after(o[0].cloneNode(!0)):r.prepend(o[0].cloneNode(!0)),l=!0)}),o.forEach(r=>{l?r.remove():!l&&r.parentElement&&vg(r,t)})}t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${s.id}"]`)&&(o.removeAttribute("data-render"),Be(t,o))});return}if(s.action==="insert"){if(t.options.backlinkData){const o=[];s.previousID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.previousID}"]`)).forEach(l=>{l.nextElementSibling?.getAttribute("data-node-id")!==s.id&&!q(l,"data-node-id",s.id)&&(l.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(l.parentElement,"data-type","NodeBlockQueryEmbed"))&&(l.insertAdjacentHTML("afterend",s.data),o.push(l.nextElementSibling))}):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${s.parentID}"]`)).forEach(l=>{(l.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(l.parentElement,"data-type","NodeBlockQueryEmbed"))&&(l.firstElementChild&&l.firstElementChild.classList.contains("protyle-action")&&l.firstElementChild.nextElementSibling.getAttribute("data-node-id")!==s.id?(l.firstElementChild.insertAdjacentHTML("afterend",s.data),o.push(l.firstElementChild.nextElementSibling)):l.firstElementChild&&l.firstElementChild.getAttribute("data-node-id")!==s.id&&(l.insertAdjacentHTML("afterbegin",s.data),o.push(l.firstElementChild)))}),t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(l=>{l.lastElementChild.getAttribute("spin")==="1"&&l.lastElementChild.remove()}),o.forEach(l=>{bt(l),qe(l),mt(l,t),Be(t,l);const r=l.querySelector("wbr");r&&r.remove()})}ms(t,s.id)}})})},zd=(t,e)=>{let n=!1;t.wysiwyg.element.querySelectorAll(`[data-type="NodeBlockQueryEmbed"] [data-node-id="${e.id}"]`).forEach(a=>{const i=document.createElement("div");i.innerHTML=e.data,i.querySelectorAll('[contenteditable="true"]').forEach(o=>{o.setAttribute("contenteditable","false")});const s=i.querySelector("wbr");s&&s.remove(),a.outerHTML=i.innerHTML,n=!0}),n&&(bt(t.wysiwyg.element),qe(t.wysiwyg.element),mt(t.wysiwyg.element,t))},kg=(t,e,n,a)=>{a&&Rr(t[0]),t.forEach(i=>{i.remove()}),n.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(i=>{i.querySelector(`[data-node-id="${e}"]`)&&(i.removeAttribute("data-render"),Be(n,i))})},Sg=(t,e,n,a)=>{t.forEach(s=>{s.getAttribute("data-subtype")==="echarts"?s.outerHTML=e.lute.SpinBlockDOM(n.data):s.outerHTML=n.data}),Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${n.id}"]`)).find(s=>{if(s.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(s,"data-type","NodeBlockQueryEmbed"))return t[0]=s,!0});const i=t[0].querySelector("wbr");if(a){const s=re(t[0]);i?fe(t[0],s):le(t[0])}else i&&i.remove();bt(t.length===1?t[0]:e.wysiwyg.element),qe(t.length===1?t[0]:e.wysiwyg.element),mt(t.length===1?t[0]:e.wysiwyg.element,e),Be(e,t.length===1?t[0]:e.wysiwyg.element),zd(e,n),ms(e,n.id)},Yd=(t,e,n)=>{const a=[];if(Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(i=>{q(i.parentElement,"data-type","NodeBlockQueryEmbed")||a.push(i)}),e.action==="setAttrs"){t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{JSON.parse(e.data).fold==="1"?i.setAttribute("fold","1"):i.removeAttribute("fold")});return}if(e.action==="unfoldHeading"){const i=t.contentElement.scrollTop;t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(s=>{e.retData&&(Lg(e.retData,t),s.insertAdjacentHTML("afterend",e.retData)),s.removeAttribute("fold"),e.data==="remove"&&s.remove()}),e.retData&&(bt(t.wysiwyg.element),qe(t.wysiwyg.element),mt(t.wysiwyg.element,t),Be(t,t.wysiwyg.element),t.contentElement.scrollTop=i,t.scroll.lastScrollTop=i);return}if(e.action==="foldHeading"){t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(i=>{i.setAttribute("fold","1"),e.retData||Kp(i)}),e.retData&&e.retData.forEach(i=>{t.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`).forEach(s=>{s.remove()})});return}if(e.action==="delete"){a.length>0?kg(a,e.id,t,n):n&&Vt({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(i=>{q(i.parentElement,"data-type","NodeBlockQueryEmbed")||a.push(i)}),kg(a,e.id,t,n)}});return}if(e.action==="update"){a.length>0?Sg(a,t,e,n):n?Vt({protyle:t,id:t.block.rootID,isPushBack:!1,focusId:e.id,callback(){Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).forEach(i=>{q(i.parentElement,"data-type","NodeBlockQueryEmbed")||a.push(i)}),Sg(a,t,e,n)}}):(zd(t,e),ms(t,e.id));return}if(e.action==="updateAttrs"){const i=e.data,s={};let o="",l="",r="",c="",d="";Object.keys(i.new).forEach(f=>{s[f]=i.new[f];const g=Lute.EscapeHTMLStr(i.new[f]);f==="bookmark"?o=`<div class="protyle-attr--bookmark">${g}</div>`:f==="name"?l=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${g}</div>`:f==="alias"?r=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${g}</div>`:f==="memo"?c=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${g}"><svg><use xlink:href="#iconM"></use></svg></div>`:f==="custom-avs"&&(d='<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg></div>')});let u=o+l+r+c+d;if(t.block.rootID===e.id){if(t.title){const f=t.title.element.querySelector(".protyle-attr--refcount");f&&(u+=f.outerHTML),i.new[p.Constants.CUSTOM_RIFF_DECKS]&&i.new[p.Constants.CUSTOM_RIFF_DECKS]!==i.old[p.Constants.CUSTOM_RIFF_DECKS]?(t.title.element.style.animation="addCard 450ms linear",t.title.element.setAttribute(p.Constants.CUSTOM_RIFF_DECKS,i.new[p.Constants.CUSTOM_RIFF_DECKS]),setTimeout(()=>{t.title.element.style.animation=""},450)):i.new[p.Constants.CUSTOM_RIFF_DECKS]||t.title.element.removeAttribute(p.Constants.CUSTOM_RIFF_DECKS),t.title.element.querySelector(".protyle-attr").innerHTML=u}if(t.wysiwyg.renderCustom(s),i.new[p.Constants.CUSTOM_SY_FULLWIDTH]!==i.old[p.Constants.CUSTOM_SY_FULLWIDTH]&&qt(t),i.new[p.Constants.CUSTOM_SY_READONLY]!==i.old[p.Constants.CUSTOM_SY_READONLY]){let f=i.new[p.Constants.CUSTOM_SY_READONLY];f||(f=window.siyuan.config.editor.readOnly?"true":"false"),f==="true"?ia(t):Kd(t)}i.new.icon!==i.old.icon&&t.background&&t.background.ial.icon!==i.new.icon&&(t.background.ial.icon=i.new.icon,t.background.render(t.background.ial,t.block.rootID),t.model?.parent.setDocIcon(i.new.icon));return}t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`).forEach(f=>{if(f.getAttribute("data-type")==="NodeThematicBreak")return;Object.keys(i.old).forEach(h=>{f.removeAttribute(h)}),i.new.style&&i.new[p.Constants.CUSTOM_RIFF_DECKS]&&i.new[p.Constants.CUSTOM_RIFF_DECKS]!==i.old[p.Constants.CUSTOM_RIFF_DECKS]&&(i.new.style+=";animation:addCard 450ms linear"),Object.keys(i.new).forEach(h=>{f.setAttribute(h,i.new[h]),h===p.Constants.CUSTOM_RIFF_DECKS&&i.new[p.Constants.CUSTOM_RIFF_DECKS]!==i.old[p.Constants.CUSTOM_RIFF_DECKS]&&(f.style.animation="addCard 450ms linear",setTimeout(()=>{f.style.animation=""},450))});const g=f.lastElementChild.querySelector(".protyle-attr--refcount");g&&(u+=g.outerHTML),f.lastElementChild.innerHTML=u+p.Constants.ZWSP});return}if(e.action==="move"){let i;n&&getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0),i.insertNode(document.createElement("wbr"))),a.length===0&&Pe().editor.forEach(o=>{const l=o.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${e.id}"]`);l&&a.push(l.cloneNode(!0))}),a.length===0&&window.siyuan.blockPanels.forEach(o=>{const l=o.element.querySelector(`[data-node-id="${e.id}"]`);l&&a.push(l.cloneNode(!0))});let s=!1;e.previousID&&a.length>0?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(o=>{q(o.parentElement,"data-type","NodeBlockQueryEmbed")||(o.after(a[0].cloneNode(!0)),s=!0)}):a.length>0&&(!t.options.backlinkData&&e.parentID===t.block.parentID?(t.wysiwyg.element.prepend(a[0].cloneNode(!0)),s=!0):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(o=>{q(o.parentElement,"data-type","NodeBlockQueryEmbed")||(o.firstElementChild?.classList.contains("protyle-action")?o.firstElementChild.after(a[0].cloneNode(!0)):o.prepend(a[0].cloneNode(!0)),s=!0)})),a.forEach(o=>{s?o.remove():!s&&o.parentElement&&vg(o,t)}),n&&i&&(e.data==="focus"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(o=>{if(!q(o.parentElement,"data-type","NodeBlockQueryEmbed"))return le(o),!0}):fe(t.wysiwyg.element,i)),t.wysiwyg.element.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(o=>{o.querySelector(`[data-node-id="${e.id}"],[data-node-id="${e.parentID}"],[data-node-id="${e.previousID}"]`)&&(o.removeAttribute("data-render"),Be(t,o))});return}if(e.action==="insert"){const i=[];if(e.previousID?Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.previousID}"]`)).forEach(s=>{const o=q(s.parentElement,"data-type","NodeBlockQueryEmbed");o?(o.removeAttribute("data-render"),Be(t,o)):(s.insertAdjacentHTML("afterend",e.data),i.push(s.nextElementSibling))}):!t.options.backlinkData&&e.parentID===t.block.parentID?(t.wysiwyg.element.insertAdjacentHTML("afterbegin",e.data),i.push(t.wysiwyg.element.firstElementChild)):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${e.parentID}"]`)).forEach(s=>{q(s.parentElement,"data-type","NodeBlockQueryEmbed")||(s.firstElementChild?.classList.contains("protyle-action")?(s.firstElementChild.insertAdjacentHTML("afterend",e.data),i.push(s.firstElementChild.nextElementSibling)):(s.insertAdjacentHTML("afterbegin",e.data),i.push(s.firstElementChild)))}),t.wysiwyg.element.querySelectorAll('[data-type="NodeHeading"]').forEach(s=>{s.lastElementChild.getAttribute("spin")==="1"&&s.lastElementChild.remove()}),i.length===0)return;i.forEach(s=>{bt(s),qe(s),mt(s,t),Be(t,s);const o=s.querySelector("wbr");if(n){const l=re(s);o?fe(s,l):le(s)}else o&&o.remove()}),ms(t,e.id)}else e.action==="append"?na(t,!1):["addAttrViewCol","insertAttrViewBlock","updateAttrViewCol","updateAttrViewColOptions","updateAttrViewColOption","updateAttrViewCell","sortAttrViewRow","sortAttrViewCol","setAttrViewColHidden","setAttrViewColWrap","setAttrViewColWidth","removeAttrViewColOption","setAttrViewName","setAttrViewFilters","setAttrViewSorts","setAttrViewColCalc","removeAttrViewCol","updateAttrViewColNumberFormat","removeAttrViewBlock","replaceAttrViewBlock","updateAttrViewColTemplate","setAttrViewColPin","addAttrViewView","removeAttrViewView","setAttrViewViewName","setAttrViewViewIcon","duplicateAttrViewView","sortAttrViewView","updateAttrViewColRelation","setAttrViewPageSize","updateAttrViewColRollup"].includes(e.action)?r_(t,e,n):e.action==="doUpdateUpdated"&&a.forEach(i=>{i.setAttribute("updated",e.data)})},sr=t=>{let e;const n=Lute.NewNodeID();if(t.type==="BlocksMergeSuperBlock")e=Kf(t.level,n);else if(t.type==="Blocks2Blockquote")e=document.createElement("div"),e.classList.add("bq"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeBlockquote"),e.innerHTML='<div class="protyle-attr" contenteditable="false"></div>';else if(t.type.endsWith("Ls")){e=document.createElement("div"),e.classList.add("list"),e.setAttribute("data-node-id",n),e.setAttribute("data-type","NodeList"),t.type==="Blocks2ULs"?e.setAttribute("data-subtype","u"):t.type==="Blocks2OLs"?e.setAttribute("data-subtype","o"):e.setAttribute("data-subtype","t");let r="";t.selectsElement.forEach((c,d)=>{t.type==="Blocks2ULs"?r+=`<div data-marker="*" data-subtype="u" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`:t.type==="Blocks2OLs"?r+=`<div data-marker="${d+1}." data-subtype="o" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--order" contenteditable="false" draggable="true">${d+1}.</div><div class="protyle-attr" contenteditable="false"></div></div>`:r+=`<div data-marker="*" data-subtype="t" data-node-id="${Lute.NewNodeID()}" data-type="NodeListItem" class="li"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#iconUncheck"></use></svg></div><div class="protyle-attr" contenteditable="false"></div></div>`}),e.innerHTML=r+'<div class="protyle-attr" contenteditable="false"></div>'}const a=t.selectsElement[0].getAttribute("data-node-id"),i=t.selectsElement[0].parentElement.getAttribute("data-node-id")||t.protyle.block.parentID,s=[{action:"insert",id:n,data:e.outerHTML,nextID:a,parentID:i}],o=[];t.selectsElement[0].previousElementSibling?t.selectsElement[0].before(e):t.selectsElement[0].parentElement.prepend(e);let l;t.selectsElement.forEach((r,c)=>{r.classList.remove("protyle-wysiwyg--select"),r.removeAttribute("select-start"),r.removeAttribute("select-end");const d=r.getAttribute("data-node-id");o.push({action:"move",id:d,previousID:l||n,parentID:i}),t.type.endsWith("Ls")?(s.push({action:"move",id:d,parentID:e.children[c].getAttribute("data-node-id")}),e.children[c].firstElementChild.after(r)):(s.push({action:"move",id:d,previousID:l,parentID:n}),e.lastElementChild.before(r)),l=r.getAttribute("data-node-id"),c===t.selectsElement.length-1&&o.push({action:"delete",id:n}),r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(r.removeAttribute("data-render"),Be(t.protyle,r))}),F(t.protyle,s,o),le(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${t.selectsElement[0].getAttribute("data-node-id")}"]`)),X(["gutter"],t.protyle)},Lg=(t,e)=>{const n=document.createElement("template");n.innerHTML=t,Array.from(n.content.children).forEach(a=>{e.wysiwyg.element.querySelector(`:scope > [data-node-id="${a.getAttribute("data-node-id")}"]`)?.remove()})},aa=t=>{let e=t.selectsElement,n;if(t.nodeElement){n=getSelection().getRangeAt(0),n.insertNode(document.createElement("wbr")),e=Array.from(t.protyle.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),e.length===0&&(e=[t.nodeElement]);let l=!1,r=!1,c=!1;if(e.find((d,u)=>{if(d.classList.contains("li"))return c=!0,!0;if((d.classList.contains("bq")||d.classList.contains("sb")||d.classList.contains("p"))&&(r=!0),d.nextElementSibling&&e[u+1]&&d.nextElementSibling.isSameNode(e[u+1]))l=!0;else if(u!==e.length-1)return l=!1,!0}),c||r&&t.type==="Blocks2Ps")return;e.length===1&&t.type==="Blocks2Hs"&&e[0].getAttribute("data-type")==="NodeHeading"&&t.level===parseInt(e[0].getAttribute("data-subtype").substr(1))&&(t.type="Blocks2Ps"),t.isContinue=l}let a="";const i=[],s=[],o=document.createElement("div");e.forEach((l,r)=>{(t.type==="Blocks2Ps"||t.type==="Blocks2Hs")&&l.getAttribute("data-type")==="NodeHeading"&&l.getAttribute("fold")==="1"&&zt(t.protyle,l),l.classList.remove("protyle-wysiwyg--select"),l.removeAttribute("select-start"),l.removeAttribute("select-end"),a+=l.outerHTML;const c=l.getAttribute("data-node-id");s.push({action:"update",id:c,data:l.outerHTML,parentID:l.parentElement?.getAttribute("data-node-id")||t.protyle.block.parentID||t.protyle.block.rootID,previousID:s[s.length-1]?.id||l.previousElementSibling?.getAttribute("data-node-id")}),t.isContinue?r===e.length-1?(o.innerHTML=t.protyle.lute[t.type](a,t.level),l.outerHTML=o.innerHTML):l.remove():l.outerHTML=t.protyle.lute[t.type](l.outerHTML,t.level)}),s.forEach(l=>{const r=t.protyle.wysiwyg.element.querySelector(`[data-node-id="${l.id}"]`);r?i.push({action:"update",id:l.id,data:r.outerHTML}):(l.action="insert",i.push({action:"delete",id:l.id}))}),Array.from(o.children).forEach(l=>{const r=l.getAttribute("data-node-id");let c=!1;s.find(d=>{if(r===d.id)return c=!0,!0}),c||(i.push({action:"insert",id:r,previousID:l.previousElementSibling?.getAttribute("data-node-id")||s[0].previousID,data:l.outerHTML,parentID:l.parentElement?.getAttribute("data-node-id")||t.protyle.block.parentID||t.protyle.block.rootID}),s.splice(0,0,{action:"delete",id:r}))}),F(t.protyle,i,s),bt(t.protyle.wysiwyg.element),qe(t.protyle.wysiwyg.element),mt(t.protyle.wysiwyg.element,t.protyle),Be(t.protyle,t.protyle.wysiwyg.element),n?fe(t.protyle.wysiwyg.element,n):le(t.protyle.wysiwyg.element.querySelector(`[data-node-id="${e[0].getAttribute("data-node-id")}"]`)),X(["gutter"],t.protyle)},ms=(t,e,n=0)=>{n>6||t.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${e}"]`).forEach(a=>{a.getAttribute("data-subtype")==="d"&&w("/api/block/getRefText",{id:e},i=>{a.innerHTML=i.data;const s=x(a);s&&ms(t,s.getAttribute("data-node-id"),n+1)})})};let Cg;const F=(t,e,n)=>{if(!t){w("/api/transactions",{session:p.Constants.SIYUAN_APPID,app:p.Constants.SIYUAN_APPID,transactions:[{doOperations:e}]});return}const a=window.siyuan.transactions[window.siyuan.transactions.length-1];let i=!1;const s=new Date().getTime();a&&a.doOperations.length===1&&a.doOperations[0].action==="update"&&e.length===1&&e[0].action==="update"&&a.doOperations[0].id===e[0].id&&t.transactionTime-s<p.Constants.TIMEOUT_INPUT&&(i=!0),t.wysiwyg.lastHTMLs={},n&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&t.model&&t.model.headElement.classList.remove("item--unupdate"),t.updated=!0,i?t.undo.replace(e):t.undo.add(e,n)),i?(window.siyuan.transactions[window.siyuan.transactions.length-1].protyle=t,window.siyuan.transactions[window.siyuan.transactions.length-1].doOperations=e):window.siyuan.transactions.push({protyle:t,doOperations:e,undoOperations:n}),t.transactionTime=s,window.clearTimeout(Cg),Cg=window.setTimeout(()=>{Eg()},p.Constants.TIMEOUT_INPUT*2)},J=(t,e,n,a)=>{n!==a&&F(t,[{id:e,data:n,action:"update"}],[{id:e,data:a,action:"update"}])},bs=(t,e,n)=>{const a=[],i=[];t.forEach(s=>{const o=s.getAttribute("data-node-id");s.classList.remove("protyle-wysiwyg--select"),s.removeAttribute("select-start"),s.removeAttribute("select-end"),i.push({action:"update",id:o,data:s.outerHTML}),n(s),a.push({action:"update",id:o,data:s.outerHTML})}),F(e,a,i)},xg=t=>{const e=Lute.NewNodeID(),n=t.newValue.match(/^(.*) \((\d+)\)$/);n?t.newValue=`${n[1]} (${parseInt(n[2])+1})`:t.newValue=`${t.newValue} (1)`,["select","mSelect","rollup"].includes(t.type)?w("/api/av/renderAttributeView",{id:t.avID},a=>{const i=a.data;let s;i.view.columns.find(o=>{if(o.id===t.colId)return s=o.options,!0}),F(t.protyle,[{action:"addAttrViewCol",name:t.newValue,avID:t.avID,type:t.type,data:t.icon,previousID:t.colId,id:e},{action:"updateAttrViewColOptions",id:e,avID:t.avID,data:s}],[{action:"removeAttrViewCol",id:e,avID:t.avID}])}):F(t.protyle,[{action:"addAttrViewCol",name:t.newValue,avID:t.avID,type:t.type,data:t.icon,id:e,previousID:t.colId}],[{action:"removeAttrViewCol",id:e,avID:t.avID}]),Jt({blockElement:t.protyle.wysiwyg.element.querySelector(`[data-av-id="${t.avID}"]`),protyle:t.protyle,type:t.type,name:t.newValue,icon:t.icon,previousID:t.colId,id:e})},Sa=t=>{let e;t.data.view.columns.find(a=>{if(a.id===t.colId)return e=a,!0});let n=`<button class="b3-menu__item" data-type="nobg" data-col-id="${t.colId}">
    <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="go-properties">
        <svg><use xlink:href="#iconLeft"></use></svg>
    </span>
    <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
</button>
<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="nobg">
    <span style="padding: 5px;margin-right: 8px;width: 14px;font-size: 14px;" class="block__icon block__icon--show" data-col-type="${e.type}" data-icon="${e.icon}" data-type="update-icon">${e.icon?ie(e.icon):`<svg><use xlink:href="#${Yt(e.type)}"></use></svg>`}</span>
    <span class="b3-menu__label" style="padding: 4px;display: flex;"><input data-type="name" class="b3-text-field fn__block" type="text" value="${e.name}"></span>
</button>
<button class="b3-menu__item" data-type="goUpdateColType">
    <span class="b3-menu__label">${window.siyuan.languages.type}</span>
    <span class="fn__space"></span>
    <svg class="b3-menu__icon"><use xlink:href="#${Yt(e.type)}"></use></svg>
    <span class="b3-menu__accelerator" style="margin-left: 0">${Ag(e.type)}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>`;if(e.options&&e.options.length>0)n+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item">
    <svg class="b3-menu__icon" style=""><use xlink:href="#iconAdd"></use></svg>
    <span class="b3-menu__label" style="padding: 4px;display: flex"><input data-type="addOption" class="b3-text-field fn__block fn__size200" type="text" placeholder="Enter ${window.siyuan.languages.addAttr}"></span>
</button>`,e.options.forEach(a=>{n+=`<button class="b3-menu__item${n?"":" b3-menu__item--current"}" draggable="true" data-name="${a.name}" data-color="${a.color}">
    <svg class="b3-menu__icon"><use xlink:href="#iconDrag"></use></svg>
    <div class="fn__flex-1">
        <span class="b3-chip" style="background-color:var(--b3-font-background${a.color});color:var(--b3-font-color${a.color})">
            <span class="fn__ellipsis">${a.name}</span>
        </span>
    </div>
    <svg class="b3-menu__action" data-type="setColOption"><use xlink:href="#iconEdit"></use></svg>
</button>`});else if(e.type==="number")n+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item" data-type="numberFormat" data-format="${e.numberFormat}">
    <svg class="b3-menu__icon"><use xlink:href="#iconFormat"></use></svg>
    <span class="b3-menu__label">${window.siyuan.languages.format}</span>
    <span class="b3-menu__accelerator">${fp(e.numberFormat)}</span>
</button>`;else if(e.type==="template")n+=`<button class="b3-menu__separator"></button>
<button class="b3-menu__item">
    <textarea rows="${e.template.split(`
`).length}" placeholder="${window.siyuan.languages.template}" data-type="updateTemplate" style="margin: 4px 0" rows="1" class="fn__block b3-text-field">${e.template}</textarea>
</button>`;else if(e.type==="relation"){const a=e.relation?.avID===t.data.id;n+=`<button class="b3-menu__item" data-type="goSearchAV" data-av-id="${e.relation?.avID||""}" data-old-value='${JSON.stringify(e.relation||{})}'>
    <span class="b3-menu__label">${window.siyuan.languages.relatedTo}</span>
    <span class="b3-menu__accelerator">${a?window.siyuan.languages.thisDatabase:""}</span>
    <svg class="b3-menu__icon b3-menu__icon--small"><use xlink:href="#iconRight"></use></svg>
</button>
<label class="b3-menu__item fn__none">
    <span class="fn__flex-center">${window.siyuan.languages.backRelation}</span>
    <svg class="b3-menu__icon b3-menu__icon--small fn__none"><use xlink:href="#iconHelp"></use></svg>
    <span class="fn__space fn__flex-1"></span>
    <input data-type="backRelation" type="checkbox" class="b3-switch b3-switch--menu" ${e.relation?.isTwoWay?"checked":""}>
</label>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <input data-old-value="" data-type="colName" style="margin: 8px 0 4px" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.title}">
</div>
<div class="b3-menu__item fn__flex-column fn__none" data-type="nobg">
    <button style="margin: 4px 0 8px;" class="b3-button fn__block" data-type="updateRelation">${window.siyuan.languages.confirm}</button>
</div>`}else e.type==="rollup"&&(n+=Ap({colData:e}));return`<div class="b3-menu__items">
    ${n}
    <button class="b3-menu__separator"></button>
    <button class="b3-menu__item" data-type="${e.hidden?"showCol":"hideCol"}">
        <svg class="b3-menu__icon" style=""><use xlink:href="#icon${e.hidden?"Eye":"Eyeoff"}"></use></svg>
        <span class="b3-menu__label">${e.hidden?window.siyuan.languages.showCol:window.siyuan.languages.hideCol}</span>
    </button>
    <button class="b3-menu__item${e.type==="relation"?" fn__none":""}" data-type="duplicateCol">
        <svg class="b3-menu__icon" style=""><use xlink:href="#iconCopy"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.duplicate}</span>
    </button>
    <button class="b3-menu__item" data-type="removeCol">
        <svg class="b3-menu__icon" style=""><use xlink:href="#iconTrashcan"></use></svg>
        <span class="b3-menu__label">${window.siyuan.languages.delete}</span>
    </button>
</div>
<div class="b3-menu__items fn__none">
    <button class="b3-menu__item" data-type="nobg" data-col-id="${e.id}">
        <span class="block__icon" style="padding: 8px;margin-left: -4px;" data-type="goEditCol">
            <svg><use xlink:href="#iconLeft"></use></svg>
        </span>
        <span class="b3-menu__label ft__center">${window.siyuan.languages.edit}</span>
    </button>
    <button class="b3-menu__separator"></button>
    ${tn("text",e.type,e.name)}
    ${tn("number",e.type,e.name)}
    ${tn("select",e.type,e.name)}
    ${tn("mSelect",e.type,e.name)}
    ${tn("date",e.type,e.name)}
    ${tn("mAsset",e.type,e.name)}
    ${tn("checkbox",e.type,e.name)}
    ${tn("url",e.type,e.name)}
    ${tn("email",e.type,e.name)}
    ${tn("phone",e.type,e.name)}
    ${tn("template",e.type,e.name)}
    ${tn("relation",e.type,e.name)}
    ${tn("rollup",e.type,e.name)}
    ${tn("created",e.type,e.name)}
    ${tn("updated",e.type,e.name)}
</div>`},La=t=>{const e=t.data.id,n=t.menuElement.querySelector(".b3-menu__item").getAttribute("data-col-id"),a=t.data.view.columns.find(r=>r.id===n),i=t.menuElement.querySelector('[data-type="name"]');i.addEventListener("blur",()=>{const r=i.value;r!==a.name&&(F(t.protyle,[{action:"updateAttrViewCol",id:n,avID:e,name:r,type:a.type}],[{action:"updateAttrViewCol",id:n,avID:e,name:a.name,type:a.type}]),a.name=r,cn(t.protyle.wysiwyg.element.querySelector(`.av__row--header .av__cell[data-col-id="${n}"]`),void 0,{name:r}))}),i.addEventListener("keydown",r=>{r.isComposing||(r.key==="Escape"?t.menuElement.parentElement.remove():r.key==="Enter"&&(i.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))}),i.select();const s=t.menuElement.querySelector('[data-type="updateTemplate"]');s&&(s.addEventListener("blur",()=>{const r=s.value;r!==a.template&&(F(t.protyle,[{action:"updateAttrViewColTemplate",id:n,avID:e,data:r,type:a.type}],[{action:"updateAttrViewColTemplate",id:n,avID:e,data:a.template,type:a.type}]),a.template=r)}),s.addEventListener("keydown",r=>{r.isComposing||(r.key==="Escape"?t.menuElement.parentElement.remove():r.key==="Enter"&&!r.shiftKey&&(s.dispatchEvent(new CustomEvent("blur")),t.menuElement.parentElement.remove()))}));const o=t.menuElement.querySelector('[data-type="addOption"]');o&&o.addEventListener("keydown",r=>{if(!r.isComposing&&(r.key==="Escape"&&t.menuElement.parentElement.remove(),r.key==="Enter")){let c=!1;if(a.options.find(d=>{if(o.value===d.name)return c=!0,!0}),c||!o.value)return;a.options.push({color:(a.options.length+1).toString(),name:o.value}),F(t.protyle,[{action:"updateAttrViewColOptions",id:n,avID:e,data:a.options}],[{action:"removeAttrViewColOption",id:n,avID:e,data:o.value}]),t.menuElement.innerHTML=Sa({protyle:t.protyle,colId:n,data:t.data}),La({protyle:t.protyle,menuElement:t.menuElement,data:t.data}),t.menuElement.querySelector('[data-type="addOption"]').focus()}});const l=t.menuElement.querySelector('[data-type="backRelation"]');if(l){l.addEventListener("change",()=>{uo(t.menuElement,e)});const r=t.menuElement.querySelector('[data-type="goSearchAV"]'),c=JSON.parse(r.getAttribute("data-old-value")),d=t.menuElement.querySelector('[data-type="colName"]');d.addEventListener("input",()=>{uo(t.menuElement,e)}),c.avID?w("/api/av/getAttributeView",{id:c.avID},u=>{r.querySelector(".b3-menu__accelerator").textContent=c.avID===e?window.siyuan.languages.thisDatabase:u.data.av.name||window.siyuan.languages.title,u.data.av.keyValues.find(f=>{if(f.key.id===c.backKeyID)return d.setAttribute("data-old-value",f.key.name||window.siyuan.languages.title),d.value=f.key.name||window.siyuan.languages.title,!0}),uo(t.menuElement,e)}):uo(t.menuElement,e)}Tp(t)},Ag=t=>{switch(t){case"text":case"number":case"select":case"date":case"phone":case"email":case"template":return window.siyuan.languages[t];case"mSelect":return window.siyuan.languages.multiSelect;case"relation":return window.siyuan.languages.relation;case"rollup":return window.siyuan.languages.rollup;case"updated":return window.siyuan.languages.updatedTime;case"created":return window.siyuan.languages.createdTime;case"url":return window.siyuan.languages.link;case"mAsset":return window.siyuan.languages.assets;case"checkbox":return window.siyuan.languages.checkbox}},Yt=t=>{switch(t){case"text":return"iconAlignLeft";case"block":return"iconKey";case"number":return"iconNumber";case"select":return"iconListItem";case"mSelect":return"iconList";case"relation":return"iconOpen";case"rollup":return"iconSearch";case"date":return"iconCalendar";case"updated":case"created":return"iconClock";case"url":return"iconLink";case"mAsset":return"iconImage";case"email":return"iconEmail";case"phone":return"iconPhone";case"template":return"iconMath";case"checkbox":return"iconCheck"}},Jt=t=>{t.blockElement&&(t.blockElement.querySelectorAll(".av__row").forEach((e,n)=>{let a;t.previousID?a=e.querySelector(`[data-col-id="${t.previousID}"]`):a=e.lastElementChild.previousElementSibling;let i="";n===0?i=`<div class="av__cell" data-icon="${t.icon||""}" data-col-id="${t.id}" data-dtype="${t.type}" data-wrap="false" style="width: 200px;">
    <div draggable="true" class="av__cellheader">
        ${t.icon?ie(t.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Yt(t.type)}"></use></svg>`}
        <span class="av__celltext">${t.name}</span>
    </div>
    <div class="av__widthdrag"></div>
</div>`:i='<div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>',a.insertAdjacentHTML("afterend",i)}),window.siyuan.menus.menu.remove())},Tg=(t,e,n)=>{const a=n.getAttribute("data-dtype"),i=n.getAttribute("data-col-id"),s=e.getAttribute("data-av-id"),o=n.querySelector(".av__celltext").textContent.trim(),l=new At("av-header-cell",()=>{const u=l.element.querySelector(".b3-text-field").value;u!==o&&(F(t,[{action:"updateAttrViewCol",id:i,avID:s,name:u,type:a}],[{action:"updateAttrViewCol",id:i,avID:s,name:o,type:a}]),cn(e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{name:u}),le(e))});l.addItem({iconHTML:`<span style="align-self: center;margin-right: 8px;width: 14px;" class="block__icon block__icon--show">${n.dataset.icon?ie(n.dataset.icon):`<svg><use xlink:href="#${Yt(a)}"></use></svg>`}</span>`,type:"readonly",label:`<input style="margin: 4px 0" class="b3-text-field fn__block fn__size200" type="text" value="${o}">`,bind(u){const f=u.querySelector(".block__icon");f.setAttribute("data-icon",n.dataset.icon),f.addEventListener("click",g=>{const h=f.getBoundingClientRect();fi("","av",{x:h.left,y:h.bottom,h:h.height,w:h.width},m=>{F(t,[{action:"setAttrViewColIcon",id:i,avID:s,data:m}],[{action:"setAttrViewColIcon",id:i,avID:s,data:n.dataset.icon}]),f.setAttribute("data-icon",m),f.innerHTML=m?ie(m):`<svg><use xlink:href="#${Yt(a)}"></use></svg>`,cn(e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{icon:m})}),g.preventDefault(),g.stopPropagation()}),u.querySelector("input").addEventListener("keydown",g=>{g.isComposing||g.key==="Enter"&&(l.close(),g.preventDefault())})}}),a!=="block"&&l.addItem({icon:"iconEdit",label:window.siyuan.languages.edit,click(){const u=l.element.querySelector(".b3-text-field").value;Zt({protyle:t,blockElement:e,type:"edit",colId:i,cb(f){const g=f.querySelector('.b3-text-field[data-type="name"]');g.value=u,g.select()}})}}),l.addSeparator(),l.addItem({icon:"iconUp",label:window.siyuan.languages.asc,click(){w("/api/av/renderAttributeView",{id:s},u=>{F(t,[{action:"setAttrViewSorts",avID:u.data.id,data:[{column:i,order:"ASC"}]}],[{action:"setAttrViewSorts",avID:u.data.id,data:u.data.view.sorts}])})}}),l.addItem({icon:"iconDown",label:window.siyuan.languages.desc,click(){w("/api/av/renderAttributeView",{id:s},u=>{F(t,[{action:"setAttrViewSorts",avID:u.data.id,data:[{column:i,order:"DESC"}]}],[{action:"setAttrViewSorts",avID:u.data.id,data:u.data.view.sorts}])})}}),a!=="mAsset"&&l.addItem({icon:"iconFilter",label:window.siyuan.languages.filter,click(){w("/api/av/renderAttributeView",{id:s},u=>{const f=u.data;let g;f.view.filters.find(h=>{if(h.column===i)return g=h,!0}),g||(g={column:i,operator:Yl(a),value:za(a,""),type:a},f.view.filters.push(g)),fd({filter:g,protyle:t,data:f,blockElement:e,target:e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`)})})}}),l.addSeparator(),l.addItem({icon:"iconInsertLeft",label:window.siyuan.languages.insertColumnLeft,click(){const u=or(t,e,n.previousElementSibling?.getAttribute("data-col-id")||""),f=n.getBoundingClientRect();u.open({x:f.left,y:f.bottom,h:f.height})}}),l.addItem({icon:"iconInsertRight",label:window.siyuan.languages.insertColumnRight,click(){const u=or(t,e,n.getAttribute("data-col-id")||""),f=n.getBoundingClientRect();u.open({x:f.left,y:f.bottom,h:f.height})}}),a!=="block"&&l.addItem({icon:"iconEyeoff",label:window.siyuan.languages.hide,click(){F(t,[{action:"setAttrViewColHidden",id:i,avID:s,data:!0}],[{action:"setAttrViewColHidden",id:i,avID:s,data:!1}])}});const r=n.dataset.pin==="true";l.addItem({icon:r?"iconUnpin":"iconPin",label:r?window.siyuan.languages.unfreezeCol:window.siyuan.languages.freezeCol,click(){F(t,[{action:"setAttrViewColPin",id:i,avID:s,data:!r}],[{action:"setAttrViewColPin",id:i,avID:s,data:r}]),cn(e.querySelector(`.av__row--header .av__cell[data-col-id="${i}"]`),void 0,{pin:!r})}}),a!=="block"&&(a!=="relation"&&l.addItem({icon:"iconCopy",label:window.siyuan.languages.duplicate,click(){xg({protyle:t,type:a,avID:s,colId:i,icon:l.element.querySelector(".block__icon").getAttribute("data-icon"),newValue:window.siyuan.menus.menu.element.querySelector(".b3-text-field").value})}}),l.addItem({icon:"iconTrashcan",label:window.siyuan.languages.delete,click(){F(t,[{action:"removeAttrViewCol",id:i,avID:s}],[{action:"addAttrViewCol",name:o,avID:s,type:a,id:i,previousID:n.previousElementSibling?.getAttribute("data-col-id")||""}]),Mp(e,i)}}),l.addSeparator()),l.addItem({label:`<label class="fn__flex" style="margin: 4px 0;padding-right: 6px"><span>${window.siyuan.languages.wrap}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${n.dataset.wrap==="true"?" checked":""}></label>`,bind(u){const f=u.querySelector("input");f.addEventListener("change",()=>{F(t,[{action:"setAttrViewColWrap",id:i,avID:s,data:f.checked}],[{action:"setAttrViewColWrap",id:i,avID:s,data:!f.checked}])})}});const c=n.getBoundingClientRect();l.open({x:c.left,y:c.bottom,h:c.height});const d=window.siyuan.menus.menu.element.querySelector(".b3-text-field");d&&(d.select(),d.focus())},tn=(t,e,n)=>`<button class="b3-menu__item" data-type="updateColType"  data-name="${n}" data-old-type="${e}" data-new-type="${t}">
    <svg class="b3-menu__icon"><use xlink:href="#${Yt(t)}"></use></svg>
    <span class="b3-menu__label">${Ag(t)}</span>
    ${t===e?'<span class="b3-menu__accelerator"><svg class="svg" style="height: 30px; float: left;"><use xlink:href="#iconSelect"></use></svg></span>':""}
</button>`,or=(t,e,n)=>{const a=new At("av-header-add"),i=e.getAttribute("data-av-id");return typeof n>"u"&&(n=Array.from(e.querySelectorAll(".av__row--header .av__cell")).pop().getAttribute("data-col-id")),a.addItem({icon:"iconAlignLeft",label:window.siyuan.languages.text,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.text,avID:i,type:"text",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"text",name:window.siyuan.languages.text,id:s,previousID:n})}}),a.addItem({icon:"iconNumber",label:window.siyuan.languages.number,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.number,avID:i,type:"number",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"number",name:window.siyuan.languages.number,id:s,previousID:n})}}),a.addItem({icon:"iconListItem",label:window.siyuan.languages.select,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.select,avID:i,type:"select",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"select",name:window.siyuan.languages.select,id:s,previousID:n})}}),a.addItem({icon:"iconList",label:window.siyuan.languages.multiSelect,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.multiSelect,avID:i,type:"mSelect",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"mSelect",name:window.siyuan.languages.multiSelect,id:s,previousID:n})}}),a.addItem({icon:"iconCalendar",label:window.siyuan.languages.date,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.date,avID:i,type:"date",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"date",name:window.siyuan.languages.date,id:s,previousID:n})}}),a.addItem({icon:"iconImage",label:window.siyuan.languages.assets,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.assets,avID:i,type:"mAsset",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"mAsset",name:window.siyuan.languages.assets,id:s,previousID:n})}}),a.addItem({icon:"iconCheck",label:window.siyuan.languages.checkbox,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.checkbox,avID:i,type:"checkbox",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"checkbox",name:window.siyuan.languages.checkbox,id:s,previousID:n})}}),a.addItem({icon:"iconLink",label:window.siyuan.languages.link,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.link,avID:i,type:"url",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"url",name:window.siyuan.languages.link,id:s,previousID:n})}}),a.addItem({icon:"iconEmail",label:window.siyuan.languages.email,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.email,avID:i,type:"email",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"email",name:window.siyuan.languages.email,id:s,previousID:n})}}),a.addItem({icon:"iconPhone",label:window.siyuan.languages.phone,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.phone,avID:i,type:"phone",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"phone",name:window.siyuan.languages.phone,id:s,previousID:n})}}),a.addItem({icon:"iconMath",label:window.siyuan.languages.template,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.template,avID:i,type:"template",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"template",name:window.siyuan.languages.template,id:s,previousID:n})}}),a.addItem({icon:"iconOpen",label:window.siyuan.languages.relation,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.relation,avID:i,type:"relation",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"relation",name:window.siyuan.languages.relation,id:s,previousID:n})}}),a.addItem({icon:"iconSearch",label:window.siyuan.languages.rollup,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.rollup,avID:i,type:"rollup",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"rollup",name:window.siyuan.languages.rollup,id:s,previousID:n})}}),a.addItem({icon:"iconClock",label:window.siyuan.languages.createdTime,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.createdTime,avID:i,type:"created",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"created",name:window.siyuan.languages.createdTime,id:s,previousID:n})}}),a.addItem({icon:"iconClock",label:window.siyuan.languages.updatedTime,click(){const s=Lute.NewNodeID();F(t,[{action:"addAttrViewCol",name:window.siyuan.languages.updatedTime,avID:i,type:"updated",id:s,previousID:n}],[{action:"removeAttrViewCol",id:s,avID:i}]),Jt({blockElement:e,protyle:t,type:"updated",name:window.siyuan.languages.updatedTime,id:s,previousID:n})}}),a},mt=(t,e,n,a)=>{let i=[];t.getAttribute("data-type")==="NodeAttributeView"?i=[t]:i=Array.from(t.querySelectorAll('[data-type="NodeAttributeView"]')),i.length!==0&&i.length>0&&i.forEach(s=>{if(s.getAttribute("data-render")==="true")return;if(s.firstElementChild.innerHTML===""){s.style.alignSelf="";let h="";[1,2,3].forEach(()=>{h+=`<div class="av__row">
    <div style="width: 24px;flex-shrink: 0"></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
    <div class="av__cell" style="width: 200px"><span class="av__pulse"></span></div>
</div>`}),s.firstElementChild.innerHTML=h}const o=s.querySelector(".av__scroll")?.scrollLeft||0,l=s.querySelector(".av__row--header")?.style.transform,r=s.querySelector(".av__row--footer")?.style.transform;let c="";const d=s.querySelector(".av__cell--select");d&&(c=A(d,"av__row").dataset.id+p.Constants.ZWSP+d.getAttribute("data-col-id"));const u=e.options.history?.created,f=e.options.history?.snapshot;let g="";typeof a=="string"?g=a:typeof a>"u"&&(g=s.querySelector(".av__header .item--focus")?.getAttribute("data-id")),w(u?"/api/av/renderHistoryAttributeView":f?"/api/av/renderSnapshotAttributeView":"/api/av/renderAttributeView",{id:s.getAttribute("data-av-id"),created:u,snapshot:f,pageSize:parseInt(s.dataset.pageSize)||void 0,viewID:g},h=>{const m=h.data.view;s.dataset.pageSize||(s.dataset.pageSize=m.pageSize.toString());let b='<div class="av__row av__row--header"><div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>',y='<div style="width: 24px"></div>',_=-1,v=-1,k=0;const L=s.clientWidth;m.columns.forEach((T,H)=>{T.hidden||(T.pin&&(_=H),k<L-200&&(k+=parseInt(T.width)||200,v=H))}),_=Math.min(_,v),_>-1&&(b='<div class="av__row av__row--header"><div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>',y='<div class="av__colsticky"><div style="width: 24px"></div>'),m.columns.forEach((T,H)=>{T.hidden||(b+=`<div class="av__cell" data-col-id="${T.id}" 
data-icon="${T.icon}" data-dtype="${T.type}" data-wrap="${T.wrap}" data-pin="${T.pin}" 
style="width: ${T.width||"200px"};">
    <div draggable="true" class="av__cellheader">
        ${T.icon?ie(T.icon,"av__cellheadericon",!0):`<svg class="av__cellheadericon"><use xlink:href="#${Yt(T.type)}"></use></svg>`}
        <span class="av__celltext">${T.name}</span>
        ${T.pin?'<div class="fn__flex-1"></div><svg class="av__cellheadericon"><use xlink:href="#iconPin"></use></svg>':""}
    </div>
    <div class="av__widthdrag"></div>
</div>`,_===H&&(b+="</div>"),y+=`<div class="av__calc${y?"":" av__calc--show"}${T.calc&&T.calc.operator!==""?" av__calc--ashow":""}" data-col-id="${T.id}" data-dtype="${T.type}" data-operator="${T.calc?.operator||""}"  
style="width: ${T.width||"200px"}">${my(T)||'<svg><use xlink:href="#iconDown"></use></svg>'+window.siyuan.languages.calc}</div>`,_===H&&(y+="</div>"))}),b+=`<div class="block__icons" style="min-height: auto">
    <div class="block__icon block__icon--show" data-type="av-header-add"><svg><use xlink:href="#iconAdd"></use></svg></div>
    <div class="fn__space"></div>
    <div class="block__icon block__icon--show"  data-type="av-header-more"><svg><use xlink:href="#iconMore"></use></svg></div>
</div>
</div>`,m.rows.forEach(T=>{b+=`<div class="av__row" data-id="${T.id}">`,_>-1?b+='<div class="av__colsticky"><div class="av__firstcol"><svg><use xlink:href="#iconUncheck"></use></svg></div>':b+='<div class="av__firstcol av__colsticky"><svg><use xlink:href="#iconUncheck"></use></svg></div>',T.cells.forEach((H,D)=>{m.columns[D].hidden||(b+=`<div class="av__cell" data-id="${H.id}" data-col-id="${m.columns[D].id}"
${H.valueType==="block"?'data-block-id="'+(H.value.block.id||"")+'"':""} data-wrap="${m.columns[D].wrap}" 
${H.value?.isDetached?' data-detached="true"':""} 
style="width: ${m.columns[D].width||"200px"};
${H.bgColor?`background-color:${H.bgColor};`:""}
${H.color?`color:${H.color};`:""}">${_d(H.value,m.columns[D].wrap)}</div>`,_===D&&(b+="</div>"))}),b+="<div></div></div>"});let C="";h.data.views.forEach(T=>{C+=`<div data-id="${T.id}" class="item${T.id===h.data.viewID?" item--focus":""}">
    ${T.icon?ie(T.icon,"item__graphic",!0):'<svg class="item__graphic"><use xlink:href="#iconTable"></use></svg>'}
    <span class="item__text">${T.name}</span>
</div>`}),s.firstElementChild.outerHTML=`<div class="av__container" style="--av-background:${s.style.backgroundColor||"var(--b3-theme-background)"}">
    <div class="av__header">
        <div class="fn__flex av__views">
            <div class="layout-tab-bar fn__flex">
                ${C}
            </div>
            <div class="fn__space"></div>
            <span data-type="av-add" class="block__icon">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__flex-1"></div>
            <div class="fn__space"></div>
            <span data-type="av-switcher" class="block__icon${h.data.views.length>0?"":" fn__none"}">
                <svg><use xlink:href="#iconDown"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-filter" class="block__icon${m.filters.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconFilter"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-sort" class="block__icon${m.sorts.length>0?" block__icon--active":""}">
                <svg><use xlink:href="#iconSort"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-more" class="block__icon">
                <svg><use xlink:href="#iconMore"></use></svg>
            </span>
            <div class="fn__space"></div>
            <span data-type="av-add-more" class="block__icon">
                <svg><use xlink:href="#iconAdd"></use></svg>
            </span>
            <div class="fn__space"></div>
            ${h.data.isMirror?` <span class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.mirrorTip}">
    <svg><use xlink:href="#iconSplitLR"></use></svg></span><div class="fn__space"></div>`:""}
        </div>
        <div contenteditable="${e.disabled?"false":"true"}" spellcheck="${window.siyuan.config.editor.spellcheck.toString()}" class="av__title" data-title="${h.data.name||""}" data-tip="${window.siyuan.languages.title}">${h.data.name||""}</div>
        <div class="av__counter fn__none"></div>
    </div>
    <div class="av__scroll">
        <div class="av__body">
            ${b}
            <div class="av__row--util">
                <div class="av__colsticky">
                    <button class="b3-button" data-type="av-add-bottom">
                        <svg><use xlink:href="#iconAdd"></use></svg>
                        ${window.siyuan.languages.addAttr}
                    </button>
                    <span class="fn__space"></span>
                    <button class="b3-button${m.rowCount>m.rows.length?"":" fn__none"}">
                        <svg data-type="av-load-more"><use xlink:href="#iconArrowDown"></use></svg>
                        <span data-type="av-load-more">
                            ${window.siyuan.languages.loadMore}
                        </span>
                        <svg data-type="set-page-size" data-size="${m.pageSize}"><use xlink:href="#iconMore"></use></svg>
                    </button>
                </div>
            </div>
            <div class="av__row--footer">${y}</div>
        </div>
    </div>
</div>`,s.setAttribute("data-render","true"),s.style.margin="",o&&(s.querySelector(".av__scroll").scrollLeft=o);const E=e.contentElement.getBoundingClientRect();if(l?s.querySelector(".av__row--header").style.transform=l:Ua(s,E,"top"),r?s.querySelector(".av__row--footer").style.transform=r:Ua(s,E,"bottom"),c){const T=s.querySelector(`.av__row[data-id="${c.split(p.Constants.ZWSP)[0]}"] .av__cell[data-col-id="${c.split(p.Constants.ZWSP)[1]}"]`);T&&T.classList.add("av__cell--select");const H=document.querySelector(".av__mask");H?H.querySelector(" textarea").focus():document.querySelector(".av__panel")||le(s)}if(getSelection().rangeCount>0){const T=getSelection().getRangeAt(0);if(!A(T.startContainer,"av__title")){const H=x(T.startContainer);H&&s.isSameNode(H)&&le(s)}}s.querySelector(".layout-tab-bar").scrollLeft=s.querySelector(".layout-tab-bar .item--focus").offsetLeft,n&&n()})})},Ig={},r_=(t,e,n)=>{e.action==="setAttrViewName"&&Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${e.id}"]`)).forEach(a=>{const i=a.querySelector(".av__title");i&&(i.textContent=e.data,i.dataset.title=e.data)}),clearTimeout(Ig[t.id]),Ig[t.id]=window.setTimeout(()=>{e.action==="setAttrViewColWidth"?Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${e.avID}"]`)).forEach(a=>{const i=a.querySelector(`.av__cell[data-col-id="${e.id}"]`);!i||i.style.width===e.data||a.querySelectorAll(".av__row").forEach(s=>{s.querySelector(`[data-col-id="${e.id}"]`).style.width=e.data})}):Array.from(t.wysiwyg.element.querySelectorAll(`[data-av-id="${e.avID}"]`)).forEach(a=>{a.removeAttribute("data-render");const i=a.querySelector(".av__pulse");mt(a,t,()=>{e.action==="insertAttrViewBlock"?(a.querySelectorAll(".av__cell--select").forEach(s=>{s.classList.remove("av__cell--select")}),!n&&e.isDetached&&i&&qn(t,[a.querySelector(`.av__row[data-id="${e.srcIDs[0]}"] .av__cell[data-detached="true"]`)],"block")):e.action==="addAttrViewCol"&&i&&Zt({protyle:t,blockElement:a,type:"edit",colId:e.id})},["addAttrViewView","duplicateAttrViewView"].includes(e.action)?e.id:e.action==="removeAttrViewView"?null:void 0)})},["insertAttrViewBlock","addAttrViewCol"].includes(e.action)?2:100)},Dg=(t,e)=>{t.block.showAll=!0;let n="";e.forEach(a=>{n+=Mg(a.blockPaths)+Pg(a.dom,a.expand)}),t.wysiwyg.element.innerHTML=n,bt(t.wysiwyg.element),qe(t.wysiwyg.element),mt(t.wysiwyg.element,t),Be(t,t.wysiwyg.element),$r(t),(window.siyuan.config.readonly||window.siyuan.config.editor.readOnly)&&ia(t)},$g=(t,e)=>{e.firstElementChild.classList.contains("li")?t?e.querySelectorAll(".li .li").forEach(n=>{n.childElementCount>3&&n.setAttribute("fold","1")}):e.firstElementChild.setAttribute("fold","1"):e.firstElementChild.getAttribute("data-type")==="NodeHeading"&&Array.from(e.children).forEach((n,a)=>{(t&&a>2||!t&&a>1)&&((t&&a===3||!t&&a===2)&&n.insertAdjacentHTML("beforebegin",'<div style="max-width: 100%;justify-content: center;" contenteditable="false" class="protyle-breadcrumb__item"><svg><use xlink:href="#iconMore"></use></svg></div>'),n.classList.add("fn__none"))})},Pg=(t,e)=>{const n=document.createElement("template");return n.innerHTML=t,$g(e,n.content),n.innerHTML},c_=(t,e)=>{w("/api/filetree/getDoc",{id:e.getAttribute("data-id"),size:p.Constants.SIZE_GET_MAX},n=>{e.parentElement.querySelector(".protyle-breadcrumb__item--active").classList.remove("protyle-breadcrumb__item--active"),e.classList.add("protyle-breadcrumb__item--active");let a=e.parentElement.nextElementSibling;for(;a&&!a.classList.contains("protyle-breadcrumb__bar");){const i=a;a=a.nextElementSibling,i.remove()}e.parentElement.insertAdjacentHTML("afterend",Pg(n.data.content,!0)),bt(e.parentElement.parentElement),mt(e.parentElement.parentElement,t),Be(t,e.parentElement.parentElement),n.data.isSyncing?Hg(t):window.siyuan.config.readonly||window.siyuan.config.editor.readOnly?ia(t):e.parentElement.parentElement.classList.contains("protyle-wysiwyg__embed")&&e.parentElement.parentElement.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(i=>{i.setAttribute("contenteditable","false")})})},d_=t=>{let e=t.nextElementSibling;for(;e&&!e.classList.contains("protyle-breadcrumb__bar");)e.classList.remove("fn__none"),e=e.nextElementSibling;t.remove()},Mg=(t,e=!1)=>{let n="";return t.forEach((a,i)=>{i===0&&!e||(n+=`<span class="protyle-breadcrumb__item${i===t.length-1?" protyle-breadcrumb__item--active":""}" data-id="${a.id}">
    <svg class="popover__block" data-id="${a.id}"><use xlink:href="#${bn(a.type,a.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${a.name}">${a.name}</span>
</span>`,i!==t.length-1&&(n+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>'))}),`<div contenteditable="false" style="margin-bottom: 8px" class="protyle-breadcrumb__bar protyle-breadcrumb__bar--nowrap">${n}</div>`},Be=(t,e,n)=>{let a=[];e.getAttribute("data-type")==="NodeBlockQueryEmbed"?a=[e]:a=Array.from(e.querySelectorAll('[data-type="NodeBlockQueryEmbed"]')),a.length!==0&&a.forEach(i=>{if(i.getAttribute("data-render")==="true")return;i.setAttribute("data-render","true"),i.style.height=i.clientHeight-8+"px",i.innerHTML=`<div class="protyle-icons${q(i.parentElement,"data-type","NodeBlockQueryEmbed")?" fn__none":""}">
    <span aria-label="${window.siyuan.languages.refresh}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__reload protyle-icon--first"><svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg></span>
    <span aria-label="${window.siyuan.languages.update} SQL" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__edit"><svg><use xlink:href="#iconEdit"></use></svg></span>
    <span aria-label="${window.siyuan.languages.more}" class="b3-tooltips__nw b3-tooltips protyle-icon protyle-action__menu protyle-icon--last"><svg><use xlink:href="#iconMore"></use></svg></span>
</div>${i.lastElementChild.outerHTML}`;const s=Lute.UnEscapeHTMLStr(i.getAttribute("data-content"));let o=i.getAttribute("breadcrumb");if(o?o=o==="true":o=window.siyuan.config.editor.embedBlockBreadcrumb,ut(i,"sb")&&(o=!1),s.startsWith("//!js"))try{const r=new Function("fetchSyncPost","item","protyle","top",s)(lt,i,t,n);if(r instanceof Promise)r.then(c=>{if(Array.isArray(c))w("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:c,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:o},d=>{Eo(d.data.blocks||[],t,i,n)});else return}).catch(()=>{Eo([],t,i,n)});else if(Array.isArray(r))w("/api/search/getEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),includeIDs:r,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,breadcrumb:o},c=>{Eo(c.data.blocks||[],t,i,n)});else return}catch{Eo([],t,i,n)}else w("/api/search/searchEmbedBlock",{embedBlockID:i.getAttribute("data-node-id"),stmt:s,headingMode:i.getAttribute("custom-heading-mode")==="1"?1:0,excludeIDs:[i.getAttribute("data-node-id"),t.block.rootID],breadcrumb:o},r=>{Eo(r.data.blocks,t,i,n)})})},Eo=(t,e,n,a)=>{const i=n.querySelector(".fn__rotate");i&&i.classList.remove("fn__rotate");let s="";t.forEach(r=>{let c="";r.blockPaths.length!==0&&(c=Mg(r.blockPaths,!0)),s+=`<div class="protyle-wysiwyg__embed" data-id="${r.block.id}">${c}${r.block.content}</div>`}),t.length>0?n.lastElementChild.insertAdjacentHTML("beforebegin",s+`<div style="position: absolute;">${p.Constants.ZWSP}</div>`):n.lastElementChild.insertAdjacentHTML("beforebegin",`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>
<div style="position: absolute;">${p.Constants.ZWSP}</div>`),bt(n),qe(n),mt(n,e),a&&(e.contentElement.scrollTop=a);let o=0,l=n;for(;o<4&&l;)l=q(l.parentElement,"data-type","NodeBlockQueryEmbed"),o++;o<4&&n.querySelectorAll('[data-type="NodeBlockQueryEmbed"]').forEach(r=>{Be(e,r)}),n.style.height=""};let un=[],ws=!1;const lr=async(t,e)=>{X(["gutter","toolbar","hint","util","dialog"],e.protyle);let n;if(!document.contains(e.protyle.element)){if(!(await lt("/api/block/checkBlockExist",{id:e.protyle.block.rootID})).data)return!1;let i;const s=document.querySelector(".layout__wnd--active");if(s&&(i=Lt(s.getAttribute("data-id"))),i||(i=Ni(window.siyuan.layout.centerLayout)),i){const o=await lt("/api/block/getBlockInfo",{id:e.id});if(o.code===3){M(o.msg);return}const l=new gt({title:o.data.rootTitle,docIcon:o.data.rootIcon,callback(c){const d=cs(e.protyle,!0);d.rootId=e.protyle.block.rootID,d.focusId=e.id,d.focusStart=e.position.start,d.focusEnd=e.position.end,window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION][e.protyle.block.rootID]=d;const u=new dt({app:t,tab:c,blockId:e.zoomId||e.protyle.block.rootID,rootId:e.protyle.block.rootID,action:e.zoomId?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS]});c.addModel(u)}});if(window.siyuan.config.fileTree.openFilesUseCurrentTab){let c;i.children.forEach(d=>{d.headElement&&d.headElement.classList.contains("item--unupdate")&&!d.headElement.classList.contains("item--pin")&&(c=d)}),i.addTab(l),c&&i.removeTab(c.id)}else i.addTab(l);i.showHeading();const r=l.model.editor.protyle;return e.protyle=r,un.forEach(c=>{!document.contains(c.protyle.element)&&c.protyle.block.rootID===o.data.rootID&&(c.protyle=r)}),window.siyuan.backStack.forEach(c=>{!document.contains(c.protyle.element)&&c.protyle.block.rootID===o.data.rootID&&(c.protyle=r)}),o.data.rootID===e.id?Gn(r.title.editElement,e.position.start,e.position.end):(Array.from(r.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(c=>{if(!q(c,"data-type","NodeBlockQueryEmbed"))return n=c,!0}),Gn(ae(n),e.position.start,e.position.end),He(r,n)),!0}else return!1}if(e.protyle.block.rootID===e.id)return e.protyle.title.editElement.getBoundingClientRect().height===0&&(e.protyle.model.parent.parent.switchTab(e.protyle.model.parent.headElement),e.protyle.toolbar.range=void 0),Gn(e.protyle.title.editElement,e.position.start,e.position.end),!0;if(Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(a=>{if(!q(a,"data-type","NodeBlockQueryEmbed"))return n=a,!0}),n&&(!e.zoomId||e.zoomId&&e.zoomId===e.protyle.block.id))return n.getBoundingClientRect().height===0&&e.protyle.model.parent.parent.switchTab(e.protyle.model.parent.headElement),Gn(ae(n),e.position.start,e.position.end),He(e.protyle,n,!0),Pe().outline.forEach(a=>{a.blockId===e.protyle.block.rootID&&a.setCurrent(n)}),!0;if(e.protyle.element.parentElement)return(await lt("/api/block/checkBlockExist",{id:e.id})).data?(Vt({protyle:e.protyle,id:e.zoomId||e.protyle.block.rootID,isPushBack:!1,callback:()=>{Array.from(e.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(i=>{if(!q(i,"data-type","NodeBlockQueryEmbed"))return n=i,!0}),n&&(Pe().outline.forEach(i=>{i.blockId===e.protyle.block.rootID&&i.setCurrent(n)}),Gn(ae(n),e.position.start,e.position.end),He(e.protyle,n,!0))}}),!0):(getSelection().rangeCount>0&&Z(getSelection().getRangeAt(0)),!1)},Gd=async t=>{if(window.siyuan.backStack.length===0){un.length>0&&await lr(t,un[un.length-1]);return}document.querySelector("#barForward")?.classList.remove("toolbar__item--disabled"),!ws&&document.contains(window.siyuan.backStack[window.siyuan.backStack.length-1].protyle.element)&&un.push(window.siyuan.backStack.pop());let e=window.siyuan.backStack.pop();for(;e;)if(await lr(t,e)){un.push(e);break}else e=window.siyuan.backStack.pop();ws=!0,window.siyuan.backStack.length===0&&document.querySelector("#barBack")?.classList.add("toolbar__item--disabled")},jd=async t=>{if(un.length===0){window.siyuan.backStack.length>0&&await lr(t,window.siyuan.backStack[window.siyuan.backStack.length-1]);return}document.querySelector("#barBack")?.classList.remove("toolbar__item--disabled"),ws&&window.siyuan.backStack.push(un.pop());let e=un.pop();for(;e;)if(await lr(t,e)){window.siyuan.backStack.push(e);break}else e=un.pop();ws=!1,un.length===0&&document.querySelector("#barForward")?.classList.add("toolbar__item--disabled")},ys=(t,e,n)=>{if(!t.model||(!n&&e&&(n=x(e.startContainer)),!n))return;let a;if(n.classList.contains("protyle-title__input")?a=n:a=ae(n),a){const i=yt(a,void 0,e),s=n.getAttribute("data-node-id")||t.block.rootID,o=window.siyuan.backStack[window.siyuan.backStack.length-1];o&&o.id===s&&(t.block.showAll&&o.zoomId===t.block.id||!o.zoomId&&!t.block.showAll)?o.position=i:(un.length>0&&(ws&&window.siyuan.backStack.push(un.pop()),un=[],document.querySelector("#barForward")?.classList.add("toolbar__item--disabled")),window.siyuan.backStack.push({position:i,id:s,protyle:t,zoomId:t.block.showAll?t.block.id:void 0}),window.siyuan.backStack.length>p.Constants.SIZE_UNDO&&window.siyuan.backStack.shift(),ws=!1),window.siyuan.backStack.length>1&&document.querySelector("#barBack")?.classList.remove("toolbar__item--disabled")}},st=t=>{if(t.action||(t.action=[]),t.protyle.wysiwyg.element.removeAttribute("data-top"),t.data.code===1){t.protyle.model?t.protyle.model.parent.parent.removeTab(t.protyle.model.parent.id,!1):t.protyle.element.innerHTML=`<div class="ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`;return}if(t.data.code!==3&&(t.protyle.notebookId=t.data.data.box,t.protyle.path=t.data.data.path,!(t.data.data.eof&&!t.scrollAttr&&(t.action.includes(p.Constants.CB_GET_BEFORE)?t.protyle.wysiwyg.element.firstElementChild.setAttribute("data-eof","1"):t.protyle.wysiwyg.element.lastElementChild.setAttribute("data-eof","2"),t.data.data.mode!==4)))){if(X(["gutter"],t.protyle),t.protyle.block.parentID=t.data.data.parentID,t.protyle.block.parent2ID=t.data.data.parent2ID,t.protyle.block.rootID=t.data.data.rootID,t.protyle.block.showAll=!1,t.protyle.block.mode=t.data.data.mode,t.protyle.block.blockCount=t.data.data.blockCount,t.protyle.block.scroll=t.data.data.scroll,t.protyle.block.action=t.action,t.action.includes(p.Constants.CB_GET_UNCHANGEID)||(t.protyle.block.id=t.data.data.id,t.protyle.scroll.lastScrollTop=0,t.protyle.contentElement.scrollTop=0,t.protyle.wysiwyg.element.setAttribute("data-doc-type",t.data.data.type)),t.action.includes(p.Constants.CB_GET_APPEND)||t.action.includes(p.Constants.CB_GET_BEFORE)||t.action.includes(p.Constants.CB_GET_HTML)){Ng({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,isSyncing:t.data.data.isSyncing,afterCB:t.afterCB},t.protyle),$r(t.protyle);return}w("/api/block/getDocInfo",{id:t.protyle.block.rootID},e=>{t.protyle.options.render.title?t.protyle.title.render(t.protyle,e):(t.protyle.options.render.background&&t.protyle.background.render(e.data.ial,t.protyle.block.rootID),t.protyle.wysiwyg.renderCustom(e.data.ial)),Ng({content:t.data.data.content,expand:t.data.data.isBacklinkExpand,action:t.action,scrollAttr:t.scrollAttr,isSyncing:t.data.data.isSyncing,afterCB:t.afterCB},t.protyle),$r(t.protyle)})}},Ng=(t,e)=>{if(e.contentElement.classList.contains("fn__none")&&e.wysiwyg.element.innerHTML!=="")return;e.block.showAll=t.action.includes(p.Constants.CB_GET_ALL);const n=e.contentElement.clientHeight*8;if(t.action.includes(p.Constants.CB_GET_APPEND)){if(!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad&&e.contentElement.scrollHeight>n){let a=e.wysiwyg.element.firstElementChild;const i=[];for(;e.wysiwyg.element.childElementCount>2&&i&&!e.wysiwyg.element.lastElementChild.isSameNode(a)&&e.contentElement.scrollHeight-a.offsetTop>n;){i.push(a);a=a.nextElementSibling}const s=a.getBoundingClientRect().top;i.forEach(o=>{o.remove()}),e.contentElement.scrollTop=e.contentElement.scrollTop+(a.getBoundingClientRect().top-s),e.scroll.lastScrollTop=e.contentElement.scrollTop,X(["toolbar"],e)}e.wysiwyg.element.insertAdjacentHTML("beforeend",t.content)}else if(t.action.includes(p.Constants.CB_GET_BEFORE)){const a=e.wysiwyg.element.firstElementChild,i=a.getBoundingClientRect().top;if(e.wysiwyg.element.insertAdjacentHTML("afterbegin",t.content),e.contentElement.scrollTop=e.contentElement.scrollTop+(a.getBoundingClientRect().top-i),e.scroll.lastScrollTop=e.contentElement.scrollTop,!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&!e.scroll.keepLazyLoad){const s=[];let o=e.wysiwyg.element.childElementCount,l=e.contentElement.scrollHeight,r=e.wysiwyg.element.lastElementChild;for(;o>2&&l>n&&r.getBoundingClientRect().top>window.innerHeight;)s.push(r),r=r.previousElementSibling,o--,l-=r.clientHeight+8;s.forEach(c=>{c.remove()}),X(["toolbar"],e)}}else e.wysiwyg.element.innerHTML=t.content;if(t.action.includes(p.Constants.CB_GET_BACKLINK)&&$g(t.expand,e.wysiwyg.element),bt(e.wysiwyg.element),qe(e.wysiwyg.element),mt(e.wysiwyg.element,e),Be(e,e.wysiwyg.element),!t.action.includes(p.Constants.CB_GET_HISTORY)){if(e.options.render.scroll&&e.scroll.update(e),t.action.includes(p.Constants.CB_GET_FOCUSFIRST)){const a=e.wysiwyg.element.offsetTop-16;ln(e,a,256),e.contentElement.scrollTop=a}if(t.isSyncing?Hg(e):(e.breadcrumb&&(e.breadcrumb.element.nextElementSibling.textContent=""),e.element.removeAttribute("disabled-forever"),Og(e)),u_(e,t.action,t.scrollAttr),t.action.includes(p.Constants.CB_GET_SETID)&&(e.block.id=e.block.rootID,e.wysiwyg.element.setAttribute("data-doc-type","NodeDocument")),e.options.defId&&(e.wysiwyg.element.querySelectorAll(`[data-id="${e.options.defId}"]`).forEach(a=>{a.classList.add("def--mark")}),e.options.defId=void 0),t.action.includes(p.Constants.CB_GET_APPEND)||t.action.includes(p.Constants.CB_GET_BEFORE)){e.app.plugins.forEach(a=>{a.eventBus.emit("loaded-protyle-dynamic",{protyle:e,positon:t.action.includes(p.Constants.CB_GET_APPEND)?"afterend":"beforebegin"})});return}e.options.render.breadcrumb&&(e.breadcrumb.toggleExit(!t.action.includes(p.Constants.CB_GET_ALL)),e.breadcrumb.render(e)),t.afterCB&&t.afterCB(),t.scrollAttr&&!e.scroll.element.classList.contains("fn__none")&&!e.element.classList.contains("block__edit")&&e.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&e.contentElement.scrollHeight>0&&!t.action.includes(p.Constants.CB_GET_FOCUSFIRST)&&e.contentElement.scrollHeight<=e.contentElement.clientHeight&&w("/api/filetree/getDoc",{id:e.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{st({data:a,protyle:e,action:[p.Constants.CB_GET_APPEND,p.Constants.CB_GET_UNCHANGEID]})}),t.scrollAttr&&!e.scroll.element.classList.contains("fn__none")&&!e.element.classList.contains("fn__none")&&(e.scroll.updateIndex(e,t.scrollAttr.startId),e.contentElement.scrollHeight<=e.contentElement.clientHeight&&M(window.siyuan.languages.scrollGetMore)),e.app.plugins.forEach(a=>{a.eventBus.emit("loaded-protyle",e),a.eventBus.emit("loaded-protyle-static",{protyle:e})})}},Hg=t=>{ia(t),t.breadcrumb&&!(0,I.tq)()?t.breadcrumb.element.nextElementSibling.textContent=window.siyuan.languages._kernel[81]:M(window.siyuan.languages._kernel[81]),t.element.setAttribute("disabled-forever","true")},ia=t=>{if(window.siyuan.menus.menu.remove(),X(["gutter","toolbar","select","hint","util"],t),t.disabled=!0,t.title){const e=t.title.element.querySelector(".protyle-title__input");e.setAttribute("contenteditable","false"),e.style.userSelect="text"}t.background&&(t.background.element.classList.remove("protyle-background--enable"),t.background.element.classList.remove("protyle-background--mobileshow")),t.wysiwyg.element.querySelectorAll(".protyle-icons--show").forEach(e=>{e.classList.remove("protyle-icons--show")}),t.wysiwyg.element.style.userSelect="text",t.wysiwyg.element.setAttribute("contenteditable","false"),t.wysiwyg.element.querySelectorAll('[contenteditable="true"][spellcheck]').forEach(e=>{e.setAttribute("contenteditable","false")}),t.wysiwyg.element.querySelectorAll('.protyle-action[draggable="true"]').forEach(e=>{e.setAttribute("draggable","false")}),t.wysiwyg.element.querySelectorAll(".av").forEach(e=>{const n=e.querySelector(".av__row--header");n&&(n.style.transform="",e.querySelector(".av__row--footer").style.transform="")}),t.breadcrumb&&(t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconLock"),t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.tempUnlock:window.siyuan.languages.unlockEdit)),hn()},Kd=t=>{if(t.element.getAttribute("disabled-forever")==="true")return;if(t.disabled=!1,(0,I.tq)()?document.getElementById("toolbarName").removeAttribute("readonly"):(t.wysiwyg.element.setAttribute("contenteditable","true"),t.wysiwyg.element.style.userSelect=""),t.title){const n=t.title.element.querySelector(".protyle-title__input");n.setAttribute("contenteditable","true"),n.style.userSelect=""}t.background&&t.background.element.classList.add("protyle-background--enable"),t.wysiwyg.element.querySelectorAll('[contenteditable="false"][spellcheck]').forEach(n=>{A(n,"protyle-wysiwyg__embed")||n.setAttribute("contenteditable","true")}),t.wysiwyg.element.querySelectorAll('.protyle-action[draggable="false"]').forEach(n=>{n.setAttribute("draggable","true")});const e=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(n=>{n.querySelector(".av__title")&&Ua(n,e,"all")}),t.breadcrumb&&(t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"] use').setAttribute("xlink:href","#iconUnlock"),t.breadcrumb.element.parentElement.querySelector('[data-type="readonly"]').setAttribute("aria-label",window.siyuan.config.editor.readOnly?window.siyuan.languages.cancelTempUnlock:window.siyuan.languages.lockEdit)),hn()},u_=(t,e,n)=>{let a;if(n&&n.focusId?a=t.wysiwyg.element.querySelector(`[data-node-id="${n.focusId}"]`):Array.from(t.wysiwyg.element.querySelectorAll(`[data-node-id="${t.block.id}"]`)).find(s=>{if(!q(s,"data-type","block-render",!0))return a=s,!0}),t.block.mode===4?(ln(t),a=t.wysiwyg.element.lastElementChild):(!a||e.includes(p.Constants.CB_GET_FOCUSFIRST))&&(a=t.wysiwyg.element.firstElementChild),e.includes(p.Constants.CB_GET_HL)&&(ln(t),Ol(a)),e.includes(p.Constants.CB_GET_FOCUS)||e.includes(p.Constants.CB_GET_FOCUSFIRST)){let s;n&&n.focusId?s=Gn(a,n.focusStart,n.focusEnd):le(a),e.includes(p.Constants.CB_GET_UNUNDO)||ys(t,s,a)}const i=n&&typeof n.scrollTop=="number";if(i&&(t.contentElement.scrollTop=n.scrollTop),e.includes(p.Constants.CB_GET_FOCUS)||e.includes(p.Constants.CB_GET_SCROLL)||e.includes(p.Constants.CB_GET_HL)||e.includes(p.Constants.CB_GET_FOCUSFIRST)){const s=t.contentElement.getBoundingClientRect(),o=a.getBoundingClientRect();!i&&(s.top>o.top||s.bottom<o.bottom)&&He(t,a,!0)}else{t.observerLoad?.disconnect();return}t.observerLoad=new ResizeObserver(()=>{if(i&&(t.contentElement.scrollTop=n.scrollTop),e.includes(p.Constants.CB_GET_FOCUS)||e.includes(p.Constants.CB_GET_HL)||e.includes(p.Constants.CB_GET_FOCUSFIRST)){const s=t.contentElement.getBoundingClientRect(),o=a.getBoundingClientRect();!i&&(s.top>o.top||s.bottom<o.bottom)&&He(t,a,!0)}}),t.observerLoad.observe(t.wysiwyg.element),t.observer.unobserve(t.wysiwyg.element),setTimeout(()=>{t.observerLoad.disconnect(),t.observer.observe(t.wysiwyg.element)},1e3*3),a.isSameNode(t.wysiwyg.element.firstElementChild)&&!i&&t.observerLoad.disconnect()},Og=t=>{let e=window.siyuan.config.readonly?"true":"false";e==="false"&&(e=window.siyuan.config.editor.readOnly?"true":"false",e==="false"&&(e=t.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_READONLY))),e==="true"?ia(t):Kd(t)};class ja extends ct{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&w("/api/block/checkBlockExist",{id:this.blockId},n=>{n.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(n){if(n)switch(n.cmd){case"transactions":this.onTransaction(n);break;case"rename":this.type==="local"&&this.blockId===n.data.id?this.parent.updateTitle(n.data.title):this.updateDocTitle({title:n.data.title,icon:p.Constants.ZWSP});break;case"unmount":this.type==="local"&&w("/api/block/checkBlockExist",{id:this.blockId},a=>{a.data||this.parent.parent.removeTab(this.parent.id)});break;case"removeDoc":n.data.ids.includes(this.blockId)&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break}}}),this.openNodes={},this.isPreview=e.isPreview,this.blockId=e.blockId,this.type=e.type,e.tab.panelElement.classList.add("fn__flex-column","file-tree","sy__outline"),e.tab.panelElement.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconAlignCenter"></use></svg>
        ${window.siyuan.languages.outline}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.stickOpen} ${K(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${K(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min" class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${K(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="b3-list-item fn__none"></div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.element=e.tab.panelElement.lastElementChild,this.headerElement=e.tab.panelElement.firstElementChild,this.tree=new oo({element:e.tab.panelElement.lastElementChild,data:null,click:n=>{const a=n.getAttribute("data-node-id");if(this.isPreview){const i=document.getElementById(a);if(i){const s=ut(i,"protyle");if(s){const o=Lt(s.getAttribute("data-id"));o.parent.switchTab(o.headElement)}i.scrollIntoView()}else de({app:e.app,id:this.blockId,mode:"preview"})}else ot(a,i=>{de({app:e.app,id:a,action:i?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SETID,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_HTML]})})},ctrlClick(n){const a=n.getAttribute("data-node-id");de({app:e.app,id:a,action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML],zoomIn:!0})}}),e.tab.panelElement.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),e.tab.panelElement.querySelector('[data-type="expand"]').addEventListener("click",n=>{const a=A(n.target,"block__icon");a&&(a.classList.contains("block__icon--active")?a.classList.remove("block__icon--active"):a.classList.add("block__icon--active"),this.tree.expandAll())}),e.tab.panelElement.addEventListener("click",n=>{this.type==="local"?Ze(e.tab.panelElement.parentElement.parentElement):Ze(e.tab.panelElement);let a=n.target;for(;a&&!a.isEqualNode(e.tab.panelElement);){if(a.classList.contains("block__icon")){switch(a.getAttribute("data-type")){case"min":St("outline").toggleModel("outline");break}break}else if(a.isSameNode(this.headerElement.nextElementSibling)||a.classList.contains("block__icons")){Pe().editor.find(i=>{if(this.blockId===i.editor.protyle.block.rootID)return i.editor.protyle.scroll.element.classList.contains("fn__none")?i.editor.protyle.contentElement.scrollTop=0:w("/api/filetree/getDoc",{id:i.editor.protyle.block.rootID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},s=>{st({data:s,protyle:i.editor.protyle,action:[p.Constants.CB_GET_FOCUS]})}),!0});break}a=a.parentElement}}),this.isPreview?this.blockId&&w("/api/export/preview",{id:this.blockId},n=>{n.data=n.data.outline,this.update(n)}):w("/api/outline/getDocOutline",{id:this.blockId},n=>{this.update(n)})}updateDocTitle(e){const n=this.headerElement.nextElementSibling;if(this.type==="pin")if(e){let a=`${ie(e.icon||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}`;e.icon===p.Constants.ZWSP&&n.firstElementChild&&(a=n.firstElementChild.outerHTML),n.innerHTML=`${a}
<span class="b3-list-item__text">${we(e.title)}</span>`,n.setAttribute("title",e.title),n.classList.remove("fn__none")}else n.classList.add("fn__none");else n.classList.add("fn__none")}onTransaction(e){if(this.isPreview)return;let n=!1;e.data[0].doOperations.forEach(a=>{((a.action==="update"||a.action==="insert")&&(a.data.indexOf('data-type="NodeHeading"')>-1||a.data.indexOf(`<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"><wbr></div>`)>-1)||a.action==="delete"||a.action==="move")&&(n=!0)}),e.data[0].undoOperations&&e.data[0].undoOperations.forEach(a=>{a.action==="update"&&a.data.indexOf('data-type="NodeHeading"')>-1&&(n=!0)}),n&&w("/api/outline/getDocOutline",{id:this.blockId},a=>{if(this.update(a),getSelection().rangeCount>0){const i=x(getSelection().getRangeAt(0).startContainer);i&&i.getAttribute("data-type")==="NodeHeading"&&this.setCurrent(i)}})}setCurrent(e){if(e)if(e.getAttribute("data-type")==="NodeHeading")this.setCurrentById(e.getAttribute("data-node-id"));else{let n=De(e);for(;n&&n.getAttribute("data-type")!=="NodeHeading";)n=De(n);n?this.setCurrentById(n.getAttribute("data-node-id")):w("/api/block/getBlockBreadcrumb",{id:e.getAttribute("data-node-id"),excludeTypes:[]},a=>{a.data.reverse().find(i=>{if(i.type==="NodeHeading")return this.setCurrentById(i.id),!0})})}}setCurrentById(e){this.element.querySelectorAll(".b3-list-item.b3-list-item--focus").forEach(a=>{a.classList.remove("b3-list-item--focus")});let n=this.element.querySelector(`.b3-list-item[data-node-id="${e}"]`);for(;n&&n.clientHeight===0;)n=n.parentElement.previousElementSibling;n&&(n.classList.add("b3-list-item--focus"),this.element.scrollTop=n.offsetTop-this.element.clientHeight/2-30)}update(e,n){let a=this.element.querySelector(".b3-list-item--focus"),i;a&&(i=a.getAttribute("data-node-id")),!this.isPreview&&this.openNodes[this.blockId]&&(this.openNodes[this.blockId]=this.tree.getExpandIds()),typeof n<"u"&&(this.blockId=n),this.tree.updateData(e.data),!this.isPreview&&this.openNodes[this.blockId]&&!this.headerElement.querySelector('[data-type="expand"]').classList.contains("block__icon--active")?this.tree.setExpandIds(this.openNodes[this.blockId]):(this.tree.expandAll(),this.isPreview||(this.openNodes[this.blockId]=this.tree.getExpandIds())),this.isPreview&&this.tree.element.querySelectorAll(".popover__block").forEach(s=>{s.classList.remove("popover__block")}),i&&(a=this.element.querySelector(`[data-node-id="${i}"]`),a&&a.classList.add("b3-list-item--focus"))}}class Ka extends ct{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&w("/api/block/checkBlockExist",{id:this.blockId},n=>{n.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(n){if(n&&this.type==="local")switch(n.cmd){case"rename":this.rootId===n.data.id&&this.parent.updateTitle(n.data.title);break;case"unmount":this.notebookId===n.data.box&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break;case"removeDoc":n.data.ids.includes(this.rootId)&&this.type==="local"&&this.parent.parent.removeTab(this.parent.id);break}}}),this.editors=[],this.status={},this.blockId=e.blockId,this.rootId=e.rootId,this.type=e.type,this.element=e.tab.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__backlink"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconLink"></use></svg>
        ${window.siyuan.languages.backlinks}
    </div>
    <span class="counter listCount" style="margin-left: 0"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.filter}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="sort" data-sort="3" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.sort}"><svg><use xlink:href='#iconSort'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand} ${K(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${K(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min" class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${K(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="backlinkList fn__flex-1"></div>
<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconLink"></use></svg>
        ${window.siyuan.languages.mentions}
    </div>
    <span class="counter listMCount" style="margin-left: 0;"></span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__none fn__size200" placeholder="${window.siyuan.languages.filterKeywordEnter}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.filter}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="mSort" data-sort="3" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.sort}"><svg><use xlink:href='#iconSort'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="mExpand" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.expand}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="mCollapse" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.collapse}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="layout" class="block__icon b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.down}">
        <svg><use xlink:href="#iconDown"></use></svg>
    </span>
</div>
<div class="backlinkMList fn__flex-1"></div>`,this.inputsElement=this.element.querySelectorAll("input"),this.inputsElement.forEach(n=>{n.addEventListener("blur",a=>{a.target.classList.add("fn__none")}),n.addEventListener("keydown",a=>{!a.isComposing&&a.key==="Enter"&&this.searchBacklinks()}),n.addEventListener("input",a=>{const i=a.target;i.value===""?i.classList.remove("search__input--block"):i.classList.add("search__input--block")})}),this.tree=new oo({element:this.element.querySelector(".backlinkList"),data:null,click:n=>{this.toggleItem(n,!1),this.setFocus(),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},ctrlClick:n=>{de({app:e.app,id:n.getAttribute("data-node-id"),action:[p.Constants.CB_GET_CONTEXT]}),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},altClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT]}),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},shiftClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT]}),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},toggleClick:n=>{this.toggleItem(n,!1),this.setFocus(),this.mTree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")}}),this.mTree=new oo({element:this.element.querySelector(".backlinkMList"),data:null,click:n=>{this.toggleItem(n,!0),this.setFocus(),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},ctrlClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),action:[p.Constants.CB_GET_CONTEXT]}),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},altClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT]}),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},shiftClick(n){de({app:e.app,id:n.getAttribute("data-node-id"),position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT]}),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},toggleClick:n=>{this.toggleItem(n,!0),this.setFocus(),this.tree.element.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus")},blockExtHTML:`<span class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></span>`}),this.tree.element.addEventListener("scroll",()=>{this.tree.element.querySelectorAll(".protyle-gutters").forEach(n=>{n.classList.add("fn__none"),n.innerHTML=""}),this.tree.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(n=>{n.classList.remove("protyle-wysiwyg--hl")})}),this.mTree.element.addEventListener("scroll",()=>{this.mTree.element.querySelectorAll(".protyle-gutters").forEach(n=>{n.classList.add("fn__none"),n.innerHTML=""}),this.mTree.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(n=>{n.classList.remove("protyle-wysiwyg--hl")})}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.element.querySelectorAll(".protyle").forEach(n=>{n.classList.add("fn__none")}),this.tree.element.querySelectorAll(".b3-list-item__arrow").forEach(n=>{n.classList.remove("b3-list-item__arrow--open")})}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{Array.from(this.tree.element.firstElementChild.children).forEach(n=>{n.tagName==="LI"&&!n.querySelector(".b3-list-item__arrow--open")&&this.toggleItem(n,!1)})}),this.element.addEventListener("click",n=>{this.setFocus();let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.classList.contains("block__icon")&&a.parentElement.parentElement.isSameNode(this.element)){const i=a.getAttribute("data-type");switch(i){case"refresh":this.refresh();break;case"mExpand":Array.from(this.mTree.element.firstElementChild.children).forEach(s=>{s.tagName==="LI"&&!s.querySelector(".b3-list-item__arrow--open")&&this.toggleItem(s,!0)});break;case"mCollapse":this.mTree.element.querySelectorAll(".protyle").forEach(s=>{s.classList.add("fn__none")}),this.mTree.element.querySelectorAll(".b3-list-item__arrow").forEach(s=>{s.classList.remove("b3-list-item__arrow--open")});break;case"min":St("backlink").toggleModel("backlink");break;case"search":a.previousElementSibling.classList.remove("fn__none"),a.previousElementSibling.select();break;case"sort":case"mSort":this.showSortMenu(i,a.getAttribute("data-sort")),window.siyuan.menus.menu.popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break;case"layout":this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")):a.getAttribute("aria-label")===window.siyuan.languages.down?(this.tree.element.classList.remove("fn__none"),this.mTree.element.setAttribute("style","flex:none;height:0px"),a.setAttribute("aria-label",window.siyuan.languages.up),a.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.add("fn__none"),this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),a.setAttribute("aria-label",window.siyuan.languages.down),a.querySelector("use").setAttribute("xlink:href","#iconDown")),this.tree.element.dispatchEvent(new CustomEvent("scroll")),this.mTree.element.dispatchEvent(new CustomEvent("scroll"));break}}a=a.parentElement}}),this.searchBacklinks(!0)}setFocus(){this.type==="local"?Ze(this.element.parentElement.parentElement):Ze(this.element)}showSortMenu(e,n){const a=i=>{(e==="sort"?this.tree:this.mTree).element.previousElementSibling.querySelector(`[data-type="${e}"]`).setAttribute("data-sort",i),this.searchBacklinks()};window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new S({icon:n==="0"?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{a("0")}}).element),window.siyuan.menus.menu.append(new S({icon:n==="1"?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{a("1")}}).element),window.siyuan.menus.menu.append(new S({icon:n==="4"?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{a("4")}}).element),window.siyuan.menus.menu.append(new S({icon:n==="5"?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{a("5")}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({icon:n==="9"?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{a("9")}}).element),window.siyuan.menus.menu.append(new S({icon:n==="10"?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{a("10")}}).element),window.siyuan.menus.menu.append(new S({icon:n==="2"?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{a("2")}}).element),window.siyuan.menus.menu.append(new S({icon:n==="3"?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{a("3")}}).element)}toggleItem(e,n){const a=e.firstElementChild?.firstElementChild;if(!a||a.getAttribute("disabled"))return;a.setAttribute("disabled","disabled");const i=e.getAttribute("data-node-id");a.classList.contains("b3-list-item__arrow--open")?(a.classList.remove("b3-list-item__arrow--open"),this.editors.find((s,o)=>{if(s.protyle.block.rootID===i&&e.nextElementSibling&&s.protyle.element.isSameNode(e.nextElementSibling))return s.destroy(),this.editors.splice(o,1),e.nextElementSibling.remove(),!0}),a.removeAttribute("disabled")):w(n?"/api/ref/getBackmentionDoc":"/api/ref/getBacklinkDoc",{defID:this.blockId,refTreeID:i,keyword:n?this.inputsElement[1].value:this.inputsElement[0].value},s=>{a.removeAttribute("disabled"),a.classList.add("b3-list-item__arrow--open");const o=document.createElement("div");o.style.minHeight="auto",o.setAttribute("data-defid",this.blockId),o.setAttribute("data-ismention",n?"true":"false"),e.after(o);const l=new pn(this.app,o,{blockId:i,backlinkData:n?s.data.backmentions:s.data.backlinks,render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!1}});l.protyle.notebookId=e.getAttribute("data-notebook-id"),this.editors.push(l)})}refresh(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');e.classList.add("fn__rotate"),w("/api/ref/refreshBacklink",{id:this.blockId},()=>{e.classList.remove("fn__rotate"),this.searchBacklinks()})}searchBacklinks(e=!1){const n=this.element.querySelector('.block__icon[data-type="refresh"] svg');n.classList.contains("fn__rotate")||(n.classList.add("fn__rotate"),w("/api/ref/getBacklink2",{sort:this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').getAttribute("data-sort"),mSort:this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').getAttribute("data-sort"),k:this.inputsElement[0].value,mk:this.inputsElement[1].value,id:this.blockId},a=>{e||this.saveStatus(),this.render(a.data)}))}saveStatus(){this.status[this.blockId]={sort:this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').getAttribute("data-sort"),mSort:this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').getAttribute("data-sort"),scrollTop:this.tree.element.scrollTop,mScrollTop:this.mTree.element.scrollTop,backlinkOpenIds:[],backlinkMOpenIds:[],backlinkMStatus:3},this.tree.element.querySelectorAll(".b3-list-item__arrow--open").forEach(e=>{this.status[this.blockId].backlinkOpenIds.push(e.parentElement.parentElement.getAttribute("data-node-id"))}),this.mTree.element.querySelectorAll(".b3-list-item__arrow--open").forEach(e=>{this.status[this.blockId].backlinkMOpenIds.push(e.parentElement.parentElement.getAttribute("data-node-id"))}),this.mTree.element.style.flex?this.mTree.element.style.height==="0px"?this.status[this.blockId].backlinkMStatus=3:this.status[this.blockId].backlinkMStatus=0:this.mTree.element.previousElementSibling.querySelector('[data-type="layout"]').getAttribute("aria-label")===window.siyuan.languages.down?this.status[this.blockId].backlinkMStatus=1:this.status[this.blockId].backlinkMStatus=2}render(e){e||(e={box:"",backlinks:[],backmentions:[],linkRefsCount:0,mentionsCount:0,k:"",mk:""}),this.editors.forEach(s=>{s.destroy()}),this.editors=[],this.element.querySelector('.block__icon[data-type="refresh"] svg').classList.remove("fn__rotate"),this.notebookId=e.box,this.inputsElement[0].value=e.k,this.inputsElement[1].value=e.mk,this.tree.updateData(e.backlinks),this.mTree.updateData(e.backmentions);const n=this.element.querySelector(".listCount");e.linkRefsCount===0?n.classList.add("fn__none"):(n.classList.remove("fn__none"),n.textContent=e.linkRefsCount.toString());const a=this.element.querySelector(".listMCount");e.mentionsCount===0?a.classList.add("fn__none"):(a.classList.remove("fn__none"),a.textContent=e.mentionsCount.toString()),this.status[this.blockId]||(this.status[this.blockId]={sort:"3",mSort:"3",scrollTop:0,mScrollTop:0,backlinkOpenIds:[],backlinkMOpenIds:[],backlinkMStatus:3},e.mentionsCount===0?this.status[this.blockId].backlinkMStatus=3:(Array.from({length:window.siyuan.config.editor.backmentionExpandCount}).forEach((s,o)=>{e.backmentions[o]&&this.status[this.blockId].backlinkMOpenIds.push(e.backmentions[o].id)}),window.siyuan.config.editor.backmentionExpandCount===0?this.status[this.blockId].backlinkMStatus=3:e.linkRefsCount===0?this.status[this.blockId].backlinkMStatus=0:this.status[this.blockId].backlinkMStatus=1),e.linkRefsCount>0&&Array.from({length:window.siyuan.config.editor.backlinkExpandCount}).forEach((s,o)=>{e.backlinks[o]&&this.status[this.blockId].backlinkOpenIds.push(e.backlinks[o].id)})),this.status[this.blockId].backlinkOpenIds.forEach(s=>{const o=this.tree.element.querySelector(`.b3-list-item[data-node-id="${s}"]`);o&&this.toggleItem(o,!1)}),this.status[this.blockId].backlinkMOpenIds.forEach(s=>{const o=this.mTree.element.querySelector(`.b3-list-item[data-node-id="${s}"]`);o&&this.toggleItem(o,!0)});const i=this.mTree.element.previousElementSibling.querySelector('[data-type="layout"]');this.status[this.blockId].backlinkMStatus===2||this.status[this.blockId].backlinkMStatus===1?(this.tree.element.classList.remove("fn__none"),this.mTree.element.removeAttribute("style"),this.status[this.blockId].backlinkMStatus===1?(i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")):(i.setAttribute("aria-label",window.siyuan.languages.up),i.querySelector("use").setAttribute("xlink:href","#iconUp"))):this.status[this.blockId].backlinkMStatus===3?(this.tree.element.classList.remove("fn__none"),this.mTree.element.setAttribute("style","flex:none;height:0px"),i.setAttribute("aria-label",window.siyuan.languages.up),i.querySelector("use").setAttribute("xlink:href","#iconUp")):(this.tree.element.classList.add("fn__none"),this.mTree.element.setAttribute("style",`flex:none;height:${this.element.clientHeight-this.tree.element.previousElementSibling.clientHeight*2}px`),i.setAttribute("aria-label",window.siyuan.languages.down),i.querySelector("use").setAttribute("xlink:href","#iconDown")),this.tree.element.previousElementSibling.querySelector('[data-type="sort"]').setAttribute("data-sort",this.status[this.blockId].sort),this.mTree.element.previousElementSibling.querySelector('[data-type="mSort"]').setAttribute("data-sort",this.status[this.blockId].mSort),setTimeout(()=>{this.tree.element.scrollTop=this.status[this.blockId].scrollTop,this.mTree.element.scrollTop=this.status[this.blockId].mScrollTop},p.Constants.TIMEOUT_LOAD)}}const rr=async t=>{if(Pe().backlink.find(s=>{if(s.blockId===t.blockId&&s.type==="local")return s.parent.parent.removeTab(s.parent.id),!0}))return;let n;const a=document.querySelector(".layout__wnd--active");if(a&&(n=Lt(a.getAttribute("data-id"))),n||(n=Ni(window.siyuan.layout.centerLayout)),t.rootId){if(!t.title){const s=await lt("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.title=s.data.name||"Untitled"}}else{const s=await lt("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.rootId=s.data.rootID,t.useBlockId=s.data.rootID!==s.data.id,t.title=s.data.name||"Untitled"}n.split("lr").addTab(new gt({icon:"iconLink",title:t.title,callback(s){s.addModel(new Ka({app:t.app,type:"local",tab:s,blockId:t.useBlockId?t.blockId:t.rootId,rootId:t.rootId}))}}))},cr=async t=>{if(Pe().graph.find(s=>{if(s.blockId===t.blockId&&s.type==="local")return s.parent.parent.removeTab(s.parent.id),!0}))return;let n;const a=document.querySelector(".layout__wnd--active");if(a&&(n=Lt(a.getAttribute("data-id"))),n||(n=Ni(window.siyuan.layout.centerLayout)),t.rootId){if(!t.title){const s=await lt("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.title=s.data.name||"Untitled"}}else{const s=await lt("api/block/getDocInfo",{id:t.blockId});if(s.code===-1)return;t.rootId=s.data.rootID,t.useBlockId=s.data.rootID!==s.data.id,t.title=s.data.name||"Untitled"}n.split("lr").addTab(new gt({icon:"iconGraph",title:t.title,callback(s){s.addModel(new oa({app:t.app,type:"local",tab:s,blockId:t.blockId,rootId:t.rootId}))}}))},Rg=async t=>{if(Pe().outline.find(o=>{if(o.blockId===t.block.rootID&&o.type==="local")return o.parent.parent.removeTab(o.parent.id),!0}))return;let n;const a=document.querySelector(".layout__wnd--active");a&&(n=Lt(a.getAttribute("data-id"))),n||(n=Ni(window.siyuan.layout.centerLayout));const i=n.split("lr");let s="";t.title?s=t.title.editElement.textContent||"Untitled":s=(await lt("api/block/getDocInfo",{id:t.block.rootID})).data.name||"Untitled",i.addTab(new gt({icon:"iconAlignCenter",title:s,callback(o){o.addModel(new ja({app:t.app,type:"local",tab:o,blockId:t.block.rootID,isPreview:!t.preview.element.classList.contains("fn__none")}))}})),i.element.classList.remove("fn__flex-1"),i.element.style.width="200px",Uu(i,n)},Zd=()=>{!window.siyuan.layout.leftDock.pin&&window.siyuan.layout.leftDock.layout.element.style.opacity==="1"&&window.siyuan.layout.leftDock.showDock(!0),!window.siyuan.layout.rightDock.pin&&window.siyuan.layout.rightDock.layout.element.style.opacity==="1"&&window.siyuan.layout.rightDock.showDock(!0),!window.siyuan.layout.bottomDock.pin&&window.siyuan.layout.bottomDock.layout.element.style.opacity==="1"&&window.siyuan.layout.bottomDock.showDock(!0)},Bg=t=>{const e=t.getAttribute("xlink:href")==="#iconHideDock";e?t.setAttribute("xlink:href","#iconDock"):t.setAttribute("xlink:href","#iconHideDock"),window.siyuan.config.uiLayout.hideDock=e,document.querySelectorAll(".dock").forEach(n=>{e?n.classList.add("fn__none"):n.querySelectorAll(".dock__item").length>1&&n.classList.remove("fn__none")}),jt(),Zd()},tt={element:void 0,genHTML:()=>`<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance4}
        <div class="b3-label__text">${window.siyuan.languages.appearance5}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="mode">
      <option value="0" ${window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeLight}</option>
      <option value="1" ${window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeDark}</option>
      <option value="2" ${window.siyuan.config.appearance.modeOS?"selected":""}>${window.siyuan.languages.themeOS}</option>
    </select>
</div>
<div class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-center">${window.siyuan.languages.theme}</div>
        <span class="fn__space"></span>
        <a href="javascript:void(0)" ${(0,I.jU)()?" class='fn__none'":""} id="appearanceOpenTheme" class="fn__flex-center">${window.siyuan.languages.appearance9}</a>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.theme11}
        </div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="themeLight">
          ${ba(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight)}
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">
            ${window.siyuan.languages.theme12}
        </div>
        <span class="fn__space"></span>
        <select class="b3-select fn__flex-center fn__size200" id="themeDark">
           ${ba(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark)}
        </select>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        <div class="fn__flex">
            ${window.siyuan.languages.icon}
            <span class="fn__space"></span>
            <a href="javascript:void(0)"${(0,I.jU)()?" class='fn__none'":""} id="appearanceOpenIcon">${window.siyuan.languages.appearance8}</a>
        </div>
        <div class="b3-label__text">${window.siyuan.languages.theme2}</div>
    </div>
    <span class="fn__space"></span>
    <select class="b3-select fn__flex-center fn__size200" id="icon">
        ${ba(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon)}
    </select>
</div>
<div class="b3-label fn__flex"><div class="fn__block">
    <div>
        ${window.siyuan.languages.appearance1}
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.appearance2}</div>
        <span class="fn__space"></span>
        <select id="codeBlockThemeLight" class="b3-select fn__size200">
            ${ba(p.Constants.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE,window.siyuan.config.appearance.codeBlockThemeLight)}
        </select>
    </div>
    <div class="fn__hr"></div>
    <div class="fn__flex config__item">
        <div class="fn__flex-center fn__flex-1 ft__on-surface">${window.siyuan.languages.appearance3}</div>
        <span class="fn__space"></span>
        <select id="codeBlockThemeDark" class="b3-select fn__size200">
            ${ba(p.Constants.SIYUAN_CONFIG_APPEARANCE_DARK_CODE,window.siyuan.config.appearance.codeBlockThemeDark)}
        </select>
    </div>
</div></div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.language}
        <div class="b3-label__text">${window.siyuan.languages.language1}</div>
    </div>
    <span class="fn__space"></span>
    <select id="lang" class="b3-select fn__flex-center fn__size200">${ba(window.siyuan.config.langs,window.siyuan.config.appearance.lang)}</select>
</div>
<div class="b3-label config__item${(0,I.jU)()?" fn__none":" fn__flex"}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.customEmoji}
        <div class="b3-label__text">${window.siyuan.languages.customEmojiTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="appearanceRefresh">
        <svg><use xlink:href="#iconRefresh"></use></svg>
        ${window.siyuan.languages.refresh}
    </button>
</div>
<div class="b3-label fn__flex config__item">
   <div class="fn__flex-1">
        ${window.siyuan.languages.resetLayout}
        <div class="b3-label__text">${window.siyuan.languages.appearance6}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="resetLayout">
        <svg><use xlink:href="#iconUndo"></use></svg>${window.siyuan.languages.reset}
    </button>
</div>
<div class="b3-label fn__flex config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.codeSnippet}
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="codeSnippet">
        <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
    </button>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance16}
        <div class="b3-label__text">${window.siyuan.languages.appearance17}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="hideStatusBar" type="checkbox"${window.siyuan.config.appearance.hideStatusBar?" checked":""}>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.appearance10}
        <div class="b3-label__text">${window.siyuan.languages.appearance11}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="closeButtonBehavior" type="checkbox"${window.siyuan.config.appearance.closeButtonBehavior===0?"":" checked"}>
</label>`,_send:()=>{const t=tt.element.querySelector("#themeLight").value,e=tt.element.querySelector("#themeDark").value,n=parseInt(tt.element.querySelector("#mode").value);w("/api/setting/setAppearance",{icon:tt.element.querySelector("#icon").value,mode:n===2?window.siyuan.config.appearance.mode:n,modeOS:n===2,codeBlockThemeDark:tt.element.querySelector("#codeBlockThemeDark").value,codeBlockThemeLight:tt.element.querySelector("#codeBlockThemeLight").value,themeDark:e,themeLight:t,darkThemes:window.siyuan.config.appearance.darkThemes,lightThemes:window.siyuan.config.appearance.lightThemes,icons:window.siyuan.config.appearance.icons,lang:tt.element.querySelector("#lang").value,closeButtonBehavior:tt.element.querySelector("#closeButtonBehavior").checked?1:0,hideStatusBar:tt.element.querySelector("#hideStatusBar").checked},a=>{if(window.siyuan.config.appearance.themeJS){if(!a.data.modeOS&&(a.data.mode!==window.siyuan.config.appearance.mode||window.siyuan.config.appearance.themeLight!==a.data.themeLight||window.siyuan.config.appearance.themeDark!==a.data.themeDark)){It({errorExit:!1,cb(){window.location.reload()}});return}const i=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";if(a.data.modeOS&&(a.data.mode===1&&i==="light"||a.data.mode===0&&i==="dark")){It({cb(){window.location.reload()},errorExit:!1});return}}tt.onSetappearance(a.data),a.data.hideStatusBar?document.getElementById("status").classList.add("fn__none"):document.getElementById("status").classList.remove("fn__none"),Zd()})},bindEvent:()=>{tt.element.querySelector("#codeSnippet").addEventListener("click",()=>{Kw()}),tt.element.querySelector("#resetLayout").addEventListener("click",()=>{yb()}),tt.element.querySelector("#appearanceOpenIcon").addEventListener("click",()=>{te.shell.openPath(kt.join(window.siyuan.config.system.confDir,"appearance","icons"))}),tt.element.querySelector("#appearanceOpenTheme").addEventListener("click",()=>{te.shell.openPath(kt.join(window.siyuan.config.system.confDir,"appearance","themes"))}),tt.element.querySelector("#appearanceOpenEmoji").addEventListener("click",()=>{te.shell.openPath(kt.join(window.siyuan.config.system.dataDir,"emojis"))}),tt.element.querySelector("#appearanceRefresh").addEventListener("click",()=>{It({cb(){window.location.reload()},errorExit:!1})}),tt.element.querySelectorAll("select").forEach(t=>{t.addEventListener("change",()=>{tt._send()})}),tt.element.querySelectorAll(".b3-switch").forEach(t=>{t.addEventListener("change",()=>{tt._send()})})},onSetappearance(t){if(t.lang!==window.siyuan.config.appearance.lang){It({cb(){window.location.reload()},errorExit:!1});return}if(window.siyuan.config.appearance=t,tt.element){const e=tt.element.querySelector("#mode");e&&(t.modeOS?e.value="2":e.value=t.mode===0?"0":"1");const n=tt.element.querySelector("#themeLight");n&&(n.innerHTML=ba(window.siyuan.config.appearance.lightThemes,window.siyuan.config.appearance.themeLight));const a=tt.element.querySelector("#themeDark");a&&(a.innerHTML=ba(window.siyuan.config.appearance.darkThemes,window.siyuan.config.appearance.themeDark));const i=tt.element.querySelector("#icon");i&&(i.innerHTML=ba(window.siyuan.config.appearance.icons,window.siyuan.config.appearance.icon))}Fg(t),document.querySelector("#barMode use")?.setAttribute("xlink:href",`#icon${window.siyuan.config.appearance.modeOS?"Mode":window.siyuan.config.appearance.mode===0?"Light":"Dark"}`)}},qg=(t,e)=>{(0,ze.addScript)(t,"iconDefaultScript").then(()=>{if(!["ant","material"].includes(e.icon)){const n=document.getElementById("iconScript");n&&n.remove(),(0,ze.addScript)(`/appearance/icons/${e.icon}/icon.js?v=${e.iconVer}`,"iconScript")}})},Fg=t=>{const e=document.getElementsByTagName("html")[0];e.setAttribute("lang",window.siyuan.config.appearance.lang),e.setAttribute("data-theme-mode",Vg()),e.setAttribute("data-light-theme",window.siyuan.config.appearance.themeLight),e.setAttribute("data-dark-theme",window.siyuan.config.appearance.themeDark);const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===1&&n==="light"||window.siyuan.config.appearance.mode===0&&n==="dark")&&(w("/api/system/setAppearanceMode",{mode:n==="light"?0:1}),window.siyuan.config.appearance.mode=n==="light"?0:1);const a=document.getElementById("themeDefaultStyle");let i=`/appearance/themes/${t.mode===1?"midnight":"daylight"}/theme.css?v=${p.Constants.SIYUAN_VERSION}`;(t.mode===1&&t.themeDark!=="midnight"||t.mode===0&&t.themeLight!=="daylight")&&(i=`/appearance/themes/${t.mode===1?"midnight":"daylight"}/theme.css?v=${p.Constants.SIYUAN_VERSION}`),a?a.getAttribute("href").startsWith(i)||(a.remove(),mi(i,"themeDefaultStyle")):mi(i,"themeDefaultStyle");const s=document.getElementById("themeStyle");if(t.mode===1&&t.themeDark!=="midnight"||t.mode===0&&t.themeLight!=="daylight"){const u=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.css?v=${t.themeVer}`;s?s.getAttribute("href").startsWith(u)||(s.remove(),mi(u,"themeStyle")):mi(u,"themeStyle")}else s&&s.remove();Pe().graph.forEach(u=>{u.searchGraph(!1)});const o=window.siyuan.config.appearance.mode===0?window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].light:window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].dark;document.querySelectorAll(".pdf__outer").forEach(u=>{const f=u.querySelector("#pdfDark"),g=u.querySelector("#pdfLight");o==="dark"?(u.classList.add("pdf__outer--dark"),g.classList.remove("toggled"),f.classList.add("toggled")):(u.classList.remove("pdf__outer--dark"),g.classList.add("toggled"),f.classList.remove("toggled"))}),Ug();const l=document.getElementById("themeScript"),r=`/appearance/themes/${t.mode===1?t.themeDark:t.themeLight}/theme.js?v=${t.themeVer}`;l?l.getAttribute("src").startsWith(r)||(l.remove(),(0,ze.addScript)(r,"themeScript")):(0,ze.addScript)(r,"themeScript");const c=document.getElementById("iconDefaultScript"),d=`/appearance/icons/${["ant","material"].includes(t.icon)?t.icon:"material"}/icon.js?v=${p.Constants.SIYUAN_VERSION}`;if(c){c.remove();let u=document.body.firstElementChild;for(;u.tagName==="svg";){const f=u;u=u.nextElementSibling,f.getAttribute("data-name")||f.remove()}qg(d,t)}else qg(d,t)},f_=()=>{const t=document.getElementById("loading");t&&setTimeout(()=>{t.remove()},160),Wg(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{const n=e.matches?"dark":"light";Wg(n),window.siyuan.config.appearance.modeOS&&(window.siyuan.config.appearance.mode===0&&n==="light"||window.siyuan.config.appearance.mode===1&&n==="dark"||w("/api/system/setAppearanceMode",{mode:n==="light"?0:1},a=>{if(window.siyuan.config.appearance.themeJS){It({cb(){window.location.reload()},errorExit:!1});return}window.siyuan.config.appearance=a.data.appearance,Fg(a.data.appearance)}))})},p_=()=>{if(!window.siyuan.config.system.disableGoogleAnalytics){(0,ze.addScript)("https://www.googletagmanager.com/gtag/js?id=G-L7WEXVQCR9","gaScript"),window.dataLayer=window.dataLayer||[];const t=function(...n){window.dataLayer.push(arguments)};t("js",new Date),t("config","G-L7WEXVQCR9",{send_page_view:!1});const e={version:p.Constants.SIYUAN_VERSION,container:window.siyuan.config.system.container,os:window.siyuan.config.system.os,osPlatform:window.siyuan.config.system.osPlatform,isLoggedIn:!1,subscriptionStatus:-1,subscriptionPlan:-1,subscriptionType:-1,oneTimePayStatus:-1,syncEnabled:!1,syncProvider:-1,cTreeCount:window.siyuan.config.stat.cTreeCount,cBlockCount:window.siyuan.config.stat.cBlockCount,cDataSize:window.siyuan.config.stat.cDataSize,cAssetsSize:window.siyuan.config.stat.cAssetsSize};window.siyuan.user&&(e.isLoggedIn=!0,e.subscriptionStatus=window.siyuan.user.userSiYuanSubscriptionStatus,e.subscriptionPlan=window.siyuan.user.userSiYuanSubscriptionPlan,e.subscriptionType=window.siyuan.user.userSiYuanSubscriptionType,e.oneTimePayStatus=window.siyuan.user.userSiYuanOneTimePayStatus),window.siyuan.config.sync&&(e.syncEnabled=window.siyuan.config.sync.enabled,e.syncProvider=window.siyuan.config.sync.provider),t("event",p.Constants.ANALYTICS_EVT_ON_GET_CONFIG,e)}},ko=(t=!0)=>{const e=Math.floor(window.siyuan.config.editor.fontSize*1.625);let n=`.b3-typography, .protyle-wysiwyg, .protyle-title {font-size:${window.siyuan.config.editor.fontSize}px !important}
.b3-typography code:not(.hljs), .protyle-wysiwyg span[data-type~=code] { font-variant-ligatures: ${window.siyuan.config.editor.codeLigatures?"normal":"none"} }
.li > .protyle-action {height:${e+8}px;line-height: ${e+8}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h1, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h2, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h3, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h4, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h5, .protyle-wysiwyg [data-node-id].li > .protyle-action ~ .h6 {line-height:${e+8}px;}
.protyle-wysiwyg [data-node-id].li > .protyle-action:after {height: ${window.siyuan.config.editor.fontSize}px;width: ${window.siyuan.config.editor.fontSize}px;margin:-${window.siyuan.config.editor.fontSize/2}px 0 0 -${window.siyuan.config.editor.fontSize/2}px}
.protyle-wysiwyg [data-node-id].li > .protyle-action svg {height: ${Math.max(14,window.siyuan.config.editor.fontSize-8)}px}
.protyle-wysiwyg [data-node-id].li:before {height: calc(100% - ${e+8}px);top:${e+8}px}
.protyle-wysiwyg [data-node-id] [spellcheck] {min-height:${e}px;}
.protyle-wysiwyg [data-node-id] {${window.siyuan.config.editor.rtl?" direction: rtl;":""}${window.siyuan.config.editor.justify?" text-align: justify;":""}}
.protyle-wysiwyg .li {min-height:${e+8}px}
.protyle-gutters button svg {height:${e}px}
.protyle-wysiwyg img.emoji, .b3-typography img.emoji {width:${e-8}px}
.protyle-wysiwyg .h1 img.emoji, .b3-typography h1 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.75*1.25)}px}
.protyle-wysiwyg .h2 img.emoji, .b3-typography h2 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.55*1.25)}px}
.protyle-wysiwyg .h3 img.emoji, .b3-typography h3 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.38*1.25)}px}
.protyle-wysiwyg .h4 img.emoji, .b3-typography h4 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25*1.25)}px}
.protyle-wysiwyg .h5 img.emoji, .b3-typography h5 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.13*1.25)}px}
.protyle-wysiwyg .h6 img.emoji, .b3-typography h6 img.emoji {width:${Math.floor(window.siyuan.config.editor.fontSize*1.25)}px}`;if(window.siyuan.config.editor.fontFamily&&(n+=`
.b3-typography:not(.b3-typography--default), .protyle-wysiwyg, .protyle-title {font-family: "${window.siyuan.config.editor.fontFamily}", var(--b3-font-family-protyle)}`),"ontouchend"in document&&(n+=`
.b3-menu .b3-menu__action {opacity: 0.68;}`),t){const a=document.getElementById("siyuanStyle");a?a.innerHTML=n:document.querySelector("#pluginsStyle").insertAdjacentHTML("beforebegin",`<style id="siyuanStyle">${n}</style>`)}return n},Ug=(t=p.Constants.PROTYLE_CDN)=>{const e=document.getElementById("protyleHljsStyle");let n;window.siyuan.config.appearance.mode===0?(n=window.siyuan.config.appearance.codeBlockThemeLight,p.Constants.SIYUAN_CONFIG_APPEARANCE_LIGHT_CODE.includes(n)||(n="default")):(n=window.siyuan.config.appearance.codeBlockThemeDark,p.Constants.SIYUAN_CONFIG_APPEARANCE_DARK_CODE.includes(n)||(n="github-dark"));const a=`${t}/js/highlight.js/styles/${n}.min.css?v=11.5.0`;e?e.href.includes(a)||(e.remove(),mi(a,"protyleHljsStyle")):mi(a,"protyleHljsStyle")},Jd=t=>{w("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{mode:t===2?window.siyuan.config.appearance.mode:t,modeOS:t===2}),e=>{if(window.siyuan.config.appearance.themeJS){if(!e.data.modeOS&&(e.data.mode!==window.siyuan.config.appearance.mode||window.siyuan.config.appearance.themeLight!==e.data.themeLight||window.siyuan.config.appearance.themeDark!==e.data.themeDark)){It({cb(){window.location.reload()},errorExit:!1});return}const n=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";if(e.data.modeOS&&(e.data.mode===1&&n==="light"||e.data.mode===0&&n==="dark")){It({cb(){window.location.reload()},errorExit:!1});return}}tt.onSetappearance(e.data)})},Wg=t=>{(Bt()||at())&&setTimeout(()=>{const e=getComputedStyle(document.body).getPropertyValue("--b3-theme-background").trim();let n=window.siyuan.config.appearance.mode;window.siyuan.config.appearance.modeOS&&(t==="dark"?n=1:n=0),Bt()?window.webkit.messageHandlers.changeStatusBar.postMessage((e||(n===0?"#fff":"#1e1e1e"))+" "+n):at()&&window.JSAndroid.changeStatusBarColor(e,n)},500)},Vg=()=>{const t=window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";return window.siyuan.config.appearance.modeOS?t:window.siyuan.config.appearance.mode===0?"light":"dark"},qe=(t,e=p.Constants.PROTYLE_CDN)=>{let n,a=!1;t.classList.contains("code-block")?n=t.querySelectorAll("[spellcheck]"):t.classList.contains("item__readme")?(n=t.querySelectorAll("pre code"),n.forEach(i=>{i.parentElement.setAttribute("lineNumber","false")})):t.classList.contains("b3-typography")?(n=t.querySelectorAll(".code-block code"),a=!0):n=t.querySelectorAll(".code-block [spellcheck]"),n.length!==0&&(Ug(e),(0,ze.addScript)(`${e}/js/highlight.js/highlight.min.js?v=11.7.0`,"protyleHljsScript").then(()=>{(0,ze.addScript)(`${e}/js/highlight.js/third-languages.js?v=1.0.1`,"protyleHljsThirdScript").then(()=>{n.forEach(i=>{const s=i.parentElement.querySelectorAll(".protyle-icon");if(s.length===2&&(s[0].setAttribute("aria-label",window.siyuan.languages.copy),s[1].setAttribute("aria-label",window.siyuan.languages.more)),i.getAttribute("data-render")==="true")return;const o=i.querySelector("wbr");let l=0;if(o){let h=o.previousSibling;for(;h;){for(l+=h.textContent.length;!h.previousSibling&&h.parentElement.tagName!=="DIV";)h=h.parentElement;h=h.previousSibling}o.remove()}let r;a?r=i.parentElement.getAttribute("data-language"):i.previousElementSibling?r=i.previousElementSibling.firstElementChild.textContent:r=i.className.replace("language-",""),window.hljs.getLanguage(r)||(r="plaintext"),i.classList.add("hljs"),i.setAttribute("data-render","true");const c=i.parentElement.getAttribute("linewrap"),d=i.parentElement.getAttribute("ligatures"),u=i.parentElement.getAttribute("linenumber");c==="true"||c!=="false"&&window.siyuan.config.editor.codeLineWrap?(i.style.setProperty("white-space","pre-wrap"),i.style.setProperty("word-break","break-all")):(i.style.setProperty("white-space","pre"),i.style.setProperty("word-break","initial")),d==="true"||d!=="false"&&window.siyuan.config.editor.codeLigatures?i.style.fontVariantLigatures="normal":i.style.fontVariantLigatures="none";const f=i.parentElement.querySelector(".protyle-action__language");!a&&(u==="true"||u!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum)?(i.classList.add("protyle-linenumber"),So(i),f&&(f.style.marginLeft="3.6em")):i.nextElementSibling?.classList.contains("protyle-linenumber__rows")&&(i.classList.remove("protyle-linenumber"),i.nextElementSibling.remove(),f&&(f.style.marginLeft=""));const g=A(i,"search__layout",!0);if(g&&i.parentElement.getAttribute("data-node-id")===g.querySelector("#searchList > .b3-list-item--focus")?.getAttribute("data-node-id")){const h=i.querySelector('span[data-type="search-mark"]');h&&h.scrollIntoView()}i.innerHTML=window.hljs.highlight(i.textContent+(i.textContent.endsWith(`
`)?"":`
`),{language:r,ignoreIllegals:!0}).value,o&&getSelection().rangeCount>0&&Gn(i,l,l)})})}))},So=t=>{if(t.parentElement.getAttribute("lineNumber")==="false")return;t.classList.add("protyle-linenumber"),t.parentElement.style.lineHeight=`${((parseInt(t.parentElement.style.fontSize)||window.siyuan.config.editor.fontSize)*1.625*.85).toFixed(0)}px`;const e=document.createElement("div");e.className="hljs protyle-linenumber",e.setAttribute("style",`box-sizing: border-box;width: calc(100% - 3.6em);position: absolute;padding-top:0 !important;padding-bottom:0 !important;min-height:auto !important;white-space:${t.style.whiteSpace};word-break:${t.style.wordBreak};font-variant-ligatures:${t.style.fontVariantLigatures};`),e.setAttribute("contenteditable","true"),t.insertAdjacentElement("afterend",e);let n="";const a=t.textContent.split(/\r\n|\r|\n|\u2028|\u2029/g);a[a.length-1]===""&&a.length>1&&a.pop();const i=t.style.wordBreak==="break-all";a.map(s=>{let o="";i&&(e.textContent=s||`
`,o=` style="height:${e.clientHeight}px;"`),n+=`<span${o}></span>`}),e.remove(),t.nextElementSibling?.classList.contains("protyle-linenumber__rows")?t.nextElementSibling.innerHTML=n:t.insertAdjacentHTML("afterend",`<span contenteditable="false" class="protyle-linenumber__rows">${n}</span>`)},dr=(t,e)=>{M(`${window.siyuan.languages.exported} ${we(t)}
<div class="fn__space"></div>
<button class="b3-button b3-button--white">${window.siyuan.languages.showInFolder}</button>`,6e3,"info",e),document.querySelector(`#message [data-id="${e}"] button`).addEventListener("click",()=>{Qn(kt.join(t)),W(e)})},g_=t=>{const e=new me({title:window.siyuan.languages.exportAsImage,content:`<div class="b3-dialog__content" style="${(0,I.tq)()?"padding:8px;":""};background-color: var(--b3-theme-background)">
    <div style="${(0,I.tq)()?"padding: 16px;margin: 8px 0":"padding: 48px;margin: 8px 0"};" class="export-img">
        <div class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}"></div>
        <div class="export-img__watermark"></div>
    </div>
</div>
<div class="b3-dialog__action">
    <label class="fn__flex">
        ${window.siyuan.languages.exportPDF5}
        <span class="fn__space"></span>
        <input id="keepFold" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[p.Constants.LOCAL_EXPORTIMG].keepFold?"checked":""}>
    </label>
    <label class="fn__flex" style="margin-left: 24px">
        ${window.siyuan.languages.export9}
        <span class="fn__space"></span>
        <input id="watermark" class="b3-switch fn__flex-center" type="checkbox" ${window.siyuan.storage[p.Constants.LOCAL_EXPORTIMG].watermark?"checked":""}>
    </label>
    <span class="fn__flex-1"></span>
    <button disabled class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button disabled class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>
 <div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>`,width:(0,I.tq)()?"92vw":"990px",height:"70vh"}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{const r=M(window.siyuan.languages.exporting,0);e.element.querySelector(".b3-dialog__container").style.height="",pe(p.Constants.LOCAL_EXPORTIMG,window.siyuan.storage[p.Constants.LOCAL_EXPORTIMG]),setTimeout(()=>{(0,ze.addScript)("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(e.element.querySelector(".b3-dialog__content"),{useCORS:!0}).then(c=>{c.toBlob(d=>{const u=new FormData;u.append("file",d,n[1].getAttribute("data-title")),u.append("type","image/png"),w("/api/export/exportAsFile",u,f=>{Ee(f.data.file)}),W(r),e.destroy()})})})},p.Constants.TIMEOUT_LOAD)});const a=e.element.querySelector(".protyle-wysiwyg"),i=e.element.querySelector("#keepFold");i.addEventListener("change",()=>{n[0].setAttribute("disabled","disabled"),n[1].setAttribute("disabled","disabled"),n[1].parentElement.insertAdjacentHTML("afterend",'<div class="fn__loading"><img height="128px" width="128px" src="stage/loading-pure.svg"></div>'),window.siyuan.storage[p.Constants.LOCAL_EXPORTIMG].keepFold=i.checked,w("/api/export/exportPreviewHTML",{id:t,keepFold:i.checked,image:!0},r=>{l(r)})});const s=e.element.querySelector("#watermark");s.addEventListener("change",()=>{window.siyuan.storage[p.Constants.LOCAL_EXPORTIMG].watermark=s.checked,s.checked&&!Ea()&&(s.checked=!1,M(window.siyuan.languages._kernel[214])),o()});const o=()=>{if(!Ea())return;const r=e.element.querySelector(".export-img__watermark");r.innerHTML="",s.checked?window.siyuan.config.export.imageWatermarkDesc?r.innerHTML=window.siyuan.config.export.imageWatermarkDesc:window.siyuan.config.export.imageWatermarkStr&&(window.siyuan.config.export.imageWatermarkStr.startsWith("http")?r.setAttribute("style",`background-image: url(${window.siyuan.config.export.imageWatermarkStr});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`):(0,ze.addScript)("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{const c=Math.max(e.element.querySelector(".export-img").clientWidth/3,150);r.setAttribute("style",`width: ${c}px;height: ${c}px;display: flex;justify-content: center;align-items: center;color: var(--b3-border-color);font-size: 14px;`),r.innerHTML=`<div style="transform: rotate(-45deg)">${window.siyuan.config.export.imageWatermarkStr}</div>`,window.html2canvas(r,{useCORS:!0,scale:1}).then(d=>{r.innerHTML="",r.setAttribute("style",`background-image: url(${d.toDataURL("image/png")});background-repeat: repeat;position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: var(--b3-border-radius-b);`)})})):r.removeAttribute("style")},l=r=>{a.innerHTML=r.data.content,a.querySelectorAll('[data-type~="mark"], [data-type~="u"], [data-type~="text"], [data-type~="code"], [data-type~="tag"], [data-type~="kbd"]').forEach(c=>{c.childNodes.forEach(d=>{let u="";Array.from(d.textContent).forEach(g=>{u+=`<span style="${c.getAttribute("style")||""};border-radius: 0;padding-left: 0;padding-right: 0;box-shadow: none;border-left:0;border-right:0;border-top:0" data-type="${c.getAttribute("data-type")}">${g}</span>`});const f=document.createElement("template");f.innerHTML=u,d.after(f.content),d.remove()}),c.childNodes.length>0&&(c.setAttribute("style",""),c.setAttribute("data-type",c.getAttribute("data-type").replace(/mark|u|text|code|tag|kbd/g,"")))}),a.setAttribute("data-doc-type",r.data.type||"NodeDocument"),r.data.attrs.memo&&a.setAttribute("memo",r.data.attrs.memo),r.data.attrs.name&&a.setAttribute("name",r.data.attrs.name),r.data.attrs.bookmark&&a.setAttribute("bookmark",r.data.attrs.bookmark),r.data.attrs.alias&&a.setAttribute("alias",r.data.attrs.alias),bt(a),qe(a),a.querySelectorAll("table").forEach(c=>{c.clientWidth>c.parentElement.clientWidth&&(c.setAttribute("style",`margin-bottom:${c.parentElement.clientWidth*c.clientHeight/c.clientWidth-c.parentElement.clientHeight+1}px;transform: scale(${c.parentElement.clientWidth/c.clientWidth});transform-origin: top left;`),c.parentElement.style.overflow="hidden")}),a.querySelectorAll(".li > .protyle-action > svg").forEach(c=>{const d=c.firstElementChild.getAttribute("xlink:href"),u=document.querySelectorAll(d);let f="0 0 32 32";d==="#iconDot"&&(f="0 0 20 20"),c.setAttribute("viewBox",f),c.innerHTML=u[u.length-1].innerHTML}),a.querySelectorAll(".img img").forEach(c=>{c.src.endsWith(".svg")&&Iu(c.src,d=>{c.src=`data:image/svg+xml;base64,${btoa(unescape(encodeURIComponent(d)))}`})}),o(),n[0].removeAttribute("disabled"),n[1].removeAttribute("disabled"),e.element.querySelector(".fn__loading").remove()};w("/api/export/exportPreviewHTML",{id:t,keepFold:i.checked,image:!0},r=>{l(r),n[1].setAttribute("data-title",r.data.name+".png")})},ur=t=>{if(t.type==="pdf")window.siyuan.config.appearance.mode===1?Ne(window.siyuan.languages.pdfTip,window.siyuan.languages.pdfConfirm,()=>{Yg(t.id)}):Yg(t.id);else if(t.type==="word"){const e=window.siyuan.storage[p.Constants.LOCAL_EXPORTWORD],n=new me({title:"Word "+window.siyuan.languages.config,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <div class="fn__flex-1">
            ${window.siyuan.languages.removeAssetsFolder}
        </div>
        <span class="fn__space"></span>
        <input id="removeAssets" class="b3-switch" type="checkbox" ${e.removeAssets?"checked":""}>
    </label>
    <label class="fn__flex b3-label">
        <div class="fn__flex-1">
            ${window.siyuan.languages.mergeSubdocs}
        </div>
        <span class="fn__space"></span>
        <input id="mergeSubdocs" class="b3-switch" type="checkbox" ${e.mergeSubdocs?"checked":""}>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"}),a=n.element.querySelectorAll(".b3-button");a[0].addEventListener("click",()=>{n.destroy()}),a[1].addEventListener("click",()=>{const i=n.element.querySelector("#removeAssets").checked,s=n.element.querySelector("#mergeSubdocs").checked;window.siyuan.storage[p.Constants.LOCAL_EXPORTWORD]={removeAssets:i,mergeSubdocs:s},pe(p.Constants.LOCAL_EXPORTWORD,window.siyuan.storage[p.Constants.LOCAL_EXPORTWORD]),Gg(t,i,s),n.destroy()})}else Gg(t)},zg=()=>{let t="";return document.querySelectorAll("style").forEach(e=>{e.id.startsWith("snippet")&&(t+=e.innerHTML)}),t},Yg=t=>{const e=window.siyuan.storage[p.Constants.LOCAL_EXPORTPDF],n=window.location.protocol+"//"+window.location.host,a=window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark==="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight==="daylight";let i="";a||(i=`<link rel="stylesheet" type="text/css" id="themeStyle" href="${n}/appearance/themes/${window.siyuan.config.appearance.themeLight}/theme.css?${p.Constants.SIYUAN_VERSION}"/>`);const s=`<!DOCTYPE html>
<html lang="${window.siyuan.config.appearance.lang}" data-theme-mode="light" data-light-theme="${window.siyuan.config.appearance.themeLight}" data-dark-theme="${window.siyuan.config.appearance.themeDark}">
<head>
    <base href="${n}/">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" id="baseStyle" href="${n}/stage/build/export/base.css?${p.Constants.SIYUAN_VERSION}"/>
    <link rel="stylesheet" type="text/css" id="themeDefaultStyle" href="${n}/appearance/themes/daylight/theme.css?${p.Constants.SIYUAN_VERSION}"/>
    ${i}
    <title>${window.siyuan.languages.export} PDF</title>
    <style>
        body {
          margin: 0;
          font-family: var(--b3-font-family);
        }
        
        #action {
          width: 200px;
          background: var(--b3-theme-surface);
          padding: 16px;
          position: fixed;
          right: 0;
          top: 0;
          overflow-y: auto;
          bottom: 0;
          overflow-x: hidden;
          z-index: 1;
        }
        
        #preview {
          max-width: 800px;
          margin: 0 auto;
          position: absolute;
          right: 232px;
          left: 0;
        }
        
        #preview.exporting {
          position: inherit;
          max-width: none;
        }
        
        .b3-switch {
            margin-left: 14px;
        }
        
        .exporting::-webkit-scrollbar {
          width: 0;
          height: 0;
        }
        
        .protyle-wysiwyg {
          height: 100%;
          overflow: auto;
          box-sizing: border-box;
        }
        
        .b3-label {
          border-bottom: 1px solid var(--b3-theme-surface-lighter);
          display: block;
          color: var(--b3-theme-on-surface);
          padding-bottom: 12px;
          margin-bottom: 12px;
        }
        ${ko(!1)}
        ${document.getElementById("pluginsStyle").innerHTML}
        ${zg()}
    </style>
</head>
<body>
<div id="action">
    <div class="b3-label">
        <div>
            ${window.siyuan.languages.exportPDF0}
        </div>
        <span class="fn__hr"></span>
        <select class="b3-select" id="pageSize">
            <option ${e.pageSize==="A3"?"selected":""} value="A3">A3</option>
            <option ${e.pageSize==="A4"?"selected":""} value="A4">A4</option>
            <option ${e.pageSize==="A5"?"selected":""} value="A5">A5</option>
            <option ${e.pageSize==="Legal"?"selected":""} value="Legal">Legal</option>
            <option ${e.pageSize==="Letter"?"selected":""} value="Letter">Letter</option>
            <option ${e.pageSize==="Tabloid"?"selected":""} value="Tabloid">Tabloid</option>
        </select>
    </div>
    <div class="b3-label">
        <div>
            ${window.siyuan.languages.exportPDF2}
        </div>
        <span class="fn__hr"></span>
        <select class="b3-select" id="marginsType">
            <option ${e.marginType==="default"?"selected":""} value="default">${window.siyuan.languages.defaultMargin}</option>
            <option ${e.marginType==="none"?"selected":""} value="none">${window.siyuan.languages.noneMargin}</option>
            <option ${e.marginType==="printableArea"?"selected":""} value="printableArea">${window.siyuan.languages.minimalMargin}</option>
            <option ${e.marginType==="custom"?"selected":""} value="custom">${window.siyuan.languages.customMargin}</option>
        </select>
        <div class="${e.marginType==="custom"?"":"fn__none"}">
            <span class="fn__hr"></span>
            <div>${window.siyuan.languages.marginTop}</div>
            <input id="marginsTop" class="b3-text-field fn__block" value="${e.marginTop||0}" type="number" min="0" step="0.01">
            <span class="fn__hr"></span>
            <div>${window.siyuan.languages.marginRight}</div>
            <input id="marginsRight" class="b3-text-field fn__block" value="${e.marginRight||0}" type="number" min="0" step="0.01">
            <span class="fn__hr"></span>
            <div>${window.siyuan.languages.marginBottom}</div>
            <input id="marginsBottom" class="b3-text-field fn__block" value="${e.marginBottom||0}" type="number" min="0" step="0.01">
            <span class="fn__hr"></span>
            <div>${window.siyuan.languages.marginLeft}</div>
            <input id="marginsLeft" class="b3-text-field fn__block" value="${e.marginLeft||0}" type="number" min="0" step="0.01">
        </div>
    </div>
    <div class="b3-label">
        <div>
            ${window.siyuan.languages.exportPDF3}
            <span id="scaleTip" style="float: right;color: var(--b3-theme-on-background);">${e.scale||1}</span>
        </div>
        <span class="fn__hr"></span>
        <input style="width: 192px" value="${e.scale||1}" id="scale" step="0.1" class="b3-slider" type="range" min="0.1" max="2">
    </div>
    <label class="b3-label">
        <div>
            ${window.siyuan.languages.exportPDF1}
        </div>
        <span class="fn__hr"></span>
      <input id="landscape" class="b3-switch" type="checkbox" ${e.landscape?"checked":""}>
    </label>
    <label class="b3-label">
        <div>
            ${window.siyuan.languages.exportPDF4}
        </div>
        <span class="fn__hr"></span>
        <input id="removeAssets" class="b3-switch" type="checkbox" ${e.removeAssets?"checked":""}>
    </label>
    <label class="b3-label">
        <div>
            ${window.siyuan.languages.exportPDF5}
        </div>
        <span class="fn__hr"></span>
        <input id="keepFold" class="b3-switch" type="checkbox" ${e.keepFold?"checked":""}>
    </label>
    <label class="b3-label">
        <div>
            ${window.siyuan.languages.mergeSubdocs}
        </div>
        <span class="fn__hr"></span>
        <input id="mergeSubdocs" class="b3-switch" type="checkbox" ${e.mergeSubdocs?"checked":""}>
    </label>
    <label class="b3-label">
        <div>
            ${window.siyuan.languages.export27}
        </div>
        <span class="fn__hr"></span>
        <input id="watermark" class="b3-switch" type="checkbox" ${e.watermark?"checked":""}>
        <div style="display:none;font-size: 12px;margin-top: 12px;color: var(--b3-theme-on-surface);">${window.siyuan.languages._kernel[214]}</div>
    </label>
    <div class="fn__flex">
      <div class="fn__flex-1"></div>
      <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
      <div class="fn__space"></div>
      <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
    </div>
</div>
<div style="zoom:${e.scale||1}" class="protyle-wysiwyg${window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":""}" 
id="preview">
    <div class="fn__loading" style="left:0"><img width="48px" src="${n}/stage/loading-pure.svg"></div>
</div>
<script src="${n}/appearance/icons/${window.siyuan.config.appearance.icon}/icon.js?${p.Constants.SIYUAN_VERSION}"><\/script>
<script src="${n}/stage/build/export/protyle-method.js?${p.Constants.SIYUAN_VERSION}"><\/script>
<script src="${n}/stage/protyle/js/lute/lute.min.js?${p.Constants.SIYUAN_VERSION}"><\/script>    
<script>
    const previewElement = document.getElementById('preview');
    const fixBlockWidth = () => {
        const isLandscape = document.querySelector("#landscape").checked;
        let width = 800
        switch (document.querySelector("#action #pageSize").value) {
            case "A3":
              width = isLandscape ? 1587.84 : 1122.24 
              break;
            case "A4":
              width = isLandscape ? 1122.24 : 793.92
              break;
            case "A5":
              width = isLandscape ? 793.92 : 559.68
              break;
            case "Legal":
              width = isLandscape ? 1344: 816 
              break;
            case "Letter":
              width = isLandscape ? 1056 : 816
              break;
            case "Tabloid":
              width = isLandscape ? 1632 : 1056
              break;
        }
        width = width / parseFloat(document.querySelector("#scale").value);
        previewElement.style.width = width + "px";
        width = width - parseFloat(previewElement.style.paddingLeft) * 96 * 2;
        // \u4E3A\u4FDD\u6301\u4EE3\u7801\u5757\u5BBD\u5EA6\u4E00\u81F4\uFF0C\u5168\u90E8\u90FD\u8FDB\u884C\u5BBD\u5EA6\u8BBE\u5B9A https://github.com/siyuan-note/siyuan/issues/7692 
        previewElement.querySelectorAll('.hljs').forEach((item) => {
            // \u5F3A\u5236\u6362\u884C https://ld246.com/article/1679228783553
            item.parentElement.setAttribute("linewrap", "true");
            item.parentElement.style.width = "";
            item.parentElement.style.width = Math.min(item.parentElement.clientWidth, width) + "px";
            item.removeAttribute('data-render');
        })
        Protyle.highlightRender(previewElement, "${n}/stage/protyle");
        previewElement.querySelectorAll('[data-type="NodeMathBlock"]').forEach((item) => {
            item.style.width = "";
            item.style.width = Math.min(item.clientWidth, width) + "px";
            item.removeAttribute('data-render');
        })
        Protyle.mathRender(previewElement, "${n}/stage/protyle", true);
        previewElement.querySelectorAll("table").forEach(item => {
            if (item.clientWidth > item.parentElement.clientWidth) {
                item.style.zoom = (item.parentElement.clientWidth / item.clientWidth).toFixed(2) - 0.01;
                item.parentElement.style.overflow = "hidden";
            }
        })
    }
    const setPadding = () => {
        const isLandscape = document.querySelector("#landscape").checked;
        const topElement = document.querySelector("#marginsTop")
        const rightElement = document.querySelector("#marginsRight")
        const bottomElement = document.querySelector("#marginsBottom")
        const leftElement = document.querySelector("#marginsLeft")
        switch (document.querySelector("#marginsType").value) {
            case "default":
                if (isLandscape) {
                    topElement.value = "0.42";
                    rightElement.value = "0.42";
                    bottomElement.value = "0.42";
                    leftElement.value = "0.42";
                } else {
                    topElement.value = "1";
                    rightElement.value = "0.54";
                    bottomElement.value = "1";
                    leftElement.value = "0.54";
                }
                break;
            case "none": // none
                topElement.value = "0";
                rightElement.value = "0";
                bottomElement.value = "0";
                leftElement.value = "0";
                break;
            case "printableArea": // minimal
                if (isLandscape) {
                    topElement.value = ".07";
                    rightElement.value = ".07";
                    bottomElement.value = ".07";
                    leftElement.value = ".07";
                } else {
                    topElement.value = "0.58";
                    rightElement.value = "0.1";
                    bottomElement.value = "0.58";
                    leftElement.value = "0.1";
                }
                break;
        }
        document.getElementById('preview').style.padding = topElement.value + "in " 
                             + rightElement.value + "in "
                             + bottomElement.value + "in "
                             + leftElement.value + "in";
        setTimeout(() => {
            fixBlockWidth();
        }, 300);
    }
    const fetchPost = (url, data, cb) => {
        fetch("${n}" + url, {
            method: "POST",
            body: JSON.stringify(data)
        }).then((response) => {
            return response.json();
        }).then((response) => {
            cb(response);
        })
    }
    const renderPreview = (data) => {
        previewElement.innerHTML = data.content;
        previewElement.setAttribute("data-doc-type", data.type || "NodeDocument");
        if (data.attrs.memo) {
            previewElement.setAttribute("memo", data.attrs.memo);
        }
        if (data.attrs.name) {
            previewElement.setAttribute("name", data.attrs.name);
        }
        if (data.attrs.bookmark) {
            previewElement.setAttribute("bookmark", data.attrs.bookmark);
        }
        if (data.attrs.alias) {
            previewElement.setAttribute("alias", data.attrs.alias);
        }
        Protyle.mermaidRender(previewElement, "${n}/stage/protyle");
        Protyle.flowchartRender(previewElement, "${n}/stage/protyle");
        Protyle.graphvizRender(previewElement, "${n}/stage/protyle");
        Protyle.chartRender(previewElement, "${n}/stage/protyle");
        Protyle.mindmapRender(previewElement, "${n}/stage/protyle");
        Protyle.abcRender(previewElement, "${n}/stage/protyle");
        Protyle.htmlRender(previewElement);
        Protyle.plantumlRender(previewElement, "${n}/stage/protyle");
    }
    fetchPost("/api/export/exportPreviewHTML", {
        id: "${t}",
        keepFold: ${e.keepFold},
        merge: ${e.mergeSubdocs},
    }, response => {
        if (response.code === 1) {
            alert(response.msg)
            return;
        }
        document.title = '${window.siyuan.languages.export} PDF - ' + response.data.name
        window.siyuan = {
          config: {
            appearance: { mode: 0, codeBlockThemeDark: "${window.siyuan.config.appearance.codeBlockThemeDark}", codeBlockThemeLight: "${window.siyuan.config.appearance.codeBlockThemeLight}" },
            editor: { 
              fontSize: ${window.siyuan.config.editor.fontSize},
              codeLineWrap: true,
              codeLigatures: ${window.siyuan.config.editor.codeLigatures},
              plantUMLServePath: "${window.siyuan.config.editor.plantUMLServePath}",
              codeSyntaxHighlightLineNum: ${window.siyuan.config.editor.codeSyntaxHighlightLineNum},
              katexMacros: JSON.stringify(${window.siyuan.config.editor.katexMacros}),
            }
          },
          languages: {copy:"${window.siyuan.languages.copy}"}
        };
        previewElement.addEventListener("click", (event) => {
            let target = event.target;
            while (target && !target.isEqualNode(previewElement)) {
                if (target.tagName === "A") {
                    const linkAddress = target.getAttribute("href");
                    if (linkAddress.startsWith("#")) {
                        // \u5BFC\u51FA\u9884\u89C8\u6A21\u5F0F\u70B9\u51FB\u5757\u5F15\u8F6C\u6362\u540E\u7684\u811A\u6CE8\u8DF3\u8F6C\u4E0D\u6B63\u786E https://github.com/siyuan-note/siyuan/issues/5700
                        previewElement.querySelector(linkAddress).scrollIntoView();
                        event.stopPropagation();
                        event.preventDefault();
                        return;
                    }
                } else if (target.classList.contains("protyle-action__copy")) {
                    let text = target.parentElement.nextElementSibling.textContent.trimEnd();
                    text = text.replace(/\xA0/g, " "); // Replace non-breaking spaces with normal spaces when copying https://github.com/siyuan-note/siyuan/issues/9382
                    navigator.clipboard.writeText(text);
                    event.preventDefault();
                    event.stopPropagation();
                    break;
                }
                target = target.parentElement;
            }
        });
        const actionElement = document.getElementById('action');
        const keepFoldElement = actionElement.querySelector('#keepFold');
        keepFoldElement.addEventListener('change', () => {
            refreshPreview();
        });
        const mergeSubdocsElement = actionElement.querySelector('#mergeSubdocs');
        mergeSubdocsElement.addEventListener('change', () => {
            refreshPreview();
        });
        const  watermarkElement = actionElement.querySelector('#watermark');
        watermarkElement.addEventListener('change', () => {
            if (watermarkElement.checked && ${!Ea()}) {
                watermarkElement.nextElementSibling.style.display = "";
                watermarkElement.checked = false;
            }
        });
        const refreshPreview = () => {
          previewElement.innerHTML = '<div class="fn__loading" style="left:0"><img width="48px" src="${n}/stage/loading-pure.svg"></div>'
            fetchPost("/api/export/exportPreviewHTML", {
                id: "${t}",
                keepFold: keepFoldElement.checked,
                merge: mergeSubdocsElement.checked,
            }, response2 => {
                if (response2.code === 1) {
                    alert(response2.msg)
                    return;
                }
                setPadding();
                renderPreview(response2.data);
            })
        };
        
        actionElement.querySelector("#scale").addEventListener("input", () => {
            const scale = actionElement.querySelector("#scale").value;
            actionElement.querySelector("#scaleTip").innerText = scale;
            previewElement.style.zoom = scale;
            fixBlockWidth();
        })
        actionElement.querySelector("#pageSize").addEventListener('change', () => {
            fixBlockWidth();
        });
        actionElement.querySelector("#marginsType").addEventListener('change', (event) => {
            setPadding();
            if (event.target.value === "custom") {
                event.target.nextElementSibling.classList.remove("fn__none");
            } else {
                event.target.nextElementSibling.classList.add("fn__none");
            }
        });
        actionElement.querySelector("#marginsTop").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector("#marginsRight").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector("#marginsBottom").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector("#marginsLeft").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector("#landscape").addEventListener('change', () => {
            setPadding();
        });
        actionElement.querySelector('.b3-button--cancel').addEventListener('click', () => {
            const {ipcRenderer}  = require("electron");
            ipcRenderer.send("${p.Constants.SIYUAN_CMD}", "destroy")
        });
        actionElement.querySelector('.b3-button--text').addEventListener('click', () => {
            const {ipcRenderer}  = require("electron");
            ipcRenderer.send("${p.Constants.SIYUAN_EXPORT_PDF}", {
              title: "${window.siyuan.languages.export} PDF",
              pdfOptions:{
                printBackground: true,
                landscape: actionElement.querySelector("#landscape").checked,
                marginType: actionElement.querySelector("#marginsType").value,
                margins: {
                  top: parseFloat(document.querySelector("#marginsTop").value),
                  bottom: parseFloat(document.querySelector("#marginsBottom").value),
                  left: parseFloat(document.querySelector("#marginsLeft").value),
                  right: parseFloat(document.querySelector("#marginsRight").value),
                },
                scale:  parseFloat(actionElement.querySelector("#scale").value),
                pageSize: actionElement.querySelector("#pageSize").value,
              },
              keepFold: keepFoldElement.checked,
              mergeSubdocs: mergeSubdocsElement.checked,
              watermark: watermarkElement.checked,
              removeAssets: actionElement.querySelector("#removeAssets").checked,
              rootId: "${t}",
              rootTitle: response.data.name,
            })
            previewElement.classList.add("exporting");
            previewElement.style.zoom = "";
            previewElement.style.paddingTop = "6px";
            previewElement.style.paddingBottom = "0";
            fixBlockWidth();
            actionElement.remove();
        });
        setPadding();
        renderPreview(response.data);
    });
<\/script></body></html>`;w("/api/export/exportTempContent",{content:s},o=>{te.ipcRenderer.send(p.Constants.SIYUAN_EXPORT_NEWWINDOW,o.data.url)})},Gg=(t,e,n)=>{w("/api/block/getBlockInfo",{id:t.id},async a=>{if(a.code===3){M(a.msg);return}let i="HTML (SiYuan)";switch(t.type){case"htmlmd":i="HTML (Markdown)";break;case"word":i="Word .docx";break;case"pdf":i="PDF";break}const s=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"showOpenDialog",title:window.siyuan.languages.export+" "+i,properties:["createDirectory","openDirectory"]});if(!s.canceled){const o=M(window.siyuan.languages.exporting,-1);let l="/api/export/exportHTML";t.type==="htmlmd"?l="/api/export/exportMdHTML":t.type==="word"&&(l="/api/export/exportDocx");let r=s.filePaths[0];t.type!=="word"&&!r.endsWith(a.data.rootTitle)&&(r=kt.join(r,ad(a.data.rootTitle))),r=r.trim(),w(l,{id:t.id,pdf:t.type==="pdf",removeAssets:e,merge:n,savePath:r},c=>{if(t.type==="word"){if(c.code===1){M(c.msg,void 0,"error"),W(o);return}dr(kt.join(r,ad(a.data.rootTitle))+".docx",o)}else h_(c,r,t,e,o)})}})},h_=(t,e,n,a,i)=>{let s=window.siyuan.config.appearance.themeLight,o=0;["html","htmlmd"].includes(n.type)&&window.siyuan.config.appearance.mode===1&&(s=window.siyuan.config.appearance.themeDark,o=1);const l=window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark==="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight==="daylight";let r="";l||(r=`<link rel="stylesheet" type="text/css" id="themeStyle" href="appearance/themes/${s}/theme.css?${p.Constants.SIYUAN_VERSION}"/>`);const c=`<!DOCTYPE html>
<html lang="${window.siyuan.config.appearance.lang}" data-theme-mode="${Vg()}" data-light-theme="${window.siyuan.config.appearance.themeLight}" data-dark-theme="${window.siyuan.config.appearance.themeDark}">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes"/>
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" type="text/css" id="baseStyle" href="stage/build/export/base.css?${p.Constants.SIYUAN_VERSION}"/>
    <link rel="stylesheet" type="text/css" id="themeDefaultStyle" href="appearance/themes/${s}/theme.css?${p.Constants.SIYUAN_VERSION}"/>
    ${r}
    <title>${Le().basename(e)} - ${window.siyuan.languages.siyuanNote}  v${p.Constants.SIYUAN_VERSION}</title>
    <style>
        body {font-family: var(--b3-font-family);background-color: var(--b3-theme-background);color: var(--b3-theme-on-background)}
        ${ko(!1)}
        ${document.getElementById("pluginsStyle").innerHTML}
        ${zg()}
    </style>
</head>
<body>
<div class="${["htmlmd","word"].includes(n.type)?"b3-typography":"protyle-wysiwyg"+(window.siyuan.config.editor.displayBookmarkIcon?" protyle-wysiwyg--attr":"")}" 
style="max-width: 800px;margin: 0 auto;" 
id="preview">${t.data.content}</div>
<script src="appearance/icons/${window.siyuan.config.appearance.icon}/icon.js?${p.Constants.SIYUAN_VERSION}"><\/script>
<script src="stage/build/export/protyle-method.js?${p.Constants.SIYUAN_VERSION}"><\/script>
<script src="stage/protyle/js/lute/lute.min.js?${p.Constants.SIYUAN_VERSION}"><\/script>    
<script>
    window.siyuan = {
      config: {
        appearance: { mode: ${o}, codeBlockThemeDark: "${window.siyuan.config.appearance.codeBlockThemeDark}", codeBlockThemeLight: "${window.siyuan.config.appearance.codeBlockThemeLight}" },
        editor: { 
          codeLineWrap: true,
          fontSize: ${window.siyuan.config.editor.fontSize},
          codeLigatures: ${window.siyuan.config.editor.codeLigatures},
          plantUMLServePath: "${window.siyuan.config.editor.plantUMLServePath}",
          codeSyntaxHighlightLineNum: ${window.siyuan.config.editor.codeSyntaxHighlightLineNum},
          katexMacros: JSON.stringify(${window.siyuan.config.editor.katexMacros}),
        }
      },
      languages: {copy:"${window.siyuan.languages.copy}"}
    };
    const previewElement = document.getElementById('preview');
    Protyle.highlightRender(previewElement, "stage/protyle");
    Protyle.mathRender(previewElement, "stage/protyle", ${n.type==="pdf"});
    Protyle.mermaidRender(previewElement, "stage/protyle");
    Protyle.flowchartRender(previewElement, "stage/protyle");
    Protyle.graphvizRender(previewElement, "stage/protyle");
    Protyle.chartRender(previewElement, "stage/protyle");
    Protyle.mindmapRender(previewElement, "stage/protyle");
    Protyle.abcRender(previewElement, "stage/protyle");
    Protyle.htmlRender(previewElement);
    Protyle.plantumlRender(previewElement, "stage/protyle");
    document.querySelectorAll(".protyle-action__copy").forEach((item) => {
      item.addEventListener("click", (event) => {
            let text = item.parentElement.nextElementSibling.textContent.trimEnd();
            text = text.replace(/\xA0/g, " "); // Replace non-breaking spaces with normal spaces when copying
            navigator.clipboard.writeText(text);
            event.preventDefault();
            event.stopPropagation();
      })
    });
<\/script></body></html>`,d=kt.join(e,"index.html");ts.writeFileSync(d,c),dr(d,i)},jg=(t,e)=>{t.addEventListener("change",()=>{w("/api/attr/setBlockAttrs",{id:e,attrs:{[t.dataset.name]:t.value}})})},m_=t=>{const e=t.getAttribute("data-node-id"),n=re(t),a=t.getAttribute(p.Constants.CUSTOM_REMINDER_WECHAT);let i="";a&&(i=Q(a).format("YYYY-MM-DD HH:mm"));const s=new me({width:(0,I.tq)()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${i}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,destroyCallback(){Z(n)}}),o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{o[1].getAttribute("disabled")||(o[1].setAttribute("disabled","disabled"),w("/api/block/setBlockReminder",{id:e,timed:"0"},()=>{t.removeAttribute(p.Constants.CUSTOM_REMINDER_WECHAT),s.destroy()}))}),o[2].addEventListener("click",()=>{const l=s.element.querySelector("input").value;if(l){if(new Date(l)<=new Date){M(window.siyuan.languages.reminderTip);return}if(o[2].getAttribute("disabled"))return;o[2].setAttribute("disabled","disabled");const r=Q(l).format("YYYYMMDDHHmmss");w("/api/block/setBlockReminder",{id:e,timed:r},()=>{t.setAttribute(p.Constants.CUSTOM_REMINDER_WECHAT,r),s.destroy()})}else M(window.siyuan.languages.notEmpty)})},b_=t=>{w("/api/block/getDocInfo",{id:t.block.rootID},e=>{const n=e.data.ial[p.Constants.CUSTOM_REMINDER_WECHAT];let a="";n&&(a=Q(n).format("YYYY-MM-DD HH:mm"));const i=new me({width:(0,I.tq)()?"92vw":"50vw",title:window.siyuan.languages.wechatReminder,content:`<div class="b3-dialog__content custom-attr">
    <div class="fn__flex">
        <span class="ft__on-surface fn__flex-center" style="text-align: right;white-space: nowrap;width: 100px">${window.siyuan.languages.notifyTime}</span>
        <div class="fn__space"></div>
        <input class="b3-text-field fn__flex-1" type="datetime-local" max="9999-12-31 23:59" value="${a}">
    </div>
    <div class="b3-label__text" style="text-align: center">${window.siyuan.languages.wechatTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.remove}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`}),s=i.element.querySelectorAll(".b3-button");s[0].addEventListener("click",()=>{i.destroy()}),s[1].addEventListener("click",()=>{w("/api/block/setBlockReminder",{id:t.block.rootID,timed:"0"},()=>{i.destroy()})}),s[2].addEventListener("click",()=>{const o=i.element.querySelector("input").value;if(o){if(new Date(o)<=new Date){M(window.siyuan.languages.reminderTip);return}w("/api/block/setBlockReminder",{id:t.block.rootID,timed:Q(o).format("YYYYMMDDHHmmss")},()=>{i.destroy()})}else M(window.siyuan.languages.notEmpty)})})},Un=(t,e="bookmark",n)=>{let a="",i="",s=!1;const o=getSelection().rangeCount>0?getSelection().getRangeAt(0):null;Object.keys(t).forEach(r=>{p.Constants.CUSTOM_RIFF_DECKS===r||r.startsWith("custom-sy-")||(r===p.Constants.CUSTOM_REMINDER_WECHAT?i=`<label class="b3-label b3-label--noborder">
    ${window.siyuan.languages.wechatReminder}
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" type="datetime-local" max="9999-12-31 23:59" readonly data-name="${r}" value="${Q(t[r]).format("YYYY-MM-DD HH:mm")}">
</label>`:r.indexOf("custom-av")>-1?s=!0:r.indexOf("custom")>-1&&(a+=`<label class="b3-label b3-label--noborder">
     <div class="fn__flex">
        <span class="fn__flex-1">${r.replace("custom-","")}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" rows="1" data-name="${r}">${t[r]}</textarea>
</label>`))});const l=new me({width:(0,I.tq)()?"92vw":"50vw",height:"80vh",content:`<div class="fn__flex-column">
    <div class="layout-tab-bar fn__flex" style="flex-shrink:0;border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0">
        <div class="item item--full item--focus" data-type="attr">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.builtIn}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full${s?"":" fn__none"}" data-type="NodeAttributeView">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.database}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="custom">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.custom}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="custom-attr" data-type="attr">
            <label class="b3-label b3-label--noborder">
                <div class="fn__flex">
                    <span class="fn__flex-1">${window.siyuan.languages.bookmark}</span>
                    <span data-action="bookmark" class="block__icon block__icon--show"><svg><use xlink:href="#iconDown"></use></svg></span>
                </div>
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrBookmarkTip}" data-name="bookmark">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.name}
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrNameTip}" data-name="name">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.alias}
                <div class="fn__hr"></div>
                <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrAliasTip}" data-name="alias">
            </label>
            <label class="b3-label b3-label--noborder">
                ${window.siyuan.languages.memo}
                <div class="fn__hr"></div>
                <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.attrMemoTip}" rows="2" data-name="memo">${t.memo||""}</textarea>
            </label>
            ${i}
        </div>
        <div data-type="NodeAttributeView" class="fn__none custom-attr"></div>
        <div data-type="custom" class="fn__none custom-attr">
           ${a}
           <div class="b3-label">
               <button data-action="addCustom" class="b3-button b3-button--outline">
                   <svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}
               </button>
           </div>
        </div>
    </div>
</div>`,destroyCallback(){Z(o)}});l.element.querySelector('.b3-text-field[data-name="bookmark"]').value=t.bookmark||"",l.element.querySelector('.b3-text-field[data-name="name"]').value=t.name||"",l.element.querySelector('.b3-text-field[data-name="alias"]').value=t.alias||"",l.element.addEventListener("click",r=>{let c=r.target;for(typeof r.detail=="string"&&(c=l.element.querySelector('.item--full[data-type="NodeAttributeView"]'));!c.isSameNode(l.element);){const d=c.dataset.action;if(c.classList.contains("item--full"))c.parentElement.querySelector(".item--focus").classList.remove("item--focus"),c.classList.add("item--focus"),l.element.querySelectorAll(".custom-attr").forEach(u=>{u.dataset.type===c.dataset.type?(u.dataset.type==="NodeAttributeView"&&u.innerHTML===""&&ty(u,t.id,n),u.classList.remove("fn__none")):u.classList.add("fn__none")});else if(d==="remove"){w("/api/attr/setBlockAttrs",{id:t.id,attrs:{["custom-"+c.previousElementSibling.textContent]:""}}),c.parentElement.parentElement.remove(),r.stopPropagation(),r.preventDefault();break}else if(d==="bookmark"){w("/api/attr/getBookmarkLabels",{},u=>{window.siyuan.menus.menu.remove(),u.data.length===0?window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.emptyContent,type:"readonly"}).element):u.data.forEach(f=>{window.siyuan.menus.menu.append(new S({label:f,click(){const g=c.parentElement.parentElement.querySelector("input");g.value=f,g.dispatchEvent(new CustomEvent("change"))}}).element)}),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),window.siyuan.menus.menu.popup({x:r.clientX,y:r.clientY+16,w:16})}),r.stopPropagation(),r.preventDefault();break}else if(d==="addCustom"){const u=new me({title:window.siyuan.languages.attrName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),f=u.element.querySelector("input"),g=u.element.querySelectorAll(".b3-button");u.bindInput(f,()=>{g[1].click()}),f.focus(),f.select(),g[0].addEventListener("click",()=>{u.destroy()}),g[1].addEventListener("click",()=>{if(!(0,I.vc)(f.value))return M(window.siyuan.languages.attrName+" <b>"+f.value+"</b> "+window.siyuan.languages.invalid),!1;c.parentElement.insertAdjacentHTML("beforebegin",`<div class="b3-label b3-label--noborder">
    <div class="fn__flex">
        <span class="fn__flex-1">${f.value}</span>
        <span data-action="remove" class="block__icon block__icon--show"><svg><use xlink:href="#iconMin"></use></svg></span>
    </div>
    <div class="fn__hr"></div>
    <textarea data-name="custom-${f.value}" class="b3-text-field fn__block" rows="1" placeholder="${window.siyuan.languages.attrValue1}"></textarea>
</div>`);const h=c.parentElement.previousElementSibling.querySelector(".b3-text-field");h.focus(),jg(h,t.id),u.destroy()}),r.stopPropagation(),r.preventDefault();break}c=c.parentElement}}),l.element.querySelectorAll(".b3-text-field").forEach(r=>{e!=="av"&&e===r.getAttribute("data-name")&&r.focus(),jg(r,t.id)}),e==="av"&&l.element.dispatchEvent(new CustomEvent("click",{detail:"av"}))},Ca=(t,e="bookmark",n)=>{if(t.getAttribute("data-type")==="NodeThematicBreak")return;const a=t.getAttribute("data-node-id");w("/api/attr/getBlockAttrs",{id:a},i=>{Un(i.data,e,n)})},Li=(t,e=!0,n)=>[{icon:"iconRef",accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockRef.custom:void 0,label:window.siyuan.languages.copyBlockRef,click:()=>{w("/api/block/getRefText",{id:t},a=>{G(`((${t} '${a.data}'))`)}),n&&le(n)}},{icon:"iconSQL",label:window.siyuan.languages.copyBlockEmbed,accelerator:e?window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom:void 0,click:()=>{G(`{{select * from blocks where id='${t}'}}`),n&&le(n)}},{icon:"iconSiYuan",label:window.siyuan.languages.copyProtocol,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocol.custom:void 0,click:()=>{G(`siyuan://blocks/${t}`),n&&le(n)}},{label:window.siyuan.languages.copyProtocolInMd,accelerator:e?window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom:void 0,click:()=>{w("/api/block/getRefText",{id:t},a=>{G(`[${a.data}](siyuan://blocks/${t})`)}),n&&le(n)}},{label:window.siyuan.languages.copyHPath,accelerator:e?window.siyuan.config.keymap.editor.general.copyHPath.custom:void 0,click:()=>{w("/api/filetree/getHPathByID",{id:t},a=>{G(a.data)})}},{label:window.siyuan.languages.copyID,accelerator:e?window.siyuan.config.keymap.editor.general.copyID.custom:void 0,click:()=>{G(t),n&&le(n)}}],Kg=t=>new S({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:window.siyuan.languages.template,iconClass:"ft__error",icon:"iconMarkdown",click:async()=>{const e=await lt("/api/block/getRefText",{id:t}),n=new me({title:window.siyuan.languages.fileName,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),a=n.element.querySelector("input"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()});let s=mn(e.data);const o=32;s.length>o&&(s=s.substring(0,o)),a.value=s,a.focus(),a.select(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{a.value.trim()===""?a.value="Untitled":a.value=mn(a.value),s.length>o&&(s=s.substring(0,o)),w("/api/template/docSaveAsTemplate",{id:t,name:a.value,overwrite:!1},l=>{if(l.code===1){Ne(window.siyuan.languages.export,window.siyuan.languages.exportTplTip,()=>{w("/api/template/docSaveAsTemplate",{id:t,name:a.value,overwrite:!0},r=>{r.code===0&&M(window.siyuan.languages.exportTplSucc)})});return}M(window.siyuan.languages.exportTplSucc)}),n.destroy()})}},{label:"Markdown",icon:"iconMarkdown",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportMd",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportSY",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:window.siyuan.languages.image,icon:"iconImage",click:()=>{g_(t)}},{label:"PDF",icon:"iconPDF",click:()=>{ur({type:"pdf",id:t})}},{label:"HTML (SiYuan)",iconClass:"ft__error",icon:"iconHTML5",click:()=>{ur({type:"html",id:t})}},{label:"HTML (Markdown)",icon:"iconHTML5",click:()=>{ur({type:"htmlmd",id:t})}},{label:"Word .docx",icon:"iconExact",click:()=>{ur({type:"word",id:t})}},{label:window.siyuan.languages.more,icon:"iconMore",type:"submenu",submenu:[{label:"reStructuredText",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportReStructuredText",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:"AsciiDoc",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportAsciiDoc",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:"Textile",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportTextile",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:"OPML",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportOPML",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:"Org-Mode",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportOrgMode",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:"MediaWiki",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportMediaWiki",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:"ODT",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportODT",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:"RTF",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportRTF",{id:t},n=>{W(e),Ee(n.data.zip)})}},{label:"EPUB",click:()=>{const e=M(window.siyuan.languages.exporting,-1);w("/api/export/exportEPUB",{id:t},n=>{W(e),Ee(n.data.zip)})}}]}]}).element,Lo=(t,e,n,a)=>{const i=[];if(es(e)?(p.Constants.SIYUAN_ASSETS_EXTS.includes(Le().extname(e))&&(!e.endsWith(".pdf")||e.endsWith(".pdf")&&!e.startsWith("file://"))?(i.push({icon:"iconLayoutRight",label:window.siyuan.languages.insertRight,accelerator:a?"Click":"",click(){ks(t,e.trim(),parseInt((0,I.on)("page",e)),"right")}}),i.push({label:window.siyuan.languages.useDefault,accelerator:a?"\u21E7Click":"",click(){fn(e,"app")}})):i.push({label:window.siyuan.languages.useDefault,accelerator:a?"Click":"",click(){fn(e,"app")}}),i.push({icon:"iconFolder",label:window.siyuan.languages.showInFolder,accelerator:a?"\u2318Click":"",click:()=>{fn(e,"folder")}})):i.push({label:window.siyuan.languages.useDefault,accelerator:a?"Click":"",click:()=>{te.shell.openExternal(e).catch(s=>{M(s)})}}),n)return i;window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.openBy,icon:"iconOpen",submenu:i}).element)},Zg=t=>new S({accelerator:window.siyuan.config.keymap.editor.general.rename.custom,icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{id(t)}}).element,Xd=t=>new S({label:window.siyuan.languages.move,icon:"iconMove",accelerator:window.siyuan.config.keymap.general.move.custom,click(){ga((e,n)=>{ed(t,n[0],e[0])},t)}}).element,w_=t=>{const e=`<div class="fn__flex">${we(t.name)}
<div class="fn__space"></div>
<button class="b3-button b3-button--small">${window.siyuan.languages.copy} ID</button></div>`,n=`<div class="b3-dialog__content" style="background-color: var(--b3-theme-background);">
<div class="b3-label">
    ${window.siyuan.languages.fileTree12}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="docCreateSavePath" value="">
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree5}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
</div>
<div class="b3-label">
    ${window.siyuan.languages.fileTree11}
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree14}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteSavePath" value="">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.fileTree15}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__flex-center fn__block" id="dailyNoteTemplatePath" value="${t.conf.dailyNoteTemplatePath}">
</div></div>`;let a;(0,I.tq)()?ng({title:e,icon:"iconSettings",html:`<div>${n}</div>`,bindEvent(){Jg(document.querySelector("#model"),t)}}):(a=new me({width:"80vw",title:e,content:n}).element,Jg(a,t))},Jg=(t,e)=>{t.querySelector(".b3-button--small").addEventListener("click",()=>{G(e.box),M(window.siyuan.languages.copied)});const n=t.querySelector("#dailyNoteSavePath");n.value=e.conf.dailyNoteSavePath;const a=t.querySelector("#docCreateSavePath");a.value=e.conf.docCreateSavePath;const i=t.querySelector("#refCreateSavePath");i.value=e.conf.refCreateSavePath;const s=t.querySelector("#dailyNoteTemplatePath");s.value=e.conf.dailyNoteTemplatePath,t.querySelectorAll("input").forEach(o=>{o.addEventListener("change",()=>{w("/api/notebook/setNotebookConf",{notebook:e.box,conf:{refCreateSavePath:i.value,docCreateSavePath:a.value,dailyNoteSavePath:n.value,dailyNoteTemplatePath:s.value}})})})},_n=async t=>{if(window.siyuan.dialogs.find(c=>{if(c.element.querySelector("#searchList")){const d=c.element.getAttribute("data-key"),u=c.element.querySelectorAll(".search__header")[1];if(d!==t.hotkey&&t.hotkey===p.Constants.DIALOG_REPLACE&&u.classList.contains("fn__none"))return u.classList.remove("fn__none"),c.element.setAttribute("data-key",t.hotkey),!0;const f=c.element.querySelector("#searchPathInput");if(d!==t.hotkey&&t.hotkey===p.Constants.DIALOG_GLOBALSEARCH){if(f.textContent!=="")return c.destroy(),!1;if(!u.classList.contains("fn__none"))return u.classList.add("fn__none"),c.element.setAttribute("data-key",t.hotkey),!0}if(d!==t.hotkey&&t.hotkey===p.Constants.DIALOG_SEARCH){if(f.textContent==="")return c.destroy(),!1;if(!u.classList.contains("fn__none"))return u.classList.add("fn__none"),c.element.setAttribute("data-key",t.hotkey),!0}return c.destroy(),!0}}))return;const n=window.siyuan.storage[p.Constants.LOCAL_SEARCHDATA];let a="",i=[];if(t.notebookId){if(a=ea(t.notebookId),i.push(t.notebookId),t.searchPath&&t.searchPath!=="/"){const c=await lt("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.searchPath.endsWith(".sy")?t.searchPath:t.searchPath+".sy"});a=Le().join(a,c.data),i[0]=Le().join(i[0],t.searchPath)}}else p.Constants.DIALOG_GLOBALSEARCH===t.hotkey&&(n.removed?(a="",i=[]):(a=n.hPath,i=n.idPath));let s;getSelection().rangeCount>0&&(s=getSelection().getRangeAt(0));const o=new me({positionId:t.hotkey,content:"",width:"80vw",height:"90vh",destroyCallback(c){s&&!c&&Z(s),r&&r.destroy()},resizeCallback(c){c!=="d"&&c!=="t"&&r&&r.resize()}});o.element.setAttribute("data-key",t.hotkey);const l={removed:n.removed,k:t.key||n.k,r:n.r,hasReplace:t.hotkey===p.Constants.DIALOG_REPLACE,method:n.method,hPath:a,idPath:i,group:n.group,sort:n.sort,types:Object.assign({},n.types),replaceTypes:Object.assign({},n.replaceTypes),page:t.key?1:n.page},r=Yp(t.app,l,o.element.querySelector(".b3-dialog__body"),()=>{o.destroy({focus:"false"})});o.editor=r,o.data=l},Xg=(t,e)=>{if(window.siyuan.config.fileTree.removeDocWithoutConfirm){w("/api/filetree/removeDoc",{notebook:t,path:e});return}w("/api/block/getDocInfo",{id:ft(e,!0,!0)},n=>{const a=we(n.data.name);let i=`${window.siyuan.languages.confirmDelete} <b>${a}</b>?`;n.data.subFileCount>0&&(i=`${window.siyuan.languages.confirmDelete} <b>${a}</b> ${window.siyuan.languages.andSubFile.replace("x",n.data.subFileCount)}?`),Ne(window.siyuan.languages.deleteOpConfirm,i,()=>{w("/api/filetree/removeDoc",{notebook:t,path:e})})})},fr=t=>{if(t.length===1){const e=xt(t[0],"UL");if(e){const n=e.getAttribute("data-url");t[0].getAttribute("data-type")==="navigation-file"?Xg(n,t[0].getAttribute("data-path")):Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${Lute.EscapeHTMLStr(ea(n))}</b>?`,()=>{w("/api/notebook/removeNotebook",{notebook:n,callback:p.Constants.CB_MOUNT_REMOVE})})}}else{const e=[];if(t.forEach(n=>{n.getAttribute("data-path")!=="/"&&e.push(n.getAttribute("data-path"))}),e.length===0){M(window.siyuan.languages.notBatchRemove);return}Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.confirmRemoveAll.replace("${count}",e.length),()=>{w("/api/filetree/removeDocs",{paths:e})})}},y_=(t,e)=>`<span class="ft__error">1</span>
<span class="fn__space"></span>/<span class="fn__space"></span>
<span class="ariaLabel ft__primary" aria-label="${window.siyuan.languages.flashcardNewCard}">${t}</span>
<span class="fn__space"></span>+<span class="fn__space"></span>
<span class="ariaLabel ft__success" aria-label="${window.siyuan.languages.flashcardReviewCard}">${e}</span>`,pr=t=>{let e;return e=`<div class="block__icons">
        ${t.isTab?'<div class="fn__flex-1"></div>':`<div class="block__icon block__icon--show">
            <svg><use xlink:href="#iconRiffCard"></use></svg>
        </div>
        <span class="fn__space"></span>
        <span class="fn__flex-center">${window.siyuan.languages.riffCard}</span>`}
        <span class="fn__space fn__flex-1 resize__move" style="min-height: 100%"></span>
        <div data-type="count" class="ft__on-surface ft__smaller fn__flex-center${t.cardsData.cards.length===0?" fn__none":" fn__flex"}">${y_(t.cardsData.unreviewedNewCardCount,t.cardsData.unreviewedOldCardCount)}</span></div>
        <div class="fn__space"></div>
        <div data-id="${t.id||""}" data-cardtype="${t.cardType}" data-type="filter" class="block__icon block__icon--show">
            <svg><use xlink:href="#iconFilter"></use></svg>
        </div>
        <div class="fn__space"></div>
        <div data-type="fullscreen" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show" aria-label="${window.siyuan.languages.fullscreen}">
            <svg><use xlink:href="#iconFullscreen"></use></svg>
        </div>
        <div class="fn__space${t.isTab?" fn__none":""}"></div>
        <div data-type="sticktab" class="b3-tooltips b3-tooltips__sw block__icon block__icon--show${t.isTab?" fn__none":""}" aria-label="${window.siyuan.languages.openInNewTab}">
            <svg><use xlink:href="#iconLayoutRight"></use></svg>
        </div>
    </div>`,`<div class="card__main">
    ${e}
    <div class="card__block fn__flex-1 ${t.cardsData.cards.length===0?"fn__none":""} 
${window.siyuan.config.flashcard.mark?"card__block--hidemark":""} 
${window.siyuan.config.flashcard.superBlock?"card__block--hidesb":""} 
${window.siyuan.config.flashcard.heading?"card__block--hideh":""} 
${window.siyuan.config.flashcard.list?"card__block--hideli":""}" data-type="render"></div>
    <div class="card__empty card__empty--space${t.cardsData.cards.length===0?"":" fn__none"}" data-type="empty">
        <div>\u{1F52E}</div>
        ${window.siyuan.languages.noDueCard}
    </div>
    <div class="fn__flex card__action${t.cardsData.cards.length===0?" fn__none":""}">
        <button class="b3-button b3-button--cancel" disabled="disabled" data-type="-2" style="width: 25%;min-width: 86px;display: flex">
            <svg><use xlink:href="#iconLeft"></use></svg>
            (p)
        </button>
        <span class="fn__space"></span>
        <button data-type="-1" class="b3-button fn__flex-1">${window.siyuan.languages.cardShowAnswer} (${window.siyuan.languages.space} / Enter)</button>
    </div>
    <div class="fn__flex card__action fn__none">
        <div>
            <span>${window.siyuan.languages.nextRound}</span>
            <button data-type="-3" aria-label="0" class="b3-button b3-button--cancel b3-tooltips__n b3-tooltips">
                <div>\u{1F4A4}</div>
                ${window.siyuan.languages.skip} (0)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="1" aria-label="1 / j" class="b3-button b3-button--error b3-tooltips__n b3-tooltips">
                <div>\u{1F648}</div>
                ${window.siyuan.languages.cardRatingAgain} (1)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="2" aria-label="2 / k" class="b3-button b3-button--warning b3-tooltips__n b3-tooltips">
                <div>\u{1F62C}</div>
                ${window.siyuan.languages.cardRatingHard} (2)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="3" aria-label="3 / l / ${window.siyuan.languages.space} / Enter" class="b3-button b3-button--info b3-tooltips__n b3-tooltips">
                <div>\u{1F60A}</div>
                ${window.siyuan.languages.cardRatingGood} (3)
            </button>
        </div>
        <div>
            <span></span>
            <button data-type="4" aria-label="4 / ;" class="b3-button b3-button--success b3-tooltips__n b3-tooltips">
                <div>\u{1F308}</div>
                ${window.siyuan.languages.cardRatingEasy} (4)
            </button>
        </div>
    </div>
</div>`},Qd=t=>{window.siyuan.storage[p.Constants.LOCAL_FLASHCARD].fullscreen&&_o(t.element.querySelector(".card__main"),t.element.querySelector('[data-type="fullscreen"]'));let e=0;typeof t.index=="number"&&(e=t.index);const n=new pn(t.app,t.element.querySelector("[data-type='render']"),{blockId:"",action:[p.Constants.CB_GET_ALL],render:{background:!1,title:!1,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1});window.siyuan.mobile&&(window.siyuan.mobile.popEditor=n),t.cardsData.cards.length>0&&w("/api/filetree/getDoc",{id:t.cardsData.cards[e].blockID,mode:0,size:p.Constants.SIZE_GET_MAX},l=>{st({data:l,protyle:n.protyle,action:l.data.rootID===l.data.id?[p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]})}),t.element.setAttribute("data-key",p.Constants.DIALOG_OPENCARD);const a=t.element.querySelector('[data-type="count"] span');a.innerHTML=(e+1).toString();const i=t.element.querySelectorAll(".card__action");t.index===0?i[0].firstElementChild.setAttribute("disabled","disabled"):i[0].firstElementChild.removeAttribute("disabled");const s=t.element.querySelector('[data-type="filter"]'),o=()=>{const l=s.getAttribute("data-cardtype");w(l==="all"?"/api/riff/getRiffDueCards":l==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:s.getAttribute("data-id"),deckID:s.getAttribute("data-id"),notebook:s.getAttribute("data-id")},r=>{e=0,t.cardsData=r.data,t.cardsData.cards.length>0?gr({countElement:a,editor:n,actionElements:i,index:e,blocks:t.cardsData.cards}):Qg(a,n,i)})};return t.element.addEventListener("click",l=>{const r=l.target;let c="";if(typeof l.detail=="string")l.detail==="1"||l.detail==="j"?c="1":l.detail==="2"||l.detail==="k"?c="2":l.detail==="3"||l.detail==="l"?c="3":l.detail==="4"||l.detail===";"?c="4":l.detail===" "||l.detail==="enter"?c="-1":l.detail==="p"?c="-2":l.detail==="0"&&(c="-3");else{if(q(r,"data-type","fullscreen")){_o(t.element.querySelector(".card__main"),t.element.querySelector('[data-type="fullscreen"]')),qt(n.protyle),window.siyuan.storage[p.Constants.LOCAL_FLASHCARD].fullscreen=!window.siyuan.storage[p.Constants.LOCAL_FLASHCARD].fullscreen,pe(p.Constants.LOCAL_FLASHCARD,window.siyuan.storage[p.Constants.LOCAL_FLASHCARD]),l.stopPropagation(),l.preventDefault();return}if(q(r,"data-type","sticktab")){Dn({app:t.app,position:"right",custom:{icon:"iconRiffCard",title:window.siyuan.languages.spaceRepetition,data:{cardsData:t.cardsData,index:e,cardType:s.getAttribute("data-cardtype"),id:s.getAttribute("data-id"),title:t.title},id:"siyuan-card"}}),t.dialog&&t.dialog.destroy(),l.stopPropagation(),l.preventDefault();return}if(q(r,"data-type","close")){t.dialog&&t.dialog.destroy(),l.stopPropagation(),l.preventDefault();return}const g=q(r,"data-type","filter");if(g){w("/api/riff/getRiffDecks",{},m=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.all,click(){s.setAttribute("data-id",""),s.setAttribute("data-cardtype","all"),o()}}).element),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.fileTree,click(){ga((y,_)=>{s.setAttribute("data-id",y[0]==="/"?_[0]:ft(y[0],!0,!0)),s.setAttribute("data-cardtype",y[0]==="/"?"notebook":"doc"),o()},[],void 0,window.siyuan.languages.specifyPath,!0)}}).element),(t.title||m.data.length>0)&&window.siyuan.menus.menu.append(new S({type:"separator"}).element),t.title&&(window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:we(t.title),click(){s.setAttribute("data-id",t.id),s.setAttribute("data-cardtype",t.cardType),o()}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element)),m.data.forEach(y=>{window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,label:we(y.name),click(){s.setAttribute("data-id",y.id),s.setAttribute("data-cardtype","all"),o()}}).element)});const b=g.getBoundingClientRect();window.siyuan.menus.menu.popup({x:b.left,y:b.bottom})}),l.stopPropagation(),l.preventDefault();return}if(q(r,"data-type","newround")){o(),l.stopPropagation(),l.preventDefault();return}}if(!c){const d=A(r,"b3-button");d&&(c=d.getAttribute("data-type"))}if(!(!c||!t.cardsData.cards[e])){if(l.preventDefault(),l.stopPropagation(),X(["toolbar","hint","util","gutter"],n.protyle),c==="-1")if(i[0].classList.contains("fn__none"))c="3";else{n.protyle.element.classList.remove("card__block--hidemark","card__block--hideli","card__block--hidesb","card__block--hideh"),i[0].classList.add("fn__none"),i[1].querySelectorAll(".b3-button").forEach((d,u)=>{d.previousElementSibling.textContent=t.cardsData.cards[e].nextDues[u]}),i[1].classList.remove("fn__none");return}else if(c==="-2"){if(i[0].classList.contains("fn__none"))return;e>0&&(e--,gr({countElement:a,editor:n,actionElements:i,index:e,blocks:t.cardsData.cards}));return}["1","2","3","4","-3"].includes(c)&&i[0].classList.contains("fn__none")&&w(c==="-3"?"/api/riff/skipReviewRiffCard":"/api/riff/reviewRiffCard",{deckID:t.cardsData.cards[e].deckID,cardID:t.cardsData.cards[e].cardID,rating:parseInt(c),reviewedCards:t.cardsData.cards},()=>{if(e++,e>t.cardsData.cards.length-1){const d=s.getAttribute("data-cardtype");w(d==="all"?"/api/riff/getRiffDueCards":d==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:s.getAttribute("data-id"),deckID:s.getAttribute("data-id"),notebook:s.getAttribute("data-id"),reviewedCards:t.cardsData.cards},u=>{e=0,t.cardsData=u.data,t.cardsData.cards.length===0?t.cardsData.unreviewedCount>0?__(a,n,i,u.data.unreviewedCount):Qg(a,n,i):gr({countElement:a,editor:n,actionElements:i,index:e,blocks:t.cardsData.cards})});return}gr({countElement:a,editor:n,actionElements:i,index:e,blocks:t.cardsData.cards})})}}),n},Co=t=>{w("/api/riff/getRiffDueCards",{deckID:""},e=>{Ci(t,e.data,"all")})},Ci=(t,e,n,a,i)=>{if(window.siyuan.dialogs.find(r=>{if(r.element.getAttribute("data-key")===p.Constants.DIALOG_OPENCARD)return r.destroy(),!0}))return;const o=new me({positionId:p.Constants.DIALOG_OPENCARD,content:pr({id:a,cardType:n,cardsData:e,isTab:!1}),width:(0,I.tq)()?"100vw":"80vw",height:(0,I.tq)()?"100vh":"70vh",destroyCallback(){l&&(l.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))}});o.element.querySelector(".b3-dialog__scrim").style.backgroundColor="var(--b3-theme-background)",o.element.querySelector(".b3-dialog__container").style.maxWidth="1024px";const l=Qd({app:t,element:o.element,cardsData:e,title:i,id:a,cardType:n,dialog:o});o.editor=l,o.element.querySelector('.b3-button[data-type="-1"]').focus()},gr=t=>{t.editor.protyle.element.classList.add("card__block--hide"),window.siyuan.config.flashcard.superBlock&&t.editor.protyle.element.classList.add("card__block--hidesb"),window.siyuan.config.flashcard.heading&&t.editor.protyle.element.classList.add("card__block--hideh"),window.siyuan.config.flashcard.list&&t.editor.protyle.element.classList.add("card__block--hideli"),window.siyuan.config.flashcard.mark&&t.editor.protyle.element.classList.add("card__block--hidemark"),t.actionElements[0].classList.remove("fn__none"),t.actionElements[1].classList.add("fn__none"),t.editor.protyle.element.classList.remove("fn__none"),t.editor.protyle.element.nextElementSibling.classList.add("fn__none"),t.countElement.innerHTML=(t.index+1).toString(),t.countElement.parentElement.classList.remove("fn__none"),t.index===0?t.actionElements[0].firstElementChild.setAttribute("disabled","disabled"):t.actionElements[0].firstElementChild.removeAttribute("disabled"),w("/api/filetree/getDoc",{id:t.blocks[t.index].blockID,mode:0,size:p.Constants.SIZE_GET_MAX},e=>{st({data:e,protyle:t.editor.protyle,action:e.data.rootID===e.data.id?[p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]})})},Qg=(t,e,n)=>{t.parentElement.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const a=e.protyle.element.nextElementSibling;a.innerHTML=`<div>\u{1F52E}</div>${window.siyuan.languages.noDueCard}`,a.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")},__=(t,e,n,a)=>{t.parentElement.classList.add("fn__none"),e.protyle.element.classList.add("fn__none");const i=e.protyle.element.nextElementSibling;i.innerHTML=`<div>\u267B\uFE0F </div>
<span>${window.siyuan.languages.continueReview2.replace("${count}",a)}</span>
<div class="fn__hr"></div>
<button data-type="newround" class="b3-button fn__size200">${window.siyuan.languages.continueReview1}</button>`,i.classList.remove("fn__none"),n[0].classList.add("fn__none"),n[1].classList.add("fn__none")},_s=(t,e,n,a,i)=>{let s=1,o;w(`/api/riff/get${a}RiffCards`,{id:e,page:s},l=>{const r=new me({positionId:p.Constants.DIALOG_VIEWCARDS,content:`<div class="fn__flex-column" style="height: 100%">
    <div class="block__icons">
        <span class="fn__flex-1 fn__flex-center resize__move">${we(n)}</span>
        <span class="fn__space"></span>
        <span data-type="resetAll" class="block__icon block__icon--show b3-tooltips b3-tooltips__w${a===""&&e===""?" fn__none":""}" aria-label="${window.siyuan.languages.reset}"><svg><use xlink:href='#iconUndo'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href='#iconLeft'></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href='#iconRight'></use></svg></span>
        <span class="fn__space"></span>
        <span class="fn__flex-center ft__on-surface">${s}/${l.data.pageCount||1}</span>
        <span class="fn__space"></span>
        <span class="counter">${l.data.total}</span>
        ${(0,I.tq)()?`<span class="fn__space"></span>
<div data-type="close" class="block__icon block__icon--show">
    <svg><use xlink:href="#iconCloseRound"></use></svg>
</div>`:""}
    </div>
    <div class="${(0,I.tq)()?"fn__flex-column":"fn__flex"} fn__flex-1" style="min-height: auto">
        <ul class="fn__flex-1 b3-list b3-list--background" style="user-select: none">
            ${eu(l.data.blocks,n,a)}
        </ul>
        <div id="cardPreview" style="border-bottom-right-radius:var(--b3-border-radius-b);" class="fn__flex-1 fn__none"></div>
        <div class="fn__flex-1 card__empty">${window.siyuan.languages.emptyContent}</div>
    </div>
</div>`,width:(0,I.tq)()?"100vw":"80vw",height:(0,I.tq)()?"100vh":"70vh",destroyCallback(){o&&(o.destroy(),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=null))}});l.data.blocks.length>0&&(o=new pn(t,r.element.querySelector("#cardPreview"),{blockId:"",render:{gutter:!0,breadcrumbDocName:!0}}),window.siyuan.mobile&&(window.siyuan.mobile.popEditor=o),r.editor=o,xi(o,r.element.querySelector(".b3-list-item--focus")?.getAttribute("data-id")));const c=r.element.querySelector('[data-type="previous"]'),d=r.element.querySelector('[data-type="next"]'),u=r.element.querySelector(".b3-list--background");l.data.pageCount>1&&d.removeAttribute("disabled"),r.element.setAttribute("data-key",p.Constants.DIALOG_VIEWCARDS),r.element.addEventListener("click",f=>{if(typeof f.detail=="string"){let h=u.querySelector(".b3-list-item--focus");if(h){h.classList.remove("b3-list-item--focus"),f.detail==="arrowup"?h=h.previousElementSibling||h.parentElement.lastElementChild:f.detail==="arrowdown"&&(h=h.nextElementSibling||h.parentElement.firstElementChild);const m=h.getBoundingClientRect(),b=h.parentElement.getBoundingClientRect();(m.top<b.top||m.bottom>b.bottom)&&h.scrollIntoView(m.top<b.top),xi(o,h.getAttribute("data-id")),h.classList.add("b3-list-item--focus")}f.stopPropagation(),f.preventDefault();return}let g=f.target;for(;g&&!r.element.isSameNode(g);){const h=g.getAttribute("data-type");if(h==="close"){r.destroy(),f.stopPropagation(),f.preventDefault();break}else if(h==="previous"){if(s<=1)return;s--,s<=1&&c.setAttribute("disabled","disabled"),w(`/api/riff/get${a}RiffCards`,{id:e,page:s},m=>{s===m.data.pageCount?d.setAttribute("disabled","disabled"):m.data.pageCount>1&&d.removeAttribute("disabled"),d.nextElementSibling.nextElementSibling.textContent=`${s}/${m.data.pageCount||1}`,u.innerHTML=eu(m.data.blocks,n,a),u.scrollTop=0,xi(o,r.element.querySelector(".b3-list-item--focus")?.getAttribute("data-id"))}),f.stopPropagation(),f.preventDefault();break}else if(h==="next"){if(s>=l.data.pageCount)return;s++,c.removeAttribute("disabled"),w(`/api/riff/get${a}RiffCards`,{id:e,page:s},m=>{s===m.data.pageCount?d.setAttribute("disabled","disabled"):m.data.pageCount>1&&d.removeAttribute("disabled"),d.nextElementSibling.nextElementSibling.textContent=`${s}/${m.data.pageCount||1}`,u.innerHTML=eu(m.data.blocks,n,a),u.scrollTop=0,xi(o,r.element.querySelector(".b3-list-item--focus")?.getAttribute("data-id"))}),f.stopPropagation(),f.preventDefault();break}else if(h==="reset"){w("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?e:p.Constants.QUICK_DECK_ID,id:e,blockIDs:[g.getAttribute("data-id")]},()=>{g.parentElement.querySelector(".ariaLabel.b3-list-item__meta").textContent=Q().format("YYYY-MM-DD")}),f.stopPropagation(),f.preventDefault();break}else if(h==="resetAll"){Ne(window.siyuan.languages.reset,window.siyuan.languages.resetCardTip.replace("${x}",r.element.querySelector(".counter").textContent),()=>{w("/api/riff/resetRiffCards",{type:a===""?"deck":a.toLowerCase(),deckID:a===""?e:p.Constants.QUICK_DECK_ID,id:e},()=>{r.element.querySelectorAll(".ariaLabel.b3-list-item__meta").forEach(m=>{m.textContent=Q().format("YYYY-MM-DD")})})}),f.stopPropagation(),f.preventDefault();break}else if(h==="card-item"){xi(o,g.getAttribute("data-id")),u.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus"),g.classList.add("b3-list-item--focus"),f.stopPropagation(),f.preventDefault();break}else if(h==="remove"){w("/api/riff/removeRiffCards",{deckID:a===""?e:p.Constants.QUICK_DECK_ID,blockIDs:[g.getAttribute("data-id")]},m=>{let b=g.parentElement.nextElementSibling;b||(b=g.parentElement.previousElementSibling),!b&&g.parentElement.parentElement.childElementCount>1&&(b=g.parentElement.parentElement.firstElementChild),b?(xi(o,b.getAttribute("data-id")),u.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus"),b.classList.add("b3-list-item--focus"),g.parentElement.remove()):(xi(o,""),u.innerHTML=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),r.element.querySelector(".counter").textContent=(parseInt(r.element.querySelector(".counter").textContent)-1).toString(),i&&i(m)}),f.stopPropagation(),f.preventDefault();break}g=g.parentElement}})})},eu=(t,e,n)=>{let a="",i=!0;const s=e.split("/");return s.splice(0,1),t.forEach(o=>{if(o.type){let l;n===""?l=ea(o.box)+ft(Lute.UnEscapeHTMLStr(o.hPath),!1):(l=ft(Lute.UnEscapeHTMLStr(o.hPath),!1).replace("/"+s.join("/"),""),l.startsWith("/")&&(l=l.substring(1))),a+=`<div data-type="card-item" class="b3-list-item${i?" b3-list-item--focus":""}${(0,I.tq)()?"":" b3-list-item--hide-action"}" data-id="${o.id}">
<svg class="b3-list-item__graphic"><use xlink:href="#${bn(o.type)}"></use></svg>
${ie(o.ial.icon,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${o.content||p.Constants.ZWSP}</span>
<span class="${(0,I.tq)()||!l?"fn__none ":""}b3-list-item__meta b3-list-item__meta--ellipsis" title="${Ba(l)}">${we(l)}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.revisionCount}" class="ariaLabel counter${o.riffCard?.reps===0?" fn__none":""}">${o.riffCard?.reps}</span>
<span data-position="parentE" aria-label="${window.siyuan.languages.nextDue}" class="ariaLabel b3-list-item__meta${o.riffCard?.due?"":" fn__none"}">${Q(o.riffCard?.due).format("YYYY-MM-DD")}</span>
<span data-position="parentE" data-type="reset" data-id="${o.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.reset}">
    <svg><use xlink:href="#iconUndo"></use></svg>
</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`,i=!1}else a+=`<div data-type="card-item" class="b3-list-item${(0,I.tq)()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">${o.content}</span>
<span data-position="parentE" data-type="remove" data-id="${o.id}" class="b3-list-item__action ariaLabel" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
</div>`}),t.length===0&&(a=`<div class="b3-list--empty">${window.siyuan.languages.emptyContent}</div>`),a},xi=(t,e)=>{if(!e){t.protyle.element.classList.add("fn__none"),t.protyle.element.nextElementSibling.classList.remove("fn__none");return}t.protyle.element.classList.remove("fn__none"),t.protyle.element.nextElementSibling.classList.add("fn__none"),t.protyle.scroll.lastScrollTop=0,$i(t.protyle),w("/api/filetree/getDoc",{id:e,mode:0,size:p.Constants.SIZE_GET_MAX},n=>{st({data:n,protyle:t.protyle,action:n.data.rootID===n.data.id?[p.Constants.CB_GET_HTML]:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_HTML]})})};let xo,Ao=!1;const tu=(t,e,n)=>{const a=t.querySelector('[data-type="docprevious"]'),i=t.querySelector('[data-type="docnext"]');t.setAttribute("data-page",e.toString()),e>1?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled");const s=t.querySelector('.b3-select[data-type="opselect"]'),o=t.querySelector(".b3-list--background");t.querySelector('.history__text[data-type="docPanel"]').classList.add("fn__none"),t.querySelector('.history__text[data-type="mdPanel"]').classList.remove("fn__none"),w("/api/history/searchHistory",{query:n,page:e,op:s.value,type:3},l=>{if(e<l.data.pageCount?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled"),i.nextElementSibling.nextElementSibling.textContent=`${e}/${l.data.pageCount||1}`,l.data.histories.length===0){o.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;return}let r="";l.data.histories.forEach(c=>{r+=`<li class="b3-list-item b3-list-item--hide-action" data-created="${c}">
    <span class="b3-list-item__text">${Q(parseInt(c)*1e3).format("YYYY-MM-DD HH:mm:ss")}</span>
    <span class="fn__space"></span>
    <span class="b3-list-item__action b3-tooltips b3-tooltips__w" data-type="rollback" aria-label="${window.siyuan.languages.rollback}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
</li>`}),o.innerHTML=r})},eh=t=>{const e=`<div class="fn__flex-column" style="height: 100%;">
        <div class="block__icons">
            ${(0,I.tq)()?"":t.pathString}
            <span class="fn__space"></span>
            <div class="fn__flex-1"></div>
            <select data-type="opselect" class="b3-select">
                <option value="all" selected>${window.siyuan.languages.allOp}</option>
                <option value="clean">clean</option>
                <option value="update">update</option>
                <option value="delete">delete</option>
                <option value="format">format</option>
                <option value="sync">sync</option>
                <option value="replace">replace</option>
            </select>
            <span class="fn__space"></span>
            <span data-type="docprevious" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
            <span class="fn__space"></span>
            <span data-type="docnext" class="block__icon block__icon--show b3-tooltips b3-tooltips__s" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
            <span class="fn__space"></span>
            <span>1/1</span>
            ${(0,I.tq)()?'<span class="fn__space"></span><span data-type="close" class="block__icon block__icon--show"><svg><use xlink:href="#iconClose"></use></svg></span>':""}
        </div>
        <div class="fn__flex fn__flex-1 history__panel">
            <ul class="b3-list b3-list--background" style="overflow:auto;">
                <li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>
            </ul>
            <textarea class="fn__flex-1 history__text fn__none" readonly data-type="mdPanel"></textarea>
            <div class="fn__flex-1 history__text fn__none" style="padding: 0" data-type="docPanel"></div>
        </div>
</div>`,n=new me({content:e,width:(0,I.tq)()?"100vw":"90vw",height:(0,I.tq)()?"100vh":"80vh",destroyCallback(){xo=void 0}}),a=n.element.querySelector(".b3-select");a.addEventListener("change",()=>{tu(n.element,1,t.id)});const i=n.element.querySelector('.history__text[data-type="docPanel"]'),s=n.element.querySelector('.history__text[data-type="mdPanel"]');tu(n.element,1,t.id),xo=new pn(t.app,i,{blockId:"",history:{created:""},action:[p.Constants.CB_GET_HISTORY],render:{background:!1,title:!1,gutter:!1,breadcrumb:!1,breadcrumbDocName:!1},typewriterMode:!1}),ia(xo.protyle),n.element.addEventListener("click",o=>{let l=o.target;for(;l&&!l.isEqualNode(n.element);){const r=l.getAttribute("data-type");if(r==="close")n.destroy();else if(r==="rollback"&&!Ao){th(l.parentElement,a.value,t.id,c=>{Ao=!1,Ne("\u26A0\uFE0F "+window.siyuan.languages.rollback,`${window.siyuan.languages.rollbackConfirm.replace("${date}",l.parentElement.textContent.trim())}`,()=>{w("/api/history/rollbackDocHistory",{notebook:t.notebookId,historyPath:c})})}),o.stopPropagation(),o.preventDefault();break}else if(l.classList.contains("b3-list-item")&&!Ao){th(l,a.value,t.id,c=>{w("/api/history/getDocHistoryContent",{historyPath:c},d=>{d.data.isLargeDoc?(s.value=d.data.content,s.classList.remove("fn__none"),i.classList.add("fn__none")):(s.classList.add("fn__none"),i.classList.remove("fn__none"),st({data:d,protyle:xo.protyle,action:[p.Constants.CB_GET_HISTORY,p.Constants.CB_GET_HTML]})),Ao=!1}),l.parentElement.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus"),l.classList.add("b3-list-item--focus")}),o.stopPropagation(),o.preventDefault();break}else if((r==="docprevious"||r==="docnext")&&l.getAttribute("disabled")!=="disabled"){const c=parseInt(n.element.getAttribute("data-page"));tu(n.element,r==="docprevious"?c-1:c+1,t.id),o.stopPropagation(),o.preventDefault();break}l=l.parentElement}})},th=(t,e,n,a)=>{Ao=!0;const i=t.getAttribute("data-path");i&&a(i);const s=t.getAttribute("data-created");xo.protyle.options.history.created=s,w("/api/history/getHistoryItems",{query:n,op:e,type:3,created:s},o=>{a(o.data.items[0].path)})},To=t=>`<li data-id="${t.id}" data-name="${Ba(t.name)}" class="b3-list-item b3-list-item--narrow${(0,I.tq)()?"":" b3-list-item--hide-action"}">
<span class="b3-list-item__text">
    <span>${we(t.name)}</span>
    <span class="b3-list-item__meta">${t.size}</span>
</span>
<span data-type="rename" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.rename}">
    <svg><use xlink:href="#iconEdit"></use></svg>
</span>
<span data-type="delete" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>
<span data-type="view" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
    <svg><use xlink:href="#iconEye"></use></svg>
</span>
<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.removeDeck}">
    <svg><use xlink:href="#iconMin"></use></svg>
</span>
<span data-type="add" style="display: flex" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.addDeck}">
    <svg><use xlink:href="#iconAdd"></use></svg>
</span>
<span class="b3-list-item__meta${(0,I.tq)()?" fn__none":""}">${t.updated}</span>
</li>`,Io=(t,e)=>{window.siyuan.dialogs.find(n=>{if(n.element.getAttribute("data-key")===p.Constants.DIALOG_MAKECARD)return X(["dialog"]),!0}),w("/api/riff/getRiffDecks",{},n=>{let a="";n.data.forEach(s=>{a+=To(s)});const i=new me({positionId:p.Constants.DIALOG_MAKECARD,width:(0,I.tq)()?"92vw":"50vw",height:"70vh",title:window.siyuan.languages.riffCard,content:`<div class="b3-dialog__content fn__flex-column" style="box-sizing: border-box;height: 100%">
    <div class="fn__flex">
        <input class="b3-text-field fn__flex-1">
        <span class="fn__space"></span>
        <span data-type="create" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.createDeck}">
            <svg><use xlink:href="#iconAdd"></use></svg>
        </span>
        <span class="fn__space"></span>
        <span data-type="viewall" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.cardPreview}">
            <svg><use xlink:href="#iconEye"></use></svg>
        </span>
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1">${a}</ul>
</div>`});i.element.setAttribute("data-key",p.Constants.DIALOG_MAKECARD),i.element.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isSameNode(i.element);){const l=o.getAttribute("data-type");if(l==="create"){let r="";const c=i.element.querySelector(".b3-text-field");c.value?(r&&W(r),w("/api/riff/createRiffDeck",{name:c.value},d=>{i.element.querySelector(".b3-list").insertAdjacentHTML("afterbegin",To(d.data)),c.value=""})):(r=M(window.siyuan.languages._kernel[142]),c.focus()),s.stopPropagation(),s.preventDefault();break}else if(l==="add"){w("/api/riff/addRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:e},r=>{o.parentElement.outerHTML=To(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="remove"){w("/api/riff/removeRiffCards",{deckID:o.parentElement.getAttribute("data-id"),blockIDs:e},r=>{o.parentElement.outerHTML=To(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="delete"){Ne(window.siyuan.languages.confirm,`${window.siyuan.languages.confirmDelete} <b>${we(o.parentElement.getAttribute("data-name"))}</b>?`,()=>{w("/api/riff/removeRiffDeck",{deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.remove()})}),s.stopPropagation(),s.preventDefault();break}else if(l==="view"){_s(t,o.parentElement.getAttribute("data-id"),o.parentElement.getAttribute("data-name"),"",r=>{o.parentElement.outerHTML=To(r.data)}),s.stopPropagation(),s.preventDefault();break}else if(l==="viewall"){_s(t,"",window.siyuan.languages.all,""),s.stopPropagation(),s.preventDefault();break}else if(l==="rename"){const r=new me({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block" value=""></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),c=r.element.querySelector("input"),d=r.element.querySelectorAll(".b3-button");r.bindInput(c,()=>{d[1].click()}),c.value=o.parentElement.getAttribute("data-name"),c.focus(),c.select(),d[0].addEventListener("click",()=>{r.destroy()}),d[1].addEventListener("click",()=>{w("/api/riff/renameRiffDeck",{name:c.value,deckID:o.parentElement.getAttribute("data-id")},()=>{o.parentElement.querySelector(".b3-list-item__text span").textContent=c.value,o.parentElement.setAttribute("data-name",c.value)}),r.destroy()}),s.stopPropagation(),s.preventDefault();break}o=o.parentElement}})})},Do=(t,e)=>{let n=!0;const a=[];e.forEach(i=>{i.getAttribute("data-type")!=="NodeThematicBreak"&&(i.classList.remove("protyle-wysiwyg--select"),a.push(i.getAttribute("data-node-id")),(i.getAttribute(p.Constants.CUSTOM_RIFF_DECKS)||"").indexOf(p.Constants.QUICK_DECK_ID)===-1&&(n=!1))}),n?F(t,[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}]):F(t,[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}])},nh=(t,e)=>{if(!Array.from(t).find(s=>{if(s.getAttribute("data-type")==="navigation-file")return!0}))return window.siyuan.menus.menu;window.siyuan.menus.menu.append(Xd(Qc(Array.from(t)))),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{fr(Array.from(t))}}).element);const a=[];if(t.forEach(s=>{const o=s.getAttribute("data-node-id");o&&a.push(o)}),a.length===0)return window.siyuan.menus.menu;window.siyuan.menus.menu.append(new S({type:"separator"}).element);const i=[{iconHTML:p.Constants.ZWSP,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{F(void 0,[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}])}},{iconHTML:p.Constants.ZWSP,label:`${window.siyuan.languages.cancel} <b>${window.siyuan.languages.quickMakeCard}</b>`,click:()=>{F(void 0,[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}],[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:a}])}}];return window.siyuan.config.flashcard.deck&&i.push({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{Io(e,a)}}),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.riffCard,icon:"iconRiffCard",submenu:i}).element),e.plugins&&en({plugins:e.plugins,type:"open-menu-doctree",detail:{elements:t,type:"docs"},separatorPosition:"top"}),window.siyuan.menus.menu},hr=(t,e)=>{window.siyuan.menus.menu.remove();const n=_e(e,"DIV");if(!n)return window.siyuan.menus.menu;e.classList.contains("b3-list-item--focus")||(n.querySelectorAll(".b3-list-item--focus").forEach(o=>{o.classList.remove("b3-list-item--focus"),o.removeAttribute("select-end"),o.removeAttribute("select-start")}),e.classList.add("b3-list-item--focus"));const a=n.querySelectorAll(".b3-list-item--focus");if(a.length>1)return nh(a,t);const i=e.parentElement.getAttribute("data-url"),s=ea(i);if(!window.siyuan.config.readonly){window.siyuan.menus.menu.append(Zg({path:"/",notebookId:i,name:s,type:"notebook"})),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.config,icon:"iconSettings",click:()=>{w("/api/notebook/getNotebookConf",{notebook:i},l=>{w_(l.data)})}}).element);const o=ah("notebook",parseInt(e.parentElement.getAttribute("data-sortmode")),l=>(w("/api/notebook/setNotebookConf",{notebook:i,conf:{sortMode:l}},()=>{e.parentElement.setAttribute("data-sortmode",l.toString());let r;r=St("file").data.file;const c=e.querySelector(".b3-list-item__arrow--open");c&&(c.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling?.remove(),r.getLeaf(e,i))}),!0));window.siyuan.menus.menu.append(new S({icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:o}).element)}return window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{w("/api/riff/getNotebookRiffDueCards",{notebook:i},o=>{Ci(t,o.data,"notebook",i,s)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{_s(t,i,s,"Notebook")}}]}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.search,accelerator:window.siyuan.config.keymap.general.search.custom,icon:"iconSearch",click(){_n({app:t,hotkey:p.Constants.DIALOG_SEARCH,notebookId:i})}}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",click(){_n({app:t,hotkey:p.Constants.DIALOG_REPLACE,notebookId:i})}}).element),window.siyuan.config.readonly||(window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.close,icon:"iconClose",click:()=>{w("/api/notebook/closeNotebook",{notebook:i})}}).element),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{fr(Array.from(n.querySelectorAll(".b3-list-item--focus")))}}).element)),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({icon:"iconFolder",label:window.siyuan.languages.showInFolder,click:()=>{te.shell.openPath(kt.join(window.siyuan.config.system.dataDir,i))}}).element),nu(i,"/"),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.export,type:"submenu",icon:"iconUpload",submenu:[{label:"Markdown",icon:"iconMarkdown",click:()=>{const o=M(window.siyuan.languages.exporting,-1);w("/api/export/batchExportMd",{notebook:i,path:"/"},l=>{W(o),window.open(l.data.zip)})}},{label:"SiYuan .sy.zip",icon:"iconSiYuan",click:()=>{const o=M(window.siyuan.languages.exporting,-1);w("/api/export/exportNotebookSY",{id:i},l=>{W(o),window.open(l.data.zip)})}}]}).element),t.plugins&&en({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:a,type:"notebook"},separatorPosition:"top"}),window.siyuan.menus.menu},mr=(t,e,n,a)=>{window.siyuan.menus.menu.remove();const i=_e(a,"DIV");if(!i)return window.siyuan.menus.menu;a.classList.contains("b3-list-item--focus")||(i.querySelectorAll(".b3-list-item--focus").forEach(r=>{r.classList.remove("b3-list-item--focus"),r.removeAttribute("select-end"),r.removeAttribute("select-start")}),a.classList.add("b3-list-item--focus"));const s=i.querySelectorAll(".b3-list-item--focus");if(s.length>1)return nh(s,t);const o=a.getAttribute("data-node-id");let l=a.getAttribute("data-name");if(l=ft(l,!1,!0),!window.siyuan.config.readonly){window.siyuan.config.fileTree.sort===6&&(window.siyuan.menus.menu.append(new S({icon:"iconBefore",label:window.siyuan.languages.newDocAbove,click:()=>{const c=[];Array.from(a.parentElement.children).forEach(d=>{d.tagName==="LI"&&(d.isSameNode(a)&&c.push(void 0),c.push(d.getAttribute("data-path")))}),gi({app:t,notebookId:e,currentPath:Le().dirname(n),paths:c,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new S({icon:"iconAfter",label:window.siyuan.languages.newDocBelow,click:()=>{const c=[];Array.from(a.parentElement.children).forEach(d=>{d.tagName==="LI"&&(c.push(d.getAttribute("data-path")),d.isSameNode(a)&&c.push(void 0))}),gi({app:t,notebookId:e,currentPath:Le().dirname(n),paths:c,useSavePath:!1})}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element)),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:Li(o,!1).concat([{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,click(){w("/api/filetree/duplicateDoc",{id:o})}}])}).element),window.siyuan.menus.menu.append(Xd(Qc(Array.from(i.querySelectorAll(".b3-list-item--focus"))))),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:window.siyuan.languages.delete,accelerator:"\u2326",click:()=>{fr(Array.from(i.querySelectorAll(".b3-list-item--focus")))}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(Zg({path:n,notebookId:e,name:l,type:"file"})),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.attr,icon:"iconAttr",click(){w("/api/block/getDocInfo",{id:o},c=>{Un(c.data.ial)})}}).element);const r=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{w("/api/riff/getTreeRiffDueCards",{rootID:o},c=>{Ci(t,c.data,"doc",o,l)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{w("/api/filetree/getHPathByID",{id:o},c=>{_s(t,o,Le().join(ea(e),c.data),"Tree")})}},{iconHTML:p.Constants.ZWSP,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,label:window.siyuan.languages.quickMakeCard,click:()=>{F(void 0,[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:[o]}],[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:[o]}])}},{iconHTML:p.Constants.ZWSP,label:`${window.siyuan.languages.cancel} <b>${window.siyuan.languages.quickMakeCard}</b>`,click:()=>{F(void 0,[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:[o]}],[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:[o]}])}}];window.siyuan.config.flashcard.deck&&r.push({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{Io(t,[o])}}),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:r}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,async click(){const c=ft(n,!1,!0);_n({app:t,hotkey:p.Constants.DIALOG_SEARCH,notebookId:e,searchPath:c})}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.replace,accelerator:window.siyuan.config.keymap.general.replace.custom,icon:"iconReplace",async click(){const c=ft(n,!1,!0);_n({app:t,hotkey:p.Constants.DIALOG_REPLACE,notebookId:e,searchPath:c})}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element)}return lp(t,o,e,n),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){eh({app:t,id:o,notebookId:e,pathString:l})}}).element),nu(e,n),window.siyuan.menus.menu.append(Kg(o)),t.plugins&&en({plugins:t.plugins,type:"open-menu-doctree",detail:{elements:s,type:"doc"},separatorPosition:"top"}),window.siyuan.menus.menu},nu=(t,e)=>{if(!window.siyuan.config.readonly){const n=(a,i)=>({icon:i?"iconMarkdown":"iconFolder",label:a,click:async()=>{let s=[];i&&(s=[{name:"Markdown",extensions:["md","markdown"]}]);const o=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"showOpenDialog",defaultPath:window.siyuan.config.system.homeDir,filters:s,properties:[i?"openFile":"openDirectory"]});o.filePaths.length!==0&&w("/api/import/importStdMd",{notebook:t,localPath:o.filePaths[0],toPath:e})}});window.siyuan.menus.menu.append(new S({icon:"iconDownload",label:window.siyuan.languages.import,submenu:[{icon:"iconSiYuan",label:'SiYuan .sy.zip<input class="b3-form__upload" type="file" accept="application/zip">',bind:a=>{a.querySelector(".b3-form__upload").addEventListener("change",i=>{const s=new FormData;s.append("file",i.target.files[0]),s.append("notebook",t),s.append("toPath",e),w("/api/import/importSY",s,()=>{let o;o=St("file").data.file;const l=o.element.querySelector(`[data-path="${e}"]`),r=l.querySelector(".b3-list-item__arrow--open");r&&(r.classList.remove("b3-list-item__arrow--open"),l.nextElementSibling?.remove()),o.getLeaf(l,t),window.siyuan.menus.menu.remove()})})}},n("Markdown "+window.siyuan.languages.doc,!0),n("Markdown "+window.siyuan.languages.folder)]}).element)}},ah=(t,e,n)=>{const a=[{icon:e===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{n(0)}},{icon:e===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{n(1)}},{icon:e===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{n(4)}},{icon:e===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{n(5)}},{type:"separator"},{icon:e===9?"iconSelect":void 0,label:window.siyuan.languages.createdASC,click:()=>{n(9)}},{icon:e===10?"iconSelect":void 0,label:window.siyuan.languages.createdDESC,click:()=>{n(10)}},{icon:e===2?"iconSelect":void 0,label:window.siyuan.languages.modifiedASC,click:()=>{n(2)}},{icon:e===3?"iconSelect":void 0,label:window.siyuan.languages.modifiedDESC,click:()=>{n(3)}},{type:"separator"},{icon:e===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{n(7)}},{icon:e===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{n(8)}},{type:"separator"},{icon:e===11?"iconSelect":void 0,label:window.siyuan.languages.docSizeASC,click:()=>{n(11)}},{icon:e===12?"iconSelect":void 0,label:window.siyuan.languages.docSizeDESC,click:()=>{n(12)}},{type:"separator"},{icon:e===13?"iconSelect":void 0,label:window.siyuan.languages.subDocCountASC,click:()=>{n(13)}},{icon:e===14?"iconSelect":void 0,label:window.siyuan.languages.subDocCountDESC,click:()=>{n(14)}},{type:"separator"},{icon:e===6?"iconSelect":void 0,label:window.siyuan.languages.customSort,click:()=>{n(6)}}];return t==="notebook"&&a.push({icon:e===15?"iconSelect":void 0,label:window.siyuan.languages.sortByFiletree,click:()=>{n(15)}}),a};class xa extends ct{constructor(e){super({app:e.app,type:"filetree",id:e.tab.id,msgCallback(n){if(n)switch(n.cmd){case"moveDoc":this.onMove(n);break;case"reloadFiletree":ha(()=>{this.init(!1)});break;case"mount":this.onMount(n);break;case"createnotebook":ha(a=>{let i;a.find(s=>{if(!s.closed){if(s.id===n.data.box.id)return i?this.element.querySelector(`.b3-list[data-url="${i}"]`).insertAdjacentHTML("afterend",this.genNotebook(n.data.box)):this.element.insertAdjacentHTML("afterbegin",this.genNotebook(n.data.box)),!0;i=s.id}})});break;case"unmount":case"removeDoc":this.onRemove(n);break;case"createdailynote":case"create":case"heading2doc":case"li2doc":this.onMkdir(n.data);break;case"renamenotebook":this.element.querySelector(`[data-url="${n.data.box}"] .b3-list-item__text`).innerHTML=we(n.data.name);break;case"rename":this.onRename(n.data);break}}}),this.genFileHTML=n=>{let a="";n.count&&n.count>0&&(a=`<span class="popover__block counter b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.ref}">${n.count}</span>`);const i=`${ft(n.name,!0,!0)} ${n.hSize}${n.bookmark?"<br>"+window.siyuan.languages.bookmark+" "+n.bookmark:""}${n.name1?"<br>"+window.siyuan.languages.name+" "+n.name1:""}${n.alias?"<br>"+window.siyuan.languages.alias+" "+n.alias:""}${n.memo?"<br>"+window.siyuan.languages.memo+" "+n.memo:""}${n.subFileCount!==0?window.siyuan.languages.includeSubFile.replace("x",n.subFileCount):""}<br>${window.siyuan.languages.modifiedAt} ${n.hMtime}<br>${window.siyuan.languages.createdAt} ${n.hCtime}`;return`<li data-node-id="${n.id}" data-name="${Lute.EscapeHTMLStr(n.name)}" draggable="true" data-count="${n.subFileCount}" 
data-type="navigation-file" 
style="--file-toggle-width:${(n.path.split("/").length-2)*18+40}px" 
class="b3-list-item b3-list-item--hide-action" data-path="${n.path}">
    <span style="padding-left: ${(n.path.split("/").length-2)*18+22}px" class="b3-list-item__toggle b3-list-item__toggle--hl${n.subFileCount===0?" fn__hidden":""}">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__icon b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.changeIcon}">${ie(n.icon||(n.subFileCount===0?p.Constants.SIYUAN_IMAGE_FILE:p.Constants.SIYUAN_IMAGE_FOLDER))}</span>
    <span class="b3-list-item__text ariaLabel" data-position="parentE"
aria-label="${we(i)}">${ft(n.name,!0,!0)}</span>
    <span data-type="more-file" class="b3-list-item__action b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__nw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
    ${a}
</li>`},e.tab.panelElement.classList.add("fn__flex-column","file-tree","sy__file"),e.tab.panelElement.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconFiles"></use></svg>
        ${window.siyuan.languages.fileTree}
    </div>
    <span class="fn__flex-1 fn__space"></span>
    <span data-type="focus" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.selectOpen1} ${K(window.siyuan.config.keymap.general.selectOpen1.custom)}"><svg><use xlink:href='#iconFocus'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${K(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <div class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></div>
    <div data-type="more" class="b3-tooltips b3-tooltips__sw block__icon${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </div> 
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${K(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1"></div>
<ul class="b3-list fn__flex-column" style="min-height: auto;transition: var(--b3-transition)">
    <li class="b3-list-item" data-type="toggle">
        <span class="b3-list-item__toggle">
            <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text">${window.siyuan.languages.closeNotebook}</span>
    </li>
    <ul class="fn__none fn__flex-1"></ul>
</ul>`,this.actionsElement=e.tab.panelElement.firstElementChild,this.element=this.actionsElement.nextElementSibling,this.closeElement=e.tab.panelElement.lastElementChild,this.closeElement.addEventListener("click",n=>{Ze(this.element.parentElement);let a=n.target;for(;a&&!a.isEqualNode(this.closeElement);){const i=a.getAttribute("data-type");if(a.classList.contains("b3-list-item__icon")){n.preventDefault(),n.stopPropagation();const s=a.getBoundingClientRect();fi(a.parentElement.getAttribute("data-url"),"notebook",{x:s.left,y:s.bottom,h:s.height,w:s.width});break}else if(i==="toggle"){this.closeElement.classList.contains("fn__flex-1")?(this.closeElement.lastElementChild.classList.add("fn__none"),this.closeElement.classList.remove("fn__flex-1"),a.querySelector("svg").classList.remove("b3-list-item__arrow--open")):(this.closeElement.lastElementChild.classList.remove("fn__none"),this.closeElement.classList.add("fn__flex-1"),a.querySelector("svg").classList.add("b3-list-item__arrow--open")),window.siyuan.menus.menu.remove(),n.stopPropagation(),n.preventDefault();break}else if(i==="remove"){Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${we(a.parentElement.querySelector(".b3-list-item__text").textContent)}</b>?`,()=>{w("/api/notebook/removeNotebook",{notebook:a.getAttribute("data-url"),callback:p.Constants.CB_MOUNT_REMOVE})}),window.siyuan.menus.menu.remove(),n.stopPropagation(),n.preventDefault();break}else if(i==="open"){w("/api/notebook/openNotebook",{notebook:a.getAttribute("data-url")}),window.siyuan.menus.menu.remove(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}),this.actionsElement.querySelector('[data-type="collapse"]').addEventListener("click",()=>{Array.from(this.element.children).forEach(n=>{const a=n.firstElementChild,i=a.querySelector(".b3-list-item__arrow");i.classList.contains("b3-list-item__arrow--open")&&(i.classList.remove("b3-list-item__arrow--open"),a.nextElementSibling.remove())})}),this.actionsElement.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(this.actionsElement);){const i=a.getAttribute("data-type");if(i==="min"){St("file").toggleModel("file",!1,!0),n.preventDefault(),n.stopPropagation(),window.siyuan.menus.menu.remove();break}else if(i==="focus"){const s=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus")||document.querySelector("ul.layout-tab-bar > .item--focus");if(s){const o=Lt(s.getAttribute("data-id"));o&&o.model instanceof dt&&this.selectItem(o.model.editor.protyle.notebookId,o.model.editor.protyle.path)}n.preventDefault();break}else if(i==="more"){this.initMoreMenu().popup({x:n.clientX,y:n.clientY}),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}Ze(this.element.parentElement)}),this.element.addEventListener("mousedown",n=>{if(n.button!==1||!window.siyuan.config.fileTree.openFilesUseCurrentTab)return;let a=n.target;for(;a&&!a.isEqualNode(this.element);){if(a.tagName==="LI"&&!a.getAttribute("data-opening")){a.setAttribute("data-opening","true"),de({app:e.app,removeCurrentTab:!1,id:a.getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){a.removeAttribute("data-opening")}}),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}),this.element.addEventListener("click",n=>{let a=n.target;const i=xt(a,"UL");let s=!0;if(i){const o=i.getAttribute("data-url");for(;a&&!a.isEqualNode(this.element);){if(R(n)&&a.classList.contains("b3-list-item__icon")&&window.siyuan.config.system.container!=="ios"){n.preventDefault(),n.stopPropagation();const l=a.getBoundingClientRect();a.parentElement.getAttribute("data-type")==="navigation-file"?fi(a.parentElement.getAttribute("data-node-id"),"doc",{x:l.left,y:l.bottom,h:l.height,w:l.width}):fi(a.parentElement.parentElement.getAttribute("data-url"),"notebook",{x:l.left,y:l.bottom,h:l.height,w:l.width});break}else if(R(n)&&a.classList.contains("b3-list-item__toggle")){this.getLeaf(a.parentElement,o),this.setCurrent(a.parentElement),n.preventDefault(),n.stopPropagation(),window.siyuan.menus.menu.remove();break}else if(R(n)&&a.classList.contains("b3-list-item__action")){const l=a.getAttribute("data-type"),r=a.parentElement.getAttribute("data-path");window.siyuan.config.readonly||(l==="new"?gi({app:e.app,notebookId:o,currentPath:r,useSavePath:!1}):l==="more-root"&&hr(e.app,a.parentElement).popup({x:n.clientX,y:n.clientY})),l==="more-file"&&mr(e.app,o,r,a.parentElement).popup({x:n.clientX,y:n.clientY}),n.preventDefault(),n.stopPropagation();break}else if(a.tagName==="LI"){if(O(n)&&!n.altKey&&!n.shiftKey)a.classList.toggle("b3-list-item--focus");else if(this.setCurrent(a,!1),a.getAttribute("data-type")==="navigation-file"){if(s=!1,a.getAttribute("data-opening"))return;a.setAttribute("data-opening","true"),n.altKey&&R(n)&&!n.shiftKey?de({app:e.app,id:a.getAttribute("data-node-id"),position:"right",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){a.removeAttribute("data-opening")}}):!n.altKey&&R(n)&&n.shiftKey?de({app:e.app,id:a.getAttribute("data-node-id"),position:"bottom",action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){a.removeAttribute("data-opening")}}):window.siyuan.config.fileTree.openFilesUseCurrentTab&&n.altKey&&O(n)&&!n.shiftKey?de({app:e.app,removeCurrentTab:!1,id:a.getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){a.removeAttribute("data-opening")}}):de({app:e.app,id:a.getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL],afterOpen(){a.removeAttribute("data-opening")}})}else a.getAttribute("data-type")==="navigation-root"&&this.getLeaf(a,o);this.element.querySelector('[select-end="true"]')?.removeAttribute("select-end"),this.element.querySelector('[select-start="true"]')?.removeAttribute("select-start"),window.siyuan.menus.menu.remove(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}}s&&Ze(this.element.parentElement)}),this.element.addEventListener("dragstart",n=>{if((0,I.b1)()){n.stopPropagation(),n.preventDefault();return}window.getSelection().removeAllRanges();const a=_e(n.target,"LI");if(a){let i=Array.from(this.element.querySelectorAll(".b3-list-item--focus"));a.classList.contains("b3-list-item--focus")||(i.forEach(l=>{l.classList.remove("b3-list-item--focus")}),a.classList.add("b3-list-item--focus"),i=[a]);let s="";const o=document.createElement("ul");i.forEach((l,r)=>{o.append(l.cloneNode(!0)),l.style.opacity="0.1";const c=l.dataset.nodeId||l.dataset.path;c&&(s+=c,r<i.length-1&&(s+=","))}),o.setAttribute("style",`width: 219px;position: fixed;top:-${i.length*30}px`),o.setAttribute("class","b3-list b3-list--background"),document.body.append(o),n.dataTransfer.setDragImage(o,16,16),n.dataTransfer.setData(p.Constants.SIYUAN_DROP_FILE,s),n.dataTransfer.dropEffect="move",window.siyuan.dragElement=document.createElement("div"),window.siyuan.dragElement.innerText=s,setTimeout(()=>{o.remove()})}}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll(".b3-list-item--focus").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("dragover",n=>{if(window.siyuan.config.readonly)return;const a=this.element.getBoundingClientRect();(n.clientY<a.top+p.Constants.SIZE_SCROLL_TB||n.clientY>a.bottom-p.Constants.SIZE_SCROLL_TB)&&this.element.scroll({top:this.element.scrollTop+(n.clientY<a.top+p.Constants.SIZE_SCROLL_TB?-p.Constants.SIZE_SCROLL_STEP:p.Constants.SIZE_SCROLL_STEP),behavior:"smooth"});let i=_e(n.target,"LI");if(i||(i=_e(document.elementFromPoint(n.clientX,n.clientY-1),"LI")),!i||!window.siyuan.dragElement){n.preventDefault();return}i.classList.remove("dragover__top","dragover__bottom","dragover");let s="";for(const d of n.dataTransfer.items)d.type.startsWith(p.Constants.SIYUAN_DROP_GUTTER)&&(s=d.type);if(s){const d=s.replace(p.Constants.SIYUAN_DROP_GUTTER,"").split(p.Constants.ZWSP);["nodelistitem","nodeheading"].includes(d[0])&&i.classList.add("dragover"),n.preventDefault();return}if(i.classList.contains("b3-list-item--focus"))return;let o=!0;Array.from(this.element.querySelectorAll(".b3-list-item--focus")).find(d=>{if(d.getAttribute("data-type")==="navigation-file")return o=!1,!0});const l=i.getAttribute("data-type");if(o&&l!=="navigation-root"){n.preventDefault();return}const r=q(i,"data-sortmode",null);if(!r)return;const c=r.getAttribute("data-sortmode");if((c==="6"||window.siyuan.config.fileTree.sort===6&&c==="15")&&!(!o&&l==="navigation-root")){const d=i.getBoundingClientRect();n.clientY>d.top+20?(i.classList.add("dragover__bottom"),n.preventDefault()):n.clientY<d.bottom-20&&(i.classList.add("dragover__top"),n.preventDefault())}if(i.classList.contains("dragover__top")||i.classList.contains("dragover__bottom")||l==="navigation-root"&&o){n.preventDefault();return}i.classList.add("dragover"),n.preventDefault()}),this.element.addEventListener("dragleave",()=>{this.element.querySelectorAll(".dragover, .dragover__bottom, .dragover__top").forEach(n=>{n.classList.remove("dragover","dragover__bottom","dragover__top")})}),this.element.addEventListener("drop",async n=>{const a=this.element.querySelector(".dragover, .dragover__bottom, .dragover__top");if(!a)return;const i=xt(a,"UL");if(!i)return;const s=this.element.scrollTop,o=i.getAttribute("data-url"),l=a.getAttribute("data-path");let r="";for(const g of n.dataTransfer.items)g.type.startsWith(p.Constants.SIYUAN_DROP_GUTTER)&&(r=g.type);if(r&&a.classList.contains("dragover")){const g=r.replace(p.Constants.SIYUAN_DROP_GUTTER,"").split(p.Constants.ZWSP);["nodelistitem","nodeheading"].includes(g[0])&&(g[0]==="nodeheading"?w("/api/filetree/heading2Doc",{targetNoteBook:o,srcHeadingID:g[2].split(",")[0],targetPath:l,pushMode:0}):w("/api/filetree/li2Doc",{pushMode:0,srcListItemID:g[2].split(",")[0],targetNoteBook:o,targetPath:l})),a.classList.remove("dragover","dragover__bottom","dragover__top"),window.siyuan.dragElement=void 0;return}if(window.siyuan.dragElement=void 0,!n.dataTransfer.getData(p.Constants.SIYUAN_DROP_FILE)){a.classList.remove("dragover","dragover__bottom","dragover__top");return}const c=[],d=[],u=[];if(this.element.querySelectorAll(".b3-list-item--focus").forEach(g=>{if(g.getAttribute("data-type")==="navigation-root")c.push(g);else{const h=g.getAttribute("data-path");u.find(b=>{if(h.startsWith(b.replace(".sy","")))return!0})||(d.push(g),u.push(h))}}),a.classList.contains("dragover")){w("/api/filetree/moveDocs",{toNotebook:o,fromPaths:u,toPath:l}),a.classList.remove("dragover","dragover__bottom","dragover__top");return}const f=i.getAttribute("data-sortmode");if((a.classList.contains("dragover__bottom")||a.classList.contains("dragover__top"))&&(f==="6"||window.siyuan.config.fileTree.sort===6&&f==="15"))if(c.length>0&&a.getAttribute("data-path")==="/"){a.classList.contains("dragover__top")?c.forEach(h=>{a.parentElement.before(h.parentElement)}):c.reverse().forEach(h=>{a.parentElement.after(h.parentElement)});const g=[];Array.from(this.element.children).forEach(h=>{g.push(h.getAttribute("data-url"))}),w("/api/notebook/changeSortNotebook",{notebooks:g})}else{let g=!1;const h=Le().dirname(l);u.length>0&&(await lt("/api/filetree/moveDocs",{toNotebook:o,fromPaths:u,toPath:h==="/"?"/":h+".sy",callback:p.Constants.CB_MOVE_NOLIST}),d.forEach(b=>{b.setAttribute("data-path",Le().join(h,b.getAttribute("data-node-id")+".sy"))}),g=!0),a.classList.contains("dragover__top")?d.forEach(b=>{let y;b.nextElementSibling&&b.nextElementSibling.tagName==="UL"&&(y=b.nextElementSibling),a.before(b),y&&b.after(y)}):a.classList.contains("dragover__bottom")&&d.reverse().forEach(b=>{let y;b.nextElementSibling&&b.nextElementSibling.tagName==="UL"&&(y=b.nextElementSibling),a.nextElementSibling&&a.nextElementSibling.tagName==="UL"?a.nextElementSibling.after(b):a.after(b),y&&b.after(y)});const m=[];Array.from(a.parentElement.children).forEach(b=>{b.tagName==="LI"&&m.push(b.getAttribute("data-path"))}),w("/api/filetree/changeSort",{paths:m,notebook:o},()=>{g&&w("/api/filetree/listDocsByPath",{notebook:o,path:h==="/"?"/":h+".sy"},b=>{if(b.data.path==="/"&&b.data.files.length===0){M(window.siyuan.languages.emptyContent);return}this.onLsHTML(b.data,s)})})}a.classList.remove("dragover","dragover__bottom","dragover__top")}),this.init(),window.siyuan.config.openHelp&&er()}genNotebook(e){const n=`<span class="b3-list-item__icon b3-tooltips b3-tooltips__e" aria-label="${window.siyuan.languages.changeIcon}">${ie(e.icon||p.Constants.SIYUAN_IMAGE_NOTE)}</span>`;return e.closed?`<li data-type="open" data-url="${e.id}" class="b3-list-item b3-list-item--hide-action">
    <span class="b3-list-item__toggle fn__hidden">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text">${we(e.name)}</span>
    <span data-type="remove" data-url="${e.id}" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.delete}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
</li>`:`<ul class="b3-list b3-list--background" data-url="${e.id}" data-sort="${e.sort}" data-sortmode="${e.sortMode}">
<li class="b3-list-item b3-list-item--hide-action" draggable="true" data-type="navigation-root" data-path="/">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    ${n}
    <span class="b3-list-item__text">${we(e.name)}</span>
    <span data-type="more-root" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </span>
    <span data-type="new" class="b3-list-item__action b3-tooltips b3-tooltips__w${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.newSubDoc}">
        <svg><use xlink:href="#iconAdd"></use></svg>
    </span>
</li></ul>`}init(e=!0){let n="",a="";window.siyuan.notebooks.forEach(i=>{i.closed?a+=this.genNotebook(i):n+=this.genNotebook(i)}),this.element.innerHTML=n,this.closeElement.lastElementChild.innerHTML=a,e&&(n===""?(this.closeElement.lastElementChild.classList.remove("fn__none"),this.closeElement.classList.add("fn__flex-1")):(this.closeElement.lastElementChild.classList.add("fn__none"),this.closeElement.classList.remove("fn__flex-1")))}onMkdir(e){let n=this.element.querySelector(`ul[data-url="${e.box.id}"]`),a=Le().dirname(e.path)+".sy";for(;a!=="/"&&(n=n.querySelector(`li[data-path="${a}"]`),!n);)n=this.element.querySelector(`ul[data-url="${e.box.id}"]`),a==="/.sy"?a="/":a=Le().dirname(a)+".sy";if(n.tagName==="UL"&&(n=n.firstElementChild),n){n.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open"),n.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden");const i=n.querySelector(".b3-list-item__icon");i.innerHTML===ie(p.Constants.SIYUAN_IMAGE_FILE)&&(i.innerHTML=ie(p.Constants.SIYUAN_IMAGE_FOLDER)),n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&n.nextElementSibling.remove(),this.getLeaf(n,e.box.id)}}onRemove(e){if(e.cmd==="unmount"){if(ha(n=>{const a=this.element.querySelector(`ul[data-url="${e.data.box}"] li[data-path="/"]`);if(a&&(a.parentElement.remove(),p.Constants.CB_MOUNT_REMOVE!==e.callback)){let i="";n.find(s=>{s.closed&&(i+=this.genNotebook(s))}),this.closeElement.lastElementChild.innerHTML=i}}),p.Constants.CB_MOUNT_REMOVE===e.callback){const n=this.closeElement.querySelector(`li[data-url="${e.data.box}"]`);n&&n.remove()}return}e.data.ids.forEach(n=>{const a=this.element.querySelector(`li.b3-list-item[data-node-id="${n}"]`);if(a){a.nextElementSibling?.tagName==="UL"&&a.nextElementSibling.remove();const i=a.parentElement.previousElementSibling;if(a.parentElement.childElementCount===1){if(i){const s=i.querySelector("svg");s.classList.remove("b3-list-item__arrow--open"),s.parentElement.classList.add("fn__hidden");const o=s.parentElement.nextElementSibling;o.innerHTML===ie(p.Constants.SIYUAN_IMAGE_FOLDER)&&(o.innerHTML=ie(p.Constants.SIYUAN_IMAGE_FILE))}a.parentElement.remove()}else a.remove()}})}onMount(e){if(e.data.existed)return;const n=this.closeElement.querySelector(`li[data-url="${e.data.box.id}"]`);n&&n.remove(),ha(a=>{const i=this.genNotebook(e.data.box);if(this.element.childElementCount===0)this.element.innerHTML=i;else{let s;a.find((o,l)=>{if(o.id===e.data.box.id){for(;l>0;)if(a[l-1].closed)l--;else{s=a[l-1].id;break}return!0}}),s?this.element.querySelector(`[data-url="${s}"]`).insertAdjacentHTML("afterend",i):this.element.insertAdjacentHTML("afterbegin",i)}})}onRename(e){const n=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);n&&(n.setAttribute("data-name",Lute.EscapeHTMLStr(e.title)),n.querySelector(".b3-list-item__text").innerHTML=we(e.title))}onMove(e){const n=this.element.querySelector(`ul[data-url="${e.data.fromNotebook}"] li[data-path="${e.data.fromPath}"]`);if(n)if(n.nextElementSibling&&n.nextElementSibling.tagName==="UL"&&n.nextElementSibling.remove(),n.parentElement.childElementCount===1){if(n.parentElement.previousElementSibling){n.parentElement.previousElementSibling.querySelector(".b3-list-item__toggle").classList.add("fn__hidden"),n.parentElement.previousElementSibling.querySelector(".b3-list-item__arrow").classList.remove("b3-list-item__arrow--open");const i=n.parentElement.previousElementSibling.querySelector(".b3-list-item__icon");i.innerHTML===ie(p.Constants.SIYUAN_IMAGE_FOLDER)&&(i.innerHTML=ie(p.Constants.SIYUAN_IMAGE_FILE))}n.parentElement.remove()}else n.remove();const a=this.element.querySelector(`[data-url="${e.data.toNotebook}"] li[data-path="${e.data.toPath}"]`);if(a){a.querySelector(".b3-list-item__toggle").classList.remove("fn__hidden");const i=a.querySelector(".b3-list-item__icon");i.innerHTML===ie(p.Constants.SIYUAN_IMAGE_FILE)&&(i.innerHTML=ie(p.Constants.SIYUAN_IMAGE_FOLDER));const s=a.querySelector(".b3-list-item__arrow");s.classList.contains("b3-list-item__arrow--open")&&(s.classList.remove("b3-list-item__arrow--open"),a.nextElementSibling&&a.nextElementSibling.tagName==="UL"&&a.nextElementSibling.remove(),e.callback!==p.Constants.CB_MOVE_NOLIST&&this.getLeaf(a,e.data.toNotebook))}}onLsHTML(e,n){let a="";if(e.files.forEach(o=>{a+=this.genFileHTML(o)}),a==="")return;const i=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);if(!i)return;let s=i.nextElementSibling;s&&s.tagName==="UL"&&s.remove(),i.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),i.insertAdjacentHTML("afterend",`<ul class="file-tree__sliderDown">${a}</ul>`),s=i.nextElementSibling,setTimeout(()=>{s.setAttribute("style",`top: -1px;position: relative;height:${s.childElementCount*(i.clientHeight+1)-1}px;`),setTimeout(()=>{this.element.querySelectorAll(".file-tree__sliderDown").forEach(o=>{o.classList.remove("file-tree__sliderDown"),o.removeAttribute("style")}),typeof n=="number"&&this.element.scroll({top:n,behavior:"smooth"})},120)},2)}onLsSelect(e,n){let a="";if(e.files.forEach(s=>{a+=this.genFileHTML(s),n===s.path?this.selectItem(e.box,n):n.startsWith(s.path.replace(".sy",""))&&w("/api/filetree/listDocsByPath",{notebook:e.box,path:s.path},o=>{this.selectItem(o.data.box,n,o.data)})}),a==="")return;const i=this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${e.path}"]`);i.nextElementSibling&&i.nextElementSibling.tagName==="UL"&&i.nextElementSibling.remove(),i.querySelector(".b3-list-item__arrow").classList.add("b3-list-item__arrow--open"),i.insertAdjacentHTML("afterend",`<ul>${a}</ul>`),this.setCurrent(this.element.querySelector(`ul[data-url="${e.box}"] li[data-path="${n}"]`))}setCurrent(e,n=!0){if(e&&(this.element.querySelectorAll("li").forEach(a=>{a.classList.remove("b3-list-item--focus")}),e.classList.add("b3-list-item--focus"),n)){let a=e.offsetTop;e.parentElement.classList.contains("file-tree__sliderDown")&&e.offsetParent&&(a=e.offsetParent.offsetTop),this.element.scrollTop=a-this.element.clientHeight/2-this.actionsElement.clientHeight}}getLeaf(e,n){const a=e.querySelector(".b3-list-item__arrow");if(a.classList.contains("b3-list-item__arrow--open")){a.classList.remove("b3-list-item__arrow--open"),e.nextElementSibling?.remove();return}w("/api/filetree/listDocsByPath",{notebook:n,path:e.getAttribute("data-path")},i=>{if(i.data.path==="/"&&i.data.files.length===0){M(window.siyuan.languages.emptyContent);return}this.onLsHTML(i.data)})}selectItem(e,n,a){const i=this.element.querySelector(`[data-url="${e}"]`);if(!i)return;let s=n,o;for(;!o;)if(o=i.querySelector(`[data-path="${s}"]`),!o){const l=Le().dirname(s);l==="/"?s=l:s=l+".sy"}if(o.getAttribute("data-path")===n){this.setCurrent(o);return}a&&a.path===s?this.onLsSelect(a,n):w("/api/filetree/listDocsByPath",{notebook:e,path:s},l=>{this.onLsSelect(l.data,n)})}initMoreMenu(){if(window.siyuan.menus.menu.remove(),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new S({icon:"iconFilesRoot",label:window.siyuan.languages.newNotebook,click:()=>{Jp()}}).element),window.siyuan.menus.menu.append(new S({icon:"iconRefresh",label:window.siyuan.languages.rebuildIndex,click:()=>{this.element.getAttribute("disabled")||(this.element.setAttribute("disabled","disabled"),w("/api/filetree/refreshFiletree",{},()=>{this.element.removeAttribute("disabled"),this.init(!1)}))}}).element),!window.siyuan.config.readonly){const e=ah("notebooks",window.siyuan.config.fileTree.sort,n=>{window.siyuan.config.fileTree.sort=n,w("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:window.siyuan.config.fileTree.alwaysSelectOpenedFile,refCreateSavePath:window.siyuan.config.fileTree.refCreateSavePath,docCreateSavePath:window.siyuan.config.fileTree.docCreateSavePath,openFilesUseCurrentTab:window.siyuan.config.fileTree.openFilesUseCurrentTab,maxListCount:window.siyuan.config.fileTree.maxListCount},()=>{ha(()=>{this.init(!1)})})});window.siyuan.menus.menu.append(new S({icon:"iconSort",label:window.siyuan.languages.sort,type:"submenu",submenu:e}).element)}return window.siyuan.menus.menu}}const Ai=()=>{if(!(0,I.FJ)())return;const t=[];Pr(window.siyuan.layout.layout,t),t.forEach(async e=>{const n=e.headersElement.parentElement,a=n.getBoundingClientRect(),i=n.querySelector(".item--readonly .fn__flex-1");a.top<=0?(i.style.height=i.parentElement.clientHeight+"px",i.style.WebkitAppRegion="drag"):i.style.WebkitAppRegion="";const s=n.lastElementChild;if(window.siyuan.config.system.os==="darwin"){const o=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"isFullScreen"});a.top<=0&&a.left<=0&&!o?(e.headersElement.style.marginLeft="var(--b3-toolbar-left-mac)",s.style.paddingRight="42px"):(e.headersElement.style.marginLeft="",s.style.paddingRight="")}a.top<=0&&a.right+8>=window.innerWidth?s.style.paddingRight=42*(window.siyuan.config.system.os==="darwin"?1:4)+"px":s.style.paddingRight=""})},au=()=>{if(!(0,I.FJ)())return;let t="";Yn().forEach(e=>{if(e.model)e.model instanceof dt?t+=e.model.editor.protyle.block.rootID+p.Constants.ZWSP:e.model instanceof zn&&(t+=e.model.path+p.Constants.ZWSP);else{const n=e.headElement.getAttribute("data-initdata");if(n){const a=JSON.parse(n);a.instance==="Editor"&&(t+=a.rootId+p.Constants.ZWSP)}}}),window.location.hash=t},$o="auto",iu=1,ih=1.1,su=.1,ou=10,lu=0,v_=1.25,sh=40,oh=5,Re={INITIAL:0,RUNNING:1,PAUSED:2,FINISHED:3},Ot={UNKNOWN:0,NORMAL:1,CHANGING:2,FULLSCREEN:3},Ie={UNKNOWN:-1,NONE:0,THUMBS:1,OUTLINE:2,ATTACHMENTS:3,LAYERS:4},br=typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC")?{CANVAS:"canvas",SVG:"svg"}:null,wr={DISABLE:0,ENABLE:1},Ce={UNKNOWN:-1,VERTICAL:0,HORIZONTAL:1,WRAPPED:2,PAGE:3},pt={UNKNOWN:-1,NONE:0,ODD:1,EVEN:2},nn={SELECT:0,HAND:1,ZOOM:2},E_=/\bprint\s*\(/;class lh{constructor(){const e=window.devicePixelRatio||1;this.sx=e,this.sy=e}get scaled(){return this.sx!==1||this.sy!==1}}function ru(t,e,n=!1){let a=t.offsetParent;if(!a){console.error("offsetParent is not set -- cannot scroll");return}let i=t.offsetTop+t.clientTop,s=t.offsetLeft+t.clientLeft;for(;a.clientHeight===a.scrollHeight&&a.clientWidth===a.scrollWidth||n&&(a.classList.contains("markedContent")||getComputedStyle(a).overflow==="hidden");)if(i+=a.offsetTop,s+=a.offsetLeft,a=a.offsetParent,!a)return;e&&(e.top!==void 0&&(i+=e.top),e.left!==void 0&&(s+=e.left,a.scrollLeft=s)),a.scrollTop=i}function rh(t,e){const n=function(s){i||(i=window.requestAnimationFrame(function(){i=null;const l=t.scrollLeft,r=a.lastX;l!==r&&(a.right=l>r),a.lastX=l;const c=t.scrollTop,d=a.lastY;c!==d&&(a.down=c>d),a.lastY=c,e(a)}))},a={right:!0,down:!0,lastX:t.scrollLeft,lastY:t.scrollTop,_eventHandler:n};let i=null;return t.addEventListener("scroll",n,!0),a}function yr(t){const e=new Map;for(const[n,a]of new URLSearchParams(t))e.set(n.toLowerCase(),a);return e}const k_=/[\x01-\x1F]/g;function ch(t,e=!1){return typeof t!="string"?(console.error("The argument must be a string."),t):(e&&(t=t.replaceAll(k_," ")),t.replaceAll("\0",""))}function Po(t,e,n=0){let a=n,i=t.length-1;if(i<0||!e(t[i]))return t.length;if(e(t[a]))return a;for(;a<i;){const s=a+i>>1,o=t[s];e(o)?i=s:a=s+1}return a}function dh(t){if(Math.floor(t)===t)return[t,1];const e=1/t,n=8;if(e>n)return[1,n];if(Math.floor(e)===e)return[1,e];const a=t>1?e:t;let i=0,s=1,o=1,l=1;for(;;){const c=i+o,d=s+l;if(d>n)break;a<=c/d?(o=c,l=d):(i=c,s=d)}let r;return a-i/s<o/l-a?r=a===t?[i,s]:[s,i]:r=a===t?[o,l]:[l,o],r}function _r(t,e){const n=t%e;return n===0?t:Math.round(t-n+e)}function S_({view:t,userUnit:e,rotate:n}){const[a,i,s,o]=t,l=n%180!==0,r=(s-a)/72*e,c=(o-i)/72*e;return{width:l?c:r,height:l?r:c}}function L_(t,e,n){if(t<2)return t;let a=e[t].div,i=a.offsetTop+a.clientTop;i>=n&&(a=e[t-1].div,i=a.offsetTop+a.clientTop);for(let s=t-2;s>=0&&(a=e[s].div,!(a.offsetTop+a.clientTop+a.clientHeight<=i));--s)t=s;return t}function uh({scrollEl:t,views:e,sortByVisibility:n=!1,horizontal:a=!1,rtl:i=!1}){const s=t.scrollTop,o=s+t.clientHeight,l=t.scrollLeft,r=l+t.clientWidth;function c(_){const v=_.div;return v.offsetTop+v.clientTop+v.clientHeight>s}function d(_){const v=_.div,k=v.offsetLeft+v.clientLeft,L=k+v.clientWidth;return i?k<r:L>l}const u=[],f=new Set,g=e.length;let h=Po(e,a?d:c);h>0&&h<g&&!a&&(h=L_(h,e,s));let m=a?r:-1;for(let _=h;_<g;_++){const v=e[_],k=v.div,L=k.offsetLeft+k.clientLeft,C=k.offsetTop+k.clientTop,E=k.clientWidth,T=k.clientHeight,H=L+E,D=C+T;if(m===-1)D>=o&&(m=D);else if((a?L:C)>m)break;if(D<=s||C>=o||H<=l||L>=r)continue;const U=Math.max(0,s-C)+Math.max(0,D-o),ye=Math.max(0,l-L)+Math.max(0,H-r),Fe=(T-U)/T,xe=(E-ye)/E,je=Fe*xe*100|0;u.push({id:v.id,x:L,y:C,view:v,percent:je,widthPercent:xe*100|0}),f.add(v.id)}const b=u[0],y=u.at(-1);return n&&u.sort(function(_,v){const k=_.percent-v.percent;return Math.abs(k)>.001?-k:_.id-v.id}),{first:b,last:y,views:u,ids:f}}function C_(t){t.preventDefault()}function fh(t){let e=Math.hypot(t.deltaX,t.deltaY);const n=Math.atan2(t.deltaY,t.deltaX);return-.25*Math.PI<n&&n<.75*Math.PI&&(e=-e),e}function x_(t){const e=t.deltaMode;let n=fh(t);const a=30,i=30;return e===WheelEvent.DOM_DELTA_PIXEL?n/=a*i:e===WheelEvent.DOM_DELTA_LINE&&(n/=i),n}function vr(t){return Number.isInteger(t)&&t%90===0}function ph(t){return Number.isInteger(t)&&Object.values(Ce).includes(t)&&t!==Ce.UNKNOWN}function gh(t){return Number.isInteger(t)&&Object.values(pt).includes(t)&&t!==pt.UNKNOWN}function cu(t){return t.width<=t.height}const hh=new Promise(function(t){if(typeof PDFJSDev<"u"&&PDFJSDev.test("LIB")&&typeof window>"u"){setTimeout(t,20);return}window.requestAnimationFrame(t)}),du=typeof PDFJSDev<"u"&&PDFJSDev.test("LIB")&&typeof document>"u"?null:document.documentElement.style;function A_(t,e,n){return Math.min(Math.max(t,e),n)}class T_{constructor(e){B(this,ei,null);B(this,Oi,null);B(this,Ri,0);B(this,$s,null);B(this,Bi,!0);oe(this,ei,e.classList),oe(this,$s,e.style)}get percent(){return P(this,Ri)}set percent(e){if(oe(this,Ri,A_(e,0,100)),isNaN(e)){P(this,ei).add("indeterminate");return}P(this,ei).remove("indeterminate"),P(this,$s).setProperty("--progressBar-percent",`${P(this,Ri)}%`)}setWidth(e){if(!e)return;const a=e.parentNode.offsetWidth-e.offsetWidth;a>0&&P(this,$s).setProperty("--progressBar-end-offset",`${a}px`)}setDisableAutoFetch(e=5e3){isNaN(P(this,Ri))||(P(this,Oi)&&clearTimeout(P(this,Oi)),this.show(),oe(this,Oi,setTimeout(()=>{oe(this,Oi,null),this.hide()},e)))}hide(){P(this,Bi)&&(oe(this,Bi,!1),P(this,ei).add("fn__hidden"),du.setProperty("--progressBar-percent","0"))}show(){P(this,Bi)||(oe(this,Bi,!0),P(this,ei).remove("fn__hidden"))}}ei=new WeakMap,Oi=new WeakMap,Ri=new WeakMap,$s=new WeakMap,Bi=new WeakMap;function I_(){let t=document,e=t.activeElement||t.querySelector(":focus");for(;e?.shadowRoot;)t=e.shadowRoot,e=t.activeElement||t.querySelector(":focus");return e}function mh(t){let e=Ce.VERTICAL,n=pt.NONE;switch(t){case"SinglePage":e=Ce.PAGE;break;case"OneColumn":break;case"TwoPageLeft":e=Ce.PAGE;case"TwoColumnLeft":n=pt.ODD;break;case"TwoPageRight":e=Ce.PAGE;case"TwoColumnRight":n=pt.EVEN;break}return{scrollMode:e,spreadMode:n}}function D_(t){switch(t){case"UseNone":return Ie.NONE;case"UseThumbs":return Ie.THUMBS;case"UseOutlines":return Ie.OUTLINE;case"UseAttachments":return Ie.ATTACHMENTS;case"UseOC":return Ie.LAYERS}return Ie.NONE}const $_="noopener noreferrer nofollow",Aa={NONE:0,SELF:1,BLANK:2,PARENT:3,TOP:4};function bh(t,{url:e,target:n,rel:a,enabled:i=!0}={}){if(!e||typeof e!="string")throw new Error('A valid "url" parameter must provided.');const s=ch(e);i?t.href=t.title=s:(t.href="",t.title=`Disabled: ${s}`,t.onclick=()=>!1);let o="";switch(n){case Aa.NONE:break;case Aa.SELF:o="_self";break;case Aa.BLANK:o="_blank";break;case Aa.PARENT:o="_parent";break;case Aa.TOP:o="_top";break}t.target=o,t.rel=typeof a=="string"?a:$_}const Ju=class{constructor({eventBus:e,externalLinkTarget:n=null,externalLinkRel:a=null,ignoreDestinationZoom:i=!1}={}){B(this,Go);B(this,Ps,new Map);this.eventBus=e,this.externalLinkTarget=n,this.externalLinkRel=a,this.externalLinkEnabled=!0,this._ignoreDestinationZoom=i,this.baseUrl=null,this.pdfDocument=null,this.pdfViewer=null,this.pdfHistory=null}setDocument(e,n=null){this.baseUrl=n,this.pdfDocument=e,P(this,Ps).clear()}setViewer(e){this.pdfViewer=e}setHistory(e){this.pdfHistory=e}get pagesCount(){return this.pdfDocument?this.pdfDocument.numPages:0}get page(){return this.pdfViewer.currentPageNumber}set page(e){this.pdfViewer.currentPageNumber=e}get rotation(){return this.pdfViewer.pagesRotation}set rotation(e){this.pdfViewer.pagesRotation=e}get isInPresentationMode(){return this.pdfViewer.isInPresentationMode}async goToDestination(e){if(!this.pdfDocument)return;let n,a;if(typeof e=="string"?(n=e,a=await this.pdfDocument.getDestination(e)):(n=null,a=await e),!Array.isArray(a)){console.error(`PDFLinkService.goToDestination: "${a}" is not a valid destination array, for dest="${e}".`);return}N(this,Go,tf).call(this,e,n,a)}goToPage(e){if(!this.pdfDocument)return;const n=typeof e=="string"&&this.pdfViewer.pageLabelToPageNumber(e)||e|0;if(!(Number.isInteger(n)&&n>0&&n<=this.pagesCount)){console.error(`PDFLinkService.goToPage: "${e}" is not a valid page.`);return}this.pdfHistory&&(this.pdfHistory.pushCurrentPosition(),this.pdfHistory.pushPage(n)),this.pdfViewer.scrollPageIntoView({pageNumber:n})}addLinkAttributes(e,n,a=!1){bh(e,{url:n,target:a?Aa.BLANK:this.externalLinkTarget,rel:this.externalLinkRel,enabled:this.externalLinkEnabled})}getDestinationHash(e){if(typeof e=="string"){if(e.length>0)return this.getAnchorUrl("#"+escape(e))}else if(Array.isArray(e)){const n=JSON.stringify(e);if(n.length>0)return this.getAnchorUrl("#"+escape(n))}return this.getAnchorUrl("")}getAnchorUrl(e){return this.baseUrl?this.baseUrl+e:e}setHash(e){var i;if(!this.pdfDocument)return;let n,a;if(e.includes("=")){const s=yr(e);if(s.has("search")&&this.eventBus.dispatch("findfromurlhash",{source:this,query:s.get("search").replaceAll('"',""),phraseSearch:s.get("phrase")==="true"}),s.has("page")&&(n=s.get("page")|0||1),s.has("zoom")){const o=s.get("zoom").split(","),l=o[0],r=parseFloat(l);l.includes("Fit")?l==="Fit"||l==="FitB"?a=[null,{name:l}]:l==="FitH"||l==="FitBH"||l==="FitV"||l==="FitBV"?a=[null,{name:l},o.length>1?o[1]|0:null]:l==="FitR"?o.length!==5?console.error('PDFLinkService.setHash: Not enough parameters for "FitR".'):a=[null,{name:l},o[1]|0,o[2]|0,o[3]|0,o[4]|0]:console.error(`PDFLinkService.setHash: "${l}" is not a valid zoom value.`):a=[null,{name:"XYZ"},o.length>1?o[1]|0:null,o.length>2?o[2]|0:null,r?r/100:l]}a?this.pdfViewer.scrollPageIntoView({pageNumber:n||this.page,destArray:a,allowNegativeOffset:!0}):n&&(this.page=n),s.has("pagemode")&&this.eventBus.dispatch("pagemode",{source:this,mode:s.get("pagemode")}),s.has("nameddest")&&this.goToDestination(s.get("nameddest"))}else{a=unescape(e);try{a=JSON.parse(a),Array.isArray(a)||(a=a.toString())}catch{}if(typeof a=="string"||N(i=Ju,zr,Bb).call(i,a)){this.goToDestination(a);return}console.error(`PDFLinkService.setHash: "${unescape(e)}" is not a valid destination.`)}}executeNamedAction(e){switch(e){case"GoBack":this.pdfHistory?.back();break;case"GoForward":this.pdfHistory?.forward();break;case"NextPage":this.pdfViewer.nextPage();break;case"PrevPage":this.pdfViewer.previousPage();break;case"LastPage":this.page=this.pagesCount;break;case"FirstPage":this.page=1;break;default:break}this.eventBus.dispatch("namedaction",{source:this,action:e})}async executeSetOCGState(e){const n=this.pdfDocument,a=await this.pdfViewer.optionalContentConfigPromise;if(n!==this.pdfDocument)return;let i;for(const s of e.state){switch(s){case"ON":case"OFF":case"Toggle":i=s;continue}switch(i){case"ON":a.setVisibility(s,!0);break;case"OFF":a.setVisibility(s,!1);break;case"Toggle":const o=a.getGroup(s);o&&a.setVisibility(s,!o.visible);break}}this.pdfViewer.optionalContentConfigPromise=Promise.resolve(a)}cachePageRef(e,n){if(!n)return;const a=n.gen===0?`${n.num}R`:`${n.num}R${n.gen}`;P(this,Ps).set(a,e)}_cachedPageNumber(e){if(!e)return null;const n=e.gen===0?`${e.num}R`:`${e.num}R${e.gen}`;return P(this,Ps).get(n)||null}isPageVisible(e){return this.pdfViewer.isPageVisible(e)}isPageCached(e){return this.pdfViewer.isPageCached(e)}};let Er=Ju;Ps=new WeakMap,Go=new WeakSet,tf=function(e,n=null,a){const i=a[0];let s;if(typeof i=="object"&&i!==null){if(s=this._cachedPageNumber(i),!s){this.pdfDocument.getPageIndex(i).then(o=>{this.cachePageRef(o+1,i),N(this,Go,tf).call(this,e,n,a)}).catch(()=>{console.error(`PDFLinkService.#goToDestinationHelper: "${i}" is not a valid page reference, for dest="${e}".`)});return}}else if(Number.isInteger(i))s=i+1;else{console.error(`PDFLinkService.#goToDestinationHelper: "${i}" is not a valid destination reference, for dest="${e}".`);return}if(!s||s<1||s>this.pagesCount){console.error(`PDFLinkService.#goToDestinationHelper: "${s}" is not a valid page number, for dest="${e}".`);return}this.pdfHistory&&(this.pdfHistory.pushCurrentPosition(),this.pdfHistory.push({namedDest:n,explicitDest:a,pageNumber:s})),this.pdfViewer.scrollPageIntoView({pageNumber:s,destArray:a,ignoreDestinationZoom:this._ignoreDestinationZoom})},zr=new WeakSet,Bb=function(e){if(!Array.isArray(e))return!1;const n=e.length;if(n<2)return!1;const a=e[0];if(!(typeof a=="object"&&Number.isInteger(a.num)&&Number.isInteger(a.gen))&&!(Number.isInteger(a)&&a>=0))return!1;const i=e[1];if(!(typeof i=="object"&&typeof i.name=="string"))return!1;let s=!0;switch(i.name){case"XYZ":if(n!==5)return!1;break;case"Fit":case"FitB":return n===2;case"FitH":case"FitBH":case"FitV":case"FitBV":if(n!==3)return!1;break;case"FitR":if(n!==6)return!1;s=!1;break;default:return!1}for(let o=2;o<n;o++){const l=e[o];if(!(typeof l=="number"||s&&l===null))return!1}return!0},B(Er,zr);class wh{constructor(){this.externalLinkEnabled=!0}get pagesCount(){return 0}get page(){return 0}set page(e){}get rotation(){return 0}set rotation(e){}get isInPresentationMode(){return!1}async goToDestination(e){}goToPage(e){}addLinkAttributes(e,n,a=!1){bh(e,{url:n,enabled:this.externalLinkEnabled})}getDestinationHash(e){return"#"}getAnchorUrl(e){return"#"}setHash(e){}executeNamedAction(e){}executeSetOCGState(e){}cachePageRef(e,n){}isPageVisible(e){return!0}isPageCached(e){return!0}}var j=Ye(272);const kr=Object.create(null);if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")){typeof PDFJSDev<"u"&&PDFJSDev.test("LIB")&&typeof navigator>"u"&&(globalThis.navigator=Object.create(null));const t=navigator.userAgent||"",e=navigator.platform||"",n=navigator.maxTouchPoints||1,a=/Android/.test(t),i=/\b(iPad|iPhone|iPod)(?=;)/.test(t)||e==="MacIntel"&&n>1;(function(){(i||a)&&(kr.maxCanvasPixels=5242880)})()}const ne={VIEWER:2,API:4,WORKER:8,PREFERENCE:128},Wn={annotationEditorMode:{value:0,kind:ne.VIEWER+ne.PREFERENCE},annotationMode:{value:2,kind:ne.VIEWER+ne.PREFERENCE},cursorToolOnLoad:{value:0,kind:ne.VIEWER+ne.PREFERENCE},defaultZoomDelay:{value:400,kind:ne.VIEWER+ne.PREFERENCE},defaultZoomValue:{value:"",kind:ne.VIEWER+ne.PREFERENCE},disableHistory:{value:!1,kind:ne.VIEWER},disablePageLabels:{value:!1,kind:ne.VIEWER+ne.PREFERENCE},enablePermissions:{value:!1,kind:ne.VIEWER+ne.PREFERENCE},enablePrintAutoRotate:{value:!0,kind:ne.VIEWER+ne.PREFERENCE},enableScripting:{value:typeof PDFJSDev>"u"||!PDFJSDev.test("CHROME"),kind:ne.VIEWER+ne.PREFERENCE},externalLinkRel:{value:"noopener noreferrer nofollow",kind:ne.VIEWER},externalLinkTarget:{value:0,kind:ne.VIEWER+ne.PREFERENCE},historyUpdateUrl:{value:!1,kind:ne.VIEWER+ne.PREFERENCE},ignoreDestinationZoom:{value:!1,kind:ne.VIEWER+ne.PREFERENCE},imageResourcesPath:{value:"./images/",kind:ne.VIEWER},maxCanvasPixels:{value:16777216,kind:ne.VIEWER},forcePageColors:{value:!1,kind:ne.VIEWER+ne.PREFERENCE},pageColorsBackground:{value:"Canvas",kind:ne.VIEWER+ne.PREFERENCE},pageColorsForeground:{value:"CanvasText",kind:ne.VIEWER+ne.PREFERENCE},pdfBugEnabled:{value:typeof PDFJSDev>"u"||!PDFJSDev.test("PRODUCTION"),kind:ne.VIEWER+ne.PREFERENCE},printResolution:{value:150,kind:ne.VIEWER},sidebarViewOnLoad:{value:-1,kind:ne.VIEWER+ne.PREFERENCE},scrollModeOnLoad:{value:-1,kind:ne.VIEWER+ne.PREFERENCE},spreadModeOnLoad:{value:-1,kind:ne.VIEWER+ne.PREFERENCE},textLayerMode:{value:1,kind:ne.VIEWER+ne.PREFERENCE},useOnlyCssZoom:{value:!1,kind:ne.VIEWER+ne.PREFERENCE},viewerCssTheme:{value:typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")?2:0,kind:ne.VIEWER+ne.PREFERENCE},viewOnLoad:{value:0,kind:ne.VIEWER+ne.PREFERENCE},cMapPacked:{value:!0,kind:ne.API},cMapUrl:{value:"cmaps/",kind:ne.API},disableAutoFetch:{value:!1,kind:ne.API+ne.PREFERENCE},disableFontFace:{value:!1,kind:ne.API+ne.PREFERENCE},disableRange:{value:!1,kind:ne.API+ne.PREFERENCE},disableStream:{value:!1,kind:ne.API+ne.PREFERENCE},docBaseUrl:{value:"",kind:ne.API},enableXfa:{value:!0,kind:ne.API+ne.PREFERENCE},fontExtraProperties:{value:!1,kind:ne.API},isEvalSupported:{value:!0,kind:ne.API},isOffscreenCanvasSupported:{value:!0,kind:ne.API},maxImageSize:{value:-1,kind:ne.API},pdfBug:{value:!1,kind:ne.API},standardFontDataUrl:{value:"standard_fonts/",kind:ne.API},verbosity:{value:1,kind:ne.API},workerPort:{value:null,kind:ne.WORKER},workerSrc:{value:`${p.Constants.PROTYLE_CDN}/js/pdf/pdf.worker.js?v=3.5.141`,kind:ne.WORKER}};typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC")?(Wn.defaultUrl={value:"compressed.tracemonkey-pldi-09.pdf",kind:ne.VIEWER},Wn.disablePreferences={value:typeof PDFJSDev<"u"&&PDFJSDev.test("TESTING"),kind:ne.VIEWER},Wn.locale={value:navigator.language||"en-US",kind:ne.VIEWER},Wn.renderer={value:"canvas",kind:ne.VIEWER+ne.PREFERENCE},Wn.sandboxBundleSrc={value:typeof PDFJSDev>"u"||!PDFJSDev.test("PRODUCTION")?"../build/dev-sandbox/pdf.sandbox.js":"../build/pdf.sandbox.js",kind:ne.VIEWER}):PDFJSDev.test("CHROME")&&(Wn.defaultUrl={value:"",kind:ne.VIEWER},Wn.disableTelemetry={value:!1,kind:ne.VIEWER+ne.PREFERENCE},Wn.sandboxBundleSrc={value:"../build/pdf.sandbox.js",kind:ne.VIEWER});const vs=Object.create(null);class ge{constructor(){throw new Error("Cannot initialize AppOptions.")}static get(e){const n=vs[e];if(n!==void 0)return n;const a=Wn[e];if(a!==void 0)return kr[e]??a.value}static getAll(e=null){const n=Object.create(null);for(const a in Wn){const i=Wn[a];if(e){if(!(e&i.kind))continue;if(e===ne.PREFERENCE){const o=i.value,l=typeof o;if(l==="boolean"||l==="string"||l==="number"&&Number.isInteger(o)){n[a]=o;continue}throw new Error(`Invalid type for preference: ${a}`)}}const s=vs[a];n[a]=s!==void 0?s:kr[a]??i.value}return n}static set(e,n){vs[e]=n}static setAll(e){for(const n in e)vs[n]=e[n]}static remove(e){delete vs[e]}}(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(ge._hasUserOptions=function(){return Object.keys(vs).length>0});const yh={EVENT:"event",TIMEOUT:"timeout"};function _h({target:t,name:e,delay:n=0}){return new Promise(function(a,i){if(typeof t!="object"||!(e&&typeof e=="string")||!(Number.isInteger(n)&&n>=0))throw new Error("waitOnEventOrTimeout - invalid parameters.");function s(c){t instanceof Sr?t._off(e,o):t.removeEventListener(e,o),r&&clearTimeout(r),a(c)}const o=s.bind(null,yh.EVENT);t instanceof Sr?t._on(e,o):t.addEventListener(e,o);const l=s.bind(null,yh.TIMEOUT),r=setTimeout(l,n)})}class Sr{constructor(){B(this,Ms,Object.create(null))}on(e,n,a=null){this._on(e,n,{external:!0,once:a?.once})}off(e,n,a=null){this._off(e,n,{external:!0,once:a?.once})}dispatch(e,n){const a=P(this,Ms)[e];if(!a||a.length===0)return;let i;for(const{listener:s,external:o,once:l}of a.slice(0)){if(l&&this._off(e,s),o){(i||=[]).push(s);continue}s(n)}if(i){for(const s of i)s(n);i=null}}_on(e,n,a=null){(P(this,Ms)[e]||=[]).push({listener:n,external:a?.external===!0,once:a?.once===!0})}_off(e,n,a=null){const i=P(this,Ms)[e];if(i){for(let s=0,o=i.length;s<o;s++)if(i[s].listener===n){i.splice(s,1);return}}}}Ms=new WeakMap;class P_ extends Sr{dispatch(e,n){if(typeof PDFJSDev<"u"&&!PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: AutomationEventBus.dispatch");super.dispatch(e,n);const a=Object.create(null);if(n)for(const s in n){const o=n[s];if(s==="source"){if(o===window||o===document)return;continue}a[s]=o}const i=document.createEvent("CustomEvent");i.initCustomEvent(e,!0,!0,a),document.dispatchEvent(i)}}class M_{constructor(e,n){B(this,Yr);this.eventBus=n,N(this,Yr,qb).call(this,e)}}Yr=new WeakSet,qb=function({editorFreeTextFontSize:e,editorFreeTextColor:n,editorInkColor:a,editorInkThickness:i,editorInkOpacity:s}){e.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:j.AnnotationEditorParamsType.FREETEXT_SIZE,value:e.valueAsNumber})}),n.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:j.AnnotationEditorParamsType.FREETEXT_COLOR,value:n.value})}),a.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:j.AnnotationEditorParamsType.INK_COLOR,value:a.value})}),i.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:j.AnnotationEditorParamsType.INK_THICKNESS,value:i.valueAsNumber})}),s.addEventListener("input",o=>{this.eventBus.dispatch("switchannotationeditorparams",{source:this,type:j.AnnotationEditorParamsType.INK_OPACITY,value:s.valueAsNumber})}),this.eventBus._on("annotationeditorparamschanged",o=>{for(const[l,r]of o.details)switch(l){case j.AnnotationEditorParamsType.FREETEXT_SIZE:e.value=r;break;case j.AnnotationEditorParamsType.FREETEXT_COLOR:n.value=r;break;case j.AnnotationEditorParamsType.INK_COLOR:a.value=r;break;case j.AnnotationEditorParamsType.INK_THICKNESS:i.value=r;break;case j.AnnotationEditorParamsType.INK_OPACITY:s.value=r;break}})};class N_{constructor(){B(this,ua,new WeakMap);B(this,En,null)}get active(){return P(this,En)}async register(e,n=!1){if(typeof e!="object")throw new Error("Not enough parameters.");if(P(this,ua).has(e))throw new Error("The overlay is already registered.");P(this,ua).set(e,{canForceClose:n}),e.addEventListener("cancel",a=>{oe(this,En,null)})}async unregister(e){if(P(this,ua).has(e)){if(P(this,En)===e)throw new Error("The overlay cannot be removed while it is active.")}else throw new Error("The overlay does not exist.");P(this,ua).delete(e)}async open(e){if(P(this,ua).has(e)){if(P(this,En)){if(P(this,En)===e)throw new Error("The overlay is already active.");if(P(this,ua).get(e).canForceClose)await this.close();else throw new Error("Another overlay is currently active.")}}else throw new Error("The overlay does not exist.");oe(this,En,e),e.classList.add("dialog--open")}async close(e=P(this,En)){if(P(this,ua).has(e))if(P(this,En)){if(P(this,En)!==e)throw new Error("Another overlay is currently active.")}else throw new Error("The overlay is currently not active.");else throw new Error("The overlay does not exist.");e.classList.remove("dialog--open"),oe(this,En,null)}}ua=new WeakMap,En=new WeakMap;class H_{constructor(e,n,a,i=!1){B(this,Ko);B(this,Gr);B(this,Zo);B(this,fa,null);B(this,qi,null);B(this,jo,null);this.dialog=e.dialog,this.label=e.label,this.input=e.input,this.submitButton=e.submitButton,this.cancelButton=e.cancelButton,this.overlayManager=n,this.l10n=a,this._isViewerEmbedded=i,this.submitButton.addEventListener("click",N(this,Ko,nf).bind(this)),this.cancelButton.addEventListener("click",this.close.bind(this)),this.input.addEventListener("keydown",s=>{s.keyCode===13&&N(this,Ko,nf).call(this)}),this.overlayManager.register(this.dialog,!0),this.dialog.addEventListener("close",N(this,Gr,Fb).bind(this))}async open(){P(this,fa)&&await P(this,fa).promise,oe(this,fa,(0,j.createPromiseCapability)());try{await this.overlayManager.open(this.dialog)}catch(n){throw oe(this,fa,null),n}const e=P(this,jo)===j.PasswordResponses.INCORRECT_PASSWORD;(!this._isViewerEmbedded||e)&&this.input.focus(),this.label.textContent=window.siyuan.languages[`password_${e?"invalid":"label"}`]}async close(){this.overlayManager.active===this.dialog&&this.overlayManager.close(this.dialog)}async setUpdateCallback(e,n){P(this,fa)&&await P(this,fa).promise,oe(this,qi,e),oe(this,jo,n)}}fa=new WeakMap,qi=new WeakMap,jo=new WeakMap,Ko=new WeakSet,nf=function(){const e=this.input.value;e?.length>0&&N(this,Zo,af).call(this,e)},Gr=new WeakSet,Fb=function(){N(this,Zo,af).call(this,new Error("PasswordPrompt cancelled.")),P(this,fa).resolve()},Zo=new WeakSet,af=function(e){P(this,qi)&&(this.close(),this.input.value="",P(this,qi).call(this,e),oe(this,qi,null))};const O_=-100,vh="selected";class Mo{constructor(e){if(this.constructor===Mo)throw new Error("Cannot initialize BaseTreeViewer.");this.container=e.container,this.eventBus=e.eventBus,this.reset()}reset(){this._pdfDocument=null,this._lastToggleIsShow=!0,this._currentTreeItem=null,this.container.textContent="",this.container.classList.remove("treeWithDeepNesting")}_dispatchEvent(e){throw new Error("Not implemented: _dispatchEvent")}_bindLink(e,n){throw new Error("Not implemented: _bindLink")}_normalizeTextContent(e){return ch(e,!0)||"\u2013"}_addToggleButton(e,n=!1){const a=document.createElement("div");a.innerHTML='<svg><use xlink:href="#iconDown"></use></svg>',a.className="treeItemToggler",n&&a.classList.add("treeItemsHidden"),a.onclick=i=>{if(i.stopPropagation(),a.classList.toggle("treeItemsHidden"),i.shiftKey){const s=!a.classList.contains("treeItemsHidden");this._toggleTreeItem(e,s)}},e.prepend(a)}_toggleTreeItem(e,n=!1){this._lastToggleIsShow=n;for(const a of e.querySelectorAll(".treeItemToggler"))a.classList.toggle("treeItemsHidden",!n)}_toggleAllTreeItems(){this._toggleTreeItem(this.container,!this._lastToggleIsShow)}_finishRendering(e,n,a=!1){a&&(this.container.classList.add("treeWithDeepNesting"),this._lastToggleIsShow=!e.querySelector(".treeItemsHidden")),this.container.append(e),this._dispatchEvent(n)}render(e){throw new Error("Not implemented: render")}_updateCurrentTreeItem(e=null){this._currentTreeItem&&(this._currentTreeItem.classList.remove(vh),this._currentTreeItem=null),e&&(e.classList.add(vh),this._currentTreeItem=e)}_scrollToCurrentTreeItem(e){if(!e)return;let n=e.parentNode;for(;n&&n!==this.container;)n.classList.contains("treeItem")&&n.firstElementChild?.classList.remove("treeItemsHidden"),n=n.parentNode;this._updateCurrentTreeItem(e),this.container.scrollTo(e.offsetLeft,e.offsetTop+O_)}}class R_ extends Mo{constructor(n){super(n);B(this,jr);this.downloadManager=n.downloadManager,this.eventBus._on("fileattachmentannotation",N(this,jr,Ub).bind(this))}reset(n=!1){super.reset(),this._attachments=null,n||(this._renderedCapability=(0,j.createPromiseCapability)()),this._pendingDispatchEvent=!1}async _dispatchEvent(n){this._renderedCapability.resolve(),!(n===0&&!this._pendingDispatchEvent&&(this._pendingDispatchEvent=!0,await _h({target:this.eventBus,name:"annotationlayerrendered",delay:1e3}),!this._pendingDispatchEvent))&&(this._pendingDispatchEvent=!1,this.eventBus.dispatch("attachmentsloaded",{source:this,attachmentsCount:n}))}_bindLink(n,{content:a,filename:i}){n.onclick=()=>(this.downloadManager.openOrDownloadData(n,a,i),!1)}render({attachments:n,keepRenderedCapability:a=!1}){if(this._attachments&&this.reset(a),this._attachments=n||null,!n){this._dispatchEvent(0);return}const i=Object.keys(n).sort(function(l,r){return l.toLowerCase().localeCompare(r.toLowerCase())}),s=document.createDocumentFragment();let o=0;for(const l of i){const r=n[l],c=r.content,d=(0,j.getFilenameFromUrl)(r.filename,!0),u=document.createElement("div");u.className="treeItem";const f=document.createElement("a");this._bindLink(f,{content:c,filename:d}),f.textContent=this._normalizeTextContent(d),u.append(f),s.append(u),o++}this._finishRendering(s,o)}}jr=new WeakSet,Ub=function({filename:n,content:a}){const i=this._renderedCapability.promise;i.then(()=>{if(i!==this._renderedCapability.promise)return;const s=this._attachments||Object.create(null);for(const o in s)if(n===o)return;s[n]={filename:n,content:a},this.render({attachments:s,keepRenderedCapability:!0})})};const Eh="grab-to-pan-grab";class B_{constructor(e){B(this,Kr);B(this,Zr);B(this,Jr);this.element=e.element,this.document=e.element.ownerDocument,typeof e.ignoreTarget=="function"&&(this.ignoreTarget=e.ignoreTarget),this.onActiveChanged=e.onActiveChanged,this.activate=this.activate.bind(this),this.deactivate=this.deactivate.bind(this),this.toggle=this.toggle.bind(this),this._onMouseDown=N(this,Kr,Wb).bind(this),this._onMouseMove=N(this,Zr,Vb).bind(this),this._endPan=N(this,Jr,zb).bind(this);const n=this.overlay=document.createElement("div");n.className="grab-to-pan-grabbing"}activate(){this.active||(this.active=!0,this.element.addEventListener("mousedown",this._onMouseDown,!0),this.element.classList.add(Eh),this.onActiveChanged?.(!0))}deactivate(){this.active&&(this.active=!1,this.element.removeEventListener("mousedown",this._onMouseDown,!0),this._endPan(),this.element.classList.remove(Eh),this.onActiveChanged?.(!1))}toggle(){this.active?this.deactivate():this.activate()}ignoreTarget(e){return e.matches("a[href], a[href] *, input, textarea, button, button *, select, option")}}Kr=new WeakSet,Wb=function(e){if(e.button!==0||this.ignoreTarget(e.target))return;if(e.originalTarget)try{e.originalTarget.tagName}catch{return}this.scrollLeftStart=this.element.scrollLeft,this.scrollTopStart=this.element.scrollTop,this.clientXStart=e.clientX,this.clientYStart=e.clientY,this.document.addEventListener("mousemove",this._onMouseMove,!0),this.document.addEventListener("mouseup",this._endPan,!0),this.element.addEventListener("scroll",this._endPan,!0),e.preventDefault(),e.stopPropagation();const n=document.activeElement;n&&!n.contains(e.target)&&n.blur()},Zr=new WeakSet,Vb=function(e){if(this.element.removeEventListener("scroll",this._endPan,!0),!(e.buttons&1)){this._endPan();return}const n=e.clientX-this.clientXStart,a=e.clientY-this.clientYStart,i=this.scrollTopStart-a,s=this.scrollLeftStart-n;this.element.scrollTo?this.element.scrollTo({top:i,left:s,behavior:"instant"}):(this.element.scrollTop=i,this.element.scrollLeft=s),this.overlay.parentNode||document.body.append(this.overlay)},Jr=new WeakSet,zb=function(){this.element.removeEventListener("scroll",this._endPan,!0),this.document.removeEventListener("mousemove",this._onMouseMove,!0),this.document.removeEventListener("mouseup",this._endPan,!0),this.overlay.remove()};class q_{constructor({container:e,eventBus:n,cursorToolOnLoad:a=nn.SELECT}){B(this,Xr);B(this,Qr);this.container=e,this.eventBus=n,this.active=nn.SELECT,this.previouslyActive=null,this.handTool=new B_({element:this.container}),N(this,Qr,Gb).call(this),Promise.resolve().then(()=>{this.switchTool(a)})}get activeTool(){return this.active}switchTool(e){if(this.previouslyActive!==null||e===this.active)return;const n=()=>{switch(this.active){case nn.SELECT:break;case nn.HAND:this.handTool.deactivate();break;case nn.ZOOM:}};switch(e){case nn.SELECT:n();break;case nn.HAND:n(),this.handTool.activate();break;case nn.ZOOM:default:console.error(`switchTool: "${e}" is an unsupported value.`);return}this.active=e,N(this,Xr,Yb).call(this)}}Xr=new WeakSet,Yb=function(){this.eventBus.dispatch("cursortoolchanged",{source:this,tool:this.active})},Qr=new WeakSet,Gb=function(){this.eventBus._on("switchcursortool",s=>{this.switchTool(s.tool)});let e=j.AnnotationEditorType.NONE,n=Ot.NORMAL;const a=()=>{const s=this.active;this.switchTool(nn.SELECT),this.previouslyActive??=s},i=()=>{const s=this.previouslyActive;s!==null&&e===j.AnnotationEditorType.NONE&&n===Ot.NORMAL&&(this.previouslyActive=null,this.switchTool(s))};this.eventBus._on("secondarytoolbarreset",s=>{this.previouslyActive!==null&&(e=j.AnnotationEditorType.NONE,n=Ot.NORMAL,i())}),this.eventBus._on("annotationeditormodechanged",({mode:s})=>{e=s,s===j.AnnotationEditorType.NONE?i():a()}),this.eventBus._on("presentationmodechanged",({state:s})=>{n=s,s===Ot.NORMAL?i():s===Ot.FULLSCREEN&&a()})};const kh="-",Rk=null,F_={"8.5x11":"Letter","8.5x14":"Legal"},Sh={"297x420":"A3","210x297":"A4"};function uu(t,e,n){const a=e?t.width:t.height,i=e?t.height:t.width;return n[`${a}x${i}`]}class U_{constructor({dialog:e,fields:n,closeButton:a},i,s,o,l){B(this,Jo);B(this,Fi);B(this,Xo);B(this,ec);B(this,Qo);B(this,tc);B(this,Nn,null);this.dialog=e,this.fields=n,this.overlayManager=i,this.l10n=o,this._fileNameLookup=l,N(this,Jo,sf).call(this),a.addEventListener("click",this.close.bind(this)),this.overlayManager.register(this.dialog),s._on("pagechanging",r=>{this._currentPageNumber=r.pageNumber}),s._on("rotationchanging",r=>{this._pagesRotation=r.pagesRotation}),this._isNonMetricLocale=!0}async open(){await Promise.all([this.overlayManager.open(this.dialog),this._dataAvailableCapability.promise]);const e=this._currentPageNumber,n=this._pagesRotation;if(P(this,Nn)&&e===P(this,Nn)._currentPageNumber&&n===P(this,Nn)._pagesRotation){N(this,Fi,Il).call(this);return}const{info:a,contentLength:i}=await this.pdfDocument.getMetadata(),[s,o,l,r,c,d]=await Promise.all([this._fileNameLookup(),N(this,Xo,of).call(this,i),N(this,Qo,lf).call(this,a.CreationDate),N(this,Qo,lf).call(this,a.ModDate),this.pdfDocument.getPage(e).then(g=>N(this,ec,jb).call(this,S_(g),n)),N(this,tc,Kb).call(this,a.IsLinearized)]);oe(this,Nn,Object.freeze({fileName:s,fileSize:o,title:a.Title,author:a.Author,subject:a.Subject,keywords:a.Keywords,creationDate:l,modificationDate:r,creator:a.Creator,producer:a.Producer,version:a.PDFFormatVersion,pageCount:this.pdfDocument.numPages,pageSize:c,linearized:d,_currentPageNumber:e,_pagesRotation:n})),N(this,Fi,Il).call(this);const{length:u}=await this.pdfDocument.getDownloadInfo();if(i===u)return;const f=Object.assign(Object.create(null),P(this,Nn));f.fileSize=await N(this,Xo,of).call(this,u),oe(this,Nn,Object.freeze(f)),N(this,Fi,Il).call(this)}async close(){this.overlayManager.close(this.dialog)}setDocument(e){this.pdfDocument&&(N(this,Jo,sf).call(this),N(this,Fi,Il).call(this,!0)),e&&(this.pdfDocument=e,this._dataAvailableCapability.resolve())}}Nn=new WeakMap,Jo=new WeakSet,sf=function(){this.pdfDocument=null,oe(this,Nn,null),this._dataAvailableCapability=(0,j.createPromiseCapability)(),this._currentPageNumber=1,this._pagesRotation=0},Fi=new WeakSet,Il=function(e=!1){if(e||!P(this,Nn)){for(const n in this.fields)this.fields[n].textContent=kh;return}if(this.overlayManager.active===this.dialog)for(const n in this.fields){const a=P(this,Nn)[n];this.fields[n].textContent=a||a===0?a:kh}},Xo=new WeakSet,of=async function(e=0){const n=e/1024,a=n/1024;if(n)return a>=1?`${a>=1&&(+a.toPrecision(3)).toLocaleString()} MB ${e.toLocaleString()} bytes`:`${a<1&&(+n.toPrecision(3)).toLocaleString()} KB (${e.toLocaleString()} bytes`},ec=new WeakSet,jb=async function(e,n){if(!e)return;n%180!==0&&(e={width:e.height,height:e.width});const a=cu(e);let i={width:Math.round(e.width*100)/100,height:Math.round(e.height*100)/100},s={width:Math.round(e.width*25.4*10)/10,height:Math.round(e.height*25.4*10)/10},o=uu(i,a,F_)||uu(s,a,Sh);if(!o&&!(Number.isInteger(s.width)&&Number.isInteger(s.height))){const f={width:e.width*25.4,height:e.height*25.4},g={width:Math.round(s.width),height:Math.round(s.height)};Math.abs(f.width-g.width)<.1&&Math.abs(f.height-g.height)<.1&&(o=uu(g,a,Sh),o&&(i={width:Math.round(g.width/25.4*100)/100,height:Math.round(g.height/25.4*100)/100},s=g))}const[{width:l,height:r},c,d,u]=await Promise.all([this._isNonMetricLocale?i:s,this._isNonMetricLocale?window.siyuan.languages.unitInches:window.siyuan.languages.unitMillimeters,o&&window.siyuan.languages[`document_properties_page_size_name_${o.toLowerCase()}`],window.siyuan.languages[`document_properties_page_size_orientation_${a?"portrait":"landscape"}`]]);return d?`${l.toLocaleString()} \xD7 ${r.toLocaleString()} ${c} (${d}, ${u})`:`${l.toLocaleString()} \xD7 ${r.toLocaleString()} ${c} (${u})`},Qo=new WeakSet,lf=async function(e){const n=j.PDFDateString.toDateObject(e);if(n)return`${n.toLocaleDateString()}, ${n.toLocaleTimeString()}`},tc=new WeakSet,Kb=function(e){return e?"Yes":"No"};const Vn={SPACE:0,ALPHA_LETTER:1,PUNCT:2,HAN_LETTER:3,KATAKANA_LETTER:4,HIRAGANA_LETTER:5,HALFWIDTH_KATAKANA_LETTER:6,THAI_LETTER:7};function W_(t){return t<11904}function V_(t){return(t&65408)===0}function z_(t){return t>=97&&t<=122||t>=65&&t<=90}function Y_(t){return t>=48&&t<=57}function G_(t){return t===32||t===9||t===13||t===10}function j_(t){return t>=13312&&t<=40959||t>=63744&&t<=64255}function K_(t){return t>=12448&&t<=12543}function Z_(t){return t>=12352&&t<=12447}function J_(t){return t>=65376&&t<=65439}function X_(t){return(t&65408)===3584}function Lr(t){return W_(t)?V_(t)?G_(t)?Vn.SPACE:z_(t)||Y_(t)||t===95?Vn.ALPHA_LETTER:Vn.PUNCT:X_(t)?Vn.THAI_LETTER:t===160?Vn.SPACE:Vn.ALPHA_LETTER:j_(t)?Vn.HAN_LETTER:K_(t)?Vn.KATAKANA_LETTER:Z_(t)?Vn.HIRAGANA_LETTER:J_(t)?Vn.HALFWIDTH_KATAKANA_LETTER:Vn.ALPHA_LETTER}const In={FOUND:0,NOT_FOUND:1,WRAPPED:2,PENDING:3},Q_=250,ev=-50,tv=-400,Lh={"\u2010":"-","\u2018":"'","\u2019":"'","\u201A":"'","\u201B":"'","\u201C":'"',"\u201D":'"',"\u201E":'"',"\u201F":'"',"\xBC":"1/4","\xBD":"1/2","\xBE":"3/4"},Ch=new Set([12441,12442,2381,2509,2637,2765,2893,3021,3149,3277,3387,3388,3405,3530,3642,3770,3972,4153,4154,5908,5940,6098,6752,6980,7082,7083,7154,7155,11647,43014,43052,43204,43347,43456,43766,44013,3158,3953,3954,3962,3963,3964,3965,3968,3956]);let xh;const nv=/\p{M}+/gu,av=/([.*+?^${}()|[\]\\])|(\p{P})|(\s+)|(\p{M})|(\p{L})/gu,iv=/([^\p{M}])\p{M}*$/u,sv=/^\p{M}*([^\p{M}])/u,ov=/[\uAC00-\uD7AF\uFA6C\uFACF-\uFAD1\uFAD5-\uFAD7]+/g,Ah=new Map,lv="[\\u1100-\\u1112\\ud7a4-\\ud7af\\ud84a\\ud84c\\ud850\\ud854\\ud857\\ud85f]",Th=new Map;let fu=null,pu=null;function Ih(t){const e=[];let n;for(;(n=ov.exec(t))!==null;){let{index:g}=n;for(const h of n[0]){let m=Ah.get(h);m||(m=h.normalize("NFD").length,Ah.set(h,m)),e.push([m,g++])}}let a;if(e.length===0&&fu)a=fu;else if(e.length>0&&pu)a=pu;else{const y=`([${Object.keys(Lh).join("")}])|([\u2460-\u2473\u24B6-\u24FF\u3244-\u32BF\u32D0-\u32FE\uFF00-\uFFEF])|((?:\u3099|\u309A)\\n)|(\\p{M}+(?:-\\n)?)|(\\S-\\n)|((?:\\p{Ideographic}|[\u3040-\u30FF])\\n)|(\\n)`;e.length===0?a=fu=new RegExp(y+"|(\\u0000)","gum"):a=pu=new RegExp(y+`|(${lv})`,"gum")}const i=[];for(;(n=nv.exec(t))!==null;)i.push([n[0].length,n.index]);let s=t.normalize("NFD");const o=[[0,0]];let l=0,r=0,c=0,d=0,u=0,f=!1;return s=s.replace(a,(g,h,m,b,y,_,v,k,L,C)=>{if(C-=d,h){const E=Lh[h],T=E.length;for(let H=1;H<T;H++)o.push([C-c+H,c-H]);return c-=T-1,E}if(m){let E=Th.get(m);E||(E=m.normalize("NFKC"),Th.set(m,E));const T=E.length;for(let H=1;H<T;H++)o.push([C-c+H,c-H]);return c-=T-1,E}if(b)return f=!0,C+u===i[l]?.[1]?++l:(o.push([C-1-c+1,c-1]),c-=1,d+=1),o.push([C-c+1,c]),d+=1,u+=1,b.charAt(0);if(y){const E=y.endsWith(`
`),T=E?y.length-2:y.length;f=!0;let H=T;C+u===i[l]?.[1]&&(H-=i[l][0],++l);for(let D=1;D<=H;D++)o.push([C-1-c+D,c-D]);return c-=H,d+=H,E?(C+=T-1,o.push([C-c+1,1+c]),c+=1,d+=1,u+=1,y.slice(0,T)):y}if(_){const E=_.length-2;return o.push([C-c+E,1+c]),c+=1,d+=1,u+=1,_.slice(0,-2)}if(v){const E=v.length-1;return o.push([C-c+E,c]),d+=1,u+=1,v.slice(0,-1)}if(k)return o.push([C-c+1,c-1]),c-=1,d+=1,u+=1," ";if(C+u===e[r]?.[1]){const E=e[r][0]-1;++r;for(let T=1;T<=E;T++)o.push([C-(c-T),c-T]);c-=E,d+=E}return L}),o.push([s.length,c]),[s,o,f]}function rv(t,e,n){if(!t)return[e,n];const a=e,i=e+n;let s=Po(t,l=>l[0]>=a);t[s][0]>a&&--s;let o=Po(t,l=>l[0]>=i,s);return t[o][0]>i&&--o,[a+t[s][1],n+t[o][1]-t[s][1]]}class cv{constructor({linkService:e,eventBus:n,updateMatchesCountOnProgress:a=!0}){B(this,nc);B(this,el);B(this,tl);B(this,ac);B(this,ic);B(this,sc);B(this,nl);B(this,oc);B(this,lc);B(this,Hs);B(this,Wi);B(this,ti);B(this,rc);B(this,al);B(this,il);B(this,Os);B(this,cc);B(this,sl);B(this,ol);B(this,Vi);B(this,Ns,!0);B(this,Ui,0);this._linkService=e,this._eventBus=n,oe(this,Ns,a),N(this,el,rf).call(this),n._on("find",N(this,nc,Zb).bind(this)),n._on("findbarclose",N(this,cc,aw).bind(this))}get highlightMatches(){return this._highlightMatches}get pageMatches(){return this._pageMatches}get pageMatchesLength(){return this._pageMatchesLength}get selected(){return this._selected}get state(){return this._state}setDocument(e){this._pdfDocument&&N(this,el,rf).call(this),e&&(this._pdfDocument=e,this._firstPageCapability.resolve())}scrollMatchIntoView({element:e=null,selectedLeft:n=0,pageIndex:a=-1,matchIndex:i=-1}){if(!this._scrollMatches||!e)return;if(i===-1||i!==this._selected.matchIdx)return;if(a===-1||a!==this._selected.pageIdx)return;this._scrollMatches=!1;const s={top:ev,left:n+tv};ru(e,s,!0)}}Ns=new WeakMap,Ui=new WeakMap,nc=new WeakSet,Zb=function(e){if(!e)return;const n=this._pdfDocument,{type:a}=e;(this._state===null||N(this,ac,Jb).call(this,e))&&(this._dirtyMatch=!0),this._state=e,a!=="highlightallchange"&&N(this,Vi,$l).call(this,In.PENDING),this._firstPageCapability.promise.then(()=>{if(!this._pdfDocument||n&&this._pdfDocument!==n)return;N(this,lc,tw).call(this);const i=!this._highlightMatches,s=!!this._findTimeout;this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),a?this._dirtyMatch?N(this,ti,Js).call(this):a==="again"?(N(this,ti,Js).call(this),i&&this._state.highlightAll&&N(this,Wi,Dl).call(this)):a==="highlightallchange"?(s?N(this,ti,Js).call(this):this._highlightMatches=!0,N(this,Wi,Dl).call(this)):N(this,ti,Js).call(this):this._findTimeout=setTimeout(()=>{N(this,ti,Js).call(this),this._findTimeout=null},Q_)})},el=new WeakSet,rf=function(){this._highlightMatches=!1,this._scrollMatches=!1,this._pdfDocument=null,this._pageMatches=[],this._pageMatchesLength=[],oe(this,Ui,0),this._state=null,this._selected={pageIdx:-1,matchIdx:-1},this._offset={pageIdx:null,matchIdx:null,wrapped:!1},this._extractTextPromises=[],this._pageContents=[],this._pageDiffs=[],this._hasDiacritics=[],this._matchesCountTotal=0,this._pagesToSearch=null,this._pendingFindMatches=new Set,this._resumePageIdx=null,this._dirtyMatch=!1,clearTimeout(this._findTimeout),this._findTimeout=null,this._firstPageCapability=(0,j.createPromiseCapability)()},tl=new WeakSet,cf=function(){return this._state.query!==this._rawQuery&&(this._rawQuery=this._state.query,[this._normalizedQuery]=Ih(this._state.query)),this._normalizedQuery},ac=new WeakSet,Jb=function(e){if(e.query!==this._state.query)return!0;switch(e.type){case"again":const n=this._selected.pageIdx+1,a=this._linkService;return n>=1&&n<=a.pagesCount&&n!==a.page&&!a.isPageVisible(n);case"highlightallchange":return!1}return!0},ic=new WeakSet,Xb=function(e,n,a){let i=e.slice(0,n).match(iv);if(i){const s=e.charCodeAt(n),o=i[1].charCodeAt(0);if(Lr(s)===Lr(o))return!1}if(i=e.slice(n+a).match(sv),i){const s=e.charCodeAt(n+a-1),o=i[1].charCodeAt(0);if(Lr(s)===Lr(o))return!1}return!0},sc=new WeakSet,Qb=function(e,n,a,i){const s=this._pageMatches[a]=[],o=this._pageMatchesLength[a]=[];if(!e)return;const l=this._pageDiffs[a];let r;for(;(r=e.exec(i))!==null;){if(n&&!N(this,ic,Xb).call(this,i,r.index,r[0].length))continue;const[c,d]=rv(l,r.index,r[0].length);d&&(s.push(c),o.push(d))}},nl=new WeakSet,df=function(e,n){const{matchDiacritics:a}=this._state;let i=!1;e=e.replaceAll(av,(o,l,r,c,d,u)=>l?`[ ]*\\${l}[ ]*`:r?`[ ]*${r}[ ]*`:c?"[ ]+":a?d||u:d?Ch.has(d.charCodeAt(0))?d:"":n?(i=!0,`${u}\\p{M}*`):u);const s="[ ]*";return e.endsWith(s)&&(e=e.slice(0,e.length-s.length)),a&&n&&(xh||=String.fromCharCode(...Ch),i=!0,e=`${e}(?=[${xh}]|[^\\p{M}]|$)`),[i,e]},oc=new WeakSet,ew=function(e){let n=P(this,tl,cf);if(!n)return;const{caseSensitive:a,entireWord:i,phraseSearch:s}=this._state,o=this._pageContents[e],l=this._hasDiacritics[e];let r=!1;if(s)[r,n]=N(this,nl,df).call(this,n,l);else{const u=n.match(/\S+/g);u&&(n=u.sort().reverse().map(f=>{const[g,h]=N(this,nl,df).call(this,f,l);return r||=g,`(${h})`}).join("|"))}const c=`g${r?"u":""}${a?"":"i"}`;n=n?new RegExp(n,c):null,N(this,sc,Qb).call(this,n,i,e,o),this._state.highlightAll&&N(this,Hs,Vc).call(this,e),this._resumePageIdx===e&&(this._resumePageIdx=null,N(this,al,uf).call(this));const d=this._pageMatches[e].length;this._matchesCountTotal+=d,P(this,Ns)?d>0&&N(this,ol,gf).call(this):++Rb(this,Ui)._===this._linkService.pagesCount&&N(this,ol,gf).call(this)},lc=new WeakSet,tw=function(){if(this._extractTextPromises.length>0)return;let e=Promise.resolve();for(let n=0,a=this._linkService.pagesCount;n<a;n++){const i=(0,j.createPromiseCapability)();this._extractTextPromises[n]=i.promise,e=e.then(()=>this._pdfDocument.getPage(n+1).then(s=>s.getTextContent()).then(s=>{const o=[];for(const l of s.items)o.push(l.str),l.hasEOL&&o.push(`
`);[this._pageContents[n],this._pageDiffs[n],this._hasDiacritics[n]]=Ih(o.join("")),i.resolve()},s=>{console.error(`Unable to get text content for page ${n+1}`,s),this._pageContents[n]="",this._pageDiffs[n]=null,this._hasDiacritics[n]=!1,i.resolve()}))}},Hs=new WeakSet,Vc=function(e){this._scrollMatches&&this._selected.pageIdx===e&&(this._linkService.page=e+1),this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:e})},Wi=new WeakSet,Dl=function(){this._eventBus.dispatch("updatetextlayermatches",{source:this,pageIndex:-1})},ti=new WeakSet,Js=function(){const e=this._state.findPrevious,n=this._linkService.page-1,a=this._linkService.pagesCount;if(this._highlightMatches=!0,this._dirtyMatch){this._dirtyMatch=!1,this._selected.pageIdx=this._selected.matchIdx=-1,this._offset.pageIdx=n,this._offset.matchIdx=null,this._offset.wrapped=!1,this._resumePageIdx=null,this._pageMatches.length=0,this._pageMatchesLength.length=0,oe(this,Ui,0),this._matchesCountTotal=0,N(this,Wi,Dl).call(this);for(let s=0;s<a;s++)this._pendingFindMatches.has(s)||(this._pendingFindMatches.add(s),this._extractTextPromises[s].then(()=>{this._pendingFindMatches.delete(s),N(this,oc,ew).call(this,s)}))}if(!P(this,tl,cf)){N(this,Vi,$l).call(this,In.FOUND);return}if(this._resumePageIdx)return;const i=this._offset;if(this._pagesToSearch=a,i.matchIdx!==null){const s=this._pageMatches[i.pageIdx].length;if(!e&&i.matchIdx+1<s||e&&i.matchIdx>0){i.matchIdx=e?i.matchIdx-1:i.matchIdx+1,N(this,Os,zc).call(this,!0);return}N(this,il,ff).call(this,e)}N(this,al,uf).call(this)},rc=new WeakSet,nw=function(e){const n=this._offset,a=e.length,i=this._state.findPrevious;return a?(n.matchIdx=i?a-1:0,N(this,Os,zc).call(this,!0),!0):(N(this,il,ff).call(this,i),n.wrapped&&(n.matchIdx=null,this._pagesToSearch<0)?(N(this,Os,zc).call(this,!1),!0):!1)},al=new WeakSet,uf=function(){this._resumePageIdx!==null&&console.error("There can only be one pending page.");let e=null;do{const n=this._offset.pageIdx;if(e=this._pageMatches[n],!e){this._resumePageIdx=n;break}}while(!N(this,rc,nw).call(this,e))},il=new WeakSet,ff=function(e){const n=this._offset,a=this._linkService.pagesCount;n.pageIdx=e?n.pageIdx-1:n.pageIdx+1,n.matchIdx=null,this._pagesToSearch--,(n.pageIdx>=a||n.pageIdx<0)&&(n.pageIdx=e?a-1:0,n.wrapped=!0)},Os=new WeakSet,zc=function(e=!1){let n=In.NOT_FOUND;const a=this._offset.wrapped;if(this._offset.wrapped=!1,e){const i=this._selected.pageIdx;this._selected.pageIdx=this._offset.pageIdx,this._selected.matchIdx=this._offset.matchIdx,n=a?In.WRAPPED:In.FOUND,i!==-1&&i!==this._selected.pageIdx&&N(this,Hs,Vc).call(this,i)}N(this,Vi,$l).call(this,n,this._state.findPrevious),this._selected.pageIdx!==-1&&(this._scrollMatches=!0,N(this,Hs,Vc).call(this,this._selected.pageIdx))},cc=new WeakSet,aw=function(e){const n=this._pdfDocument;this._firstPageCapability.promise.then(()=>{!this._pdfDocument||n&&this._pdfDocument!==n||(this._findTimeout&&(clearTimeout(this._findTimeout),this._findTimeout=null),this._resumePageIdx&&(this._resumePageIdx=null,this._dirtyMatch=!0),N(this,Vi,$l).call(this,In.FOUND),this._highlightMatches=!1,N(this,Wi,Dl).call(this))})},sl=new WeakSet,pf=function(){const{pageIdx:e,matchIdx:n}=this._selected;let a=0,i=this._matchesCountTotal;if(n!==-1){for(let s=0;s<e;s++)a+=this._pageMatches[s]?.length||0;a+=n+1}return(a<1||a>i)&&(a=i=0),{current:a,total:i}},ol=new WeakSet,gf=function(){this._eventBus.dispatch("updatefindmatchescount",{source:this,matchesCount:N(this,sl,pf).call(this)})},Vi=new WeakSet,$l=function(e,n=!1){!P(this,Ns)&&(P(this,Ui)!==this._linkService.pagesCount||e===In.PENDING)||this._eventBus.dispatch("updatefindcontrolstate",{source:this,state:e,previous:n,matchesCount:N(this,sl,pf).call(this),rawQuery:this._state?.query??null})};const dv=1e3;class uv{constructor(e,n,a){B(this,zi);this.opened=!1,this.bar=e.bar,this.toggleButton=e.toggleButton,this.findField=e.findField,this.highlightAll=e.highlightAllCheckbox,this.caseSensitive=e.caseSensitiveCheckbox,this.matchDiacritics=e.matchDiacriticsCheckbox,this.entireWord=e.entireWordCheckbox,this.findMsg=e.findMsg,this.findResultsCount=e.findResultsCount,this.findPreviousButton=e.findPreviousButton,this.findNextButton=e.findNextButton,this.eventBus=n,this.l10n=a,this.toggleButton.addEventListener("click",()=>{this.toggle()}),this.findField.addEventListener("input",()=>{this.dispatchEvent("")}),this.bar.addEventListener("keydown",i=>{switch(i.keyCode){case 13:i.target===this.findField&&this.dispatchEvent("again",i.shiftKey);break;case 27:this.close();break}}),this.findPreviousButton.addEventListener("click",()=>{this.dispatchEvent("again",!0)}),this.findNextButton.addEventListener("click",()=>{this.dispatchEvent("again",!1)}),this.highlightAll.addEventListener("click",()=>{this.dispatchEvent("highlightallchange"),this.highlightAll.checked?this.highlightAll.parentElement.classList.remove("b3-button--outline"):this.highlightAll.parentElement.classList.add("b3-button--outline")}),this.caseSensitive.addEventListener("click",()=>{this.dispatchEvent("casesensitivitychange"),this.caseSensitive.checked?this.caseSensitive.parentElement.classList.remove("b3-button--outline"):this.caseSensitive.parentElement.classList.add("b3-button--outline")}),this.entireWord.addEventListener("click",()=>{this.dispatchEvent("entirewordchange"),this.entireWord.checked?this.entireWord.parentElement.classList.remove("b3-button--outline"):this.entireWord.parentElement.classList.add("b3-button--outline")}),this.matchDiacritics.addEventListener("click",()=>{this.dispatchEvent("diacriticmatchingchange"),this.matchDiacritics.checked?this.matchDiacritics.parentElement.classList.remove("b3-button--outline"):this.matchDiacritics.parentElement.classList.add("b3-button--outline")}),this.eventBus._on("resize",N(this,zi,Pl).bind(this))}reset(){this.updateUIState()}dispatchEvent(e,n=!1){this.eventBus.dispatch("find",{source:this,type:e,query:this.findField.value,phraseSearch:!0,caseSensitive:this.caseSensitive.checked,entireWord:this.entireWord.checked,highlightAll:this.highlightAll.checked,findPrevious:n,matchDiacritics:this.matchDiacritics.checked})}updateUIState(e,n,a){let i="",s="";switch(e){case In.FOUND:break;case In.PENDING:s="pending";break;case In.NOT_FOUND:i=window.siyuan.languages.find_not_found,s="notFound";break;case In.WRAPPED:i=window.siyuan.languages.find_not_found[`find_reached_${n?"top":"bottom"}`];break}this.findField.setAttribute("data-status",s),this.findField.setAttribute("aria-invalid",e===In.NOT_FOUND),this.findMsg.textContent=i,N(this,zi,Pl).call(this),this.updateResultsCount(a)}updateResultsCount({current:e=0,total:n=0}={}){const a=dv;let i="";n>0&&(n>a?i=window.siyuan.languages.find_match_count_limit.replace("{{limit}}",a):i=window.siyuan.languages.find_match_count.replace("{{current}}",e).replace("{{total}}",n)),this.findResultsCount.textContent=i,N(this,zi,Pl).call(this)}open(){this.opened||(this.opened=!0,this.toggleButton.classList.add("toggled"),this.toggleButton.setAttribute("aria-expanded","true"),this.bar.classList.remove("fn__hidden")),this.findField.select(),this.findField.focus(),N(this,zi,Pl).call(this)}close(){this.opened&&(this.opened=!1,this.toggleButton.classList.remove("toggled"),this.toggleButton.setAttribute("aria-expanded","false"),this.bar.classList.add("fn__hidden"),this.eventBus.dispatch("findbarclose",{source:this}))}toggle(){this.opened?this.close():this.open()}}zi=new WeakSet,Pl=function(){if(!this.opened)return;this.bar.classList.remove("wrapContainers");const e=this.bar.clientHeight,n=this.bar.firstElementChild.clientHeight;e>n&&this.bar.classList.add("wrapContainers")};const fv=1e3,gu=50,Dh=1e3;function hu(){return document.location.hash}class pv{constructor({linkService:e,eventBus:n}){this.linkService=e,this.eventBus=n,this._initialized=!1,this._fingerprint="",this.reset(),this._boundEvents=null,this.eventBus._on("pagesinit",()=>{this._isPagesLoaded=!1,this.eventBus._on("pagesloaded",a=>{this._isPagesLoaded=!!a.pagesCount},{once:!0})})}initialize({fingerprint:e,resetHistory:n=!1,updateUrl:a=!1}){if(!e||typeof e!="string"){console.error('PDFHistory.initialize: The "fingerprint" must be a non-empty string.');return}this._initialized&&this.reset();const i=this._fingerprint!==""&&this._fingerprint!==e;this._fingerprint=e,this._updateUrl=a===!0,this._initialized=!0,this._bindEvents();const s=window.history.state;if(this._popStateInProgress=!1,this._blockHashChange=0,this._currentHash=hu(),this._numPositionUpdates=0,this._uid=this._maxUid=0,this._destination=null,this._position=null,!this._isValidState(s,!0)||n){const{hash:l,page:r,rotation:c}=this._parseCurrentHash(!0);if(!l||i||n){this._pushOrReplaceState(null,!0);return}this._pushOrReplaceState({hash:l,page:r,rotation:c},!0);return}const o=s.destination;this._updateInternalState(o,s.uid,!0),o.rotation!==void 0&&(this._initialRotation=o.rotation),o.dest?(this._initialBookmark=JSON.stringify(o.dest),this._destination.page=null):o.hash?this._initialBookmark=o.hash:o.page&&(this._initialBookmark=`page=${o.page}`)}reset(){this._initialized&&(this._pageHide(),this._initialized=!1,this._unbindEvents()),this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._initialBookmark=null,this._initialRotation=null}push({namedDest:e=null,explicitDest:n,pageNumber:a}){if(!this._initialized)return;if(e&&typeof e!="string"){console.error(`PDFHistory.push: "${e}" is not a valid namedDest parameter.`);return}else if(Array.isArray(n)){if(!this._isValidPage(a)&&(a!==null||this._destination)){console.error(`PDFHistory.push: "${a}" is not a valid pageNumber parameter.`);return}}else{console.error(`PDFHistory.push: "${n}" is not a valid explicitDest parameter.`);return}const i=e||JSON.stringify(n);if(!i)return;let s=!1;if(this._destination&&(gv(this._destination.hash,i)||hv(this._destination.dest,n))){if(this._destination.page)return;s=!0}this._popStateInProgress&&!s||(this._pushOrReplaceState({dest:n,hash:i,page:a,rotation:this.linkService.rotation},s),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(()=>{this._popStateInProgress=!1})))}pushPage(e){if(this._initialized){if(!this._isValidPage(e)){console.error(`PDFHistory.pushPage: "${e}" is not a valid page number.`);return}this._destination?.page!==e&&(this._popStateInProgress||(this._pushOrReplaceState({dest:null,hash:`page=${e}`,page:e,rotation:this.linkService.rotation}),this._popStateInProgress||(this._popStateInProgress=!0,Promise.resolve().then(()=>{this._popStateInProgress=!1}))))}}pushCurrentPosition(){!this._initialized||this._popStateInProgress||this._tryPushCurrentPosition()}back(){if(!this._initialized||this._popStateInProgress)return;const e=window.history.state;this._isValidState(e)&&e.uid>0&&window.history.back()}forward(){if(!this._initialized||this._popStateInProgress)return;const e=window.history.state;this._isValidState(e)&&e.uid<this._maxUid&&window.history.forward()}get popStateInProgress(){return this._initialized&&(this._popStateInProgress||this._blockHashChange>0)}get initialBookmark(){return this._initialized?this._initialBookmark:null}get initialRotation(){return this._initialized?this._initialRotation:null}_pushOrReplaceState(e,n=!1){const a=n||!this._destination,i={fingerprint:this._fingerprint,uid:a?this._uid:this._uid+1,destination:e};typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")&&window.history.state?.chromecomState&&(i.chromecomState=window.history.state.chromecomState),this._updateInternalState(e,i.uid);let s;if(this._updateUrl&&e?.hash){const o=document.location.href.split("#")[0];o.startsWith("file://")||(s=`${o}#${e.hash}`)}a?window.history.replaceState(i,"",s):window.history.pushState(i,"",s),typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")&&top===window&&chrome.runtime.sendMessage("showPageAction")}_tryPushCurrentPosition(e=!1){if(!this._position)return;let n=this._position;if(e&&(n=Object.assign(Object.create(null),this._position),n.temporary=!0),!this._destination){this._pushOrReplaceState(n);return}if(this._destination.temporary){this._pushOrReplaceState(n,!0);return}if(this._destination.hash===n.hash||!this._destination.page&&(gu<=0||this._numPositionUpdates<=gu))return;let a=!1;if(this._destination.page>=n.first&&this._destination.page<=n.page){if(this._destination.dest!==void 0||!this._destination.first)return;a=!0}this._pushOrReplaceState(n,a)}_isValidPage(e){return Number.isInteger(e)&&e>0&&e<=this.linkService.pagesCount}_isValidState(e,n=!1){if(!e)return!1;if(e.fingerprint!==this._fingerprint)if(n){if(typeof e.fingerprint!="string"||e.fingerprint.length!==this._fingerprint.length)return!1;const[a]=performance.getEntriesByType("navigation");if(a?.type!=="reload")return!1}else return!1;return!(!Number.isInteger(e.uid)||e.uid<0||e.destination===null||typeof e.destination!="object")}_updateInternalState(e,n,a=!1){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),a&&e?.temporary&&delete e.temporary,this._destination=e,this._uid=n,this._maxUid=Math.max(this._maxUid,n),this._numPositionUpdates=0}_parseCurrentHash(e=!1){const n=unescape(hu()).substring(1),a=yr(n),i=a.get("nameddest")||"";let s=a.get("page")|0;return(!this._isValidPage(s)||e&&i.length>0)&&(s=null),{hash:n,page:s,rotation:this.linkService.rotation}}_updateViewarea({location:e}){this._updateViewareaTimeout&&(clearTimeout(this._updateViewareaTimeout),this._updateViewareaTimeout=null),this._position={hash:e.pdfOpenParams.substring(1),page:this.linkService.page,first:e.pageNumber,rotation:e.rotation},!this._popStateInProgress&&(gu>0&&this._isPagesLoaded&&this._destination&&!this._destination.page&&this._numPositionUpdates++,Dh>0&&(this._updateViewareaTimeout=setTimeout(()=>{this._popStateInProgress||this._tryPushCurrentPosition(!0),this._updateViewareaTimeout=null},Dh)))}_popState({state:e}){const n=hu(),a=this._currentHash!==n;if(this._currentHash=n,typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")&&e?.chromecomState&&!this._isValidState(e)||!e){this._uid++;const{hash:s,page:o,rotation:l}=this._parseCurrentHash();this._pushOrReplaceState({hash:s,page:o,rotation:l},!0);return}if(!this._isValidState(e))return;this._popStateInProgress=!0,a&&(this._blockHashChange++,_h({target:window,name:"hashchange",delay:fv}).then(()=>{this._blockHashChange--}));const i=e.destination;this._updateInternalState(i,e.uid,!0),vr(i.rotation)&&(this.linkService.rotation=i.rotation),i.dest?this.linkService.goToDestination(i.dest):i.hash?this.linkService.setHash(i.hash):i.page&&(this.linkService.page=i.page),Promise.resolve().then(()=>{this._popStateInProgress=!1})}_pageHide(){(!this._destination||this._destination.temporary)&&this._tryPushCurrentPosition()}_bindEvents(){this._boundEvents||(this._boundEvents={updateViewarea:this._updateViewarea.bind(this),popState:this._popState.bind(this),pageHide:this._pageHide.bind(this)},this.eventBus._on("updateviewarea",this._boundEvents.updateViewarea),window.addEventListener("popstate",this._boundEvents.popState),window.addEventListener("pagehide",this._boundEvents.pageHide))}_unbindEvents(){this._boundEvents&&(this.eventBus._off("updateviewarea",this._boundEvents.updateViewarea),window.removeEventListener("popstate",this._boundEvents.popState),window.removeEventListener("pagehide",this._boundEvents.pageHide),this._boundEvents=null)}}function gv(t,e){return typeof t!="string"||typeof e!="string"?!1:t===e||yr(t).get("nameddest")===e}function hv(t,e){function n(a,i){if(typeof a!=typeof i||Array.isArray(a)||Array.isArray(i))return!1;if(a!==null&&typeof a=="object"&&i!==null){if(Object.keys(a).length!==Object.keys(i).length)return!1;for(const s in a)if(!n(a[s],i[s]))return!1;return!0}return a===i||Number.isNaN(a)&&Number.isNaN(i)}if(!(Array.isArray(t)&&Array.isArray(e))||t.length!==e.length)return!1;for(let a=0,i=t.length;a<i;a++)if(!n(t[a],e[a]))return!1;return!0}class mv extends Mo{constructor(n){super(n);B(this,ll);this.l10n=n.l10n,this.eventBus._on("optionalcontentconfigchanged",a=>{N(this,ll,hf).call(this,a.promise)}),this.eventBus._on("resetlayers",()=>{N(this,ll,hf).call(this)}),this.eventBus._on("togglelayerstree",this._toggleAllTreeItems.bind(this))}reset(){super.reset(),this._optionalContentConfig=null,this._optionalContentHash=null}_dispatchEvent(n){this.eventBus.dispatch("layersloaded",{source:this,layersCount:n})}_bindLink(n,{groupId:a,input:i}){const s=()=>{this._optionalContentConfig.setVisibility(a,i.checked),this._optionalContentHash=this._optionalContentConfig.getHash(),this.eventBus.dispatch("optionalcontentconfig",{source:this,promise:Promise.resolve(this._optionalContentConfig)})};n.onclick=o=>o.target===i?(s(),!0):o.target!==n?!0:(i.checked=!i.checked,s(),!1)}async _setNestedName(n,{name:a=null}){if(typeof a=="string"){n.textContent=this._normalizeTextContent(a);return}n.textContent=window.siyuan.languages.additionalLayers,n.style.fontStyle="italic"}_addToggleButton(n,{name:a=null}){super._addToggleButton(n,a===null)}_toggleAllTreeItems(){this._optionalContentConfig&&super._toggleAllTreeItems()}render({optionalContentConfig:n,pdfDocument:a}){this._optionalContentConfig&&this.reset(),this._optionalContentConfig=n||null,this._pdfDocument=a||null;const i=n?.getOrder();if(!i){this._dispatchEvent(0);return}this._optionalContentHash=n.getHash();const s=document.createDocumentFragment(),o=[{parent:s,groups:i}];let l=0,r=!1;for(;o.length>0;){const c=o.shift();for(const d of c.groups){const u=document.createElement("div");u.className="treeItem";const f=document.createElement("a");if(u.append(f),typeof d=="object"){r=!0,this._addToggleButton(u,d),this._setNestedName(f,d);const g=document.createElement("div");g.className="treeItems",u.append(g),o.push({parent:g,groups:d.order})}else{const g=n.getGroup(d),h=document.createElement("input");this._bindLink(f,{groupId:d,input:h}),h.type="checkbox",h.checked=g.visible;const m=document.createElement("label");m.textContent=this._normalizeTextContent(g.name),m.append(h),f.append(m),l++}c.parent.append(u)}}this._finishRendering(s,l,r)}}ll=new WeakSet,hf=async function(n=null){if(!this._optionalContentConfig)return;const a=this._pdfDocument,i=await(n||a.getOptionalContentConfig());if(a===this._pdfDocument){if(n){if(i.getHash()===this._optionalContentHash)return}else this.eventBus.dispatch("optionalcontentconfig",{source:this,promise:Promise.resolve(i)});this.render({optionalContentConfig:i,pdfDocument:this._pdfDocument})}};class bv extends Mo{constructor(e){super(e),this.linkService=e.linkService,this.downloadManager=e.downloadManager,this.eventBus._on("toggleoutlinetree",this._toggleAllTreeItems.bind(this)),this.eventBus._on("currentoutlineitem",this._currentOutlineItem.bind(this)),this.eventBus._on("pagechanging",n=>{this._currentPageNumber=n.pageNumber}),this.eventBus._on("pagesloaded",n=>{this._isPagesLoaded=!!n.pagesCount,this._currentOutlineItemCapability&&!this._currentOutlineItemCapability.settled&&this._currentOutlineItemCapability.resolve(this._isPagesLoaded)}),this.eventBus._on("sidebarviewchanged",n=>{this._sidebarView=n.view})}reset(){super.reset(),this._outline=null,this._pageNumberToDestHashCapability=null,this._currentPageNumber=1,this._isPagesLoaded=null,this._currentOutlineItemCapability&&!this._currentOutlineItemCapability.settled&&this._currentOutlineItemCapability.resolve(!1),this._currentOutlineItemCapability=null}_dispatchEvent(e){this._currentOutlineItemCapability=(0,j.createPromiseCapability)(),e===0||this._pdfDocument?.loadingParams.disableAutoFetch?this._currentOutlineItemCapability.resolve(!1):this._isPagesLoaded!==null&&this._currentOutlineItemCapability.resolve(this._isPagesLoaded),this.eventBus.dispatch("outlineloaded",{source:this,outlineCount:e,currentOutlineItemPromise:this._currentOutlineItemCapability.promise})}_bindLink(e,{url:n,newWindow:a,action:i,attachment:s,dest:o,setOCGState:l}){const{linkService:r}=this;if(n){r.addLinkAttributes(e,n,a);return}if(i){e.href=r.getAnchorUrl(""),e.onclick=()=>(r.executeNamedAction(i),!1);return}if(s){e.href=r.getAnchorUrl(""),e.onclick=()=>(this.downloadManager.openOrDownloadData(e,s.content,s.filename),!1);return}if(l){e.href=r.getAnchorUrl(""),e.onclick=()=>(r.executeSetOCGState(l),!1);return}e.href=r.getDestinationHash(o),e.onclick=c=>(this._updateCurrentTreeItem(c.target.parentNode),o&&r.goToDestination(o),!1)}_setStyles(e,{bold:n,italic:a}){n&&(e.style.fontWeight="bold"),a&&(e.style.fontStyle="italic")}_addToggleButton(e,{count:n,items:a}){let i=!1;if(n<0){let s=a.length;if(s>0){const o=[...a];for(;o.length>0;){const{count:l,items:r}=o.shift();l>0&&r.length>0&&(s+=r.length,o.push(...r))}}Math.abs(n)===s&&(i=!0)}super._addToggleButton(e,i)}_toggleAllTreeItems(){this._outline&&super._toggleAllTreeItems()}render({outline:e,pdfDocument:n}){if(this._outline&&this.reset(),this._outline=e||null,this._pdfDocument=n||null,!e){this._dispatchEvent(0);return}const a=document.createDocumentFragment(),i=[{parent:a,items:e}];let s=0,o=!1;for(;i.length>0;){const l=i.shift();for(const r of l.items){const c=document.createElement("div");c.className="treeItem";const d=document.createElement("a");if(this._bindLink(d,r),this._setStyles(d,r),d.textContent=this._normalizeTextContent(r.title),c.append(d),r.items.length>0){o=!0,this._addToggleButton(c,r);const u=document.createElement("div");u.className="treeItems",c.append(u),i.push({parent:u,items:r.items})}l.parent.append(c),s++}}this._finishRendering(a,s,o)}async _currentOutlineItem(){if(!this._isPagesLoaded)throw new Error("_currentOutlineItem: All pages have not been loaded.");if(!this._outline||!this._pdfDocument)return;const e=await this._getPageNumberToDestHash(this._pdfDocument);if(e&&(this._updateCurrentTreeItem(null),this._sidebarView===Ie.OUTLINE))for(let n=this._currentPageNumber;n>0;n--){const a=e.get(n);if(!a)continue;const i=this.container.querySelector(`a[href="${a}"]`);if(i){this._scrollToCurrentTreeItem(i.parentNode);break}}}async _getPageNumberToDestHash(e){if(this._pageNumberToDestHashCapability)return this._pageNumberToDestHashCapability.promise;this._pageNumberToDestHashCapability=(0,j.createPromiseCapability)();const n=new Map,a=new Map,i=[{nesting:0,items:this._outline}];for(;i.length>0;){const s=i.shift(),o=s.nesting;for(const{dest:l,items:r}of s.items){let c,d;if(typeof l=="string"){if(c=await e.getDestination(l),e!==this._pdfDocument)return null}else c=l;if(Array.isArray(c)){const[u]=c;if(typeof u=="object"&&u!==null){if(d=this.linkService._cachedPageNumber(u),!d)try{if(d=await e.getPageIndex(u)+1,e!==this._pdfDocument)return null;this.linkService.cachePageRef(d,u)}catch{}}else Number.isInteger(u)&&(d=u+1);if(Number.isInteger(d)&&(!n.has(d)||o>a.get(d))){const f=this.linkService.getDestinationHash(l);n.set(d,f),a.set(d,o)}}r.length>0&&i.push({nesting:o+1,items:r})}}return this._pageNumberToDestHashCapability.resolve(n.size>0?n:null),this._pageNumberToDestHashCapability.promise}}const wv=3e3,$h="pdfPresentationMode",mu="pdfPresentationModeControls",yv=50,_v=.1,Ph=50,bu=Math.PI/6;class vv{constructor({container:e,pdfViewer:n,eventBus:a}){B(this,dc);B(this,Yi);B(this,uc);B(this,fc);B(this,pc);B(this,gc);B(this,rl);B(this,hc);B(this,Gi);B(this,mc);B(this,bc);B(this,wc);B(this,yc);B(this,_c);B(this,cl);B(this,Rs,Ot.UNKNOWN);B(this,Qt,null);this.container=e,this.pdfViewer=n,this.eventBus=a,this.contextMenuOpen=!1,this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0,this.touchSwipeState=null}async request(){const{container:e,pdfViewer:n}=this;if(this.active||!n.pagesCount||!e.requestFullscreen)return!1;N(this,_c,gw).call(this),N(this,Yi,Ml).call(this,Ot.CHANGING);const a=e.requestFullscreen();oe(this,Qt,{pageNumber:n.currentPageNumber,scaleValue:n.currentScaleValue,scrollMode:n.scrollMode,spreadMode:null,annotationEditorMode:null}),n.spreadMode!==pt.NONE&&!(n.pageViewsReady&&n.hasEqualPageSizes)&&(console.warn("Ignoring Spread modes when entering PresentationMode, since the document may contain varying page sizes."),P(this,Qt).spreadMode=n.spreadMode),n.annotationEditorMode!==j.AnnotationEditorType.DISABLE&&(P(this,Qt).annotationEditorMode=n.annotationEditorMode);try{return await a,n.focus(),!0}catch{N(this,cl,bf).call(this),N(this,Yi,Ml).call(this,Ot.NORMAL)}return!1}get active(){return P(this,Rs)===Ot.CHANGING||P(this,Rs)===Ot.FULLSCREEN}}Rs=new WeakMap,Qt=new WeakMap,dc=new WeakSet,iw=function(e){if(!this.active)return;e.preventDefault();const n=x_(e),a=Date.now(),i=this.mouseScrollTimeStamp;if(!(a>i&&a-i<yv)&&((this.mouseScrollDelta>0&&n<0||this.mouseScrollDelta<0&&n>0)&&N(this,Gi,Nl).call(this),this.mouseScrollDelta+=n,Math.abs(this.mouseScrollDelta)>=_v)){const s=this.mouseScrollDelta;N(this,Gi,Nl).call(this),(s>0?this.pdfViewer.previousPage():this.pdfViewer.nextPage())&&(this.mouseScrollTimeStamp=a)}},Yi=new WeakSet,Ml=function(e){oe(this,Rs,e),this.eventBus.dispatch("presentationmodechanged",{source:this,state:e})},uc=new WeakSet,sw=function(){N(this,Yi,Ml).call(this,Ot.FULLSCREEN),this.container.classList.add($h),setTimeout(()=>{this.pdfViewer.scrollMode=Ce.PAGE,P(this,Qt).spreadMode!==null&&(this.pdfViewer.spreadMode=pt.NONE),this.pdfViewer.currentPageNumber=P(this,Qt).pageNumber,this.pdfViewer.currentScaleValue="page-fit",P(this,Qt).annotationEditorMode!==null&&(this.pdfViewer.annotationEditorMode=j.AnnotationEditorType.NONE)},0),N(this,bc,uw).call(this),N(this,rl,mf).call(this),this.contextMenuOpen=!1,window.getSelection().removeAllRanges()},fc=new WeakSet,ow=function(){const e=this.pdfViewer.currentPageNumber;this.container.classList.remove($h),setTimeout(()=>{N(this,cl,bf).call(this),N(this,Yi,Ml).call(this,Ot.NORMAL),this.pdfViewer.scrollMode=P(this,Qt).scrollMode,P(this,Qt).spreadMode!==null&&(this.pdfViewer.spreadMode=P(this,Qt).spreadMode),this.pdfViewer.currentScaleValue=P(this,Qt).scaleValue,this.pdfViewer.currentPageNumber=e,P(this,Qt).annotationEditorMode!==null&&(this.pdfViewer.annotationEditorMode=P(this,Qt).annotationEditorMode),oe(this,Qt,null)},0),N(this,wc,fw).call(this),N(this,hc,cw).call(this),N(this,Gi,Nl).call(this),this.contextMenuOpen=!1},pc=new WeakSet,lw=function(e){if(this.contextMenuOpen){this.contextMenuOpen=!1,e.preventDefault();return}e.button===0&&(e.target.href&&e.target.parentNode?.hasAttribute("data-internal-link")||(e.preventDefault(),e.shiftKey?this.pdfViewer.previousPage():this.pdfViewer.nextPage()))},gc=new WeakSet,rw=function(){this.contextMenuOpen=!0},rl=new WeakSet,mf=function(){this.controlsTimeout?clearTimeout(this.controlsTimeout):this.container.classList.add(mu),this.controlsTimeout=setTimeout(()=>{this.container.classList.remove(mu),delete this.controlsTimeout},wv)},hc=new WeakSet,cw=function(){this.controlsTimeout&&(clearTimeout(this.controlsTimeout),this.container.classList.remove(mu),delete this.controlsTimeout)},Gi=new WeakSet,Nl=function(){this.mouseScrollTimeStamp=0,this.mouseScrollDelta=0},mc=new WeakSet,dw=function(e){if(this.active){if(e.touches.length>1){this.touchSwipeState=null;return}switch(e.type){case"touchstart":this.touchSwipeState={startX:e.touches[0].pageX,startY:e.touches[0].pageY,endX:e.touches[0].pageX,endY:e.touches[0].pageY};break;case"touchmove":if(this.touchSwipeState===null)return;this.touchSwipeState.endX=e.touches[0].pageX,this.touchSwipeState.endY=e.touches[0].pageY,e.preventDefault();break;case"touchend":if(this.touchSwipeState===null)return;let n=0;const a=this.touchSwipeState.endX-this.touchSwipeState.startX,i=this.touchSwipeState.endY-this.touchSwipeState.startY,s=Math.abs(Math.atan2(i,a));Math.abs(a)>Ph&&(s<=bu||s>=Math.PI-bu)?n=a:Math.abs(i)>Ph&&Math.abs(s-Math.PI/2)<=bu&&(n=i),n>0?this.pdfViewer.previousPage():n<0&&this.pdfViewer.nextPage();break}}},bc=new WeakSet,uw=function(){this.showControlsBind=N(this,rl,mf).bind(this),this.mouseDownBind=N(this,pc,lw).bind(this),this.mouseWheelBind=N(this,dc,iw).bind(this),this.resetMouseScrollStateBind=N(this,Gi,Nl).bind(this),this.contextMenuBind=N(this,gc,rw).bind(this),this.touchSwipeBind=N(this,mc,dw).bind(this),window.addEventListener("mousemove",this.showControlsBind),window.addEventListener("mousedown",this.mouseDownBind),window.addEventListener("wheel",this.mouseWheelBind,{passive:!1}),window.addEventListener("keydown",this.resetMouseScrollStateBind),window.addEventListener("contextmenu",this.contextMenuBind),window.addEventListener("touchstart",this.touchSwipeBind),window.addEventListener("touchmove",this.touchSwipeBind),window.addEventListener("touchend",this.touchSwipeBind)},wc=new WeakSet,fw=function(){window.removeEventListener("mousemove",this.showControlsBind),window.removeEventListener("mousedown",this.mouseDownBind),window.removeEventListener("wheel",this.mouseWheelBind,{passive:!1}),window.removeEventListener("keydown",this.resetMouseScrollStateBind),window.removeEventListener("contextmenu",this.contextMenuBind),window.removeEventListener("touchstart",this.touchSwipeBind),window.removeEventListener("touchmove",this.touchSwipeBind),window.removeEventListener("touchend",this.touchSwipeBind),delete this.showControlsBind,delete this.mouseDownBind,delete this.mouseWheelBind,delete this.resetMouseScrollStateBind,delete this.contextMenuBind,delete this.touchSwipeBind},yc=new WeakSet,pw=function(){document.fullscreenElement?N(this,uc,sw).call(this):N(this,fc,ow).call(this)},_c=new WeakSet,gw=function(){this.fullscreenChangeBind=N(this,yc,pw).bind(this),window.addEventListener("fullscreenchange",this.fullscreenChangeBind)},cl=new WeakSet,bf=function(){window.removeEventListener("fullscreenchange",this.fullscreenChangeBind),delete this.fullscreenChangeBind};const Ev=3e4;class Mh{constructor(){this.pdfViewer=null,this.pdfThumbnailViewer=null,this.onIdle=null,this.highestPriorityPage=null,this.idleTimeout=null,this.printing=!1,this.isThumbnailViewEnabled=!1}setViewer(e){this.pdfViewer=e}setThumbnailViewer(e){this.pdfThumbnailViewer=e}isHighestPriority(e){return this.highestPriorityPage===e.renderingId}hasViewer(){return!!this.pdfViewer}renderHighestPriority(e){this.idleTimeout&&(clearTimeout(this.idleTimeout),this.idleTimeout=null),!this.pdfViewer.forceRendering(e)&&(this.isThumbnailViewEnabled&&this.pdfThumbnailViewer?.forceRendering()||this.printing||this.onIdle&&(this.idleTimeout=setTimeout(this.onIdle.bind(this),Ev)))}getHighestPriority(e,n,a,i=!1){const s=e.views,o=s.length;if(o===0)return null;for(let u=0;u<o;u++){const f=s[u].view;if(!this.isViewFinished(f))return f}const l=e.first.id,r=e.last.id;if(r-l+1>o){const u=e.ids;for(let f=1,g=r-l;f<g;f++){const h=a?l+f:r-f;if(u.has(h))continue;const m=n[h-1];if(!this.isViewFinished(m))return m}}let c=a?r:l-2,d=n[c];return d&&!this.isViewFinished(d)||i&&(c+=a?1:-1,d=n[c],d&&!this.isViewFinished(d))?d:null}isViewFinished(e){return e.renderingState===Re.FINISHED}renderView(e){switch(e.renderingState){case Re.FINISHED:return!1;case Re.PAUSED:this.highestPriorityPage=e.renderingId,e.resume();break;case Re.RUNNING:this.highestPriorityPage=e.renderingId;break;case Re.INITIAL:this.highestPriorityPage=e.renderingId,e.draw().finally(()=>{this.renderHighestPriority()}).catch(n=>{n instanceof j.RenderingCancelledException||console.error(`renderView: "${n}"`)});break}return!0}}class kv{constructor({eventBus:e,sandboxBundleSrc:n=null,scriptingFactory:a=null,docPropertiesLookup:i=null}){this._pdfDocument=null,this._pdfViewer=null,this._closeCapability=null,this._destroyCapability=null,this._scripting=null,this._ready=!1,this._eventBus=e,this._sandboxBundleSrc=n,this._scriptingFactory=a,this._docPropertiesLookup=i,typeof PDFJSDev<"u"&&PDFJSDev.test("COMPONENTS")&&!this._scriptingFactory&&window.addEventListener("updatefromsandbox",s=>{this._eventBus.dispatch("updatefromsandbox",{source:window,detail:s.detail})})}setViewer(e){this._pdfViewer=e}async setDocument(e){if(this._pdfDocument&&await this._destroyScripting(),this._pdfDocument=e,!e)return;const[n,a,i]=await Promise.all([e.getFieldObjects(),e.getCalculationOrderIds(),e.getJSActions()]);if(!n&&!i){await this._destroyScripting();return}if(e===this._pdfDocument){try{this._scripting=this._createScripting()}catch(s){console.error(`PDFScriptingManager.setDocument: "${s?.message}".`),await this._destroyScripting();return}this._internalEvents.set("updatefromsandbox",s=>{s?.source===window&&this._updateFromSandbox(s.detail)}),this._internalEvents.set("dispatcheventinsandbox",s=>{this._scripting?.dispatchEventInSandbox(s.detail)}),this._internalEvents.set("pagechanging",({pageNumber:s,previous:o})=>{s!==o&&(this._dispatchPageClose(o),this._dispatchPageOpen(s))}),this._internalEvents.set("pagerendered",({pageNumber:s})=>{this._pageOpenPending.has(s)&&s===this._pdfViewer.currentPageNumber&&this._dispatchPageOpen(s)}),this._internalEvents.set("pagesdestroy",async s=>{await this._dispatchPageClose(this._pdfViewer.currentPageNumber),await this._scripting?.dispatchEventInSandbox({id:"doc",name:"WillClose"}),this._closeCapability?.resolve()});for(const[s,o]of this._internalEvents)this._eventBus._on(s,o);try{const s=await this._getDocProperties();if(e!==this._pdfDocument)return;await this._scripting.createSandbox({objects:n,calculationOrder:a,appInfo:{platform:navigator.platform,language:navigator.language},docInfo:{...s,actions:i}}),this._eventBus.dispatch("sandboxcreated",{source:this})}catch(s){console.error(`PDFScriptingManager.setDocument: "${s?.message}".`),await this._destroyScripting();return}await this._scripting?.dispatchEventInSandbox({id:"doc",name:"Open"}),await this._dispatchPageOpen(this._pdfViewer.currentPageNumber,!0),Promise.resolve().then(()=>{e===this._pdfDocument&&(this._ready=!0)})}}async dispatchWillSave(e){return this._scripting?.dispatchEventInSandbox({id:"doc",name:"WillSave"})}async dispatchDidSave(e){return this._scripting?.dispatchEventInSandbox({id:"doc",name:"DidSave"})}async dispatchWillPrint(e){return this._scripting?.dispatchEventInSandbox({id:"doc",name:"WillPrint"})}async dispatchDidPrint(e){return this._scripting?.dispatchEventInSandbox({id:"doc",name:"DidPrint"})}get destroyPromise(){return this._destroyCapability?.promise||null}get ready(){return this._ready}get _internalEvents(){return(0,j.shadow)(this,"_internalEvents",new Map)}get _pageOpenPending(){return(0,j.shadow)(this,"_pageOpenPending",new Set)}get _visitedPages(){return(0,j.shadow)(this,"_visitedPages",new Map)}async _updateFromSandbox(e){const n=this._pdfViewer.isInPresentationMode||this._pdfViewer.isChangingPresentationMode,{id:a,siblings:i,command:s,value:o}=e;if(!a){switch(s){case"clear":console.clear();break;case"error":console.error(o);break;case"layout":{if((typeof PDFJSDev>"u"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))||n)return;const r=mh(o);this._pdfViewer.spreadMode=r.spreadMode;break}case"page-num":this._pdfViewer.currentPageNumber=o+1;break;case"print":await this._pdfViewer.pagesPromise,this._eventBus.dispatch("print",{source:this});break;case"println":console.log(o);break;case"zoom":if(n)return;this._pdfViewer.currentScaleValue=o;break;case"SaveAs":this._eventBus.dispatch("download",{source:this});break;case"FirstPage":this._pdfViewer.currentPageNumber=1;break;case"LastPage":this._pdfViewer.currentPageNumber=this._pdfViewer.pagesCount;break;case"NextPage":this._pdfViewer.nextPage();break;case"PrevPage":this._pdfViewer.previousPage();break;case"ZoomViewIn":if(n)return;this._pdfViewer.increaseScale();break;case"ZoomViewOut":if(n)return;this._pdfViewer.decreaseScale();break}return}if(n&&e.focus)return;delete e.id,delete e.siblings;const l=i?[a,...i]:[a];for(const r of l){const c=document.querySelector(`[data-element-id="${r}"]`);c?c.dispatchEvent(new CustomEvent("updatefromsandbox",{detail:e})):this._pdfDocument?.annotationStorage.setValue(r,e)}}async _dispatchPageOpen(e,n=!1){const a=this._pdfDocument,i=this._visitedPages;if(n&&(this._closeCapability=(0,j.createPromiseCapability)()),!this._closeCapability)return;const s=this._pdfViewer.getPageView(e-1);if(s?.renderingState!==Re.FINISHED){this._pageOpenPending.add(e);return}this._pageOpenPending.delete(e);const o=(async()=>{const l=await(i.has(e)?null:s.pdfPage?.getJSActions());a===this._pdfDocument&&await this._scripting?.dispatchEventInSandbox({id:"page",name:"PageOpen",pageNumber:e,actions:l})})();i.set(e,o)}async _dispatchPageClose(e){const n=this._pdfDocument,a=this._visitedPages;if(!this._closeCapability||this._pageOpenPending.has(e))return;const i=a.get(e);i&&(a.set(e,null),await i,n===this._pdfDocument&&await this._scripting?.dispatchEventInSandbox({id:"page",name:"PageClose",pageNumber:e}))}async _getDocProperties(){if(this._docPropertiesLookup)return this._docPropertiesLookup(this._pdfDocument);if(typeof PDFJSDev<"u"&&PDFJSDev.test("COMPONENTS")){const{docPropertiesLookup:e}=Ye(916);return e(this._pdfDocument)}throw new Error("_getDocProperties: Unable to lookup properties.")}_createScripting(){if(this._destroyCapability=(0,j.createPromiseCapability)(),this._scripting)throw new Error("_createScripting: Scripting already exists.");if(this._scriptingFactory)return this._scriptingFactory.createScripting({sandboxBundleSrc:this._sandboxBundleSrc});if(typeof PDFJSDev<"u"&&PDFJSDev.test("COMPONENTS")){const{GenericScripting:e}=Ye(916);return new e(this._sandboxBundleSrc)}throw new Error("_createScripting: Cannot create scripting.")}async _destroyScripting(){if(!this._scripting){this._pdfDocument=null,this._destroyCapability?.resolve();return}this._closeCapability&&(await Promise.race([this._closeCapability.promise,new Promise(e=>{setTimeout(e,1e3)})]).catch(e=>{}),this._closeCapability=null),this._pdfDocument=null;try{await this._scripting.destroySandbox()}catch{}for(const[e,n]of this._internalEvents)this._eventBus._off(e,n);this._internalEvents.clear(),this._pageOpenPending.clear(),this._visitedPages.clear(),this._scripting=null,this._ready=!1,this._destroyCapability?.resolve()}}const Nh="pdfSidebarNotification";class Sv{constructor({elements:e,pdfViewer:n,pdfThumbnailViewer:a,eventBus:i,l10n:s}){B(this,ni);B(this,Bs);B(this,qs);B(this,vc);B(this,dl);B(this,Ec);this.isOpen=!1,this.active=Ie.THUMBS,this.isInitialViewSet=!1,this.isInitialEventDispatched=!1,this.onToggled=null,this.pdfViewer=n,this.pdfThumbnailViewer=a,this.outerContainer=e.outerContainer,this.sidebarContainer=e.sidebarContainer,this.toggleButton=e.toggleButton,this.thumbnailButton=e.thumbnailButton,this.outlineButton=e.outlineButton,this.attachmentsButton=e.attachmentsButton,this.layersButton=e.layersButton,this.thumbnailView=e.thumbnailView,this.outlineView=e.outlineView,this.attachmentsView=e.attachmentsView,this.layersView=e.layersView,this._outlineOptionsContainer=e.outlineOptionsContainer,this._currentOutlineItemButton=e.currentOutlineItemButton,this.eventBus=i,this.l10n=s,N(this,Ec,mw).call(this)}reset(){this.isInitialViewSet=!1,this.isInitialEventDispatched=!1,N(this,dl,wf).call(this,!0),this.switchView(Ie.THUMBS),this.outlineButton.disabled=!1,this.attachmentsButton.disabled=!1,this.layersButton.disabled=!1,this._currentOutlineItemButton.disabled=!0}get visibleView(){return this.isOpen?this.active:Ie.NONE}setInitialView(e=Ie.NONE){if(!this.isInitialViewSet){if(this.isInitialViewSet=!0,e===Ie.NONE||e===Ie.UNKNOWN){N(this,ni,Xs).call(this);return}this.switchView(e,!0),this.isInitialEventDispatched||N(this,ni,Xs).call(this)}}switchView(e,n=!1){const a=e!==this.active;let i=!1;switch(e){case Ie.NONE:this.isOpen&&this.close();return;case Ie.THUMBS:this.isOpen&&a&&(i=!0);break;case Ie.OUTLINE:if(this.outlineButton.disabled)return;break;case Ie.ATTACHMENTS:if(this.attachmentsButton.disabled)return;break;case Ie.LAYERS:if(this.layersButton.disabled)return;break;default:console.error(`PDFSidebar.switchView: "${e}" is not a valid view.`);return}this.active=e;const s=e===Ie.THUMBS,o=e===Ie.OUTLINE,l=e===Ie.ATTACHMENTS,r=e===Ie.LAYERS;if(this.thumbnailButton.classList.toggle("toggled",s),this.outlineButton.classList.toggle("toggled",o),this.attachmentsButton.classList.toggle("toggled",l),this.layersButton.classList.toggle("toggled",r),this.thumbnailButton.setAttribute("aria-checked",s),this.outlineButton.setAttribute("aria-checked",o),this.attachmentsButton.setAttribute("aria-checked",l),this.layersButton.setAttribute("aria-checked",r),this.thumbnailView.classList.toggle("fn__hidden",!s),this.outlineView.classList.toggle("fn__hidden",!o),this.attachmentsView.classList.toggle("fn__hidden",!l),this.layersView.classList.toggle("fn__hidden",!r),this._outlineOptionsContainer.classList.toggle("fn__hidden",!o),n&&!this.isOpen){this.open();return}i&&(N(this,qs,Gc).call(this),N(this,Bs,Yc).call(this)),a&&N(this,ni,Xs).call(this)}open(){this.isOpen||(this.isOpen=!0,this.toggleButton.classList.add("toggled"),this.toggleButton.setAttribute("aria-expanded","true"),this.outerContainer.classList.add("sidebarMoving","sidebarOpen"),this.active===Ie.THUMBS&&N(this,qs,Gc).call(this),N(this,Bs,Yc).call(this),N(this,ni,Xs).call(this),N(this,dl,wf).call(this))}close(){this.isOpen&&(this.isOpen=!1,this.toggleButton.classList.remove("toggled"),this.toggleButton.setAttribute("aria-expanded","false"),this.outerContainer.classList.add("sidebarMoving"),this.outerContainer.classList.remove("sidebarOpen"),N(this,Bs,Yc).call(this),N(this,ni,Xs).call(this))}toggle(){this.isOpen?this.close():this.open()}}ni=new WeakSet,Xs=function(){this.isInitialViewSet&&!this.isInitialEventDispatched&&(this.isInitialEventDispatched=!0),this.eventBus.dispatch("sidebarviewchanged",{source:this,view:this.visibleView})},Bs=new WeakSet,Yc=function(){this.onToggled?this.onToggled():(this.pdfViewer.forceRendering(),this.pdfThumbnailViewer.forceRendering())},qs=new WeakSet,Gc=function(){const{pdfViewer:e,pdfThumbnailViewer:n}=this,a=e.pagesCount;for(let i=0;i<a;i++){const s=e.getPageView(i);s?.renderingState===Re.FINISHED&&n.getThumbnail(i).setImage(s)}n.scrollThumbnailIntoView(e.currentPageNumber)},vc=new WeakSet,hw=function(){this.toggleButton.title=window.siyuan.languages.toggleSidebarNotification2Title,this.isOpen||this.toggleButton.classList.add(Nh)},dl=new WeakSet,wf=function(e=!1){(this.isOpen||e)&&this.toggleButton.classList.remove(Nh),e&&(this.toggleButton.title=window.siyuan.languages.toggleSidebarTitle)},Ec=new WeakSet,mw=function(){this.sidebarContainer.addEventListener("transitionend",n=>{n.target===this.sidebarContainer&&this.outerContainer.classList.remove("sidebarMoving")}),this.toggleButton.addEventListener("click",()=>{this.toggle()}),this.thumbnailButton.addEventListener("click",()=>{this.switchView(Ie.THUMBS)}),this.outlineButton.addEventListener("click",()=>{this.switchView(Ie.OUTLINE)}),this.outlineButton.addEventListener("dblclick",()=>{this.eventBus.dispatch("toggleoutlinetree",{source:this})}),this.attachmentsButton.addEventListener("click",()=>{this.switchView(Ie.ATTACHMENTS)}),this.layersButton.addEventListener("click",()=>{this.switchView(Ie.LAYERS)}),this.layersButton.addEventListener("dblclick",()=>{this.eventBus.dispatch("resetlayers",{source:this})}),this._currentOutlineItemButton.addEventListener("click",()=>{this.eventBus.dispatch("currentoutlineitem",{source:this})});const e=(n,a,i)=>{a.disabled=!n,n?N(this,vc,hw).call(this):this.active===i&&this.switchView(Ie.THUMBS)};this.eventBus._on("outlineloaded",n=>{e(n.outlineCount,this.outlineButton,Ie.OUTLINE),n.currentOutlineItemPromise.then(a=>{this.isInitialViewSet&&(this._currentOutlineItemButton.disabled=!a)})}),this.eventBus._on("attachmentsloaded",n=>{e(n.attachmentsCount,this.attachmentsButton,Ie.ATTACHMENTS)}),this.eventBus._on("layersloaded",n=>{e(n.layersCount,this.layersButton,Ie.LAYERS)}),this.eventBus._on("presentationmodechanged",n=>{n.state===Ot.NORMAL&&this.visibleView===Ie.THUMBS&&N(this,qs,Gc).call(this)})};const Lv="--b3-pdf-sidebar-width",Hh=200,Cr="sidebarResizing";class Cv{constructor(e,n,a){this.isRTL=!1,this.sidebarOpen=!1,this._width=null,this._outerContainerWidth=null,this._boundEvents=Object.create(null),this.outerContainer=e.outerContainer,this.resizer=e.resizer,this.eventBus=n,this.isRTL=!1,this._addEventListeners()}get outerContainerWidth(){return this.outerContainer.clientWidth}_updateWidth(e=0){const n=Math.floor(this.outerContainerWidth/2);return e>n&&(e=n),e<Hh&&(e=Hh),e===this._width?!1:(this._width=e,du.setProperty(Lv,`${e}px`),!0)}_mouseMove(e){let n=e.clientX-this.outerContainer.getBoundingClientRect().left;this.isRTL&&(n=this.outerContainerWidth-n),this._updateWidth(n)}_mouseUp(e){this.outerContainer.classList.remove(Cr),this.eventBus.dispatch("resize",{source:this});const n=this._boundEvents;window.removeEventListener("mousemove",n.mouseMove),window.removeEventListener("mouseup",n.mouseUp)}_addEventListeners(){const e=this._boundEvents;e.mouseMove=this._mouseMove.bind(this),e.mouseUp=this._mouseUp.bind(this),this.resizer.addEventListener("mousedown",n=>{n.button===0&&(this.outerContainer.classList.add(Cr),window.addEventListener("mousemove",e.mouseMove),window.addEventListener("mouseup",e.mouseUp))}),this.eventBus._on("sidebarviewchanged",n=>{this.sidebarOpen=!!n?.view}),this.eventBus._on("resize",n=>{if(n?.source!==window||(this._outerContainerWidth=null,!this._width))return;if(!this.sidebarOpen){this._updateWidth(this._width);return}this.outerContainer.classList.add(Cr);const a=this._updateWidth(this._width);Promise.resolve().then(()=>{this.outerContainer.classList.remove(Cr),a&&this.eventBus.dispatch("resize",{source:this})})})}}const Oh=2,Rh=3,Bh=1,xv=98;class wu{static getCanvas(e,n){const a=P(this,Fs)||oe(this,Fs,document.createElement("canvas"));a.width=e,a.height=n;const i=a.getContext("2d",{alpha:!1});return i.save(),i.fillStyle="rgb(255, 255, 255)",i.fillRect(0,0,e,n),i.restore(),[a,a.getContext("2d")]}static destroyCanvas(){const e=P(this,Fs);e&&(e.width=0,e.height=0),oe(this,Fs,null)}}Fs=new WeakMap,B(wu,Fs,null);class Av{constructor({container:e,id:n,defaultViewport:a,optionalContentConfigPromise:i,linkService:s,renderingQueue:o,l10n:l,pageColors:r}){this.id=n,this.renderingId="thumbnail"+n,this.pageLabel=null,this.pdfPage=null,this.rotation=0,this.viewport=a,this.pdfPageRotate=a.rotation,this._optionalContentConfigPromise=i||null,this.pageColors=r||null,this.linkService=s,this.renderingQueue=o,this.renderTask=null,this.renderingState=Re.INITIAL,this.resume=null;const c=this.viewport.width,d=this.viewport.height,u=c/d;this.canvasWidth=xv,this.canvasHeight=this.canvasWidth/u|0,this.scale=this.canvasWidth/c,this.l10n=l;const f=document.createElement("a");f.href=s.getAnchorUrl("#page="+n),f.title=this._thumbPageTitle,f.onclick=function(){return s.goToPage(n),!1},this.anchor=f;const g=document.createElement("div");g.className="thumbnail",g.setAttribute("data-page-number",this.id),this.div=g;const h=document.createElement("div");h.className="thumbnailSelectionRing";const m=2*Bh;h.style.width=this.canvasWidth+m+"px",h.style.height=this.canvasHeight+m+"px",this.ring=h,g.append(h),f.append(g),e.append(f)}setPdfPage(e){this.pdfPage=e,this.pdfPageRotate=e.rotate;const n=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport({scale:1,rotation:n}),this.reset()}reset(){this.cancelRendering(),this.renderingState=Re.INITIAL;const e=this.viewport.width,n=this.viewport.height,a=e/n;this.canvasHeight=this.canvasWidth/a|0,this.scale=this.canvasWidth/e,this.div.removeAttribute("data-loaded");const i=this.ring;i.textContent="";const s=2*Bh;i.style.width=this.canvasWidth+s+"px",i.style.height=this.canvasHeight+s+"px",this.canvas&&(this.canvas.width=0,this.canvas.height=0,delete this.canvas),this.image&&(this.image.removeAttribute("src"),delete this.image)}update({rotation:e=null}){typeof e=="number"&&(this.rotation=e);const n=(this.rotation+this.pdfPageRotate)%360;this.viewport=this.viewport.clone({scale:1,rotation:n}),this.reset()}cancelRendering(){this.renderTask&&(this.renderTask.cancel(),this.renderTask=null),this.resume=null}_getPageDrawContext(e=1){const n=document.createElement("canvas"),a=n.getContext("2d",{alpha:!1}),i=new lh;n.width=e*this.canvasWidth*i.sx|0,n.height=e*this.canvasHeight*i.sy|0;const s=i.scaled?[i.sx,0,0,i.sy,0,0]:null;return{ctx:a,canvas:n,transform:s}}_convertCanvasToImage(e){if(this.renderingState!==Re.FINISHED)throw new Error("_convertCanvasToImage: Rendering has not finished.");const n=this._reduceImage(e),a=document.createElement("img");a.className="thumbnailImage",a.setAttribute("aria-label",this._thumbPageCanvas),a.style.width=this.canvasWidth+"px",a.style.height=this.canvasHeight+"px",a.src=n.toDataURL(),this.image=a,this.div.setAttribute("data-loaded",!0),this.ring.append(a),n.width=0,n.height=0}draw(){if(this.renderingState!==Re.INITIAL)return console.error("Must be in new state before drawing"),Promise.resolve();const{pdfPage:e}=this;if(!e)return this.renderingState=Re.FINISHED,Promise.reject(new Error("pdfPage is not loaded"));this.renderingState=Re.RUNNING;const n=async(u=null)=>{if(c===this.renderTask&&(this.renderTask=null),!(u instanceof j.RenderingCancelledException)&&(this.renderingState=Re.FINISHED,this._convertCanvasToImage(i),u))throw u},{ctx:a,canvas:i,transform:s}=this._getPageDrawContext(Oh),o=this.viewport.clone({scale:Oh*this.scale}),l=u=>{if(!this.renderingQueue.isHighestPriority(this)){this.renderingState=Re.PAUSED,this.resume=()=>{this.renderingState=Re.RUNNING,u()};return}u()},r={canvasContext:a,transform:s,viewport:o,optionalContentConfigPromise:this._optionalContentConfigPromise,pageColors:this.pageColors},c=this.renderTask=e.render(r);c.onContinue=l;const d=c.promise.then(function(){return n(null)},function(u){return n(u)});return d.finally(()=>{i.width=0,i.height=0,this.linkService.isPageCached(this.id)||this.pdfPage?.cleanup()}),d}setImage(e){if(this.renderingState!==Re.INITIAL)return;const{thumbnailCanvas:n,pdfPage:a,scale:i}=e;n&&(this.pdfPage||this.setPdfPage(a),!(i<this.scale)&&(this.renderingState=Re.FINISHED,this._convertCanvasToImage(n)))}_reduceImage(e){const{ctx:n,canvas:a}=this._getPageDrawContext();if(e.width<=2*a.width)return n.drawImage(e,0,0,e.width,e.height,0,0,a.width,a.height),a;let i=a.width<<Rh,s=a.height<<Rh;const[o,l]=wu.getCanvas(i,s);for(;i>e.width||s>e.height;)i>>=1,s>>=1;for(l.drawImage(e,0,0,e.width,e.height,0,0,i,s);i>2*a.width;)l.drawImage(o,0,0,i,s,0,0,i>>1,s>>1),i>>=1,s>>=1;return n.drawImage(o,0,0,i,s,0,0,a.width,a.height),a}get _thumbPageTitle(){return window.siyuan.languages.thumbPageTitle.replace("{{page}}",this.pageLabel??this.id)}get _thumbPageCanvas(){return window.siyuan.languages.thumbPage.replace("{{page}}",this.pageLabel??this.id)}setPageLabel(e){this.pageLabel=typeof e=="string"?e:null,this.anchor.title=this._thumbPageTitle,this.renderingState===Re.FINISHED&&this.image?.setAttribute("aria-label",this._thumbPageCanvas)}}const Tv=-19,yu="selected";class Iv{constructor({container:e,linkService:n,renderingQueue:a,l10n:i,pageColors:s}){B(this,kc);B(this,Sc);this.container=e,this.linkService=n,this.renderingQueue=a,this.l10n=i,this.pageColors=s||null,(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&this.pageColors&&!(CSS.supports("color",this.pageColors.background)&&CSS.supports("color",this.pageColors.foreground))&&((this.pageColors.background||this.pageColors.foreground)&&console.warn("PDFThumbnailViewer: Ignoring `pageColors`-option, since the browser doesn't support the values used."),this.pageColors=null),this.scroll=rh(this.container,this._scrollUpdated.bind(this)),this._resetView()}_scrollUpdated(){this.renderingQueue.renderHighestPriority()}getThumbnail(e){return this._thumbnails[e]}_getVisibleThumbs(){return uh({scrollEl:this.container,views:this._thumbnails})}scrollThumbnailIntoView(e){if(!this.pdfDocument)return;const n=this._thumbnails[e-1];if(!n){console.error('scrollThumbnailIntoView: Invalid "pageNumber" parameter.');return}e!==this._currentPageNumber&&(this._thumbnails[this._currentPageNumber-1].div.classList.remove(yu),n.div.classList.add(yu));const{first:a,last:i,views:s}=this._getVisibleThumbs();if(s.length>0){let o=!1;if(e<=a.id||e>=i.id)o=!0;else for(const{id:l,percent:r}of s)if(l===e){o=r<100;break}o&&ru(n.div,{top:Tv})}this._currentPageNumber=e}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!vr(e))throw new Error("Invalid thumbnails rotation angle.");if(!this.pdfDocument||this._pagesRotation===e)return;this._pagesRotation=e;const n={rotation:e};for(const a of this._thumbnails)a.update(n)}cleanup(){for(const e of this._thumbnails)e.renderingState!==Re.FINISHED&&e.reset();wu.destroyCanvas()}_resetView(){this._thumbnails=[],this._currentPageNumber=1,this._pageLabels=null,this._pagesRotation=0,this.container.textContent=""}setDocument(e){if(this.pdfDocument&&(this._cancelRendering(),this._resetView()),this.pdfDocument=e,!e)return;const n=e.getPage(1),a=e.getOptionalContentConfig();n.then(i=>{const s=e.numPages,o=i.getViewport({scale:1});for(let r=1;r<=s;++r){const c=new Av({container:this.container,id:r,defaultViewport:o.clone(),optionalContentConfigPromise:a,linkService:this.linkService,renderingQueue:this.renderingQueue,l10n:this.l10n,pageColors:this.pageColors});this._thumbnails.push(c)}this._thumbnails[0]?.setPdfPage(i),this._thumbnails[this._currentPageNumber-1].div.classList.add(yu)}).catch(i=>{console.error("Unable to initialize thumbnail viewer",i)})}_cancelRendering(){for(const e of this._thumbnails)e.cancelRendering()}setPageLabels(e){if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("PDFThumbnailViewer_setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let n=0,a=this._thumbnails.length;n<a;n++)this._thumbnails[n].setPageLabel(this._pageLabels?.[n]??null)}}forceRendering(){const e=this._getVisibleThumbs(),n=N(this,Sc,ww).call(this,e),a=this.renderingQueue.getHighestPriority(e,this._thumbnails,n);return a?(N(this,kc,bw).call(this,a).then(()=>{this.renderingQueue.renderView(a)}),!0):!1}}kc=new WeakSet,bw=async function(e){if(e.pdfPage)return e.pdfPage;try{const n=await this.pdfDocument.getPage(e.id);return e.pdfPage||e.setPdfPage(n),n}catch(n){return console.error("Unable to get page for thumb view",n),null}},Sc=new WeakSet,ww=function(e){return e.first?.id===1?!0:e.last?.id===this._thumbnails.length?!1:this.scroll.down};const qh={of_pages:"of {{pagesCount}}",page_of_pages:"({{pageNumber}} of {{pagesCount}})",document_properties_kb:"{{size_kb}} KB ({{size_b}} bytes)",document_properties_mb:"{{size_mb}} MB ({{size_b}} bytes)",document_properties_date_string:"{{date}}, {{time}}",document_properties_page_size_unit_inches:"in",document_properties_page_size_unit_millimeters:"mm",document_properties_page_size_orientation_portrait:"portrait",document_properties_page_size_orientation_landscape:"landscape",document_properties_page_size_name_a3:"A3",document_properties_page_size_name_a4:"A4",document_properties_page_size_name_letter:"Letter",document_properties_page_size_name_legal:"Legal",document_properties_page_size_dimension_string:"{{width}} \xD7 {{height}} {{unit}} ({{orientation}})",document_properties_page_size_dimension_name_string:"{{width}} \xD7 {{height}} {{unit}} ({{name}}, {{orientation}})",document_properties_linearized_yes:"Yes",document_properties_linearized_no:"No",additional_layers:"Additional Layers",page_landmark:"Page {{page}}",thumb_page_title:"Page {{page}}",thumb_page_canvas:"Thumbnail of Page {{page}}",find_reached_top:"Reached top of document, continued from bottom",find_reached_bottom:"Reached end of document, continued from top","find_match_count[one]":"{{current}} of {{total}} match","find_match_count[other]":"{{current}} of {{total}} matches","find_match_count_limit[one]":"More than {{limit}} match","find_match_count_limit[other]":"More than {{limit}} matches",find_not_found:"Phrase not found",page_scale_width:"Page Width",page_scale_fit:"Page Fit",page_scale_auto:"Automatic Zoom",page_scale_actual:"Actual Size",page_scale_percent:"{{scale}}%",loading_error:"An error occurred while loading the PDF.",invalid_file_error:"Invalid or corrupted PDF file.",missing_file_error:"Missing PDF file.",unexpected_response_error:"Unexpected server response.",rendering_error:"An error occurred while rendering the page.",printing_not_supported:"Warning: Printing is not fully supported by this browser.",printing_not_ready:"Warning: The PDF is not fully loaded for printing.",web_fonts_disabled:"Web fonts are disabled: unable to use embedded PDF fonts.",free_text2_default_content:"Start typing\u2026",editor_free_text2_aria_label:"Text Editor",editor_ink2_aria_label:"Draw Editor",editor_ink_canvas_aria_label:"User-created image"};(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&(qh.print_progress_percent="{{progress}}%");function Dv(t,e){switch(t){case"find_match_count":t=`find_match_count[${e.total===1?"one":"other"}]`;break;case"find_match_count_limit":t=`find_match_count_limit[${e.limit===1?"one":"other"}]`;break}return qh[t]||""}const $v={en:"en-US",es:"es-ES",fy:"fy-NL",ga:"ga-IE",gu:"gu-IN",hi:"hi-IN",hy:"hy-AM",nb:"nb-NO",ne:"ne-NP",nn:"nn-NO",pa:"pa-IN",pt:"pt-PT",sv:"sv-SE",zh:"zh-CN"};function Bk(t){return $v[t?.toLowerCase()]||t}function Pv(t,e){return e?t.replaceAll(/\{\{\s*(\w+)\s*\}\}/g,(n,a)=>a in e?e[a]:"{{"+a+"}}"):t}const xr={async getLanguage(){return"en-us"},async getDirection(){return"ltr"},async get(t,e=null,n=Dv(t,e)){return Pv(n,e)},async translate(t){}};class Mv{constructor(e){B(this,ul,void 0);this.pageDiv=e.pageDiv,this.pdfPage=e.pdfPage,this.accessibilityManager=e.accessibilityManager,this.l10n=e.l10n||xr,this.annotationEditorLayer=null,this.div=null,this._cancelled=!1,oe(this,ul,e.uiManager)}async render(e,n="display"){if(n!=="display"||this._cancelled)return;const a=e.clone({dontFlip:!0});if(this.div){this.annotationEditorLayer.update({viewport:a}),this.show();return}const i=this.div=document.createElement("div");i.className="annotationEditorLayer",i.tabIndex=0,i.hidden=!0,this.pageDiv.append(i),this.annotationEditorLayer=new j.AnnotationEditorLayer({uiManager:P(this,ul),div:i,accessibilityManager:this.accessibilityManager,pageIndex:this.pdfPage.pageNumber-1,l10n:this.l10n,viewport:a});const s={viewport:a,div:i,annotations:null,intent:n};this.annotationEditorLayer.render(s),this.show()}cancel(){this._cancelled=!0,this.div&&(this.pageDiv=null,this.annotationEditorLayer.destroy(),this.div.remove())}hide(){this.div&&(this.div.hidden=!0)}show(){!this.div||this.annotationEditorLayer.isEmpty||(this.div.hidden=!1)}}ul=new WeakMap;class Nv{constructor({pageDiv:e,pdfPage:n,linkService:a,downloadManager:i,annotationStorage:s=null,imageResourcesPath:o="",renderForms:l=!0,l10n:r=xr,enableScripting:c=!1,hasJSActionsPromise:d=null,fieldObjectsPromise:u=null,annotationCanvasMap:f=null,accessibilityManager:g=null}){B(this,fl);B(this,Us,0);B(this,$a,null);this.pageDiv=e,this.pdfPage=n,this.linkService=a,this.downloadManager=i,this.imageResourcesPath=o,this.renderForms=l,this.l10n=r,this.annotationStorage=s,this.enableScripting=c,this._hasJSActionsPromise=d||Promise.resolve(!1),this._fieldObjectsPromise=u||Promise.resolve(null),this._annotationCanvasMap=f,this._accessibilityManager=g,this.div=null,this._cancelled=!1,this._eventBus=a.eventBus}async render(e,n="display"){if(this.div){if(this._cancelled||P(this,Us)===0)return;j.AnnotationLayer.update({viewport:e.clone({dontFlip:!0}),div:this.div,annotationCanvasMap:this._annotationCanvasMap});return}const[a,i,s]=await Promise.all([this.pdfPage.getAnnotations({intent:n}),this._hasJSActionsPromise,this._fieldObjectsPromise]);if(!this._cancelled){if(oe(this,Us,a.length),this.div=document.createElement("div"),this.div.className="annotationLayer",this.pageDiv.append(this.div),P(this,Us)===0){this.hide();return}j.AnnotationLayer.render({viewport:e.clone({dontFlip:!0}),div:this.div,annotations:a,page:this.pdfPage,imageResourcesPath:this.imageResourcesPath,renderForms:this.renderForms,linkService:this.linkService,downloadManager:this.downloadManager,annotationStorage:this.annotationStorage,enableScripting:this.enableScripting,hasJSActions:i,fieldObjects:s,annotationCanvasMap:this._annotationCanvasMap,accessibilityManager:this._accessibilityManager}),this.linkService.isInPresentationMode&&N(this,fl,yf).call(this,Ot.FULLSCREEN),P(this,$a)||(oe(this,$a,o=>{N(this,fl,yf).call(this,o.state)}),this._eventBus?._on("presentationmodechanged",P(this,$a)))}}cancel(){this._cancelled=!0,P(this,$a)&&(this._eventBus?._off("presentationmodechanged",P(this,$a)),oe(this,$a,null))}hide(){this.div&&(this.div.hidden=!0)}}Us=new WeakMap,$a=new WeakMap,fl=new WeakSet,yf=function(e){if(!this.div)return;let n=!1;switch(e){case Ot.FULLSCREEN:n=!0;break;case Ot.NORMAL:break;default:return}for(const a of this.div.childNodes)a.hasAttribute("data-internal-link")||(a.inert=n)};const Fh={Document:null,DocumentFragment:null,Part:"group",Sect:"group",Div:"group",Aside:"note",NonStruct:"none",P:null,H:"heading",Title:null,FENote:"note",Sub:"group",Lbl:null,Span:null,Em:null,Strong:null,Link:"link",Annot:"note",Form:"form",Ruby:null,RB:null,RT:null,RP:null,Warichu:null,WT:null,WP:null,L:"list",LI:"listitem",LBody:null,Table:"table",TR:"row",TH:"columnheader",TD:"cell",THead:"columnheader",TBody:null,TFoot:null,Caption:null,Figure:"figure",Formula:null,Artifact:null},Hv=/^H(\d+)$/;class Ov{constructor(){B(this,pl);B(this,gl);B(this,Hn,void 0)}get renderingDone(){return P(this,Hn)!==void 0}render(e){if(P(this,Hn)!==void 0)return P(this,Hn);const n=N(this,gl,vf).call(this,e);return n?.classList.add("structTree"),oe(this,Hn,n)}hide(){P(this,Hn)&&!P(this,Hn).hidden&&(P(this,Hn).hidden=!0)}show(){P(this,Hn)?.hidden&&(P(this,Hn).hidden=!1)}}Hn=new WeakMap,pl=new WeakSet,_f=function(e,n){e.alt!==void 0&&n.setAttribute("aria-label",e.alt),e.id!==void 0&&n.setAttribute("aria-owns",e.id),e.lang!==void 0&&n.setAttribute("lang",e.lang)},gl=new WeakSet,vf=function(e){if(!e)return null;const n=document.createElement("span");if("role"in e){const{role:a}=e,i=a.match(Hv);i?(n.setAttribute("role","heading"),n.setAttribute("aria-level",i[1])):Fh[a]&&n.setAttribute("role",Fh[a])}if(N(this,pl,_f).call(this,e,n),e.children)if(e.children.length===1&&"id"in e.children[0])N(this,pl,_f).call(this,e.children[0],n);else for(const a of e.children)n.append(N(this,gl,vf).call(this,a));return n};const ml=class{constructor(){B(this,hl);B(this,Pa,!1);B(this,On,null);B(this,Ma,new Map);B(this,ai,new Map)}setTextMapping(e){oe(this,On,e)}enable(){if(P(this,Pa))throw new Error("TextAccessibilityManager is already enabled.");if(!P(this,On))throw new Error("Text divs and strings have not been set.");if(oe(this,Pa,!0),oe(this,On,P(this,On).slice()),P(this,On).sort(N(ml,Ws,jc)),P(this,Ma).size>0){const e=P(this,On);for(const[n,a]of P(this,Ma)){if(!document.getElementById(n)){P(this,Ma).delete(n);continue}N(this,hl,Ef).call(this,n,e[a])}}for(const[e,n]of P(this,ai))this.addPointerInTextLayer(e,n);P(this,ai).clear()}disable(){P(this,Pa)&&(P(this,ai).clear(),oe(this,On,null),oe(this,Pa,!1))}removePointerInTextLayer(e){if(!P(this,Pa)){P(this,ai).delete(e);return}const n=P(this,On);if(!n||n.length===0)return;const{id:a}=e,i=P(this,Ma).get(a);if(i===void 0)return;const s=n[i];P(this,Ma).delete(a);let o=s.getAttribute("aria-owns");o?.includes(a)&&(o=o.split(" ").filter(l=>l!==a).join(" "),o?s.setAttribute("aria-owns",o):(s.removeAttribute("aria-owns"),s.setAttribute("role","presentation")))}addPointerInTextLayer(e,n){const{id:a}=e;if(!a)return;if(!P(this,Pa)){P(this,ai).set(e,n);return}n&&this.removePointerInTextLayer(e);const i=P(this,On);if(!i||i.length===0)return;const s=Po(i,l=>{var r;return N(r=ml,Ws,jc).call(r,e,l)<0}),o=Math.max(0,s-1);N(this,hl,Ef).call(this,a,i[o]),P(this,Ma).set(a,o)}moveElementInDOM(e,n,a,i){if(this.addPointerInTextLayer(a,i),!e.hasChildNodes()){e.append(n);return}const s=Array.from(e.childNodes).filter(r=>r!==n);if(s.length===0)return;const o=a||n,l=Po(s,r=>{var c;return N(c=ml,Ws,jc).call(c,o,r)<0});l===0?s[0].before(n):s[l-1].after(n)}};let Ar=ml;Pa=new WeakMap,On=new WeakMap,Ma=new WeakMap,ai=new WeakMap,Ws=new WeakSet,jc=function(e,n){const a=e.getBoundingClientRect(),i=n.getBoundingClientRect();if(a.width===0&&a.height===0)return 1;if(i.width===0&&i.height===0)return-1;const s=a.y,o=a.y+a.height,l=a.y+a.height/2,r=i.y,c=i.y+i.height,d=i.y+i.height/2;if(l<=r&&d>=o)return-1;if(d<=s&&l>=c)return 1;const u=a.x+a.width/2,f=i.x+i.width/2;return u-f},hl=new WeakSet,Ef=function(e,n){const a=n.getAttribute("aria-owns");a?.includes(e)||n.setAttribute("aria-owns",a?`${a} ${e}`:e),n.removeAttribute("role")},B(Ar,Ws);class Rv{constructor({findController:e,eventBus:n,pageIndex:a}){this.findController=e,this.matches=[],this.eventBus=n,this.pageIdx=a,this._onUpdateTextLayerMatches=null,this.textDivs=null,this.textContentItemsStr=null,this.enabled=!1}setTextMapping(e,n){this.textDivs=e,this.textContentItemsStr=n}enable(){if(!this.textDivs||!this.textContentItemsStr)throw new Error("Text divs and strings have not been set.");if(this.enabled)throw new Error("TextHighlighter is already enabled.");this.enabled=!0,this._onUpdateTextLayerMatches||(this._onUpdateTextLayerMatches=e=>{(e.pageIndex===this.pageIdx||e.pageIndex===-1)&&this._updateMatches()},this.eventBus._on("updatetextlayermatches",this._onUpdateTextLayerMatches)),this._updateMatches()}disable(){this.enabled&&(this.enabled=!1,this._onUpdateTextLayerMatches&&(this.eventBus._off("updatetextlayermatches",this._onUpdateTextLayerMatches),this._onUpdateTextLayerMatches=null),this._updateMatches(!0))}_convertMatches(e,n){if(!e)return[];const{textContentItemsStr:a}=this;let i=0,s=0;const o=a.length-1,l=[];for(let r=0,c=e.length;r<c;r++){let d=e[r];for(;i!==o&&d>=s+a[i].length;)s+=a[i].length,i++;i===a.length&&console.error("Could not find a matching mapping");const u={begin:{divIdx:i,offset:d-s}};for(d+=n[r];i!==o&&d>s+a[i].length;)s+=a[i].length,i++;u.end={divIdx:i,offset:d-s},l.push(u)}return l}_renderMatches(e){if(e.length===0)return;const{findController:n,pageIdx:a}=this,{textContentItemsStr:i,textDivs:s}=this,o=a===n.selected.pageIdx,l=n.selected.matchIdx,r=n.state.highlightAll;let c=null;const d={divIdx:-1,offset:void 0};function u(m,b){const y=m.divIdx;return s[y].textContent="",f(y,0,m.offset,b)}function f(m,b,y,_){let v=s[m];if(v.nodeType===Node.TEXT_NODE){const C=document.createElement("span");v.before(C),C.append(v),s[m]=C,v=C}const k=i[m].substring(b,y),L=document.createTextNode(k);if(_){const C=document.createElement("span");return C.className=`${_} appended`,C.append(L),v.append(C),_.includes("selected")?C.offsetLeft:0}return v.append(L),0}let g=l,h=g+1;if(r)g=0,h=e.length;else if(!o)return;for(let m=g;m<h;m++){const b=e[m],y=b.begin,_=b.end,v=o&&m===l,k=v?" selected":"";let L=0;if(!c||y.divIdx!==c.divIdx?(c!==null&&f(c.divIdx,c.offset,d.offset),u(y)):f(c.divIdx,c.offset,y.offset),y.divIdx===_.divIdx)L=f(y.divIdx,y.offset,_.offset,"highlight"+k);else{L=f(y.divIdx,y.offset,d.offset,"highlight begin"+k);for(let C=y.divIdx+1,E=_.divIdx;C<E;C++)s[C].className="highlight middle"+k;u(_,"highlight end"+k)}c=_,v&&n.scrollMatchIntoView({element:s[y.divIdx],selectedLeft:L,pageIndex:a,matchIndex:l})}c&&f(c.divIdx,c.offset,d.offset)}_updateMatches(e=!1){if(!this.enabled&&!e)return;const{findController:n,matches:a,pageIdx:i}=this,{textContentItemsStr:s,textDivs:o}=this;let l=-1;for(const d of a){const u=Math.max(l,d.begin.divIdx);for(let f=u,g=d.end.divIdx;f<=g;f++){const h=o[f];h.textContent=s[f],h.className=""}l=d.end.divIdx+1}if(!n?.highlightMatches||e)return;const r=n.pageMatches[i]||null,c=n.pageMatchesLength[i]||null;this.matches=this._convertMatches(r,c),this._renderMatches(this.matches)}}const Bv=(t,e,n)=>{Es(e);const a=n.toolbar.rectAnno;a.addEventListener("click",()=>{a.classList.contains("toggled")?(a.classList.remove("toggled"),n.mainContainer.classList.remove("rect-to-annotation")):(e.pdfCursorTools.switchTool(0),a.classList.add("toggled"),n.mainContainer.classList.add("rect-to-annotation"),getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0),Ti(t))});const i=n.mainContainer.lastElementChild;return n.mainContainer.addEventListener("mousedown",s=>{if(s.button===2||!a.classList.contains("toggled"))return;let o=e.pdfViewer._getVisiblePages().first.view.canvas.getBoundingClientRect();s.clientX>o.right&&(o=e.pdfViewer._getVisiblePages().last.view.canvas.getBoundingClientRect());const l=n.mainContainer.getBoundingClientRect(),r=o.left,c=o.right,d=l.bottom;let u=s.clientX;s.clientX>c?u=c:s.clientX<r&&(u=r);const f=l.top,g=s.clientY,h=document;h.onmousemove=m=>{i.classList.remove("fn__none");let b=0,y=0,_=0,v=0;m.clientX<u?(m.clientX<r?y=r:y=m.clientX,_=u-y):m.clientX>c?(y=u,_=c-y):(y=u,_=m.clientX-u),m.clientY>g?m.clientY>d?(b=g,v=d-g):(b=g,v=m.clientY-g):(m.clientY<f?b=f:b=m.clientY,v=g-b),i.setAttribute("style",`top:${b}px;height:${v}px;left:${y}px;width:${_}px;background-color:${m.altKey?"var(--b3-pdf-background1)":""}`)},h.onmouseup=()=>{h.onmousemove=null,h.onmouseup=null,h.ondragstart=null,h.onselectstart=null,h.onselect=null,a.classList.remove("toggled"),n.mainContainer.classList.remove("rect-to-annotation");const m=qv(e,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor||"var(--b3-pdf-background1)",i,i.style.backgroundColor?"text":"border");i.classList.add("fn__none"),m?m.forEach((b,y)=>{const _=Tr(b,e);y===0&&(Tt=_,Ir(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Tt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))}):Tt=null}}),t.addEventListener("click",s=>{let o=!1,l=s.target;if(typeof s.detail=="string"){window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor=s.detail==="0"?window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor||"var(--b3-pdf-background1)":`var(--b3-pdf-background${s.detail})`,pe(p.Constants.LOCAL_PDFTHEME,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME]);const r=Wh(e,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor);r&&r.forEach((c,d)=>{const u=Tr(c,e);d===0&&(Tt=u,Ir(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Tt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))}),Ti(t);return}for(;l&&!l.classList.contains("pdf__outer");){const r=l.getAttribute("data-type");if(l.classList.contains("color__square")){const c=l.style.backgroundColor;if(window.siyuan.storage[p.Constants.LOCAL_PDFTHEME].annoColor=c,pe(p.Constants.LOCAL_PDFTHEME,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME]),Tt){const d=Es(e),u=d[Tt.getAttribute("data-node-id")];u.color=c,Array.from(Tt.children).forEach(f=>{f.style.border="2px solid "+c,u.type==="text"?f.style.backgroundColor=c:f.style.backgroundColor="transparent"}),w("/api/asset/setFileAnnotation",{path:e.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(d)})}else{const d=Wh(e,c);d&&d.forEach((u,f)=>{const g=Tr(u,e);f===0&&(Tt=g,Ir(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Tt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e))})}Ti(t),o=!0,s.preventDefault(),s.stopPropagation();break}else if(l.classList.contains("pdf__rect")){Uh(t,void 0,l),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="remove"){const c=e.appConfig.file.replace(location.origin,"").substr(1),d=Es(e);delete d[Tt.getAttribute("data-node-id")],Tt.remove(),w("/api/asset/setFileAnnotation",{path:c+".sya",data:JSON.stringify(d)}),Ti(t),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="copy"){Ti(t),Ir(`${e.appConfig.file.replace(location.origin,"").substr(1)}/${Tt.getAttribute("data-node-id")}`,e.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,""),e),s.preventDefault(),s.stopPropagation(),o=!0;break}else if(r==="toggle"){const c=Es(e),d=c[Tt.getAttribute("data-node-id")];d.type==="border"?d.type="text":d.type="border",Array.from(Tt.children).forEach(u=>{d.type==="text"?u.style.backgroundColor=u.style.border.replace("2px solid ",""):u.style.backgroundColor=""}),w("/api/asset/setFileAnnotation",{path:e.appConfig.file.replace(location.origin,"").substr(1)+".sya",data:JSON.stringify(c)}),s.preventDefault(),s.stopPropagation(),o=!0,Ti(t);break}l=l.parentElement}o||setTimeout(()=>{let r=!1;const c=window.getSelection();if(c.rangeCount>0){const d=c.getRangeAt(0);d.toString()!==""&&A(d.commonAncestorContainer,"pdfViewer")&&(Uh(t,d),r=!0)}r||Ti(t)})}),e},Ti=t=>{t.querySelector(".pdf__util").classList.add("fn__none")};let Tt;const Uh=(t,e,n)=>{n&&(n.setAttribute("prevent-popover","true"),setTimeout(()=>{n.removeAttribute("prevent-popover")},620));const a=t.querySelector(".pdf__util");if(a.classList.remove("fn__none"),e){a.classList.add("pdf__util--hide");const s=e.getClientRects(),o=s[s.length-1];ke(a,o.left,o.bottom),Tt=null;return}Tt=n,a.classList.remove("pdf__util--hide");const i=n.firstElementChild.getBoundingClientRect();ke(a,i.left,i.top+i.height+4)},Wh=(t,e)=>{const n=window.getSelection().getRangeAt(0),a=A(n.startContainer,"page");if(!a)return;const i=parseInt(a.getAttribute("data-page-number"))-1,s=A(n.endContainer,"page");if(!s)return;const o=parseInt(s.getAttribute("data-page-number"))-1,l=n.cloneContents();Array.from(l.children).forEach(_=>{if(_.tagName==="BR"&&_.previousElementSibling&&_.nextElementSibling){const v=_.previousElementSibling.textContent,k=_.nextElementSibling.textContent;/^[A-Za-z]$/.test(v.substring(v.length-2,v.length-1))&&/^[A-Za-z]$/.test(k.substring(0,1))&&(v.endsWith("-")?_.previousElementSibling.textContent=v.substring(0,v.length-1):_.insertAdjacentText("afterend"," "))}});const r=Lute.EscapeHTMLStr(l.textContent.replace(/[\x00]|\n/g,"")),c=t.pdfViewer.getPageView(i),d=c.canvas.getClientRects()[0],u=c.viewport,f=n.cloneRange();if(i!==o){const _=c.textLayer.textDivs;n.setEndAfter(_[_.length-1])}const g=[];Vh(n).forEach(function(_){g.push(u.convertToPdfPoint(_.left-d.x,_.top-d.y).concat(u.convertToPdfPoint(_.right-d.x,_.bottom-d.y)))});const h=[];if(i!==o){Z(f);const _=t.pdfViewer.getPageView(o),v=_.canvas.getClientRects()[0],k=_.viewport,L=_.textLayer.textDivs;f.setStart(L[0],0),Vh(f).forEach(function(C){h.push(k.convertToPdfPoint(C.left-v.x,C.top-v.y).concat(k.convertToPdfPoint(C.right-v.x,C.bottom-v.y)))})}const m=Lute.NewNodeID(),b=[],y=[];if(g.length>0&&(b.push({index:i,positions:g}),y.push({index:i,coords:g,id:m,color:e,content:r,type:"text",mode:"text"})),h.length>0&&(b.push({index:o,positions:h}),y.push({index:o,coords:h,id:m,color:e,content:r,type:"text",mode:"text"})),b.length!==0)return Gh(t,m,{pages:b,content:r,color:e,type:"text",mode:"text"}),y},qv=(t,e,n,a)=>{const i=n.getBoundingClientRect(),s=A(document.elementFromPoint(i.left,i.top-1),"page");if(!s)return;const o=parseInt(s.getAttribute("data-page-number"))-1,l=t.pdfViewer.getPageView(o),r=l.canvas.getClientRects()[0],c=l.viewport,d=c.convertToPdfPoint(i.left-r.x,i.top-r.y).concat(c.convertToPdfPoint(i.right-r.x,i.bottom-r.y)),u=[{index:l.id-1,positions:[d]}],f=Lute.NewNodeID(),g=t.appConfig.file.replace(location.origin,"").substr(8).replace(/-\d{14}-\w{7}.pdf$/,"")+`-P${l.id}-${Q().format("YYYYMMDDHHmmss")}`,h=[{index:l.id-1,coords:[d],id:f,color:e,content:g,type:a,mode:"rect"}];let m=document.elementFromPoint(i.right,i.bottom+1);if(m=A(m,"page"),m){const b=parseInt(m.getAttribute("data-page-number"))-1;if(b!==o){const y=t.pdfViewer.getPageView(b),_=y.canvas.getClientRects()[0],v=y.viewport,k=v.convertToPdfPoint(i.left-_.x,i.top-_.y).concat(v.convertToPdfPoint(i.right-_.x,i.bottom-_.y));u.push({index:y.id-1,positions:[k]}),h.push({index:y.id-1,coords:[k],id:f,color:e,content:g,type:a,mode:"rect"})}}return Gh(t,f,{pages:u,content:g,color:e,type:a,mode:"rect"}),h},Vh=t=>{const e=t.getClientRects(),n=[];let a;return Array.from(e).forEach(i=>{i.height===0||i.width===0||(typeof a>"u"||Math.abs(a-i.top)>4?(n.push({left:i.left,top:i.top,right:i.right,bottom:i.bottom}),a=i.top):n[n.length-1].right=i.right)}),n},Ae=t=>{let e;return Pe().asset.find(n=>{if(n.pdfObject&&t&&n.element&&typeof n.element.contains<"u"&&n.element.contains(t))return e=n.pdfObject,!0}),e},zh=t=>{const e=Ae(t);if(!e)return;const n=parseInt(t.parentElement.getAttribute("data-page-number"))-1,a=Es(e);Object.keys(a).find(i=>{const s=a[i],o=s.pages.find(l=>{if(l.index===n)return!0});o&&Tr({index:n,coords:o.positions,id:i,color:s.color,content:s.content,type:s.type,mode:s.mode||""},e,e.annoId===i)})},Tr=(t,e,n)=>{const a=t.index,i=e.pdfViewer.getPageView(a);let s=i.textLayer.div;if(!s.lastElementChild)return;const o=i.viewport.clone({rotation:0});s.lastElementChild.classList.contains("endOfContent")&&s.insertAdjacentHTML("beforeend","<div></div>"),s=s.lastElementChild;let l=`<div class="pdf__rect popover__block" data-node-id="${t.id}" data-mode="${t.mode}">`;return t.coords.forEach(r=>{const c=o.convertToViewportRectangle(r),d=Math.abs(c[0]-c[2]);if(d<=0)return;let u=`border: 2px solid ${t.color};background-color: ${t.color};`;t.type==="border"&&(u=`border: 2px solid ${t.color};`),l+=`<div style="${u}
        left:${Math.min(c[0],c[2])}px;
        top:${Math.min(c[1],c[3])}px;
        width:${d}px;
        height: ${Math.abs(c[1]-c[3])}px"></div>`}),s.insertAdjacentHTML("beforeend",l+"</div>"),s.lastElementChild.setAttribute("data-content",t.content),n&&Yh(s,t.id),s.lastElementChild},Yh=(t,e)=>{const n=t.querySelector(`.pdf__rect[data-node-id="${e}"]`);if(n&&n.firstElementChild){const a=q(n,"id","viewerContainer");if(a){const i=n.firstElementChild.getBoundingClientRect(),s=a.getBoundingClientRect();i.top<s.top?a.scrollTop=a.scrollTop-(s.top-i.top)-(s.height-i.height)/2:i.bottom>s.bottom&&(a.scrollTop=a.scrollTop+(i.bottom-s.bottom)+(s.height-i.height)/2)}n.classList.add("pdf__rect--hl"),setTimeout(()=>{n.classList.remove("pdf__rect--hl")},1500)}},Ir=(t,e,n)=>{const a=Tt.getAttribute("data-mode"),i=Tt.getAttribute("data-content");setTimeout(()=>{a==="rect"||a===""&&Tt.childElementCount===1&&i.startsWith(e)?Uv(n).then(s=>{fetch(s).then(o=>o.blob()).then(o=>{const l=new FormData,r=i+".png";l.append("file[]",o,r),w(p.Constants.UPLOAD_ADDRESS,l,c=>{G(`<<${t} "${i}">>
![](${c.data.succMap[r]})`)})})}):G(`<<${t} "${i}">>`)},p.Constants.TIMEOUT_DBLCLICK)},Fv=async(t,e)=>{const n=await t.pdfDocument.getPage(e),a=n.getViewport({scale:1.5*t.pdfViewer.currentScale*window.pdfjsLib.PixelsPerInch.PDF_TO_CSS_UNITS}),i=document.createElement("canvas");return i.width=Math.floor(a.width),i.height=Math.floor(a.height),await n.render({canvasContext:i.getContext("2d"),viewport:a}).promise,i};async function Uv(t){const e=A(Tt,"page");if(!e)return;const n=await Fv(t,parseInt(e.getAttribute("data-page-number"))),a=Tt.firstElementChild.style,i=1.5,s=n.getContext("2d").getImageData(i*parseFloat(a.left),i*parseFloat(a.top),i*parseFloat(a.width),i*parseFloat(a.height)),o=document.createElement("canvas");return o.width=s.width,o.height=s.height,o.getContext("2d").putImageData(s,0,0),o.toDataURL()}const Gh=(t,e,n)=>{const a=t.appConfig.file.replace(location.origin,"").substr(1),i=Es(t);i[e]=n,w("/api/asset/setFileAnnotation",{path:a+".sya",data:JSON.stringify(i)})},Es=t=>{if(t.appConfig.config)return t.appConfig.config;const e=t.appConfig.file.replace(location.origin,"").substr(1)+".sya";w("/api/asset/getFileAnnotation",{path:e},n=>{let a={};n.code!==1&&(a=JSON.parse(n.data.data)),t.appConfig.config=a})};class Wv{constructor({highlighter:e=null,accessibilityManager:n=null,isOffscreenCanvasSupported:a=!0}){B(this,Lc);B(this,Cc);B(this,Vs,0);B(this,zs,0);B(this,Ys,null);this.textContentItemsStr=[],this.renderingDone=!1,this.textDivs=[],this.textDivProperties=new WeakMap,this.textLayerRenderTask=null,this.highlighter=e,this.accessibilityManager=n,this.isOffscreenCanvasSupported=a,this.div=document.createElement("div"),this.div.className="textLayer",this.hide()}get numTextDivs(){return this.textDivs.length}async render(e){if(!P(this,Ys))throw new Error('No "textContentSource" parameter specified.');const n=e.scale*(globalThis.devicePixelRatio||1),{rotation:a}=e;if(this.renderingDone){const i=a!==P(this,Vs),s=n!==P(this,zs);(i||s)&&(this.hide(),(0,j.updateTextLayer)({container:this.div,viewport:e,textDivs:this.textDivs,textDivProperties:this.textDivProperties,isOffscreenCanvasSupported:this.isOffscreenCanvasSupported,mustRescale:s,mustRotate:i}),oe(this,zs,n),oe(this,Vs,a)),this.show(),this.div.lastElementChild.previousElementSibling&&this.div.lastElementChild.previousElementSibling.classList.contains("endOfContent")&&(this.div.lastElementChild.innerHTML=""),zh(this.div);return}this.cancel(),this.highlighter?.setTextMapping(this.textDivs,this.textContentItemsStr),this.accessibilityManager?.setTextMapping(this.textDivs),this.textLayerRenderTask=(0,j.renderTextLayer)({textContentSource:P(this,Ys),container:this.div,viewport:e,textDivs:this.textDivs,textDivProperties:this.textDivProperties,textContentItemsStr:this.textContentItemsStr,isOffscreenCanvasSupported:this.isOffscreenCanvasSupported}),await this.textLayerRenderTask.promise,N(this,Lc,yw).call(this),oe(this,zs,n),oe(this,Vs,a),this.show(),zh(this.div),this.accessibilityManager?.enable()}hide(){this.div.hidden||(this.highlighter?.disable(),this.div.hidden=!0)}show(){this.div.hidden&&this.renderingDone&&(this.div.hidden=!1,this.highlighter?.enable())}cancel(){this.textLayerRenderTask&&(this.textLayerRenderTask.cancel(),this.textLayerRenderTask=null),this.highlighter?.disable(),this.accessibilityManager?.disable(),this.textContentItemsStr.length=0,this.textDivs.length=0,this.textDivProperties=new WeakMap}setTextContentSource(e){this.cancel(),oe(this,Ys,e)}}Vs=new WeakMap,zs=new WeakMap,Ys=new WeakMap,Lc=new WeakSet,yw=function(){this.renderingDone=!0;const e=document.createElement("div");e.className="endOfContent",this.div.append(e),N(this,Cc,_w).call(this)},Cc=new WeakSet,_w=function(){const{div:e}=this;e.addEventListener("mousedown",n=>{const a=e.querySelector(".endOfContent");if(a){if(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL")){let i=n.target!==e;if((typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(i&&=getComputedStyle(a).getPropertyValue("-moz-user-select")!=="none"),i){const s=e.getBoundingClientRect(),o=Math.max(0,(n.pageY-s.top)/s.height);a.style.top=(o*100).toFixed(2)+"%"}}a.classList.add("active")}}),e.addEventListener("mouseup",()=>{const n=e.querySelector(".endOfContent");n&&((typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&(n.style.top=""),n.classList.remove("active"))})};class Vv{constructor({pageDiv:e,pdfPage:n,annotationStorage:a=null,linkService:i,xfaHtml:s=null}){this.pageDiv=e,this.pdfPage=n,this.annotationStorage=a,this.linkService=i,this.xfaHtml=s,this.div=null,this._cancelled=!1}async render(e,n="display"){if(n==="print"){const s={viewport:e.clone({dontFlip:!0}),div:this.div,xfaHtml:this.xfaHtml,annotationStorage:this.annotationStorage,linkService:this.linkService,intent:n},o=document.createElement("div");return this.pageDiv.append(o),s.div=o,j.XfaLayer.render(s)}const a=await this.pdfPage.getXfa();if(this._cancelled||!a)return{textDivs:[]};const i={viewport:e.clone({dontFlip:!0}),div:this.div,xfaHtml:a,annotationStorage:this.annotationStorage,linkService:this.linkService,intent:n};return this.div?j.XfaLayer.update(i):(this.div=document.createElement("div"),this.pageDiv.append(this.div),i.div=this.div,j.XfaLayer.render(i))}cancel(){this._cancelled=!0}hide(){this.div&&(this.div.hidden=!0)}}const zv=kr.maxCanvasPixels||16777216,Yv=()=>typeof PDFJSDev>"u"||!PDFJSDev.test("COMPONENTS")?null:{annotationEditorUIManager:null,annotationStorage:null,downloadManager:null,enableScripting:!1,fieldObjectsPromise:null,findController:null,hasJSActionsPromise:null,get linkService(){return new wh}};class Gv{constructor(e){B(this,js);B(this,wl);B(this,yl);B(this,_l);B(this,vl);B(this,xc);B(this,Ac);B(this,ii,j.AnnotationMode.ENABLE_FORMS);B(this,si,null);B(this,oi,null);B(this,bl,null);B(this,Gs,Re.INITIAL);B(this,ji,{initialOptionalContent:!0,regularAnnotations:!0});const n=e.container,a=e.defaultViewport;this.id=e.id,this.renderingId="page"+this.id,oe(this,si,e.layerProperties||Yv),this.pdfPage=null,this.pageLabel=null,this.rotation=0,this.scale=e.scale||iu,this.viewport=a,this.pdfPageRotate=a.rotation,this._optionalContentConfigPromise=e.optionalContentConfigPromise||null,this.hasRestrictedScaling=!1,this.textLayerMode=e.textLayerMode??wr.ENABLE,oe(this,ii,e.annotationMode??j.AnnotationMode.ENABLE_FORMS),this.imageResourcesPath=e.imageResourcesPath||"",this.useOnlyCssZoom=e.useOnlyCssZoom||!1,this.isOffscreenCanvasSupported=e.isOffscreenCanvasSupported??!0,this.maxCanvasPixels=e.maxCanvasPixels||zv,this.pageColors=e.pageColors||null,this.eventBus=e.eventBus,this.renderingQueue=e.renderingQueue,(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&(this.renderer=e.renderer||br.CANVAS),this.l10n=e.l10n||xr,this.paintTask=null,this.paintedViewportMap=new WeakMap,this.resume=null,this._renderError=null,(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&(this._isStandalone=!this.renderingQueue?.hasViewer()),this._annotationCanvasMap=null,this.annotationLayer=null,this.annotationEditorLayer=null,this.textLayer=null,this.zoomLayer=null,this.xfaLayer=null,this.structTreeLayer=null;const i=document.createElement("div");if(i.className="page",i.setAttribute("data-page-number",this.id),i.setAttribute("role","region"),i.setAttribute("aria-label",window.siyuan.languages.thumbPageTitle.replace("{{page}}",this.id)),this.div=i,N(this,js,Kc).call(this),n?.append(i),(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this._isStandalone){n?.style.setProperty("--scale-factor",this.scale*j.PixelsPerInch.PDF_TO_CSS_UNITS);const{optionalContentConfigPromise:s}=e;s&&s.then(o=>{s===this._optionalContentConfigPromise&&(P(this,ji).initialOptionalContent=o.hasInitialVisibility)})}}get renderingState(){return P(this,Gs)}set renderingState(e){if(e!==P(this,Gs))switch(oe(this,Gs,e),P(this,oi)&&(clearTimeout(P(this,oi)),oe(this,oi,null)),e){case Re.PAUSED:this.div.classList.remove("loading");break;case Re.RUNNING:this.div.classList.add("loadingIcon"),oe(this,oi,setTimeout(()=>{this.div.classList.add("loading"),oe(this,oi,null)},0));break;case Re.INITIAL:case Re.FINISHED:this.div.classList.remove("loadingIcon","loading");break}}setPdfPage(e){this.pdfPage=e,this.pdfPageRotate=e.rotate;const n=(this.rotation+this.pdfPageRotate)%360;this.viewport=e.getViewport({scale:this.scale*j.PixelsPerInch.PDF_TO_CSS_UNITS,rotation:n}),N(this,js,Kc).call(this),this.reset()}destroy(){this.reset(),this.pdfPage?.cleanup()}get _textHighlighter(){return(0,j.shadow)(this,"_textHighlighter",new Rv({pageIndex:this.id-1,eventBus:this.eventBus,findController:P(this,si).call(this).findController}))}_resetZoomLayer(e=!1){if(!this.zoomLayer)return;const n=this.zoomLayer.firstChild;this.paintedViewportMap.delete(n),n.width=0,n.height=0,e&&this.zoomLayer.remove(),this.zoomLayer=null}reset({keepZoomLayer:e=!1,keepAnnotationLayer:n=!1,keepAnnotationEditorLayer:a=!1,keepXfaLayer:i=!1,keepTextLayer:s=!1}={}){this.cancelRendering({keepAnnotationLayer:n,keepAnnotationEditorLayer:a,keepXfaLayer:i,keepTextLayer:s}),this.renderingState=Re.INITIAL;const o=this.div,l=o.childNodes,r=e&&this.zoomLayer||null,c=n&&this.annotationLayer?.div||null,d=a&&this.annotationEditorLayer?.div||null,u=i&&this.xfaLayer?.div||null,f=s&&this.textLayer?.div||null;for(let g=l.length-1;g>=0;g--){const h=l[g];switch(h){case r:case c:case d:case u:case f:continue}h.remove()}o.removeAttribute("data-loaded"),c&&this.annotationLayer.hide(),d&&this.annotationEditorLayer.hide(),u&&this.xfaLayer.hide(),f&&this.textLayer.hide(),this.structTreeLayer?.hide(),r||(this.canvas&&(this.paintedViewportMap.delete(this.canvas),this.canvas.width=0,this.canvas.height=0,delete this.canvas),this._resetZoomLayer()),(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this.svg&&(this.paintedViewportMap.delete(this.svg),delete this.svg)}update({scale:e=0,rotation:n=null,optionalContentConfigPromise:a=null,drawingDelay:i=-1}){this.scale=e||this.scale,typeof n=="number"&&(this.rotation=n),a instanceof Promise&&(this._optionalContentConfigPromise=a,a.then(c=>{a===this._optionalContentConfigPromise&&(P(this,ji).initialOptionalContent=c.hasInitialVisibility)}));const s=(this.rotation+this.pdfPageRotate)%360;if(this.viewport=this.viewport.clone({scale:this.scale*j.PixelsPerInch.PDF_TO_CSS_UNITS,rotation:s}),N(this,js,Kc).call(this),(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this._isStandalone&&this.div.parentNode?.style.setProperty("--scale-factor",this.viewport.scale),(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this.svg){this.cssTransform({target:this.svg,redrawAnnotationLayer:!0,redrawAnnotationEditorLayer:!0,redrawXfaLayer:!0,redrawTextLayer:!0}),this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0,timestamp:performance.now(),error:this._renderError});return}let o=!1;if(this.canvas&&this.maxCanvasPixels>0){const c=this.outputScale;(Math.floor(this.viewport.width)*c.sx|0)*(Math.floor(this.viewport.height)*c.sy|0)>this.maxCanvasPixels&&(o=!0)}const l=this.useOnlyCssZoom||this.hasRestrictedScaling&&o,r=!l&&i>=0&&i<1e3;if(this.canvas){if(r||l){r&&this.renderingState!==Re.FINISHED&&(this.cancelRendering({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0,cancelExtraDelay:i}),this.renderingState=Re.FINISHED),this.cssTransform({target:this.canvas,redrawAnnotationLayer:!0,redrawAnnotationEditorLayer:!0,redrawXfaLayer:!0,redrawTextLayer:!r,hideTextLayer:r}),this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!0,timestamp:performance.now(),error:this._renderError});return}!this.zoomLayer&&!this.canvas.hidden&&(this.zoomLayer=this.canvas.parentNode,this.zoomLayer.style.position="absolute")}this.zoomLayer&&this.cssTransform({target:this.zoomLayer.firstChild}),this.reset({keepZoomLayer:!0,keepAnnotationLayer:!0,keepAnnotationEditorLayer:!0,keepXfaLayer:!0,keepTextLayer:!0})}cancelRendering({keepAnnotationLayer:e=!1,keepAnnotationEditorLayer:n=!1,keepXfaLayer:a=!1,keepTextLayer:i=!1,cancelExtraDelay:s=0}={}){this.paintTask&&(this.paintTask.cancel(s),this.paintTask=null),this.resume=null,this.textLayer&&(!i||!this.textLayer.div)&&(this.textLayer.cancel(),this.textLayer=null),this.structTreeLayer&&!this.textLayer&&(this.structTreeLayer=null),this.annotationLayer&&(!e||!this.annotationLayer.div)&&(this.annotationLayer.cancel(),this.annotationLayer=null,this._annotationCanvasMap=null),this.annotationEditorLayer&&(!n||!this.annotationEditorLayer.div)&&(this.annotationEditorLayer.cancel(),this.annotationEditorLayer=null),this.xfaLayer&&(!a||!this.xfaLayer.div)&&(this.xfaLayer.cancel(),this.xfaLayer=null,this._textHighlighter?.disable())}cssTransform({target:e,redrawAnnotationLayer:n=!1,redrawAnnotationEditorLayer:a=!1,redrawXfaLayer:i=!1,redrawTextLayer:s=!1,hideTextLayer:o=!1}){if(e instanceof HTMLCanvasElement){if(!e.hasAttribute("zooming")){e.setAttribute("zooming",!0);const{style:r}=e;r.width=r.height=""}}else{const r=this.div,{width:c,height:d}=this.viewport;e.style.width=e.parentNode.style.width=r.style.width=Math.floor(c)+"px",e.style.height=e.parentNode.style.height=r.style.height=Math.floor(d)+"px"}const l=this.paintedViewportMap.get(e);if(this.viewport!==l){const r=this.viewport.rotation-l.rotation,c=Math.abs(r);let d=1,u=1;if(c===90||c===270){const{width:f,height:g}=this.viewport;d=g/f,u=f/g}e.style.transform=`rotate(${r}deg) scale(${d}, ${u})`}n&&this.annotationLayer&&N(this,wl,kf).call(this),a&&this.annotationEditorLayer&&N(this,yl,Sf).call(this),i&&this.xfaLayer&&N(this,_l,Lf).call(this),this.textLayer&&(o?(this.textLayer.hide(),this.structTreeLayer?.hide()):s&&N(this,vl,Cf).call(this))}get width(){return this.viewport.width}get height(){return this.viewport.height}getPagePoint(e,n){return this.viewport.convertToPdfPoint(e,n)}draw(){this.renderingState!==Re.INITIAL&&(console.error("Must be in new state before drawing"),this.reset());const{div:e,pdfPage:n}=this;if(!n)return this.renderingState=Re.FINISHED,Promise.reject(new Error("pdfPage is not loaded"));this.renderingState=Re.RUNNING;const a=document.createElement("div");if(a.classList.add("canvasWrapper"),e.append(a),!this.textLayer&&this.textLayerMode!==wr.DISABLE&&!n.isPureXfa&&(this._accessibilityManager||=new Ar,this.textLayer=new Wv({highlighter:this._textHighlighter,accessibilityManager:this._accessibilityManager,isOffscreenCanvasSupported:this.isOffscreenCanvasSupported}),e.append(this.textLayer.div)),!this.annotationLayer&&P(this,ii)!==j.AnnotationMode.DISABLE){const{annotationStorage:r,downloadManager:c,enableScripting:d,fieldObjectsPromise:u,hasJSActionsPromise:f,linkService:g}=P(this,si).call(this);this._annotationCanvasMap||=new Map,this.annotationLayer=new Nv({pageDiv:e,pdfPage:n,annotationStorage:r,imageResourcesPath:this.imageResourcesPath,renderForms:P(this,ii)===j.AnnotationMode.ENABLE_FORMS,linkService:g,downloadManager:c,l10n:this.l10n,enableScripting:d,hasJSActionsPromise:f,fieldObjectsPromise:u,annotationCanvasMap:this._annotationCanvasMap,accessibilityManager:this._accessibilityManager})}let i=null;this.renderingQueue&&(i=r=>{if(!this.renderingQueue.isHighestPriority(this)){this.renderingState=Re.PAUSED,this.resume=()=>{this.renderingState=Re.RUNNING,r()};return}r()});const s=async(r=null)=>{if(o===this.paintTask&&(this.paintTask=null),r instanceof j.RenderingCancelledException){this._renderError=null;return}if(this._renderError=r,this.renderingState=Re.FINISHED,this._resetZoomLayer(!0),P(this,ji).regularAnnotations=!o.separateAnnots,this.eventBus.dispatch("pagerendered",{source:this,pageNumber:this.id,cssTransform:!1,timestamp:performance.now(),error:this._renderError}),r)throw r},o=(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&this.renderer===br.SVG?this.paintOnSvg(a):this.paintOnCanvas(a);o.onRenderContinue=i,this.paintTask=o;const l=o.promise.then(()=>s(null).then(async()=>{if(N(this,vl,Cf).call(this),this.annotationLayer&&await N(this,wl,kf).call(this),!this.annotationEditorLayer){const{annotationEditorUIManager:r}=P(this,si).call(this);if(!r)return;this.annotationEditorLayer=new Mv({uiManager:r,pageDiv:e,pdfPage:n,l10n:this.l10n,accessibilityManager:this._accessibilityManager})}N(this,yl,Sf).call(this)}),function(r){return s(r)});if(n.isPureXfa){if(this.xfaLayer)this.xfaLayer.div&&e.append(this.xfaLayer.div);else{const{annotationStorage:r,linkService:c}=P(this,si).call(this);this.xfaLayer=new Vv({pageDiv:e,pdfPage:n,annotationStorage:r,linkService:c})}N(this,_l,Lf).call(this)}return e.setAttribute("data-loaded",!0),this.eventBus.dispatch("pagerender",{source:this,pageNumber:this.id}),l}paintOnCanvas(e){const n=(0,j.createPromiseCapability)(),a={promise:n.promise,onRenderContinue(v){v()},cancel(v=0){_.cancel(v)},get separateAnnots(){return _.separateAnnots}},i=this.viewport,{width:s,height:o}=i,l=document.createElement("canvas");l.setAttribute("role","presentation"),l.hidden=!0;let r=!0;const c=!!(this.pageColors?.background&&this.pageColors?.foreground),d=function(v){r&&(!c||v)&&(l.hidden=!1,r=!1)};e.append(l),this.canvas=l;const u=l.getContext("2d",{alpha:!1}),f=this.outputScale=new lh;if(this.useOnlyCssZoom){const v=i.clone({scale:j.PixelsPerInch.PDF_TO_CSS_UNITS});f.sx*=v.width/s,f.sy*=v.height/o}if(this.maxCanvasPixels>0){const v=s*o,k=Math.sqrt(this.maxCanvasPixels/v);f.sx>k||f.sy>k?(f.sx=k,f.sy=k,this.hasRestrictedScaling=!0):this.hasRestrictedScaling=!1}const g=dh(f.sx),h=dh(f.sy);l.width=_r(i.width*f.sx,g[0]),l.height=_r(i.height*f.sy,h[0]);const{style:m}=l;m.width=_r(i.width,g[1])+"px",m.height=_r(i.height,h[1])+"px",this.paintedViewportMap.set(l,i);const b=f.scaled?[f.sx,0,0,f.sy,0,0]:null,y={canvasContext:u,transform:b,viewport:i,annotationMode:P(this,ii),optionalContentConfigPromise:this._optionalContentConfigPromise,annotationCanvasMap:this._annotationCanvasMap,pageColors:this.pageColors},_=this.pdfPage.render(y);return _.onContinue=function(v){d(!1),a.onRenderContinue?a.onRenderContinue(v):v()},_.promise.then(function(){d(!0),n.resolve()},function(v){v instanceof j.RenderingCancelledException||d(!0),n.reject(v)}),a}paintOnSvg(e){if(!(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC")))throw new Error("Not implemented: paintOnSvg");let n=!1;const a=()=>{if(n)throw new j.RenderingCancelledException(`Rendering cancelled, page ${this.id}`,"svg")},i=this.pdfPage,s=this.viewport.clone({scale:j.PixelsPerInch.PDF_TO_CSS_UNITS});return{promise:i.getOperatorList({annotationMode:P(this,ii)}).then(l=>(a(),new j.SVGGraphics(i.commonObjs,i.objs).getSVG(l,s).then(c=>{a(),this.svg=c,this.paintedViewportMap.set(c,s),c.style.width=e.style.width,c.style.height=e.style.height,this.renderingState=Re.FINISHED,e.append(c)}))),onRenderContinue(l){l()},cancel(){n=!0},get separateAnnots(){return!1}}}setPageLabel(e){this.pageLabel=typeof e=="string"?e:null,this.pageLabel!==null?this.div.setAttribute("data-page-label",this.pageLabel):this.div.removeAttribute("data-page-label")}get thumbnailCanvas(){const{initialOptionalContent:e,regularAnnotations:n}=P(this,ji);return e&&n?this.canvas:null}}ii=new WeakMap,si=new WeakMap,oi=new WeakMap,bl=new WeakMap,Gs=new WeakMap,ji=new WeakMap,js=new WeakSet,Kc=function(){const{viewport:e}=this;if(this.pdfPage){if(P(this,bl)===e.rotation)return;oe(this,bl,e.rotation)}(0,j.setLayerDimensions)(this.div,e,!0,!1)},wl=new WeakSet,kf=async function(){let e=null;try{await this.annotationLayer.render(this.viewport,"display")}catch(n){console.error(`#renderAnnotationLayer: "${n}".`),e=n}finally{this.eventBus.dispatch("annotationlayerrendered",{source:this,pageNumber:this.id,error:e})}},yl=new WeakSet,Sf=async function(){let e=null;try{await this.annotationEditorLayer.render(this.viewport,"display")}catch(n){console.error(`#renderAnnotationEditorLayer: "${n}".`),e=n}finally{this.eventBus.dispatch("annotationeditorlayerrendered",{source:this,pageNumber:this.id,error:e})}},_l=new WeakSet,Lf=async function(){let e=null;try{const n=await this.xfaLayer.render(this.viewport,"display");n?.textDivs&&this._textHighlighter&&N(this,Ac,Ew).call(this,n.textDivs)}catch(n){console.error(`#renderXfaLayer: "${n}".`),e=n}finally{this.eventBus.dispatch("xfalayerrendered",{source:this,pageNumber:this.id,error:e})}},vl=new WeakSet,Cf=async function(){const{pdfPage:e,textLayer:n,viewport:a}=this;if(!n)return;let i=null;try{if(!n.renderingDone){const s=e.streamTextContent({includeMarkedContent:!0});n.setTextContentSource(s)}await n.render(a)}catch(s){if(s instanceof j.AbortException)return;console.error(`#renderTextLayer: "${s}".`),i=s}this.eventBus.dispatch("textlayerrendered",{source:this,pageNumber:this.id,numTextDivs:n.numTextDivs,error:i}),N(this,xc,vw).call(this)},xc=new WeakSet,vw=async function(){if(!this.textLayer)return;this.structTreeLayer||=new Ov;const e=await(this.structTreeLayer.renderingDone?null:this.pdfPage.getStructTree()),n=this.structTreeLayer?.render(e);n&&this.canvas?.append(n),this.structTreeLayer?.show()},Ac=new WeakSet,Ew=async function(e){const n=await this.pdfPage.getTextContent(),a=[];for(const i of n.items)a.push(i.str);this._textHighlighter.setTextMapping(e,a),this._textHighlighter.enable()};const jh=10,Kh="enablePermissions",No={FORCE_SCROLL_MODE_PAGE:15e3,FORCE_LAZY_PAGE_INIT:7500,PAUSE_EAGER_PAGE_INIT:250};function Zh(t){return Object.values(j.AnnotationEditorType).includes(t)&&t!==j.AnnotationEditorType.DISABLE}class jv{constructor(e){B(this,El);B(this,Na,new Set);B(this,Ki,0);oe(this,Ki,e)}push(e){const n=P(this,Na);n.has(e)&&n.delete(e),n.add(e),n.size>P(this,Ki)&&N(this,El,xf).call(this)}resize(e,n=null){oe(this,Ki,e);const a=P(this,Na);if(n){const i=a.size;let s=1;for(const o of a)if(n.has(o.id)&&(a.delete(o),a.add(o)),++s>i)break}for(;a.size>P(this,Ki);)N(this,El,xf).call(this)}has(e){return P(this,Na).has(e)}[Symbol.iterator](){return P(this,Na).keys()}}Na=new WeakMap,Ki=new WeakMap,El=new WeakSet,xf=function(){const e=P(this,Na).keys().next().value;e?.destroy(),P(this,Na).delete(e)};class Kv{constructor(e){B(this,Ic);B(this,Dc);B(this,$c);B(this,Qi);B(this,Ks);B(this,Pc);B(this,Cl);B(this,Mc);B(this,Jn);B(this,xl);B(this,Nc);B(this,Hc);B(this,Al);B(this,Oc);B(this,Zi,null);B(this,Ha,j.AnnotationEditorType.NONE);B(this,sn,null);B(this,Ji,j.AnnotationMode.ENABLE_FORMS);B(this,kl,null);B(this,Sl,!1);B(this,Ll,0);B(this,Tc,new ResizeObserver(N(this,Oc,Iw).bind(this)));B(this,Xi,null);B(this,kn,null);B(this,li,null);if(this.container=e.container,this.viewer=e.viewer||e.container.firstElementChild,typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC")){if(this.container?.tagName!=="DIV"||this.viewer?.tagName!=="DIV")throw new Error("Invalid `container` and/or `viewer` option.");if(this.container.offsetParent&&getComputedStyle(this.container).position!=="absolute")throw new Error("The `container` must be absolutely positioned.")}P(this,Tc).observe(this.container),this.eventBus=e.eventBus,this.linkService=e.linkService||new wh,this.downloadManager=e.downloadManager||null,this.findController=e.findController||null,this._scriptingManager=e.scriptingManager||null,this.textLayerMode=e.textLayerMode??wr.ENABLE,oe(this,Ji,e.annotationMode??j.AnnotationMode.ENABLE_FORMS),oe(this,Ha,e.annotationEditorMode??j.AnnotationEditorType.NONE),this.imageResourcesPath=e.imageResourcesPath||"",this.enablePrintAutoRotate=e.enablePrintAutoRotate||!1,(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&(this.removePageBorders=e.removePageBorders||!1,this.renderer=e.renderer||br.CANVAS),this.useOnlyCssZoom=e.useOnlyCssZoom||!1,this.isOffscreenCanvasSupported=e.isOffscreenCanvasSupported??!0,this.maxCanvasPixels=e.maxCanvasPixels,this.l10n=e.l10n||xr,oe(this,Sl,e.enablePermissions||!1),this.pageColors=e.pageColors||null,(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&this.pageColors&&!(CSS.supports("color",this.pageColors.background)&&CSS.supports("color",this.pageColors.foreground))&&((this.pageColors.background||this.pageColors.foreground)&&console.warn("PDFViewer: Ignoring `pageColors`-option, since the browser doesn't support the values used."),this.pageColors=null),this.defaultRenderingQueue=!e.renderingQueue,this.defaultRenderingQueue?(this.renderingQueue=new Mh,this.renderingQueue.setViewer(this)):this.renderingQueue=e.renderingQueue,this.scroll=rh(this.container,this._scrollUpdate.bind(this)),this.presentationModeState=Ot.UNKNOWN,this._onBeforeDraw=this._onAfterDraw=null,this._resetView(),(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&this.viewer.classList.add("removePageBorders"),N(this,Al,If).call(this)}get pagesCount(){return this._pages.length}getPageView(e){return this._pages[e]}get pageViewsReady(){return this._pagesCapability.settled?this._pages.every(function(e){return e?.pdfPage}):!1}get renderForms(){return P(this,Ji)===j.AnnotationMode.ENABLE_FORMS}get enableScripting(){return!!this._scriptingManager}get currentPageNumber(){return this._currentPageNumber}set currentPageNumber(e){if(!Number.isInteger(e))throw new Error("Invalid page number.");this.pdfDocument&&(this._setCurrentPageNumber(e,!0)||console.error(`currentPageNumber: "${e}" is not a valid page.`))}_setCurrentPageNumber(e,n=!1){if(this._currentPageNumber===e)return n&&N(this,xl,Tf).call(this),!0;if(!(0<e&&e<=this.pagesCount))return!1;const a=this._currentPageNumber;return this._currentPageNumber=e,this.eventBus.dispatch("pagechanging",{source:this,pageNumber:e,pageLabel:this._pageLabels?.[e-1]??null,previous:a}),n&&N(this,xl,Tf).call(this),!0}get currentPageLabel(){return this._pageLabels?.[this._currentPageNumber-1]??null}set currentPageLabel(e){if(!this.pdfDocument)return;let n=e|0;if(this._pageLabels){const a=this._pageLabels.indexOf(e);a>=0&&(n=a+1)}this._setCurrentPageNumber(n,!0)||console.error(`currentPageLabel: "${e}" is not a valid page.`)}get currentScale(){return this._currentScale!==lu?this._currentScale:iu}set currentScale(e){if(isNaN(e))throw new Error("Invalid numeric scale.");this.pdfDocument&&N(this,Jn,Oa).call(this,e,{noScroll:!1})}get currentScaleValue(){return this._currentScaleValue}set currentScaleValue(e){this.pdfDocument&&N(this,Jn,Oa).call(this,e,{noScroll:!1})}get pagesRotation(){return this._pagesRotation}set pagesRotation(e){if(!vr(e))throw new Error("Invalid pages rotation angle.");if(!this.pdfDocument||(e%=360,e<0&&(e+=360),this._pagesRotation===e))return;this._pagesRotation=e;const n=this._currentPageNumber;this.refresh(!0,{rotation:e}),this._currentScaleValue&&N(this,Jn,Oa).call(this,this._currentScaleValue,{noScroll:!0}),this.eventBus.dispatch("rotationchanging",{source:this,pagesRotation:e,pageNumber:n}),this.defaultRenderingQueue&&this.update()}get firstPagePromise(){return this.pdfDocument?this._firstPageCapability.promise:null}get onePageRendered(){return this.pdfDocument?this._onePageRenderedCapability.promise:null}get pagesPromise(){return this.pdfDocument?this._pagesCapability.promise:null}setDocument(e){if(this.pdfDocument&&(this.eventBus.dispatch("pagesdestroy",{source:this}),this._cancelRendering(),this._resetView(),this.findController?.setDocument(null),this._scriptingManager?.setDocument(null),P(this,sn)&&(P(this,sn).destroy(),oe(this,sn,null))),this.pdfDocument=e,!e)return;const n=e.numPages,a=e.getPage(1),i=e.getOptionalContentConfig(),s=P(this,Sl)?e.getPermissions():Promise.resolve();if(n>No.FORCE_SCROLL_MODE_PAGE){console.warn("Forcing PAGE-scrolling for performance reasons, given the length of the document.");const o=this._scrollMode=Ce.PAGE;this.eventBus.dispatch("scrollmodechanged",{source:this,mode:o})}this._pagesCapability.promise.then(()=>{this.eventBus.dispatch("pagesloaded",{source:this,pagesCount:n})},()=>{}),this._onBeforeDraw=o=>{const l=this._pages[o.pageNumber-1];l&&P(this,Zi).push(l)},this.eventBus._on("pagerender",this._onBeforeDraw),this._onAfterDraw=o=>{o.cssTransform||this._onePageRenderedCapability.settled||(this._onePageRenderedCapability.resolve({timestamp:o.timestamp}),this.eventBus._off("pagerendered",this._onAfterDraw),this._onAfterDraw=null,P(this,kn)&&(document.removeEventListener("visibilitychange",P(this,kn)),oe(this,kn,null)))},this.eventBus._on("pagerendered",this._onAfterDraw),Promise.all([a,s]).then(([o,l])=>{if(e!==this.pdfDocument)return;this._firstPageCapability.resolve(o),this._optionalContentConfigPromise=i;const{annotationEditorMode:r,annotationMode:c,textLayerMode:d}=N(this,Dc,Sw).call(this,l);if(r!==j.AnnotationEditorType.DISABLE){const b=r;e.isPureXfa?console.warn("Warning: XFA-editing is not implemented."):Zh(b)?(oe(this,sn,new j.AnnotationEditorUIManager(this.container,this.eventBus,e?.annotationStorage)),b!==j.AnnotationEditorType.NONE&&P(this,sn).updateMode(b)):console.error(`Invalid AnnotationEditor mode: ${b}`)}const u=N(this,Ic,kw).bind(this),f=this._scrollMode===Ce.PAGE?null:this.viewer,g=this.currentScale,h=o.getViewport({scale:g*j.PixelsPerInch.PDF_TO_CSS_UNITS});this.viewer.style.setProperty("--scale-factor",h.scale);for(let b=1;b<=n;++b){const y=new Gv({container:f,eventBus:this.eventBus,id:b,scale:g,defaultViewport:h.clone(),optionalContentConfigPromise:i,renderingQueue:this.renderingQueue,textLayerMode:d,annotationMode:c,imageResourcesPath:this.imageResourcesPath,renderer:typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC")?this.renderer:null,useOnlyCssZoom:this.useOnlyCssZoom,isOffscreenCanvasSupported:this.isOffscreenCanvasSupported,maxCanvasPixels:this.maxCanvasPixels,pageColors:this.pageColors,l10n:this.l10n,layerProperties:u});this._pages.push(y)}const m=this._pages[0];m&&(m.setPdfPage(o),this.linkService.cachePageRef(1,o.ref)),this._scrollMode===Ce.PAGE?N(this,Qi,Hl).call(this):this._spreadMode!==pt.NONE&&this._updateSpreadMode(),N(this,$c,Lw).call(this).then(async()=>{if(this.findController?.setDocument(e),this._scriptingManager?.setDocument(e),P(this,sn)&&this.eventBus.dispatch("annotationeditormodechanged",{source:this,mode:P(this,Ha)}),e.loadingParams.disableAutoFetch||n>No.FORCE_LAZY_PAGE_INIT){this._pagesCapability.resolve();return}let b=n-1;if(b<=0){this._pagesCapability.resolve();return}for(let y=2;y<=n;++y){const _=e.getPage(y).then(v=>{const k=this._pages[y-1];k.pdfPage||k.setPdfPage(v),this.linkService.cachePageRef(y,v.ref),--b===0&&this._pagesCapability.resolve()},v=>{console.error(`Unable to get page ${y} to initialize viewer`,v),--b===0&&this._pagesCapability.resolve()});y%No.PAUSE_EAGER_PAGE_INIT===0&&await _}}),this.eventBus.dispatch("pagesinit",{source:this}),e.getMetadata().then(({info:b})=>{e===this.pdfDocument&&b.Language&&(this.viewer.lang=b.Language)}),this.defaultRenderingQueue&&this.update()}).catch(o=>{console.error("Unable to initialize viewer",o),this._pagesCapability.reject(o)})}setPageLabels(e){if(this.pdfDocument){e?Array.isArray(e)&&this.pdfDocument.numPages===e.length?this._pageLabels=e:(this._pageLabels=null,console.error("setPageLabels: Invalid page labels.")):this._pageLabels=null;for(let n=0,a=this._pages.length;n<a;n++)this._pages[n].setPageLabel(this._pageLabels?.[n]??null)}}_resetView(){this._pages=[],this._currentPageNumber=1,this._currentScale=lu,this._currentScaleValue=null,this._pageLabels=null,oe(this,Zi,new jv(jh)),this._location=null,this._pagesRotation=0,this._optionalContentConfigPromise=null,this._firstPageCapability=(0,j.createPromiseCapability)(),this._onePageRenderedCapability=(0,j.createPromiseCapability)(),this._pagesCapability=(0,j.createPromiseCapability)(),this._scrollMode=Ce.VERTICAL,this._previousScrollMode=Ce.UNKNOWN,this._spreadMode=pt.NONE,oe(this,Xi,{previousPageNumber:1,scrollDown:!0,pages:[]}),this._onBeforeDraw&&(this.eventBus._off("pagerender",this._onBeforeDraw),this._onBeforeDraw=null),this._onAfterDraw&&(this.eventBus._off("pagerendered",this._onAfterDraw),this._onAfterDraw=null),P(this,kn)&&(document.removeEventListener("visibilitychange",P(this,kn)),oe(this,kn,null)),this.viewer.textContent="",this._updateScrollMode(),this.viewer.removeAttribute("lang"),this.viewer.classList.remove(Kh)}_scrollUpdate(){this.pagesCount!==0&&this.update()}pageLabelToPageNumber(e){if(!this._pageLabels)return null;const n=this._pageLabels.indexOf(e);return n<0?null:n+1}scrollPageIntoView({pageNumber:e,destArray:n=null,allowNegativeOffset:a=!1,ignoreDestinationZoom:i=!1}){if(!this.pdfDocument)return;const s=Number.isInteger(e)&&this._pages[e-1];if(!s){console.error(`scrollPageIntoView: "${e}" is not a valid pageNumber parameter.`);return}if(this.isInPresentationMode||!n){this._setCurrentPageNumber(e,!0);return}let o=0,l=0,r=0,c=0,d,u;const f=s.rotation%180!==0,g=(f?s.height:s.width)/s.scale/j.PixelsPerInch.PDF_TO_CSS_UNITS,h=(f?s.width:s.height)/s.scale/j.PixelsPerInch.PDF_TO_CSS_UNITS;let m=0;switch(n[1].name){case"XYZ":o=n[2],l=n[3],m=n[4],o=o!==null?o:0,l=l!==null?l:h;break;case"Fit":case"FitB":m="page-fit";break;case"FitH":case"FitBH":l=n[2],m="page-width",l===null&&this._location?(o=this._location.left,l=this._location.top):(typeof l!="number"||l<0)&&(l=h);break;case"FitV":case"FitBV":o=n[2],r=g,c=h,m="page-height";break;case"FitR":o=n[2],l=n[3],r=n[4]-o,c=n[5]-l;let v=sh,k=oh;(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.removePageBorders&&(v=k=0),d=(this.container.clientWidth-v)/r/j.PixelsPerInch.PDF_TO_CSS_UNITS,u=(this.container.clientHeight-k)/c/j.PixelsPerInch.PDF_TO_CSS_UNITS,m=Math.min(Math.abs(d),Math.abs(u));break;default:console.error(`scrollPageIntoView: "${n[1].name}" is not a valid destination type.`);return}if(i||(m&&m!==this._currentScale?this.currentScaleValue=m:this._currentScale===lu&&(this.currentScaleValue=$o)),m==="page-fit"&&!n[4]){N(this,Ks,Zc).call(this,s);return}const b=[s.viewport.convertToViewportPoint(o,l),s.viewport.convertToViewportPoint(o+r,l+c)];let y=Math.min(b[0][0],b[1][0]),_=Math.min(b[0][1],b[1][1]);a||(y=Math.max(y,0),_=Math.max(_,0)),N(this,Ks,Zc).call(this,s,{left:y,top:_})}_updateLocation(e){const n=this._currentScale,a=this._currentScaleValue,i=parseFloat(a)===n?Math.round(n*1e4)/100:a,s=e.id,o=this._pages[s-1],l=this.container,r=o.getPagePoint(l.scrollLeft-e.x,l.scrollTop-e.y),c=Math.round(r[0]),d=Math.round(r[1]);let u=`#page=${s}`;this.isInPresentationMode||(u+=`&zoom=${i},${c},${d}`),this._location={pageNumber:s,scale:i,top:d,left:c,rotation:this._pagesRotation,pdfOpenParams:u}}update(){const e=this._getVisiblePages(),n=e.views,a=n.length;if(a===0)return;const i=Math.max(jh,2*a+1);P(this,Zi).resize(i,e.ids),this.renderingQueue.renderHighestPriority(e);const s=this._spreadMode===pt.NONE&&(this._scrollMode===Ce.PAGE||this._scrollMode===Ce.VERTICAL),o=this._currentPageNumber;let l=!1;for(const r of n){if(r.percent<100)break;if(r.id===o&&s){l=!0;break}}this._setCurrentPageNumber(l?o:n[0].id),this._updateLocation(e.first),this.eventBus.dispatch("updateviewarea",{source:this,location:this._location})}containsElement(e){return this.container.contains(e)}focus(){this.container.focus(),this.container.parentElement.querySelector("#sidebarToggle").focus()}get _isContainerRtl(){return getComputedStyle(this.container).direction==="rtl"}get isInPresentationMode(){return this.presentationModeState===Ot.FULLSCREEN}get isChangingPresentationMode(){return this.presentationModeState===Ot.CHANGING}get isHorizontalScrollbarEnabled(){return this.isInPresentationMode?!1:this.container.scrollWidth>this.container.clientWidth}get isVerticalScrollbarEnabled(){return this.isInPresentationMode?!1:this.container.scrollHeight>this.container.clientHeight}_getVisiblePages(){const e=this._scrollMode===Ce.PAGE?P(this,Xi).pages:this._pages,n=this._scrollMode===Ce.HORIZONTAL,a=n&&this._isContainerRtl;return uh({scrollEl:this.container,views:e,sortByVisibility:!0,horizontal:n,rtl:a})}isPageVisible(e){return this.pdfDocument?Number.isInteger(e)&&e>0&&e<=this.pagesCount?this._getVisiblePages().ids.has(e):(console.error(`isPageVisible: "${e}" is not a valid page.`),!1):!1}isPageCached(e){if(!this.pdfDocument)return!1;if(!(Number.isInteger(e)&&e>0&&e<=this.pagesCount))return console.error(`isPageCached: "${e}" is not a valid page.`),!1;const n=this._pages[e-1];return P(this,Zi).has(n)}cleanup(){for(const e of this._pages)e.renderingState!==Re.FINISHED&&e.reset()}_cancelRendering(){for(const e of this._pages)e.cancelRendering()}forceRendering(e){const n=e||this._getVisiblePages(),a=N(this,Hc,Tw).call(this,n),i=this._spreadMode!==pt.NONE&&this._scrollMode!==Ce.HORIZONTAL,s=this.renderingQueue.getHighestPriority(n,this._pages,a,i);return s?(N(this,Nc,Aw).call(this,s).then(()=>{this.renderingQueue.renderView(s)}),!0):!1}get hasEqualPageSizes(){const e=this._pages[0];for(let n=1,a=this._pages.length;n<a;++n){const i=this._pages[n];if(i.width!==e.width||i.height!==e.height)return!1}return!0}getPagesOverview(){return this._pages.map(e=>{const n=e.pdfPage.getViewport({scale:1});return!this.enablePrintAutoRotate||cu(n)?{width:n.width,height:n.height,rotation:n.rotation}:{width:n.height,height:n.width,rotation:(n.rotation-90)%360}})}get optionalContentConfigPromise(){return this.pdfDocument?this._optionalContentConfigPromise?this._optionalContentConfigPromise:(console.error("optionalContentConfigPromise: Not initialized yet."),this.pdfDocument.getOptionalContentConfig()):Promise.resolve(null)}set optionalContentConfigPromise(e){if(!(e instanceof Promise))throw new Error(`Invalid optionalContentConfigPromise: ${e}`);this.pdfDocument&&this._optionalContentConfigPromise&&(this._optionalContentConfigPromise=e,this.refresh(!1,{optionalContentConfigPromise:e}),this.eventBus.dispatch("optionalcontentconfigchanged",{source:this,promise:e}))}get scrollMode(){return this._scrollMode}set scrollMode(e){if(this._scrollMode!==e){if(!ph(e))throw new Error(`Invalid scroll mode: ${e}`);this.pagesCount>No.FORCE_SCROLL_MODE_PAGE||(this._previousScrollMode=this._scrollMode,this._scrollMode=e,this.eventBus.dispatch("scrollmodechanged",{source:this,mode:e}),this._updateScrollMode(this._currentPageNumber))}}_updateScrollMode(e=null){const n=this._scrollMode,a=this.viewer;a.classList.toggle("scrollHorizontal",n===Ce.HORIZONTAL),a.classList.toggle("scrollWrapped",n===Ce.WRAPPED),!(!this.pdfDocument||!e)&&(n===Ce.PAGE?N(this,Qi,Hl).call(this):this._previousScrollMode===Ce.PAGE&&this._updateSpreadMode(),this._currentScaleValue&&isNaN(this._currentScaleValue)&&N(this,Jn,Oa).call(this,this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}get spreadMode(){return this._spreadMode}set spreadMode(e){if(this._spreadMode!==e){if(!gh(e))throw new Error(`Invalid spread mode: ${e}`);this._spreadMode=e,this.eventBus.dispatch("spreadmodechanged",{source:this,mode:e}),this._updateSpreadMode(this._currentPageNumber)}}_updateSpreadMode(e=null){if(!this.pdfDocument)return;const n=this.viewer,a=this._pages;if(this._scrollMode===Ce.PAGE)N(this,Qi,Hl).call(this);else if(n.textContent="",this._spreadMode===pt.NONE)for(const i of this._pages)n.append(i.div);else{const i=this._spreadMode-1;let s=null;for(let o=0,l=a.length;o<l;++o)s===null?(s=document.createElement("div"),s.className="spread",n.append(s)):o%2===i&&(s=s.cloneNode(!1),n.append(s)),s.append(a[o].div)}e&&(this._currentScaleValue&&isNaN(this._currentScaleValue)&&N(this,Jn,Oa).call(this,this._currentScaleValue,{noScroll:!0}),this._setCurrentPageNumber(e,!0),this.update())}_getPageAdvance(e,n=!1){switch(this._scrollMode){case Ce.WRAPPED:{const{views:a}=this._getVisiblePages(),i=new Map;for(const{id:s,y:o,percent:l,widthPercent:r}of a){if(l===0||r<100)continue;let c=i.get(o);c||i.set(o,c||=[]),c.push(s)}for(const s of i.values()){const o=s.indexOf(e);if(o===-1)continue;const l=s.length;if(l===1)break;if(n)for(let r=o-1,c=0;r>=c;r--){const d=s[r],u=s[r+1]-1;if(d<u)return e-u}else for(let r=o+1,c=l;r<c;r++){const d=s[r],u=s[r-1]+1;if(d>u)return u-e}if(n){const r=s[0];if(r<e)return e-r+1}else{const r=s[l-1];if(r>e)return r-e+1}break}break}case Ce.HORIZONTAL:break;case Ce.PAGE:case Ce.VERTICAL:{if(this._spreadMode===pt.NONE)break;const a=this._spreadMode-1;if(n&&e%2!==a)break;if(!n&&e%2===a)break;const{views:i}=this._getVisiblePages(),s=n?e-1:e+1;for(const{id:o,percent:l,widthPercent:r}of i)if(o===s){if(l>0&&r===100)return 2;break}break}}return 1}nextPage(){const e=this._currentPageNumber,n=this.pagesCount;if(e>=n)return!1;const a=this._getPageAdvance(e,!1)||1;return this.currentPageNumber=Math.min(e+a,n),!0}previousPage(){const e=this._currentPageNumber;if(e<=1)return!1;const n=this._getPageAdvance(e,!0)||1;return this.currentPageNumber=Math.max(e-n,1),!0}increaseScale({drawingDelay:e,scaleFactor:n,steps:a}={}){if(!this.pdfDocument)return;let i=this._currentScale;if(n>1)i=Math.round(i*n*100)/100;else{a??=1;do i=Math.ceil((i*ih).toFixed(2)*10)/10;while(--a>0&&i<ou)}N(this,Jn,Oa).call(this,Math.min(ou,i),{noScroll:!1,drawingDelay:e})}decreaseScale({drawingDelay:e,scaleFactor:n,steps:a}={}){if(!this.pdfDocument)return;let i=this._currentScale;if(n>0&&n<1)i=Math.round(i*n*100)/100;else{a??=1;do i=Math.floor((i/ih).toFixed(2)*10)/10;while(--a>0&&i>su)}N(this,Jn,Oa).call(this,Math.max(su,i),{noScroll:!1,drawingDelay:e})}get containerTopLeft(){return P(this,kl)||oe(this,kl,[this.container.offsetTop,this.container.offsetLeft])}get annotationEditorMode(){return P(this,sn)?P(this,Ha):j.AnnotationEditorType.DISABLE}set annotationEditorMode(e){if(!P(this,sn))throw new Error("The AnnotationEditor is not enabled.");if(P(this,Ha)!==e){if(!Zh(e))throw new Error(`Invalid AnnotationEditor mode: ${e}`);this.pdfDocument&&(oe(this,Ha,e),this.eventBus.dispatch("annotationeditormodechanged",{source:this,mode:e}),P(this,sn).updateMode(e))}}set annotationEditorParams({type:e,value:n}){if(!P(this,sn))throw new Error("The AnnotationEditor is not enabled.");P(this,sn).updateParams(e,n)}refresh(e=!1,n=Object.create(null)){if(this.pdfDocument){for(const a of this._pages)a.update(n);P(this,li)!==null&&(clearTimeout(P(this,li)),oe(this,li,null)),e||this.update()}}}Zi=new WeakMap,Ha=new WeakMap,sn=new WeakMap,Ji=new WeakMap,kl=new WeakMap,Sl=new WeakMap,Ll=new WeakMap,Tc=new WeakMap,Xi=new WeakMap,kn=new WeakMap,li=new WeakMap,Ic=new WeakSet,kw=function(){const e=this;return{get annotationEditorUIManager(){return P(e,sn)},get annotationStorage(){return e.pdfDocument?.annotationStorage},get downloadManager(){return e.downloadManager},get enableScripting(){return!!e._scriptingManager},get fieldObjectsPromise(){return e.pdfDocument?.getFieldObjects()},get findController(){return e.findController},get hasJSActionsPromise(){return e.pdfDocument?.hasJSActions()},get linkService(){return e.linkService}}},Dc=new WeakSet,Sw=function(e){const n={annotationEditorMode:P(this,Ha),annotationMode:P(this,Ji),textLayerMode:this.textLayerMode};return e&&(e.includes(j.PermissionFlag.COPY)||this.viewer.classList.add(Kh),e.includes(j.PermissionFlag.MODIFY_CONTENTS)||(n.annotationEditorMode=j.AnnotationEditorType.DISABLE),!e.includes(j.PermissionFlag.MODIFY_ANNOTATIONS)&&!e.includes(j.PermissionFlag.FILL_INTERACTIVE_FORMS)&&P(this,Ji)===j.AnnotationMode.ENABLE_FORMS&&(n.annotationMode=j.AnnotationMode.ENABLE)),n},$c=new WeakSet,Lw=function(){if(document.visibilityState==="hidden"||!this.container.offsetParent||this._getVisiblePages().views.length===0)return Promise.resolve();const e=new Promise(n=>{oe(this,kn,()=>{document.visibilityState==="hidden"&&(n(),document.removeEventListener("visibilitychange",P(this,kn)),oe(this,kn,null))}),document.addEventListener("visibilitychange",P(this,kn))});return Promise.race([this._onePageRenderedCapability.promise,e])},Qi=new WeakSet,Hl=function(){if(this._scrollMode!==Ce.PAGE)throw new Error("#ensurePageViewVisible: Invalid scrollMode value.");const e=this._currentPageNumber,n=P(this,Xi),a=this.viewer;if(a.textContent="",n.pages.length=0,this._spreadMode===pt.NONE&&!this.isInPresentationMode){const i=this._pages[e-1];a.append(i.div),n.pages.push(i)}else{const i=new Set,s=this._spreadMode-1;s===-1?i.add(e-1):e%2!==s?(i.add(e-1),i.add(e)):(i.add(e-2),i.add(e-1));const o=document.createElement("div");if(o.className="spread",this.isInPresentationMode){const l=document.createElement("div");l.className="dummyPage",o.append(l)}for(const l of i){const r=this._pages[l];r&&(o.append(r.div),n.pages.push(r))}a.append(o)}n.scrollDown=e>=n.previousPageNumber,n.previousPageNumber=e},Ks=new WeakSet,Zc=function(e,n=null){const{div:a,id:i}=e;if(this._currentPageNumber!==i&&this._setCurrentPageNumber(i),this._scrollMode===Ce.PAGE&&(N(this,Qi,Hl).call(this),this.update()),!n&&!this.isInPresentationMode){const s=a.offsetLeft+a.clientLeft,o=s+a.clientWidth,{scrollLeft:l,clientWidth:r}=this.container;(this._scrollMode===Ce.HORIZONTAL||s<l||o>l+r)&&(n={left:0,top:0})}ru(a,n),!this._currentScaleValue&&this._location&&(this._location=null)},Pc=new WeakSet,Cw=function(e){return e===this._currentScale||Math.abs(e-this._currentScale)<1e-15},Cl=new WeakSet,Af=function(e,n,{noScroll:a=!1,preset:i=!1,drawingDelay:s=-1}){if(this._currentScaleValue=n.toString(),N(this,Pc,Cw).call(this,e)){i&&this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:n});return}this.viewer.style.setProperty("--scale-factor",e*j.PixelsPerInch.PDF_TO_CSS_UNITS);const o=s>=0&&s<1e3;if(this.refresh(!0,{scale:e,drawingDelay:o?s:-1}),o&&oe(this,li,setTimeout(()=>{oe(this,li,null),this.refresh()},s)),this._currentScale=e,!a){let l=this._currentPageNumber,r;this._location&&!(this.isInPresentationMode||this.isChangingPresentationMode)&&(l=this._location.pageNumber,r=[null,{name:"XYZ"},this._location.left,this._location.top,null]),this.scrollPageIntoView({pageNumber:l,destArray:r,allowNegativeOffset:!0})}this.eventBus.dispatch("scalechanging",{source:this,scale:e,presetValue:i?n:void 0}),this.defaultRenderingQueue&&this.update()},Mc=new WeakSet,xw=function(){return this._spreadMode!==pt.NONE&&this._scrollMode!==Ce.HORIZONTAL?2:1},Jn=new WeakSet,Oa=function(e,n){let a=parseFloat(e);if(a>0)n.preset=!1,N(this,Cl,Af).call(this,a,e,n);else{const i=this._pages[this._currentPageNumber-1];if(!i)return;let s=sh,o=oh;this.isInPresentationMode?(s=o=4,this._spreadMode!==pt.NONE&&(s*=2)):(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.removePageBorders?s=o=0:this._scrollMode===Ce.HORIZONTAL&&([s,o]=[o,s]);const l=(this.container.clientWidth-s)/i.width*i.scale/P(this,Mc,xw),r=(this.container.clientHeight-o)/i.height*i.scale;switch(e){case"page-actual":a=1;break;case"page-width":a=l;break;case"page-height":a=r;break;case"page-fit":a=Math.min(l,r);break;case"auto":const c=cu(i)?l:Math.min(r,l);a=Math.min(v_,c);break;default:console.error(`#setScale: "${e}" is an unknown zoom value.`);return}n.preset=!0,N(this,Cl,Af).call(this,a,e,n)}},xl=new WeakSet,Tf=function(){const e=this._pages[this._currentPageNumber-1];this.isInPresentationMode&&N(this,Jn,Oa).call(this,this._currentScaleValue,{noScroll:!0}),N(this,Ks,Zc).call(this,e)},Nc=new WeakSet,Aw=async function(e){if(e.pdfPage)return e.pdfPage;try{const n=await this.pdfDocument.getPage(e.id);return e.pdfPage||e.setPdfPage(n),this.linkService._cachedPageNumber?.(n.ref)||this.linkService.cachePageRef(e.id,n.ref),n}catch(n){return console.error("Unable to get page for page view",n),null}},Hc=new WeakSet,Tw=function(e){if(e.first?.id===1)return!0;if(e.last?.id===this.pagesCount)return!1;switch(this._scrollMode){case Ce.PAGE:return P(this,Xi).scrollDown;case Ce.HORIZONTAL:return this.scroll.right}return this.scroll.down},Al=new WeakSet,If=function(e=this.container.clientHeight){e!==P(this,Ll)&&(oe(this,Ll,e),du.setProperty("--viewer-container-height",`${e}px`))},Oc=new WeakSet,Iw=function(e){for(const n of e)if(n.target===this.container){N(this,Al,If).call(this,Math.floor(n.borderBoxSize[0].blockSize)),oe(this,kl,null);break}};class Zv{constructor(e,n,a){B(this,Zs);B(this,Rc);B(this,Bc);B(this,qc);B(this,Fc);this.toolbar=e.toolbar,this.toggleButton=e.toggleButton,this.buttons=[{element:e.presentationModeButton,eventName:"presentationmode",close:!0},{element:e.printButton,eventName:"print",close:!0},{element:e.downloadButton,eventName:"download",close:!0},{element:e.viewBookmarkButton,eventName:null,close:!0},{element:e.firstPageButton,eventName:"firstpage",close:!0},{element:e.lastPageButton,eventName:"lastpage",close:!0},{element:e.pageRotateCwButton,eventName:"rotatecw",close:!1},{element:e.pageRotateCcwButton,eventName:"rotateccw",close:!1},{element:e.cursorSelectToolButton,eventName:"switchcursortool",eventDetails:{tool:nn.SELECT},close:!0},{element:e.cursorHandToolButton,eventName:"switchcursortool",eventDetails:{tool:nn.HAND},close:!0},{element:e.scrollPageButton,eventName:"switchscrollmode",eventDetails:{mode:Ce.PAGE},close:!0},{element:e.scrollVerticalButton,eventName:"switchscrollmode",eventDetails:{mode:Ce.VERTICAL},close:!0},{element:e.scrollHorizontalButton,eventName:"switchscrollmode",eventDetails:{mode:Ce.HORIZONTAL},close:!0},{element:e.scrollWrappedButton,eventName:"switchscrollmode",eventDetails:{mode:Ce.WRAPPED},close:!0},{element:e.spreadNoneButton,eventName:"switchspreadmode",eventDetails:{mode:pt.NONE},close:!0},{element:e.spreadOddButton,eventName:"switchspreadmode",eventDetails:{mode:pt.ODD},close:!0},{element:e.spreadEvenButton,eventName:"switchspreadmode",eventDetails:{mode:pt.EVEN},close:!0},{element:e.documentPropertiesButton,eventName:"documentproperties",close:!0}],this.items={firstPage:e.firstPageButton,lastPage:e.lastPageButton,pageRotateCw:e.pageRotateCwButton,pageRotateCcw:e.pageRotateCcwButton},this.eventBus=n,this.externalServices=a,this.opened=!1,N(this,Rc,Dw).call(this),N(this,Bc,$w).call(this,e),N(this,qc,Pw).call(this,e),N(this,Fc,Mw).call(this,e),this.reset()}get isOpen(){return this.opened}setPageNumber(e){this.pageNumber=e,N(this,Zs,Jc).call(this)}setPagesCount(e){this.pagesCount=e,N(this,Zs,Jc).call(this)}reset(){this.pageNumber=0,this.pagesCount=0,N(this,Zs,Jc).call(this),this.eventBus.dispatch("secondarytoolbarreset",{source:this})}open(){this.opened||(this.opened=!0,this.toggleButton.classList.add("toggled"),this.toggleButton.setAttribute("aria-expanded","true"),this.toolbar.classList.remove("fn__hidden"))}close(){this.opened&&(this.opened=!1,this.toolbar.classList.add("fn__hidden"),this.toggleButton.classList.remove("toggled"),this.toggleButton.setAttribute("aria-expanded","false"))}toggle(){this.opened?this.close():this.open()}}Zs=new WeakSet,Jc=function(){this.items.firstPage.disabled=this.pageNumber<=1,this.items.lastPage.disabled=this.pageNumber>=this.pagesCount,this.items.pageRotateCw.disabled=this.pagesCount===0,this.items.pageRotateCcw.disabled=this.pagesCount===0},Rc=new WeakSet,Dw=function(){this.toggleButton.addEventListener("click",this.toggle.bind(this));for(const{element:e,eventName:n,close:a,eventDetails:i}of this.buttons)e.addEventListener("click",s=>{n!==null&&this.eventBus.dispatch(n,{source:this,...i}),a&&this.close(),this.externalServices.reportTelemetry({type:"buttons",data:{id:e.id}})})},Bc=new WeakSet,$w=function({cursorSelectToolButton:e,cursorHandToolButton:n}){this.eventBus._on("cursortoolchanged",function({tool:a}){const i=a===nn.SELECT,s=a===nn.HAND;e.classList.toggle("toggled",i),n.classList.toggle("toggled",s),e.setAttribute("aria-checked",i),n.setAttribute("aria-checked",s)})},qc=new WeakSet,Pw=function({scrollPageButton:e,scrollVerticalButton:n,scrollHorizontalButton:a,scrollWrappedButton:i,spreadNoneButton:s,spreadOddButton:o,spreadEvenButton:l}){const r=({mode:c})=>{const d=c===Ce.PAGE,u=c===Ce.VERTICAL,f=c===Ce.HORIZONTAL,g=c===Ce.WRAPPED;e.classList.toggle("toggled",d),n.classList.toggle("toggled",u),a.classList.toggle("toggled",f),i.classList.toggle("toggled",g),e.setAttribute("aria-checked",d),n.setAttribute("aria-checked",u),a.setAttribute("aria-checked",f),i.setAttribute("aria-checked",g);const h=this.pagesCount>No.FORCE_SCROLL_MODE_PAGE;e.disabled=h,n.disabled=h,a.disabled=h,i.disabled=h,s.disabled=f,o.disabled=f,l.disabled=f};this.eventBus._on("scrollmodechanged",r),this.eventBus._on("secondarytoolbarreset",c=>{c.source===this&&r({mode:Ce.VERTICAL})})},Fc=new WeakSet,Mw=function({spreadNoneButton:e,spreadOddButton:n,spreadEvenButton:a}){function i({mode:s}){const o=s===pt.NONE,l=s===pt.ODD,r=s===pt.EVEN;e.classList.toggle("toggled",o),n.classList.toggle("toggled",l),a.classList.toggle("toggled",r),e.setAttribute("aria-checked",o),n.setAttribute("aria-checked",l),a.setAttribute("aria-checked",r)}this.eventBus._on("spreadmodechanged",i),this.eventBus._on("secondarytoolbarreset",s=>{s.source===this&&i({mode:pt.NONE})})};const Jv="visiblePageIsLoading";class Xv{constructor(e,n,a){B(this,Uc);B(this,Xu);B(this,ri);B(this,Wc);B(this,Tl,!1);this.toolbar=e.container,this.eventBus=n,this.l10n=a,this.buttons=[{element:e.previous,eventName:"previouspage"},{element:e.next,eventName:"nextpage"},{element:e.zoomIn,eventName:"zoomin"},{element:e.zoomOut,eventName:"zoomout"},{element:e.print,eventName:"print"},{element:e.download,eventName:"download"},{element:e.editorFreeTextButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:i}=e.editorFreeTextButton;return i.contains("toggled")?j.AnnotationEditorType.NONE:j.AnnotationEditorType.FREETEXT}}},{element:e.editorInkButton,eventName:"switchannotationeditormode",eventDetails:{get mode(){const{classList:i}=e.editorInkButton;return i.contains("toggled")?j.AnnotationEditorType.NONE:j.AnnotationEditorType.INK}}}],(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.buttons.push({element:e.openFile,eventName:"openfile"}),this.items={numPages:e.numPages,pageNumber:e.pageNumber,scaleSelect:e.scaleSelect,customScaleOption:e.customScaleOption,previous:e.previous,next:e.next,zoomIn:e.zoomIn,zoomOut:e.zoomOut},N(this,Uc,Nw).call(this,e),this.reset()}setPageNumber(e,n){this.pageNumber=e,this.pageLabel=n,N(this,ri,Qs).call(this,!1)}setPagesCount(e,n){this.pagesCount=e,this.hasPageLabels=n,N(this,ri,Qs).call(this,!0)}setPageScale(e,n){this.pageScaleValue=(e||n).toString(),this.pageScale=n,N(this,ri,Qs).call(this,!1)}reset(){this.pageNumber=0,this.pageLabel=null,this.hasPageLabels=!1,this.pagesCount=0,this.pageScaleValue=$o,this.pageScale=iu,N(this,ri,Qs).call(this,!0),this.updateLoadingIndicatorState(),this.eventBus.dispatch("toolbarreset",{source:this})}updateLoadingIndicatorState(e=!1){const{pageNumber:n}=this.items;n.classList.toggle(Jv,e)}}Tl=new WeakMap,Uc=new WeakSet,Nw=function(e){const{pageNumber:n,scaleSelect:a}=this.items,i=this;for(const{element:s,eventName:o,eventDetails:l}of this.buttons)s.addEventListener("click",r=>{o!==null&&this.eventBus.dispatch(o,{source:this,...l})});n.addEventListener("click",function(){this.select()}),n.addEventListener("change",function(){i.eventBus.dispatch("pagenumberchanged",{source:i,value:this.value})}),a.addEventListener("change",function(){this.value!=="custom"&&i.eventBus.dispatch("scalechanged",{source:i,value:this.value})}),a.addEventListener("click",function(s){const o=s.target;this.value===i.pageScaleValue&&o.tagName.toUpperCase()==="OPTION"&&this.blur()}),a.oncontextmenu=C_,this.eventBus._on("localized",()=>{oe(this,Tl,!0),N(this,Wc,Hw).call(this),N(this,ri,Qs).call(this,!0)})},Xu=new WeakSet,$k=function({editorFreeTextButton:e,editorFreeTextParamsToolbar:n,editorInkButton:a,editorInkParamsToolbar:i}){const s=(o,l=!1)=>{const r=[{mode:j.AnnotationEditorType.FREETEXT,button:e,toolbar:n},{mode:j.AnnotationEditorType.INK,button:a,toolbar:i}];for(const{mode:c,button:d,toolbar:u}of r){const f=c===o.mode;d.classList.toggle("toggled",f),d.setAttribute("aria-checked",f),d.disabled=l,u?.classList.toggle("fn__hidden",!f)}};this.eventBus._on("annotationeditormodechanged",s),this.eventBus._on("toolbarreset",o=>{o.source===this&&s({mode:j.AnnotationEditorType.NONE},!0)})},ri=new WeakSet,Qs=function(e=!1){if(!P(this,Tl))return;const{pageNumber:n,pagesCount:a,pageScaleValue:i,pageScale:s,items:o}=this;e&&(this.hasPageLabels?o.pageNumber.type="text":(o.pageNumber.type="number",o.numPages.textContent="/ "+a),o.pageNumber.max=a),this.hasPageLabels?(o.pageNumber.value=this.pageLabel,o.numPages.textContent=`(${n} / ${a})`):o.pageNumber.value=n,o.previous.disabled=n<=1,o.next.disabled=n>=a,o.zoomOut.disabled=s<=su,o.zoomIn.disabled=s>=ou;let l=!1;for(const r of o.scaleSelect.options){if(r.value!==i){r.selected=!1;continue}r.selected=!0,l=!0}l||(o.customScaleOption.textContent=`${Math.round(s*1e4)/100}%`,o.customScaleOption.selected=!0)},Wc=new WeakSet,Hw=async function(){const{items:e,l10n:n}=this,a=[window.siyuan.languages.pageScaleAuto,window.siyuan.languages.pageScaleActual,window.siyuan.languages.pageScaleFit,window.siyuan.languages.pageScaleWidth];await hh;const i=getComputedStyle(e.scaleSelect),s=parseFloat(i.getPropertyValue("--scale-select-width")),o=document.createElement("canvas"),l=o.getContext("2d",{alpha:!1});l.font=`${i.fontSize} ${i.fontFamily}`;let r=0;for(const c of await a){const{width:d}=l.measureText(c);d>r&&(r=d)}r+=.3*s,r>s&&e.scaleSelect.parentNode.style.setProperty("--scale-select-width",`${r}px`),o.width=0,o.height=0};const Qv=20;class eE{constructor(e,n=Qv){this.fingerprint=e,this.cacheSize=n,this._initializedPromise=this._readFromStorage().then(a=>{const i=JSON.parse(a||"{}");let s=-1;if(!Array.isArray(i.files))i.files=[];else{for(;i.files.length>=this.cacheSize;)i.files.shift();for(let o=0,l=i.files.length;o<l;o++)if(i.files[o].fingerprint===this.fingerprint){s=o;break}}s===-1&&(s=i.files.push({fingerprint:this.fingerprint})-1),this.file=i.files[s],this.database=i})}async _writeToStorage(){const e=JSON.stringify(this.database);if(typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")){sessionStorage.setItem("pdfjs.history",e);return}window.siyuan.storage["pdfjs.history"]=e,pe("pdfjs.history",e)}async _readFromStorage(){return typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")?sessionStorage.getItem("pdfjs.history"):window.siyuan.storage["pdfjs.history"]}async set(e,n){return await this._initializedPromise,this.file[e]=n,this._writeToStorage()}async setMultiple(e){await this._initializedPromise;for(const n in e)this.file[n]=e[n];return this._writeToStorage()}async get(e,n){await this._initializedPromise;const a=this.file[e];return a!==void 0?a:n}async getMultiple(e){await this._initializedPromise;const n=Object.create(null);for(const a in e){const i=this.file[a];n[a]=i!==void 0?i:e[a]}return n}}const Qu=class{constructor(){B(this,Rn,Object.freeze(typeof PDFJSDev>"u"||!PDFJSDev.test("PRODUCTION")?ge.getAll(ne.PREFERENCE):PDFJSDev.eval("DEFAULT_PREFERENCES")));B(this,Sn,Object.create(null));B(this,ci,null);if(this.constructor===Qu)throw new Error("Cannot initialize BasePreferences.");typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")&&Object.defineProperty(this,"defaults",{get(){return P(this,Rn)}}),oe(this,ci,this._readFromStorage(P(this,Rn)).then(e=>{for(const n in P(this,Rn)){const a=e?.[n];typeof a==typeof P(this,Rn)[n]&&(P(this,Sn)[n]=a)}}))}async _writeToStorage(e){throw new Error("Not implemented: _writeToStorage")}async _readFromStorage(e){throw new Error("Not implemented: _readFromStorage")}async reset(){await P(this,ci);const e=P(this,Sn);return oe(this,Sn,Object.create(null)),this._writeToStorage(P(this,Rn)).catch(n=>{throw oe(this,Sn,e),n})}async set(e,n){await P(this,ci);const a=P(this,Rn)[e],i=P(this,Sn);if(a===void 0)throw new Error(`Set preference: "${e}" is undefined.`);if(n===void 0)throw new Error("Set preference: no value is specified.");const s=typeof n,o=typeof a;if(s!==o)if(s==="number"&&o==="string")n=n.toString();else throw new Error(`Set preference: "${n}" is a ${s}, expected a ${o}.`);else if(s==="number"&&!Number.isInteger(n))throw new Error(`Set preference: "${n}" must be an integer.`);return P(this,Sn)[e]=n,this._writeToStorage(P(this,Sn)).catch(l=>{throw oe(this,Sn,i),l})}async get(e){await P(this,ci);const n=P(this,Rn)[e];if(n===void 0)throw new Error(`Get preference: "${e}" is undefined.`);return P(this,Sn)[e]??n}async getAll(){await P(this,ci);const e=Object.create(null);for(const n in P(this,Rn))e[n]=P(this,Sn)[n]??P(this,Rn)[n];return e}};let _u=Qu;Rn=new WeakMap,Sn=new WeakMap,ci=new WeakMap;var tE=Ye(916);if(typeof PDFJSDev<"u"&&!PDFJSDev.test("GENERIC"))throw new Error('Module "pdfjs-web/genericcom" shall not be used outside GENERIC build.');const qk={};class nE extends _u{async _writeToStorage(e){localStorage.setItem("pdfjs.preferences",JSON.stringify(e))}async _readFromStorage(e){return JSON.parse(localStorage.getItem("pdfjs.preferences"))}}class aE{constructor(){throw new Error("Cannot initialize DefaultExternalServices.")}static updateFindControlState(e){}static updateFindMatchesCount(e){}static initPassiveLoading(e){}static reportTelemetry(e){}static get supportsPinchToZoom(){return(0,j.shadow)(this,"supportsPinchToZoom",!0)}static get supportsIntegratedFind(){return(0,j.shadow)(this,"supportsIntegratedFind",!1)}static get supportsDocumentFonts(){return(0,j.shadow)(this,"supportsDocumentFonts",!0)}static get supportedMouseWheelZoomModifierKeys(){return(0,j.shadow)(this,"supportedMouseWheelZoomModifierKeys",{ctrlKey:!0,metaKey:!0})}static get isInAutomation(){return(0,j.shadow)(this,"isInAutomation",!1)}static updateEditorStates(e){throw new Error("Not implemented: updateEditorStates")}static createDownloadManager(){}static createPreferences(){return new nE}static createL10n({locale:e="en-US"}){}static createScripting({sandboxBundleSrc:e}){return new tE.GenericScripting(e)}}const iE=1e4,sE=1e3,vu={UNKNOWN:-1,PREVIOUS:0,INITIAL:1},Eu={AUTOMATIC:0,LIGHT:1,DARK:2};class Ii{constructor(e){this.pdfId=e,this.initialBookmark=document.location.hash.substring(1),this._initializedCapability=(0,j.createPromiseCapability)(),this.appConfig=null,this.pdfDocument=null,this.pdfLoadingTask=null,this.printService=null,this.pdfViewer=null,this.pdfThumbnailViewer=null,this.pdfRenderingQueue=null,this.pdfPresentationMode=null,this.pdfDocumentProperties=null,this.pdfLinkService=null,this.pdfHistory=null,this.pdfSidebar=null,this.pdfSidebarResizer=null,this.pdfOutlineViewer=null,this.pdfAttachmentViewer=null,this.pdfLayerViewer=null,this.pdfCursorTools=null,this.pdfScriptingManager=null,this.store=null,this.downloadManager=null,this.overlayManager=null,this.preferences=null,this.toolbar=null,this.secondaryToolbar=null,this.eventBus=null,this.l10n=null,this.annotationEditorParams=null,this.isInitialViewSet=!1,this.downloadComplete=!1,this.isViewerEmbedded=!0,this.url="",this.baseUrl="",this._downloadUrl="",this.externalServices=aE,this._boundEvents=Object.create(null),this.documentInfo=null,this.metadata=null,this._contentDispositionFilename=null,this._contentLength=null,this._saveInProgress=!1,this._wheelUnusedTicks=0,this._wheelUnusedFactor=1,this._touchUnusedTicks=0,this._touchUnusedFactor=1,this._PDFBug=null,this._hasAnnotationEditors=!1,this._title=document.title,this._printAnnotationStoragePromise=null,this._touchInfo=null,this._isCtrlKeyDown=!1}async initialize(e){this.preferences=this.externalServices.createPreferences(),this.appConfig=e,await this._initializeOptions(),this._forceCssTheme(),ge.set("ignoreDestinationZoom",!0),this.isViewerEmbedded&&ge.get("externalLinkTarget")===Aa.NONE&&ge.set("externalLinkTarget",Aa.TOP),await this._initializeViewerComponents(),this.bindEvents(),this.bindWindowEvents();const n=e.appContainer||document.documentElement;this.eventBus.dispatch("localized",{source:this}),this._initializedCapability.resolve()}async _initializeOptions(){if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")){if(ge.get("disablePreferences")){ge.get("pdfBugEnabled")&&await this._parseHashParams();return}ge._hasUserOptions()&&console.warn('_initializeOptions: The Preferences may override manually set AppOptions; please use the "disablePreferences"-option in order to prevent that.')}try{ge.setAll(await this.preferences.getAll())}catch(e){console.error(`_initializeOptions: "${e.message}".`)}ge.get("pdfBugEnabled")&&await this._parseHashParams()}async _parseHashParams(){const e=document.location.hash.substring(1);if(!e)return;const{mainContainer:n,viewerContainer:a}=this.appConfig,i=yr(e);if((typeof PDFJSDev>"u"||!PDFJSDev.test("PRODUCTION"))&&i.get("workermodules")==="true")ge.set("workerSrc","../src/pdf.worker.js");else if(i.get("disableworker")==="true")try{await oE()}catch(s){console.error(`_parseHashParams: "${s.message}".`)}if(i.has("disablerange")&&ge.set("disableRange",i.get("disablerange")==="true"),i.has("disablestream")&&ge.set("disableStream",i.get("disablestream")==="true"),i.has("disableautofetch")&&ge.set("disableAutoFetch",i.get("disableautofetch")==="true"),i.has("disablefontface")&&ge.set("disableFontFace",i.get("disablefontface")==="true"),i.has("disablehistory")&&ge.set("disableHistory",i.get("disablehistory")==="true"),i.has("verbosity")&&ge.set("verbosity",i.get("verbosity")|0),i.has("textlayer"))switch(i.get("textlayer")){case"off":ge.set("textLayerMode",wr.DISABLE);break;case"visible":case"shadow":case"hover":a.classList.add(`textLayer-${i.get("textlayer")}`);try{await Jh(this),this._PDFBug.loadCSS()}catch(s){console.error(`_parseHashParams: "${s.message}".`)}break}if(i.has("pdfbug")){ge.set("pdfBug",!0),ge.set("fontExtraProperties",!0);const s=i.get("pdfbug").split(",");try{await Jh(this),this._PDFBug.init({OPS:j.OPS},n,s)}catch(o){console.error(`_parseHashParams: "${o.message}".`)}}(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC"))&&i.has("locale")&&ge.set("locale",i.get("locale"))}async _initializeL10n(){this.l10n=this.externalServices.createL10n(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC")?{locale:ge.get("locale")}:null);const e=await this.l10n.getDirection();document.getElementsByTagName("html")[0].dir=e}_forceCssTheme(){const e=ge.get("viewerCssTheme");if(!(e===Eu.AUTOMATIC||!Object.values(Eu).includes(e)))try{const n=document.styleSheets[0],a=n?.cssRules||[];for(let i=0,s=a.length;i<s;i++){const o=a[i];if(o instanceof CSSMediaRule&&o.media?.[0]==="(prefers-color-scheme: dark)"){if(e===Eu.LIGHT){n.deleteRule(i);return}const l=/^@media \(prefers-color-scheme: dark\) {\n\s*([\w\s-.,:;/\\{}()]+)\n}$/.exec(o.cssText);l?.[1]&&(n.deleteRule(i),n.insertRule(l[1],i));return}}}catch(n){console.error(`_forceCssTheme: "${n?.message}".`)}}async _initializeViewerComponents(){const{appConfig:e,externalServices:n}=this,a=n.isInAutomation?new P_:new Sr;this.eventBus=a,this.overlayManager=new N_;const i=new Mh;i.onIdle=this._cleanup.bind(this),this.pdfRenderingQueue=i;const s=new Er({eventBus:a,externalLinkTarget:ge.get("externalLinkTarget"),externalLinkRel:ge.get("externalLinkRel"),ignoreDestinationZoom:ge.get("ignoreDestinationZoom")});this.pdfLinkService=s;const o=n.createDownloadManager();this.downloadManager=o;const l=new cv({linkService:s,eventBus:a,updateMatchesCountOnProgress:typeof PDFJSDev>"u"?!window.isGECKOVIEW:!PDFJSDev.test("GECKOVIEW")});this.findController=l;const r=new kv({eventBus:a,sandboxBundleSrc:typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC || CHROME")?ge.get("sandboxBundleSrc"):null,scriptingFactory:n,docPropertiesLookup:this._scriptingDocProperties.bind(this)});this.pdfScriptingManager=r;const c=e.mainContainer,d=e.viewerContainer,u=ge.get("annotationEditorMode"),f=ge.get("forcePageColors")||window.matchMedia("(forced-colors: active)").matches?{background:ge.get("pageColorsBackground"),foreground:ge.get("pageColorsForeground")}:null;if(this.pdfViewer=new Kv({container:c,viewer:d,eventBus:a,renderingQueue:i,linkService:s,downloadManager:o,findController:l,scriptingManager:ge.get("enableScripting")&&r,renderer:typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC")?ge.get("renderer"):null,l10n:this.l10n,textLayerMode:ge.get("textLayerMode"),annotationMode:ge.get("annotationMode"),annotationEditorMode:u,imageResourcesPath:ge.get("imageResourcesPath"),enablePrintAutoRotate:ge.get("enablePrintAutoRotate"),useOnlyCssZoom:ge.get("useOnlyCssZoom"),isOffscreenCanvasSupported:ge.get("isOffscreenCanvasSupported"),maxCanvasPixels:ge.get("maxCanvasPixels"),enablePermissions:ge.get("enablePermissions"),pageColors:f}),i.setViewer(this.pdfViewer),s.setViewer(this.pdfViewer),r.setViewer(this.pdfViewer),e.sidebar?.thumbnailView&&(this.pdfThumbnailViewer=new Iv({container:e.sidebar.thumbnailView,renderingQueue:i,linkService:s,l10n:this.l10n,pageColors:f}),i.setThumbnailViewer(this.pdfThumbnailViewer)),!this.isViewerEmbedded&&!ge.get("disableHistory")&&(this.pdfHistory=new pv({linkService:s,eventBus:a}),s.setHistory(this.pdfHistory)),!this.supportsIntegratedFind&&e.findBar&&(this.findBar=new uv(e.findBar,a,this.l10n)),e.annotationEditorParams)if(u!==j.AnnotationEditorType.DISABLE)this.annotationEditorParams=new M_(e.annotationEditorParams,a);else for(const g of["editorModeButtons","editorModeSeparator"])document.getElementById(g)?.classList.add("hidden");e.documentProperties&&(this.pdfDocumentProperties=new U_(e.documentProperties,this.overlayManager,a,this.l10n,()=>this._docFilename)),e.secondaryToolbar?.cursorHandToolButton&&(this.pdfCursorTools=new q_({container:c,eventBus:a,cursorToolOnLoad:ge.get("cursorToolOnLoad")})),e.toolbar&&(this.toolbar=new Xv(e.toolbar,a,this.l10n)),e.secondaryToolbar&&(this.secondaryToolbar=new Zv(e.secondaryToolbar,a,this.externalServices)),this.supportsFullscreen&&e.secondaryToolbar?.presentationModeButton&&(this.pdfPresentationMode=new vv({container:c,pdfViewer:this.pdfViewer,eventBus:a})),e.passwordOverlay&&(this.passwordPrompt=new H_(e.passwordOverlay,this.overlayManager,this.l10n,this.isViewerEmbedded)),e.sidebar?.outlineView&&(this.pdfOutlineViewer=new bv({container:e.sidebar.outlineView,eventBus:a,linkService:s,downloadManager:o})),e.sidebar?.attachmentsView&&(this.pdfAttachmentViewer=new R_({container:e.sidebar.attachmentsView,eventBus:a,downloadManager:o})),e.sidebar?.layersView&&(this.pdfLayerViewer=new mv({container:e.sidebar.layersView,eventBus:a,l10n:this.l10n})),e.sidebar&&(this.pdfSidebar=new Sv({elements:e.sidebar,pdfViewer:this.pdfViewer,pdfThumbnailViewer:this.pdfThumbnailViewer,eventBus:a,l10n:this.l10n}),this.pdfSidebar.onToggled=this.forceRendering.bind(this),this.pdfSidebarResizer=new Cv(e.sidebarResizer,a,this.l10n))}run(e){this.initialize(e).then(rE(this))}get initialized(){return this._initializedCapability.settled}get initializedPromise(){return this._initializedCapability.promise}zoomIn(e,n){this.pdfViewer.isInPresentationMode||this.pdfViewer.increaseScale({drawingDelay:ge.get("defaultZoomDelay"),steps:e,scaleFactor:n})}zoomOut(e,n){this.pdfViewer.isInPresentationMode||this.pdfViewer.decreaseScale({drawingDelay:ge.get("defaultZoomDelay"),steps:e,scaleFactor:n})}zoomReset(){this.pdfViewer.isInPresentationMode||(this.pdfViewer.currentScaleValue=$o)}get pagesCount(){return this.pdfDocument?this.pdfDocument.numPages:0}get page(){return this.pdfViewer.currentPageNumber}set page(e){this.pdfViewer.currentPageNumber=e}get supportsPrinting(){return Wm.instance.supportsPrinting}get supportsFullscreen(){return(0,j.shadow)(this,"supportsFullscreen",document.fullscreenEnabled)}get supportsPinchToZoom(){return this.externalServices.supportsPinchToZoom}get supportsIntegratedFind(){return this.externalServices.supportsIntegratedFind}get supportsDocumentFonts(){return this.externalServices.supportsDocumentFonts}get loadingBar(){const e=new T_(this.appConfig.appContainer.querySelector("#loadingBar"));return(0,j.shadow)(this,"loadingBar",e)}get supportedMouseWheelZoomModifierKeys(){return this.externalServices.supportedMouseWheelZoomModifierKeys}initPassiveLoading(){if(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL || CHROME"))throw new Error("Not implemented: initPassiveLoading");this.externalServices.initPassiveLoading({onOpenWithTransport:e=>{this.open({range:e})},onOpenWithData:(e,n)=>{(0,j.isPdfFile)(n)&&(this._contentDispositionFilename=n),this.open({data:e})},onOpenWithURL:(e,n,a)=>{this.open({url:e,length:n,originalUrl:a})},onError:e=>{this.l10n.get("loading_error").then(n=>{this._documentError(n,e)})},onProgress:(e,n)=>{this.progress(e/n)}})}setTitleUsingUrl(e="",n=null){this.url=e,this.baseUrl=e.split("#")[0],n&&(this._downloadUrl=n===e?this.baseUrl:n.split("#")[0]),(0,j.isDataScheme)(e)&&this._hideViewBookmark();let a=(0,j.getPdfFilenameFromUrl)(e,"");if(!a)try{a=decodeURIComponent((0,j.getFilenameFromUrl)(e))||e}catch{a=e}this.setTitle(a)}setTitle(e=this._title){if(this._title=e,this.isViewerEmbedded)return;const n=this._hasAnnotationEditors&&!this.pdfRenderingQueue.printing;document.title=`${n?"* ":""}${e}`}get _docFilename(){return this._contentDispositionFilename||(0,j.getPdfFilenameFromUrl)(this.url)}_hideViewBookmark(){const{secondaryToolbar:e}=this.appConfig;e?.viewBookmarkButton.classList.add("fn__hidden"),e?.presentationModeButton.classList.contains("fn__hidden")&&document.getElementById("viewBookmarkSeparator")?.classList.add("fn__hidden")}async close(){if(this._unblockDocumentLoadEvent(),this._hideViewBookmark(),!this.pdfLoadingTask)return;if((typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&this.pdfDocument?.annotationStorage.size>0&&this._annotationStorageModified)try{await this.save()}catch{}const e=[];e.push(this.pdfLoadingTask.destroy()),this.pdfLoadingTask=null,this.pdfDocument&&(this.pdfDocument=null,this.pdfThumbnailViewer?.setDocument(null),this.pdfViewer.setDocument(null),this.pdfLinkService.setDocument(null),this.pdfDocumentProperties?.setDocument(null)),this.pdfLinkService.externalLinkEnabled=!0,this.store=null,this.isInitialViewSet=!1,this.downloadComplete=!1,this.url="",this.baseUrl="",this._downloadUrl="",this.documentInfo=null,this.metadata=null,this._contentDispositionFilename=null,this._contentLength=null,this._saveInProgress=!1,this._hasAnnotationEditors=!1,e.push(this.pdfScriptingManager.destroyPromise),this.setTitle(),this.pdfSidebar?.reset(),this.pdfOutlineViewer?.reset(),this.pdfAttachmentViewer?.reset(),this.pdfLayerViewer?.reset(),this.pdfHistory?.reset(),this.findBar?.reset(),this.toolbar?.reset(),this.secondaryToolbar?.reset(),this._PDFBug?.cleanup(),await Promise.all(e)}async open(e){if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")){let o=!1;typeof e=="string"?(e={url:e},o=!0):e?.byteLength&&(e={data:e},o=!0),o&&console.error("The `PDFViewerApplication.open` signature was updated, please use an object instead.")}this.pdfLoadingTask&&await this.close();const n=ge.getAll(ne.WORKER);Object.assign(j.GlobalWorkerOptions,n),(typeof PDFJSDev>"u"||!PDFJSDev.test("MOZCENTRAL"))&&e.url&&this.setTitleUsingUrl(e.originalUrl||e.url,e.url);const a=ge.getAll(ne.API),i={canvasMaxAreaInBytes:this.externalServices.canvasMaxAreaInBytes,...a,...e};typeof PDFJSDev>"u"||!PDFJSDev.test("PRODUCTION")||PDFJSDev.test("MOZCENTRAL || CHROME")&&(i.docBaseUrl||=this.baseUrl);const s=(0,j.getDocument)(i);return this.pdfLoadingTask=s,s.onPassword=(o,l)=>{this.isViewerEmbedded&&this._unblockDocumentLoadEvent(),this.pdfLinkService.externalLinkEnabled=!1,this.passwordPrompt.setUpdateCallback(o,l),this.passwordPrompt.open()},s.onProgress=({loaded:o,total:l})=>{this.progress(o/l)},s.promise.then(o=>{this.load(o)},o=>{if(s!==this.pdfLoadingTask)return;let l="loadingError";throw o instanceof j.InvalidPDFException?l="invalidFileError":o instanceof j.MissingPDFException?l="missingFileError":o instanceof j.UnexpectedResponseException&&(l="unexpectedResponseError"),this._documentError(window.siyuan.languages[l],{message:o?.message}),o})}_ensureDownloadComplete(){if(!(this.pdfDocument&&this.downloadComplete))throw new Error("PDF document not downloaded.")}async download(){const e=this._downloadUrl,n=this._docFilename;try{this._ensureDownloadComplete();const a=await this.pdfDocument.getData(),i=new Blob([a],{type:"application/pdf"});await this.downloadManager.download(i,e,n)}catch{await this.downloadManager.downloadUrl(e,n)}}async save(){if(this._saveInProgress)return;this._saveInProgress=!0,await this.pdfScriptingManager.dispatchWillSave();const e=this._downloadUrl,n=this._docFilename;try{this._ensureDownloadComplete();const a=await this.pdfDocument.saveDocument(),i=new Blob([a],{type:"application/pdf"});await this.downloadManager.download(i,e,n)}catch(a){console.error(`Error when saving the document: ${a.message}`),await this.download()}finally{await this.pdfScriptingManager.dispatchDidSave(),this._saveInProgress=!1}this._hasAnnotationEditors&&this.externalServices.reportTelemetry({type:"editing",data:{type:"save"}})}downloadOrSave(){this.pdfDocument?.annotationStorage.size>0?this.save():this.download()}_documentError(e,n=null){this._unblockDocumentLoadEvent(),this._otherError(e,n),this.eventBus.dispatch("documenterror",{source:this,message:e,reason:n?.message??null})}_otherError(e,n=null){const a=[`PDF.js v${j.version||"?"} (build: ${j.build||"?"})`];n&&(a.push(`Message: ${n.message}`),n.stack?a.push(`Stack: ${n.stack}`):(n.filename&&a.push(`File: ${n.filename}`),n.lineNumber&&a.push(`Line: ${n.lineNumber}`))),console.error(`${e}

${a.join(`
`)}`)}progress(e){if(!this.loadingBar||this.downloadComplete)return;const n=Math.round(e*100);n<=this.loadingBar.percent||(this.loadingBar.percent=n,(this.pdfDocument?.loadingParams.disableAutoFetch??ge.get("disableAutoFetch"))&&this.loadingBar.setDisableAutoFetch())}load(e){this.pdfDocument=e,e.getDownloadInfo().then(({length:d})=>{this._contentLength=d,this.downloadComplete=!0,this.loadingBar?.hide(),o.then(()=>{this.eventBus.dispatch("documentloaded",{source:this})})});const n=e.getPageLayout().catch(function(){}),a=e.getPageMode().catch(function(){}),i=e.getOpenAction().catch(function(){});if(this.toolbar?.setPagesCount(e.numPages,!1),this.secondaryToolbar?.setPagesCount(e.numPages),typeof PDFJSDev<"u"&&PDFJSDev.test("CHROME")){const d=location.href.split("#")[0];this.pdfLinkService.setDocument(e,(0,j.isDataScheme)(d)?null:d)}else this.pdfLinkService.setDocument(e);this.pdfDocumentProperties?.setDocument(e);const s=this.pdfViewer;s.setDocument(e);const{firstPagePromise:o,onePageRendered:l,pagesPromise:r}=s;this.pdfThumbnailViewer?.setDocument(e);const c=(this.store=new eE(e.fingerprints[0])).getMultiple({page:null,zoom:$o,scrollLeft:"0",scrollTop:"0",rotation:null,sidebarView:Ie.UNKNOWN,scrollMode:Ce.UNKNOWN,spreadMode:pt.UNKNOWN}).catch(()=>Object.create(null));o.then(d=>{this.loadingBar?.setWidth(this.appConfig.viewerContainer),this._initializeAnnotationStorageCallbacks(e),Promise.all([hh,c,n,a,i]).then(async([u,f,g,h,m])=>{const b=ge.get("viewOnLoad");this._initializePdfHistory({fingerprint:e.fingerprints[0],viewOnLoad:b,initialDest:m?.dest});const y=this.initialBookmark,_=ge.get("defaultZoomValue");let v=_?`zoom=${_}`:null,k=null,L=ge.get("sidebarViewOnLoad"),C=ge.get("scrollModeOnLoad"),E=ge.get("spreadModeOnLoad");f.page=this.pdfId||f.page,f.page&&b!==vu.INITIAL&&(v=`page=${f.page}&zoom=${_||f.zoom},${f.scrollLeft},${f.scrollTop}`,k=parseInt(f.rotation,10),L===Ie.UNKNOWN&&(L=f.sidebarView|0),C===Ce.UNKNOWN&&(C=f.scrollMode|0),E===pt.UNKNOWN&&(E=f.spreadMode|0)),v.indexOf("page=")===-1&&this.pdfId&&(v+=`&page=${this.pdfId}`),(typeof PDFJSDev>"u"?!window.isGECKOVIEW:!PDFJSDev.test("GECKOVIEW"))&&(h&&L===Ie.UNKNOWN&&(L=D_(h)),g&&C===Ce.UNKNOWN&&E===pt.UNKNOWN&&(E=mh(g).spreadMode)),this.setInitialView(v,{rotation:k,sidebarView:L,scrollMode:C,spreadMode:E}),this.eventBus.dispatch("documentinit",{source:this}),this.isViewerEmbedded||s.focus(),await Promise.race([r,new Promise(T=>{setTimeout(T,iE)})]),!(!y&&!v)&&(s.hasEqualPageSizes||(this.initialBookmark=y,s.currentScaleValue=s.currentScaleValue,this.setInitialView(v)))}).catch(()=>{this.setInitialView()}).then(function(){s.update();const u=A(s.container,"fn__flex-1");u&&u.removeAttribute("data-loading")})}),r.then(()=>{this._unblockDocumentLoadEvent(),this._initializeAutoPrint(e,i)},d=>{this.l10n.get("loading_error").then(u=>{this._documentError(u,{message:d?.message})})}),l.then(d=>{this.externalServices.reportTelemetry({type:"pageInfo",timestamp:d.timestamp}),this.pdfOutlineViewer&&e.getOutline().then(u=>{e===this.pdfDocument&&this.pdfOutlineViewer.render({outline:u,pdfDocument:e})}),this.pdfAttachmentViewer&&e.getAttachments().then(u=>{e===this.pdfDocument&&this.pdfAttachmentViewer.render({attachments:u})}),this.pdfLayerViewer&&s.optionalContentConfigPromise.then(u=>{e===this.pdfDocument&&this.pdfLayerViewer.render({optionalContentConfig:u,pdfDocument:e})})}),this._initializePageLabels(e),this._initializeMetadata(e)}async _scriptingDocProperties(e){return!this.documentInfo&&(await new Promise(n=>{this.eventBus._on("metadataloaded",n,{once:!0})}),e!==this.pdfDocument)||!this._contentLength&&(await new Promise(n=>{this.eventBus._on("documentloaded",n,{once:!0})}),e!==this.pdfDocument)?null:{...this.documentInfo,baseURL:this.baseUrl,filesize:this._contentLength,filename:this._docFilename,metadata:this.metadata?.getRaw(),authors:this.metadata?.get("dc:creator"),numPages:this.pagesCount,URL:this.url}}async _initializeAutoPrint(e,n){const[a,i]=await Promise.all([n,this.pdfViewer.enableScripting?null:e.getJavaScript()]);if(e!==this.pdfDocument)return;let s=!1;if(a?.action==="Print"&&(s=!0),i&&(i.some(o=>o?(console.warn("Warning: JavaScript support is not enabled"),!0):!1),!s)){for(const o of i)if(o&&E_.test(o)){s=!0;break}}s&&this.triggerPrinting()}async _initializeMetadata(e){const{info:n,metadata:a,contentDispositionFilename:i,contentLength:s}=await e.getMetadata();if(e!==this.pdfDocument)return;this.documentInfo=n,this.metadata=a,this._contentDispositionFilename??=i,this._contentLength??=s;let o=n.Title;const l=a?.get("dc:title");l&&l!=="Untitled"&&!/[\uFFF0-\uFFFF]/g.test(l)&&(o=l),o?this.setTitle(`${o} - ${this._contentDispositionFilename||this._title}`):this._contentDispositionFilename&&this.setTitle(this._contentDispositionFilename),n.IsXFAPresent&&!n.IsAcroFormPresent&&!e.isPureXfa?e.loadingParams.enableXfa?console.warn("Warning: XFA Foreground documents are not supported"):console.warn("Warning: XFA support is not enabled"):(n.IsAcroFormPresent||n.IsXFAPresent)&&!this.pdfViewer.renderForms&&console.warn("Warning: Interactive form support is not enabled"),n.IsSignaturesPresent&&console.warn("Warning: Digital signatures validation is not supported"),this.eventBus.dispatch("metadataloaded",{source:this})}async _initializePageLabels(e){if(typeof PDFJSDev>"u"?window.isGECKOVIEW:PDFJSDev.test("GECKOVIEW"))return;const n=await e.getPageLabels();if(e!==this.pdfDocument||!n||ge.get("disablePageLabels"))return;const a=n.length;let i=0,s=0;for(let c=0;c<a;c++){const d=n[c];if(d===(c+1).toString())i++;else if(d==="")s++;else break}if(i>=a||s>=a)return;const{pdfViewer:o,pdfThumbnailViewer:l,toolbar:r}=this;o.setPageLabels(n),l?.setPageLabels(n),r?.setPagesCount(a,!0),r?.setPageNumber(o.currentPageNumber,o.currentPageLabel)}_initializePdfHistory({fingerprint:e,viewOnLoad:n,initialDest:a=null}){this.pdfHistory&&(this.pdfHistory.initialize({fingerprint:e,resetHistory:n===vu.INITIAL,updateUrl:ge.get("historyUpdateUrl")}),this.pdfHistory.initialBookmark&&(this.initialBookmark=this.pdfHistory.initialBookmark,this.initialRotation=this.pdfHistory.initialRotation),a&&!this.initialBookmark&&n===vu.UNKNOWN&&(this.initialBookmark=JSON.stringify(a),this.pdfHistory.push({explicitDest:a,pageNumber:null})))}_initializeAnnotationStorageCallbacks(e){if(e!==this.pdfDocument)return;const{annotationStorage:n}=e;n.onSetModified=()=>{(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(this._annotationStorageModified=!0)},n.onResetModified=()=>{(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&delete this._annotationStorageModified},n.onAnnotationEditor=a=>{this._hasAnnotationEditors=!!a,this.setTitle(),a&&this.externalServices.reportTelemetry({type:"editing",data:{type:a}})}}setInitialView(e,{rotation:n,sidebarView:a,scrollMode:i,spreadMode:s}={}){const o=r=>{vr(r)&&(this.pdfViewer.pagesRotation=r)},l=(r,c)=>{ph(r)&&(this.pdfViewer.scrollMode=r),gh(c)&&(this.pdfViewer.spreadMode=c)};this.isInitialViewSet=!0,this.pdfSidebar?.setInitialView(a),l(i,s),this.initialBookmark?(o(this.initialRotation),delete this.initialRotation,this.pdfLinkService.setHash(this.initialBookmark),this.initialBookmark=null):e&&(o(n),this.pdfLinkService.setHash(e)),this.toolbar?.setPageNumber(this.pdfViewer.currentPageNumber,this.pdfViewer.currentPageLabel),this.secondaryToolbar?.setPageNumber(this.pdfViewer.currentPageNumber),this.pdfViewer.currentScaleValue||(this.pdfViewer.currentScaleValue=$o)}_cleanup(){this.pdfDocument&&(this.pdfViewer.cleanup(),this.pdfThumbnailViewer?.cleanup(),!this.pdfLoadingTask.destroyed&&(typeof PDFJSDev>"u"||PDFJSDev.test("!PRODUCTION || GENERIC")?this.pdfDocument.cleanup(this.pdfViewer.renderer===br.SVG):this.pdfDocument.cleanup()))}forceRendering(){this.pdfRenderingQueue.printing=!!this.printService,this.pdfRenderingQueue.isThumbnailViewEnabled=this.pdfSidebar?.visibleView===Ie.THUMBS,this.pdfRenderingQueue.renderHighestPriority()}beforePrint(){if(this._printAnnotationStoragePromise=this.pdfScriptingManager.dispatchWillPrint().catch(()=>{}).then(()=>this.pdfDocument?.annotationStorage.print),this.printService)return;if(!this.supportsPrinting){this._otherError(window.siyuan.languages.printingNotSupported);return}if(!this.pdfViewer.pageViewsReady){window.alert(window.siyuan.languages.printingNotReady);return}const e=this.pdfViewer.getPagesOverview(),n=this.appConfig.printContainer,a=ge.get("printResolution"),i=this.pdfViewer.optionalContentConfigPromise,s=Wm.instance.createPrintService(this.pdfDocument,e,n,a,i,this._printAnnotationStoragePromise,this.l10n);this.printService=s,this.forceRendering(),this.setTitle(),s.layout(),this._hasAnnotationEditors&&this.externalServices.reportTelemetry({type:"editing",data:{type:"print"}})}afterPrint(){this._printAnnotationStoragePromise&&(this._printAnnotationStoragePromise.then(()=>{this.pdfScriptingManager.dispatchDidPrint()}),this._printAnnotationStoragePromise=null),this.printService&&(this.printService.destroy(),this.printService=null,this.pdfDocument?.annotationStorage.resetModified()),this.forceRendering(),this.setTitle()}rotatePages(e){this.pdfViewer.pagesRotation+=e}requestPresentationMode(){this.pdfPresentationMode?.request()}triggerPrinting(){this.supportsPrinting&&window.print()}bindEvents(){const{eventBus:e,_boundEvents:n}=this;n.beforePrint=this.beforePrint.bind(this),n.afterPrint=this.afterPrint.bind(this),e._on("resize",lm),e._on("hashchange",rm),e._on("beforeprint",n.beforePrint),e._on("afterprint",n.afterPrint),e._on("pagerender",Xh),e._on("pagerendered",Qh),e._on("updateviewarea",im),e._on("pagechanging",Pm),e._on("scalechanging",Dm),e._on("rotationchanging",$m),e._on("sidebarviewchanged",am),e._on("pagemode",em),e._on("namedaction",tm),e._on("presentationmodechanged",nm),e._on("presentationmode",um),e._on("switchannotationeditormode",cE),e._on("switchannotationeditorparams",dE),e._on("print",fm),e._on("download",pm),e._on("firstpage",gm),e._on("lastpage",hm),e._on("nextpage",mm),e._on("previouspage",bm),e._on("zoomin",wm),e._on("zoomout",ym),e._on("zoomreset",_m),e._on("pagenumberchanged",Dr),e._on("scalechanged",vm),e._on("rotatecw",Em),e._on("rotateccw",km),e._on("optionalcontentconfig",Sm),e._on("switchscrollmode",Lm),e._on("scrollmodechanged",sm),e._on("switchspreadmode",Cm),e._on("spreadmodechanged",om),e._on("documentproperties",xm),e._on("findfromurlhash",Am),e._on("updatefindmatchescount",Tm),e._on("updatefindcontrolstate",Im),ge.get("pdfBug")&&(n.reportPageStatsPDFBug=lE,e._on("pagerendered",n.reportPageStatsPDFBug),e._on("pagechanging",n.reportPageStatsPDFBug)),(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(e._on("fileinputchange",cm),e._on("openfile",dm)),typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")&&e._on("annotationeditorstateschanged",fE)}bindWindowEvents(){const{eventBus:e,_boundEvents:n}=this;function a(i=null){i&&uE(i);const s=window.matchMedia(`(resolution: ${window.devicePixelRatio||1}dppx)`);s.addEventListener("change",a,{once:!0}),!(typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL"))&&(n.removeWindowResolutionChange||=function(){s.removeEventListener("change",a),n.removeWindowResolutionChange=null})}a(),n.windowResize=()=>{e.dispatch("resize",{source:window})},n.windowHashChange=()=>{e.dispatch("hashchange",{source:window,hash:document.location.hash.substring(1)})},n.windowBeforePrint=()=>{e.dispatch("beforeprint",{source:window})},n.windowAfterPrint=()=>{e.dispatch("afterprint",{source:window})},n.windowUpdateFromSandbox=i=>{e.dispatch("updatefromsandbox",{source:window,detail:i.detail})},window.addEventListener("visibilitychange",Mm),window.addEventListener("wheel",Hm,{passive:!1}),window.addEventListener("touchstart",Om,{passive:!1}),window.addEventListener("touchmove",Rm,{passive:!1}),window.addEventListener("touchend",Bm,{passive:!1}),window.addEventListener("click",qm),window.addEventListener("keydown",Um),window.addEventListener("keyup",Fm),window.addEventListener("resize",n.windowResize),window.addEventListener("hashchange",n.windowHashChange),window.addEventListener("beforeprint",n.windowBeforePrint),window.addEventListener("afterprint",n.windowAfterPrint),window.addEventListener("updatefromsandbox",n.windowUpdateFromSandbox)}unbindEvents(){if(typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: unbindEvents");const{eventBus:e,_boundEvents:n}=this;e._off("resize",lm),e._off("hashchange",rm),e._off("beforeprint",n.beforePrint),e._off("afterprint",n.afterPrint),e._off("pagerender",Xh),e._off("pagerendered",Qh),e._off("updateviewarea",im),e._off("pagechanging",Pm),e._off("scalechanging",Dm),e._off("rotationchanging",$m),e._off("sidebarviewchanged",am),e._off("pagemode",em),e._off("namedaction",tm),e._off("presentationmodechanged",nm),e._off("presentationmode",um),e._off("print",fm),e._off("download",pm),e._off("firstpage",gm),e._off("lastpage",hm),e._off("nextpage",mm),e._off("previouspage",bm),e._off("zoomin",wm),e._off("zoomout",ym),e._off("zoomreset",_m),e._off("pagenumberchanged",Dr),e._off("scalechanged",vm),e._off("rotatecw",Em),e._off("rotateccw",km),e._off("optionalcontentconfig",Sm),e._off("switchscrollmode",Lm),e._off("scrollmodechanged",sm),e._off("switchspreadmode",Cm),e._off("spreadmodechanged",om),e._off("documentproperties",xm),e._off("findfromurlhash",Am),e._off("updatefindmatchescount",Tm),e._off("updatefindcontrolstate",Im),n.reportPageStatsPDFBug&&(e._off("pagerendered",n.reportPageStatsPDFBug),e._off("pagechanging",n.reportPageStatsPDFBug),n.reportPageStatsPDFBug=null),(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))&&(e._off("fileinputchange",cm),e._off("openfile",dm)),n.beforePrint=null,n.afterPrint=null}unbindWindowEvents(){if(typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL"))throw new Error("Not implemented: unbindWindowEvents");const{_boundEvents:e}=this;window.removeEventListener("visibilitychange",Mm),window.removeEventListener("wheel",Hm,{passive:!1}),window.removeEventListener("touchstart",Om,{passive:!1}),window.removeEventListener("touchmove",Rm,{passive:!1}),window.removeEventListener("touchend",Bm,{passive:!1}),window.removeEventListener("click",qm),window.removeEventListener("keydown",Um),window.removeEventListener("keyup",Fm),window.removeEventListener("resize",e.windowResize),window.removeEventListener("hashchange",e.windowHashChange),window.removeEventListener("beforeprint",e.windowBeforePrint),window.removeEventListener("afterprint",e.windowAfterPrint),window.removeEventListener("updatefromsandbox",e.windowUpdateFromSandbox),e.removeWindowResolutionChange?.(),e.windowResize=null,e.windowHashChange=null,e.windowBeforePrint=null,e.windowAfterPrint=null,e.windowUpdateFromSandbox=null}_accumulateTicks(e,n){(this[n]>0&&e<0||this[n]<0&&e>0)&&(this[n]=0),this[n]+=e;const a=Math.trunc(this[n]);return this[n]-=a,a}_accumulateFactor(e,n,a){if(n===1)return 1;(this[a]>1&&n<1||this[a]<1&&n>1)&&(this[a]=1);const i=Math.floor(e*n*this[a]*100)/(100*e);return this[a]=n/i,i}_centerAtPos(e,n,a){const{pdfViewer:i}=this,s=i.currentScale/e-1;if(s!==0){const[o,l]=i.containerTopLeft;i.container.scrollLeft+=(n-l)*s,i.container.scrollTop+=(a-o)*s}}_unblockDocumentLoadEvent(){document.blockUnblockOnload?.(!1),this._unblockDocumentLoadEvent=()=>{}}get scriptingReady(){return this.pdfScriptingManager.ready}}if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))var Fk=function(e){if(e)try{const n=new URL(window.location.href).origin||"null";if(null.includes(n))return;if(new URL(e,window.location.href).origin!==n)throw new Error("file origin does not match viewer's")}catch(n){throw console.log(window.siyuan.languages.loadingError,n.message),n}};async function oE(){if(j.GlobalWorkerOptions.workerSrc||=ge.get("workerSrc"),typeof PDFJSDev>"u"||!PDFJSDev.test("PRODUCTION")){window.pdfjsWorker=await Ye(917)(`${Constants.PROTYLE_CDN}/js/pdf/pdf.worker.js`);return}await(0,j.loadScript)(j.PDFWorker.workerSrc)}async function Jh(t){}function lE({pageNumber:t}){}function rE(t){const{appConfig:e,eventBus:n}=t,a=e.file;t.supportsDocumentFonts||(ge.set("disableFontFace",!0),console.warn("Web fonts are disabled: unable to use embedded PDF fonts.")),t.supportsPrinting||(e.toolbar?.print.classList.add("fn__hidden"),e.secondaryToolbar?.printButton.classList.add("fn__hidden")),t.supportsFullscreen||e.secondaryToolbar?.presentationModeButton.classList.add("fn__hidden"),t.supportsIntegratedFind&&e.toolbar?.viewFind.classList.add("fn__hidden"),e.mainContainer.addEventListener("transitionend",function(i){i.target===this&&t.eventBus.dispatch("resize",{source:this})},!0);try{if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))a?t.open({url:a}):t._hideViewBookmark();else if(PDFJSDev.test("MOZCENTRAL || CHROME"))t.setTitleUsingUrl(a,a),t.initPassiveLoading();else throw new Error("Not implemented: webViewerInitialized")}catch(i){t._documentError(window.siyuan.languages.loadingError,i)}}function Xh({pageNumber:t,source:e}){const n=Ae(e.div);n&&t===n.page&&n.toolbar?.updateLoadingIndicatorState(!0)}function Qh({pageNumber:t,error:e,source:n}){const a=Ae(n.div);if(a){if(t===a.page&&a.toolbar?.updateLoadingIndicatorState(!1),a.pdfSidebar?.visibleView===Ie.THUMBS){const i=a.pdfViewer.getPageView(t-1),s=a.pdfThumbnailViewer?.getThumbnail(t-1);i&&s&&s.setImage(i)}e&&a._otherError("An error occurred while rendering the page.",e)}}function em({mode:t,source:e}){const n=Ae(e.externalLinkTarget);if(!n)return;let a;switch(t){case"thumbs":a=Ie.THUMBS;break;case"bookmarks":case"outline":a=Ie.OUTLINE;break;case"attachments":a=Ie.ATTACHMENTS;break;case"layers":a=Ie.LAYERS;break;case"none":a=Ie.NONE;break;default:console.error('Invalid "pagemode" hash parameter: '+t);return}n.pdfSidebar?.switchView(a,!0)}function tm(t){const e=Ae(t.source.externalLinkTarget);if(e)switch(t.action){case"GoToPage":e.appConfig.toolbar?.pageNumber.select();break;case"Find":e.supportsIntegratedFind||e?.findBar.toggle();break;case"Print":e.triggerPrinting();break;case"SaveAs":e.downloadOrSave();break}}function nm(t){const e=Ae(t.source.toolbar);e&&(e.pdfViewer.presentationModeState=t.state)}function am({view:t,source:e}){const n=Ae(e.outerContainer);n&&(n.pdfRenderingQueue.isThumbnailViewEnabled=t===Ie.THUMBS,n.isInitialViewSet&&n.store?.set("sidebarView",t).catch(()=>{}))}function im({location:t,source:e}){const n=Ae(e.container);if(n&&(n.isInitialViewSet&&n.store?.setMultiple({page:t.pageNumber,zoom:t.scale,scrollLeft:t.left,scrollTop:t.top,rotation:t.rotation}).catch(()=>{}),n.appConfig.secondaryToolbar)){const a=n.pdfLinkService.getAnchorUrl(t.pdfOpenParams);n.appConfig.secondaryToolbar.viewBookmarkButton.href=a}}function sm(t){const e=Ae(t.source.container);e&&e.isInitialViewSet&&!e.pdfViewer.isInPresentationMode&&e.store?.set("scrollMode",t.mode).catch(()=>{})}function om(t){const e=Ae(t.source.container);e&&e.isInitialViewSet&&!e.pdfViewer.isInPresentationMode&&e.store?.set("spreadMode",t.mode).catch(()=>{})}function lm(){}function rm(t){}if(typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC"))var cm=function(t){if(Ii.pdfViewer?.isInPresentationMode)return;const e=t.fileInput.files[0];Ii.open({url:URL.createObjectURL(e),originalUrl:e.name})},dm=function(t){Ii.appConfig.openFileInput.click()};function um({source:t}){const e=Ae(t.toolbar);e&&e.requestPresentationMode()}function cE(t){const e=Ae(t.source.toolbar);e&&(e.pdfViewer.annotationEditorMode=t.mode)}function dE(t){const e=Ae(t.source.toolbar);e&&(e.pdfViewer.annotationEditorParams=t)}function fm(t){const e=Ae(t.source.toolbar);e&&e.triggerPrinting()}function pm(t){const e=Ae(t.source.toolbar);e&&e.downloadOrSave()}function gm(t){const e=Ae(t.source.toolbar);e&&(e.page=1)}function hm(t){const e=Ae(t.source.toolbar);e&&(e.page=e.pagesCount)}function mm(t){const e=Ae(t.source.toolbar);e&&e.pdfViewer.nextPage()}function bm(t){const e=Ae(t.source.toolbar);e&&e.pdfViewer.previousPage()}function wm(t){const e=Ae(t.source.toolbar);e&&e.zoomIn()}function ym(t){const e=Ae(t.source.toolbar);e&&e.zoomOut()}function _m(t){const e=Ae(t.source.toolbar);e&&e.zoomReset()}function Dr(t){let e;if(t.pdfInstance?e=t.pdfInstance:e=Ae(t.source.toolbar),!e||typeof t.value>"u")return;const n=e.pdfViewer;t.value!==""&&e.pdfLinkService.goToPage(t.value),t.id&&Yh(e.pdfViewer.container,t.id),t.value!==n.currentPageNumber.toString()&&t.value!==n.currentPageLabel&&e.toolbar?.setPageNumber(n.currentPageNumber,n.currentPageLabel)}function vm(t){const e=Ae(t.source.toolbar);e&&(e.pdfViewer.currentScaleValue=t.value)}function Em(t){const e=Ae(t.source.toolbar);e&&e.rotatePages(90)}function km(t){const e=Ae(t.source.toolbar);e&&e.rotatePages(-90)}function Sm(t){const e=Ae(t.source.toolbar);e&&(e.pdfViewer.optionalContentConfigPromise=t.promise)}function Lm(t){const e=Ae(t.source.toolbar);e&&(e.pdfViewer.scrollMode=t.mode)}function Cm(t){const e=Ae(t.source.toolbar);e&&(e.pdfViewer.spreadMode=t.mode)}function xm(t){const e=Ae(t.source.toolbar);e&&e.pdfDocumentProperties?.open()}function Am(t){const e=Ae(t.source.toolbar);e&&e.eventBus.dispatch("find",{source:t.source,type:"",query:t.query,phraseSearch:t.phraseSearch,caseSensitive:!1,entireWord:!1,highlightAll:!0,findPrevious:!1,matchDiacritics:!0})}function Tm({matchesCount:t,source:e}){const n=Ae(e._linkService.pdfViewer.container);n&&(n.supportsIntegratedFind?n.externalServices.updateFindMatchesCount(t):n.findBar.updateResultsCount(t))}function Im({state:t,previous:e,matchesCount:n,rawQuery:a,source:i}){const s=Ae(i._linkService.pdfViewer.container);s&&(s.supportsIntegratedFind?s.externalServices.updateFindControlState({result:t,findPrevious:e,matchesCount:n,rawQuery:a}):s.findBar?.updateUIState(t,e,n))}function Dm(t){const e=Ae(t.source.container);e&&(e.toolbar?.setPageScale(t.presetValue,t.scale),e.pdfViewer.update())}function $m(t){const e=Ae(t.source.container);e&&(e.pdfThumbnailViewer&&(e.pdfThumbnailViewer.pagesRotation=t.pagesRotation),e.forceRendering(),e.pdfViewer.currentPageNumber=t.pageNumber)}function Pm({pageNumber:t,pageLabel:e,source:n}){const a=Ae(n.container);if(!a)return;a.toolbar?.setPageNumber(t,e),a.secondaryToolbar?.setPageNumber(t),a.pdfSidebar?.visibleView===Ie.THUMBS&&a.pdfThumbnailViewer?.scrollThumbnailIntoView(t);const i=a.pdfViewer.getPageView(t-1);a.toolbar?.updateLoadingIndicatorState(i?.renderingState===Re.RUNNING)}function uE(t){const e=Ae(t.source.container);e&&e.pdfViewer.refresh()}function Mm(t){document.visibilityState==="visible"&&Nm()}let Ho=null;function Nm(){Ho&&clearTimeout(Ho),Ho=setTimeout(function(){Ho=null},sE)}function Hm(t){const e=Ae(t.target);if(!e)return;const{pdfViewer:n,supportedMouseWheelZoomModifierKeys:a,supportsPinchToZoom:i}=e;if(n.isInPresentationMode)return;const s=t.deltaMode;let o=Math.exp(-t.deltaY/100);const l=typeof PDFJSDev<"u"&&PDFJSDev.test("MOZCENTRAL")&&j.FeatureTest.platform.isMac,r=t.ctrlKey&&!e._isCtrlKeyDown&&s===WheelEvent.DOM_DELTA_PIXEL&&t.deltaX===0&&(Math.abs(o-1)<.05||l)&&t.deltaZ===0;if(r||t.ctrlKey&&a.ctrlKey||t.metaKey&&a.metaKey){if(t.preventDefault(),Ho||document.visibilityState==="hidden")return;const c=n.currentScale;if(r&&i)if(o=e._accumulateFactor(c,o,"_wheelUnusedFactor"),o<1)e.zoomOut(null,o);else if(o>1)e.zoomIn(null,o);else return;else{const d=fh(t);let u=0;if(s===WheelEvent.DOM_DELTA_LINE||s===WheelEvent.DOM_DELTA_PAGE?Math.abs(d)>=1?u=Math.sign(d):u=e._accumulateTicks(d,"_wheelUnusedTicks"):u=e._accumulateTicks(d/30,"_wheelUnusedTicks"),u<0)e.zoomOut(-u);else if(u>0)e.zoomIn(u);else return}e._centerAtPos(c,t.clientX,t.clientY)}else Nm()}function Om(t){const e=Ae(t.target);if(!e||e.pdfViewer.isInPresentationMode||t.touches.length<2)return;if(t.preventDefault(),t.touches.length!==2){e._touchInfo=null;return}let[n,a]=t.touches;n.identifier>a.identifier&&([n,a]=[a,n]),e._touchInfo={touch0X:n.pageX,touch0Y:n.pageY,touch1X:a.pageX,touch1Y:a.pageY}}function Rm(t){const e=Ae(t.target);if(!e||!e._touchInfo||t.touches.length!==2)return;const{pdfViewer:n,_touchInfo:a,supportsPinchToZoom:i}=e;let[s,o]=t.touches;s.identifier>o.identifier&&([s,o]=[o,s]);const{pageX:l,pageY:r}=s,{pageX:c,pageY:d}=o,{touch0X:u,touch0Y:f,touch1X:g,touch1Y:h}=a;if(Math.abs(u-l)<=1&&Math.abs(f-r)<=1&&Math.abs(g-c)<=1&&Math.abs(h-d)<=1)return;if(a.touch0X=l,a.touch0Y=r,a.touch1X=c,a.touch1Y=d,u===l&&f===r){const _=g-l,v=h-r,k=c-l,L=d-r,C=_*L-v*k;if(Math.abs(C)>.02*Math.hypot(_,v)*Math.hypot(k,L))return}else if(g===c&&h===d){const _=u-c,v=f-d,k=l-c,L=r-d,C=_*L-v*k;if(Math.abs(C)>.02*Math.hypot(_,v)*Math.hypot(k,L))return}else{const _=l-u,v=c-g,k=r-f,L=d-h;if(_*v+k*L>=0)return}t.preventDefault();const m=Math.hypot(l-c,r-d)||1,b=Math.hypot(u-g,f-h)||1,y=n.currentScale;if(i){const _=e._accumulateFactor(y,m/b,"_touchUnusedFactor");if(_<1)e.zoomOut(null,_);else if(_>1)e.zoomIn(null,_);else return}else{const v=e._accumulateTicks((m-b)/30,"_touchUnusedTicks");if(v<0)e.zoomOut(-v);else if(v>0)e.zoomIn(v);else return}Ii._centerAtPos(y,(l+c)/2,(r+d)/2)}function Bm(t){const e=Ae(t.target);e&&e._touchInfo&&(t.preventDefault(),e._touchInfo=null,e._touchUnusedTicks=0,e._touchUnusedFactor=1)}function qm(t){const e=Ae(t.target);if(!e||(["SELECT","TEXTAREA","INPUT"].includes(t.target.tagName)||e.pdfViewer.focus(),!e.secondaryToolbar?.isOpen))return;const n=e.appConfig;(e.pdfViewer.containsElement(t.target)||n.toolbar?.container.contains(t.target)&&!n.secondaryToolbar.toggleButton.contains(t.target))&&e.secondaryToolbar.close()}function Fm(t){const e=Ae(t.target);e&&(t.key==="Control"&&(e._isCtrlKeyDown=!1),t.keyCode===68&&e.appConfig.toolbar.rectAnno.classList.contains("toggled")&&e.appConfig.toolbar.rectAnno.dispatchEvent(new MouseEvent("click")))}function Um(t){const e=Ae(t.target);if(!e||(e._isCtrlKeyDown=t.key==="Control",e.overlayManager.active))return;const{eventBus:n,pdfViewer:a}=e,i=a.isInPresentationMode;let s=!1,o=!1;const l=(t.ctrlKey?1:0)|(t.altKey?2:0)|(t.shiftKey?4:0)|(t.metaKey?8:0);if(l===0&&[38,40].includes(t.keyCode)){document.activeElement&&document.activeElement.blur(),setTimeout(()=>{a.focus()});return}if(!t.repeat&&(l===8||l===1||l===2)&&t.keyCode===68&&!e.appConfig.toolbar.rectAnno.classList.contains("toggled")){e.appConfig.toolbar.rectAnno.dispatchEvent(new MouseEvent("click")),t.preventDefault();return}if(!t.repeat&&l!==1&&l!==2&&l!==4&&l!==8&&[48,49,50,51,52,53,54,55].includes(t.keyCode)&&getSelection().rangeCount>0&&!e.appConfig.toolbar.rectAnno.classList.contains("toggled")){const d=getSelection().getRangeAt(0);if(d.toString()!==""&&A(d.commonAncestorContainer,"pdfViewer")){e.appConfig.appContainer.dispatchEvent(new CustomEvent("click",{detail:(t.keyCode-48).toString()})),t.preventDefault();return}}if(l===1||l===8||l===5||l===12)switch(t.keyCode){case 70:!e.supportsIntegratedFind&&!t.shiftKey&&(e.findBar?.open(),s=!0);break;case 71:if(!e.supportsIntegratedFind){const{state:d}=e.findController;if(d){const u={source:window,type:"again",findPrevious:l===5||l===12};n.dispatch("find",{...d,...u})}s=!0}break;case 61:case 107:case 187:case 171:e.zoomIn(),s=!0;break;case 173:case 109:case 189:e.zoomOut(),s=!0;break;case 48:case 96:i||(setTimeout(function(){e.zoomReset()}),s=!1);break;case 38:(i||e.page>1)&&(e.page=1,s=!0,o=!0);break;case 40:(i||e.page<e.pagesCount)&&(Ii.page=Ii.pagesCount,s=!0,o=!0);break}if(l===3||l===10)switch(t.keyCode){case 80:e.requestPresentationMode(),s=!0,e.externalServices.reportTelemetry({type:"buttons",data:{id:"presentationModeKeyboard"}});break;case 71:e.appConfig.toolbar&&(e.appConfig.toolbar.pageNumber.select(),s=!0);break}if(s){o&&!i&&a.focus(),t.preventDefault();return}const r=I_(),c=r?.tagName.toUpperCase();if(!((c==="INPUT"||c==="TEXTAREA"||c==="SELECT"||r?.isContentEditable)&&t.keyCode!==27)){if(l===0){let d=0,u=!1;switch(t.keyCode){case 38:case 33:a.isVerticalScrollbarEnabled&&(u=!0),d=-1;break;case 8:i||(u=!0),d=-1;break;case 37:a.isHorizontalScrollbarEnabled&&(u=!0);case 75:case 80:d=-1;break;case 27:e.secondaryToolbar?.isOpen&&(e.secondaryToolbar.close(),s=!0),!e.supportsIntegratedFind&&e.findBar?.opened&&(e.findBar.close(),s=!0);break;case 40:case 34:a.isVerticalScrollbarEnabled&&(u=!0),d=1;break;case 13:case 32:i||(u=!0),d=1;break;case 39:a.isHorizontalScrollbarEnabled&&(u=!0);case 74:case 78:d=1;break;case 36:(i||e.page>1)&&(e.page=1,s=!0,o=!0);break;case 35:(i||e.page<e.pagesCount)&&(e.page=e.pagesCount,s=!0,o=!0);break;case 83:e.pdfCursorTools?.switchTool(nn.SELECT);break;case 72:e.pdfCursorTools?.switchTool(nn.HAND);break;case 82:e.rotatePages(90);break;case 115:e.pdfSidebar?.toggle();break}d!==0&&(!u||a.currentScaleValue==="page-fit")&&(d>0?a.nextPage():a.previousPage(),s=!0)}if(l===4)switch(t.keyCode){case 13:case 32:if(!i&&a.currentScaleValue!=="page-fit")break;a.previousPage(),s=!0;break;case 82:e.rotatePages(-90);break}!s&&!i&&(t.keyCode>=33&&t.keyCode<=40||t.keyCode===32&&c!=="BUTTON")&&(o=!0),o&&!a.containsElement(r)&&a.focus(),s&&t.preventDefault()}}function Uk(t){return t.preventDefault(),t.returnValue="",!1}function fE(t){const e=Ae(t.target);!e||e.overlayManager.active||e.externalServices.updateEditorStates(t)}const Wm={instance:{supportsPrinting:!1,createPrintService(){throw new Error("Not implemented: createPrintService")}}},Wk=typeof PDFJSDev<"u"?PDFJSDev.eval("BUNDLE_VERSION"):void 0,Vk=typeof PDFJSDev<"u"?PDFJSDev.eval("BUNDLE_BUILD"):void 0,zk=typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")?{LinkTarget:Aa,RenderingStates:Re,ScrollMode:Ce,SpreadMode:pt}:null;function pE(t){return{appContainer:t,mainContainer:t.querySelector("#viewerContainer"),viewerContainer:t.querySelector("#viewer"),toolbar:{rectAnno:t.querySelector("#rectAnno"),container:t.querySelector("#toolbarViewer"),numPages:t.querySelector("#numPages"),pageNumber:t.querySelector("#pageNumber"),scaleSelect:t.querySelector("#scaleSelect"),customScaleOption:t.querySelector("#customScaleOption"),previous:t.querySelector("#previous"),next:t.querySelector("#next"),zoomIn:t.querySelector("#zoomIn"),zoomOut:t.querySelector("#zoomOut"),viewFind:t.querySelector("#viewFind"),openFile:typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")?t.querySelector("#openFile"):null,print:t.querySelector("#print"),editorFreeTextButton:t.querySelector("#editorFreeText"),editorFreeTextParamsToolbar:t.querySelector("#editorFreeTextParamsToolbar"),editorInkButton:t.querySelector("#editorInk"),editorInkParamsToolbar:t.querySelector("#editorInkParamsToolbar"),download:t.querySelector("#download")},secondaryToolbar:{toolbar:t.querySelector("#secondaryToolbar"),toggleButton:t.querySelector("#secondaryToolbarToggle"),presentationModeButton:t.querySelector("#presentationMode"),openFileButton:typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")?t.querySelector("#secondaryOpenFile"):null,printButton:t.querySelector("#secondaryPrint"),downloadButton:t.querySelector("#secondaryDownload"),viewBookmarkButton:t.querySelector("#viewBookmark"),firstPageButton:t.querySelector("#firstPage"),lastPageButton:t.querySelector("#lastPage"),pageRotateCwButton:t.querySelector("#pageRotateCw"),pageRotateCcwButton:t.querySelector("#pageRotateCcw"),cursorSelectToolButton:t.querySelector("#cursorSelectTool"),cursorHandToolButton:t.querySelector("#cursorHandTool"),scrollPageButton:t.querySelector("#scrollPage"),scrollVerticalButton:t.querySelector("#scrollVertical"),scrollHorizontalButton:t.querySelector("#scrollHorizontal"),scrollWrappedButton:t.querySelector("#scrollWrapped"),spreadNoneButton:t.querySelector("#spreadNone"),spreadOddButton:t.querySelector("#spreadOdd"),spreadEvenButton:t.querySelector("#spreadEven"),documentPropertiesButton:t.querySelector("#documentProperties")},sidebar:{outerContainer:t.querySelector("#outerContainer"),sidebarContainer:t.querySelector("#sidebarContainer"),toggleButton:t.querySelector("#sidebarToggle"),thumbnailButton:t.querySelector("#viewThumbnail"),outlineButton:t.querySelector("#viewOutline"),attachmentsButton:t.querySelector("#viewAttachments"),layersButton:t.querySelector("#viewLayers"),thumbnailView:t.querySelector("#thumbnailView"),outlineView:t.querySelector("#outlineView"),attachmentsView:t.querySelector("#attachmentsView"),layersView:t.querySelector("#layersView"),outlineOptionsContainer:t.querySelector("#outlineOptionsContainer"),currentOutlineItemButton:t.querySelector("#currentOutlineItem")},sidebarResizer:{outerContainer:t.querySelector("#outerContainer"),resizer:t.querySelector("#sidebarResizer")},findBar:{bar:t.querySelector("#findbar"),toggleButton:t.querySelector("#viewFind"),findField:t.querySelector("#findInput"),highlightAllCheckbox:t.querySelector("#findHighlightAll"),caseSensitiveCheckbox:t.querySelector("#findMatchCase"),matchDiacriticsCheckbox:t.querySelector("#findMatchDiacritics"),entireWordCheckbox:t.querySelector("#findEntireWord"),findMsg:t.querySelector("#findMsg"),findResultsCount:t.querySelector("#findResultsCount"),findPreviousButton:t.querySelector("#findPrevious"),findNextButton:t.querySelector("#findNext")},passwordOverlay:{dialog:t.querySelector("#passwordDialog"),label:t.querySelector("#passwordText"),input:t.querySelector("#password"),submitButton:t.querySelector("#passwordSubmit"),cancelButton:t.querySelector("#passwordCancel")},documentProperties:{dialog:t.querySelector("#documentPropertiesDialog"),closeButton:t.querySelector("#documentPropertiesClose"),fields:{fileName:t.querySelector("#fileNameField"),fileSize:t.querySelector("#fileSizeField"),title:t.querySelector("#titleField"),author:t.querySelector("#authorField"),subject:t.querySelector("#subjectField"),keywords:t.querySelector("#keywordsField"),creationDate:t.querySelector("#creationDateField"),modificationDate:t.querySelector("#modificationDateField"),creator:t.querySelector("#creatorField"),producer:t.querySelector("#producerField"),version:t.querySelector("#versionField"),pageCount:t.querySelector("#pageCountField"),pageSize:t.querySelector("#pageSizeField"),linearized:t.querySelector("#linearizedField")}},annotationEditorParams:{editorFreeTextFontSize:t.querySelector("#editorFreeTextFontSize"),editorFreeTextColor:t.querySelector("#editorFreeTextColor"),editorInkColor:t.querySelector("#editorInkColor"),editorInkThickness:t.querySelector("#editorInkThickness"),editorInkOpacity:t.querySelector("#editorInkOpacity")},printContainer:t.querySelector("#printContainer"),openFileInput:typeof PDFJSDev>"u"||PDFJSDev.test("GENERIC")?t.querySelector("#fileInput"):null,debuggerScriptPath:"./debugger.js"}}function Vm(t,e,n,a){const i=new Ii(n);i.annoId=a;const s=pE(e);if(typeof PDFJSDev<"u"&&PDFJSDev.test("GENERIC")){const o=document.createEvent("CustomEvent");o.initCustomEvent("webviewerloaded",!0,!0,{source:window});try{parent.document.dispatchEvent(o)}catch(l){console.error(`webviewerloaded: ${l}`),document.dispatchEvent(o)}}else s.file=t;return i.run(s),Bv(e,i,s),i}document.blockUnblockOnload?.(!0);class zn extends ct{constructor(e){if(super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement.classList.add("item--unupdate"),this.element=e.tab.panelElement,this.path=e.path,this.pdfId=e.page,this.element.addEventListener("click",n=>{Ze(this.element.parentElement.parentElement),this.app.plugins.forEach(a=>{a.eventBus.emit("click-pdf",{event:n})})}),typeof this.pdfId=="string"){this.getPdfId(()=>{this.render()});return}else typeof this.pdfId=="number"&&(this.pdfPage=this.pdfId);this.render()}getPdfId(e){w("/api/asset/getFileAnnotation",{path:this.path+".sya"},n=>{if(n.code!==1){const a=JSON.parse(n.data.data);a[this.pdfId]?this.pdfPage=a[this.pdfId].page?a[this.pdfId].page+1:a[this.pdfId].pages[0].index+1:this.pdfPage=void 0}e()})}goToPage(e){if(!(typeof e>"u"||e===null)){if(this.pdfId=e,typeof e=="string"){this.getPdfId(()=>{Dr({value:this.pdfPage,pdfInstance:this.pdfObject,id:this.pdfId})});return}typeof e=="number"&&!isNaN(e)&&Dr({value:this.pdfId,pdfInstance:this.pdfObject})}}render(){const e=this.path.substr(this.path.lastIndexOf(".")).toLowerCase();if(p.Constants.SIYUAN_ASSETS_IMAGE.includes(e))this.element.innerHTML=`<div class="asset"><img src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></div>`;else if(p.Constants.SIYUAN_ASSETS_AUDIO.includes(e))this.element.innerHTML=`<div class="asset"><audio controls="controls" src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></audio></div>`;else if(p.Constants.SIYUAN_ASSETS_VIDEO.includes(e))this.element.innerHTML=`<div class="asset"><video controls="controls" src="${this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path}"></video></div>`;else if(e===".pdf"){this.element.innerHTML=`<div class="pdf__outer" id="outerContainer">
      <div id="sidebarContainer">
        <div id="toolbarSidebar">
          <div id="toolbarSidebarLeft">
              <button id="viewThumbnail" class="toolbarButton toggled b3-tooltips b3-tooltips__ne" aria-label="${window.siyuan.languages.thumbsTitle}">
                <svg><use xlink:href="#iconImage"></use></svg>
              </button>
              <button id="viewOutline" class="toolbarButton b3-tooltips b3-tooltips__ne" aria-label="${window.siyuan.languages.outline}">
                 <svg><use xlink:href="#iconAlignCenter"></use></svg>
              </button>
              <button id="viewAttachments" class="toolbarButton fn__none" data-l10n-id="attachments">
                 <span data-l10n-id="attachments_label">Attachments</span>
              </button>
              <button id="viewLayers" class="toolbarButton fn__none" data-l10n-id="layers">
                 <span data-l10n-id="layers_label">Layers</span>
              </button>
          </div>
          <div class="fn__flex-1"></div>
          <div id="toolbarSidebarRight">
            <div id="outlineOptionsContainer" class="fn__hidden">
              <button id="currentOutlineItem" class="toolbarButton b3-tooltips b3-tooltips__nw" disabled="disabled" aria-label="${window.siyuan.languages.focusOutline}">
                <svg><use xlink:href="#iconFocus"></use></svg>
              </button>
            </div>
          </div>
        </div>
        <div id="sidebarContent">
          <div id="thumbnailView">
          </div>
          <div id="outlineView" class="fn__hidden">
          </div>
          <div id="attachmentsView" class="fn__hidden">
          </div>
          <div id="layersView" class="fn__hidden">
          </div>
        </div>
        <div id="sidebarResizer"></div>
      </div>
      <div id="mainContainer">
        <div class="findbar b3-menu fn__hidden doorHanger" id="findbar">
            <input id="findInput" class="toolbarField b3-text-field" placeholder="${window.siyuan.languages.search}">
            <div class="fn__space"></div>
            <button id="findPrevious" class="toolbarButton findPrevious b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.previous}">
                <svg><use xlink:href="#iconUp"></use></svg>
            </button>
            <button id="findNext" class="toolbarButton findNext b3-tooltips b3-tooltips__n" aria-label="${window.siyuan.languages.next}">
                <svg><use xlink:href="#iconDown"></use></svg>
            </button>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findHighlightAll" class="toolbarField">
                ${window.siyuan.languages.findHighlight}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findMatchCase" class="toolbarField">
                ${window.siyuan.languages.searchCaseSensitive}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findMatchDiacritics" class="toolbarField">
                ${window.siyuan.languages.matchDiacritics}
            </label>
            <div class="fn__space"></div>
            <label class="b3-button b3-button--outline b3-button--small">
                <input type="checkbox" id="findEntireWord" class="toolbarField">
                ${window.siyuan.languages.findEntireWord}
            </label>
            <div class="fn__space"></div>
            <span id="findResultsCount" class="b3-button b3-button--small b3-button--cancel"></span>
            <span id="findMsg" class="b3-button b3-button--small b3-button--cancel"></span>
        </div>  <!-- findbar -->
        <div id="secondaryToolbar" class="secondaryToolbar fn__hidden doorHangerRight b3-menu">
          <div id="secondaryToolbarButtonContainer" class="b3-menu__items">
            <button id="pdfLight" class="secondaryToolbarButton b3-menu__item toggled">
              <svg class="b3-menu__icon"><use xlink:href="#iconLight"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.themeLight}</span>
            </button>
            <button id="pdfDark" class="secondaryToolbarButton b3-menu__item">
              <svg class="b3-menu__icon"><use xlink:href="#iconDark"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.themeDark}</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="previous" class="secondaryToolbarButton b3-menu__item pageUp">
              <svg class="b3-menu__icon"><use xlink:href="#iconUp"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.previousLabel}</span>
              <span class="b3-menu__accelerator">${K("P")}/${K("K")}</span>
            </button>
            <button id="next" class="secondaryToolbarButton b3-menu__item pageDown">
              <svg class="b3-menu__icon"><use xlink:href="#iconDown"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.nextLabel}</span>
              <span class="b3-menu__accelerator">${K("J")}/${K("N")}</span>
            </button>
            <button id="firstPage" class="secondaryToolbarButton b3-menu__item firstPage">
              <svg class="b3-menu__icon"><use xlink:href="#iconBack"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.firstPage}</span>
              <span class="b3-menu__accelerator">Home</span>
            </button>
            <button id="lastPage" class="secondaryToolbarButton b3-menu__item lastPage">
              <svg class="b3-menu__icon"><use xlink:href="#iconForward"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.lastPage}</span>
              <span class="b3-menu__accelerator">End</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="zoomOut" class="secondaryToolbarButton b3-menu__item zoomOut">
               <svg class="b3-menu__icon"><use xlink:href="#iconLine"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.zoomOut}</span>
               <span class="b3-menu__accelerator">${K("\u2318-")}</span>
            </button>
            <button id="zoomIn" class="secondaryToolbarButton b3-menu__item zoomIn">
               <svg class="b3-menu__icon"><use xlink:href="#iconAdd"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.zoomIn}</span>
               <span class="b3-menu__accelerator">${K("\u2318=")}</span>
            </button>
            <button id="pageRotateCw" class="secondaryToolbarButton b3-menu__item rotateCw">
               <svg class="b3-menu__icon"><use xlink:href="#iconRedo"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.rotateCw}</span>
               <span class="b3-menu__accelerator">R</span>
            </button>
            <button id="pageRotateCcw" class="secondaryToolbarButton b3-menu__item rotateCcw">
               <svg class="b3-menu__icon"><use xlink:href="#iconUndo"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.rotateCcw}</span>
               <span class="b3-menu__accelerator">\u21E7R</span>
            </button>

            <div class="horizontalToolbarSeparator b3-menu__separator"></div>

            <button id="cursorSelectTool" class="secondaryToolbarButton b3-menu__item selectTool toggled">
               <svg class="b3-menu__icon"><use xlink:href="#iconSelectText"></use></svg> 
               <span class="b3-menu__label">${window.siyuan.languages.cursorText}</span>
               <span class="b3-menu__accelerator">S</span>
            </button>
            <button id="cursorHandTool" class="secondaryToolbarButton b3-menu__item handTool">
              <svg class="b3-menu__icon"><use xlink:href="#iconHand"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.cursorHand}</span>
              <span class="b3-menu__accelerator">H</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator"></div>
            <button id="scrollVertical" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollVertical toggled">
             <svg class="b3-menu__icon"><use xlink:href="#iconScrollVert"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollVertical}</span>
            </button>
            <button id="scrollHorizontal" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollHorizontal">
              <svg class="b3-menu__icon"><use xlink:href="#iconScrollHoriz"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollHorizontal}</span>
            </button>
            <button id="scrollWrapped" class="secondaryToolbarButton b3-menu__item scrollModeButtons scrollWrapped">
             <svg class="b3-menu__icon"><use xlink:href="#iconScrollWrapped"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.scrollWrapped}</span>
            </button>

            <div class="horizontalToolbarSeparator b3-menu__separator scrollModeButtons"></div>

            <button id="spreadNone" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadNone toggled">
              <svg class="b3-menu__icon"><use xlink:href="#iconFile"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadNone}</span>
            </button>
            <button id="spreadOdd" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadOdd">
              <svg class="b3-menu__icon"><use xlink:href="#iconSpreadOdd"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadOdd}</span>
            </button>
            <button id="spreadEven" class="secondaryToolbarButton b3-menu__item spreadModeButtons spreadEven">
              <svg class="b3-menu__icon"><use xlink:href="#iconSpreadEven"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.spreadEven}</span>
            </button>
            <button id="presentationMode" class="secondaryToolbarButton b3-menu__item presentationMode">
              <svg class="b3-menu__icon"><use xlink:href="#iconPlay"></use></svg>
              <span class="b3-menu__label">${window.siyuan.languages.presentationMode}</span>
              <span class="b3-menu__accelerator">${K("\u2325\u2318P")}</span>
            </button>
            <div class="horizontalToolbarSeparator b3-menu__separator spreadModeButtons"></div>
            <button id="documentProperties" class="secondaryToolbarButton b3-menu__item documentProperties">
              <svg class="b3-menu__icon"><use xlink:href="#iconInfo"></use></svg> 
              <span class="b3-menu__label">${window.siyuan.languages.attr}</span>
            </button>
          </div>
        </div>  <!-- secondaryToolbar -->

        <div class="pdf__toolbar">
          <div id="toolbarContainer">
            <div id="toolbarViewer">
                <button id="sidebarToggle" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="sidebarContainer" aria-label="${window.siyuan.languages.toggleSidebarNotification2Title} ${K("F4")}">
                    <svg><use xlink:href="#iconLayoutRight"></use></svg>
                </button>
                <button id="viewFind" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="findbar" aria-label="${window.siyuan.languages.search} ${K("\u2318F")}">
                  <svg><use xlink:href="#iconSearch"></use></svg>
                </button>
                <button id="rectAnno" class="toolbarButton b3-tooltips b3-tooltips__se" aria-expanded="false" aria-controls="findbar" aria-label="${window.siyuan.languages.rectAnnotation} ${K("\u2318D")}/${K("\u2325D")}">
                  <svg><use xlink:href="#iconLeftTop"></use></svg>
                </button>
                <input type="number" id="pageNumber" class="toolbarField pageNumber b3-text-field" value="1" size="4" min="1" autocomplete="off">
                <span id="numPages"></span>
                <div class="fn__flex-1"></div>
                <span id="scaleSelectContainer" class="dropdownToolbarButton">
                  <select id="scaleSelect" class="b3-select">
                    <option id="pageAutoOption" value="auto" selected="selected">${window.siyuan.languages.pageScaleAuto}</option>
                    <option id="pageActualOption" value="page-actual">${window.siyuan.languages.pageScaleActual}</option>
                    <option id="pageFitOption" value="page-fit">${window.siyuan.languages.pageScaleFit}</option>
                    <option id="pageWidthOption" value="page-width">${window.siyuan.languages.pageScaleWidth}</option>
                    <option id="customScaleOption" value="custom" disabled="disabled" hidden="true"></option>
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1">100%</option>
                    <option value="1.25">125%</option>
                    <option value="1.5">150%</option>
                    <option value="2">200%</option>
                    <option value="3">300%</option>
                    <option value="4">400%</option>
                  </select>
                </span>
                <span id="scrollPage" class="fn__none"></span>
                <span id="print" class="fn__none"></span>
                <span id="secondaryPrint" class="fn__none"></span>
                <span id="viewBookmark" class="fn__none"></span>
                <span id="secondaryViewBookmark" class="fn__none"></span>
                <button id="secondaryToolbarToggle" class="toolbarButton b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.more}" aria-expanded="false" aria-controls="secondaryToolbar">
                  <svg><use xlink:href="#iconMore"></use></svg>
                </button>
            </div>
            <div id="loadingBar">
              <div class="progress">
                <div class="glimmer">
                </div>
              </div>
            </div>
          </div>
        </div>

        <div id="viewerContainer">
          <div id="viewer" class="pdfViewer"></div>
          <div class="pdf__resize fn__none"></div>
        </div>
        <div id="errorWrapper" hidden='true'>
          <div id="errorMessageLeft">
            <span id="errorMessage"></span>
            <button id="errorShowMore" data-l10n-id="error_more_info">
              More Information
            </button>
            <button id="errorShowLess" data-l10n-id="error_less_info" hidden='true'>
              Less Information
            </button>
          </div>
          <div id="errorMessageRight">
            <button id="errorClose" data-l10n-id="error_close">
              Close
            </button>
          </div>
          <div class="clearBoth"></div>
          <textarea id="errorMoreInfo" hidden='true' readonly="readonly"></textarea>
        </div>
      </div>
      <div id="dialogContainer">
        <div class="dialog" id="passwordDialog">
            <div class="row">
              <p id="passwordText" data-l10n-id="password_label">Enter the password to open this PDF file:</p>
            </div>
            <div class="row">
              <input type="password" id="password" class="toolbarField">
            </div>
            <div class="buttonRow">
              <button id="passwordCancel" class="overlayButton"><span data-l10n-id="password_cancel">Cancel</span></button>
              <button id="passwordSubmit" class="overlayButton"><span data-l10n-id="password_ok">OK</span></button>
            </div>
        </div>
        <div class="dialog" id="documentPropertiesDialog">
            <div class="row">
              <span>${window.siyuan.languages.fileName}</span> <p id="fileNameField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.fileSize}</span> <p id="fileSizeField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>${window.siyuan.languages.title1}</span> <p id="titleField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.author}</span> <p id="authorField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.subject}</span> <p id="subjectField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.keywords}</span> <p id="keywordsField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.creationDate}</span> <p id="creationDateField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.modificationDate}</span> <p id="modificationDateField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.creator}</span> <p id="creatorField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>PDF ${window.siyuan.languages.producer}</span> <p id="producerField">-</p>
            </div>
            <div class="row">
              <span>PDF ${window.siyuan.languages.version}</span> <p id="versionField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.pageCount}</span> <p id="pageCountField">-</p>
            </div>
            <div class="row">
              <span>${window.siyuan.languages.pageSize}</span> <p id="pageSizeField">-</p>
            </div>
            <div class="separator"></div>
            <div class="row">
              <span>${window.siyuan.languages.linearized}</span> <p id="linearizedField">-</p>
            </div>
            <div class="buttonRow">
              <button id="documentPropertiesClose" class="b3-button"><span>${window.siyuan.languages.close}</span></button>
            </div>
        </div>
        <div class="dialog" id="printServiceOverlay">
            <div class="row">
              <span data-l10n-id="print_progress_message">Preparing document for printing\u2026</span>
            </div>
            <div class="row">
              <progress value="0" max="100"></progress>
              <span data-l10n-id="print_progress_percent" data-l10n-args='{ "progress": 0 }' class="relative-progress">0%</span>
            </div>
            <div class="buttonRow">
              <button id="printCancel" class="overlayButton"><span data-l10n-id="print_progress_close">Cancel</span></button>
            </div>
        </div>
      </div>
      <div class="pdf__util b3-menu fn__none pdf__util--hide">
        <div class="fn__flex" style="padding: 0 4px">
            <button class="color__square" style="background-color:var(--b3-pdf-background1)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background2)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background3)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background4)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background5)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background6)"></button>
            <button class="color__square" style="background-color:var(--b3-pdf-background7)"></button>
        </div>
        <div class="b3-menu__separator pdf__util__hide" style="margin-top: 8px"></div>
        <button class="b3-menu__item pdf__util__hide" data-type="toggle">
            <svg class="b3-menu__icon"><use xlink:href="#iconFilesRoot"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.showHideBg}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="copy">
            <svg class="b3-menu__icon"><use xlink:href="#iconRef"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.copyAnnotation}</span>
        </button>
        <button class="b3-menu__item pdf__util__hide" data-type="remove">
            <svg class="b3-menu__icon"><use xlink:href="#iconTrashcan"></use></svg>
            <span class="b3-menu__label">${window.siyuan.languages.remove}</span>
        </button>
      </div>
      <div class="fn__none">
        <input id="editorFreeTextFontSize">
        <input id="editorFreeTextColor">
        <input id="editorInkColor">
        <input id="editorInkThickness">
        <input id="editorInkOpacity">
        <input id="download">
        <input id="secondaryDownload">
        <input id="editorFreeText">
        <input id="openFile">
        <input id="editorInk">
      </div>
    </div> <!-- outerContainer -->
    <div id="printContainer"></div>`;const n=window.siyuan.storage[p.Constants.LOCAL_PDFTHEME],a=window.siyuan.config.appearance.mode===0?n.light:n.dark,i=this.element.querySelector("#pdfDark"),s=this.element.querySelector("#pdfLight");a==="dark"?(this.element.firstElementChild.classList.add("pdf__outer--dark"),s.classList.remove("toggled"),i.classList.add("toggled")):(s.classList.add("toggled"),i.classList.remove("toggled")),s.addEventListener("click",()=>{window.siyuan.config.appearance.mode===0?n.light="light":n.dark="light",this.element.firstElementChild.classList.remove("pdf__outer--dark"),s.classList.add("toggled"),i.classList.remove("toggled"),pe(p.Constants.LOCAL_PDFTHEME,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME])}),i.addEventListener("click",()=>{window.siyuan.config.appearance.mode===0?n.light="dark":n.dark="dark",this.element.firstElementChild.classList.add("pdf__outer--dark"),s.classList.remove("toggled"),i.classList.add("toggled"),pe(p.Constants.LOCAL_PDFTHEME,window.siyuan.storage[p.Constants.LOCAL_PDFTHEME])}),setTimeout(()=>{if(this.element.clientWidth===0){const o=new MutationObserver(()=>{this.pdfObject=Vm(this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path,this.element,this.pdfPage,this.pdfId),this.element.setAttribute("data-loading","true"),o.disconnect()});o.observe(this.element,{attributeFilter:["class"]})}else this.pdfObject=Vm(this.path.startsWith("file")?this.path:document.getElementById("baseURL").getAttribute("href")+"/"+this.path,this.element,this.pdfPage,this.pdfId),this.element.setAttribute("data-loading","true");au()},p.Constants.TIMEOUT_LOAD)}}}class Za extends ct{constructor(e){super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement?.classList.add("item--unupdate"),this.element=e.tab.panelElement,this.config=e.config,this.edit=Yp(e.app,this.config,this.element),this.element.addEventListener("click",()=>{Ze(this.element.parentElement.parentElement)})}updateSearch(e,n){const a=this.element.querySelector(".b3-text-field");if(e===""){a.select();return}const i=a.value;i!==e&&(n||(i.indexOf(e)>-1?e=i.replace(e+" ","").replace(" "+e,""):i!==""&&(e=i+" "+e)),a.value=e,a.select(),a.dispatchEvent(new CustomEvent("input")))}}class sa extends ct{constructor(e){super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement?.classList.add("item--unupdate"),this.element=e.tab.panelElement,this.tab=e.tab,this.data=e.data,this.type=e.type,this.init=e.init,this.destroy=e.destroy,this.beforeDestroy=e.beforeDestroy,this.resize=e.resize,this.update=e.update,this.init(this)}}const ku=t=>{let e;const n=new sa({app:t.app,type:"siyuan-card",tab:t.tab,data:t.data,init(){t.data.cardsData?(this.element.innerHTML=pr({id:this.data.id,cardType:this.data.cardType,cardsData:t.data.cardsData,isTab:!0}),e=Qd({app:t.app,element:this.element,id:this.data.id,title:this.data.title,cardType:this.data.cardType,cardsData:t.data.cardsData,index:t.data.index}),this.data.editor=e,delete t.data.cardsData,delete t.data.index):w(this.data.cardType==="all"?"/api/riff/getRiffDueCards":this.data.cardType==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:this.data.id,deckID:this.data.id,notebook:this.data.id},a=>{this.element.innerHTML=pr({id:this.data.id,cardType:this.data.cardType,cardsData:a.data,isTab:!0}),e=Qd({app:t.app,element:this.element,id:this.data.id,title:this.data.title,cardType:this.data.cardType,cardsData:a.data}),n.data.editor=e})},destroy(){e&&e.destroy()},resize(){e&&e.resize()},update(){w(this.data.cardType==="all"?"/api/riff/getRiffDueCards":this.data.cardType==="doc"?"/api/riff/getTreeRiffDueCards":"/api/riff/getNotebookRiffDueCards",{rootID:this.data.id,deckID:this.data.id,notebook:this.data.id},a=>{this.element.innerHTML=pr({id:this.data.id,cardType:this.data.cardType,cardsData:a.data,isTab:!0})})}});return n.element.addEventListener("click",()=>{Ze(n.element.parentElement.parentElement)}),n},de=async t=>{const e=await lt("/api/block/getBlockInfo",{id:t.id});if(e.code!==-1){if(e.code===3){M(e.msg);return}return Dn({app:t.app,fileName:e.data.rootTitle,rootIcon:e.data.rootIcon,rootID:e.data.rootID,id:t.id,position:t.position,mode:t.mode,action:t.action,zoomIn:t.zoomIn,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,afterOpen:t.afterOpen})}},ks=(t,e,n,a)=>{const i=Le().extname(e.split("?page")[0]);p.Constants.SIYUAN_ASSETS_EXTS.includes(i)&&Dn({app:t,assetPath:e,page:n,position:a,removeCurrentTab:!0})},Dn=async t=>{typeof t.removeCurrentTab>"u"&&(t.removeCurrentTab=!0);const e=Pe();if(t.assetPath){const o=e.asset.find(l=>{if(l.path==t.assetPath)return Hi(l.parent.parent.element)||(l.parent.parent.switchTab(l.parent.headElement),l.parent.parent.showHeading(),l.goToPage(t.page)),!0});if(o)return t.afterOpen&&t.afterOpen(),o.parent}else if(t.custom){const o=e.custom.find(r=>{if((0,I.MK)(r.data,t.custom.data)&&(!t.custom.id||t.custom.id===r.type))return Hi(r.parent.parent.element)||(r.parent.parent.switchTab(r.parent.headElement),r.parent.parent.showHeading()),!0});if(o)return t.afterOpen&&t.afterOpen(),o.parent;const l=Su(t);if(l)return t.afterOpen&&t.afterOpen(),l}else if(t.searchData){const o=e.search.find(l=>{if((0,I.MK)(l.config,t.searchData))return Hi(l.parent.parent.element)||(l.parent.parent.switchTab(l.parent.headElement),l.parent.parent.showHeading()),!0});if(o)return o.parent}else if(!t.position){let o,l;if(e.editor.find(c=>{if(c.editor.protyle.block.rootID===t.rootID&&(A(c.element,"layout__wnd--active")&&(l=c),o=c),l)return!0}),l&&(o=l),o)return Hi(o.parent.parent.element)||zm(o,t,e),t.afterOpen&&t.afterOpen(),o.parent;const r=Su(t);if(r)return t.afterOpen&&t.afterOpen(),r}let n=!1;const a=Object.assign({},t);if(delete a.app,n=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:p.Constants.SIYUAN_OPEN_FILE,options:JSON.stringify(a)}),n){t.afterOpen&&t.afterOpen();return}let i;const s=document.querySelector(".layout__wnd--active");if(s&&(i=Lt(s.getAttribute("data-id"))),i||(i=Ni(window.siyuan.layout.centerLayout)),i){let o;if((t.position==="right"||t.position==="bottom")&&i.children[0].headElement){const l=t.position==="right"?"lr":"tb";let r;if(i.parent.children.length>1&&i.parent instanceof Kn&&i.parent.direction===l&&i.parent.children.find((c,d)=>{if(c.id===i.id){let u=i.parent.children[d+1];for(u||(u=i);u instanceof Kn;)u=u.children[0];return r=u,!0}}),r){if(Hi(r.element)){t.afterOpen&&t.afterOpen();return}let c=r.children.find(d=>{if(d.model&&d.model instanceof dt&&d.model.editor.protyle.block.rootID===t.rootID)return zm(d.model,t,e),!0});c||(c=Su(t),o=c),c||(o=Oo(t),r.addTab(o))}else o=Oo(t),i.split(l).addTab(o);return i.showHeading(),t.afterOpen&&t.afterOpen(),o}if(Hi(i.element)){t.afterOpen&&t.afterOpen();return}if(t.keepCursor&&i.children[0].headElement)o=Oo(t),o.headElement.setAttribute("keep-cursor",t.id),i.addTab(o,t.keepCursor);else if(window.siyuan.config.fileTree.openFilesUseCurrentTab){let l;i.children.find(r=>{if(r.headElement&&r.headElement.classList.contains("item--unupdate")&&!r.headElement.classList.contains("item--pin")&&(l=r,r.headElement.classList.contains("item--focus")))return!0}),o=Oo(t),i.addTab(o),l&&t.removeCurrentTab&&i.removeTab(l.id,!1,!1)}else o=Oo(t),i.addTab(o);return i.showHeading(),t.afterOpen&&t.afterOpen(),o}},Su=t=>Yn().find(e=>{const n=e.headElement?.getAttribute("data-initdata");if(n){const a=JSON.parse(n);if(a.instance==="Editor"&&(a.rootId===t.rootID||a.blockId===t.rootID))return a.blockId=t.id,a.mode=t.mode,t.zoomIn?a.action=[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS]:a.action=t.action,e.headElement.setAttribute("data-initdata",JSON.stringify(a)),e.parent.switchTab(e.headElement),!0;if(a.instance==="Custom"&&t.custom&&(0,I.MK)(a.customModelData,t.custom.data))return e.parent.switchTab(e.headElement),!0}}),zm=(t,e,n)=>{if(n.editor.forEach(i=>{!i.element.isSameNode(t.element)&&window.siyuan.editorIsFullscreen&&i.element.classList.contains("fullscreen")&&(i.element.classList.remove("fullscreen"),qt(i.editor.protyle))}),window.siyuan.editorIsFullscreen&&(t.element.classList.add("fullscreen"),qt(t.editor.protyle)),e.keepCursor)return t.parent.headElement.setAttribute("keep-cursor",e.id),!0;if(t.parent.parent.switchTab(t.parent.headElement),t.parent.parent.showHeading(),e.mode!=="preview"&&!t.editor.protyle.preview.element.classList.contains("fn__none"))return!0;if(e.zoomIn)return Vt({protyle:t.editor.protyle,id:e.id}),!0;let a;if(Array.from(t.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${e.id}"]`)).find(i=>{if(!q(i.parentElement,"data-type","NodeBlockQueryEmbed"))return a=i,!0}),(!a||a?.clientHeight===0)&&e.id!==e.rootID)w("/api/filetree/getDoc",{id:e.id,mode:e.action&&e.action.includes(p.Constants.CB_GET_CONTEXT)?3:0,size:window.siyuan.config.editor.dynamicLoadBlocks},i=>{st({data:i,protyle:t.editor.protyle,action:e.action}),xu(n,t.editor.protyle)});else{if(ln(t.editor.protyle),e.action?.includes(p.Constants.CB_GET_HL))Ow(t.editor.protyle,e.id,!0);else if(e.action?.includes(p.Constants.CB_GET_FOCUS))if(a){const i=le(a);i&&(t.editor.protyle.toolbar.range=i),He(t.editor.protyle,a,!0)}else t.editor.protyle.block.rootID===e.id||t.editor.protyle.toolbar.range&&(a=x(t.editor.protyle.toolbar.range.startContainer),Z(t.editor.protyle.toolbar.range),a&&He(t.editor.protyle,a));ys(t.editor.protyle,void 0,a||t.editor.protyle.wysiwyg.element.firstElementChild)}e.mode&&Di(t.editor.protyle,e.mode)},Oo=t=>{let e;if(t.assetPath){const n=Le().extname(t.assetPath.split("?page")[0]);if(p.Constants.SIYUAN_ASSETS_EXTS.includes(n)){let a="iconPDF";p.Constants.SIYUAN_ASSETS_IMAGE.includes(n)?a="iconImage":p.Constants.SIYUAN_ASSETS_AUDIO.includes(n)?a="iconRecord":p.Constants.SIYUAN_ASSETS_VIDEO.includes(n)&&(a="iconVideo"),e=new gt({icon:a,title:ft(t.assetPath),callback(i){i.addModel(new zn({app:t.app,tab:i,path:t.assetPath,page:t.page})),Ze(i.panelElement.parentElement.parentElement)}})}}else t.custom?e=new gt({icon:t.custom.icon,title:t.custom.title,callback(n){t.custom.id?t.custom.id==="siyuan-card"?n.addModel(ku({app:t.app,tab:n,data:t.custom.data})):t.app.plugins.find(a=>{if(a.models[t.custom.id])return n.addModel(a.models[t.custom.id]({tab:n,data:t.custom.data})),!0}):(console.warn("0.8.3 \u5C06\u79FB\u9664 custom.fn \u53C2\u6570\uFF0C\u8BF7\u53C2\u7167 https://github.com/siyuan-note/plugin-sample/blob/91a716358941791b4269241f21db25fd22ae5ff5/src/index.ts \u5C06\u5176\u4FEE\u6539\u4E3A custom.id"),n.addModel(t.custom.fn({tab:n,data:t.custom.data}))),Ze(n.panelElement.parentElement.parentElement)}}):t.searchData?e=new gt({icon:"iconSearch",title:window.siyuan.languages.search,callback(n){n.addModel(new Za({app:t.app,tab:n,config:t.searchData})),Ze(n.panelElement.parentElement.parentElement)}}):e=new gt({title:ft(t.fileName,!0,!0),docIcon:t.rootIcon,callback(n){let a;t.zoomIn?a=new dt({app:t.app,tab:n,blockId:t.id,rootId:t.rootID,action:[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS]}):a=new dt({app:t.app,tab:n,blockId:t.id,rootId:t.rootID,mode:t.mode,action:t.action}),n.addModel(a)}});return e},Ta=t=>{if(t.protyle&&t.protyle.path){if(t.protyle.element.classList.contains("fn__none")||!A(t.protyle.element,"layout__wnd--active")&&document.querySelector(".layout__wnd--active"))return;if(t.resize&&qt(t.protyle),t.focus&&(t.protyle.toolbar.range?(Z(t.protyle.toolbar.range),Ls(t.protyle.toolbar.range,t.protyle.block.rootID),t.pushBackStack&&t.protyle.preview.element.classList.contains("fn__none")&&ys(t.protyle,t.protyle.toolbar.range)):(le(t.protyle.wysiwyg.element.firstElementChild),t.pushBackStack&&t.protyle.preview.element.classList.contains("fn__none")&&ys(t.protyle,void 0,t.protyle.wysiwyg.element.firstElementChild),Gt([],t.protyle.block.rootID))),window.siyuan.config.fileTree.alwaysSelectOpenedFile&&t.protyle){const n=St("file")?.data.file;if(n instanceof xa){const a=n.element.querySelector(`li[data-path="${t.protyle.path}"]`);(!a||a&&!a.classList.contains("b3-list-item--focus"))&&n.selectItem(t.protyle.notebookId,t.protyle.path)}}const e=Pe();Cu(e,t.protyle,t.reload),xu(e,t.protyle),t.protyle.app.plugins.forEach(n=>{n.eventBus.emit("switch-protyle",{protyle:t.protyle})})}},Lu=t=>{const e=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus");if(e){const n=Lt(e.getAttribute("data-id"));if(n instanceof gt&&n.model instanceof dt&&n.model.editor.protyle.block.rootID!==t&&n.model.editor.protyle.block.parentID!==t&&n.model.editor.protyle.block.id!==t)return!1}return!0},Cu=(t,e,n=!1)=>{t.outline.find(a=>{if(n||a.type==="pin"&&(!e||a.blockId!==e.block?.rootID)){let i="";if(e&&e.block&&(i=e.block.rootID),i===a.blockId&&!n)return;if(e&&!e.preview.element.classList.contains("fn__none")){e.preview.render(e);return}w("/api/outline/getDocOutline",{id:i},s=>{if(!(!n&&(!Lu(i)||a.blockId===i)))if(a.isPreview=!1,a.update(s,i),e){if(a.updateDocTitle(e.background.ial),getSelection().rangeCount>0){const o=getSelection().getRangeAt(0).startContainer;if(e.wysiwyg.element.contains(o)){const l=q(o,"data-node-id",null);l&&a.setCurrent(l)}}}else a.updateDocTitle()})}})},xu=(t,e)=>{e&&e.element.classList.contains("fn__none")||e&&!A(e.element,"layout__wnd--active")&&document.querySelector(".layout__wnd--active")||(t.graph.forEach(n=>{if(n.type!=="global"&&(!e||n.blockId!==e.block?.id)){if(n.type==="local"&&n.rootId!==e?.block?.rootID)return;let a="";if(e&&e.block&&(a=e.block.showAll?e.block.id:e.block.parentID),a===n.blockId)return;n.searchGraph(!0,a)}}),t.backlink.forEach(n=>{if(n.type==="local"&&n.rootId!==e?.block?.rootID)return;let a="";e&&e.block&&(a=e.block.showAll?e.block.id:e.block.parentID),a!==n.blockId&&(n.element.querySelector('.block__icon[data-type="refresh"] svg').classList.add("fn__rotate"),w("/api/ref/getBacklink2",{sort:n.status[a]?n.status[a].sort:"3",mSort:n.status[a]?n.status[a].mSort:"3",id:a||"",k:n.inputsElement[0].value,mk:n.inputsElement[1].value},i=>{if(!Lu(a)||n.blockId===a){n.element.querySelector('.block__icon[data-type="refresh"] svg').classList.remove("fn__rotate");return}n.saveStatus(),n.blockId=a,n.render(i.data)}))}))},fn=(t,e)=>{if(t.startsWith("assets/")){w("/api/asset/resolveAssetPath",{path:t.replace(/\.pdf\?page=\d{1,}$/,".pdf")},a=>{e==="app"?te.shell.openPath(a.data):e==="folder"&&Qn(a.data)});return}let n="";window.siyuan.config.system.os==="windows"?n=t.replace("file:///","").replace("file://\\","").replace("file://","").replace(/\//g,"\\"):n=t.replace("file://",""),n=n.replace(/\\\)/g,")").replace(/\\\(/g,"("),e==="app"?te.shell.openPath(n):e==="folder"&&(window.siyuan.config.system.os==="windows"&&(n.startsWith("\\\\")||(n=n.replace(/\\\\/g,"\\"))),Qn(n))},Di=(t,e)=>{if(e==="preview"){if(!t.preview.element.classList.contains("fn__none"))return;t.preview.element.classList.remove("fn__none"),t.contentElement.classList.add("fn__none"),t.scroll?.element.classList.add("fn__none"),t.options.render.breadcrumb&&(t.breadcrumb?.element.classList.add("fn__none"),t.breadcrumb.toggleExit(!0)),t.preview.render(t)}else if(e==="wysiwyg"){if(!t.contentElement.classList.contains("fn__none"))return;t.preview.element.classList.add("fn__none"),t.contentElement.classList.remove("fn__none"),t.options.render.scroll&&t.scroll?.element.classList.remove("fn__none"),t.options.render.breadcrumb&&(t.breadcrumb?.element.classList.remove("fn__none"),t.breadcrumb.toggleExit(!t.block.showAll)),Cu(Pe(),t,!0),qt(t)}X(["gutter","toolbar","select","hint","util"],t)};let Ym;const gE=(t,e)=>{e.addEventListener("scroll",()=>{const n=e.getBoundingClientRect();if(!t.toolbar.element.classList.contains("fn__none")){const a=t.toolbar.element.getAttribute("data-inity").split(p.Constants.ZWSP),i=parseInt(a[0])+(parseInt(a[1])-e.scrollTop);i<n.top-t.toolbar.toolbarHeight||i>n.bottom-t.toolbar.toolbarHeight?t.toolbar.element.style.display="none":(t.toolbar.element.style.top=i+"px",t.toolbar.element.style.display="")}t.wysiwyg.element.querySelectorAll(".av").forEach(a=>{a.dataset.render==="true"&&Ua(a,n,"all")}),!t.element.classList.contains("block__edit")&&!(0,I.tq)()&&t.contentElement.setAttribute("data-scrolltop",e.scrollTop.toString()),window.siyuan.dragElement||X(["gutter"],t),t.scroll&&!t.scroll.element.classList.contains("fn__none")&&(clearTimeout(Ym),Ym=window.setTimeout(()=>{let a=document.elementFromPoint(n.left+n.width/2,n.top+10);a.classList.contains("protyle-wysiwyg")&&(a=document.elementFromPoint(n.left+n.width/2,n.top+20));const i=x(a);if(!i){if((t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.wysiwyg.element.firstElementChild.getAttribute("data-node-index")==="0")&&(A(a,"protyle-background")||A(a,"protyle-title"))){const s=t.scroll.element.querySelector(".b3-slider");s.value="1",t.scroll.element.setAttribute("aria-label",`Blocks 1/${t.block.blockCount}`)}return}t.scroll.updateIndex(t,i.getAttribute("data-node-id"))},p.Constants.TIMEOUT_LOAD)),!(t.wysiwyg.element.getAttribute("data-top")||t.block.showAll||t.scroll&&t.scroll.element.classList.contains("fn__none")||!t.scroll||t.scroll.lastScrollTop===e.scrollTop||t.scroll.lastScrollTop===-1)&&(t.scroll.lastScrollTop-e.scrollTop>0?e.scrollTop<e.clientHeight&&t.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(t.contentElement.style.width=t.contentElement.clientWidth+"px",t.contentElement.style.overflow="hidden",t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),w("/api/filetree/getDoc",{id:t.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{t.contentElement.style.overflow="",t.contentElement.style.width="",st({data:a,protyle:t,action:[p.Constants.CB_GET_BEFORE,p.Constants.CB_GET_UNCHANGEID]})})):e.scrollTop>e.scrollHeight-e.clientHeight*1.8&&t.wysiwyg.element.lastElementChild&&t.wysiwyg.element.lastElementChild.getAttribute("data-eof")!=="2"&&(t.wysiwyg.element.setAttribute("data-top",e.scrollTop.toString()),w("/api/filetree/getDoc",{id:t.wysiwyg.element.lastElementChild.getAttribute("data-node-id"),mode:2,size:window.siyuan.config.editor.dynamicLoadBlocks},a=>{st({data:a,protyle:t,action:[p.Constants.CB_GET_APPEND,p.Constants.CB_GET_UNCHANGEID]})})),t.scroll.lastScrollTop=Math.max(e.scrollTop,0))},{capture:!1,passive:!0,once:!1})},hE=t=>{t.contentElement=document.createElement("div"),t.contentElement.className="protyle-content",t.options.render.background&&t.contentElement.appendChild(t.background.element),t.options.render.title&&t.contentElement.appendChild(t.title.element),t.contentElement.appendChild(t.wysiwyg.element),t.options.action.includes(p.Constants.CB_GET_HISTORY)||gE(t,t.contentElement),t.element.append(t.contentElement),t.element.appendChild(t.preview.element),t.upload&&t.element.appendChild(t.upload.element),t.options.render.scroll&&t.element.appendChild(t.scroll.element.parentElement),t.gutter&&t.element.appendChild(t.gutter.element),t.element.appendChild(t.hint.element),t.selectElement=document.createElement("div"),t.selectElement.className="protyle-select fn__none",t.element.appendChild(t.selectElement),t.element.appendChild(t.toolbar.element),t.element.appendChild(t.toolbar.subElement),$i(t),Di(t,t.options.mode),document.execCommand("DefaultParagraphSeparator",!1,"p");let e;const n=$e();t.contentElement.addEventListener("mousewheel",a=>{if(!(!window.siyuan.config.editor.fontSizeScrollZoom||n&&!a.metaKey||!n&&!a.ctrlKey||a.deltaX!==0)){if(a.preventDefault(),a.stopPropagation(),a.deltaY<0)if(window.siyuan.config.editor.fontSize<72)window.siyuan.config.editor.fontSize++;else return;else if(a.deltaY>0)if(window.siyuan.config.editor.fontSize>9)window.siyuan.config.editor.fontSize--;else return;ko(),clearTimeout(e),e=window.setTimeout(()=>{w("/api/setting/setEditor",window.siyuan.config.editor),window.siyuan.config.editor.codeSyntaxHighlightLineNum&&t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber").forEach(i=>{So(i)})},p.Constants.TIMEOUT_LOAD)}},{passive:!1})},$i=(t,e)=>{t.element.removeAttribute("data-loading"),setTimeout(()=>{t.element.getAttribute("data-loading")!=="finished"&&t.element.insertAdjacentHTML("beforeend",`<div style="background-color: var(--b3-theme-background);flex-direction: column;" class="fn__loading wysiwygLoading">
    <img width="48px" src="/stage/loading-pure.svg">
    <div style="color: var(--b3-theme-on-surface);margin-top: 8px;">${e||""}</div>
</div>`)},p.Constants.TIMEOUT_LOAD)},$r=t=>{t.element.setAttribute("data-loading","finished"),t.element.querySelectorAll(".wysiwygLoading").forEach(e=>{e.remove()})},Gm=t=>{if(t.options.action.includes(p.Constants.CB_GET_HISTORY))return{width:0,padding:0};const e=parseInt(t.wysiwyg.element.style.paddingLeft);let n=16,a=24;if(!(0,I.tq)()){let l=t.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_FULLWIDTH);l||(l=window.siyuan.config.editor.fullWidth?"true":"false");let r=(t.element.clientWidth-p.Constants.SIZE_EDITOR_WIDTH)/2;l==="false"&&r>96?(r>p.Constants.SIZE_EDITOR_WIDTH&&(r=t.element.clientWidth*.382/1.382),r=Math.ceil(r),n=r,a=r):t.element.clientWidth>p.Constants.SIZE_EDITOR_WIDTH&&(n=96,a=96)}let i="16px";if(t.options.typewriterMode&&((0,I.tq)()?i=window.innerHeight/5+"px":i=t.element.clientHeight/2+"px"),t.options.backlinkData?t.wysiwyg.element.style.padding=`4px ${n}px 4px ${a}px`:t.wysiwyg.element.style.padding=`16px ${n}px ${i} ${a}px`,t.options.render.background&&(t.background.element.lastElementChild.setAttribute("style",`left:${n}px`),t.background.element.querySelector(".protyle-background__img .protyle-icons").setAttribute("style",`right:${n}px`)),t.options.render.title&&(t.title.element.style.margin=`16px ${n}px 0 ${a}px`),window.siyuan.config.editor.displayBookmarkIcon){const l=document.getElementById("editorAttr");l&&(l.innerHTML=`.protyle-wysiwyg--attr .b3-tooltips:after { max-width: ${t.wysiwyg.element.clientWidth-n-a}px; }`)}const s=t.wysiwyg.element.getAttribute("data-realwidth"),o=t.wysiwyg.element.clientWidth-parseInt(t.wysiwyg.element.style.paddingLeft)-parseInt(t.wysiwyg.element.style.paddingRight);return t.wysiwyg.element.setAttribute("data-realwidth",o.toString()),{width:Math.abs(parseInt(s)-o),padding:Math.abs(e-parseInt(t.wysiwyg.element.style.paddingLeft))}},qt=t=>{X(["gutter"],t);const e=Gm(t),n=4;setTimeout(()=>{if(!t.disabled){const a=t.contentElement.getBoundingClientRect();t.wysiwyg.element.querySelectorAll(".av").forEach(i=>{i.querySelector(".av__title")&&Ua(i,a,"all")})}if((e.width>n||isNaN(e.width))&&(typeof window.echarts<"u"&&t.wysiwyg.element.querySelectorAll('[data-subtype="echarts"], [data-subtype="mindmap"]').forEach(a=>{const i=window.echarts.getInstanceById(a.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));i&&i.resize()}),window.siyuan.config.editor.codeSyntaxHighlightLineNum&&t.wysiwyg.element.querySelectorAll(".code-block .protyle-linenumber").forEach(a=>{So(a)}),!t.disabled&&t.toolbar.range)){let a=t.toolbar.range.getBoundingClientRect();if(a.height===0){const s=x(t.toolbar.range.startContainer);s&&(a=s.getBoundingClientRect())}if(a.height===0)return;const i=t.element.getBoundingClientRect();(i.top+30>a.top||i.bottom<a.bottom)&&t.toolbar.range.startContainer.parentElement.scrollIntoView(i.top>a.top)}},p.Constants.TIMEOUT_TRANSITION)};class Ro{constructor(e){this.defIds=[],this.editors=[],this.id=Se(),this.targetElement=e.targetElement,this.nodeIds=e.nodeIds,this.defIds=e.defIds||[],this.app=e.app,this.x=e.x,this.y=e.y,this.isBacklink=e.isBacklink,this.element=document.createElement("div"),this.element.classList.add("block__popover");const n=A(this.targetElement,"block__popover",!0);let a=1;n?(this.element.setAttribute("data-oid",n.getAttribute("data-oid")),a=parseInt(n.getAttribute("data-level"))+1):this.element.setAttribute("data-oid",this.nodeIds[0]),this.element.setAttribute("data-level",a.toString());for(let i=0;i<window.siyuan.blockPanels.length;i++){const s=window.siyuan.blockPanels[i];s.element.getAttribute("data-pin")==="false"&&s.targetElement&&parseInt(s.element.getAttribute("data-level"))>=a&&(s.destroy(),i--)}document.body.insertAdjacentElement("beforeend",this.element),this.targetElement&&(this.targetElement.style.cursor="wait"),this.element.setAttribute("data-pin","false"),this.element.addEventListener("dblclick",i=>{const s=i.target,o=A(s,"block__icons");if(o){const l=o.querySelector('[data-type="pin"]');this.element.getAttribute("data-pin")==="true"?(l.setAttribute("aria-label",window.siyuan.languages.pin),l.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(l.setAttribute("aria-label",window.siyuan.languages.unpin),l.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")),i.preventDefault(),i.stopPropagation()}}),this.element.addEventListener("click",i=>{this.element&&window.siyuan.blockPanels.length>1&&(this.element.style.zIndex=(++window.siyuan.zIndex).toString());let s=i.target;for(;s&&!s.isEqualNode(this.element);){if(s.classList.contains("block__icon")||s.classList.contains("block__logo")){const o=s.getAttribute("data-type");o==="close"?this.destroy():o==="pin"?this.element.getAttribute("data-pin")==="true"?(s.setAttribute("aria-label",window.siyuan.languages.pin),s.querySelector("use").setAttribute("xlink:href","#iconPin"),this.element.setAttribute("data-pin","false")):(s.setAttribute("aria-label",window.siyuan.languages.unpin),s.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")):o==="open"&&to(this.nodeIds[0]),i.preventDefault(),i.stopPropagation();break}s=s.parentElement}}),Tu(this.element,i=>{i!=="move"&&this.editors.forEach(o=>{qt(o.protyle)});const s=this.element.firstElementChild.querySelector('[data-type="pin"]');s.setAttribute("aria-label",window.siyuan.languages.unpin),s.querySelector("use").setAttribute("xlink:href","#iconUnpin"),this.element.setAttribute("data-pin","true")}),this.render()}initProtyle(e,n){const a=parseInt(e.getAttribute("data-index"));w("/api/block/getBlockInfo",{id:this.nodeIds[a]},i=>{if(i.code===3){M(i.msg);return}if(!this.targetElement&&typeof this.x>"u"&&typeof this.y>"u")return;const s=[];i.data.rootID!==this.nodeIds[a]?s.push(p.Constants.CB_GET_ALL):(s.push(p.Constants.CB_GET_CONTEXT),s.push(p.Constants.CB_GET_HL)),this.isBacklink&&s.push(p.Constants.CB_GET_BACKLINK);const o=new pn(this.app,e,{blockId:this.nodeIds[a],defId:this.defIds[a]||this.defIds[0]||"",action:s,render:{scroll:!0,gutter:!0,breadcrumbDocName:!0},typewriterMode:!1,after:l=>{e.addEventListener("mouseleave",()=>{X(["gutter"],l.protyle)}),i.data.rootID!==this.nodeIds[a]&&l.protyle.breadcrumb.element.parentElement.lastElementChild.classList.remove("fn__none"),n&&n(),(l.protyle.element.nextElementSibling||l.protyle.element.previousElementSibling)&&(l.protyle.element.style.minHeight=Math.min(30+l.protyle.wysiwyg.element.clientHeight,window.innerHeight/3)+"px"),l.protyle.scroll.element.parentElement.setAttribute("style",`--b3-dynamicscroll-width:${Math.min(l.protyle.contentElement.clientHeight-49,200)}px;${(0,I.tq)()?"":"right:10px"}`)}});this.editors.push(o)})}destroy(){window.siyuan.blockPanels.find((e,n)=>{if(e.id===this.id)return window.siyuan.blockPanels.splice(n,1),!0}),this.editors.length>0&&(this.editors.forEach(e=>{X(["util"],e.protyle),e.destroy()}),this.editors=[]),this.element.remove(),this.element=void 0,this.targetElement=void 0,window.siyuan.menus.menu.element.dataset.from!=="app"&&window.siyuan.menus.menu.remove()}render(){if(!document.body.contains(this.element)){this.destroy();return}let e="";this.nodeIds.length===1&&(e=`<span data-type="open" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.openByNewWindow}"><svg><use xlink:href="#iconOpenWindow"></use></svg></span>
<span class="fn__space"></span>`);let n=`<div class="block__icons block__icons--menu">
    <span class="fn__space fn__flex-1 resize__move"></span>${e}
    <span data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.pin}"><svg><use xlink:href="#iconPin"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></span>
</div>
<div class="block__content">`;this.nodeIds.length===0?n+=`<div class="ft__smaller ft__smaller ft__secondary b3-form__space--small" contenteditable="false">${window.siyuan.languages.refExpired}</div>`:this.nodeIds.forEach((i,s)=>{n+=`<div class="block__edit fn__flex-1 protyle" data-index="${s}"></div>`}),n&&(n+='</div><div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>'),this.element.innerHTML=n;const a=new IntersectionObserver(i=>{i.forEach(s=>{s.isIntersecting&&s.target.innerHTML===""&&this.initProtyle(s.target)})},{threshold:0});this.element.querySelectorAll(".block__edit").forEach((i,s)=>{s<5?this.initProtyle(i,s===0?()=>{let o;if(this.targetElement&&this.targetElement.classList.contains("protyle-wysiwyg__embed")){o=this.targetElement.getBoundingClientRect();let r=o.top;const c=A(this.targetElement,"protyle-content",!0);if(c){const d=c.getBoundingClientRect().top;o.top<d&&(r=d)}this.element.style.height=Math.min(window.innerHeight-p.Constants.SIZE_TOOLBAR_HEIGHT,o.height+42)+"px",ke(this.element,o.left,Math.max(r-42,p.Constants.SIZE_TOOLBAR_HEIGHT),-42,0)}else this.targetElement?(this.targetElement.classList.contains("pdf__rect")?o=this.targetElement.firstElementChild.getBoundingClientRect():o=this.targetElement.getBoundingClientRect(),window.innerHeight-o.bottom-4>o.top+12&&(this.element.style.maxHeight=Math.floor(window.innerHeight-o.bottom-12)+"px"),ke(this.element,o.left,o.bottom+4,o.height+12,8)):typeof this.x=="number"&&typeof this.y=="number"&&(ke(this.element,this.x,this.y),this.element.style.maxHeight=Math.floor(window.innerHeight-Math.max(this.y,p.Constants.SIZE_TOOLBAR_HEIGHT)-12)+"px");const l=this.element.getBoundingClientRect();this.targetElement&&!this.targetElement.classList.contains("protyle-wysiwyg__embed")&&(l.top<o.top?this.element.style.maxHeight=Math.floor(o.top-l.top-8)+"px":this.element.style.maxHeight=Math.floor(window.innerHeight-l.top-8)+"px"),this.element.classList.add("block__popover--open"),this.element.style.zIndex=(++window.siyuan.zIndex).toString()}:void 0):a.observe(i)}),this.targetElement&&(this.targetElement.style.cursor="")}}class oa extends ct{constructor(e){super({app:e.app,id:e.tab.id,callback(){this.type==="local"&&w("/api/block/checkBlockExist",{id:this.blockId},a=>{a.data||this.parent.parent.removeTab(this.parent.id)})},msgCallback(a){if(a)switch(a.cmd){case"mount":this.type==="global"&&a.code!==1&&this.searchGraph(!1);break;case"rename":this.graphData&&a.data.box===this.graphData.box&&this.rootId===a.data.id&&(this.searchGraph(!1),this.type==="local"&&this.parent.updateTitle(a.data.title)),this.type==="global"&&this.searchGraph(!1);break;case"unmount":this.type==="local"&&this.graphData&&this.graphData.box===a.data.box&&this.parent.parent.removeTab(this.parent.id);break;case"removeDoc":this.type==="local"&&a.data.ids.includes(this.rootId)&&this.parent.parent.removeTab(this.parent.id);break}}}),this.element=e.tab.panelElement,this.blockId=e.blockId,this.rootId=e.rootId,this.type=e.type,this.element.classList.add("graph","file-tree",this.type==="global"?"sy__globalGraph":"sy__graph");let n;this.type==="global"?n=`
<label>
    <span>${window.siyuan.languages.headings}</span> 
    <input data-type="heading" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.heading?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.list1}</span> 
    <input data-type="list" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.list?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.listItem}</span> 
    <input data-type="listItem" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.listItem?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.quote}</span> 
    <input data-type="blockquote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.blockquote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.superBlock}</span> 
    <input data-type="super" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.super?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.table}</span> 
    <input data-type="table" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.table?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.math}</span> 
    <input data-type="math" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.math?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.code}</span> 
    <input data-type="code" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.code?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.paragraph}</span> 
    <input data-type="paragraph" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.paragraph?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.dailyNote}</span>  
    <input data-type="dailyNote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.dailyNote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.tag}</span>  
    <input data-type="tag" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.type.tag?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.arrow}</span> 
    <input data-type="arrow" type="checkbox" class="b3-switch"${window.siyuan.config.graph.global.d3.arrow?" checked":""}/>
</label>
<label> 
    <span>${window.siyuan.languages.graphConfig2}</span>  
    <input data-type="minRefs" class="b3-slider b3-tooltips__n b3-tooltips" max="16" min="0" step="1" type="range" value="${window.siyuan.config.graph.global.minRefs}" aria-label="${window.siyuan.config.graph.global.minRefs}" />
</label>
<label>
    <span>${window.siyuan.languages.nodeSize}</span> 
    <input data-type="nodeSize" class="b3-slider b3-tooltips__n b3-tooltips" aria-label="${window.siyuan.config.graph.global.d3.nodeSize}" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.global.d3.nodeSize}" />
</label>
<label>
    <span>${window.siyuan.languages.lineWidth}</span> 
    <input data-type="linkWidth" class="b3-tooltips b3-tooltips__n b3-slider" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.global.d3.linkWidth}" aria-label="${window.siyuan.config.graph.global.d3.linkWidth}"/>
</label>
<label>
    <span>${window.siyuan.languages.lineOpacity}</span> 
    <input data-type="lineOpacity" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.1" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.lineOpacity}" aria-label="${window.siyuan.config.graph.global.d3.lineOpacity}"/>
</label>
<label>
    <span>${window.siyuan.languages.centerStrength}</span> 
    <input data-type="centerStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="0.1" min="0.005" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.centerStrength}" aria-label="${window.siyuan.config.graph.global.d3.centerStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideRadius}</span> 
    <input data-type="collideRadius" class="b3-tooltips b3-tooltips__n b3-slider" max="5000" min="400" step="200" type="range" value="${window.siyuan.config.graph.global.d3.collideRadius}" aria-label="${window.siyuan.config.graph.global.d3.collideRadius}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideStrength}</span> 
    <input data-type="collideStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.01" step="0.01" type="range" value="${window.siyuan.config.graph.global.d3.collideStrength}" aria-label="${window.siyuan.config.graph.global.d3.collideStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.linkDistance}</span> 
    <input data-type="linkDistance" class="b3-tooltips b3-tooltips__n b3-slider" max="2000" min="100" step="100" type="range" value="${window.siyuan.config.graph.global.d3.linkDistance}" aria-label="${window.siyuan.config.graph.global.d3.linkDistance}"/>
</label>
<div class="fn__hr"></div>
<button class="b3-button b3-button--small fn__block">${window.siyuan.languages.reset}</button>`:n=`
<label>
    <span>${window.siyuan.languages.headings}</span> 
    <input data-type="heading" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.heading?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.list1}</span> 
    <input data-type="list" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.list?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.listItem}</span> 
    <input data-type="listItem" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.listItem?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.quote}</span> 
    <input data-type="blockquote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.blockquote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.superBlock}</span> 
    <input data-type="super" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.super?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.table}</span> 
    <input data-type="table" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.table?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.math}</span> 
    <input data-type="math" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.math?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.code}</span> 
    <input data-type="code" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.code?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.paragraph}</span> 
    <input data-type="paragraph" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.paragraph?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.dailyNote}</span>  
    <input data-type="dailyNote" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.dailyNote?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.tag}</span>  
    <input data-type="tag" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.type.tag?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.arrow}</span> 
    <input data-type="arrow" type="checkbox" class="b3-switch"${window.siyuan.config.graph.local.d3.arrow?" checked":""}/>
</label>
<label>
    <span>${window.siyuan.languages.nodeSize}</span> 
    <input data-type="nodeSize" class="b3-slider b3-tooltips__n b3-tooltips" aria-label="${window.siyuan.config.graph.local.d3.nodeSize}" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.local.d3.nodeSize}" />
</label>
<label>
    <span>${window.siyuan.languages.lineWidth}</span> 
    <input data-type="linkWidth" class="b3-tooltips b3-tooltips__n b3-slider" max="32" min="4" step="2" type="range" value="${window.siyuan.config.graph.local.d3.linkWidth}" aria-label="${window.siyuan.config.graph.local.d3.linkWidth}"/>
</label>
<label>
    <span>${window.siyuan.languages.lineOpacity}</span> 
    <input data-type="lineOpacity" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.1" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.lineOpacity}" aria-label="${window.siyuan.config.graph.local.d3.lineOpacity}"/>
</label>
<label>
    <span>${window.siyuan.languages.centerStrength}</span> 
    <input data-type="centerStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="0.1" min="0.005" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.centerStrength}" aria-label="${window.siyuan.config.graph.local.d3.centerStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideRadius}</span> 
    <input data-type="collideRadius" class="b3-tooltips b3-tooltips__n b3-slider" max="5000" min="400" step="200" type="range" value="${window.siyuan.config.graph.local.d3.collideRadius}" aria-label="${window.siyuan.config.graph.local.d3.collideRadius}"/>
</label>
<label>
    <span>${window.siyuan.languages.collideStrength}</span> 
    <input data-type="collideStrength" class="b3-tooltips b3-tooltips__n b3-slider" max="1" min="0.01" step="0.01" type="range" value="${window.siyuan.config.graph.local.d3.collideStrength}" aria-label="${window.siyuan.config.graph.local.d3.collideStrength}"/>
</label>
<label>
    <span>${window.siyuan.languages.linkDistance}</span> 
    <input data-type="linkDistance" class="b3-tooltips b3-tooltips__n b3-slider" max="2000" min="100" step="100" type="range" value="${window.siyuan.config.graph.local.d3.linkDistance}" aria-label="${window.siyuan.config.graph.local.d3.linkDistance}"/>
</label>
<div class="fn__hr"></div>
<button class="b3-button b3-button--small fn__block">${window.siyuan.languages.reset}</button>`,this.element.innerHTML=`
<div class="block__icons"> 
    <div class="block__logo">
        <svg><use xlink:href="#icon${this.type==="global"?"GlobalGraph":"Graph"}"></use></svg>
        ${this.type==="global"?window.siyuan.languages.globalGraph:window.siyuan.languages.graphView}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <input class="b3-text-field search__label fn__size200 fn__none" placeholder="${window.siyuan.languages.search}" />
    <span data-type="search" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.search}"><svg><use xlink:href='#iconFilter'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <div class="fn__space"></div>
    <div data-type="fullscreen" class="b3-tooltips b3-tooltips__sw block__icon" aria-label="${window.siyuan.languages.fullscreen}">
        <svg><use xlink:href="#iconFullscreen"></use></svg>
    </div>
    <div class="fn__space"></div>
    <div data-type="menu" class="b3-tooltips b3-tooltips__sw block__icon" aria-label="${window.siyuan.languages.more}">
        <svg><use xlink:href="#iconMore"></use></svg>
    </div> 
    <span class="${this.type==="local"?"fn__none ":""}fn__space"></span>
    <span data-type="min"  class="${this.type==="local"?"fn__none ":""}block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${K(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="graph__panel">
    ${n}
</div>
<div class="fn__flex-1 graph__svg"><div class="graph__loading"><div></div></div><div style="height: 100%"></div></div>`,this.graphElement=this.element.querySelector(".graph__svg"),this.inputElement=this.element.querySelector("input"),this.panelElement=this.element.querySelector(".graph__panel"),this.element.addEventListener("click",a=>{this.type==="local"?Ze(this.element.parentElement.parentElement):Ze(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("b3-button")){this.type==="global"?w("/api/graph/resetGraph",{},s=>{this.reset(s.data.conf)}):w("/api/graph/resetLocalGraph",{},s=>{this.reset(s.data.conf)});break}else if(i.classList.contains("block__icon")){const s=i.getAttribute("data-type");s==="min"?St(this.type==="global"?"globalGraph":"graph").toggleModel(this.type==="global"?"globalGraph":"graph"):s==="menu"?i.classList.contains("ft__primary")?(i.classList.remove("ft__primary"),this.panelElement.style.right=""):(i.classList.add("ft__primary"),this.panelElement.style.right="0"):s==="search"?(i.previousElementSibling.classList.remove("fn__none"),i.previousElementSibling.select()):s==="refresh"?this.searchGraph(!1):s==="fullscreen"&&_o(this.element,i);break}else if(i.classList.contains("graph__svg")){this.element.querySelectorAll(".block__icon.ft__primary").forEach(s=>{s.classList.remove("ft__primary")}),this.panelElement.style.right="";break}i=i.parentElement}}),this.inputElement.addEventListener("compositionend",()=>{this.searchGraph(!1),this.inputElement.classList.add("search__input--block")}),this.inputElement.addEventListener("blur",a=>{a.target.classList.add("fn__none")}),this.inputElement.addEventListener("input",a=>{a.isComposing||(this.inputElement.value===""?this.inputElement.classList.remove("search__input--block"):this.inputElement.classList.add("search__input--block"),this.searchGraph(!1))}),this.element.querySelectorAll(".b3-slider").forEach(a=>{a.addEventListener("input",()=>{a.setAttribute("aria-label",a.value),this.searchGraph(!1)})}),this.element.querySelectorAll(".b3-switch").forEach(a=>{a.addEventListener("change",()=>{this.searchGraph(!1)})}),this.searchGraph(e.type!=="global")}reset(e){this.type==="global"?(window.siyuan.config.graph.global=e,this.panelElement.querySelector("[data-type='minRefs']").setAttribute("aria-label",window.siyuan.config.graph.global.minRefs.toString()),this.panelElement.querySelector("[data-type='minRefs']").value=window.siyuan.config.graph.global.minRefs.toString()):window.siyuan.config.graph.local=e,this.inputElement.value="",this.panelElement.querySelector("[data-type='nodeSize']").setAttribute("aria-label",e.d3.nodeSize.toString()),this.panelElement.querySelector("[data-type='centerStrength']").setAttribute("aria-label",e.d3.centerStrength.toString()),this.panelElement.querySelector("[data-type='collideRadius']").setAttribute("aria-label",e.d3.collideRadius.toString()),this.panelElement.querySelector("[data-type='collideStrength']").setAttribute("aria-label",e.d3.collideStrength.toString()),this.panelElement.querySelector("[data-type='lineOpacity']").setAttribute("aria-label",e.d3.lineOpacity.toString()),this.panelElement.querySelector("[data-type='linkDistance']").setAttribute("aria-label",e.d3.linkDistance.toString()),this.panelElement.querySelector("[data-type='linkWidth']").setAttribute("aria-label",e.d3.linkWidth.toString()),this.panelElement.querySelector("[data-type='nodeSize']").value=e.d3.nodeSize.toString(),this.panelElement.querySelector("[data-type='centerStrength']").value=e.d3.centerStrength.toString(),this.panelElement.querySelector("[data-type='collideRadius']").value=e.d3.collideRadius.toString(),this.panelElement.querySelector("[data-type='collideStrength']").value=e.d3.collideStrength.toString(),this.panelElement.querySelector("[data-type='lineOpacity']").value=e.d3.lineOpacity.toString(),this.panelElement.querySelector("[data-type='linkDistance']").value=e.d3.linkDistance.toString(),this.panelElement.querySelector("[data-type='linkWidth']").value=e.d3.linkWidth.toString(),this.panelElement.querySelector("[data-type='list']").checked=e.type.list,this.panelElement.querySelector("[data-type='listItem']").checked=e.type.listItem,this.panelElement.querySelector("[data-type='math']").checked=e.type.math,this.panelElement.querySelector("[data-type='paragraph']").checked=e.type.paragraph,this.panelElement.querySelector("[data-type='super']").checked=e.type.super,this.panelElement.querySelector("[data-type='table']").checked=e.type.table,this.panelElement.querySelector("[data-type='tag']").checked=e.type.tag,this.panelElement.querySelector("[data-type='dailyNote']").checked=e.dailyNote,this.panelElement.querySelector("[data-type='heading']").checked=e.type.heading,this.panelElement.querySelector("[data-type='arrow']").checked=e.d3.arrow,this.panelElement.querySelector("[data-type='blockquote']").checked=e.type.blockquote,this.panelElement.querySelector("[data-type='code']").checked=e.type.code,this.searchGraph(!1)}searchGraph(e,n){const a=this.element.querySelector('.block__icon[data-type="refresh"] svg');if(a.classList.contains("fn__rotate")&&!n)return;a.classList.add("fn__rotate");const i={list:this.panelElement.querySelector("[data-type='list']").checked,listItem:this.panelElement.querySelector("[data-type='listItem']").checked,math:this.panelElement.querySelector("[data-type='math']").checked,paragraph:this.panelElement.querySelector("[data-type='paragraph']").checked,super:this.panelElement.querySelector("[data-type='super']").checked,table:this.panelElement.querySelector("[data-type='table']").checked,tag:this.panelElement.querySelector("[data-type='tag']").checked,heading:this.panelElement.querySelector("[data-type='heading']").checked,blockquote:this.panelElement.querySelector("[data-type='blockquote']").checked,code:this.panelElement.querySelector("[data-type='code']").checked},s={arrow:this.panelElement.querySelector("[data-type='arrow']").checked,nodeSize:parseFloat(this.panelElement.querySelector("[data-type='nodeSize']").value),centerStrength:parseFloat(this.panelElement.querySelector("[data-type='centerStrength']").value),collideRadius:parseFloat(this.panelElement.querySelector("[data-type='collideRadius']").value),collideStrength:parseFloat(this.panelElement.querySelector("[data-type='collideStrength']").value),lineOpacity:parseFloat(this.panelElement.querySelector("[data-type='lineOpacity']").value),linkDistance:parseFloat(this.panelElement.querySelector("[data-type='linkDistance']").value),linkWidth:parseFloat(this.panelElement.querySelector("[data-type='linkWidth']").value)};this.type==="global"?w("/api/graph/getGraph",{k:this.inputElement.value,conf:{type:i,d3:s,dailyNote:this.panelElement.querySelector("[data-type='dailyNote']").checked,minRefs:parseFloat(this.panelElement.querySelector("[data-type='minRefs']").value)}},o=>{this.graphData=o.data,window.siyuan.config.graph.global=o.data.conf,this.onGraph(!1),a.classList.remove("fn__rotate")}):w("/api/graph/getLocalGraph",{type:this.type,k:this.inputElement.value,id:n||this.blockId,conf:{type:i,d3:s,dailyNote:this.panelElement.querySelector("[data-type='dailyNote']").checked}},o=>{a.classList.remove("fn__rotate"),n&&(this.blockId=n),!(!Lu(this.blockId)&&this.graphElement.firstElementChild.classList.contains("fn__none"))&&(this.graphData=o.data,window.siyuan.config.graph.local=o.data.conf,this.onGraph(e))})}hlNode(e){this.graphElement.clientHeight===0||!this.network||this.network.findNode(e).length===0||(this.network.focus(e,{animation:{duration:1e3,easingFunction:"easeInOutQuad"}}),this.network.selectNodes([e]))}onGraph(e){if(this.graphElement.clientHeight===0)return;if(!this.graphData||!this.graphData.nodes||this.graphData.nodes.length===0){this.network&&this.network.destroy(),this.graphElement.firstElementChild.classList.add("fn__none");return}const n=getComputedStyle(document.body);this.graphData.nodes.forEach(a=>{switch(a.type){case"NodeDocument":a.color={background:n.getPropertyValue("--b3-graph-doc-point").trim()};break;case"NodeParagraph":a.color={background:n.getPropertyValue("--b3-graph-p-point").trim()};break;case"NodeHeading":a.color={background:n.getPropertyValue("--b3-graph-heading-point").trim()};break;case"NodeMathBlock":a.color={background:n.getPropertyValue("--b3-graph-math-point").trim()};break;case"NodeCodeBlock":a.color={background:n.getPropertyValue("--b3-graph-code-point").trim()};break;case"NodeTable":a.color={background:n.getPropertyValue("--b3-graph-table-point").trim()};break;case"NodeList":a.color={background:n.getPropertyValue("--b3-graph-list-point").trim()};break;case"NodeListItem":a.color={background:n.getPropertyValue("--b3-graph-listitem-point").trim()};break;case"NodeBlockquote":a.color={background:n.getPropertyValue("--b3-graph-bq-point").trim()};break;case"NodeSuperBlock":a.color={background:n.getPropertyValue("--b3-graph-super-point").trim()};break;default:a.color={background:n.getPropertyValue("--b3-graph-p-point").trim()};break}}),this.graphData.links.forEach(a=>{a.ref?a.color={color:n.getPropertyValue("--b3-graph-ref-line").trim()}:a.color={color:n.getPropertyValue("--b3-graph-line").trim()}}),clearTimeout(this.timeout),(0,ze.addScript)(`${p.Constants.PROTYLE_CDN}/js/vis/vis-network.min.js?v=9.1.2`,"protyleVisScript").then(()=>{this.timeout=window.setTimeout(()=>{this.graphElement.firstElementChild.classList.remove("fn__none"),this.graphElement.firstElementChild.firstElementChild.setAttribute("style","width:3%");const a=window.siyuan.config.graph[this.type==="global"?"global":"local"],i={nodes:this.graphData.nodes,edges:this.graphData.links},s={autoResize:!0,interaction:{hover:!0},nodes:{borderWidth:0,borderWidthSelected:5,shape:"dot",font:{face:n.getPropertyValue("--b3-font-family-graph").trim(),size:32,color:n.getPropertyValue("--b3-theme-on-background").trim()},color:{hover:{border:n.getPropertyValue("--b3-graph-hl-point").trim(),background:n.getPropertyValue("--b3-graph-hl-point").trim()},highlight:{border:n.getPropertyValue("--b3-graph-hl-point").trim(),background:n.getPropertyValue("--b3-graph-hl-point").trim()}}},edges:{width:a.d3.linkWidth,arrowStrikethrough:!1,smooth:!1,color:{opacity:a.d3.lineOpacity,hover:n.getPropertyValue("--b3-graph-hl-line").trim(),highlight:n.getPropertyValue("--b3-graph-hl-line").trim()}},layout:{improvedLayout:!1},physics:{enabled:!0,forceAtlas2Based:{theta:.5,gravitationalConstant:-a.d3.collideRadius,centralGravity:a.d3.centerStrength,springConstant:a.d3.collideStrength,springLength:a.d3.linkDistance,damping:.4,avoidOverlap:.5},maxVelocity:50,minVelocity:.1,solver:"forceAtlas2Based",stabilization:{enabled:!0,iterations:256,updateInterval:25,onlyDynamicEdges:!1,fit:!0},timestep:.5,adaptiveTimestep:!0,wind:{x:0,y:0}}},o=new vis.Network(this.graphElement.lastElementChild,i,s);this.network=o,o.on("stabilizationIterationsDone",()=>{o.physics.stopSimulation(),this.graphElement.firstElementChild.classList.add("fn__none"),e&&this.hlNode(this.blockId)}),o.on("dragEnd",()=>{setTimeout(()=>{o.physics.stopSimulation()},5e3)}),o.on("stabilizationProgress",l=>{this.graphElement.firstElementChild.firstElementChild.setAttribute("style",`width:${Math.max(5,l.iterations)/l.total*100}%`)}),o.on("click",l=>{if(l.nodes.length!==1)return;const r=this.graphData.nodes.find(c=>c.id===l.nodes[0]);if(r){if(r.type==="textmark tag"){Fn(this.app,`#${r.id}#`,!window.siyuan.ctrlIsPressed);return}window.siyuan.shiftIsPressed?ot(r.id,(c,d)=>{de({app:this.app,id:r.id,position:"bottom",action:d,zoomIn:c})}):window.siyuan.altIsPressed?ot(r.id,(c,d)=>{de({app:this.app,id:r.id,position:"right",action:d,zoomIn:c})}):window.siyuan.ctrlIsPressed?window.siyuan.blockPanels.push(new Ro({app:this.app,isBacklink:!1,x:l.event.center.x,y:l.event.center.y,nodeIds:[r.id]})):ot(r.id,(c,d)=>{de({app:this.app,id:r.id,action:d,zoomIn:c})})}})},1e3)})}}const jm=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="bookmarkMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove();const a=t.getAttribute("data-node-id");!a&&!window.siyuan.config.readonly&&window.siyuan.menus.menu.append(new S({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{const i=t.querySelector(".b3-list-item__text").textContent,s=new me({title:window.siyuan.languages.rename,content:`<div class="b3-dialog__content"><input class="b3-text-field fn__block"></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()});const l=s.element.querySelector("input");s.bindInput(l,()=>{o[1].click()}),l.value=i,l.focus(),l.select(),o[1].addEventListener("click",()=>{w("/api/bookmark/renameBookmark",{oldBookmark:i,newBookmark:l.value},()=>{s.destroy()})})}}).element),a&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy,type:"submenu",icon:"iconCopy",submenu:Li(t.getAttribute("data-node-id"),!1)}).element),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{const i=t.querySelector(".b3-list-item__text").textContent;Ne(window.siyuan.languages.deleteOpConfirm,window.siyuan.languages.removeBookmark.replace("${x}",`<b>${we(i)}</b>`),()=>{a?(w("/api/attr/setBlockAttrs",{id:a,attrs:{bookmark:""}},()=>{n.update()}),document.querySelectorAll(`.protyle-wysiwyg [data-node-id="${a}"]`).forEach(s=>{s.setAttribute("bookmark","");const o=s.querySelector(".protyle-attr--bookmark");o&&o.remove()})):w("/api/bookmark/removeBookmark",{bookmark:i})})}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","bookmarkMenu"),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class Pi extends ct{constructor(e,n){super({app:e,id:n.id,msgCallback(a){if(a)switch(a.cmd){case"transactions":a.data[0].doOperations.forEach(i=>{let s=!1;((i.action==="update"||i.action==="insert")&&i.data.indexOf('class="protyle-attr--bookmark"')>-1||i.action==="delete")&&(s=!0),s&&w("/api/bookmark/getBookmark",{},o=>{this.update(o.data)})});break;case"unmount":case"removeDoc":case"mount":(a.cmd!=="mount"||a.code!==1)&&w("/api/bookmark/getBookmark",{},i=>{this.update(i.data)});break}}}),this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__bookmark"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconBookmark"></use></svg>
        ${window.siyuan.languages.bookmark}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand} ${K(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${K(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${K(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.tree=new oo({element:this.element.lastElementChild,data:null,click:(a,i)=>{if(i){const o=A(i.target,"b3-list-item__action");if(o){jm(o.parentElement,i,this);return}}const s=a.getAttribute("data-node-id");ot(s,(o,l)=>{de({app:e,id:s,action:l,zoomIn:o})})},rightClick:(a,i)=>{jm(a,i,this)},ctrlClick:a=>{const i=a.getAttribute("data-node-id");ot(i,s=>{de({app:e,id:i,keepCursor:!0,action:s?[p.Constants.CB_GET_HL,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:s})})},altClick:a=>{const i=a.getAttribute("data-node-id");ot(i,(s,o)=>{de({app:e,id:i,position:"bottom",action:o,zoomIn:s})})},shiftClick:a=>{const i=a.getAttribute("data-node-id");ot(i,(s,o)=>{de({app:e,id:i,position:"bottom",action:o,zoomIn:s})})},blockExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll()}),this.element.addEventListener("click",a=>{Ze(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon"))switch(i.getAttribute("data-type")){case"min":St("bookmark").toggleModel("bookmark");break;case"refresh":this.update();break}i=i.parentElement}}),this.update()}update(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');e.classList.contains("fn__rotate")||(e.classList.add("fn__rotate"),w("/api/bookmark/getBookmark",{},n=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(n.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),e.classList.remove("fn__rotate")}))}}const Km=(t,e,n)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="tagMenu"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new S({icon:"iconEdit",label:window.siyuan.languages.rename,click:()=>{sp(n)}}).element),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:window.siyuan.languages.remove,click:()=>{Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} <b>${we(n)}</b>?`,()=>{w("/api/tag/removeTag",{label:n})})}}).element),window.siyuan.menus.menu.element.setAttribute("data-name","tagMenu"),window.siyuan.menus.menu.popup({x:e.clientX-11,y:e.clientY+11,h:22,w:12})};class Mi extends ct{constructor(e,n){super({app:e,id:n.id,msgCallback(a){if(a)switch(a.cmd){case"transactions":a.data[0].doOperations.forEach(i=>{let s=!1;((i.action==="update"||i.action==="insert")&&i.data.indexOf('data-type="tag"')>-1||i.action==="delete")&&(s=!0),s&&this.update()});break;case"unmount":case"removeDoc":case"mount":(a.cmd!=="mount"||a.code!==1)&&this.update();break}}}),this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__tag"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconTags"></use></svg>
        ${window.siyuan.languages.tag}
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="refresh" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href='#iconRefresh'></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="sort" class="block__icon b3-tooltips b3-tooltips__sw${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.sort}">
        <svg><use xlink:href="#iconSort"></use></svg>
    </span>
    <span class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></span>
    <span data-type="expand" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.expand} ${K(window.siyuan.config.keymap.editor.general.expand.custom)}">
        <svg><use xlink:href="#iconExpand"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="collapse" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.collapse} ${K(window.siyuan.config.keymap.editor.general.collapse.custom)}">
        <svg><use xlink:href="#iconContract"></use></svg>
    </span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__sw" aria-label="${window.siyuan.languages.min} ${K(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href='#iconMin'></use></svg></span>
</div>
<div class="fn__flex-1" style="margin-bottom: 8px"></div>`,this.tree=new oo({element:this.element.lastElementChild,data:null,click(a,i){const s=a.getAttribute("data-label");if(i){const o=A(i.target,"b3-list-item__action");if(o){Km(o.parentElement,i,s);return}}Fn(e,`#${a.getAttribute("data-label")}#`,!window.siyuan.ctrlIsPressed)},rightClick:(a,i)=>{Km(a,i,a.getAttribute("data-label"))},blockExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>',topExtHTML:window.siyuan.config.readonly?void 0:'<span class="b3-list-item__action"><svg><use xlink:href="#iconMore"></use></svg></span>'}),this.element.querySelector('[data-type="collapse"]').addEventListener("click",()=>{this.tree.collapseAll()}),this.element.querySelector('[data-type="expand"]').addEventListener("click",()=>{this.tree.expandAll()}),this.element.addEventListener("click",a=>{Ze(this.element);let i=a.target;for(;i&&!i.isEqualNode(this.element);){if(i.classList.contains("block__icon"))switch(i.getAttribute("data-type")){case"min":St("tag").toggleModel("tag");break;case"sort":window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new S({icon:window.siyuan.config.tag.sort===0?"iconSelect":void 0,label:window.siyuan.languages.fileNameASC,click:()=>{window.siyuan.config.tag.sort=0,this.update()}}).element),window.siyuan.menus.menu.append(new S({icon:window.siyuan.config.tag.sort===1?"iconSelect":void 0,label:window.siyuan.languages.fileNameDESC,click:()=>{window.siyuan.config.tag.sort=1,this.update()}}).element),window.siyuan.menus.menu.append(new S({icon:window.siyuan.config.tag.sort===4?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatASC,click:()=>{window.siyuan.config.tag.sort=4,this.update()}}).element),window.siyuan.menus.menu.append(new S({icon:window.siyuan.config.tag.sort===5?"iconSelect":void 0,label:window.siyuan.languages.fileNameNatDESC,click:()=>{window.siyuan.config.tag.sort=5,this.update()}}).element),window.siyuan.menus.menu.append(new S({icon:window.siyuan.config.tag.sort===7?"iconSelect":void 0,label:window.siyuan.languages.refCountASC,click:()=>{window.siyuan.config.tag.sort=7,this.update()}}).element),window.siyuan.menus.menu.append(new S({icon:window.siyuan.config.tag.sort===8?"iconSelect":void 0,label:window.siyuan.languages.refCountDESC,click:()=>{window.siyuan.config.tag.sort=8,this.update()}}).element),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY}),a.preventDefault(),a.stopPropagation();break;case"refresh":this.update();break}i=i.parentElement}}),this.update()}update(){const e=this.element.querySelector('.block__icon[data-type="refresh"] svg');e.classList.contains("fn__rotate")||(e.classList.add("fn__rotate"),w("/api/tag/getTag",{sort:window.siyuan.config.tag.sort},n=>{this.openNodes&&(this.openNodes=this.tree.getExpandIds()),this.tree.updateData(n.data),this.openNodes?this.tree.setExpandIds(this.openNodes):this.openNodes=this.tree.getExpandIds(),e.classList.remove("fn__rotate")}))}}const Au=async t=>{for(let e=0;e<t.plugins.length;e++)try{await t.plugins[e].onunload()}catch(n){console.error(n)}te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"destroy")};class la{constructor(e,n,a){this.children=[],this.removeTabAction=(l,r=!1,c=!0)=>{if(kE(),this.children.find((d,u)=>{if(d.id===l){if(d.model instanceof sa&&d.model.beforeDestroy&&d.model.beforeDestroy(),d.model instanceof dt&&cs(d.model.editor.protyle),this.children.length===1){this.destroyModel(this.children[0].model),this.children=[],["bottom","left","right"].includes(this.parent.type)?d.panelElement.remove():this.remove();const f=Pe().editor;f.length===0?Ta({protyle:void 0,focus:!0,pushBackStack:!1,reload:!1,resize:!0}):f.forEach(g=>{if(!g.element.classList.contains("fn__none")){Ze(g.parent.parent.headersElement.parentElement.parentElement),Ta({protyle:g.editor.protyle,focus:!0,pushBackStack:!0,reload:!1,resize:!0});return}});return}if(d.headElement){if(d.headElement.classList.contains("item--focus")){let f;Array.from(d.headElement.parentElement.children).forEach(g=>{!g.isSameNode(d.headElement)&&g.style.maxWidth!=="0px"&&(f?g.getAttribute("data-activetime")>f.getAttribute("data-activetime")&&(f=g):f=g)}),f&&!r&&(this.switchTab(f,!0,!0,!1,!1),this.showHeading())}c?(d.headElement.setAttribute("style","max-width: 0px;"),setTimeout(()=>{d.headElement.remove()},200)):d.headElement.remove()}return d.panelElement.remove(),this.destroyModel(d.model),this.children.splice(u,1),jt(!1),!0}}),window.siyuan.layout.centerLayout&&!Ni(window.siyuan.layout.centerLayout)){if((0,I.FJ)()){Au(this.app);return}const u=new la(this.app);window.siyuan.layout.centerLayout.addWnd(u),u.addTab(ub(this.app),!1,!1),Bo(window.siyuan.languages.siyuanNote)}Zn(),te.webFrame.clearCache(),te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"clearCache"),Ai()},this.id=Se(),this.app=e,this.resize=n,this.element=document.createElement("div"),this.element.classList.add("fn__flex-1","fn__flex");let i='<div class="layout-tab-container__drag fn__none"></div>';(a==="left"||a==="right"||a==="bottom")&&(i=""),this.element.innerHTML=`<div data-type="wnd" data-id="${this.id}" class="fn__flex-column fn__flex fn__flex-1">
    <div class="fn__flex fn__none">
        <ul class="fn__flex layout-tab-bar"></ul>
        <ul class="layout-tab-bar layout-tab-bar--readonly fn__flex-1">
            <li class="item item--readonly">
                <span data-type="new" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.newFile}"><svg><use xlink:href="#iconAdd"></use></svg></span>
                <span class="fn__flex-1"></span>
                <span data-type="more" data-menu="true" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.switchTab}"><svg><use xlink:href="#iconDown"></use></svg></span>
            </li>
        </ul>
    </div>
    <div class="layout-tab-container fn__flex-1">${i}</div>
</div>`,this.headersElement=this.element.querySelector(".layout-tab-bar");const s=this.element.querySelector(".layout-tab-container__drag");if(!s)return;this.headersElement.addEventListener("mousedown",l=>{if(l.button!==1)return;let r=l.target;for(;r&&!r.isEqualNode(this.headersElement);){if(r.tagName==="LI"){this.removeTab(r.getAttribute("data-id")),window.siyuan.menus.menu.remove(),l.stopPropagation(),l.preventDefault();break}r=r.parentElement}}),this.headersElement.addEventListener("mousewheel",l=>{this.headersElement.scrollLeft=this.headersElement.scrollLeft+l.deltaY},{passive:!0}),this.headersElement.parentElement.addEventListener("click",l=>{let r=l.target;for(;r&&!r.isEqualNode(this.headersElement);){if(r.classList.contains("block__icon")&&r.getAttribute("data-type")==="new"){Ze(this.headersElement.parentElement.parentElement),gi({app:e,useSavePath:!0});break}else if(r.classList.contains("block__icon")&&r.getAttribute("data-type")==="more"){this.renderTabList(r);break}else if(r.tagName==="LI"&&r.getAttribute("data-id")&&!Hi(this.element)){r.classList.contains("item--focus")?this.switchTab(r,!0,!0,!1,!1):this.switchTab(r,!0);break}r=r.parentElement}}),this.headersElement.parentElement.addEventListener("dblclick",l=>{let r=l.target;for(;r&&!r.isEqualNode(this.headersElement);){if(window.siyuan.config.fileTree.openFilesUseCurrentTab&&r.getAttribute("data-type")==="tab-header"){r.classList.remove("item--unupdate");break}r=r.parentElement}}),this.headersElement.parentElement.addEventListener("dragover",function(l){const r=this;if(l.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_FILE)){l.preventDefault(),r.classList.add("layout-tab-bars--drag");return}if(!l.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_TAB))return;l.preventDefault();let c=window.siyuan.dragElement,d=!1;if(Array.from(r.firstElementChild.childNodes).find(f=>{if(f.style.opacity==="0.1")return c=f,d=!0,!0}),!d&&c){if(c.classList.contains("item--pin"))return;c=c.cloneNode(!0),c.setAttribute("data-clone","true"),r.firstElementChild.append(c);return}else!d&&!c&&(c=document.createElement("li"),c.style.opacity="0.1",c.innerHTML='<svg class="svg"><use xlink:href="#iconFile"></use></svg>',c.setAttribute("data-clone","true"),r.firstElementChild.append(c));const u=q(l.target,"data-type","tab-header");if(!u){c.classList.contains("item--pin")||r.classList.add("layout-tab-bars--drag");return}if(!u.isSameNode(c)&&(c.classList.contains("item--pin")&&u.classList.contains("item--pin")||!c.classList.contains("item--pin")&&!u.classList.contains("item--pin"))){const f=u.getClientRects()[0];l.clientX>f.left+f.width/2?u.after(c):u.before(c)}});let o;this.headersElement.parentElement.addEventListener("dragleave",function(){clearTimeout(o),o=window.setTimeout(()=>{document.querySelectorAll(".layout-tab-bar li[data-clone='true']").forEach(r=>{r.remove()})},1e3),this.classList.remove("layout-tab-bars--drag")}),this.headersElement.parentElement.addEventListener("drop",function(l){const r=this;if(l.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_FILE)){Ze(r.parentElement),l.dataTransfer.getData(p.Constants.SIYUAN_DROP_FILE).split(",").forEach(h=>{h&&de({app:e,id:h,action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]})}),window.siyuan.dragElement=void 0,r.classList.remove("layout-tab-bars--drag");return}const c=JSON.parse(l.dataTransfer.getData(p.Constants.SIYUAN_DROP_TAB));let d=Lt(c.id);const u=Lt(r.parentElement.getAttribute("data-id"));if(d||u instanceof la&&(Wo(e,c,u),d=u.children[u.children.length-1],te.ipcRenderer.send(p.Constants.SIYUAN_SEND_WINDOWS,{cmd:"closetab",data:c.id}),r.querySelector("li[data-clone='true']").remove(),u.switchTab(d.headElement),te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"focus")),r.classList.remove("layout-tab-bars--drag"),!d)return;const f=Array.from(r.firstElementChild.childNodes).find(h=>{if(h.style.opacity==="0.1")return!0})?.nextElementSibling;if(!r.contains(d.headElement)){const h=r.querySelector("[data-clone='true']");if(!h)return;if(h.before(d.headElement),h.remove(),d.model instanceof zn){const m=d.model.element.querySelector("#viewerContainer");m&&m.setAttribute("data-scrolltop",m.scrollTop.toString())}u.moveTab(d,f?f.getAttribute("data-id"):void 0),jt();return}let g;d.parent.children.find((h,m)=>{if(h.id===d.id)return g=d.parent.children.splice(m,1)[0],!0}),f?d.parent.children.find((h,m)=>{if(h.id===f.getAttribute("data-id"))return d.parent.children.splice(m,0,g),!0}):d.parent.children.push(g),Zn()}),this.element.addEventListener("dragenter",l=>{if(l.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_TAB)){if(A(l.target,"layout-tab-bar"))return;A(l.target,"layout-tab-container",!0)&&(s.classList.remove("fn__none"),s.setAttribute("style","height:100%;width:100%;right:auto;bottom:auto"))}}),s.addEventListener("dragover",l=>{if(l.preventDefault(),!s.nextElementSibling)return;const r=s.parentElement.getBoundingClientRect(),c=r.height,d=r.width,u=l.clientX-r.left,f=l.clientY-r.top;u<=d/3&&(f<=c/8||f>=c*7/8)||u<=d/8&&(f>c/8||f<c*7/8)?s.setAttribute("style","height:100%;width:50%;right:50%;bottom:0;left:0;top:0"):u>d*2/3&&(f<=c/8||f>=c*7/8)||u>=d*7/8&&(f>c/8||f<c*7/8)?s.setAttribute("style","height:100%;width:50%;right:0;bottom:0;left:50%;top:0"):u>d/3&&u<d*2/3&&f<=c/8?s.setAttribute("style","height:50%;width:100%;right:0;bottom:50%;left:0;top:0"):u>d/3&&u<d*2/3&&f>=c*7/8?s.setAttribute("style","height:50%;width:100%;right:0;bottom:0;left:0;top:50%"):s.setAttribute("style","height:100%;width:100%;right:0;bottom:0;top:0;left:0")}),s.addEventListener("dragleave",()=>{s.classList.add("fn__none")}),s.addEventListener("drop",l=>{s.classList.add("fn__none");const r=l.target.parentElement.parentElement,c=Lt(r.getAttribute("data-id")),d=JSON.parse(l.dataTransfer.getData(p.Constants.SIYUAN_DROP_TAB));let u=Lt(d.id);if(u||(Wo(e,d,this),u=this.children[this.children.length-1],te.ipcRenderer.send(p.Constants.SIYUAN_SEND_WINDOWS,{cmd:"closetab",data:d.id}),te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"focus")),!!u){if(u.model instanceof zn){const f=u.model.element.querySelector("#viewerContainer");f&&f.setAttribute("data-scrolltop",f.scrollTop.toString())}if(s.style.height==="50%"||s.style.width==="50%"){if(s.style.height==="50%"){const f=c.split("tb");f.headersElement.append(u.headElement),f.headersElement.parentElement.classList.remove("fn__none"),f.moveTab(u),s.style.bottom==="50%"&&f.element.previousElementSibling&&c.element.parentElement&&Uu(f,c)}else if(s.style.width==="50%"){const f=c.split("lr");f.headersElement.append(u.headElement),f.headersElement.parentElement.classList.remove("fn__none"),f.moveTab(u),s.style.right==="50%"&&f.element.previousElementSibling&&c.element.parentElement&&Uu(f,c)}jt(),Ai();return}r.contains(document.querySelector(`[data-id="${d.id}"]`))||c&&(c.headersElement.append(u.headElement),c.headersElement.parentElement.classList.remove("fn__none"),c.moveTab(u),jt())}})}showHeading(){const e=this.headersElement.querySelector(".item--focus");e&&(e.offsetLeft+e.clientWidth>this.headersElement.scrollLeft+this.headersElement.clientWidth?this.headersElement.scrollLeft=e.offsetLeft+e.clientWidth-this.headersElement.clientWidth:e.offsetLeft<this.headersElement.scrollLeft&&(this.headersElement.scrollLeft=e.offsetLeft))}switchTab(e,n=!1,a=!0,i=!0,s=!0){let o;if(this.children.forEach(l=>{e===l.headElement?(l.headElement&&l.headElement.classList.contains("fn__none")||(l.headElement&&(l.headElement.classList.add("item--focus"),l.headElement.setAttribute("data-activetime",new Date().getTime().toString())),l.panelElement.classList.remove("fn__none")),o=l):(l.headElement?.classList.remove("item--focus"),l.panelElement.classList.contains("fn__none")||l.panelElement.classList.add("fn__none"))}),Ze(this.headersElement.parentElement.parentElement),o&&o.headElement){const l=o.headElement.getAttribute("data-initdata");if(l){o.addModel(vb(this.app,o,JSON.parse(l))),o.headElement.removeAttribute("data-initdata"),s&&Zn();return}}if(o&&e===o.headElement&&(o.model instanceof oa?o.model.onGraph(!1):o.model instanceof zn&&o.model.pdfObject&&o.model.pdfObject.pdfViewer&&o.model.pdfObject.pdfViewer.container.focus()),o&&o.model instanceof dt){const l=o.headElement.getAttribute("keep-cursor");if(l){let r;if(Array.from(o.model.editor.protyle.wysiwyg.element.querySelectorAll(`[data-node-id="${l}"]`)).find(c=>{if(!q(c,"data-type","NodeBlockQueryEmbed",!0))return r=c,!0}),r){if(!o.model.editor.protyle.toolbar.range){const c=document.createRange();c.selectNodeContents(r),c.collapse(),o.model.editor.protyle.toolbar.range=c}He(o.model.editor.protyle,r,!0)}else de({app:this.app,id:l,action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]});o.headElement.removeAttribute("keep-cursor")}a&&Ta({protyle:o.model.editor.protyle,focus:!0,pushBackStack:n,reload:!1,resize:i})}else Ta({protyle:void 0,focus:!1,pushBackStack:!1,reload:!1,resize:i});s&&Zn()}addTab(e,n=!1,a=!0){n&&(e.headElement?.classList.remove("item--focus"),e.panelElement.classList.add("fn__none"));let i=0;this.children.forEach((o,l)=>{if(o.headElement&&o.headElement.classList.contains("item--focus")){i=l;let r=o.headElement.nextElementSibling;for(;r&&r.classList.contains("item--pin");)i++,r=r.nextElementSibling}n||(o.headElement?.classList.remove("item--focus"),o.panelElement.classList.add("fn__none"))}),this.children.splice(i+1,0,e),e.headElement&&(this.headersElement.parentElement.classList.remove("fn__none"),this.headersElement.childElementCount===0?this.headersElement.append(e.headElement):this.headersElement.children[i].after(e.headElement),e.headElement.querySelector(".item__close").addEventListener("click",o=>{e.headElement.classList.contains("item--pin")?e.unpin():e.parent.removeTab(e.id),window.siyuan.menus.menu.remove(),o.stopPropagation(),o.preventDefault()}),e.headElement.setAttribute("data-activetime",new Date().getTime().toString()));const s=this.element.querySelector(".layout-tab-container");s.querySelector(".fn__flex-1")?s.querySelector(".layout-tab-container__drag")?s.children[i+1].after(e.panelElement):s.children[i].after(e.panelElement):s.append(e.panelElement),e.parent=this,e.callback&&e.callback(e),this.parent.type==="center"&&this.children.length===2&&!this.children[0].headElement?this.removeTab(this.children[0].id):this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter(i),Ai(),au(),a&&Zn()}renderTabList(e){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="tabList"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.classList.add("b3-menu--list"),Array.from(this.headersElement.children).forEach(a=>{const i=a.querySelector(".item__icon"),s=a.querySelector(".item__graphic");let o;i?i.firstElementChild?.tagName==="IMG"?o=`<img src="${i.firstElementChild.getAttribute("src")}"  class="b3-menu__icon">`:o=`<span class="b3-menu__icon">${i.innerHTML}</span>`:s||(o=ie(p.Constants.SIYUAN_IMAGE_FILE,"b3-menu__icon",!0)),window.siyuan.menus.menu.append(new S({label:we(a.querySelector(".item__text").textContent),action:"iconCloseRound",iconHTML:o,icon:s?s.firstElementChild.getAttribute("xlink:href").substring(1):"",bind:l=>{l.addEventListener("click",r=>{A(r.target,"b3-menu__action")?(this.removeTab(a.getAttribute("data-id")),l.previousElementSibling||l.nextElementSibling?l.remove():window.siyuan.menus.menu.remove()):(this.switchTab(a,!0),this.showHeading(),window.siyuan.menus.menu.remove()),r.preventDefault(),r.stopPropagation()})},current:a.classList.contains("item--focus")}).element)}),window.siyuan.menus.menu.element.setAttribute("data-name","tabList");const n=e.getBoundingClientRect();window.siyuan.menus.menu.popup({x:n.left+n.width,y:n.top+n.height,isLeft:!0})}removeOverCounter(e){typeof e>"u"&&this.children.forEach((i,s)=>{i.headElement&&i.headElement.classList.contains("item--focus")&&(e=s)});let n,a;this.children.forEach((i,s)=>{i.headElement.classList.contains("item--pin")||i.headElement.classList.contains("item--focus")||s===e||(a?i.headElement.getAttribute("data-activetime")<a&&(a=i.headElement.getAttribute("data-activetime"),n=this.children[s].id):(a=i.headElement.getAttribute("data-activetime"),n=this.children[s].id))}),n&&this.removeTab(n)}destroyModel(e){if(e){if(e instanceof dt&&e.editor){window.siyuan.blockPanels.forEach(n=>{n.element&&e.editor.protyle.wysiwyg.element.contains(n.element)&&n.destroy()}),e.editor.destroy();return}if(e instanceof Za){e.edit&&e.edit.destroy();return}e instanceof zn&&e.pdfObject&&e.pdfObject.pdfLoadingTask&&e.pdfObject.pdfLoadingTask.destroy(),e instanceof sa&&e.destroy&&e.destroy(),e.send("closews",{})}}removeTab(e,n=!1,a=!0){for(let i=0;i<this.children.length;i++){const s=this.children[i];if(s.id===e){if(s.model instanceof dt&&s.model.editor?.protyle){if(s.model.editor.protyle.upload.isUploading){M(window.siyuan.languages.uploading);return}this.removeTabAction(e,n,a)}else this.removeTabAction(e,n,a);return}}}moveTab(e,n){let a;if(e.model instanceof dt&&e.model.editor.protyle.toolbar.range){const s=x(e.model.editor.protyle.toolbar.range.startContainer);if(s){const o=yt(s,void 0,e.model.editor.protyle.toolbar.range);a={id:s.getAttribute("data-node-id"),start:o.start,end:o.end}}}if(this.element.querySelector(".layout-tab-container").append(e.panelElement),a&&e.model instanceof dt){const s=Gn(e.model.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${a.id}"]`),a.start,a.end);s&&(e.model.editor.protyle.toolbar.range=s)}n?this.children.find((s,o)=>{if(s.id===n)return this.children.splice(o,0,e),!0}):this.children.push(e),this.children.length>window.siyuan.config.fileTree.maxOpenTabCount&&this.removeOverCounter(),this.switchTab(e.headElement);const i=e.parent;if(i.children.length===1)i.children=[],i.remove();else if(i.children.find((s,o)=>{if(s.id===e.id)return i.children.splice(o,1),jt(),!0}),!i.headersElement.querySelector(".item--focus")){let s;Array.from(i.headersElement.children).forEach(o=>{s?o.getAttribute("data-activetime")>s.getAttribute("data-activetime")&&(s=o):s=o}),s&&i.switchTab(s,!0)}e.parent=this,Ja(["toolbar"]),Ai()}split(e){if(this.children.length===1&&!this.children[0].headElement)return this;const n=new la(this.app,e);return e===this.parent.direction?this.parent.addWnd(n,this.id):this.parent.children.length===1?(this.parent.direction=e,e==="tb"?(this.parent.element.classList.add("fn__flex-column"),this.parent.element.classList.remove("fn__flex")):(this.parent.element.classList.remove("fn__flex-column"),this.parent.element.classList.add("fn__flex")),this.parent.addWnd(n,this.id)):this.parent.children.find((a,i)=>{if(a.id===this.id){const s=new Kn({resize:a.resize,direction:e});this.parent.addLayout(s,a.id);const o=this.parent.children.splice(i,1)[0];return o.resize&&(o.element.previousElementSibling.remove(),o.resize=void 0),s.addWnd.call(s,o),s.addWnd.call(s,n),e==="tb"&&o.element.style.width?(s.element.style.width=o.element.style.width,s.element.classList.remove("fn__flex-1"),o.element.style.width="",o.element.classList.add("fn__flex-1")):e==="lr"&&o.element.style.height&&(s.element.style.height=o.element.style.height,s.element.classList.remove("fn__flex-1"),o.element.style.height="",o.element.classList.add("fn__flex-1")),!0}}),n}remove(){let e=this.parent,n=this.element,a=this.id;for(;e&&e.children.length===1&&e.type!=="center";)a=e.id,n=e.element,e=e.parent;e.children.find((i,s)=>{if(i.id===a){if(e.children.length>1){let o=e.children[s-1];s===0&&(o=e.children[1]),e.children.length===2?(e.direction==="lr"?o.element.style.width="":o.element.style.height="",o.resize=void 0,o.element.classList.add("fn__flex-1")):o.element.classList.contains("fn__flex-1")||(e.direction==="lr"?o.element.style.width=o.element.clientWidth+n.clientWidth+"px":o.element.style.height=o.element.clientHeight+n.clientHeight+"px"),e.children.length>2&&s===0&&(e.children[1].resize=void 0)}return e.children.splice(s,1),!0}}),n.previousElementSibling&&n.previousElementSibling.classList.contains("layout__resize")?n.previousElementSibling.remove():n.nextElementSibling&&n.nextElementSibling.classList.contains("layout__resize")&&n.nextElementSibling.remove(),n.remove(),jt()}}const Zm=()=>{const t=Pe(),e=[];return t.editor.forEach(n=>{e.push(n.editor)}),t.search.forEach(n=>{e.push(n.edit)}),t.custom.forEach(n=>{n.data?.editor instanceof pn&&e.push(n.data.editor)}),t.backlink.forEach(n=>{n.editors.forEach(a=>{e.push(a)})}),window.siyuan.dialogs.forEach(n=>{n.editor&&e.push(n.editor)}),window.siyuan.blockPanels.forEach(n=>{n.editors.forEach(a=>{e.push(a)})}),e},Pe=()=>{const t={editor:[],graph:[],asset:[],outline:[],backlink:[],search:[],inbox:[],files:[],bookmark:[],tag:[],custom:[]},e=n=>{for(let a=0;a<n.children.length;a++){const i=n.children[a];if(i instanceof gt){const s=i.model;s instanceof dt?t.editor.push(s):s instanceof oa?t.graph.push(s):s instanceof ja?t.outline.push(s):s instanceof Ka?t.backlink.push(s):s instanceof zn?t.asset.push(s):s instanceof Za?t.search.push(s):s instanceof xa?t.files.push(s):s instanceof Pi?t.bookmark.push(s):s instanceof Mi?t.tag.push(s):s instanceof sa&&t.custom.push(s)}else e(i)}};return window.siyuan.layout.layout&&e(window.siyuan.layout.layout),t},Pr=(t,e)=>{for(let n=0;n<t.children.length;n++){const a=t.children[n];a instanceof la?e.push(a):a instanceof Kn&&Pr(a,e)}},Yn=()=>{const t=[],e=n=>{for(let a=0;a<n.children.length;a++){const i=n.children[a];i instanceof gt?t.push(i):e(i)}};return window.siyuan.layout.centerLayout&&e(window.siyuan.layout.centerLayout),t},Mr=()=>{const t=[];return window.siyuan.config.uiLayout.left.data.forEach(e=>{e.forEach(n=>{t.push(n)})}),window.siyuan.config.uiLayout.right.data.forEach(e=>{e.forEach(n=>{t.push(n)})}),window.siyuan.config.uiLayout.bottom.data.forEach(e=>{e.forEach(n=>{t.push(n)})}),t},X=(t,e,n=!1)=>{if(!e){if(t.includes("dialog"))for(let a=0;a<window.siyuan.dialogs.length;a++)window.siyuan.dialogs[a].destroy(),a--;return}if(t.includes("hint")&&(clearTimeout(e.hint.timeId),e.hint.element.classList.add("fn__none")),e.gutter&&t.includes("gutter")&&(e.gutter.element.classList.add("fn__none"),e.gutter.element.innerHTML="",e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})),e.toolbar&&t.includes("toolbar")&&(e.toolbar.element.classList.add("fn__none"),e.toolbar.element.style.display=""),e.toolbar&&t.includes("util")){const a=e.toolbar.subElement.querySelector('[data-type="pin"]');(n||!a||a&&a.getAttribute("aria-label")===window.siyuan.languages.pin)&&(e.toolbar.subElement.classList.add("fn__none"),e.toolbar.subElementCloseCB&&(e.toolbar.subElementCloseCB(),e.toolbar.subElementCloseCB=void 0))}t.includes("select")&&e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(a=>{a.classList.remove("protyle-wysiwyg--select"),a.removeAttribute("select-start"),a.removeAttribute("select-end")})},Ja=t=>{t.includes("toolbar")&&document.querySelectorAll(".protyle-toolbar").forEach(e=>{e.classList.add("fn__none"),e.style.display=""}),t.includes("util")&&Zm().forEach(e=>{e.protyle.toolbar&&(e.protyle.toolbar.subElement.classList.add("fn__none"),e.protyle.toolbar.subElementCloseCB&&(e.protyle.toolbar.subElementCloseCB(),e.protyle.toolbar.subElementCloseCB=void 0))}),t.includes("pdfutil")&&document.querySelectorAll(".pdf__util").forEach(e=>{e.classList.add("fn__none")}),t.includes("gutter")&&document.querySelectorAll(".protyle-gutters").forEach(e=>{e.classList.add("fn__none"),e.innerHTML=""})},Tu=(t,e)=>{t.addEventListener("mousedown",n=>{if(A(n.target,"protyle-util")&&!t.classList.contains("protyle-util"))return;let a=A(n.target,"resize__move"),i,s;const o=t.getBoundingClientRect();if(a?(i=n.clientX-o.left,s=n.clientY-o.top):(i=n.clientX,s=n.clientY,a=A(n.target,"resize__rd")||A(n.target,"resize__r")||A(n.target,"resize__rt")||A(n.target,"resize__d")||A(n.target,"resize__l")||A(n.target,"resize__ld")||A(n.target,"resize__lt")||A(n.target,"resize__t")),!a)return;const l=t.clientHeight,r=t.clientWidth,c=a.className.split("resize__")[1].split(" ")[0],d=document;t.style.userSelect="none",t.classList.contains("b3-dialog__container")&&t.parentElement.style.display!=="block"&&(t.parentElement.style.display="block",t.style.left=o.left+"px",t.style.top=o.top+"px",t.style.width=o.width+"px"),d.ondragstart=()=>!1;let u=!1;d.onmousemove=f=>{if(u=!0,!!t)if(c==="move"){let g=f.clientX-i,h=f.clientY-s;g>window.innerWidth-r&&(g=window.innerWidth-r),h>window.innerHeight-l&&(h=window.innerHeight-l),t.style.left=Math.max(g,0)+"px",t.style.top=Math.max(h,p.Constants.SIZE_TOOLBAR_HEIGHT)+"px"}else c==="r"&&f.clientX-i+r>200&&f.clientX-i+r<window.innerWidth?(t.style.width=f.clientX-i+r+"px",t.style.maxWidth="none"):c==="d"&&f.clientY-s+l>160&&f.clientY-s+l<window.innerHeight-p.Constants.SIZE_TOOLBAR_HEIGHT?(t.style.height=f.clientY-s+l+"px",t.style.maxHeight=""):c==="t"&&f.clientY>p.Constants.SIZE_TOOLBAR_HEIGHT&&s-f.clientY+l>160?(t.style.top=f.clientY+"px",t.style.maxHeight="",t.style.height=s-f.clientY+l+"px"):c==="l"&&f.clientX>0&&i-f.clientX+r>200?(t.style.left=f.clientX+"px",t.style.width=i-f.clientX+r+"px",t.style.maxWidth="none"):c==="rd"&&f.clientX-i+r>200&&f.clientX-i+r<window.innerWidth&&f.clientY-s+l>160&&f.clientY-s+l<window.innerHeight-p.Constants.SIZE_TOOLBAR_HEIGHT?(t.style.height=f.clientY-s+l+"px",t.style.maxHeight="",t.style.maxWidth="none",t.style.width=f.clientX-i+r+"px"):c==="rt"&&f.clientX-i+r>200&&f.clientX-i+r<window.innerWidth&&f.clientY>p.Constants.SIZE_TOOLBAR_HEIGHT&&s-f.clientY+l>160?(t.style.width=f.clientX-i+r+"px",t.style.top=f.clientY+"px",t.style.maxHeight="",t.style.maxWidth="none",t.style.height=s-f.clientY+l+"px"):c==="lt"&&f.clientX>0&&i-f.clientX+r>200&&f.clientY>p.Constants.SIZE_TOOLBAR_HEIGHT&&s-f.clientY+l>160?(t.style.left=f.clientX+"px",t.style.width=i-f.clientX+r+"px",t.style.top=f.clientY+"px",t.style.maxHeight="",t.style.maxWidth="none",t.style.height=s-f.clientY+l+"px"):c==="ld"&&f.clientX>0&&i-f.clientX+r>200&&f.clientY-s+l>160&&f.clientY-s+l<window.innerHeight-p.Constants.SIZE_TOOLBAR_HEIGHT&&(t.style.left=f.clientX+"px",t.style.width=i-f.clientX+r+"px",t.style.height=f.clientY-s+l+"px",t.style.maxHeight="",t.style.maxWidth="none")},d.onmouseup=()=>{if(!t)return;window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0),t.style.userSelect="auto",d.onmousemove=null,d.onmouseup=null,d.ondragstart=null,d.onselectstart=null,d.onselect=null,Ja(["gutter"]);const f=A(t,"b3-dialog--open");if(f){const g=f.dataset.key;g&&t.offsetWidth&&(window.siyuan.storage[p.Constants.LOCAL_DIALOGPOSITION][g]={width:t.offsetWidth,height:t.offsetHeight,left:parseInt(t.style.left),top:parseInt(t.style.top)},pe(p.Constants.LOCAL_DIALOGPOSITION,window.siyuan.storage[p.Constants.LOCAL_DIALOGPOSITION]))}u&&e&&e(c)}})};class me{constructor(e){this.disableClose=e.disableClose,this.id=Se(),window.siyuan.dialogs.push(this),this.destroyCallback=e.destroyCallback,this.element=document.createElement("div");let n,a;if(!(0,I.tq)()&&e.positionId){const i=window.siyuan.storage[p.Constants.LOCAL_DIALOGPOSITION][e.positionId];i&&(n=i.left+"px",a=i.top+"px",e.width=i.width+"px",e.height=i.height+"px")}this.element.innerHTML=`<div class="b3-dialog" style="z-index: ${++window.siyuan.zIndex};${typeof n=="string"?"display:block":""}">
<div class="b3-dialog__scrim"${e.transparent?'style="background-color:transparent"':""}></div>
<div class="b3-dialog__container" style="width:${e.width||"auto"};height:${e.height||"auto"};left:${n};top:${a}">
  <svg ${(0,I.tq)()&&e.title?'style="top:0;right:0;"':""} class="b3-dialog__close${this.disableClose||e.hideCloseIcon?" fn__none":""}"><use xlink:href="#iconCloseRound"></use></svg>
  <div class="resize__move b3-dialog__header${e.title?"":" fn__none"}" onselectstart="return false;">${e.title||""}</div>
  <div class="b3-dialog__body">${e.content}</div>
  <div class="resize__rd"></div><div class="resize__ld"></div><div class="resize__lt"></div><div class="resize__rt"></div><div class="resize__r"></div><div class="resize__d"></div><div class="resize__t"></div><div class="resize__l"></div>
</div></div>`,this.element.querySelector(".b3-dialog__scrim").addEventListener("click",i=>{this.disableClose||this.destroy(),i.preventDefault(),i.stopPropagation()}),this.disableClose||this.element.querySelector(".b3-dialog__close").addEventListener("click",i=>{this.destroy(),i.preventDefault(),i.stopPropagation()}),document.body.append(this.element),e.disableAnimation?this.element.classList.add("b3-dialog--open"):setTimeout(()=>{this.element.classList.add("b3-dialog--open")}),Tu(this.element.querySelector(".b3-dialog__container"),e.resizeCallback)}destroy(e){this.element.querySelector(".b3-dialog").style.zIndex<window.siyuan.menus.menu.element.style.zIndex&&window.siyuan.menus.menu.remove(),this.element.remove(),this.destroyCallback&&this.destroyCallback(e),window.siyuan.dialogs.find((n,a)=>{if(n.id===this.id)return window.siyuan.dialogs.splice(a,1),!0})}bindInput(e,n,a=!0){e.focus(),e.addEventListener("keydown",i=>{if(i.isComposing){i.preventDefault();return}if(i.key==="Escape"){this.destroy(),i.preventDefault(),i.stopPropagation();return}!i.shiftKey&&R(i)&&i.key==="Enter"&&n&&a&&(n(),i.preventDefault(),i.stopPropagation())})}}const Nr=(t,e,n)=>{w("/api/block/getDocInfo",{id:t},a=>{e.updateTitle(a.data.name),n&&n.title&&n.title.setTitle(a.data.name)})},Jm=(t,e)=>{W();const n=Pe();n.editor.forEach(a=>{e.upsertRootIDs.includes(a.editor.protyle.block.rootID)?(na(a.editor.protyle,!1),Nr(a.editor.protyle.block.rootID,a.parent,a.editor.protyle)):e.removeRootIDs.includes(a.editor.protyle.block.rootID)&&(a.parent.parent.removeTab(a.parent.id,!1,!1),delete window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION][a.editor.protyle.block.rootID],pe(p.Constants.LOCAL_FILEPOSITION,window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION]))}),n.graph.forEach(a=>{a.type==="local"&&e.removeRootIDs.includes(a.rootId)?a.parent.parent.removeTab(a.parent.id,!1,!1):(a.type!=="local"||e.upsertRootIDs.includes(a.rootId))&&(a.searchGraph(!1),a.type==="local"&&Nr(a.rootId,a.parent))}),n.outline.forEach(a=>{a.type==="local"&&e.removeRootIDs.includes(a.blockId)?a.parent.parent.removeTab(a.parent.id,!1,!1):(a.type!=="local"||e.upsertRootIDs.includes(a.blockId))&&(w("/api/outline/getDocOutline",{id:a.blockId},i=>{a.update(i)}),a.type==="local"&&Nr(a.blockId,a.parent))}),n.backlink.forEach(a=>{a.type==="local"&&e.removeRootIDs.includes(a.rootId)?a.parent.parent.removeTab(a.parent.id,!1,!1):(a.refresh(),a.type==="local"&&Nr(a.rootId,a.parent))}),n.files.forEach(a=>{ha(()=>{a.init(!1)})}),n.bookmark.forEach(a=>{a.update()}),n.tag.forEach(a=>{a.update()}),n.search.forEach(a=>{a.parent.panelElement.querySelector("#searchInput").dispatchEvent(new CustomEvent("input"))}),n.custom.forEach(a=>{a.update&&a.update()})},Xm=t=>{window.siyuan.config.readonly||(t.plugins.forEach(e=>{e.eventBus.emit("lock-screen")}),te.ipcRenderer.send(p.Constants.SIYUAN_SEND_WINDOWS,{cmd:"lockscreen"}))},Qm=()=>{if(document.querySelector("#errorLog"))return;let t="";Bt()&&(t=`<div class="fn__hr"></div><div class="fn__flex"><div class="fn__flex-1"></div><button class="b3-button">${window.siyuan.languages.retry}</button></div>`);const e=new me({disableClose:!0,title:`\u{1F494} ${window.siyuan.languages.kernelFault0} <small>v${p.Constants.SIYUAN_VERSION}</small>`,width:(0,I.tq)()?"92vw":"520px",content:`<div class="b3-dialog__content">
<div class="ft__breakword">
    <div>${window.siyuan.languages.kernelFault1}</div>
    <div class="fn__hr"></div>
    <div>${window.siyuan.languages.kernelFault2}</div>
    ${t}
</div>
</div>`});e.element.id="errorLog";const n=e.element.querySelector(".b3-button");n&&n.addEventListener("click",()=>{e.destroy(),window.webkit.messageHandlers.startKernelFast.postMessage("startKernelFast")})},Ss=()=>{Ja(["util"]),w("/api/system/exit",{force:!1},t=>{if(t.code===1){const e=M(t.msg,t.data.closeTimeout,"error"),n=document.querySelector(`#message [data-id="${e}"] button`);n&&n.addEventListener("click",()=>{w("/api/system/exit",{force:!0},()=>{te.ipcRenderer.send(p.Constants.SIYUAN_QUIT,location.port)})})}else t.code===2?(W(),Ne(window.siyuan.languages.tip,t.msg,()=>{w("/api/system/exit",{force:!0,execInstallPkg:2},()=>{setTimeout(()=>{te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"hide")},2e3),setTimeout(()=>{te.ipcRenderer.send(p.Constants.SIYUAN_QUIT,location.port)},4e3)})},()=>{w("/api/system/exit",{force:!0,execInstallPkg:1},()=>{te.ipcRenderer.send(p.Constants.SIYUAN_QUIT,location.port)})})):te.ipcRenderer.send(p.Constants.SIYUAN_QUIT,location.port)})},mE=()=>{if(document.getElementById("transactionError"))return;const t=new me({disableClose:!0,title:`${window.siyuan.languages.stateExcepted} v${p.Constants.SIYUAN_VERSION}`,content:`<div class="b3-dialog__content" id="transactionError">${window.siyuan.languages.rebuildIndexTip}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--text">${window.siyuan.languages._kernel[97]}</button>
    <div class="fn__space"></div>
    <button class="b3-button">${window.siyuan.languages.rebuildIndex}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),e=t.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{It({errorExit:!0,cb:Ss})}),e[1].addEventListener("click",()=>{w("/api/filetree/refreshFiletree",{}),t.destroy()})},bE=t=>{const e=document.querySelector("#status");if(!e)return;if((0,I.tq)()){if(!document.querySelector("#keyboardToolbar").classList.contains("fn__none"))return;e.innerHTML=t.msg,e.classList.remove("status--hide"),e.style.bottom="0";return}const n=e.querySelector(".status__msg");n&&(n.innerHTML=t.msg)},wE=t=>{let e=document.getElementById("progress");if(e||(document.body.insertAdjacentHTML("beforeend",`<div id="progress" style="z-index: ${++window.siyuan.zIndex}"></div>`),e=document.getElementById("progress")),t.code===2){e.remove();return}t.code===0?e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:var(--b3-theme-on-surface);">
    <div style="text-align: right">${t.data.current}/${t.data.total}</div>
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="width: ${t.data.current/t.data.total*100}%;transition: var(--b3-transition);background-color: var(--b3-theme-primary);height: 8px;"></div></div>
    <div>${t.msg}</div>
</div>`:t.code===1&&(e.lastElementChild?e.lastElementChild.lastElementChild.innerHTML=t.msg:e.innerHTML=`<div class="b3-dialog__scrim" style="opacity: 1"></div>
<div style="position: fixed;top: 45vh;width: 70vw;left: 15vw;color:var(--b3-theme-on-surface);">
    <div style="margin: 8px 0;height: 8px;border-radius: var(--b3-border-radius);overflow: hidden;background-color:#fff;"><div style="background-color: var(--b3-theme-primary);height: 8px;background-image: linear-gradient(-45deg, rgba(255, 255, 255, 0.2) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, 0.2) 50%, rgba(255, 255, 255, 0.2) 75%, transparent 75%, transparent);animation: stripMove 450ms linear infinite;background-size: 50px 50px;"></div></div>
    <div>${t.msg}</div>
</div>`)},yE=t=>{const e=document.querySelector(".status__backgroundtask");e&&(t.length===0?(e.classList.add("fn__none"),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"&&window.siyuan.menus.menu.remove()):(e.classList.remove("fn__none"),e.setAttribute("data-tasks",JSON.stringify(t)),e.innerHTML=t[0].action+"<div><div></div></div>"))},_E=()=>{w("/api/sync/getBootSync",{},t=>{if(t.code===1){const e=new me({width:(0,I.tq)()?"92vw":"50vw",title:"\u{1F329}\uFE0F "+window.siyuan.languages.bootSyncFailed,content:`<div class="b3-dialog__content">${t.msg}</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.syncNow}</button>
</div>`}),n=e.element.querySelectorAll(".b3-button");n[0].addEventListener("click",()=>{e.destroy()}),n[1].addEventListener("click",()=>{n[1].getAttribute("disabled")||(n[1].setAttribute("disabled","disabled"),w("/api/sync/performBootSync",{},a=>{a.code===0&&e.destroy(),n[1].removeAttribute("disabled")}))})}})},Bo=t=>{const e=document.getElementById("drag"),n=op();if(t===window.siyuan.languages.siyuanNote){const a=`${n} - ${window.siyuan.languages.siyuanNote} v${p.Constants.SIYUAN_VERSION}`;document.title=a,e&&(e.textContent=a,e.setAttribute("title",a))}else{if(t=t||"Untitled",document.title=`${t} - ${n} - ${window.siyuan.languages.siyuanNote} v${p.Constants.SIYUAN_VERSION}`,!e)return;e.setAttribute("title",t),e.innerHTML=we(t)}},vE=t=>{const e=document.querySelector("#configBazaarReadme .item__side");if(!e||t.id!==JSON.parse(e.getAttribute("data-obj")).repoURL)return;const n=e.querySelector('[data-type="install"]');n&&(t.percent>=1?(n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")):(n.classList.add("b3-button--progress"),n.parentElement.nextElementSibling.firstElementChild.classList.add("b3-button--progress"),n.innerHTML=`<span style="width: ${t.percent*100}%"></span>`,n.parentElement.nextElementSibling.firstElementChild.innerHTML=`<span style="width: ${t.percent*100}%"></span>`))},ra=(t,e)=>{const n=document.querySelector("#barSync");if(!n)return;const a=n.querySelector("use");if(!t){n.classList.remove("toolbar__item--active"),!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&va("")?a.setAttribute("xlink:href","#iconCloudOff"):a.setAttribute("xlink:href","#iconCloudSucc");return}n.firstElementChild.classList.remove("fn__rotate"),t.code===0?(n.classList.add("toolbar__item--active"),n.firstElementChild.classList.add("fn__rotate"),a.setAttribute("xlink:href","#iconRefresh")):t.code===2?(n.classList.remove("toolbar__item--active"),a.setAttribute("xlink:href","#iconCloudError")):t.code===1&&(n.classList.remove("toolbar__item--active"),a.setAttribute("xlink:href","#iconCloudSucc")),e.forEach(i=>{t.code===0?i.eventBus.emit("sync-start",t):t.code===1?i.eventBus.emit("sync-end",t):t.code===2&&i.eventBus.emit("sync-fail",t)})},w=(t,e,n,a)=>{const i={method:"POST"};e&&(["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(t)&&(window.siyuan.reqIds[t]=new Date().getTime(),e.type==="local"&&t==="/api/graph/getLocalGraph"||(e.reqId=window.siyuan.reqIds[t])),t==="/api/transactions"&&(e.reqId=new Date().getTime()),e instanceof FormData?i.body=e:i.body=JSON.stringify(e)),a&&(i.headers=a),fetch(t,i).then(s=>s.status===404?{data:null,msg:s.statusText,code:s.status}:s.headers.get("content-type")?.indexOf("application/json")>-1?s.json():s.text()).then(s=>{if(typeof s=="string"){n&&n(s);return}["/api/search/searchRefBlock","/api/graph/getGraph","/api/graph/getLocalGraph"].includes(t)&&s.data.reqId&&window.siyuan.reqIds[t]&&window.siyuan.reqIds[t]>s.data.reqId||(typeof s=="object"&&typeof s.msg=="string"&&typeof s.code=="number"?Xn(s)&&n&&n(s):n&&n(s))}).catch(s=>{if(console.warn("fetch post error",s),t==="/api/transactions"&&(s.message==="Failed to fetch"||s.message==="Unexpected end of JSON input")){Qm();return}(t==="/api/system/exit"||t==="/api/system/setWorkspaceDir"||["/api/system/setUILayout"].includes(t)&&e.errorExit)&&te.ipcRenderer.send(p.Constants.SIYUAN_QUIT,location.port)})},lt=async(t,e)=>{const n={method:"POST"};e&&(n.body=JSON.stringify(e));const i=await(await fetch(t,n)).json();return Xn(i),i},Iu=(t,e)=>{fetch(t).then(n=>n.headers.get("content-type")?.indexOf("application/json")>-1?n.json():n.text()).then(n=>{e(n)})},EE=(t=!1)=>{let e="";t||(e=`<div id="barDock" class="toolbar__item ariaLabel${window.siyuan.config.readonly||t?" fn__none":""}" aria-label="${window.siyuan.languages.toggleDock} ${K(window.siyuan.config.keymap.general.toggleDock.custom)}">
    <svg>
        <use xlink:href="#${window.siyuan.config.uiLayout.hideDock?"iconDock":"iconHideDock"}"></use>
    </svg>
</div>`),document.getElementById("status").innerHTML=`${e}
<div class="status__msg"></div>
<div class="fn__flex-1"></div>
<div class="status__backgroundtask fn__none"></div>
<div class="status__counter"></div>
<div id="statusHelp" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.help}">
    <svg><use xlink:href="#iconHelp"></use></svg>
</div>`,document.querySelector("#status").addEventListener("click",n=>{let a=n.target;for(;a.id!=="status";){if(a.id==="barDock"){Bg(a.firstElementChild.firstElementChild),n.stopPropagation();break}else if(a.classList.contains("status__backgroundtask")){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusBackgroundTask"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","statusBackgroundTask"),JSON.parse(a.getAttribute("data-tasks")).forEach(s=>{window.siyuan.menus.menu.append(new S({type:"readonly",iconHTML:p.Constants.ZWSP,label:s.action}).element)});const i=a.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.right,y:i.top,isLeft:!0}),n.stopPropagation();break}else if(a.id==="statusHelp"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="statusHelp"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","statusHelp"),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.help,icon:"iconHelp",click:()=>{er()}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.feedback,icon:"iconFeedback",click:()=>{window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?window.open("https://ld246.com/article/1649901726096"):window.open("https://liuyun.io/article/1686530886208")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.debug,icon:"iconBug",click:()=>{te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"openDevTools")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages._trayMenu.officialWebsite,icon:"iconSiYuan",click:()=>{window.open("https://b3log.org/siyuan")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages._trayMenu.openSource,icon:"iconGithub",click:()=>{window.open("https://github.com/siyuan-note/siyuan")}}).element);const i=a.getBoundingClientRect();window.siyuan.menus.menu.popup({x:i.right,y:i.top,isLeft:!0}),n.stopPropagation();break}else if(a.classList.contains("b3-menu__item")){const i=a.getAttribute("data-type");if(St(i).toggleModel(i),i==="file"&&getSelection().rangeCount>0){const s=getSelection().getRangeAt(0),o=A(s.startContainer,"protyle-wysiwyg",!0);o&&o.blur()}a.parentElement.classList.add("fn__none"),n.stopPropagation();break}a=a.parentElement}}),window.siyuan.config.appearance.hideStatusBar&&document.getElementById("status").classList.add("fn__none")};let Xa,qo;const Ls=(t,e)=>{document.getElementById("status").classList.contains("fn__none")||(clearTimeout(qo),qo=window.setTimeout(()=>{t.toString()?(w("/api/block/getContentWordCount",{content:t.toString()},a=>{Hr(a.data)}),Xa=""):e&&e!==Xa&&(Xa=e,w("/api/block/getTreeStat",{id:e},a=>{Hr(a.data)}))},p.Constants.TIMEOUT_COUNT))},Gt=(t,e,n=!1)=>{document.getElementById("status").classList.contains("fn__none")||(clearTimeout(qo),qo=window.setTimeout(()=>{n&&(Xa=""),t.length>0?(w("/api/block/getBlocksWordCount",{ids:t},a=>{Hr(a.data)}),Xa=""):e&&e!==Xa&&(Xa=e,w("/api/block/getTreeStat",{id:e},a=>{Hr(a.data)}))},p.Constants.TIMEOUT_COUNT))},kE=()=>{Xa="",document.querySelector("#status .status__counter").innerHTML="",clearTimeout(qo)},Hr=t=>{if(!t)return;let e=`<span class="ft__on-surface">${window.siyuan.languages.runeCount}</span>&nbsp;${t.runeCount}<span class="fn__space"></span>
<span class="ft__on-surface">${window.siyuan.languages.wordCount}</span>&nbsp;${t.wordCount}<span class="fn__space"></span>`;0<t.linkCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.linkCount}</span>&nbsp;${t.linkCount}<span class="fn__space"></span>`),0<t.imageCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.imgCount}</span>&nbsp;${t.imageCount}<span class="fn__space"></span>`),0<t.refCount&&(e+=`<span class="ft__on-surface">${window.siyuan.languages.refCount}</span>&nbsp;${t.refCount}<span class="fn__space"></span>`),document.querySelector("#status .status__counter").innerHTML=e},SE=(t,e)=>{if(!e){if(getSelection().rangeCount===0)return!1;e=getSelection().getRangeAt(0)}const n=e.commonAncestorContainer;return t.isEqualNode(n)||t.contains(n)},Du=t=>{const e=q(t.startContainer,"data-type","NodeTable");if(t.toString()!==""&&e&&t.commonAncestorContainer.nodeType!==3){const n=t.commonAncestorContainer.tagName;if(n!=="TH"&&n!=="TD"){const a=se(t.startContainer,"TD")||se(t.startContainer,"TH"),i=se(t.endContainer,"TD")||se(t.endContainer,"TH");if(!a&&!i){const s=e.querySelector("th")||e.querySelector("td");t.setStart(s.firstChild,0),t.setEnd(s.lastChild,s.lastChild.textContent.length)}else a&&!a.contains(t.endContainer)&&Xt(a,t,!1)}}},Fo=(t,e,n)=>{const a=ae(e);if(a){let o;if(a.tagName==="TABLE"){const l=se(n.startContainer,"TD")||se(n.startContainer,"TH");if(l&&(o=yt(l,e,n),o.start!==0||o.end!==l.textContent.length))return n.setStart(l.firstChild,0),n.setEndAfter(l.lastChild),t.toolbar.render(t,n),Ls(n,t.block.rootID),!0}else if(o=yt(a,e,n),o.start!==0||o.end!==a.textContent.length){let l=a.firstChild;for(;l;)if(l.nodeType===3){if(l.textContent!==""){n.setStart(l,0);break}l=l.nextSibling}else{if(l.classList.contains("render-node")||l.classList.contains("img")){n.setStartBefore(l);break}l=l.firstChild}let r=a.lastChild;for(;r;)if(r.nodeType===3){if(r.textContent!==""){n.setEnd(r,r.textContent.length);break}r=r.previousSibling}else{if(r.classList.contains("render-node")||r.classList.contains("img")||r.tagName==="BR"){n.setEndAfter(r);break}r=r.lastChild}return Z(n),t.toolbar.render(t,n),Ls(n,t.block.rootID),!0}}n.collapse(!0);const i=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(t.wysiwyg.element.childElementCount===i.length&&i[0].parentElement.isSameNode(t.wysiwyg.element))return!0;X(["select"],t);const s=[];Array.from(t.wysiwyg.element.children).forEach(o=>{o.classList.add("protyle-wysiwyg--select"),s.push(o.getAttribute("data-node-id"))}),Gt(s,t.block.rootID)},$u=(t,e)=>{const n=document.caretRangeFromPoint(t,e),a=q(n.startContainer,"data-type","img");return a&&(n.setStart(a.nextSibling,0),n.collapse()),n},re=t=>{let e;if(getSelection().rangeCount>0&&(e=getSelection().getRangeAt(0),t.isSameNode(e.startContainer)||t.contains(e.startContainer)))return e;t.focus({preventScroll:!0});let n;return t.classList.contains("table")?n=t.querySelector("th")||t.querySelector("td"):(n=ae(t),n?n.tagName==="TABLE"&&(n=n.querySelector("th")||t.querySelector("td")):n=t),e=n.ownerDocument.createRange(),e.setStart(n||t,0),e.collapse(!0),e},$n=(t,e)=>{if(e||(e=re(t)),!t.contains(e.startContainer))return{left:0,top:0};let n;if(e.getClientRects().length===0)if(e.startContainer.nodeType===3){const a=e.startContainer.parentElement?.getClientRects(),i=e.startContainer.previousElementSibling?.getClientRects();if(a.length>0||i.length>0)a.length===0||i&&i.length>0&&a[0].top<i[i.length-1].bottom?n={left:i[i.length-1].left,top:i[i.length-1].bottom}:n=a[0];else return{left:0,top:0}}else{const a=e.startContainer.children;if(a[e.startOffset]&&a[e.startOffset].getClientRects().length>0)n=a[e.startOffset].getClientRects()[0];else if(e.startContainer.childNodes.length>0){const i=e.cloneRange();e.selectNode(e.startContainer.childNodes[Math.max(0,e.startOffset-1)]),n=e.getClientRects()[0],e.setEnd(i.endContainer,i.endOffset),e.setStart(i.startContainer,i.startOffset)}else n=e.startContainer.getClientRects()[0];if(!n){let i=e.startContainer.childNodes[e.startOffset];if(i||(i=e.startContainer.childNodes[e.startOffset-1]),!i)n=e.getBoundingClientRect();else{for(;!i.getClientRects||i.getClientRects&&i.getClientRects().length===0;)i=i.parentElement;n=i.getClientRects()[0]}}}else{const a=e.getClientRects();return{left:a[a.length-1].left,top:a[0].top}}return{left:n.left,top:n.top}},yt=(t,e,n)=>{const a={end:0,start:0};if(!n){if(getSelection().rangeCount===0)return a;n=window.getSelection().getRangeAt(0)}if(e&&!SE(e,n))return a;const i=n.cloneRange();return t.childNodes[0]&&t.childNodes[0].childNodes[0]?i.setStart(t.childNodes[0].childNodes[0],0):i.selectNodeContents(t),i.setEnd(n.startContainer,n.startOffset),a.start=i.toString().length,a.end=a.start+n.toString().length,a};function Or(t,e,n,a){if(!e)return!1;if(n(e))return!0;for(let i=0,s=e.childNodes.length;i<s;i++)if(Or(e,e.childNodes[i],n,!0))return!0;if(!a){let i=e;for(;i&&i!==t;){let s=i.nextSibling;for(;s;){if(Or(t,s,n,!0))return!0;s=s.nextSibling}i=i.parentNode}}return!1}const Xt=(t,e,n=!0)=>{if(!t)return e;let a=t.lastChild;for(;a&&a.nodeType!==3;)a=a.lastChild;return a?(n?e.setStart(a,a.textContent.length):e.setEnd(a,a.textContent.length),e):(e.selectNodeContents(t),e)},Uo=(t,e)=>{if(!t)return e;let n=t.firstChild;for(;n&&n.nodeType!==3&&!n.classList.contains("render-node");){if(n.classList.contains("img"))return e.setStartBefore(n),e;n=n.firstChild}return n?(n.nodeType!==3&&n.classList.contains("render-node")?e.setStartBefore(n):e.setStart(n,0),e):(e.selectNodeContents(t),e)},Gn=(t,e,n)=>{if(!t)return!1;const a=ae(t);if(a)t=a;else if(Ft(t)||t.classList.contains("av"))return le(t);let i;Or(t,t.firstChild,l=>{if(l.nodeType===Node.TEXT_NODE){const r=l.data.length;return e<=r?(i=l,!0):(e-=r,n-=r,!1)}});let s;i&&Or(t,i,l=>{if(l.nodeType===Node.TEXT_NODE){const r=l.data.length;return n<=r?(s=l,!0):(n-=r,!1)}});const o=document.createRange();return i?e<i.data.length?o.setStart(i,e):o.setStartAfter(i):e===0?o.setStart(t,0):Xt(ae(t),o),s?n<s.data.length?o.setEnd(s,n):o.setEndAfter(s):n===0?o.setEnd(t,0):Xt(ae(t),o,!1),Z(o),o},fe=(t,e)=>{const n=t.querySelectorAll("wbr");if(n.length===0)return;n.forEach((i,s)=>{s!==0&&i.remove()});const a=n[0];if(!a.previousElementSibling)a.previousSibling?e.setStart(a.previousSibling,a.previousSibling.textContent.length):a.nextSibling?a.nextSibling.nodeType===3?e.setStart(a.nextSibling,0):e.setStartAfter(a):e.setStart(a.parentElement,0);else{const i=Ke(a);i&&a.previousElementSibling.isSameNode(i)?a.previousElementSibling.lastChild?.nodeType===3?e.setStart(a.previousElementSibling.lastChild,a.previousElementSibling.lastChild.textContent.length):i.nodeType!==3&&i.classList.contains("img")?e.setStartAfter(i):e.setStartBefore(a):e.setStart(a.previousSibling,a.previousSibling.textContent.length)}e.collapse(!0),a.remove(),Z(e)},Z=t=>{if(!t)return;const e=t.startContainer.childNodes[t.startOffset];if(e&&e.nodeType!==3&&["INPUT","TEXTAREA"].includes(e.tagName)){e.focus();return}const n=window.getSelection();n.removeAllRanges(),n.addRange(t)},le=(t,e,n=!0)=>{if(!t)return!1;if(t.classList.contains("render-node")||t.classList.contains("iframe")||t.classList.contains("hr")){const i=document.createRange(),s=t.getAttribute("data-type");let o=!1;return s==="NodeThematicBreak"?(i.selectNodeContents(t.firstElementChild),o=!0):s==="NodeBlockQueryEmbed"?(t.lastElementChild.previousElementSibling?.firstChild?(i.selectNodeContents(t.lastElementChild.previousElementSibling.firstChild),i.collapse(!0)):(i.selectNodeContents(t),i.collapse(!0)),o=!0):["NodeMathBlock","NodeHTMLBlock"].includes(s)?(t.lastElementChild.previousElementSibling?.lastElementChild?.firstChild?(i.selectNodeContents(t.lastElementChild.previousElementSibling.lastElementChild.firstChild),i.collapse(!0)):t.lastElementChild.previousElementSibling&&(i.selectNodeContents(t.lastElementChild.previousElementSibling),i.collapse(!0)),o=!0):s==="NodeIFrame"||s==="NodeWidget"?(i.setStart(t,0),o=!0):s==="NodeVideo"?(i.setStart(t.firstElementChild,0),o=!0):s==="NodeAudio"?(i.setStart(t.firstElementChild.lastChild,0),o=!0):s==="NodeCodeBlock"&&(i.selectNodeContents(t),i.collapse(!0),o=!0),o?(Z(i),i):(Rr(t),!1)}else if(t.classList.contains("av")){const i=t.querySelector(".av__title");if(i){const s=document.createRange();return s.selectNodeContents(i),s.collapse(),Z(s),s}else return!1}let a;if(n?a=ae(t):Array.from(t.querySelectorAll('[contenteditable="true"]')).reverse().find(i=>{if(i.getBoundingClientRect().width>0)return a=i,!0}),a){if(a.tagName==="TABLE")if(n)a=a.querySelector("th, td");else{const s=a.querySelectorAll("th, td");a=s[s.length-1]}let i;if(n)i=Uo(a,re(a)),i.collapse(!0);else{let s=!1;if(a.classList.contains("hljs")){let o=a.lastChild;o.textContent===""&&o.nodeType===3&&(o=Ke(a.lastChild)),o&&o.textContent.endsWith(`
`)&&(i=re(a),i.setStart(o,o.textContent.length-1),s=!0)}s||(i=Xt(a,re(a))),i.collapse(!1)}return Z(i),i}else e&&e.focus();return!1},Rr=t=>{if(t.getAttribute("data-node-id")){let n,a;t.nextElementSibling&&!t.nextElementSibling.classList.contains("protyle-attr")?(a=!0,n=nt(t)):t.previousElementSibling&&(a=!1,n=De(t)),n||(n=t),le(n,void 0,a);return}const e=re(t);t.nextSibling?(e.selectNodeContents(t.nextSibling),e.collapse(!0)):t.previousSibling&&(e.selectNodeContents(t.previousSibling),e.collapse(!1)),Z(e)},an=(t,e,n)=>{e&&(Xt(ae(n[n.length-1]),t.toolbar.range),t.toolbar.range.collapse(!0),wt(e,t,!0,!0),Be(t,t.wysiwyg.element),bt(t.wysiwyg.element),qe(t.wysiwyg.element))},eb=(t,e)=>{const n=[];t.forEach(i=>{n.push(i.getAttribute("data-node-id"))});const a=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiCustomAction,click(){const i=new me({title:window.siyuan.languages.aiCustomAction,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.use}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.save}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),s=i.element.querySelector("input"),o=i.element.querySelector("textarea"),l=i.element.querySelectorAll(".b3-button");i.bindInput(o,()=>{l[1].click()}),l[0].addEventListener("click",()=>{i.destroy()}),l[1].addEventListener("click",()=>{if(!o.value){M(window.siyuan.languages._kernel[142]);return}w("/api/ai/chatGPTWithAction",{ids:n,action:o.value},r=>{i.destroy(),an(e,r.data,t)})}),l[2].addEventListener("click",()=>{if(!s.value&&!o.value){M(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[p.Constants.LOCAL_AI].push({name:s.value,memo:o.value}),pe(p.Constants.LOCAL_AI,window.siyuan.storage[p.Constants.LOCAL_AI]),i.destroy()}),s.focus()}}];window.siyuan.storage[p.Constants.LOCAL_AI].length>0&&a.push({type:"separator"}),window.siyuan.storage[p.Constants.LOCAL_AI].forEach(i=>{a.push({iconHTML:p.Constants.ZWSP,action:"iconEdit",label:`<div aria-label="${qa(i.memo)}" class="ariaLabel">${we(i.name)}</div>`,bind:s=>{s.addEventListener("click",o=>{if(A(o.target,"b3-menu__action")){const l=new me({title:window.siyuan.languages.update,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.aiCustomAction}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--error">${window.siyuan.languages.delete}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),r=l.element.querySelector("input");r.value=i.name;const c=l.element.querySelector("textarea"),d=l.element.querySelectorAll(".b3-button");l.bindInput(c,()=>{d[1].click()}),c.value=i.memo,d[0].addEventListener("click",()=>{l.destroy()}),d[1].addEventListener("click",()=>{window.siyuan.storage[p.Constants.LOCAL_AI].find(u=>{if(i.name===u.name&&i.memo===u.memo)return i.name=r.value,i.memo=c.value,pe(p.Constants.LOCAL_AI,window.siyuan.storage[p.Constants.LOCAL_AI]),!0}),l.destroy()}),d[2].addEventListener("click",()=>{window.siyuan.storage[p.Constants.LOCAL_AI].find((u,f)=>{if(i.name===u.name&&i.memo===u.memo)return window.siyuan.storage[p.Constants.LOCAL_AI].splice(f,1),pe(p.Constants.LOCAL_AI,window.siyuan.storage[p.Constants.LOCAL_AI]),!0}),l.destroy()}),r.focus()}else w("/api/ai/chatGPTWithAction",{ids:n,action:i.memo},l=>{an(e,l.data,t)});window.siyuan.menus.menu.remove(),o.preventDefault(),o.stopPropagation()})}})}),window.siyuan.menus.menu.append(new S({icon:"iconSparkles",label:window.siyuan.languages.ai,type:"submenu",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiContinueWrite,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:"Continue writing"},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate,type:"submenu",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hans,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [zh-Hans]"},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_zh_Hant,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [zh-Hant]"},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_ja_JP,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [ja-JP]"},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_ko_KR,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [ko-KR]"},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_en_US,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [en-US]"},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_es_ES,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [es-ES]"},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_fr_FR,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [fr-FR]"},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiTranslate_de_DE,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:"Translate as follows to [de-DE]"},i=>{an(e,i.data,t)})}}]},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiExtractSummary,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiExtractSummary},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiBrainStorm,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiBrainStorm},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.aiFixGrammarSpell,click(){w("/api/ai/chatGPTWithAction",{ids:n,action:window.siyuan.languages.aiFixGrammarSpell},i=>{an(e,i.data,t)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.custom,type:"submenu",submenu:a}]}).element)},LE=(t,e)=>{const n=new me({title:"AI Chat",content:`<div class="b3-dialog__content"><textarea class="b3-text-field fn__block"></textarea></div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),a=n.element.querySelector("textarea"),i=n.element.querySelectorAll(".b3-button");n.bindInput(a,()=>{i[1].click()}),a.focus(),i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{w("/api/ai/chatGPT",{msg:a.value},s=>{n.destroy();let o="";s.data&&s.data!==""&&(o=`

`+s.data),an(t,`${a.value}${o}`,[e])})})};class CE{constructor(e){this.enableSlash=!0,this.enableEmoji=!0,this.enableExtend=!1,this.splitChar="",this.lastIndex=-1,this.element=document.createElement("div"),this.element.setAttribute("data-close","false"),this.element.setAttribute("style",`width:${Math.max(e.element.clientWidth/2,320)}px;`),this.element.className="protyle-hint b3-list b3-list--background fn__none",this.element.addEventListener("click",n=>{const a=n.target;if(a.tagName==="INPUT"){n.stopPropagation();return}const i=se(a,"BUTTON");if(i&&!i.classList.contains("emojis__item")&&!i.classList.contains("emojis__type")){this.source!=="search"?this.fill(decodeURIComponent(i.getAttribute("data-value")),e,!0,O(n)):setTimeout(()=>{this.fill(decodeURIComponent(i.getAttribute("data-value")),e,!0,R(n))},148),Z(e.toolbar.range),n.preventDefault(),n.stopPropagation();return}const s=this.element.querySelector(".emojis__panel"),o=A(a,"emojis__type");if(o){const r=s.querySelector(`[data-type="${o.getAttribute("data-type")}"]`);if(r){const c=r.nextElementSibling.getAttribute("data-index");if(c){let d="";window.siyuan.emojis[parseInt(c)].items.forEach(u=>{d+=`<button data-unicode="${u.unicode}" class="emojis__item ariaLabel" aria-label="${window.siyuan.config.lang==="zh_CN"?u.description_zh_cn:u.description}">
${ie(u.unicode)}</button>`}),r.nextElementSibling.innerHTML=d,r.nextElementSibling.removeAttribute("data-index")}s.scrollTo({top:r.offsetTop})}return}const l=A(a,"emojis__item");if(l){const r=l.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const c=getSelection().getRangeAt(0);c.endContainer.nodeType!==3?c.endContainer.childNodes[c.endOffset-1]?.remove():c.endContainer.textContent===":"&&(c.endContainer.textContent=""),ui(r);let d;r.indexOf(".")>-1?d=`:${r.split(".")[0]}: `:d=ie(r)+" ",wt(e.lute.SpinBlockDOM(d),e,!1,!0),this.element.classList.add("fn__none")}else this.fill(r,e)}})}render(e){if(!window.getSelection().focusNode){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(!this.enableExtend){clearTimeout(this.timeId);return}if(e.toolbar.range=getSelection().getRangeAt(0),e.toolbar.range.startContainer.nodeType===3&&e.toolbar.range.startContainer.textContent===""){const s=Ke(e.toolbar.range.startContainer);if(s&&s.nodeType===3){if(s.wholeText!==s.textContent){let o=s.previousSibling;for(;o&&o.nodeType===3;)if(o.textContent==="")o=o.previousSibling,o.nextSibling.remove();else{s.textContent=o.textContent+s.textContent,o.remove();break}}e.toolbar.range.setStart(s,s.textContent.length),e.toolbar.range.collapse(!0)}}const n=yt(e.toolbar.range.startContainer,e.wysiwyg.element).start,a=e.toolbar.range.startContainer.textContent.substring(0,n)||"",i=this.getKey(a,e.options.hint.extend);if(typeof i>"u"||q(e.toolbar.range.startContainer,"data-type","code")||q(e.toolbar.range.startContainer,"data-type","NodeCodeBlock")){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}if(this.splitChar==="#"){const s=x(e.toolbar.range.startContainer);if(s&&s.getAttribute("data-type")==="NodeHeading"){const o=yt(e.toolbar.range.startContainer,s).start;if(s.textContent.startsWith("#".repeat(o))){this.element.classList.add("fn__none"),clearTimeout(this.timeId);return}}}if(this.splitChar===":"){clearTimeout(this.timeId),i?this.genEmojiHTML(e,i):this.element.classList.add("fn__none");return}if(this.splitChar==="/"||this.splitChar==="\u3001"){clearTimeout(this.timeId),this.enableSlash&&!(0,I.tq)()&&this.genHTML(hd(i,e),e,!1,"hint");return}e.options.hint.extend.forEach(s=>{s.key===this.splitChar&&(clearTimeout(this.timeId),this.timeId=window.setTimeout(()=>{this.genHTML(s.hint(i,e,"hint"),e,!1,"hint")},e.options.hint.delay))})}genLoading(e){if(this.element.classList.contains("fn__none")){this.element.innerHTML='<div class="fn__loading" style="height: 128px;position: initial"><img width="64px" src="/stage/loading-pure.svg"></div>',this.element.classList.remove("fn__none");const n=$n(e.wysiwyg.element);ke(this.element,n.left,n.top+26,30)}else this.element.insertAdjacentHTML("beforeend",'<div class="fn__loading"><img width="64px" src="/stage/loading-pure.svg"></div>')}bindUploadEvent(e,n){const a=n.querySelector('input[type="file"]');a&&a.addEventListener("change",i=>{if(i.target.files.length===0)return;const s=re(e.wysiwyg.element);this.lastIndex>-1&&s.setStart(s.startContainer,this.lastIndex),s.deleteContents(),ka(e,i.target.files,i.target),X(["hint","toolbar"],e)})}getHTMLByData(e){let n='<div style="flex: 1;overflow:auto;">';return this.source!=="hint"&&(n='<input style="margin:0 8px 4px 8px" class="b3-text-field"><div style="flex: 1;overflow:auto;">'),e.forEach((a,i)=>{let s="";(i===1&&e[i].focus||i===0&&(e.length===1||!e[1].focus))&&(s=" b3-list-item--focus"),a.html==="separator"?n+='<div class="b3-menu__separator"></div>':n+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s}" data-value="${encodeURIComponent(a.value)}">${a.html}</button>`}),`${n}</div>`}genHTML(e,n,a=!1,i){if(this.source=i,e.length===0){(!this.element.querySelector(".fn__loading")||a)&&this.element.classList.add("fn__none");return}if(this.element.innerHTML=this.getHTMLByData(e),this.element.classList.remove("fn__none"),e[0].filter?this.element.classList.add("hint--menu"):this.element.classList.remove("hint--menu"),this.element.style.width=Math.max(n.element.clientWidth/2,320)+"px",this.source==="av"){const s=A(n.toolbar.range.startContainer,"av__cell");if(s){const o=s.getBoundingClientRect();ke(this.element,o.left,o.bottom,o.height)}}else{const s=$n(n.wysiwyg.element);ke(this.element,s.left,s.top+26,30)}if(this.element.scrollTop=0,this.bindUploadEvent(n,this.element),this.source!=="hint"){const s=this.element.querySelector("input.b3-text-field"),o=this.element.querySelector("mark")?.textContent||"";s.value=o,s.select(),s.addEventListener("keydown",r=>{r.key!=="Meta"&&r.key!=="Control"&&r.stopPropagation(),!r.isComposing&&(Bn(this.element.lastElementChild,r),r.key==="Enter"?(setTimeout(()=>{this.fill(decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value")),n,!0,R(r))},148),Z(n.toolbar.range),r.preventDefault()):r.key==="Escape"&&(this.element.classList.add("fn__none"),Z(n.toolbar.range)))});const l=n.toolbar.range?x(n.toolbar.range.startContainer):!1;s.addEventListener("input",r=>{r.isComposing||(r.stopPropagation(),this.genSearchHTML(n,s,l,o))}),s.addEventListener("compositionend",r=>{r.stopPropagation(),this.genSearchHTML(n,s,l,o)})}}genSearchHTML(e,n,a,i){this.element.lastElementChild.innerHTML='<div class="ft__center"><img style="height:32px;width:32px;" src="/stage/loading-pure.svg"></div>',w("/api/search/searchRefBlock",{k:n.value,id:a?a.getAttribute("data-node-id"):e.block.parentID,beforeLen:Math.floor((Math.max(e.element.clientWidth/2,320)-58)/28.8),rootID:e.block.rootID},s=>{let o="";if(s.data.newDoc){const l=`((newFile "${i}"${p.Constants.ZWSP}'${s.data.k}${Lute.Caret}'))`;o+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${s.data.blocks.length===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(l)}"><div class="b3-list-item__first"><svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
<span class="b3-list-item__text">${window.siyuan.languages.newFile} <mark>${s.data.k}</mark></span></div></button>`}s.data.blocks.forEach((l,r)=>{const c=`<span data-type="block-ref" data-id="${l.id}" data-subtype="s">${i}</span>`;o+=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two${r===0?" b3-list-item--focus":""}" data-value="${encodeURIComponent(c)}">
${md(l)}
</button>`}),o===""&&(o=`<button style="width: calc(100% - 16px)" class="b3-list-item b3-list-item--two" data-value="">${window.siyuan.languages.emptyContent}</button>`),this.element.lastElementChild.innerHTML=o,ke(this.element,parseInt(this.element.style.left),parseInt(this.element.style.right))})}genEmojiHTML(e,n=""){if(n&&!this.enableEmoji)return;const a=this.element.querySelector(".emojis__panel");a?(a.innerHTML=io(n,256),n?a.nextElementSibling.classList.add("fn__none"):a.nextElementSibling.classList.remove("fn__none"),ao(a)):(this.element.innerHTML=`<div style="padding: 0;${n?"":"height:402px"}" class="emojis">
<div class="emojis__panel">${io(n,256)}</div>
<div class="fn__flex${n?" fn__none":""}">
    <button data-type="0" class="emojis__type ariaLabel" aria-label="${window.siyuan.languages.recentEmoji}">${ie("2b50")}</button>
    <button data-type="1" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[0][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f527")}</button>
    <button data-type="2" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[1][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f60d")}</button>
    <button data-type="3" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[2][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f433")}</button>
    <button data-type="4" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[3][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f96a")}</button>
    <button data-type="5" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[4][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f3a8")}</button>
    <button data-type="6" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[5][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f3dd")}</button>
    <button data-type="7" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[6][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f52e")}</button>
    <button data-type="8" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[7][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("267e")}</button>
    <button data-type="9" class="emojis__type ariaLabel" aria-label="${window.siyuan.emojis[8][window.siyuan.config.lang==="zh_CN"?"title_zh_cn":"title"]}">${ie("1f6a9")}</button>
</div>
</div>`,Rl(this.element),ao(this.element));const i=this.element.querySelector(".emojis__item");if(i){i.classList.add("emojis__item--current"),this.element.classList.remove("fn__none"),this.element.style.width=Math.max(e.element.clientWidth/2,320)+"px";const s=$n(e.wysiwyg.element);ke(this.element,s.left,s.top+26,30),this.element.querySelector(".emojis__panel").scrollTop=0}else this.element.classList.add("fn__none")}fill(e,n,a=!0,i=!1){X(["hint","toolbar"],n),a&&this.source!=="av"&&(n.toolbar.range=re(n.wysiwyg.element));const s=n.toolbar.range;let o=x(n.toolbar.range.startContainer);if(!o)return;if(this.source==="av"){const d=A(n.toolbar.range.startContainer,"av__cell");if(!d)return;const u=A(d,"av__row");if(!u)return;const f=d.dataset.blockId,g=o.getAttribute("data-av-id");let h=document.createElement("div");if(h.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),h=h.firstElementChild,e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){const m=e.substring(11,e.length-4).split(`"${p.Constants.ZWSP}'`),b=m.length===1?m[0]:m[1],y=Lute.NewNodeID();u.dataset.id=y,od(n.path,n.notebookId,_=>{w("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:Le().join(_,b),parentID:n.block.rootID,markdown:"",id:y},()=>{F(n,[{action:"replaceAttrViewBlock",avID:g,previousID:f,nextID:y,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:g,previousID:y,nextID:f,isDetached:!0}])})})}else{const m=h.getAttribute("data-id");u.dataset.id=m,F(n,[{action:"replaceAttrViewBlock",avID:g,previousID:f,nextID:m,isDetached:!1}],[{action:"replaceAttrViewBlock",avID:g,previousID:m,nextID:f,isDetached:!0}])}return}this.enableExtend=!1;let l="";o&&(l=o.getAttribute("data-node-id"));const r=o.outerHTML,c=p.Constants.BLOCK_HINT_CLOSE_KEYS[this.splitChar];if(p.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&c&&s.startContainer.nodeType===3&&s.startContainer.wholeText.indexOf(c)>-1&&s.startContainer.wholeText.indexOf(this.splitChar)>-1){let d=0,u=s.startContainer;for(;u&&d<2;){const f=u.textContent.indexOf(c),g=u.textContent.indexOf(this.splitChar);if(f>-1&&(f<g||g<0)){d=2,s.setEnd(u,f+2);break}const h=u.textContent.indexOf(c.substr(1));if(h>-1&&(d+=1),d===2){s.setEnd(u,h+1);break}u=u.nextSibling}}if(this.lastIndex>-1&&(s.setStart(s.startContainer,this.lastIndex),et()&&Z(s)),p.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&e.startsWith("((newFile ")&&e.endsWith(`${Lute.Caret}'))`)){Z(s);const d=e.substring(11,e.length-4).split(`"${p.Constants.ZWSP}'`),u=d.length===1?d[0]:d[1];od(n.path,n.notebookId,f=>{w("/api/filetree/createDocWithMd",{notebook:n.notebookId,path:Le().join(f,u),parentID:n.block.rootID,markdown:""},g=>{n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${g.data}${p.Constants.ZWSP}${i?"s":"d"}${p.Constants.ZWSP}${(i?d[0]:u).substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen)}`})})});return}if(p.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)){if(e===""){const u=ae(o);u.textContent===""&&(u.innerHTML="<wbr>",fe(u,s));return}let d=document.createElement("div");if(d.innerHTML=e.replace(/<mark>/g,"").replace(/<\/mark>/g,""),d=d.firstElementChild,i){const u=s.toString().replace(this.splitChar,"");u&&(d.setAttribute("data-subtype","s"),d.innerText=u)}else{d.setAttribute("data-subtype","d");const u=d.innerText.split(p.Constants.ZWSP);u.length===2&&(d.innerText=u[1])}n.toolbar.setInlineMark(n,"block-ref","range",{type:"id",color:`${d.getAttribute("data-id")}${p.Constants.ZWSP}${d.getAttribute("data-subtype")}${p.Constants.ZWSP}${d.textContent}`});return}else if(this.splitChar===":"){ui(e);let d;e.indexOf(".")>-1?d=`:${e.split(".")[0]}: `:d=ie(e)+" ",wt(n.lute.SpinBlockDOM(d),n)}else if(["\u300C\u300C","\u300C\u300E","\u300E\u300C","\u300E\u300E","{{"].includes(this.splitChar)||this.splitChar==="#"||this.splitChar===":"){if(e===""){const d=ae(o);d.textContent===""&&(d.innerHTML="<wbr>",fe(d,s));return}wt(n.lute.SpinBlockDOM(e),n,!1,(0,I.tq)()),Be(n,n.wysiwyg.element);return}else if(this.splitChar==="/"||this.splitChar==="\u3001")if(this.enableExtend=!0,e==="(("||e==="{{"){e==="(("?Va("",n,"hint"):rs("",n),this.splitChar=e,this.lastIndex=0,s.deleteContents();const d=document.createTextNode(e);s.insertNode(d),s.setEnd(d,e.length),s.collapse(!1);return}else if(e===p.Constants.ZWSP){s.deleteContents(),this.fixImageCursor(s),n.toolbar.showTpl(n,o,s),J(n,l,o.outerHTML,r);return}else if(e===p.Constants.ZWSP+1){s.deleteContents(),this.fixImageCursor(s),n.toolbar.showWidget(n,o,s),J(n,l,o.outerHTML,r);return}else if(e===p.Constants.ZWSP+2){s.deleteContents(),this.fixImageCursor(s),n.toolbar.range=s;const d=$n(o,s);Bd(n,{x:d.left,y:d.top+26,w:0,h:26}),J(n,l,o.outerHTML,r);return}else if(e===p.Constants.ZWSP+3){s.deleteContents();return}else if(e===p.Constants.ZWSP+4){const d=Lute.NewNodeID();w("/api/filetree/createDoc",{notebook:n.notebookId,path:Le().join(ft(n.path,!1,!0),d+".sy"),title:"Untitled",md:""},()=>{wt(`<span data-type="block-ref" data-id="${d}" data-subtype="d">Untitled</span>`,n),de({app:n.app,id:d,action:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT]})});return}else if(e===p.Constants.ZWSP+5){s.deleteContents(),LE(n,o);return}else if(p.Constants.INLINE_TYPE.includes(e)){if(s.deleteContents(),Z(s),["a","block-ref","inline-math","inline-memo","text"].includes(e)){n.toolbar.element.querySelector(`[data-type="${e}"]`).dispatchEvent(new CustomEvent("click"));return}n.toolbar.setInlineMark(n,e,"range");return}else if(e==="emoji"){s.deleteContents(),s.insertNode(document.createTextNode(":")),s.collapse(!1),this.genEmojiHTML(n);return}else if(e.indexOf("style")>-1){s.deleteContents(),this.fixImageCursor(s),o.setAttribute("style",e.split(p.Constants.ZWSP)[1]||""),J(n,l,o.outerHTML,r);return}else if(e.startsWith("plugin")){n.app.plugins.find(d=>{const u=e.split(p.Constants.ZWSP);if(u[1]===d.name)return d.protyleSlash.find(f=>{if(f.id===u[2])return f.callback(n.getInstance()),!0}),!0});return}else{s.deleteContents(),e!=="![]()"&&this.fixImageCursor(s);let d=e;e==="```"&&(d=e+window.siyuan.storage[p.Constants.LOCAL_CODELANG]+Lute.Caret+"\n```");const u=ae(o);if(e==="![]()"){let f="";s.insertNode(document.createElement("wbr")),s.insertNode(document.createTextNode(e)),f=n.lute.SpinBlockDOM(o.outerHTML),o.outerHTML=f,o=n.wysiwyg.element.querySelector(`[data-node-id="${l}"]`),fe(o,s),J(n,l,o.outerHTML,r);let g=s.startContainer.childNodes[s.startOffset-1]||s.startContainer;g&&g.nodeType!==3&&g.classList.contains("img")||(g.previousSibling?.nodeType!==3&&g.previousSibling.classList.contains("img")?g=g.previousSibling:Array.from(o.querySelectorAll(".img")).find(m=>{if(m.querySelector("img").getAttribute("data-src")==="")return g=m,!0}));const h=g.getBoundingClientRect();Wd(n,s,g,{clientX:h.left,clientY:h.top});return}else if(u.textContent===""&&o.getAttribute("data-type")==="NodeParagraph"){let f="";e==="<div>"?f=`<div data-node-id="${l}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${wa()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${p.Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`:(u.textContent=d,f=n.lute.SpinBlockDOM(o.outerHTML)),o.outerHTML=f,o=n.wysiwyg.element.querySelector(`[data-node-id="${l}"]`),o.getAttribute("data-type")==="NodeTable"&&(o.querySelectorAll("colgroup col").forEach(g=>{g.style.minWidth="60px"}),f=o.outerHTML),J(n,l,f,r)}else{let f=n.lute.SpinBlockDOM(d);e==="<div>"&&(f=`<div data-node-id="${Lute.NewNodeID()}" data-type="NodeHTMLBlock" class="render-node" data-subtype="block">${wa()}<div><protyle-html data-content=""></protyle-html><span style="position: absolute">${p.Constants.ZWSP}</span></div><div class="protyle-attr" contenteditable="false"></div></div>`),o.insertAdjacentHTML("afterend",f);const g=o.outerHTML,h=f.substr(f.indexOf('data-node-id="')+14,22);o=n.wysiwyg.element.querySelector(`[data-node-id="${h}"]`),o.getAttribute("data-type")==="NodeTable"&&o.querySelectorAll("colgroup col").forEach(m=>{m.style.minWidth="60px"}),F(n,[{data:g,id:l,action:"update"},{data:o.outerHTML,id:h,previousID:l,action:"insert"}],[{id:h,action:"delete"},{data:r,id:l,action:"update"}])}if(e==="<div>"||e==="$$"||e.indexOf("```")>-1&&e.length>3)n.toolbar.showRender(n,o),bt(o);else if(e.startsWith("```"))qe(o);else if(e.startsWith("<iframe")||e.startsWith("<video")||e.startsWith("<audio")){n.gutter.renderMenu(n,o);const f=o.getBoundingClientRect();window.siyuan.menus.menu.popup({x:f.left,y:f.top,isLeft:!0});const g=window.siyuan.menus.menu.element.querySelector('[data-id="assetSubMenu"]');g.classList.add("b3-menu__item--show"),window.siyuan.menus.menu.showSubMenu(g.querySelector(".b3-menu__submenu")),window.siyuan.menus.menu.element.querySelector("textarea").focus()}else e==="---"?le(o):o.classList.contains("av")?mt(o,n):fe(o,s)}}select(e,n){const a=this.element.firstElementChild.classList.contains("emojis");if(this.element.querySelectorAll("button").length===0&&!a)return!1;if(e.key==="Enter"){if(a){const i=this.element.querySelector(".emojis__item--current");if(!i)return!1;const s=i.getAttribute("data-unicode");if(this.element.querySelectorAll(".emojis__title").length>2){const o=getSelection().getRangeAt(0);o.endContainer.nodeType!==3&&o.endContainer.childNodes[o.endOffset-1]?.remove(),ui(s);let l;s.indexOf(".")>-1?l=`:${s.split(".")[0]}: `:l=ie(s)+" ",wt(n.lute.SpinBlockDOM(l),n),this.element.classList.add("fn__none")}else this.fill(s,n)}else{const i=decodeURIComponent(this.element.querySelector(".b3-list-item--focus").getAttribute("data-value"));i===p.Constants.ZWSP+3?this.element.querySelector(".b3-list-item--focus input").click():this.fill(i,n,!0,O(e))}return e.preventDefault(),e.stopPropagation(),!0}if(a){const i=this.element.querySelector(".emojis__item--current");if(!i)return!1;let s;if(e.key==="ArrowLeft"||e.key==="ArrowUp"?i.previousElementSibling?(i.classList.remove("emojis__item--current"),s=i.previousElementSibling):i.parentElement.previousElementSibling?.previousElementSibling&&(i.classList.remove("emojis__item--current"),s=i.parentElement.previousElementSibling.previousElementSibling.lastElementChild):(e.key==="ArrowRight"||e.key==="ArrowDown")&&(i.nextElementSibling?(i.classList.remove("emojis__item--current"),s=i.nextElementSibling):i.parentElement.nextElementSibling?.nextElementSibling&&(i.classList.remove("emojis__item--current"),s=i.parentElement.nextElementSibling.nextElementSibling.firstElementChild)),s){s.classList.add("emojis__item--current");const o=4,l=this.element.querySelector(".emojis__panel");s.offsetTop-o<l.scrollTop?l.scrollTop=s.offsetTop-o:s.offsetTop-o-l.clientHeight+s.clientHeight>l.scrollTop&&(l.scrollTop=s.offsetTop-o-l.clientHeight+s.clientHeight)}return e.preventDefault(),e.stopPropagation(),!0}else if(e.key==="ArrowDown"||e.key==="ArrowUp")return Bn(this.element.firstElementChild,e),e.preventDefault(),e.stopPropagation(),!0;return e.key==="ArrowLeft"||e.key==="ArrowRight"?(X(["hint"],n),e.preventDefault(),e.stopPropagation(),!0):!1}fixImageCursor(e){const n=Ke(e.startContainer);n&&n.nodeType!==3&&n.classList.contains("img")&&(rt(n)||(e.insertNode(document.createTextNode(p.Constants.ZWSP)),e.collapse(!1)))}getKey(e,n){if(this.lastIndex=-1,this.splitChar="",n.forEach(s=>{let o=e.lastIndexOf(s.key);p.Constants.BLOCK_HINT_KEYS.includes(s.key)&&o>-1&&e.lastIndexOf(s.key+s.key.substring(0,1))>-1&&(o=Math.min(o,e.lastIndexOf(s.key+s.key.substring(0,1)))),this.lastIndex<o&&(p.Constants.BLOCK_HINT_KEYS.includes(this.splitChar)&&(s.key===":"||s.key==="#"||s.key==="/"||s.key==="\u3001")||this.splitChar==="#"&&(s.key==="/"||s.key==="\u3001")||(this.splitChar=s.key,this.lastIndex=o))}),this.lastIndex===-1)return;this.splitChar===":"&&(this.enableEmoji=!(/\d/.test(e.substr(this.lastIndex-1,1))||e.substr(this.lastIndex-1,2)==="::"));const a=e.split(this.splitChar),i=a[a.length-1];if(a.length>1&&i.trim()===i&&i.length<p.Constants.SIZE_TITLE)return this.splitChar==="\u3010\u3010"&&e.endsWith("\u3010\u3010\u3011")?"":i}}const xE=t=>{const e=Lute.New();if(e.SetSpellcheck(window.siyuan.config.editor.spellcheck),e.SetProtyleMarkNetImg(window.siyuan.config.editor.displayNetImgMark),e.SetFileAnnotationRef(!0),e.SetTextMark(!0),e.SetHeadingID(!1),e.SetYamlFrontMatter(!1),e.PutEmojis(t.emojis),e.SetEmojiSite(t.emojiSite),e.SetHeadingAnchor(t.headingAnchor),e.SetInlineMathAllowDigitAfterOpenMarker(!0),e.SetToC(!1),e.SetIndentCodeBlock(!1),e.SetParagraphBeginningSpace(!0),e.SetSetext(!1),e.SetFootnotes(!1),e.SetLinkRef(!1),e.SetSanitize(t.sanitize),e.SetChineseParagraphBeginningSpace(t.paragraphBeginningSpace),e.SetRenderListStyle(t.listStyle),e.SetImgPathAllowSpace(!0),e.SetKramdownIAL(!0),e.SetTag(!0),e.SetSuperBlock(!0),e.SetGitConflict(!0),e.SetMark(!0),e.SetSup(!0),e.SetSub(!0),e.SetProtyleWYSIWYG(!0),t.lazyLoadImage&&e.SetImageLazyLoading(t.lazyLoadImage),e.SetBlockRef(!0),window.siyuan.emojis[0].items.length>0){const n={};window.siyuan.emojis[0].items.forEach(a=>{n[a.keywords]=t.emojiSite+"/"+a.unicode}),e.PutEmojis(n)}return e},AE=(t,e)=>{if(typeof speechSynthesis>"u"||typeof SpeechSynthesisUtterance>"u")return;const n='<svg><use xlink:href="#iconPlay"></use></svg>',a='<svg><use xlink:href="#iconPause"></use></svg>';let i=document.querySelector(".protyle-speech");if(!i){i=document.createElement("div"),i.className="protyle-speech",document.body.insertAdjacentElement("beforeend",i);const s=()=>{const l=speechSynthesis.getVoices();let r,c;return l.forEach(d=>{d.lang===e.replace("_","-")&&(r=d),d.default&&(c=d)}),r||(r=c),r};speechSynthesis.onvoiceschanged!==void 0&&(speechSynthesis.onvoiceschanged=s);const o=s();i.onclick=()=>{if(i.className==="protyle-speech"){const l=new SpeechSynthesisUtterance(i.getAttribute("data-text"));l.voice=o,l.onend=()=>{i.className="protyle-speech",speechSynthesis.cancel(),i.innerHTML=n},speechSynthesis.speak(l),i.className="protyle-speech protyle-speech--current",i.innerHTML=a}else speechSynthesis.speaking&&(speechSynthesis.paused?(speechSynthesis.resume(),i.innerHTML=a):(speechSynthesis.pause(),i.innerHTML=n));Z(window.protyleSpeechRange)},document.body.addEventListener("click",()=>{getSelection().toString().trim()===""&&i.style.display==="block"&&(i.className="protyle-speech",speechSynthesis.cancel(),i.style.display="none")})}t.addEventListener("mouseup",s=>{const o=getSelection().toString().trim();if(speechSynthesis.cancel(),getSelection().toString().trim()===""){i.style.display==="block"&&(i.className="protyle-speech",i.style.display="none");return}window.protyleSpeechRange=getSelection().getRangeAt(0).cloneRange();const l=getSelection().getRangeAt(0).getBoundingClientRect();i.innerHTML=n,i.style.display="block",i.style.top=l.top+l.height+document.querySelector("html").scrollTop-20+"px",i.style.left=s.screenX+2+"px",i.setAttribute("data-text",o)})};class TE{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-preview fn__none";const n=document.createElement("div");n.className="b3-typography",e.options.classes.preview&&n.classList.add(e.options.classes.preview),e.wysiwyg.element.style.padding&&(n.style.padding=e.wysiwyg.element.style.padding);const a=e.options.preview.actions,i=document.createElement("div");i.className="protyle-preview__action";const s=[];for(let o=0;o<a.length;o++){const l=a[o];if(typeof l=="object"){s.push(`<button type="button" data-type="${l.key}" class="${l.className}">${l.text}</button>`);continue}switch(l){case"desktop":s.push(`<button type="button"${e.wysiwyg.element.style.padding?' class="protyle-preview__action--current"':""} data-type="desktop">Desktop</button>`);break;case"tablet":s.push('<button type="button" data-type="tablet">Tablet</button>');break;case"mobile":s.push('<button type="button" data-type="mobile">Mobile/Wechat</button>');break;case"mp-wechat":s.push('<button type="button" data-type="mp-wechat" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u516C\u4F17\u53F7"><svg><use xlink:href="#iconMp"></use></svg></button>');break;case"zhihu":s.push('<button type="button" data-type="zhihu" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u77E5\u4E4E"><svg><use xlink:href="#iconZhihu"></use></svg></button>');break;case"yuque":s.push('<button type="button" data-type="yuque" class="b3-tooltips b3-tooltips__w" aria-label="\u590D\u5236\u5230\u8BED\u96C0"><svg><use xlink:href="#iconYuque"></use></svg></button>');break}}i.innerHTML=s.join(""),this.element.appendChild(i),this.element.appendChild(n),this.element.addEventListener("click",o=>{e.model&&(Ze(e.model.element.parentElement.parentElement),Cu(Pe(),e.model.editor.protyle));let l=o.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){const r=l.getAttribute("href");if(r.startsWith("#")){n.querySelector(r).scrollIntoView(),o.stopPropagation(),o.preventDefault();break}if((0,I.tq)()){Ee(r),o.stopPropagation(),o.preventDefault();break}o.stopPropagation(),o.preventDefault(),es(r)?O(o)?fn(r,"folder"):o.shiftKey?fn(r,"app"):p.Constants.SIYUAN_ASSETS_EXTS.includes(Le().extname(r.split("?page")[0]))&&ks(e.app,r.split("?page")[0],parseInt((0,I.on)("page",r))):te.shell.openExternal(r).catch(c=>{M(c)});break}else if(l.tagName==="IMG"){pp(o.target.src,e.block.rootID),o.stopPropagation(),o.preventDefault();break}else if(l.tagName==="BUTTON"){const r=l.getAttribute("data-type"),c=a.find(d=>d?.key===r);c?c.click(r):r==="mp-wechat"||r==="zhihu"||r==="yuque"?this.copyToX(this.element.lastElementChild.cloneNode(!0),e,r):r==="desktop"?(n.style.width="",n.style.padding=e.wysiwyg.element.style.padding):r==="tablet"?(n.style.width="1024px",n.style.padding="8px 16px"):(n.style.width="360px",n.style.padding="8px"),r!=="mp-wechat"&&r!=="zhihu"&&r!=="yuque"&&(i.querySelectorAll("button").forEach(d=>{d.classList.remove("protyle-preview__action--current")}),l.classList.add("protyle-preview__action--current"))}l=l.parentElement}}),this.previewElement=n}render(e,n){if(this.element.style.display==="none")return;let a=this.element.querySelector(".fn__loading");a||(this.element.insertAdjacentHTML("beforeend",`<div style="flex-direction: column;" class="fn__loading">
    <img width="48px" src="/stage/loading-pure.svg">
</div>`),a=this.element.querySelector(".fn__loading")),this.mdTimeoutId=window.setTimeout(()=>{w("/api/export/preview",{id:e.block.parentID||e.options.blockId},i=>{const s=e.preview.previewElement.scrollTop;e.preview.previewElement.innerHTML=i.data.html,bt(e.preview.previewElement),qe(e.preview.previewElement),mt(e.preview.previewElement,e),AE(e.preview.previewElement,e.options.lang),e.preview.previewElement.scrollTop=s,i.data=i.data.outline,Pe().outline.forEach(o=>{(o.type==="pin"||o.type==="local"&&o.blockId===e.block.rootID)&&(o.isPreview=!0,o.update(i,e.block.rootID),o.type==="pin"&&o.updateDocTitle(e.background.ial))}),a.remove()})},e.options.preview.delay)}link2online(e){va("")||e.querySelectorAll("[href],[src]").forEach(n=>{const a=n.getAttribute("href")||n.getAttribute("src");if(a&&a.startsWith("assets/")){const i=p.Constants.ASSETS_ADDRESS+window.siyuan.user.userId+"/"+a;n.getAttribute("href")?n.setAttribute("href",i):n.setAttribute("src",i)}})}copyToX(e,n,a){if(a==="mp-wechat")this.link2online(e),e.querySelectorAll(".katex-html .base").forEach(o=>{o.style.display="initial"}),e.querySelectorAll("mjx-container > svg").forEach(o=>{o.setAttribute("width",parseInt(o.getAttribute("width"))*8+"px")});else if(a==="zhihu")this.link2online(e),e.querySelectorAll('[data-subtype="math"]').forEach(o=>{o.outerHTML=`<img class="Formula-image" data-eeimg="true" src="//www.zhihu.com/equation?tex=" alt="${o.getAttribute("data-content")}" style="${o.tagName==="DIV"?"display: block; max-width: 100%;":""}margin: 0 auto;">`}),e.querySelectorAll("blockquote").forEach(o=>{const l=[];this.processZHBlockquote(o,l),l.reverse().forEach(r=>{o.insertAdjacentElement("afterend",r)}),o.remove()}),this.processZHTable(e);else if(a==="yuque"){w("/api/lute/copyStdMarkdown",{id:n.block.rootID},o=>{G(o.data),M("\u5DF2\u590D\u5236\uFF0C\u53EF\u5230\u8BED\u96C0\u8FDB\u884C\u7C98\u8D34")});return}e.style.backgroundColor="#fff",e.querySelectorAll("code").forEach(o=>{o.style.backgroundImage="none"}),this.element.append(e);let i;getSelection().rangeCount>0&&(i=getSelection().getRangeAt(0).cloneRange());const s=e.ownerDocument.createRange();s.selectNodeContents(e),Z(s),document.execCommand("copy"),this.element.lastElementChild.remove(),Z(i),a&&M(`\u5DF2\u590D\u5236\uFF0C\u53EF\u5230${a==="zhihu"?"\u77E5\u4E4E":"\u5FAE\u4FE1\u516C\u4F17\u53F7\u5E73\u53F0"}\u8FDB\u884C\u7C98\u8D34`)}processZHBlockquote(e,n){Array.from(e.children).forEach(a=>{if(a.tagName==="BLOCKQUOTE")this.processZHBlockquote(a,n);else if(a.tagName!=="P"||a.querySelector("img"))n.push(a);else{const i=n[n.length-1];(!i||i&&i.tagName!=="BLOCKQUOTE")&&n.push(document.createElement("blockquote")),n[n.length-1].append(a)}})}processZHTable(e){e.querySelectorAll("table").forEach(n=>{const a=n.querySelector("thead");if(!a)return;const i=n.querySelector("tbody");i?i.insertAdjacentElement("afterbegin",a.firstElementChild):n.innerHTML=`<tbody>${a.innerHTML}</tbody>`,a.remove()})}}const tb=(...t)=>{const e={},n=a=>{for(const i in a)a.hasOwnProperty(i)&&(Object.prototype.toString.call(a[i])==="[object Object]"?e[i]=tb(e[i],a[i]):e[i]=a[i])};for(let a=0;a<t.length;a++)n(t[a]);return e};class IE{constructor(e){this.defaultOptions={mode:"wysiwyg",blockId:"",render:{background:!1,title:!1,gutter:!0,scroll:!1,breadcrumb:!0,breadcrumbDocName:!1},action:[],after:void 0,classes:{preview:""},debugger:p.Constants.NODE_ENV==="development",hint:{delay:200,emoji:{"+1":"\u{1F44D}","-1":"\u{1F44E}",confused:"\u{1F615}",eyes:"\u{1F440}\uFE0F",heart:"\u2764\uFE0F",rocket:"\u{1F680}\uFE0F",smile:"\u{1F604}",tada:"\u{1F389}\uFE0F"},emojiPath:"/emojis",extend:[{key:"((",hint:Va},{key:"\u3010\u3010",hint:Va},{key:"\uFF08\uFF08",hint:Va},{key:"[[",hint:Va},{key:"{{",hint:rs},{key:"\u300C\u300C",hint:rs},{key:"\u300C\u300E",hint:rs},{key:"\u300E\u300C",hint:rs},{key:"\u300E\u300E",hint:rs},{key:"#",hint:yy},{key:"/",hint:hd},{key:"\u3001",hint:hd},{key:":"}]},lang:window.siyuan.config.appearance.lang,preview:{actions:["desktop","tablet","mobile","mp-wechat","zhihu","yuque"],delay:0,markdown:{paragraphBeginningSpace:window.siyuan.config.export.paragraphBeginningSpace,listStyle:!1,sanitize:!0},mode:"both"},toolbar:(0,I.tq)()?["block-ref","a","|","text","strong","em","u","clear","|","code","tag","inline-math","inline-memo"]:["block-ref","a","|","text","strong","em","u","s","mark","sup","sub","clear","|","code","kbd","tag","inline-math","inline-memo"],typewriterMode:!1,upload:{max:1024*1024*1024*4,url:p.Constants.UPLOAD_ADDRESS,extraData:{},fieldName:"file[]",filename:n=>n.replace(/[\\/:*?"'<>|]/g,""),linkToImgUrl:"",withCredentials:!1}},this.options=e}merge(){return this.options&&(this.options.toolbar?this.options.toolbar=this.mergeToolbar(this.options.toolbar):this.options.toolbar=this.mergeToolbar(this.defaultOptions.toolbar),this.options.hint?.emoji&&(this.defaultOptions.hint.emoji=this.options.hint.emoji)),tb(this.defaultOptions,this.options)}mergeToolbar(e){const n=[{name:"block-ref",hotkey:window.siyuan.config.keymap.editor.insert.ref.custom,lang:"ref",icon:"iconRef",tipPosition:"ne"},{name:"a",hotkey:window.siyuan.config.keymap.editor.insert.link.custom,lang:"link",icon:"iconLink",tipPosition:"n"},{name:"strong",lang:"bold",hotkey:window.siyuan.config.keymap.editor.insert.bold.custom,icon:"iconBold",tipPosition:"n"},{name:"em",lang:"italic",hotkey:window.siyuan.config.keymap.editor.insert.italic.custom,icon:"iconItalic",tipPosition:"n"},{name:"u",lang:"underline",hotkey:window.siyuan.config.keymap.editor.insert.underline.custom,icon:"iconUnderline",tipPosition:"n"},{name:"s",lang:"strike",hotkey:window.siyuan.config.keymap.editor.insert.strike.custom,icon:"iconStrike",tipPosition:"n"},{name:"mark",lang:"mark",hotkey:window.siyuan.config.keymap.editor.insert.mark.custom,icon:"iconMark",tipPosition:"n"},{name:"sup",lang:"sup",hotkey:window.siyuan.config.keymap.editor.insert.sup.custom,icon:"iconSup",tipPosition:"n"},{name:"sub",lang:"sub",hotkey:window.siyuan.config.keymap.editor.insert.sub.custom,icon:"iconSub",tipPosition:"n"},{name:"kbd",lang:"kbd",hotkey:window.siyuan.config.keymap.editor.insert.kbd.custom,icon:"iconKeymap",tipPosition:"n"},{name:"tag",lang:"tag",hotkey:window.siyuan.config.keymap.editor.insert.tag.custom,icon:"iconTags",tipPosition:"n"},{name:"code",lang:"inline-code",hotkey:window.siyuan.config.keymap.editor.insert["inline-code"].custom,icon:"iconInlineCode",tipPosition:"n"},{name:"inline-math",lang:"inline-math",hotkey:window.siyuan.config.keymap.editor.insert["inline-math"].custom,icon:"iconMath",tipPosition:"n"},{name:"inline-memo",lang:"memo",hotkey:window.siyuan.config.keymap.editor.insert.memo.custom,icon:"iconM",tipPosition:"n"},{name:"text",lang:"appearance",hotkey:window.siyuan.config.keymap.editor.insert.appearance.custom,icon:"iconFont",tipPosition:"n"},{name:"clear",lang:"clearInline",hotkey:window.siyuan.config.keymap.editor.insert.clearInline.custom,icon:"iconClear",tipPosition:"n"},{name:"|"}],a=[];return e.forEach(i=>{let s=i;n.find(o=>{if(typeof i=="string"&&o.name===i)return s=o,!0;if(typeof i=="object"&&o.name===i.name)return s=Object.assign({},o,i),!0}),a.push(s)}),a}}class DE{constructor(e){this.parentElement=document.createElement("div"),this.parentElement.classList.add("protyle-scroll"),(0,I.tq)()||(this.parentElement.style.right="10px"),this.parentElement.innerHTML=`<div class="b3-tooltips b3-tooltips__w protyle-scroll__up" aria-label="${K("\u2318Home")}">
    <svg><use xlink:href="#iconUp"></use></svg>
</div>
<div class="fn__none protyle-scroll__bar b3-tooltips b3-tooltips__s" aria-label="Blocks 1/1">
    <input class="b3-slider" type="range" max="1" min="1" step="1" value="1" />
</div>
<div class="b3-tooltips b3-tooltips__w protyle-scroll__down" aria-label="${K("\u2318End")}">
    <svg><use xlink:href="#iconDown"></use></svg>
</div>`,this.element=this.parentElement.querySelector(".protyle-scroll__bar"),this.keepLazyLoad=!1,e.options.render.scroll||this.parentElement.classList.add("fn__none"),this.lastScrollTop=0,this.inputElement=this.element.firstElementChild,this.inputElement.addEventListener("input",()=>{this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)}),this.parentElement.addEventListener("click",n=>{const a=n.target;A(a,"protyle-scroll__up")?hg(e):A(a,"protyle-scroll__down")?mg(e):a.classList.contains("b3-slider")&&this.setIndex(e)})}setIndex(e){e.wysiwyg.element.getAttribute("data-top")||(e.wysiwyg.element.setAttribute("data-top",e.wysiwyg.element.scrollTop.toString()),w("/api/filetree/getDoc",{index:parseInt(this.inputElement.value),id:e.block.parentID,mode:0,size:window.siyuan.config.editor.dynamicLoadBlocks},n=>{st({data:n,protyle:e,action:[p.Constants.CB_GET_FOCUSFIRST,p.Constants.CB_GET_UNCHANGEID]})}))}updateIndex(e,n){w("/api/block/getBlockIndex",{id:n},a=>{if(!a.data)return;const i=e.scroll.element.querySelector(".b3-slider");i.value=a.data,e.scroll.element.setAttribute("aria-label",`Blocks ${a.data}/${e.block.blockCount}`)})}update(e){typeof e.block.blockCount=="number"&&(this.inputElement.setAttribute("max",e.block.blockCount.toString()),this.element.setAttribute("aria-label",`Blocks ${this.inputElement.value}/${e.block.blockCount}`)),e.block.showAll?this.element.classList.add("fn__none"):e.block.scroll?this.element.classList.remove("fn__none"):this.element.classList.add("fn__none")}}const nb=(t,e,n,a,i,s,o)=>{let l;const r=n.getAttribute("data-node-id"),c=a.getAttribute("data-node-id"),d=[],u=[];return n.insertAdjacentElement(s?"afterend":"beforebegin",a),s?d.push({action:"insert",data:a.outerHTML,id:c,previousID:r}):d.push({action:"insert",data:a.outerHTML,id:c,nextID:r}),e.reverse().forEach((f,g)=>{const h=f.getAttribute("data-node-id");g===e.length-1&&(l=be(f),l.isSameNode(f)&&(l=void 0));const m=Lute.NewNodeID();if(o?u.push({action:"delete",id:m}):u.push({action:"move",id:h,previousID:f.previousElementSibling?.getAttribute("data-node-id"),parentID:f.parentElement.getAttribute("data-node-id")||t.block.rootID}),!i&&!o){const b=t.wysiwyg.element.querySelector(`[data-node-id="${h}"]`);b&&b.remove()}if(o){const b=f.cloneNode(!0);b.setAttribute("data-node-id",m),b.querySelectorAll("[data-node-id]").forEach(y=>{const _=Lute.NewNodeID();y.setAttribute("data-node-id",_),y.setAttribute("updated",_.split("-")[0])}),a.insertAdjacentElement("afterbegin",b),d.push({action:"insert",id:m,data:b.outerHTML,parentID:c})}else a.insertAdjacentElement("afterbegin",f),d.push({action:"move",id:h,parentID:c})}),u.reverse(),a.getAttribute("data-subtype")==="o"&&(u.splice(0,0,{action:"update",id:c,data:a.outerHTML}),it(a,1),d.push({action:"update",id:c,data:a.outerHTML})),u.push({action:"delete",id:c}),{doOperations:d,undoOperations:u,topSourceElement:l}},ab=async(t,e,n,a,i,s)=>{let o;const l=[],r=[],c=[],d=n.getAttribute("data-node-id");let u=n;e.reverse().forEach((f,g)=>{const h=f.getAttribute("data-node-id"),m=f.parentElement.getAttribute("data-node-id")||t.block.rootID;g===e.length-1&&(o=be(f),o.isSameNode(f)?o=void 0:o.contains(f)&&o.contains(n)&&(o=n)),s&&f.getAttribute("data-type")==="NodeHeading"&&f.getAttribute("fold")==="1"&&(f.removeAttribute("fold"),c.push({id:h,parentID:m}));let b,y;if(s?(b=Lute.NewNodeID(),r.push({action:"delete",id:b})):r.push({action:"move",id:h,previousID:f.previousElementSibling?.getAttribute("data-node-id"),parentID:m}),!a&&!s){const _=t.wysiwyg.element.querySelector(`[data-node-id="${h}"]`);_&&_.remove()}s?(y=f.cloneNode(!0),y.setAttribute("data-node-id",b),y.querySelectorAll("[data-node-id]").forEach(_=>{const v=Lute.NewNodeID();_.setAttribute("data-node-id",v),_.setAttribute("updated",v.split("-")[0])}),u.insertAdjacentElement(i,y),l.push({action:"insert",id:b,data:y.outerHTML,previousID:i==="afterend"?d:y.previousElementSibling?.getAttribute("data-node-id"),parentID:y.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID})):(u.insertAdjacentElement(i,f),l.push({action:"move",id:h,previousID:i==="afterend"?d:f.previousElementSibling?.getAttribute("data-node-id"),parentID:f.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID})),i!=="afterend"&&(u=s?y:f)}),r.reverse();for(let f=0;f<c.length;f++){const g=c[f];(await lt("/api/block/getHeadingChildrenIDs",{id:g.id})).data.reverse().forEach(m=>{r.push({action:"move",id:m,previousID:g.id,parentID:g.parentID})}),r.push({action:"foldHeading",id:g.id,data:"remove"}),l.push({action:"unfoldHeading",id:g.id})}return{doOperations:l,undoOperations:r,topSourceElement:o}},ib=async(t,e,n,a,i,s)=>{const o=t.element.contains(e[0]);let l;e[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(l=document.createElement("div"),l.setAttribute("data-node-id",Lute.NewNodeID()),l.setAttribute("data-type","NodeList"),l.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),l.className="list",l.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`));const r=[{action:"move",id:n.getAttribute("data-node-id"),previousID:n.previousElementSibling?.getAttribute("data-node-id"),parentID:n.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}];let c,d=e[0].parentElement;const u=Kf(i);n.parentElement.replaceChild(u,n);const f=[{action:"insert",data:u.outerHTML,id:u.getAttribute("data-node-id"),nextID:u.nextElementSibling?.getAttribute("data-node-id"),previousID:u.previousElementSibling?.getAttribute("data-node-id"),parentID:u.parentElement.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}];if(l){const g=l.getAttribute("data-node-id");u.insertAdjacentElement("afterbegin",n),f.push({action:"move",id:n.getAttribute("data-node-id"),parentID:u.getAttribute("data-node-id")}),a?(n.insertAdjacentElement("afterend",l),f.push({action:"insert",data:l.outerHTML,id:g,previousID:n.getAttribute("data-node-id")})):(n.insertAdjacentElement("beforebegin",l),f.push({action:"insert",data:l.outerHTML,id:g,nextID:n.getAttribute("data-node-id")})),e.reverse().forEach((h,m)=>{m===e.length-1&&(c=be(h),c.isSameNode(h)&&(c=void 0));const b=Lute.NewNodeID();if(s?r.push({action:"delete",id:b}):r.push({action:"move",id:h.getAttribute("data-node-id"),previousID:h.previousElementSibling?.getAttribute("data-node-id"),parentID:h.parentElement.getAttribute("data-node-id")||t.block.rootID}),!o&&!s){const y=t.wysiwyg.element.querySelector(`[data-node-id="${h.getAttribute("data-node-id")}"]`);y&&y.remove()}if(s){const y=h.cloneNode(!0);y.setAttribute("data-node-id",b),y.querySelectorAll("[data-node-id]").forEach(_=>{const v=Lute.NewNodeID();_.setAttribute("data-node-id",v),_.setAttribute("updated",v.split("-")[0])}),l.insertAdjacentElement("afterbegin",y),f.push({action:"insert",id:b,data:y.outerHTML,parentID:g})}else l.insertAdjacentElement("afterbegin",h),f.push({action:"move",id:h.getAttribute("data-node-id"),parentID:g})}),r.reverse(),r.push({action:"delete",id:g})}else{const g=[];let h;e.reverse().forEach((m,b)=>{const y=m.getAttribute("data-node-id"),_=m.parentElement.getAttribute("data-node-id")||t.block.rootID;b===e.length-1&&(c=be(m),c.isSameNode(m)&&(c=void 0));const v=Lute.NewNodeID();if(b===0&&(h=s?v:y),s&&m.getAttribute("data-type")==="NodeHeading"&&m.getAttribute("fold")==="1"&&(m.removeAttribute("fold"),g.push({id:y,parentID:_})),s?r.push({action:"delete",id:v}):r.push({action:"move",id:y,previousID:m.previousElementSibling?.getAttribute("data-node-id"),parentID:_}),!o&&!s){const k=t.wysiwyg.element.querySelector(`[data-node-id="${y}"]`);k&&k.remove()}if(s){const k=m.cloneNode(!0);k.setAttribute("data-node-id",v),k.querySelectorAll("[data-node-id]").forEach(L=>{const C=Lute.NewNodeID();L.setAttribute("data-node-id",C),L.setAttribute("updated",C.split("-")[0])}),u.insertAdjacentElement("afterbegin",k),f.push({action:"insert",id:v,data:k.outerHTML,parentID:u.getAttribute("data-node-id")})}else u.insertAdjacentElement("afterbegin",m),f.push({action:"move",id:y,parentID:u.getAttribute("data-node-id")})}),r.reverse();for(let m=0;m<g.length;m++){const b=g[m],y=await lt("/api/block/getHeadingChildrenIDs",{id:b.id});y.data.reverse().forEach(_=>{r.push({action:"move",id:_,previousID:b.id,parentID:b.parentID})}),m===0&&(h=y.data[0]),r.push({action:"foldHeading",id:b.id,data:"remove"}),f.push({action:"unfoldHeading",id:b.id})}a?(u.insertAdjacentElement("afterbegin",n),f.push({action:"move",id:n.getAttribute("data-node-id"),parentID:u.getAttribute("data-node-id")})):(u.lastElementChild.insertAdjacentElement("beforebegin",n),f.push({action:"move",id:n.getAttribute("data-node-id"),previousID:h}))}if(r.push({action:"delete",id:u.getAttribute("data-node-id")}),!s&&d&&d.classList.contains("list")&&d.getAttribute("data-subtype")==="o"&&!d.isSameNode(e[0].parentElement)&&d.childElementCount>1&&(Array.from(d.children).forEach(g=>{g.classList.contains("protyle-attr")||r.splice(0,0,{action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})}),it(d,1),Array.from(d.children).forEach(g=>{g.classList.contains("protyle-attr")||f.push({action:"update",id:g.getAttribute("data-node-id"),data:g.outerHTML})})),!s&&c){if(f.push({action:"delete",id:c.getAttribute("data-node-id")}),r.splice(0,0,{action:"insert",data:c.outerHTML,id:c.getAttribute("data-node-id"),previousID:c.previousElementSibling?.getAttribute("data-node-id"),parentID:c.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}),!o){const g=t.wysiwyg.element.querySelector(`[data-node-id="${c.getAttribute("data-node-id")}"]`);g&&g.remove()}d=c.parentElement,c.remove()}if(!s&&d&&d.classList.contains("sb")&&d.childElementCount===2){const g=ns(t,d);f.push(g.doOperations[0],g.doOperations[1]),r.splice(0,0,g.undoOperations[0],g.undoOperations[1])}else if(!s&&d&&d.classList.contains("protyle-wysiwyg")&&d.innerHTML===""){const g=A(d,"protyle",!0);if(g&&!g.classList.contains("block__edit")){const h=Lt(g.getAttribute("data-id"));if(h&&h.model instanceof dt&&h.model.editor.protyle.block.id===h.model.editor.protyle.block.rootID){const m=Lute.NewNodeID();f.splice(0,0,{action:"insert",id:m,data:Cn(!1,!1,m).outerHTML,parentID:h.model.editor.protyle.block.parentID}),r.splice(0,0,{action:"delete",id:m})}}}o||s?F(t,f,r):F(t,f),le(e[0])},sb=async(t,e,n,a,i)=>{const s=t.element.contains(e[0]),o=[],l=[];let r;e[0].getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-type")!=="NodeListItem"&&(r=document.createElement("div"),r.setAttribute("data-node-id",Lute.NewNodeID()),r.setAttribute("data-type","NodeList"),r.setAttribute("data-subtype",e[0].getAttribute("data-subtype")),r.className="list",r.insertAdjacentHTML("beforeend",`<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div>`));let c,d=e[0].parentElement;if(a)if(r){const u=nb(t,e,n,r,s,a,i);o.push(...u.doOperations),l.push(...u.undoOperations),c=u.topSourceElement}else{const u=await ab(t,e,n,s,"afterend",i);o.push(...u.doOperations),l.push(...u.undoOperations),c=u.topSourceElement}else if(r){const u=nb(t,e,n,r,s,a,i);o.push(...u.doOperations),l.push(...u.undoOperations),c=u.topSourceElement}else{const u=await ab(t,e,n,s,"beforebegin",i);o.push(...u.doOperations),l.push(...u.undoOperations),c=u.topSourceElement}if(n.getAttribute("data-type")==="NodeListItem"&&n.getAttribute("data-subtype")==="o"&&(Array.from(n.parentElement.children).forEach(u=>{u.classList.contains("protyle-attr")||l.splice(0,0,{action:"update",id:u.getAttribute("data-node-id"),data:u.outerHTML})}),it(n.parentElement,1),Array.from(n.parentElement.children).forEach(u=>{u.classList.contains("protyle-attr")||o.push({action:"update",id:u.getAttribute("data-node-id"),data:u.outerHTML})})),!i&&s&&d&&d.classList.contains("list")&&d.getAttribute("data-subtype")==="o"&&!d.isSameNode(e[0].parentElement)&&d.childElementCount>1&&(Array.from(d.children).forEach(u=>{u.classList.contains("protyle-attr")||(d.contains(n)?l.splice(0,0,{action:"update",id:u.getAttribute("data-node-id"),data:u.outerHTML}):l.splice(n.parentElement.childElementCount-1,0,{action:"update",id:u.getAttribute("data-node-id"),data:u.outerHTML}))}),it(d,1),Array.from(d.children).forEach(u=>{u.classList.contains("protyle-attr")||o.push({action:"update",id:u.getAttribute("data-node-id"),data:u.outerHTML})})),!i&&c&&(o.push({action:"delete",id:c.getAttribute("data-node-id")}),l.splice(0,0,{action:"insert",data:c.outerHTML,id:c.getAttribute("data-node-id"),previousID:c.previousElementSibling?.getAttribute("data-node-id"),parentID:c.parentElement?.getAttribute("data-node-id")||t.block.parentID||t.block.rootID}),d=c.parentElement,c.remove(),!s)){const u=t.wysiwyg.element.querySelector(`[data-node-id="${c.getAttribute("data-node-id")}"]`);u&&u.remove()}if(!i&&d&&d.classList.contains("sb")&&d.childElementCount===2){const u=ns(t,d);o.push(u.doOperations[0],u.doOperations[1]),l.splice(0,0,u.undoOperations[0],u.undoOperations[1])}else if(!i&&d&&d.classList.contains("protyle-wysiwyg")&&d.childElementCount===0){const u=A(d,"protyle",!0);if(u&&!u.classList.contains("block__edit")){const f=Lt(u.getAttribute("data-id"));if(f&&f.model instanceof dt&&f.model.editor.protyle.block.id===f.model.editor.protyle.block.rootID){const g=Lute.NewNodeID();o.splice(0,0,{action:"insert",id:g,data:Cn(!1,!1,g).outerHTML,parentID:f.model.editor.protyle.block.parentID}),l.splice(0,0,{action:"delete",id:g})}}}s||i?F(t,o,l):F(t,o),le(e[0])},$E=(t,e)=>{e.addEventListener("dragstart",i=>{const s=i.target;if(s.tagName==="IMG"){window.siyuan.dragElement=void 0,i.preventDefault();return}if(s.classList){if(A(s,"protyle-wysiwyg__embed"))window.siyuan.dragElement=void 0,i.preventDefault();else if(s.classList.contains("protyle-action")){window.siyuan.dragElement=t.wysiwyg.element,i.dataTransfer.setData(`${p.Constants.SIYUAN_DROP_GUTTER}NodeListItem${p.Constants.ZWSP}${s.parentElement.getAttribute("data-subtype")}${p.Constants.ZWSP}${[s.parentElement.getAttribute("data-node-id")]}`,t.wysiwyg.element.innerHTML);return}else if(s.classList.contains("av__cellheader")){window.siyuan.dragElement=s.parentElement,i.dataTransfer.setData(`${p.Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${p.Constants.ZWSP}Col${p.Constants.ZWSP}${[s.parentElement.getAttribute("data-col-id")]}`,s.innerHTML);return}}i.dataTransfer.setData(p.Constants.SIYUAN_DROP_EDITOR,p.Constants.SIYUAN_DROP_EDITOR),t.element.style.userSelect="auto",document.onmousemove=null,document.onmouseup=null}),e.addEventListener("drop",async i=>{if(t.disabled||i.dataTransfer.getData(p.Constants.SIYUAN_DROP_EDITOR)){i.preventDefault(),i.stopPropagation();return}let s="";for(const l of i.dataTransfer.items)l.type.startsWith(p.Constants.SIYUAN_DROP_GUTTER)&&(s=l.type);const o=e.querySelector(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top");if(o&&(o.classList.remove("protyle-wysiwyg--select"),o.removeAttribute("select-start"),o.removeAttribute("select-end")),s){const l=[],r=s.replace(p.Constants.SIYUAN_DROP_GUTTER,"").split(p.Constants.ZWSP),c=r[2].split(",");if(i.altKey){Z($u(i.clientX,i.clientY));let d="";for(let u=0;u<c.length;u++){const f=await lt("/api/block/getRefText",{id:c[u]});d+=`((${c[u]} '${f.data}')) `}wt(d,t)}else if(i.shiftKey){Z($u(i.clientX,i.clientY));let d="";c.forEach(u=>{d+=`{{select * from blocks where id='${u}'}}
`}),wt(t.lute.SpinBlockDOM(d),t,!0),Be(t,t.wysiwyg.element)}else if(o&&o.className.indexOf("dragover__")>-1){let d="";if(c.forEach(g=>{d+=`[data-node-id="${g}"],`}),window.siyuan.dragElement)window.siyuan.dragElement.querySelectorAll(d.substring(0,d.length-1)).forEach(g=>{(g.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(g,"data-type","NodeBlockQueryEmbed"))&&l.push(g)});else{const g=document.createElement("template");g.innerHTML=`<div>${i.dataTransfer.getData(s)}</div>`,g.content.querySelectorAll(d.substring(0,d.length-1)).forEach(h=>{(h.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(h,"data-type","NodeBlockQueryEmbed"))&&l.push(h)})}const u=[];l.forEach(g=>{g.classList.remove("protyle-wysiwyg--select","protyle-wysiwyg--hl"),g.removeAttribute("select-start"),g.removeAttribute("select-end"),g.querySelectorAll('[data-type="search-mark"]').forEach(h=>{h.outerHTML=h.innerHTML}),u.push(g.getAttribute("data-node-id"))}),X(["gutter"],t);const f=o.className.split(" ");if(o.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right"),o.classList.contains("av__cell")){const g=x(o);if(g){const h=g.getAttribute("data-av-id");let m="";f.includes("dragover__left")?o.previousElementSibling&&(o.previousElementSibling.classList.contains("av__colsticky")?m=o.previousElementSibling.lastElementChild.getAttribute("data-col-id"):m=o.previousElementSibling.getAttribute("data-col-id")):m=o.getAttribute("data-col-id");let b="";const y=A(o,"av__row");if(y){const _=y.querySelector(`[data-col-id="${r[2]}"`)?.previousElementSibling;_&&(_.classList.contains("av__colsticky")?b=_.lastElementChild.getAttribute("data-col-id"):b=_.getAttribute("data-col-id"))}F(t,[{action:"sortAttrViewCol",avID:h,previousID:m,id:r[2]}],[{action:"sortAttrViewCol",avID:h,previousID:b,id:r[2]}])}}else if(o.classList.contains("av__row")){const g=x(o);if(g){let h="";f.includes("dragover__bottom")?h=o.getAttribute("data-id")||"":h=o.previousElementSibling?.getAttribute("data-id")||"";const m=g.getAttribute("data-av-id");if(r[0]==="nodeattributeviewrowmenu"){const b=[],y=[],_=g.querySelector(`[data-id="${c[0]}"]`).previousElementSibling.getAttribute("data-id")||"";c.reverse().forEach(v=>{b.push({action:"sortAttrViewRow",avID:m,previousID:h,id:v}),y.push({action:"sortAttrViewRow",avID:m,previousID:_,id:v})}),F(t,b,y)}else F(t,[{action:"insertAttrViewBlock",avID:m,previousID:h,srcIDs:u,isDetached:!1}],[{action:"removeAttrViewBlock",srcIDs:u,avID:m}]),co(g,u,h)}}else l.length>0&&(o.parentElement.getAttribute("data-type")==="NodeSuperBlock"&&o.parentElement.getAttribute("data-sb-layout")==="col"?f.includes("dragover__left")||f.includes("dragover__right")?sb(t,l,o,f.includes("dragover__right"),i.ctrlKey):ib(t,l,o,f.includes("dragover__bottom"),"row",i.ctrlKey):f.includes("dragover__left")||f.includes("dragover__right")?ib(t,l,o,f.includes("dragover__right"),"col",i.ctrlKey):sb(t,l,o,f.includes("dragover__bottom"),i.ctrlKey),l.forEach(g=>{g.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(g.removeAttribute("data-render"),Be(t,g))}),o.getAttribute("data-type")==="NodeBlockQueryEmbed"&&(o.removeAttribute("data-render"),Be(t,o)));n=void 0}}else if(i.dataTransfer.getData(p.Constants.SIYUAN_DROP_FILE)?.split("-").length>1&&o&&!t.options.backlinkData&&o.className.indexOf("dragover__")>-1){const l=t.contentElement.scrollTop,r=i.dataTransfer.getData(p.Constants.SIYUAN_DROP_FILE).split(",");if(o.classList.contains("av__row")){const c=x(o);if(c){let d="";o.classList.contains("dragover__bottom")?d=o.getAttribute("data-id")||"":d=o.previousElementSibling?.getAttribute("data-id")||"";const u=c.getAttribute("data-av-id");F(t,[{action:"insertAttrViewBlock",avID:u,previousID:d,srcIDs:r,isDetached:!1}],[{action:"removeAttrViewBlock",srcIDs:r,avID:u}]),co(c,r,d)}}else{for(let c=0;c<r.length;c++)r[c]&&await lt("/api/filetree/doc2Heading",{srcID:r[c],after:o.classList.contains("dragover__bottom"),targetID:o.getAttribute("data-node-id")});w("/api/filetree/getDoc",{id:t.block.id,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{st({data:c,protyle:t}),Ta({protyle:t,focus:!1,pushBackStack:!1,reload:!0,resize:!1}),setTimeout(()=>{t.contentElement.scrollTop=l,t.scroll.lastScrollTop=l-1},p.Constants.TIMEOUT_LOAD)})}o.classList.remove("dragover__bottom","dragover__top","dragover__left","dragover__right")}else if(!window.siyuan.dragElement&&(i.dataTransfer.types[0]==="Files"||i.dataTransfer.types.includes("text/html"))){const l=A(i.target,"av");if(l){const r=A(i.target,"av__cell");if(r&&l.querySelector(`.av__row--header [data-col-id="${r.dataset.colId}"]`)?.getAttribute("data-dtype")==="mAsset"&&i.dataTransfer.types[0]==="Files"&&!(0,I.jU)()){const d=[];for(let u=0;u<i.dataTransfer.files.length;u++)d.push(i.dataTransfer.files[u].path);dy(d,t,r,l.dataset.avId)}}else if(Z($u(i.clientX,i.clientY)),i.dataTransfer.types[0]==="Files"&&!(0,I.jU)()){const r=[];for(let c=0;c<i.dataTransfer.files.length;c++)r.push(i.dataTransfer.files[c].path);po(r,t,!i.altKey)}else Rp(t,i)}window.siyuan.dragElement&&(window.siyuan.dragElement.style.opacity="",window.siyuan.dragElement=void 0)});let n,a;e.addEventListener("dragover",i=>{if(t.disabled){i.preventDefault(),i.stopPropagation();return}const s=t.contentElement.getBoundingClientRect();if((i.clientY<s.top+p.Constants.SIZE_SCROLL_TB||i.clientY>s.bottom-p.Constants.SIZE_SCROLL_TB)&&t.contentElement.scroll({top:t.contentElement.scrollTop+(i.clientY<s.top+p.Constants.SIZE_SCROLL_TB?-p.Constants.SIZE_SCROLL_STEP:p.Constants.SIZE_SCROLL_STEP),behavior:"smooth"}),i.dataTransfer.types.includes("Files")&&i.target.classList.contains("protyle-wysiwyg")){i.preventDefault();return}let o="";for(const d of i.dataTransfer.items)d.type.startsWith(p.Constants.SIYUAN_DROP_GUTTER)&&(o=d.type);if(!o&&!window.siyuan.dragElement){i.preventDefault();return}if(i.shiftKey||i.altKey){const d=x(i.target);d&&(d.classList.remove("dragover__top","protyle-wysiwyg--select","dragover__bottom","dragover__left","dragover__right"),d.removeAttribute("select-start"),d.removeAttribute("select-end")),i.preventDefault();return}i.preventDefault();let l=A(i.target,"av__row")||x(i.target);const r={x:i.clientX,y:i.clientY,className:""};if(l)l&&l.classList.contains("list")&&(o&&o.replace(p.Constants.SIYUAN_DROP_GUTTER,"").split(p.Constants.ZWSP)[0]!=="nodelistitem"?l=x(document.elementFromPoint(i.clientX,i.clientY-6)):l=A(document.elementFromPoint(i.clientX,i.clientY-6),"li"));else if(i.clientY>e.lastElementChild.getBoundingClientRect().bottom)l=e.lastElementChild,r.className="dragover__bottom";else if(i.clientY<e.firstElementChild.getBoundingClientRect().top)l=e.firstElementChild,r.className="dragover__top";else if(s){const d={left:s.left+parseInt(e.style.paddingLeft),right:s.left+t.contentElement.clientWidth-parseInt(e.style.paddingRight)};i.clientX<d.left?(r.x=d.left,r.className="dragover__left"):i.clientX>=d.right&&(r.x=d.right-6,r.className="dragover__right"),l=document.elementFromPoint(r.x,r.y),l.classList.contains("protyle-wysiwyg")&&(l=document.elementFromPoint(r.x,r.y-6)),l=Xe(l,"data-node-id",null)}if(o&&o.startsWith(`${p.Constants.SIYUAN_DROP_GUTTER}NodeAttributeView${p.Constants.ZWSP}Col${p.Constants.ZWSP}`.toLowerCase())){if(l=A(i.target,"av__cell"),l){const d=A(l,"av__row--header"),u=A(window.siyuan.dragElement,"av__row--header");(!d||!u||d&&u&&!d.isSameNode(u))&&(l=!1)}}else l&&o&&o.startsWith(`${p.Constants.SIYUAN_DROP_GUTTER}NodeAttributeViewRowMenu${p.Constants.ZWSP}`.toLowerCase())&&(!l.classList.contains("av__row")||!window.siyuan.dragElement.contains(l))&&(l=!1);if(!l)return;const c=i.dataTransfer.types.includes(p.Constants.SIYUAN_DROP_FILE)&&window.siyuan.dragElement?window.siyuan.dragElement.innerText:"";if(l&&n&&l.isSameNode(n)){const d=l.getBoundingClientRect();if(e.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top").forEach(u=>{u.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right","protyle-wysiwyg--select"),u.removeAttribute("select-start"),u.removeAttribute("select-end")}),l.getAttribute("data-type")==="NodeAttributeView"&&_e(i.target,"TD"))return;if(r.className){l.classList.add(r.className);return}if(l.getAttribute("data-type")==="NodeListItem"||c.indexOf("-")>-1){i.clientY>d.top+d.height/2?l.classList.add("dragover__bottom"):l.classList.contains("av__row--header")||l.classList.add("dragover__top");return}if(l.classList.contains("av__cell")){i.clientX<d.left+d.width/2&&i.clientX>d.left&&!l.classList.contains("av__row")?l.classList.add("dragover__left"):i.clientX>d.right-d.width/2&&i.clientX<=d.right+1&&!l.classList.contains("av__row")&&l.classList.add("dragover__right");return}i.clientX<d.left+32&&i.clientX>=d.left-1&&!l.classList.contains("av__row")?l.classList.add("dragover__left"):i.clientX>d.right-32&&i.clientX<d.right&&!l.classList.contains("av__row")?l.classList.add("dragover__right"):i.clientY>d.top+d.height/2&&a!=="bottom"?l.classList.add("dragover__bottom"):a!=="top"&&l.classList.add("dragover__top");return}if(c.indexOf("-")>-1){c.split(",").includes(t.block.rootID)&&!l.classList.contains("av__row")?n=void 0:n=l;return}if(o){a="";const d=o.replace(p.Constants.SIYUAN_DROP_GUTTER,"").split(p.Constants.ZWSP);if(d[0]==="nodeattributeview"&&d[1]==="col"&&l.getAttribute("data-id")===d[2]||d[2].split(",").find(f=>{if(f&&q(l,"data-node-id",f))return!0})||q(l.parentElement,"data-type","NodeBlockQueryEmbed")||d[0]==="nodelistitem"&&d[1]!==l.getAttribute("data-subtype")&&l.getAttribute("data-type")==="NodeListItem"||d[0]!=="nodelistitem"&&l.getAttribute("data-type")==="NodeListItem")return;d[0]==="nodelistitem"&&l.parentElement.classList.contains("li")&&l.previousElementSibling?.classList.contains("protyle-action")&&(a="top"),d[0]==="nodelistitem"&&l.nextElementSibling?.classList.contains("list")&&(a="bottom"),l&&l.classList.contains("av__row--header")&&(a="top"),n=l}}),e.addEventListener("dragleave",i=>{if(t.disabled){i.preventDefault(),i.stopPropagation();return}e.querySelectorAll(".dragover__left, .dragover__right, .dragover__bottom, .dragover__top").forEach(s=>{s.classList.remove("dragover__top","dragover__bottom","dragover__left","dragover__right")})})},ob=(t,e,n,a)=>{a&&console.log(`${t} - ${n}: ${e}`)},PE=(t,e,n,a,i)=>{if(e!=="NodeCodeBlock"&&n.parentElement.getAttribute("data-subtype")!=="t"&&(["[ ]","[x]","[X]","\u3010 \u3011","\u3010x\u3011","\u3010X\u3011"].includes(a.innerHTML.substring(0,3))||["[]","\u3010\u3011"].includes(a.innerHTML.substring(0,2)))){const s=a.innerHTML.indexOf("]")+1||a.innerHTML.indexOf("\u3011")+1,o=a.innerHTML.substring(1,2).toLowerCase()==="x";if(n.parentElement.classList.contains("li")&&n.parentElement.childElementCount===3){if(!n.parentElement.parentElement.classList.contains("protyle-wysiwyg")&&n.parentElement.parentElement.childElementCount===2){const l=n.parentElement.parentElement,r=l.outerHTML;return l.setAttribute("data-subtype","t"),l.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),n.parentElement.setAttribute("data-subtype","t"),o&&n.parentElement.classList.add("protyle-task--done"),n.previousElementSibling.outerHTML=`<div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>`,a.innerHTML=a.innerHTML.substring(s),J(t,l.getAttribute("data-node-id"),l.outerHTML,r),fe(t.wysiwyg.element,i),!0}return!1}else{const l=n.getAttribute("data-node-id"),r=Lute.NewNodeID(),c=Lute.NewNodeID(),d=Lute.NewNodeID(),u=n.outerHTML;return a.innerHTML=a.innerHTML.substring(s),F(t,[{action:"update",id:l,data:n.outerHTML},{action:"insert",id:r,data:`<div data-subtype="t" data-node-id="${r}" updated="${r.split("-")[0]}" data-type="NodeList" class="list"><div data-marker="*" data-subtype="t" data-node-id="${d}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${d.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div><div data-node-id="${c}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:l},{action:"move",id:l,previousID:c},{action:"delete",id:c}],[{action:"update",id:l,data:u},{action:"move",id:l,previousID:r},{action:"delete",id:r}]),n.outerHTML=`<div data-subtype="t" data-node-id="${r}" data-type="NodeList" class="list" updated="${r.split("-")[0]}"><div data-marker="*" data-subtype="t" data-node-id="${d}" data-type="NodeListItem" class="li${o?" protyle-task--done":""}" updated="${d.split("-")[0]}"><div class="protyle-action protyle-action--task" draggable="true"><svg><use xlink:href="#icon${o?"C":"Unc"}heck"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,fe(t.wysiwyg.element,i),!0}}return!1},ME=(t,e,n,a,i)=>{if(e==="NodeHeading"&&["* ","- "].includes(a.innerHTML.substring(0,2))&&n.parentElement.getAttribute("data-type")!=="NodeListItem"){const s=n.getAttribute("data-node-id"),o=Lute.NewNodeID(),l=Lute.NewNodeID(),r=Lute.NewNodeID(),c=n.outerHTML,d=a.innerHTML.substring(0,1);return a.innerHTML=a.innerHTML.substring(2),F(t,[{action:"update",id:s,data:n.outerHTML},{action:"insert",id:o,data:`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${d}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div><div data-node-id="${l}" data-type="NodeParagraph" class="p"><div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}"></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,previousID:s},{action:"move",id:s,previousID:l},{action:"delete",id:l}],[{action:"update",id:s,data:c},{action:"move",id:s,previousID:o},{action:"delete",id:o}]),n.outerHTML=`<div data-subtype="u" data-node-id="${o}" data-type="NodeList" class="list" updated="${o.split("-")[0]}"><div data-marker="${d}" data-subtype="u" data-node-id="${r}" data-type="NodeListItem" class="li" updated="${r.split("-")[0]}"><div class="protyle-action" draggable="true"><svg><use xlink:href="#iconDot"></use></svg></div>${n.outerHTML}<div class="protyle-attr" contenteditable="false"></div></div><div class="protyle-attr" contenteditable="false"></div></div>`,fe(t.wysiwyg.element,i),!0}return!1},Pu=async(t,e,n,a=!0)=>{if(!e.parentElement)return;if(e.classList.contains("av")){vd(t,e);return}const i=ae(e),s=e.getAttribute("data-type");if(!i){s==="NodeThematicBreak"?e.innerHTML="<div><wbr></div>":s==="NodeBlockQueryEmbed"?e.lastElementChild.previousElementSibling.innerHTML="<wbr>"+p.Constants.ZWSP:s==="NodeMathBlock"||s==="NodeHTMLBlock"?e.lastElementChild.previousElementSibling.lastElementChild.innerHTML="<wbr>"+p.Constants.ZWSP:s==="NodeIFrame"||s==="NodeWidget"?e.innerHTML="<wbr>"+e.firstElementChild.outerHTML+e.lastElementChild.outerHTML:s==="NodeVideo"?e.firstElementChild.innerHTML="<wbr>"+p.Constants.ZWSP+e.firstElementChild.firstElementChild.outerHTML+e.firstElementChild.lastElementChild.outerHTML:s==="NodeAudio"?e.firstElementChild.innerHTML=e.firstElementChild.firstElementChild.outerHTML+"<wbr>"+p.Constants.ZWSP:s==="NodeCodeBlock"&&(n.startContainer.textContent=p.Constants.ZWSP),fe(e,n);return}e.setAttribute("updated",Q().format("YYYYMMDDHHmmss"));const o=document.createElement("wbr");n.insertNode(o);const l=e.getAttribute("data-node-id");if(s!=="NodeCodeBlock"&&(i.innerHTML.endsWith(`
<wbr>`)||i.innerHTML.endsWith(`
<wbr>
`))){J(t,l,e.outerHTML,t.wysiwyg.lastHTMLs[l]||e.outerHTML.replace(`
<wbr>`,"<wbr>")),o.remove();return}if(PE(t,s,e,i,n)||ME(t,s,e,i,n))return;const r=e.querySelector("br");r&&r.parentElement.tagName!=="TD"&&r.parentElement.tagName!=="TH"&&(r.parentElement.textContent.trim()===""||r.previousSibling?.previousSibling?.textContent===`
`)&&r.remove(),(i.innerHTML==="\u300B<wbr>"||i.innerHTML.indexOf(`
\u300B<wbr>`)>-1)&&(i.innerHTML=i.innerHTML.replace("\u300B<wbr>","><wbr>"));const c=i.innerHTML.trimStart();if(!((c.startsWith("````")||c.startsWith("\xB7\xB7\xB7\xB7")||c.startsWith("~~~~"))&&c.indexOf(`
`)===-1)){if((c.startsWith("```")||c.startsWith("\xB7\xB7\xB7")||c.startsWith("~~~"))&&c.indexOf(`
`)===-1&&c.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")===-1){J(t,l,e.outerHTML,t.wysiwyg.lastHTMLs[l]),o.remove();return}}(c==="\xA5\xA5<wbr>"||c==="\uFFE5\uFFE5<wbr>")&&(i.innerHTML="$$<wbr>");const d=q(n.startContainer,"data-type","block-ref");d&&d.getAttribute("data-subtype")==="d"&&(await lt("/api/block/getRefText",{id:d.getAttribute("data-id")})).data!==d.innerHTML.replace("<wbr>","")&&d.setAttribute("data-subtype","s");let u=e.outerHTML,f=!1;if(i.textContent==="---"&&s!=="NodeCodeBlock"){u=`<div data-node-id="${l}" data-type="NodeThematicBreak" class="hr"><div></div></div>`;const h=nt(i);h?Ft(h)?f=!0:le(h):u+=Wl(!1,!0)}else{if(s!=="NodeCodeBlock"&&(c.startsWith("```")||c.startsWith("~~~")||c.startsWith("\xB7\xB7\xB7")||c.indexOf("\n```")>-1||c.indexOf(`
~~~`)>-1||c.indexOf(`
\xB7\xB7\xB7`)>-1)&&!(c.indexOf(`
`)===-1&&c.replace(/·|~/g,"`").replace(/^`{3,}/g,"").indexOf("`")>-1)){let h=i.innerHTML.replace(/^(~|·|`){3,}/g,"```").replace(/\n(~|·|`){3,}/g,"\n```").trim();h.endsWith("\n```")||(h=h.replace("<wbr>","")+"<wbr>\n```"),i.innerHTML=h,u=e.outerHTML}u=t.lute.SpinBlockDOM(u)}X(["util"],t,!0);const g=document.createElement("template");if(g.innerHTML=u,a&&(ae(g.content.firstElementChild)?.innerHTML!==ae(e).innerHTML||g.content.childElementCount===1&&ae(g.content.firstElementChild)?.innerHTML==="<wbr>")&&!(g.content.childElementCount===1&&g.content.firstElementChild.classList.contains("code-block")&&s==="NodeCodeBlock")){ob("SpinBlockDOM",e.outerHTML,"argument",t.options.debugger),ob("SpinBlockDOM",u,"result",t.options.debugger);let h;e.classList.contains("table")&&(h=ae(e).scrollLeft),/<span data-type="backslash">.<\/span><wbr>/.test(u)?e.outerHTML=u:e.outerHTML=u.replace("</span><wbr>","</span>"+p.Constants.ZWSP+"<wbr>"),t.wysiwyg.element.querySelectorAll(`[data-node-id="${l}"]`).forEach(m=>{(m.getAttribute("data-type")==="NodeBlockQueryEmbed"||!q(m,"data-type","NodeBlockQueryEmbed"))&&(e=m)}),u.split('<span data-type="inline-math" data-subtype="math"').length>1&&Array.from(e.querySelectorAll('[data-type="inline-math"]')).find(m=>{if(m.dataset.content.indexOf("<wbr>")>-1)return m.setAttribute("data-content",m.dataset.content.replace("<wbr>","")),t.toolbar.showRender(t,m),!0}),Array.from(g.content.children).forEach((m,b)=>{const y=m.getAttribute("data-node-id");let _;y===l?_=e:_=t.wysiwyg.element.querySelector(`[data-node-id="${y}"]`);const v=_.getAttribute("data-type");if(v==="NodeCodeBlock"){const k=_.querySelector(".protyle-action__language");k?(window.siyuan.storage[p.Constants.LOCAL_CODELANG]&&k.textContent===""&&(k.textContent=window.siyuan.storage[p.Constants.LOCAL_CODELANG]),qe(_)):g.content.childElementCount===1&&t.toolbar.showRender(t,_)}else["NodeMathBlock","NodeHTMLBlock"].includes(v)?(v==="NodeMathBlock"&&Ln(_),t.toolbar.showRender(t,_)):v==="NodeBlockQueryEmbed"?(Be(t,_),t.toolbar.showRender(t,_),X(["hint"],t)):v==="NodeThematicBreak"&&f?le(e):(_.querySelectorAll('[data-type="block-ref"][data-subtype="d"]').forEach(k=>{k.textContent===""&&w("/api/block/getRefText",{id:k.getAttribute("data-id")},L=>{k.innerHTML=L.data})}),Ln(_),b===g.content.childElementCount-1&&(fe(t.wysiwyg.element,n),t.hint.render(t),h>0&&(ae(_).scrollLeft=h)))})}else e.getAttribute("data-type")==="NodeCodeBlock"?(i.removeAttribute("data-render"),qe(e)):(fe(t.wysiwyg.element,n),t.hint.render(t));X(["gutter"],t),NE(u,t,l)},NE=(t,e,n)=>{const a=document.createElement("template");a.innerHTML=t;const i=[],s=[];Array.from(a.content.children).forEach((o,l)=>{o.getAttribute("spellcheck")==="false"&&o.getAttribute("contenteditable")==="false"&&o.setAttribute("contenteditable","true");const r=o.getAttribute("data-node-id");if(r===n)i.push({id:n,data:o.outerHTML,action:"update"}),s.push({id:n,data:e.wysiwyg.lastHTMLs[n],action:"update"});else{let c;l===0&&(c=e.wysiwyg.element.querySelector(`[data-node-id="${r}"]`)),i.push({action:"insert",data:o.outerHTML,id:r,previousID:l===0?c?.previousElementSibling?.getAttribute("data-node-id"):o.previousElementSibling.getAttribute("data-node-id"),parentID:c?.parentElement.getAttribute("data-node-id")||e.block.parentID}),s.push({id:r,action:"delete"})}}),F(e,i,s)},HE=(t,e,n)=>{if(!e.classList.contains("av")||!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(t.isComposing)return!0;if($("\u2318B",t)||$("\u2318I",t)||$("\u2318U",t))return t.preventDefault(),!0;const a=e.querySelector(".av__cell--select");if(a){const s=A(a,"av__row");if(!s)return!1;if(t.key==="Escape")return a.classList.remove("av__cell--select"),ta(s.querySelector(".av__firstcol"),"select"),t.preventDefault(),!0;if(t.key==="Enter")return qn(n,[a]),t.preventDefault(),!0;if(t.key==="Backspace")return An(n,e,void 0,[a]),t.preventDefault(),!0;let o;if(t.key==="ArrowLeft"||$("\u21E7\u21E5",t)){const l=s.previousElementSibling;if(a.previousElementSibling&&!a.previousElementSibling.classList.contains("av__firstcol"))a.previousElementSibling.classList.contains("av__cell")?o=a.previousElementSibling:o=a.previousElementSibling.lastElementChild;else if(l&&!l.classList.contains("av__row--header")){const r=l.querySelectorAll(".av__cell");o=r[r.length-1]}return o&&(a.classList.remove("av__cell--select"),o.classList.add("av__cell--select"),vi(e,o,!1)),t.preventDefault(),!0}if(t.key==="ArrowRight"||$("\u21E5",t)){const l=s.nextElementSibling;return a.nextElementSibling&&a.nextElementSibling.classList.contains("av__cell")?o=a.nextElementSibling:!a.nextElementSibling&&a.parentElement.nextElementSibling?o=a.parentElement.nextElementSibling:l&&!l.classList.contains("av__row--footer")&&(o=l.querySelector(".av__cell")),o&&(a.classList.remove("av__cell--select"),o.classList.add("av__cell--select"),vi(e,o,!1)),t.preventDefault(),!0}if(t.key==="ArrowUp"){const l=s.previousElementSibling;return l&&!l.classList.contains("av__row--header")&&(o=l.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),o&&(a.classList.remove("av__cell--select"),o.classList.add("av__cell--select"),vi(e,o)),t.preventDefault(),!0}if(t.key==="ArrowDown"){const l=s.nextElementSibling;return l&&!l.classList.contains("av__row--footer")&&(o=l.querySelector(`.av__cell[data-col-id="${a.dataset.colId}"]`)),o&&(a.classList.remove("av__cell--select"),o.classList.add("av__cell--select"),vi(e,o)),t.preventDefault(),!0}if(!p.Constants.KEYCODELIST[t.keyCode]||p.Constants.KEYCODELIST[t.keyCode].length===1&&!t.metaKey&&!t.ctrlKey&&!["\u21E7","\u2303","\u2325","\u2318"].includes(p.Constants.KEYCODELIST[t.keyCode]))return a.style.backgroundColor?t.preventDefault():qn(n,[a]),!0}const i=e.querySelectorAll(".av__row--select:not(.av__row--header)");if(i.length>0){if($("\u2318/",t))return t.stopPropagation(),t.preventDefault(),Kl(n,i[0],{x:e.querySelector(".layout-tab-bar").getBoundingClientRect().left,y:i[0].getBoundingClientRect().bottom}),!0;if(t.key==="Escape")return t.preventDefault(),ta(i[0].querySelector(".av__firstcol"),"unselectAll"),!0;if(t.key==="Backspace")return t.preventDefault(),_p(e,n),!0;if(t.key==="Enter")return ta(i[0].querySelector(".av__firstcol"),"unselectAll"),qn(n,[i[0].querySelector(".av__cell")]),t.preventDefault(),!0;if(t.key==="ArrowUp"){const s=i[0].previousElementSibling;return ta(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--header")?(ta(s.querySelector(".av__firstcol"),"select"),vi(e,s)):e.classList.add("protyle-wysiwyg--select"),t.preventDefault(),!0}if(t.key==="ArrowDown"){const s=i[i.length-1].nextElementSibling;return ta(i[0].querySelector(".av__firstcol"),"unselectAll"),s&&!s.classList.contains("av__row--util")?(ta(s.querySelector(".av__firstcol"),"select"),vi(e,s)):e.classList.add("protyle-wysiwyg--select"),t.preventDefault(),!0}}return!1},Mu=(t,e)=>{let n="";Array.from(t.cloneContents().childNodes).forEach(a=>{a.nodeType===3?n+=a.textContent:n+=a.outerHTML}),w("/api/block/getDOMText",{dom:n},a=>{e(a.data)})},OE=(t,e)=>{e.addEventListener("keydown",n=>{if(n.target.localName==="protyle-html"){n.stopPropagation();return}if(t.disabled||!t.selectElement.classList.contains("fn__none")){n.stopPropagation(),n.preventDefault();return}t.wysiwyg.preventKeyup=!1,X(["util"],t),n.shiftKey&&n.key.indexOf("Arrow")>-1||!n.repeat&&n.code!==""&&X(["toolbar"],t);let a=re(t.wysiwyg.element);const i=x(a.startContainer);if(!i)return;const s=x(a.endContainer);if(!$("\u2318C",n)&&s&&!i.isSameNode(s)){n.stopPropagation(),n.preventDefault();return}if(HE(n,i,t))return;if(i.classList.contains("protyle-wysiwyg--select")&&R(n)&&!n.shiftKey&&!n.altKey){if(n.key.toLowerCase()==="a")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{wn(t,"afterend")},100),!1;if(n.key.toLowerCase()==="b")return n.stopPropagation(),n.preventDefault(),t.wysiwyg.element.blur(),setTimeout(()=>{wn(t,"beforebegin")},100),!1}if(n.isComposing){n.stopPropagation();return}if(["\u2318","\u21E7","\u2325","\u2303"].includes(p.Constants.KEYCODELIST[n.keyCode])||(p.Constants.KEYCODELIST[n.keyCode]==="/"||n.key==="/"||n.code==="Slash"&&n.key==="Process"&&n.keyCode===229?t.hint.enableSlash=!0:(p.Constants.KEYCODELIST[n.keyCode]==="\\"||n.key==="\\"||n.code==="Backslash"&&n.key==="Process"&&n.keyCode===229)&&(t.hint.enableSlash=!1,X(["hint"],t))),n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&n.key!=="Escape"&&n.key!=="Shift"&&n.key!=="Meta"&&n.key!=="Alt"&&n.key!=="Control"&&n.key!=="CapsLock"&&!Ft(i)&&!/^F\d{1,2}$/.test(n.key)&&typeof t.wysiwyg.lastHTMLs[i.getAttribute("data-node-id")]>"u"){const r=a.cloneRange();a.insertNode(document.createElement("wbr")),t.wysiwyg.lastHTMLs[i.getAttribute("data-node-id")]=i.outerHTML,i.querySelector("wbr").remove(),a=r}if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&(["\u2190","\u2191","\u2192","\u2193"].includes(p.Constants.KEYCODELIST[n.keyCode])||p.Constants.KEYCODELIST[n.keyCode]==="\u21A9")&&!n.altKey&&!n.shiftKey&&R(n)){n.preventDefault();return}else n.key!=="Escape"&&window.siyuan.menus.menu.remove();if(!["Alt","Meta","Shift","Control","CapsLock","Escape"].includes(n.key)&&t.options.render.breadcrumb&&t.breadcrumb.hide(),!n.altKey&&!n.shiftKey&&R(n)&&(n.key==="ArrowDown"||n.key==="ArrowUp")){const r=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(r.length>0){if(n.preventDefault(),n.stopPropagation(),X(["select"],t),n.key==="ArrowDown"){const c=r[r.length-1];let d=nt(c);if(d)if(d.getBoundingClientRect().width===0){const f=Xe(d,"fold","1");f?(d=nt(f),d?d=Et(d):d=c):d=c}else d.getAttribute("fold")==="1"&&(d.classList.contains("sb")||d.classList.contains("bq"))||(d=Et(d));else d=c;d.classList.add("protyle-wysiwyg--select"),Gt([d.getAttribute("data-node-id")]);const u=d.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;u>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+u,t.scroll.lastScrollTop=t.contentElement.scrollTop-1),le(d)}else if(n.key==="ArrowUp"){let c=De(r[0]);if(c){if(c=Qe(c),c.getBoundingClientRect().width===0){const d=Xe(c,"fold","1");d?c=Et(d):c=r[0]}else if(c){const d=Xe(c,"fold","1");d&&(d.classList.contains("sb")||d.classList.contains("bq"))&&(c=d)}}else t.title&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)?t.title.editElement.focus():t.contentElement.scrollTop!==0?(t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8):c=r[0];if(c){c.classList.add("protyle-wysiwyg--select"),Gt([c.getAttribute("data-node-id")]);const d=c.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;d<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+d,t.scroll.lastScrollTop=t.contentElement.scrollTop+1),le(c)}}return}}if(n.key!=="PageUp"&&n.key!=="PageDown"&&n.key!=="Home"&&n.key!=="End"&&n.key.indexOf("Arrow")===-1&&R(n)&&n.key!=="Escape"&&!n.shiftKey&&!n.altKey&&!/^F\d{1,2}$/.test(n.key)&&n.key!=="Enter"&&n.key!=="Tab"&&n.key!=="Backspace"&&n.key!=="Delete"&&n.key!=="ContextMenu")return n.stopPropagation(),X(["select"],t),!1;if($(window.siyuan.config.keymap.editor.general.collapse.custom,n)&&!n.repeat){const r=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");return r.length>0?zt(t,r[0]):i.parentElement.getAttribute("data-type")==="NodeListItem"?i.parentElement.childElementCount>3?zt(t,i.parentElement):zt(t,i):i.getAttribute("data-type")==="NodeHeading"?zt(t,i):zt(t,be(i)),n.stopPropagation(),n.preventDefault(),!1}if($(window.siyuan.config.keymap.editor.general.expand.custom,n)&&!n.repeat){const r=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");r.length>0?zt(t,r[0],!0):i.parentElement.getAttribute("data-type")==="NodeListItem"?i.parentElement.childElementCount>3?zt(t,i.parentElement,!0):zt(t,i,!0):i.getAttribute("data-type")==="NodeHeading"?zt(t,i,!0):zt(t,be(i),!0),n.stopPropagation(),n.preventDefault();return}if(($("\u21E7\u2190",n)||$("\u21E7\u2192",n))&&t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").length>0){n.stopPropagation(),n.preventDefault();return}if($(window.siyuan.config.keymap.editor.general.expandUp.custom,n)){pg({protyle:t,event:n,nodeElement:i,editorElement:e,range:a,cb(r){const c=r[0].previousElementSibling;if(c&&c.getAttribute("data-node-id")){c.classList.add("protyle-wysiwyg--select"),r.forEach(u=>{u.removeAttribute("select-end")}),c.setAttribute("select-end","true");const d=c.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;d<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+d,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else r[0].parentElement.classList.contains("protyle-wysiwyg")||(X(["select"],t),r[0].parentElement.classList.add("protyle-wysiwyg--select"))}});return}if($(window.siyuan.config.keymap.editor.general.expandDown.custom,n)){gg({protyle:t,event:n,nodeElement:i,editorElement:e,range:a,cb(r){const c=r[r.length-1],d=c.nextElementSibling;if(d&&d.getAttribute("data-node-id")){d.classList.add("protyle-wysiwyg--select"),r.forEach(f=>{f.removeAttribute("select-end")}),d.setAttribute("select-end","true");const u=d.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;u>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+u,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else c.parentElement.classList.contains("protyle-wysiwyg")||(X(["select"],t),c.parentElement.classList.add("protyle-wysiwyg--select"))}});return}if($("\u21E7\u2191",n)){pg({protyle:t,event:n,nodeElement:i,editorElement:e,range:a,cb(r){const c=ir(r);if(c.startElement.getBoundingClientRect().top>=c.endElement.getBoundingClientRect().top){const d=c.endElement.previousElementSibling;if(d&&d.getAttribute("data-node-id")){d.classList.add("protyle-wysiwyg--select"),d.setAttribute("select-end","true"),c.endElement.removeAttribute("select-end");const u=d.getBoundingClientRect().top-t.contentElement.getBoundingClientRect().top;u<0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+u,t.scroll.lastScrollTop=t.contentElement.scrollTop+1)}else c.endElement.parentElement.classList.contains("protyle-wysiwyg")||(X(["select"],t),c.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{c.endElement.classList.remove("protyle-wysiwyg--select"),c.endElement.removeAttribute("select-end");const d=De(c.endElement);d&&(d.setAttribute("select-end","true"),d.getBoundingClientRect().top<=t.contentElement.getBoundingClientRect().top&&(ln(t),d.scrollIntoView(!0)))}}});return}if($("\u21E7\u2193",n)){gg({protyle:t,event:n,nodeElement:i,editorElement:e,range:a,cb(r){const c=ir(r);if(c.startElement.getBoundingClientRect().top<=c.endElement.getBoundingClientRect().top){const d=c.endElement.nextElementSibling;if(d&&d.getAttribute("data-node-id")){d.classList.add("protyle-wysiwyg--select"),d.setAttribute("select-end","true"),c.endElement.removeAttribute("select-end");const u=d.getBoundingClientRect().bottom-t.contentElement.getBoundingClientRect().bottom;u>0&&(t.contentElement.scrollTop=t.contentElement.scrollTop+u,t.scroll.lastScrollTop=t.contentElement.scrollTop-1)}else c.endElement.parentElement.classList.contains("protyle-wysiwyg")||(X(["select"],t),c.endElement.parentElement.classList.add("protyle-wysiwyg--select"))}else{c.endElement.classList.remove("protyle-wysiwyg--select"),c.endElement.removeAttribute("select-end");const d=nt(c.endElement);d&&(d.setAttribute("select-end","true"),d.getBoundingClientRect().bottom>=t.contentElement.getBoundingClientRect().bottom&&(ln(t),d.scrollIntoView(!1)))}}});return}if($(window.siyuan.config.keymap.general.enter.custom,n)){let r=be(i);r.parentElement.classList.contains("li")&&r.parentElement.parentElement.classList.contains("list")&&r.nextElementSibling?.classList.contains("list")&&r.previousElementSibling.classList.contains("protyle-action")&&(r=r.parentElement),Vt({protyle:t,id:r.getAttribute("data-node-id")}),n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.general.enterBack.custom,n)){Ud(t,i.getAttribute("data-node-id")),n.preventDefault(),n.stopPropagation();return}if(n.shiftKey&&!n.altKey&&R(n)&&(n.key==="Home"||n.key==="End")&&$e()||n.shiftKey&&!n.altKey&&O(n)&&(n.key==="Home"||n.key==="End")&&!$e()){const r=Xe(i,"data-node-id",null);if(r){r.querySelectorAll(".protyle-wysiwyg--select").forEach(d=>{d.classList.remove("protyle-wysiwyg--select")}),r.classList.add("protyle-wysiwyg--select");let c=n.key==="Home"?r.previousElementSibling:r.nextElementSibling;for(;c;)c.classList.add("protyle-wysiwyg--select"),c=n.key==="Home"?c.previousElementSibling:c.nextElementSibling;n.key==="Home"?t.wysiwyg.element.firstElementChild.scrollIntoView():t.wysiwyg.element.lastElementChild.scrollIntoView(!1)}n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&O(n)&&n.key==="Home"){hg(t),X(["select"],t),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&O(n)&&n.key==="End"){mg(t),X(["select"],t),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&R(n)&&(n.key==="PageUp"||n.key==="PageDown")){n.key==="PageUp"?(t.contentElement.scrollTop=t.contentElement.scrollTop-t.contentElement.clientHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop+1):(t.contentElement.scrollTop=t.contentElement.scrollTop+t.contentElement.clientHeight,t.scroll.lastScrollTop=t.contentElement.scrollTop-1);const r=t.contentElement.getBoundingClientRect();let c=document.elementFromPoint(r.x+r.width/2,r.y+r.height/2);c.classList.contains("protyle-wysiwyg")&&(c=document.elementFromPoint(r.x+r.width/2,r.y+r.height/2+p.Constants.SIZE_TOOLBAR_HEIGHT));const d=x(c);d&&!d.isSameNode(i)&&le(d,void 0,!1),n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&!n.shiftKey&&(n.key.indexOf("Arrow")>-1&&R(n)||n.key==="Enter")&&!t.hint.element.classList.contains("fn__none")&&t.hint.select(n,t)){n.stopPropagation(),n.preventDefault();return}if($("\u2318/",n)){n.stopPropagation(),n.preventDefault();const r=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(r.length===0){const d=q(a.startContainer,"data-type",null);if(d&&d.tagName==="SPAN"){const u=d.getAttribute("data-type").split(" ");if(u.length>0&&(t.toolbar.range=a,ug(d)),u.includes("block-ref")){Fd(t,d);return}else if(u.includes("inline-memo")){t.toolbar.showRender(t,d);return}else if(u.includes("file-annotation-ref")){qd(t,d);return}else if(u.includes("a")){vo(t,d);return}else if(u.includes("tag")){Vd(t,d);return}}if(a.startOffset===0&&a.startContainer.nodeType===3){const u=Ke(a.startContainer);if(u&&u.nodeType!==3&&u.getAttribute("data-type")?.indexOf("inline-math")>-1){t.toolbar.showRender(t,u);return}else if(!u&&a.startContainer.parentElement.previousSibling&&a.startContainer.parentElement.previousSibling.isSameNode(a.startContainer.parentElement.previousElementSibling)&&a.startContainer.parentElement.previousElementSibling.getAttribute("data-type")?.indexOf("inline-math")>-1){t.toolbar.showRender(t,a.startContainer.parentElement.previousElementSibling);return}}r.push(i)}r.length===1?t.gutter.renderMenu(t,r[0]):t.gutter.renderMultipleMenu(t,r);const c=i.getBoundingClientRect();window.siyuan.menus.menu.popup({x:c.left,y:c.top,isLeft:!0});return}if(Qw(t,n,a)){n.preventDefault();return}const o=a.toString();if(!n.altKey&&!n.shiftKey&&R(n)&&!n.isComposing&&n.key.indexOf("Arrow")>-1){const r=ae(i)||i,c=yt(r,t.wysiwyg.element,a),d=se(a.startContainer,"TD");if(n.key==="ArrowDown"&&r?.textContent.trimRight().substr(c.start).indexOf(`
`)===-1&&(d&&!d.parentElement.nextElementSibling&&i.getAttribute("data-type")==="NodeTable"&&!nt(i)||i.getAttribute("data-type")==="NodeCodeBlock"&&!nt(i)||i.parentElement.getAttribute("data-type")==="NodeBlockquote"&&i.nextElementSibling.classList.contains("protyle-attr")&&!nt(i.parentElement)))i.parentElement.getAttribute("data-type")==="NodeBlockquote"?wn(t,"afterend",i.parentElement.getAttribute("data-node-id")):wn(t,"afterend",i.getAttribute("data-node-id"));else if(n.key==="ArrowUp"){const u=ae(t.wysiwyg.element.firstElementChild);if(!De(i)&&i.contains(u)||!u&&i.isSameNode(t.wysiwyg.element.firstElementChild))($n(i,a).top-t.wysiwyg.element.getBoundingClientRect().top<40||i.classList.contains("av"))&&(t.title&&(t.wysiwyg.element.firstElementChild.getAttribute("data-eof")==="1"||t.contentElement.scrollTop===0)?t.title.editElement.focus():(t.contentElement.scrollTop=0,t.scroll.lastScrollTop=8));else if(r?.textContent.substr(0,c.end).indexOf(`
`)===-1){let f=De(i);if(f&&(f=Qe(f),f)){const g=q(f,"fold","1");ae(f)?.textContent.endsWith(`
`)&&!g?(le(f,void 0,!1),He(t,f),n.stopPropagation(),n.preventDefault()):g&&g.getAttribute("data-type")!=="NodeListItem"&&(g.scrollTop=0,le(g,void 0,!0),He(t,g),n.stopPropagation(),n.preventDefault())}}}else if(o===""&&(n.key==="ArrowDown"||n.key==="ArrowRight")&&i.isSameNode(Qe(t.wysiwyg.element.lastElementChild))&&!se(a.startContainer,"TD")&&!se(a.startContainer,"TH")){const u=ae(i);u&&u.textContent.replace(/\n$/,"").length<=yt(u,void 0,a).end&&(n.stopPropagation(),n.preventDefault(),Z(a))}else if(o===""&&n.key==="ArrowLeft"&&i.isSameNode(Et(t.wysiwyg.element.firstElementChild))){const u=ae(i);u&&yt(u,void 0,a).start===0&&(n.stopPropagation(),n.preventDefault(),Z(a))}if(n.key==="ArrowDown"){const u=q(a.startContainer,"fold","1");if(u){let f=nt(u);f&&(f.getAttribute("fold")==="1"&&(f.classList.contains("sb")||f.classList.contains("bq"))||(f=Et(f)),le(f),He(t,f)),n.stopPropagation(),n.preventDefault()}else if(r?.textContent.substr(c.end+1).indexOf(`
`)===-1){const f=nt(i);f&&f.getAttribute("fold")==="1"&&(le(f),He(t,f),n.stopPropagation(),n.preventDefault())}}return}if(!n.altKey&&(n.key==="Backspace"||n.key==="Delete")||$("\u2303D",n)){if(t.wysiwyg.element.querySelector(".protyle-wysiwyg--select")){rn(t,i,a),n.stopPropagation(),n.preventDefault();return}if(o===""&&n.key==="Backspace"&&a.startOffset===a.startContainer.textContent.length&&a.startContainer.textContent.endsWith(`
`+p.Constants.ZWSP)){a.setStart(a.startContainer,a.startOffset-1),a.collapse(!0),n.stopPropagation(),n.preventDefault();return}const r=Ke(a.startContainer);if(a.startOffset===1&&a.startContainer.textContent===p.Constants.ZWSP&&r&&r.nodeType!==3&&n.key==="Backspace"){if(r.classList.contains("img"))r.classList.add("img--select");else if(r.getAttribute("data-type")?.indexOf("inline-math")>-1){r.after(document.createElement("wbr"));const d=i.outerHTML;a.startContainer.textContent="",r.remove(),J(t,i.getAttribute("data-node-id"),i.outerHTML,d),fe(i,a),n.stopPropagation(),n.preventDefault();return}}const c=t.wysiwyg.element.querySelector(".img--select");if(c){if(c.classList.remove("img--select"),i.contains(c)){c.insertAdjacentHTML("afterend","<wbr>");const d=i.outerHTML;c.remove(),J(t,i.getAttribute("data-node-id"),i.outerHTML,d),fe(i,a),n.stopPropagation(),n.preventDefault();return}}else if(o===""){const d=ae(i);if(!d){i.classList.add("protyle-wysiwyg--select"),rn(t,i,a),n.stopPropagation(),n.preventDefault();return}const u=yt(d,t.wysiwyg.element,a);if(n.key==="Delete"||$("\u2303D",n)){if(u.end===d.textContent.length){const f=nt(be(i));if(f){const g=le(f);if(g){const h=x(g.startContainer);h&&rn(t,h,g,!0)}n.stopPropagation(),n.preventDefault();return}}else if(u.end===d.textContent.length-1&&i.getAttribute("data-type")==="NodeCodeBlock"){n.stopPropagation(),n.preventDefault();return}}else{const f=a.startContainer.childNodes[a.startOffset-1];if(u.start===0&&(a.startOffset===0||f&&f.nodeType===3&&!Ke(f)&&f.textContent==="")){rn(t,i,a),n.stopPropagation(),n.preventDefault();return}if(a.startContainer.nodeType!==3&&i.getAttribute("data-type")==="NodeTable"&&a.startContainer.children[a.startOffset-1]?.tagName==="TABLE"){i.classList.add("protyle-wysiwyg--select"),rn(t,i,a),n.stopPropagation(),n.preventDefault();return}if(f&&f.nodeType!==3&&f.classList.contains("img")){a.insertNode(document.createElement("wbr"));const h=i.outerHTML;f.remove(),J(t,i.getAttribute("data-node-id"),i.outerHTML,h),fe(i,a),n.stopPropagation(),n.preventDefault();return}if(i.classList.contains("code-block")&&O(n)&&a.startContainer.nodeType===3&&a.startContainer.textContent.substring(a.startOffset-1,a.startOffset)===`
`){n.stopPropagation(),n.preventDefault();return}const g=se(a.startContainer,"SPAN");if(u.start===2&&g&&yt(g,t.wysiwyg.element,a).start===1&&g.textContent.startsWith(p.Constants.ZWSP)){le(i),n.stopPropagation(),n.preventDefault();return}if(u.start===1&&!g&&d.textContent.startsWith(p.Constants.ZWSP)){Uo(d,a),rn(t,i,a),n.stopPropagation(),n.preventDefault();return}}}else if(i.classList.contains("code-block")&&ae(i).textContent===`
`){a.collapse(!0),n.stopPropagation(),n.preventDefault();return}}if($("\u21E7\u21A9",n)&&o===""&&Qy(a,i,t)){n.stopPropagation(),n.preventDefault();return}if(!n.altKey&&R(n)&&n.key==="Enter")if(n.shiftKey){if(i.getAttribute("data-type")==="NodeAttributeView"){n.stopPropagation(),n.preventDefault();return}}else{Xy(i,a,t),n.stopPropagation(),n.preventDefault();return}if($("\u2318A",n))return n.preventDefault(),Fo(t,i,a),!0;if($(window.siyuan.config.keymap.editor.general.undo.custom,n)){t.undo.undo(t),n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.editor.general.redo.custom,n)){t.undo.redo(t),n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.editor.general.copyProtocol.custom,n)){const r=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let c;return r.length===1?c=r[0]:c=i,G(`siyuan://blocks/${c.getAttribute("data-node-id")}`),n.preventDefault(),n.stopPropagation(),!0}if(fg(t,n,i))return!0;if($(window.siyuan.config.keymap.editor.general.copyID.custom,n))return G(i.getAttribute("data-node-id")),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.copyText.custom,n))return o!==""?Mu(a,r=>{G(`${r.trim()} ((${i.getAttribute("data-node-id")} "*"))`)}):(i.setAttribute("data-reftext","true"),Z(re(i)),document.execCommand("copy")),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,n)){const r=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let c;return r.length===1?c=r[0]:c=i,G(`{{select * from blocks where id='${c.getAttribute("data-node-id")}'}}`),n.preventDefault(),n.stopPropagation(),!0}if($(window.siyuan.config.keymap.editor.general.attr.custom,n)){const r=be(i);if(o===""){const c=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let d;c.length===1?d=c[0]:d=r,Ca(d,"bookmark",t)}else Mu(a,c=>{const d=r.outerHTML,u=r.lastElementChild.querySelector(".protyle-attr--name");u?u.innerHTML=`<svg><use xlink:href="#iconN"></use></svg>${c.trim()}`:r.lastElementChild.insertAdjacentHTML("afterbegin",`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${c.trim()}</div>`),r.setAttribute("name",c.trim()),J(t,r.getAttribute("data-node-id"),r.outerHTML,d)});return n.preventDefault(),n.stopPropagation(),!0}if($(window.siyuan.config.keymap.editor.general.rename.custom,n)&&!t.disabled){o===""?w("/api/block/getDocInfo",{id:t.block.rootID},r=>{id({notebookId:t.notebookId,path:t.path,name:r.data.ial.title,range:a,type:"file"})}):w("/api/filetree/renameDoc",{notebook:t.notebookId,path:t.path,title:mn(o)}),n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.editor.general.newNameFile.custom,n)){if(!(!o.trim()&&(i.querySelector("tr")||i.querySelector("span")))){!o.trim()&&ae(i).textContent&&Fo(t,i,a);const r=mn(o.trim()?o.trim():t.lute.BlockDOM2Content(i.outerHTML).replace(/\n/g,""))||"Untitled";w("/api/filetree/getHPathByPath",{notebook:t.notebookId,path:t.path},c=>{w("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:Le().join(c.data,r),parentID:t.block.rootID,markdown:""},d=>{wt(`<span data-type="block-ref" data-id="${d.data}" data-subtype="d">${we(r.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen))}</span>`,t),X(["toolbar"],t)})})}n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.editor.general.newNameSettingFile.custom,n)){!o.trim()&&(i.querySelector("tr")||i.querySelector("span"))||(!o.trim()&&ae(i).textContent&&Fo(t,i,a),od(t.path,t.notebookId,r=>{const c=mn(o.trim()?o.trim():t.lute.BlockDOM2Content(i.outerHTML).replace(/\n/g,""))||"Untitled";w("/api/filetree/createDocWithMd",{notebook:t.notebookId,path:Le().join(r,c),parentID:t.block.rootID,markdown:""},d=>{wt(`<span data-type="block-ref" data-id="${d.data}" data-subtype="d">${we(c.substring(0,window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen))}</span>`,t),X(["toolbar"],t)})})),n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.editor.general.newContentFile.custom,n)){Vw(t),n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.editor.general.alignLeft.custom,n)){const r=i.querySelectorAll(".img--select");if(r.length>0)wg(t,i,Array.from(r),i.getAttribute("data-node-id"),i.outerHTML);else{let c=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));c.length===0&&(c=[i]),bs(c,t,d=>{d.classList.contains("av")?d.style.justifyContent="":d.style.textAlign="left"})}n.stopPropagation(),n.preventDefault();return}if($(window.siyuan.config.keymap.editor.general.alignCenter.custom,n)){const r=i.querySelectorAll(".img--select");if(r.length>0)bg(t,i,Array.from(r),i.getAttribute("data-node-id"),i.outerHTML);else{let c=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));c.length===0&&(c=[i]),bs(c,t,d=>{d.classList.contains("av")?d.style.justifyContent="center":d.style.textAlign="center"})}n.stopPropagation(),n.preventDefault();return}if($(window.siyuan.config.keymap.editor.general.alignRight.custom,n)){let r=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));r.length===0&&(r=[i]),bs(r,t,c=>{c.classList.contains("av")?c.style.justifyContent="flex-end":c.style.textAlign="right"}),n.stopPropagation(),n.preventDefault();return}if(n.key==="Escape"){!t.toolbar.element.classList.contains("fn__none")||!t.hint.element.classList.contains("fn__none")||!t.toolbar.subElement.classList.contains("fn__none")?(X(["toolbar","hint","util"],t),t.hint.enableExtend=!1):i.classList.contains("protyle-wysiwyg--select")?(X(["select"],t),Gt([],t.block.rootID)):window.siyuan.menus.menu.element.classList.contains("fn__none")?(X(["select"],t),a.collapse(!1),i.classList.add("protyle-wysiwyg--select"),Gt([i.getAttribute("data-node-id")],t.block.rootID)):window.siyuan.menus.menu.remove(),n.preventDefault();return}if($(window.siyuan.config.keymap.editor.heading.paragraph.custom,n))return aa({protyle:t,nodeElement:i,type:"Blocks2Ps"}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.heading.heading1.custom,n))return aa({protyle:t,nodeElement:i,type:"Blocks2Hs",level:1}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.heading.heading2.custom,n))return aa({protyle:t,nodeElement:i,type:"Blocks2Hs",level:2}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.heading.heading3.custom,n))return aa({protyle:t,nodeElement:i,type:"Blocks2Hs",level:3}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.heading.heading4.custom,n))return aa({protyle:t,nodeElement:i,type:"Blocks2Hs",level:4}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.heading.heading5.custom,n))return aa({protyle:t,nodeElement:i,type:"Blocks2Hs",level:5}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.heading.heading6.custom,n))return aa({protyle:t,nodeElement:i,type:"Blocks2Hs",level:6}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.insert.code.custom,n)&&!["NodeCodeBlock","NodeHeading"].includes(i.getAttribute("data-type"))){const r=i.getAttribute("data-node-id"),c=i.outerHTML,d=ae(i);d.innerHTML="```"+window.siyuan.storage[p.Constants.LOCAL_CODELANG]+`
`+d.textContent+"<wbr>\n```";const u=t.lute.SpinBlockDOM(i.outerHTML);i.outerHTML=u;const f=t.wysiwyg.element.querySelector(`[data-node-id="${r}"]`);return J(t,r,u,c),qe(f),n.preventDefault(),n.stopPropagation(),!0}if($(window.siyuan.config.keymap.editor.insert.lastUsed.custom,n)){t.toolbar.range=a;let r=[];o===""&&t.toolbar.getCurrentType(a).length===0&&(r=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),r.length===0&&(r=[i])),Ga(t,r),n.stopPropagation(),n.preventDefault();return}if(!i.classList.contains("code-block")&&!n.repeat&&!q(i,"data-type","NodeBlockQueryEmbed")){let r=!1;if(t.options.toolbar.find(c=>{if(!c.hotkey)return!1;if($(c.hotkey,n))return t.toolbar.range=re(t.wysiwyg.element),["block-ref"].includes(c.name)&&t.toolbar.range.toString()===""||(r=!0,["a","block-ref","inline-math","inline-memo","text"].includes(c.name)?t.toolbar.element.querySelector(`[data-type="${c.name}"]`).dispatchEvent(new CustomEvent("click")):t.toolbar.setInlineMark(t,c.name,"range")),!0}),r)return n.preventDefault(),n.stopPropagation(),t.wysiwyg.preventKeyup=!0,!0}if($(window.siyuan.config.keymap.editor.list.outdent.custom,n)){const r=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(r.length>0&&r[0].getAttribute("data-type")==="NodeListItem")return Ul(t,Array.from(r),a),n.preventDefault(),n.stopPropagation(),!0;if(i.parentElement.classList.contains("li")&&i.getAttribute("data-type")!=="NodeCodeBlock")return Ul(t,[i.parentElement],a),n.preventDefault(),n.stopPropagation(),!0}if($(window.siyuan.config.keymap.editor.list.indent.custom,n)){const r=t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(r.length>0&&r[0].getAttribute("data-type")==="NodeListItem")return jf(t,Array.from(r),a),n.preventDefault(),n.stopPropagation(),!0;if(i.parentElement.classList.contains("li")&&i.getAttribute("data-type")!=="NodeCodeBlock")return jf(t,[i.parentElement],a),n.preventDefault(),n.stopPropagation(),!0}if($(window.siyuan.config.keymap.editor.insert.check.custom,n)){t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill("* [ ] "+Lute.Caret,t),n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.editor.insert.table.custom,n)){t.hint.splitChar="/",t.hint.lastIndex=-1,t.hint.fill(`| ${Lute.Caret} |  |  |
| --- | --- | --- |
|  |  |  |
|  |  |  |`,t),n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.editor.list.checkToggle.custom,n)){const r=q(a.startContainer,"data-subtype","t");if(!r)return;const c=r.outerHTML;r.classList.contains("protyle-task--done")?(r.querySelector("use").setAttribute("xlink:href","#iconUncheck"),r.classList.remove("protyle-task--done")):(r.querySelector("use").setAttribute("xlink:href","#iconCheck"),r.classList.add("protyle-task--done")),r.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(t,r.getAttribute("data-node-id"),r.outerHTML,c),n.preventDefault(),n.stopPropagation();return}if($(window.siyuan.config.keymap.editor.general.insertBefore.custom,n))return wn(t,"beforebegin"),n.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.general.insertAfter.custom,n))return wn(t,"afterend"),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,n))return Zf(t,i),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.moveToUp.custom,n)){n.preventDefault(),n.stopPropagation(),Fy(t,i,a);return}if($(window.siyuan.config.keymap.editor.general.moveToDown.custom,n)){n.preventDefault(),n.stopPropagation(),Uy(t,i,a);return}if($(window.siyuan.config.keymap.editor.general.vLayout.custom,n)){n.preventDefault(),n.stopPropagation();const r=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(r.length<2)return;sr({protyle:t,selectsElement:r,type:"BlocksMergeSuperBlock",level:"row"});return}if($(window.siyuan.config.keymap.editor.general.hLayout.custom,n)){n.preventDefault(),n.stopPropagation();const r=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));if(r.length<2)return;sr({protyle:t,selectsElement:r,type:"BlocksMergeSuperBlock",level:"col"});return}if(!n.repeat&&$(window.siyuan.config.keymap.editor.general.duplicate.custom,n)){n.preventDefault(),n.stopPropagation();let r=Array.from(t.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));r.length===0&&(r=[i]),Rd(r,t);return}if(n.key==="Tab"&&R(n)&&!n.altKey){n.preventDefault();const r=window.siyuan.config.editor.codeTabSpaces===0?"	":"".padStart(window.siyuan.config.editor.codeTabSpaces," ");if(i.getAttribute("data-type")==="NodeCodeBlock"&&o!==""){const c=document.createElement("wbr");a.startContainer.nodeType!==3&&a.startContainer.classList.contains("protyle-action")&&a.setStart(i.querySelector(".hljs").firstChild,0),a.insertNode(c),a.setStartAfter(c);const d=i.outerHTML;let u="";n.shiftKey?a.extractContents().textContent.split(`
`).forEach(h=>{h.startsWith(r)?u+=h.replace(r,"")+`
`:u+=h+`
`}):a.extractContents().textContent.split(`
`).forEach(h=>{u+=r+h+`
`});const f=document.createElement("span");let g=i.querySelector(".protyle-action__language").textContent;window.hljs.getLanguage(g)||(g="plaintext"),f.innerHTML=window.hljs.highlight(u.substr(0,u.length-1),{language:g,ignoreIllegals:!0}).value,a.insertNode(f),J(t,i.getAttribute("data-node-id"),i.outerHTML,d),c.remove();return}if(!n.shiftKey){const c=document.createElement("wbr");a.insertNode(c);const d=i.outerHTML;return a.extractContents(),a.insertNode(document.createTextNode(r)),a.collapse(!1),Z(a),c.remove(),J(t,i.getAttribute("data-node-id"),i.outerHTML,d),!0}}if(n.key==="ContextMenu"){const r=$n(i,a);t.wysiwyg.element.dispatchEvent(new CustomEvent("contextmenu",{detail:{target:i,y:r.top+8,x:r.left}})),n.preventDefault(),n.stopPropagation();return}const l=q(a.startContainer,"data-type","block-ref");if(l){const r=l.getAttribute("data-id");if($(window.siyuan.config.keymap.editor.general.openBy.custom,n))return ot(r,(c,d)=>{de({app:t.app,id:r,action:d,zoomIn:c})}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.refTab.custom,n))return ot(r,c=>{de({app:t.app,id:r,action:c?[p.Constants.CB_GET_HL,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],keepCursor:!0,zoomIn:c})}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.insertRight.custom,n))return ot(r,(c,d)=>{de({app:t.app,id:r,position:"right",action:d,zoomIn:c})}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.insertBottom.custom,n))return ot(r,(c,d)=>{de({app:t.app,id:r,position:"bottom",action:d,zoomIn:c})}),n.preventDefault(),n.stopPropagation(),!0;if($(window.siyuan.config.keymap.editor.general.refPopover.custom,n))return window.siyuan.blockPanels.push(new Ro({app:t.app,isBacklink:!1,targetElement:l,nodeIds:[r]})),n.preventDefault(),n.stopPropagation(),!0}if($("\u21E7\u2318V",n)){n.returnValue=!1,n.preventDefault(),n.stopPropagation(),Ed(t);return}if($(window.siyuan.config.keymap.editor.general.showInFolder.custom,n)){const r=q(a.startContainer,"data-type","a");if(r){const c=r.getAttribute("data-href");es(c)&&(fn(c,"folder"),n.preventDefault(),n.stopPropagation())}return}R(n)&&n.key!=="Backspace"&&n.key!=="Escape"&&n.key!=="Delete"&&!n.shiftKey&&!n.altKey&&n.key!=="Enter"&&X(["select"],t)})},lb=(t,e,n)=>{const a=(0,I.tq)(),i=A(t.target,"protyle-attr--bookmark");if(i)return!a&&O(t)?Fn(e.app,i.textContent.trim(),!0):n?Un(n,"bookmark",e):Ca(i.parentElement.parentElement,"bookmark",e),t.stopPropagation(),!0;const s=A(t.target,"protyle-attr--name");if(s)return!a&&O(t)?Fn(e.app,s.textContent.trim(),!0):n?Un(n,"name",e):Ca(s.parentElement.parentElement,"name",e),t.stopPropagation(),!0;const o=A(t.target,"protyle-attr--av");if(o)return n?Un(n,"av",e):Ca(o.parentElement.parentElement,"av",e),t.stopPropagation(),!0;const l=A(t.target,"protyle-attr--alias");if(l)return!a&&O(t)?Fn(e.app,l.textContent.trim(),!0):n?Un(n,"alias",e):Ca(l.parentElement.parentElement,"alias",e),t.stopPropagation(),!0;const r=A(t.target,"protyle-attr--memo");if(r)return!a&&O(t)?Fn(e.app,r.getAttribute("aria-label").trim(),!0):n?Un(n,"memo",e):Ca(r.parentElement.parentElement,"memo",e),t.stopPropagation(),!0};class RE{constructor(e){this.lastHTMLs={},this.element=document.createElement("div"),this.element.className="protyle-wysiwyg",this.element.setAttribute("spellcheck","false"),(0,I.tq)()?this.element.setAttribute("contenteditable","false"):this.element.setAttribute("contenteditable","true"),window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.bindCommonEvent(e),!e.options.action.includes(p.Constants.CB_GET_HISTORY)&&(this.bindEvent(e),OE(e,this.element),$E(e,this.element))}renderCustom(e){let n=e[p.Constants.CUSTOM_SY_FULLWIDTH];n||(n=window.siyuan.config.editor.fullWidth?"true":"false"),n==="true"?this.element.parentElement.setAttribute("data-fullwidth","true"):this.element.parentElement.removeAttribute("data-fullwidth");const a=Object.keys(e);for(let i=0;i<this.element.attributes.length;i++){const s=this.element.attributes[i].nodeName;!["type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth"].includes(s)&&!a.includes(s)&&(this.element.removeAttribute(s),i--)}a.forEach(i=>{["title-img","title","updated","icon","id","type","class","spellcheck","contenteditable","data-doc-type","style","data-realwidth"].includes(i)||this.element.setAttribute(i,e[i])})}escapeInline(e,n,a){if(!a.data)return;const i=a.data;e.toolbar.range=n;const s=n.startContainer.parentElement,o=e.toolbar.getCurrentType();let l=i.length;if((i==="<"||i===">")&&(l=4),o.length>0&&n.toString()===""&&n.startOffset===i.length&&s.tagName==="SPAN"&&s.textContent.replace(p.Constants.ZWSP,"")!==i&&s.textContent.replace(p.Constants.ZWSP,"").length>=i.length&&!Ke(n.startContainer)&&!Ke(s)){const r=s.innerHTML.replace(p.Constants.ZWSP,"");s.innerHTML=r.substr(l);const c=document.createTextNode(i);s.before(c),n.selectNodeContents(c),n.collapse(!1);return}if(s.tagName==="SPAN"&&s.textContent!==i&&!o.includes("search-mark")&&n.toString()===""&&n.startContainer.nodeType===3&&(o.includes("inline-memo")||o.includes("text")||o.includes("block-ref")||o.includes("file-annotation-ref")||o.includes("a"))&&!rt(n.startContainer)&&n.startContainer.textContent.length===n.startOffset&&s.textContent.length>i.length){const r=yt(s,e.wysiwyg.element,n),c=s.innerHTML;if(r.start===s.textContent.length){s.innerHTML=c.substr(0,c.length-l);const d=document.createTextNode(i);s.after(d),n.selectNodeContents(d),n.collapse(!1)}}}setEmptyOutline(e,n){e.wysiwyg.element.querySelectorAll(".img--select, .av__cell--select, .av__row--select").forEach(i=>{i.classList.contains("av__row--select")&&!A(n,"av")?(i.classList.remove("av__row--select"),i.querySelector(".av__firstcol use").setAttribute("xlink:href","#iconUncheck"),ls(i)):i.classList.remove("img--select","av__cell--select")});let a=n;if(!n.getAttribute("data-node-id")){const i=x(n);if(!i)return;a=i}e.model&&Pe().outline.forEach(i=>{i.blockId===e.block.rootID&&i.setCurrent(a)})}emojiToMd(e){e.querySelectorAll(".emoji").forEach(n=>{n.outerHTML=`:${n.getAttribute("alt")}:`})}bindCommonEvent(e){this.element.addEventListener("copy",n=>{if(window.siyuan.ctrlIsPressed=!1,n.target.tagName==="PROTYLE-HTML"){n.stopPropagation();return}n.stopPropagation(),n.preventDefault();const a=re(e.wysiwyg.element),i=x(a.startContainer);if(!i)return;const s=i.querySelector(".img--select"),o=i.querySelector(".av__row--select, .av__cell--select");let l=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));l.length===0&&a.toString()===""&&!a.cloneContents().querySelector("img")&&!s&&!o&&(i.classList.add("protyle-wysiwyg--select"),Gt([i.getAttribute("data-node-id")]),l=[i]);let r="",c="";if(l.length>0){const d=l[0].getAttribute("data-reftext")==="true";if(l[0].getAttribute("data-type")==="NodeListItem"&&l[0].parentElement.classList.contains("list")&&l[0].parentElement.childElementCount-1===l.length)if(d){const u=l[0].parentElement.cloneNode(!0),f=ae(u);f&&f.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${u.getAttribute("data-node-id")}">*</span>`),r=u.outerHTML,l[0].removeAttribute("data-reftext")}else r=l[0].parentElement.outerHTML;else l.forEach((u,f)=>{if(d&&f===0){const g=u.cloneNode(!0),h=ae(g);h&&h.insertAdjacentHTML("beforeend",` <span data-type="block-ref" data-subtype="s" data-id="${u.getAttribute("data-node-id")}">*</span>`),r+=ma(g),l[0].removeAttribute("data-reftext")}else r+=ma(u)})}else if(o){const d=Array.from(i.querySelectorAll(".av__cell--select"))||[];d.length===0&&i.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(u=>{u.querySelectorAll(".av__cell").forEach(f=>{d.push(f)})}),d.forEach(u=>{const f=wd(u);r+=f,c+=f})}else{const d=document.createElement("div"),u=e.toolbar.getCurrentType(a);if((u.length>0||a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading")&&(a.startContainer.nodeType===3&&a.startContainer.parentElement.textContent===a.toString()||a.startContainer.nodeType!==3&&a.startContainer.textContent===a.toString()))a.startContainer.parentElement.parentElement.getAttribute("data-type")==="NodeHeading"?d.append(a.startContainer.parentElement.parentElement.cloneNode(!0)):["DIV","TD","TH","TR"].includes(a.startContainer.parentElement.tagName)?(d.append(a.cloneContents()),this.emojiToMd(d)):(d.append(a.startContainer.parentElement.cloneNode(!0)),this.emojiToMd(d)),r=d.innerHTML;else if(s)r=s.outerHTML;else if(u.length>0&&a.startContainer.nodeType===3&&a.startContainer.parentElement.tagName==="SPAN"&&a.startContainer.parentElement.isSameNode(a.endContainer.parentElement)){const f=a.startContainer.parentElement.attributes,g=document.createElement("span");for(let h=0;h<f.length;h++)g.setAttribute(f[h].name,f[h].value);g.getAttribute("data-type").indexOf("block-ref")>-1&&g.getAttribute("data-subtype")==="d"&&g.setAttribute("data-subtype","s"),g.textContent=a.toString(),r=g.outerHTML}else{d.append(a.cloneContents()),this.emojiToMd(d);const f=q(a.commonAncestorContainer,"data-type","inline-math");f?r=f.outerHTML:r=d.innerHTML,(q(a.startContainer,"data-type","NodeCodeBlock")||se(a.startContainer,"CODE"))&&(c=d.textContent.replace(p.Constants.ZWSP,""))}}e.disabled&&(r=Ww(r)),c=c||e.lute.BlockDOM2StdMd(r).trimEnd(),c=c.replace(/\u00A0/g," "),n.clipboardData.setData("text/plain",c),n.clipboardData.setData("text/html",e.lute.BlockDOM2HTML(r)),n.clipboardData.setData("text/siyuan",r)}),this.element.addEventListener("mousedown",n=>{if(n.button===2||window.siyuan.ctrlIsPressed)return;window.siyuan.shiftIsPressed&&getSelection().rangeCount>0&&(this.shiftStartElement=x(getSelection().getRangeAt(0).startContainer)),window.siyuan.shiftIsPressed||X(["select"],e);const a=n.target;if(A(a,"protyle-action")||A(a,"av__cellheader"))return;const i=document,s=e.element.getBoundingClientRect(),o=s.left+(parseInt(e.wysiwyg.element.style.paddingLeft)||24)+1,l=o+(e.wysiwyg.element.clientWidth-(parseInt(e.wysiwyg.element.style.paddingLeft)||24)-(parseInt(e.wysiwyg.element.style.paddingRight)||16))-2,r=s.bottom,c=n.clientY;if(!e.disabled&&a.classList.contains("av__widthdrag")){const y=x(a);if(!y)return;const _=y.getAttribute("data-av-id"),v=a.parentElement,k=v.clientWidth,L=v.getAttribute("data-col-id");let C;const E=y.querySelector(".av__scroll"),T=e.contentElement.getBoundingClientRect();i.onmousemove=H=>{C=Math.max(k+(H.clientX-n.clientX),25)+"px",E.querySelectorAll(".av__row, .av__row--footer").forEach(D=>{D.querySelector(`[data-col-id="${L}"]`).style.width=C}),Ua(y,T,"bottom")},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,!(!C||C===k+"px")&&F(e,[{action:"setAttrViewColWidth",id:L,avID:_,data:C}],[{action:"setAttrViewColWidth",id:L,avID:_,data:k+"px"}])},n.stopPropagation(),n.preventDefault();return}if(!e.disabled&&a.classList.contains("protyle-action__drag")){const y=x(a);if(!y)return;let _=!0;["NodeIFrame","NodeWidget","NodeVideo"].includes(y.getAttribute("data-type"))?(y.classList.add("iframe--drag"),(y.style.textAlign==="left"||y.style.textAlign==="right")&&(_=!1)):a.parentElement.parentElement.getAttribute("data-type")==="img"&&a.parentElement.parentElement.classList.add("img--drag");const v=y.getAttribute("data-node-id"),k=y.outerHTML,L=n.clientX,C=a.previousElementSibling,E=C.clientWidth,T=C.clientHeight;i.onmousemove=H=>{C.tagName==="IMG"&&(C.parentElement.parentElement.style.width=""),H.clientX>L-E+8&&H.clientX<l&&(C.tagName==="IMG"&&C.parentElement.parentElement.style.display!=="block"||!_?C.style.width=Math.max(17,E+(H.clientX-L))+"px":C.style.width=Math.max(17,E+(H.clientX-L)*2)+"px"),C.tagName!=="IMG"?H.clientY>c-T+8&&H.clientY<r&&(C.style.height=T+(H.clientY-c)+"px"):C.parentElement.parentElement.style.width=parseInt(C.style.width)+10+"px"},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,a.classList.contains("protyle-action__drag")&&y&&J(e,v,y.outerHTML,k),y.classList.remove("iframe--drag"),a.parentElement.parentElement.classList.remove("img--drag")};return}let d;if((a.tagName==="TH"||a.tagName==="TD"||a.firstElementChild?.tagName==="TABLE"||a.classList.contains("table__resize")||a.classList.contains("table__select"))&&(d=x(a),d&&(d.querySelector(".table__select").removeAttribute("style"),window.siyuan.menus.menu.remove(),n.stopPropagation())),!e.disabled&&a.classList.contains("table__resize")){const y=x(a);if(!y)return;const _=y.outerHTML;getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),y.firstElementChild.style.webkitUserModify="read-only",y.style.cursor="col-resize",a.removeAttribute("style");const v=y.getAttribute("data-node-id"),k=n.clientX,L=parseInt(a.getAttribute("data-col-index")),C=y.querySelectorAll("table col")[L];C.style.minWidth&&(C.style.width=y.querySelectorAll("table td, table th")[L].offsetWidth+"px",C.style.minWidth=""),y.querySelectorAll("tr").forEach(H=>{H.cells[L].style.width=""});const E=C.clientWidth,T=y.firstElementChild.clientWidth<y.firstElementChild.scrollWidth;i.onmousemove=H=>{y.style.textAlign==="center"&&!T?C.style.width=E+(H.clientX-k)*2+"px":C.style.width=E+(H.clientX-k)+"px"},i.onmouseup=()=>{y.firstElementChild.style.webkitUserModify="",y.style.cursor="",i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,y&&J(e,v,y.outerHTML,_)};return}if(["IMG","VIDEO","AUDIO"].includes(a.tagName))return;let u=n.clientX;n.clientX>l?u=l:n.clientX<o&&(u=o);const f=s.top+(e.options.render.breadcrumb?e.breadcrumb.element.parentElement.clientHeight:0);let g,h,m,b;i.onmousemove=y=>{const _=y.target;if(!e.disabled&&d&&d.contains(_)&&!A(d,"protyle-wysiwyg__embed")){if((_.tagName==="TH"||_.tagName==="TD")&&!_.isSameNode(a)&&(!h||!h.isSameNode(_))){d.firstElementChild.style.webkitUserModify="read-only";let xe=a.offsetLeft+a.clientWidth-_.offsetLeft,je=_.offsetLeft;a.offsetLeft===_.offsetLeft?xe=Math.max(a.clientWidth,_.clientWidth):a.offsetLeft<_.offsetLeft&&(xe=_.offsetLeft+_.clientWidth-a.offsetLeft,je=a.offsetLeft);let Ct=a.offsetTop+a.clientHeight-_.offsetTop,Ve=_.offsetTop;a.offsetTop===_.offsetTop?Ct=Math.max(a.clientHeight,_.clientHeight):a.offsetTop<_.offsetTop&&(Ct=_.offsetTop+_.clientHeight-a.offsetTop,Ve=a.offsetTop),Array.from(d.querySelectorAll("th, td")).find(ue=>{const Te=ue.offsetLeft<je+xe&&ue.offsetLeft+ue.clientWidth>je+xe,vt=ue.offsetLeft<je&&ue.offsetLeft+ue.clientWidth>je;ue.offsetTop<Ve&&ue.offsetTop+ue.clientHeight>Ve?((ue.offsetLeft+6>je&&ue.offsetLeft+ue.clientWidth-6<je+xe||Te||vt)&&(Ct=Ve+Ct-ue.offsetTop,Ve=ue.offsetTop),Te&&(xe=ue.offsetLeft+ue.clientWidth-je),vt&&(xe=je+xe-ue.offsetLeft,je=ue.offsetLeft)):ue.offsetTop<Ve+Ct&&ue.offsetTop+ue.clientHeight>Ve+Ct?((ue.offsetLeft+6>je&&ue.offsetLeft+ue.clientWidth-6<je+xe||Te||vt)&&(Ct=ue.clientHeight+ue.offsetTop-Ve),Te&&(xe=ue.offsetLeft+ue.clientWidth-je),vt&&(xe=je+xe-ue.offsetLeft,je=ue.offsetLeft)):vt&&ue.offsetTop+6>Ve&&ue.offsetTop+ue.clientHeight-6<Ve+Ct?(xe=je+xe-ue.offsetLeft,je=ue.offsetLeft):Te&&ue.offsetTop+6>Ve&&ue.offsetTop+ue.clientHeight-6<Ve+Ct&&(xe=ue.offsetLeft+ue.clientWidth-je)}),d.querySelector(".table__select").setAttribute("style",`left:${je-d.firstElementChild.scrollLeft}px;top:${Ve}px;height:${Ct}px;width:${xe+1}px;`),h=_}return}e.selectElement.classList.remove("fn__none"),X(["gutter"],e);let v=0,k=0,L=0,C=0;if(y.clientX<u?(y.clientX<o?k=o:k=y.clientX,L=u-k):y.clientX>l?(k=u,L=l-k):(k=u,L=y.clientX-u),y.clientY>c?y.clientY>r?(v=c,C=r-c):(v=c,C=y.clientY-c):(y.clientY<f?v=f:v=y.clientY,C=c-v),C<4)return;e.selectElement.setAttribute("style",`background-color: ${e.selectElement.style.backgroundColor};top:${v}px;height:${C}px;left:${k+2}px;width:${L-2}px;`);const E=document.elementFromPoint(y.clientX,y.clientY);if(g&&g.isSameNode(E)&&!g.classList.contains("protyle-wysiwyg")&&!g.classList.contains("list")&&!g.classList.contains("bq")&&!g.classList.contains("sb"))return;g=E,X(["select"],e);let T;if(y.clientY>c?(T=m||document.elementFromPoint(k,v),b=void 0):(T=document.elementFromPoint(k,v),m=void 0),!T||((T.classList.contains("protyle-wysiwyg")||T.classList.contains("list")||T.classList.contains("sb")||T.classList.contains("bq"))&&(T=document.elementFromPoint(k,v+16)),!T))return;let H=x(T);y.clientY>c?m||(m=T):!H&&y.clientY<e.wysiwyg.element.lastElementChild.getBoundingClientRect().bottom&&(H=e.wysiwyg.element.firstElementChild);let D=[],U=H,ye=!1;const Fe=b?b.getBoundingClientRect().bottom:v+C;for(;U;)if(U&&!U.classList.contains("protyle-attr")){const xe=U.getBoundingClientRect();if(xe.height>0&&xe.top<Fe&&xe.left<k+L)if(ye)if(U.nextElementSibling&&!U.nextElementSibling.classList.contains("protyle-attr")){const je=U.nextElementSibling.getBoundingClientRect();if(je.top<Fe&&je.left<k+L)D=[U],U=U.nextElementSibling,ye=!1;else if(U.parentElement.classList.contains("sb"))U=x(U.parentElement),ye=!0;else break}else U=x(U.parentElement),ye=!0;else D.push(U),U=U.nextElementSibling;else if(U.parentElement.classList.contains("sb"))U=x(U.parentElement),ye=!0;else if(xe.height===0&&xe.width===0&&U.parentElement.getAttribute("fold")==="1")U=U.parentElement,D=[];else break}else U=x(U.parentElement),ye=!0;y.clientY<=c&&!b&&(b=D[D.length-1]),D.length===1&&!D[0].classList.contains("list")&&!D[0].classList.contains("bq")&&!D[0].classList.contains("sb")?e.selectElement.style.backgroundColor="transparent":(D.forEach(xe=>{A(xe,"protyle-wysiwyg__embed")||xe.classList.add("protyle-wysiwyg--select")}),e.selectElement.style.backgroundColor="")},i.onmouseup=y=>{if(i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null,m=void 0,b=void 0,e.selectElement.classList.add("fn__none"),e.selectElement.removeAttribute("style"),!e.disabled&&d){d.firstElementChild.style.webkitUserModify="";const k=d.querySelector(".table__select");k.getAttribute("style")&&(getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!1),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.mergeCell,click:()=>{if(d){const L=[],C=[],E=d.querySelectorAll("th").length;let T=0;const H=d.firstElementChild.scrollLeft;let D=!1,U=!1;d.querySelectorAll("th, td").forEach((Te,vt)=>{Te.classList.contains("fn__none")?(Te.previousElementSibling&&Te.previousElementSibling.isSameNode(L[L.length-1])||vt<T&&C.includes((vt+1)%E))&&(L.push(Te),!D&&Te.parentElement.parentElement.tagName==="THEAD"?D=!0:!U&&Te.parentElement.parentElement.tagName==="TBODY"&&(U=!0)):Te.offsetLeft+6>k.offsetLeft+H&&Te.offsetLeft+Te.clientWidth-6<k.offsetLeft+H+k.clientWidth&&Te.offsetTop+6>k.offsetTop&&Te.offsetTop+Te.clientHeight-6<k.offsetTop+k.clientHeight&&(L.push(Te),!D&&Te.parentElement.parentElement.tagName==="THEAD"?D=!0:!U&&Te.parentElement.parentElement.tagName==="TBODY"&&(U=!0),C.push((vt+1)%E),T=Math.max((Te.rowSpan-1)*E+vt+1,T))}),k.removeAttribute("style");const ye=d.outerHTML;let Fe=L[0],xe=Fe.colSpan,je=1;for(;Fe.nextElementSibling&&Fe.nextElementSibling.isSameNode(L[je]);)Fe=Fe.nextElementSibling,Fe.classList.contains("fn__none")||(xe+=Fe.colSpan),je++;let Ct="",Ve=L[0].parentElement,ue=L[0].rowSpan;if(L.forEach((Te,vt)=>{let Rt=Te.innerHTML.trim();Rt.endsWith("<br>")&&(Rt=Rt.substr(0,Rt.length-4)),Ct+=Rt+(!Rt||vt===L.length-1?"":"<br>"),vt!==0&&(Ve.isSameNode(Te.parentElement)||(Te.classList.contains("fn__none")||(ue+=Te.rowSpan),Ve=Te.parentElement,L[0].parentElement.parentElement.tagName==="THEAD"&&Te.parentElement.parentElement.tagName!=="THEAD"&&L[0].parentElement.parentElement.insertAdjacentElement("beforeend",Te.parentElement)),Te.classList.add("fn__none"),Te.innerHTML="")}),D&&U)for(Ve=Ve.parentElement.nextElementSibling.firstElementChild;Ve&&Ve.parentElement.tagName!=="THEAD";){let Te=0,vt=0;if(Array.from(Ve.children).forEach(Rt=>{Te+=Rt.colSpan-1,Rt.classList.contains("fn__none")&&vt++}),Te!==vt)L[0].parentElement.parentElement.insertAdjacentElement("beforeend",Ve),Ve=Ve.parentElement.nextElementSibling.firstElementChild;else break}setTimeout(()=>{d&&(L[0].innerHTML=Ct+"<wbr>",L[0].colSpan=xe,L[0].rowSpan=ue,fe(L[0],document.createRange()),J(e,d.getAttribute("data-node-id"),d.outerHTML,ye))})}}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,label:window.siyuan.languages.alignLeft,click:()=>{if(d){const L=[],C=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(E=>{!E.classList.contains("fn__none")&&E.offsetLeft+6>k.offsetLeft+C&&E.offsetLeft+E.clientWidth-6<k.offsetLeft+C+k.clientWidth&&E.offsetTop+6>k.offsetTop&&E.offsetTop+E.clientHeight-6<k.offsetTop+k.clientHeight&&(L.length===0||L.length>0&&E.offsetTop===L[0].offsetTop)&&L.push(E)}),k.removeAttribute("style"),ya(e,L,d,"left",re(d))}}}).element),window.siyuan.menus.menu.append(new S({icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,label:window.siyuan.languages.alignCenter,click:()=>{if(d){const L=[],C=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(E=>{!E.classList.contains("fn__none")&&E.offsetLeft+6>k.offsetLeft+C&&E.offsetLeft+E.clientWidth-6<k.offsetLeft+C+k.clientWidth&&E.offsetTop+6>k.offsetTop&&E.offsetTop+E.clientHeight-6<k.offsetTop+k.clientHeight&&(L.length===0||L.length>0&&E.offsetTop===L[0].offsetTop)&&L.push(E)}),k.removeAttribute("style"),ya(e,L,d,"center",re(d))}}}).element),window.siyuan.menus.menu.append(new S({icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,label:window.siyuan.languages.alignRight,click:()=>{if(d){const L=[],C=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(E=>{!E.classList.contains("fn__none")&&E.offsetLeft+6>k.offsetLeft+C&&E.offsetLeft+E.clientWidth-6<k.offsetLeft+C+k.clientWidth&&E.offsetTop+6>k.offsetTop&&E.offsetTop+E.clientHeight-6<k.offsetTop+k.clientHeight&&(L.length===0||L.length>0&&E.offsetTop===L[0].offsetTop)&&L.push(E)}),k.removeAttribute("style"),ya(e,L,d,"right",re(d))}}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.clear,icon:"iconTrashcan",click(){if(d){const L=[],C=d.firstElementChild.scrollLeft;d.querySelectorAll("th, td").forEach(T=>{!T.classList.contains("fn__none")&&T.offsetLeft+6>k.offsetLeft+C&&T.offsetLeft+T.clientWidth-6<k.offsetLeft+C+k.clientWidth&&T.offsetTop+6>k.offsetTop&&T.offsetTop+T.clientHeight-6<k.offsetTop+k.clientHeight&&L.push(T)}),k.removeAttribute("style");const E=d.outerHTML;L.forEach(T=>{T.innerHTML=""}),J(e,d.getAttribute("data-node-id"),d.outerHTML,E)}}}).element),window.siyuan.menus.menu.popup({x:y.clientX-8,y:y.clientY-16}))}const _=[],v=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(v.forEach(k=>{_.push(k.getAttribute("data-node-id"))}),Gt(_),getSelection().rangeCount>0){const k=getSelection().getRangeAt(0);if((k.toString()===""||window.siyuan.shiftIsPressed)&&n.detail>2){let E=x(k.startContainer);if(E){if(E.nextElementSibling?.classList.contains("table"))Xt(ae(E),k,!1);else if(E.classList.contains("table")){const T=E.querySelectorAll("th, td");E=T[T.length-1],E.contains(k.startContainer)&&Xt(E,k,!1)}}return}if(v.length>0){k.collapse(!0);return}const L=x(k.startContainer);let C;y.detail>2&&k.endContainer.nodeType!==3&&k.endContainer.tagName==="DIV"&&k.endOffset===0?k.endContainer.classList.contains("protyle-attr")&&L&&Xt(ae(L),k,!1):C=x(k.endContainer),L&&C&&!C.isSameNode(L)&&k.collapse(!0)}}})}bindEvent(e){e.observer=new ResizeObserver(()=>{const l=e.contentElement.getBoundingClientRect();e.wysiwyg.element.querySelectorAll(".av").forEach(r=>{r.querySelector(".av__title")&&Ua(r,l,"all")})}),this.element.addEventListener("focusout",()=>{if(getSelection().rangeCount===0)return;const l=getSelection().getRangeAt(0);(this.element.isSameNode(l.startContainer)||this.element.contains(l.startContainer))&&(e.toolbar.range=l)}),this.element.addEventListener("cut",l=>{if(window.siyuan.ctrlIsPressed=!1,e.disabled)return;if(l.target.tagName==="PROTYLE-HTML"){l.stopPropagation();return}e.options.render.breadcrumb&&e.breadcrumb.hide();const r=re(e.wysiwyg.element);let c=x(r.startContainer);if(!c){l.stopPropagation(),l.preventDefault();return}l.stopPropagation(),l.preventDefault();const d=c.querySelector(".img--select"),u=c.querySelector(".av__row--select, .av__cell--select");let f=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));f.length===0&&r.toString()===""&&!r.cloneContents().querySelector("img")&&!d&&!u&&(c.classList.add("protyle-wysiwyg--select"),f=[c]);let g="";if(f.length>0){f[0].getAttribute("data-type")==="NodeListItem"&&f[0].parentElement.classList.contains("list")&&f[0].parentElement.childElementCount-1===f.length?g=f[0].parentElement.outerHTML:(f.forEach(b=>{const y=be(b);b.getAttribute("data-type")==="NodeHeading"&&b.getAttribute("fold")==="1"?g+=ma(y).replace('fold="1"',""):g+=ma(y)}),f[0].getAttribute("data-type")==="NodeListItem"&&(g=`<div data-subtype="${f[0].getAttribute("data-subtype")}" data-node-id="${Lute.NewNodeID()}" data-type="NodeList" class="list">${g}<div class="protyle-attr" contenteditable="false">${p.Constants.ZWSP}</div></div>`));const m=nt(f[f.length-1]);rn(e,c,r),m&&le(m)}else if(u)g=An(e,c);else{const m=c.getAttribute("data-node-id"),b=c.outerHTML,y=document.createElement("div");let _=r.startContainer;if(_.nodeType===3&&_.textContent===""){const L=rt(r.startContainer);L&&(_=L)}const v=q(_,"data-type","NodeHeading");let k=!1;if(v&&r.toString()===v.firstElementChild.textContent){const L=[{action:"delete",id:v.getAttribute("data-node-id")}],C=[{action:"insert",id:v.getAttribute("data-node-id"),data:v.outerHTML,previousID:v.previousElementSibling?.getAttribute("data-node-id"),parentID:v.parentElement?.getAttribute("data-node-id")||e.block.parentID}];if(v.getAttribute("fold")==="1"){k=!0;const E=v.cloneNode(!0);E.removeAttribute("fold"),y.append(E),C[0].data=E.outerHTML,zt(e,v,void 0,!0)}else{if(v.parentElement.childElementCount===3&&v.parentElement.classList.contains("li")||v.parentElement.childElementCount===2&&(v.parentElement.classList.contains("bq")||v.parentElement.classList.contains("sb"))||v.parentElement.childElementCount===1&&v.parentElement.classList.contains("protyle-wysiwyg")){const E=Lute.NewNodeID(),T=Cn(!1,!1,E);L.push({id:E,data:T.outerHTML,action:"insert",parentID:v.parentElement.getAttribute("data-node-id")||e.block.parentID}),C.push({id:E,action:"delete"}),v.before(T)}Rr(v),y.append(v)}F(e,L,C)}else if(r.toString()!==""&&_.isSameNode(r.endContainer)&&r.startContainer.nodeType===3&&r.endOffset===r.endContainer.textContent.length&&r.startOffset===0&&!["DIV","TD","TH","TR"].includes(r.startContainer.parentElement.tagName))y.append(r.startContainer.parentElement);else if(d)y.append(d);else if(r.startContainer.nodeType===3&&r.startContainer.parentElement.tagName==="SPAN"&&r.startContainer.parentElement.getAttribute("data-type")&&r.startContainer.parentElement.isSameNode(r.endContainer.parentElement)){const L=r.startContainer.parentElement,C=L.attributes,E=document.createElement("span");for(let T=0;T<C.length;T++)E.setAttribute(C[T].name,C[T].value);L.getAttribute("data-type").indexOf("block-ref")>-1&&L.getAttribute("data-subtype")==="d"&&(E.setAttribute("data-subtype","s"),L.setAttribute("data-subtype","s")),E.textContent=r.toString(),r.deleteContents(),y.append(E)}else if(r.cloneContents().querySelectorAll("td, th").length>0){const L=document.createElement("wbr");r.insertNode(L),r.setStartAfter(L),y.append(r.extractContents()),c.outerHTML=e.lute.SpinBlockDOM(c.outerHTML),c=e.wysiwyg.element.querySelector(`[data-node-id="${m}"]`),fe(c,r)}else{const L=q(r.commonAncestorContainer,"data-type","inline-math");if(L)y.append(L);else{y.append(r.extractContents());let C;c.classList.contains("av")?vd(e,c):c.classList.contains("table")?C=se(r.startContainer,"TD")||se(r.startContainer,"TH"):C=ae(c),C&&Array.from(C.children).forEach(E=>{E.textContent===""&&E.nodeType===1&&!["BR","IMG"].includes(E.tagName)&&E.remove()})}}if(this.emojiToMd(y),g=y.innerHTML,!c.classList.contains("table")){const L=ae(c);L&&L.textContent===""&&(L.innerHTML="")}c.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),c.getAttribute("data-type")==="NodeCodeBlock"&&(r.insertNode(document.createElement("wbr")),ae(c).removeAttribute("data-render"),qe(c)),c.parentElement.parentElement&&!k&&!c.classList.contains("av")&&J(e,m,c.outerHTML,b)}e.hint.render(e);let h=e.lute.BlockDOM2StdMd(g).trimEnd();h=h.replace(/\u00A0/g," "),l.clipboardData.setData("text/plain",h),l.clipboardData.setData("text/html",e.lute.BlockDOM2HTML(g)),l.clipboardData.setData("text/siyuan",g)});let n;this.element.addEventListener("contextmenu",l=>{if(l.shiftKey)return;l.stopPropagation(),l.preventDefault();const r=l.clientX||l.detail.x,c=l.clientY||l.detail.y,d=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(d.length>1){X(["util"],e),e.gutter.renderMenu(e,d[0]),window.siyuan.menus.menu.popup({x:r,y:c});return}const u=l.detail.target||l.target,f=q(u,"data-type","NodeBlockQueryEmbed");if(f)return getSelection().rangeCount===0&&Rr(f),e.gutter.renderMenu(e,f),window.siyuan.menus.menu.popup({x:r,y:c}),!1;if(e.toolbar.range=re(e.element),u.tagName==="SPAN"){let y=e.toolbar.getCurrentType(e.toolbar.range);if(y.length===0&&(y=(u.dataset.type||"").split(" ")),y.length>0&&ug(u),y.includes("block-ref"))return Fd(e,u),u.setAttribute("prevent-popover","true"),setTimeout(()=>{u.removeAttribute("prevent-popover")},620),!1;if(y.includes("file-annotation-ref")&&!e.disabled)return qd(e,u),!1;if(y.includes("tag")&&!e.disabled)return Vd(e,u),!1;if(y.includes("inline-memo"))return e.toolbar.showRender(e,u),!1;if(y.includes("a")&&!e.disabled)return vo(e,u),window.siyuan.config.editor.floatWindowMode===0&&u.getAttribute("data-href")?.startsWith("siyuan://blocks")&&(u.setAttribute("prevent-popover","true"),setTimeout(()=>{u.removeAttribute("prevent-popover")},620)),!1}if(u.tagName==="IMG"&&A(u,"img"))return Wd(e,e.toolbar.range,u.parentElement.parentElement,{clientX:r+4,clientY:c}),!1;const g=A(u,"av__row");if(g&&Kl(e,g,{x:l.clientX,y:g.getBoundingClientRect().bottom,h:g.clientHeight})){l.stopPropagation(),l.preventDefault();return}const h=x(u);if(!h)return!1;if(A(u,"av__cellheader")){Tg(e,h,u.parentElement),l.stopPropagation(),l.preventDefault();return}const b=A(u,"item");if(h.classList.contains("av")&&b){b.classList.contains("item--focus")?ro({protyle:e,blockElement:h,element:b}):(h.removeAttribute("data-render"),mt(h,e,()=>{ro({protyle:e,blockElement:h,element:h.querySelector(".item.item--focus")})},b.dataset.id)),l.stopPropagation(),l.preventDefault();return}!Ft(h)&&!h.classList.contains("protyle-wysiwyg--select")&&!A(u,"protyle-action")&&((0,I.tq)()||l.detail.target||n&&h.contains(n.startContainer))?(!(0,I.tq)()||e.toolbar?.element.classList.contains("fn__none"))&&!h.classList.contains("av")&&(s_(e,h),window.siyuan.menus.menu.popup({x:r,y:c+13,h:26}),e.toolbar?.element.classList.add("fn__none"),h.classList.contains("table")&&h.querySelector(".table__select").removeAttribute("style")):e.toolbar.range.toString()===""&&(X(["util"],e),e.gutter&&e.gutter.renderMenu(e,h),window.siyuan.menus.menu.popup({x:r,y:c}),e.toolbar?.element.classList.add("fn__none"))}),this.element.addEventListener("pointerdown",()=>{getSelection().rangeCount>0?n=getSelection().getRangeAt(0):n=void 0});let a=!1;this.element.addEventListener("mousewheel",l=>{if(!a&&l.deltaY<0&&!e.scroll.element.classList.contains("fn__none")&&e.contentElement.clientHeight===e.contentElement.scrollHeight&&e.wysiwyg.element.firstElementChild.getAttribute("data-eof")!=="1"&&(w("/api/filetree/getDoc",{id:e.wysiwyg.element.firstElementChild.getAttribute("data-node-id"),mode:1,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{a=!1,st({data:c,protyle:e,action:[p.Constants.CB_GET_BEFORE,p.Constants.CB_GET_UNCHANGEID]})}),a=!0),l.deltaX===0)return;const r=A(l.target,"table");if(r){const c=r.querySelector(".table__select");c?.style.width&&(c.removeAttribute("style"),window.siyuan.menus.menu.remove())}},{passive:!0});let i=!1;this.element.addEventListener("mouseover",l=>{const r=A(l.target,"protyle-attr");if(r){i=!0,r.parentElement.classList.add("protyle-wysiwyg--hl");return}else if(i){const d=e.wysiwyg.element.querySelector(".protyle-wysiwyg--hl");d&&d.classList.remove("protyle-wysiwyg--hl"),i=!1}if(A(l.target,"protyle-action")||!e.options.render.gutter)return;const c=x(l.target);if(!(c&&(c.classList.contains("list")||c.classList.contains("li")))&&c){const d=q(c,"data-type","NodeBlockQueryEmbed");d?e.gutter.render(e,d,this.element):e.gutter.render(e,c,this.element,l.target)}}),this.element.addEventListener("paste",l=>{if(e.disabled){l.stopPropagation(),l.preventDefault();return}if(window.siyuan.ctrlIsPressed=!1,l.target.tagName==="PROTYLE-HTML"){l.stopPropagation();return}if(!q(l.target,"contenteditable","true")){l.stopPropagation(),l.preventDefault();return}const r=x(l.target);if(r&&!ae(r)){l.stopPropagation(),l.preventDefault();return}Rp(e,l)});let s=!1;this.element.addEventListener("compositionstart",l=>{const r=re(e.wysiwyg.element),c=x(r.startContainer);c&&typeof e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]>"u"&&(r.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove()),s=!0,l.stopPropagation()}),this.element.addEventListener("compositionend",l=>{l.stopPropagation(),s=!1;const r=re(this.element),c=x(r.startContainer);if(!(c&&c.getAttribute("data-type")==="NodeHTMLBlock")&&c)if(l.data!=="")this.escapeInline(e,r,l),Pu(e,c,r,!0);else{const d=c.getAttribute("data-node-id");e.wysiwyg.lastHTMLs[d]&&J(e,d,c.outerHTML,e.wysiwyg.lastHTMLs[d])}});let o;this.element.addEventListener("input",l=>{const r=l.target;if(r.tagName==="VIDEO"||r.tagName==="AUDIO"||l.inputType==="historyRedo")return;if(l.inputType==="historyUndo"){te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"redo"),window.siyuan.menus.menu.remove();return}const c=re(this.element),d=x(c.startContainer);if(d){if(d&&d.getAttribute("data-type")==="NodeHTMLBlock"){l.stopPropagation();return}[":","(","\u3010","\uFF08","[","{","\u300C","\u300E","#","/","\u3001"].includes(l.data)&&(e.hint.enableExtend=!0),!(l.isComposing||s||l.inputType==="deleteByDrag"||l.inputType==="insertFromDrop")&&(this.escapeInline(e,c,l),/^\d{1}$/.test(l.data)||l.data==="\u2018"||l.data==="\u201C"||l.data==="\u201D"||l.data==="\u300C"?(clearTimeout(o),o=window.setTimeout(()=>{Pu(e,d,c,!0)})):Pu(e,d,c,!0),l.stopPropagation())}}),this.element.addEventListener("keyup",l=>{const r=re(this.element).cloneRange(),c=x(r.startContainer);if(l.key!=="PageUp"&&l.key!=="PageDown"&&l.key!=="Home"&&l.key!=="End"&&l.key.indexOf("Arrow")===-1&&l.key!=="Alt"&&l.key!=="Shift"&&l.key!=="CapsLock"&&l.key!=="Escape"&&l.key!=="Meta"&&!/^F\d{1,2}$/.test(l.key)&&(!l.isComposing||l.isComposing&&r.toString()!=="")){r.toString()===""&&c&&typeof e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]>"u"&&(r.insertNode(document.createElement("wbr")),e.wysiwyg.lastHTMLs[c.getAttribute("data-node-id")]=c.outerHTML,c.querySelector("wbr").remove());return}if(!this.preventKeyup&&((l.shiftKey||O(l))&&!l.isComposing&&r.toString()!==""&&(e.toolbar.render(e,r,l),Ls(r)),l.eventPhase!==3&&!l.shiftKey&&(l.key.indexOf("Arrow")>-1||l.key==="Home"||l.key==="End"||l.key==="PageUp"||l.key==="PageDown")&&!l.isComposing&&(c&&(this.setEmptyOutline(e,c),r.toString()===""&&Ls(r,e.block.rootID)),l.stopPropagation()),(l.key==="ArrowLeft"||l.key==="ArrowRight"||l.key==="Alt"||l.key==="Shift")&&c&&!c.classList.contains("protyle-wysiwyg--select"))){const d=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let u=!1;d.find(f=>{if(f.contains(r.startContainer))return u=!0,!0}),!u&&d.length>0&&(d.forEach(f=>{f.classList.remove("protyle-wysiwyg--select")}),c.classList.add("protyle-wysiwyg--select"))}}),this.element.addEventListener("dblclick",l=>{if(l.target.tagName==="IMG"&&!l.target.classList.contains("emoji")){pp(l.target.src,e.block.rootID);return}}),this.element.addEventListener("click",l=>{e.app.plugins.forEach(D=>{D.eventBus.emit("click-editorcontent",{protyle:e,event:l})}),X(["hint","util"],e);const r=O(l),c=A(l.target,"protyle-breadcrumb__item");if(c){const D=c.getAttribute("data-id");D?r?ot(D,U=>{de({app:e.app,id:D,action:U?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT],zoomIn:U})}):c_(e,c):d_(c),l.stopPropagation();return}l.shiftKey||(this.shiftStartElement=void 0),this.setEmptyOutline(e,l.target);const d=A(l.target,"table");this.element.querySelectorAll(".table").forEach(D=>{(!d||!D.isSameNode(d))&&D.querySelector(".table__select").removeAttribute("style"),d&&d.isSameNode(D)&&D.querySelector(".table__select").getAttribute("style")&&l.stopPropagation()}),e.options.render.breadcrumb&&e.breadcrumb.render(e);const u=re(this.element),f=q(l.target,"data-type","block-ref"),g=q(l.target,"data-type","a")||q(l.target,"data-type","url");let h="";if(g&&(g.classList.contains("av__celltext")?h=g.textContent.trim():h=g.getAttribute("data-href")),f||h.startsWith("siyuan://blocks/")){if(l.stopPropagation(),l.preventDefault(),X(["dialog","toolbar"],e),u.toString()!==""&&!l.shiftKey)return;let D;if(f?D=f.getAttribute("data-id"):g&&(D=h.substring(16,38)),ot(D,(U,ye)=>{l.shiftKey?de({app:e.app,id:D,position:"bottom",action:ye,zoomIn:U}):l.altKey?de({app:e.app,id:D,position:"right",action:ye,zoomIn:U}):de(r?{app:e.app,id:D,keepCursor:!0,action:U?[p.Constants.CB_GET_HL,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:U}:{app:e.app,id:D,action:ye,zoomIn:U})}),e.model){let U;f?U=x(f):g&&(U=x(g)),U&&ys(e,re(this.element),U)}return}const m=q(l.target,"data-type","file-annotation-ref");if(m&&u.toString()===""){l.stopPropagation(),l.preventDefault();const D=m.getAttribute("data-id").split("/"),U=`assets/${D[1]}`;r?fn(U,"folder"):l.shiftKey?fn(U,"app"):ks(e.app,U,D[2],"right");return}if(g&&!l.altKey){l.stopPropagation(),l.preventDefault();let D=Lute.UnEscapeHTMLStr(h);if(es(D)){const U=D.split("?page")[0];p.Constants.SIYUAN_ASSETS_EXTS.includes(Le().extname(U))&&(!U.endsWith(".pdf")||U.endsWith(".pdf")&&!D.startsWith("file://"))?r?fn(D,"folder"):l.shiftKey?fn(D,"app"):ks(e.app,U,parseInt((0,I.on)("page",D)),"right"):r?fn(D,"folder"):fn(D,"app")}else D&&(0>D.indexOf("://")&&(D=`https://${D}`),te.shell.openExternal(D).catch(U=>{M(U)}));return}const b=q(l.target,"data-type","tag");if(b&&!l.altKey){Fn(e.app,`#${b.textContent}#`,!r),X(["dialog"]);return}const y=A(l.target,"protyle-wysiwyg__embed");if(y){const D=y.getAttribute("data-id");ot(D,(U,ye)=>{l.shiftKey?de({app:e.app,id:D,position:"bottom",action:ye,zoomIn:U}):l.altKey?de({app:e.app,id:D,position:"right",action:ye,zoomIn:U}):r?de({app:e.app,id:D,action:U?[p.Constants.CB_GET_HL,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_HL,p.Constants.CB_GET_CONTEXT],zoomIn:U,keepCursor:!0}):e.disabled||window.siyuan.blockPanels.push(new Ro({app:e.app,targetElement:y,isBacklink:!1,nodeIds:[D]}))}),l.stopPropagation();return}if(lb(l,e)||ut(l.target,"protyle-action__copy"))return;const _=A(l.target,"protyle-action__edit");if(_&&!e.disabled){e.toolbar.showRender(e,_.parentElement.parentElement),l.stopPropagation(),l.preventDefault();return}const v=A(l.target,"protyle-action__menu");if(v){e.gutter.renderMenu(e,v.parentElement.parentElement);const D=v.getBoundingClientRect();window.siyuan.menus.menu.popup({x:D.left,y:D.top,isLeft:!0}),l.stopPropagation(),l.preventDefault();return}const k=A(l.target,"protyle-action__reload");if(k){const D=q(k,"data-type","NodeBlockQueryEmbed");D&&(D.removeAttribute("data-render"),Be(e,D)),l.stopPropagation(),l.preventDefault();return}const L=A(l.target,"protyle-action__language");if(L&&!e.disabled){e.toolbar.showCodeLanguage(e,L),l.stopPropagation(),l.preventDefault();return}const C=q(l.target,"data-subtype","math");if(!l.shiftKey&&!r&&C&&!e.disabled){e.toolbar.showRender(e,C),l.stopPropagation();return}const E=A(l.target,"protyle-action");if(E){if(E.parentElement.parentElement.getAttribute("data-type")==="img"&&!e.disabled)Wd(e,u,E.parentElement.parentElement,{clientX:l.clientX+4,clientY:l.clientY});else if(E.parentElement.classList.contains("li")){const U=E.parentElement.getAttribute("data-node-id");if(l.altKey&&!e.disabled){if(E.parentElement.parentElement.classList.contains("protyle-wysiwyg"))zt(e,E.parentElement);else{let ye=!0;const Fe=E.parentElement.parentElement.outerHTML;Array.from(E.parentElement.parentElement.children).find(xe=>{if(xe.classList.contains("li")&&xe.getAttribute("fold")!=="1"&&xe.childElementCount>3)return ye=!1,!0}),Array.from(E.parentElement.parentElement.children).find(xe=>{xe.classList.contains("li")&&(ye?xe.removeAttribute("fold"):xe.childElementCount>3&&xe.setAttribute("fold","1"))}),J(e,E.parentElement.parentElement.getAttribute("data-node-id"),E.parentElement.parentElement.outerHTML,Fe)}X(["gutter"],e)}else if(l.shiftKey&&!e.disabled)Ca(E.parentElement,"bookmark",e);else if(r)Vt({protyle:e,id:U});else if(E.classList.contains("protyle-action--task")){if(!e.disabled){const ye=E.parentElement.outerHTML;E.parentElement.classList.contains("protyle-task--done")?(E.querySelector("use").setAttribute("xlink:href","#iconUncheck"),E.parentElement.classList.remove("protyle-task--done")):(E.querySelector("use").setAttribute("xlink:href","#iconCheck"),E.parentElement.classList.add("protyle-task--done")),E.parentElement.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(e,U,E.parentElement.outerHTML,ye)}}else e.block.showAll&&e.block.id===U?Ud(e,U):Vt({protyle:e,id:U})}l.stopPropagation();return}const T=A(l.target,"hr")||A(l.target,"iframe");if(!l.shiftKey&&!r&&T){T.classList.add("protyle-wysiwyg--select"),l.stopPropagation();return}const H=ut(l.target,"img");if(!l.shiftKey&&!r&&H){H.classList.add("img--select"),u.setStartAfter(H),u.collapse(!0),Z(u),e.options.render.breadcrumb&&e.breadcrumb.render(e);return}if(!ky(e,l)){if(l.target.contains(this.element)&&this.element.lastElementChild&&!e.disabled){const D=this.element.lastElementChild.getBoundingClientRect();if(l.y>D.bottom){const U=ae(Qe(this.element.lastElementChild));if(!U||this.element.lastElementChild.getAttribute("data-type")!=="NodeParagraph"&&e.wysiwyg.element.getAttribute("data-doc-type")!=="NodeListItem"||this.element.lastElementChild.getAttribute("data-type")==="NodeParagraph"&&ae(U).innerHTML!==""){const ye=Cn(!1,!1);this.element.insertAdjacentElement("beforeend",ye),F(e,[{action:"insert",data:ye.outerHTML,id:ye.getAttribute("data-node-id"),previousID:ye.previousElementSibling.getAttribute("data-node-id"),parentID:e.block.parentID}],[{action:"delete",id:ye.getAttribute("data-node-id")}]);const Fe=ae(ye);u.selectNodeContents(Fe),u.collapse(!0),Z(u),e.options.render.breadcrumb&&setTimeout(()=>{e.breadcrumb.render(e)},p.Constants.TIMEOUT_TRANSITION)}else U&&(u.selectNodeContents(U),u.collapse(!1),Z(u))}}if(setTimeout(()=>{const D=re(this.element);D.toString().replace(p.Constants.ZWSP,"")!==""?e.toolbar.render(e,D):(X(["toolbar"],e),e.toolbar.range=D),e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")||Ls(D,e.block.rootID),getSelection().rangeCount===0&&Z(D),ys(e,D)},(0,I.tq)()||Bt()?520:0),e.hint.enableExtend=!1,l.shiftKey){l.preventDefault(),l.stopPropagation();let D=this.shiftStartElement,U=x(l.target);if(this.shiftStartElement&&U&&!this.shiftStartElement.isSameNode(U)){let ye=!0;u.collapse(!0);const Fe=D.getBoundingClientRect(),xe=U.getBoundingClientRect();let je=Fe.top,Ct=xe.top;if(je===Ct&&(je=Fe.left,Ct=xe.left),je>Ct){const vt=U;U=D,D=vt;const Rt=Ct;Ct=je,je=Rt,ye=!1}let Ve=[],ue=D,Te=!1;for(;ue;)if(ue&&!ue.classList.contains("protyle-attr")){const vt=ue.getBoundingClientRect();if(Fe.top===xe.top?vt.left<=Ct:vt.top<=Ct)if(Te)if(ue.nextElementSibling&&!ue.nextElementSibling.classList.contains("protyle-attr")){const Rt=ue.nextElementSibling.getBoundingClientRect();if(Fe.top===xe.top?Rt.left<=Ct&&Rt.bottom<=xe.bottom:Rt.top<=Ct)Ve=[ue],ue=ue.nextElementSibling,Te=!1;else if(ue.parentElement.classList.contains("sb"))ue=x(ue.parentElement),Te=!0;else break}else ue=x(ue.parentElement),Te=!0;else Ve.push(ue),ue=ue.nextElementSibling;else if(ue.parentElement.classList.contains("sb"))ue=x(ue.parentElement),Te=!0;else break}else ue=x(ue.parentElement),Te=!0;if(Ve.length===1&&!Ve[0].classList.contains("list")&&!Ve[0].classList.contains("bq")&&!Ve[0].classList.contains("sb"))this.shiftStartElement=void 0;else{const vt=[];!e.wysiwyg.element.querySelector(".protyle-wysiwyg--select")&&e.scroll&&!e.scroll.element.classList.contains("fn__none")&&!e.scroll.keepLazyLoad&&(D.getBoundingClientRect().top<-e.contentElement.clientHeight*2||U.getBoundingClientRect().bottom>e.contentElement.clientHeight*2)&&M(window.siyuan.languages.crossKeepLazyLoad),Ve.forEach(Rt=>{Rt.classList.add("protyle-wysiwyg--select"),vt.push(Rt.getAttribute("data-node-id")),Rt.querySelectorAll(".protyle-wysiwyg--select").forEach(Dk=>{Dk.classList.remove("protyle-wysiwyg--select")})}),Gt(vt),le(ye?Ve[Ve.length-1]:Ve[0],e.wysiwyg.element,!1)}}}if(this.element.querySelector(".protyle-wysiwyg--select")&&u.toString()!==""&&(u.collapse(!1),Z(u)),r&&u.toString()===""){let D=x(l.target);if(D){D=be(D),D.classList.contains("protyle-wysiwyg--select")?(D.classList.remove("protyle-wysiwyg--select"),D.removeAttribute("select-start"),D.removeAttribute("select-end")):D.classList.add("protyle-wysiwyg--select"),D.querySelectorAll(".protyle-wysiwyg--select").forEach(Fe=>{Fe.classList.remove("protyle-wysiwyg--select"),Fe.removeAttribute("select-start"),Fe.removeAttribute("select-end")});const U=A(D.parentElement,"protyle-wysiwyg--select");U&&(U.classList.remove("protyle-wysiwyg--select"),U.removeAttribute("select-start"),U.removeAttribute("select-end"));const ye=[];e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(Fe=>{ye.push(Fe.getAttribute("data-node-id"))}),Gt(ye)}}}})}}class BE{constructor(){this.element=document.createElement("div"),this.element.className="protyle-toolbar__divider"}}class qE extends ps{constructor(e,n){super(e,n),this.element.addEventListener("click",async a=>{e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!x(i.startContainer))return;const o=q(i.startContainer,"data-type","a");if(o){vo(e,o);return}const l=i.toString().trim().replace(p.Constants.ZWSP,"");let r="",c="";try{const d=await ce();if(e.lute.IsValidLinkDest(l))r=l;else if(e.lute.IsValidLinkDest(d))r=d;else{const u=d.lastIndexOf(" ");u>-1&&e.lute.IsValidLinkDest(d.substring(u))&&(r=d.substring(u),c=d.substring(0,u))}}catch(d){console.log(d)}e.toolbar.setInlineMark(e,"a","range",{type:"a",color:r+(c?p.Constants.ZWSP+c:"")})})}}class FE extends ps{constructor(e,n){super(e,n),this.element.addEventListener("click",a=>{e.toolbar.range.toString()!==""&&(Du(e.toolbar.range),Va(e.toolbar.range.toString(),e,"search"),e.toolbar.element.classList.add("fn__none"),a.stopPropagation())})}}class UE extends ps{constructor(e,n){super(e,n),this.element.addEventListener("click",async a=>{e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!x(i.startContainer))return;let o=q(i.startContainer,"data-type","inline-math");if(!o&&i.startContainer.nodeType!==3&&i.startContainer.childNodes[i.startOffset]){const l=Ke(i.startContainer.childNodes[i.startOffset]);l&&l.getAttribute("data-type").indexOf("inline-math")>-1&&(o=l)}if(!o&&i.startOffset===i.startContainer.textContent.length&&i.startContainer.nodeType===3){let l=!0,r=!1;if(i.cloneContents().childNodes.forEach(c=>{c.nodeType!==3&&(c.getAttribute("data-type")||"").indexOf("inline-math")>-1||c.nodeType==3&&c.textContent===""?r=!0:l=!1}),l&&r){const c=rt(i.startContainer);if(c&&c.nodeType!==3&&c.getAttribute("data-type").indexOf("inline-math")>-1)o=c;else{const d=Ke(i.startContainer);i.startOffset===0&&d&&d.nodeType!==3&&d.getAttribute("data-type").indexOf("inline-math")>-1&&(o=d)}}}if(o){e.toolbar.showRender(e,o);return}e.toolbar.setInlineMark(e,"inline-math","range",{type:"inline-math"})})}}class WE extends ps{constructor(e,n){super(e,n),this.element.addEventListener("click",async a=>{e.toolbar.element.classList.add("fn__none"),a.stopPropagation();const i=e.toolbar.range;if(!x(i.startContainer))return;const o=q(i.startContainer,"data-type","inline-memo");if(o&&o.textContent===i.toString()){e.toolbar.showRender(e,o);return}i.toString()!==""&&e.toolbar.setInlineMark(e,"inline-memo","range",{type:"inline-memo"})})}}class VE{constructor(e){const n=e.options,a=document.createElement("div");a.className="protyle-toolbar fn__none",this.element=a,this.subElement=document.createElement("div"),this.subElement.className="protyle-util fn__none",this.toolbarHeight=29,n.toolbar.forEach(i=>{const s=this.genItem(e,i);this.element.appendChild(s)})}render(e,n,a){this.range=n;let i=x(n.startContainer);if((0,I.tq)()||!i||e.disabled||i.classList.contains("av")){this.element.classList.add("fn__none");return}let s=!0,o=!0;if(Array.from(n.cloneContents().childNodes).find(f=>{if(f.nodeType!==1){if(f.textContent.length>0)return o=!1,!0}else if(!f.classList.contains("img"))return s=!1,!0}),s&&o||n.commonAncestorContainer.nodeType!==3&&n.commonAncestorContainer.classList.contains("img")){this.element.classList.add("fn__none");return}const l=x(n.startContainer),r=x(n.endContainer);if(l&&r&&!l.isSameNode(r)){if(a)if(a.key==="ArrowLeft")this.range=Xt(ae(l),n,!1);else if(a.key==="ArrowRight")this.range=Uo(ae(r),n),this.range.collapse(!1);else if(a.key==="ArrowUp"){if(this.range=Uo(ae(r),n),i=x(r),!i)return}else a.key==="ArrowDown"&&(this.range=Xt(ae(l),n,!1));else this.range=Xt(ae(i),n,!1);if(Z(this.range),this.range.toString()===""){this.element.classList.add("fn__none");return}}if(i.getAttribute("data-type")==="NodeCodeBlock"){this.element.classList.add("fn__none");return}const c=$n(i,n);this.element.classList.remove("fn__none"),this.toolbarHeight=this.element.clientHeight;const d=c.top-this.toolbarHeight-4;this.element.setAttribute("data-inity",d+p.Constants.ZWSP+e.contentElement.scrollTop.toString()),ke(this.element,c.left-52,d),this.element.querySelectorAll(".protyle-toolbar__item--current").forEach(f=>{f.classList.remove("protyle-toolbar__item--current")}),this.getCurrentType().forEach(f=>{if(["search-mark","a","block-ref","virtual-block-ref","text","file-annotation-ref","inline-math","inline-memo","","backslash"].includes(f))return;const g=this.element.querySelector(`[data-type="${f}"]`);g&&g.classList.add("protyle-toolbar__item--current")})}getCurrentType(e=this.range){let n=[],a=e.startContainer;if(a.nodeType===3?a=a.parentElement:a.childElementCount>0&&a.childNodes[e.startOffset]?.nodeType!==3&&(a=a.childNodes[e.startOffset]),!a||a.nodeType===3)return[];["DIV","TD","TH","TR"].includes(a.tagName)||(n=(a.getAttribute("data-type")||"").split(" "));let i=e.endContainer;return i.nodeType===3?i=i.parentElement:i.childElementCount>0&&i.childNodes[e.endOffset]?.nodeType!==3&&(i=i.childNodes[e.endOffset]),!i||i.nodeType===3?[]:(!["DIV","TD","TH","TR"].includes(i.tagName)&&!a.isSameNode(i)&&(n=n.concat((i.getAttribute("data-type")||"").split(" "))),e.cloneContents().childNodes.forEach(s=>{s.nodeType!==3&&(n=n.concat((s.getAttribute("data-type")||"").split(" ")))}),n=[...new Set(n)],n.find((s,o)=>{if(s==="")return n.splice(o,1),!0}),n)}genItem(e,n){let a;switch(n.name){case"strong":case"em":case"s":case"code":case"mark":case"tag":case"u":case"sup":case"clear":case"sub":case"kbd":a=new ps(e,n);break;case"block-ref":a=new FE(e,n);break;case"inline-math":a=new UE(e,n);break;case"inline-memo":a=new WE(e,n);break;case"|":a=new BE;break;case"text":a=new Zy(e,n);break;case"a":a=new qE(e,n);break}if(a)return a.element}mergeNode(e){for(let n=0;n<e.length;n++)e[n].nodeType!==3&&e[n].tagName==="WBR"&&(e[n].remove(),n--);for(let n=0;n<e.length;n++)e[n].nodeType===3&&(e[n].textContent===""?(e[n].remove(),n--):e[n+1]&&e[n+1].nodeType===3&&(e[n].textContent=e[n].textContent+e[n+1].textContent,e[n+1].remove(),n--))}setInlineMark(e,n,a,i){const s=x(this.range.startContainer);if(!s)return;const o=x(this.range.endContainer);if(!o)return;s.isSameNode(o)||(this.range=Xt(ae(s),this.range,!1));const l=this.getCurrentType(this.range),r=this.range.toString();Du(this.range);let c,d,u,f;const g=Ke(this.range.startContainer);["DIV","TD","TH","TR"].includes(this.range.startContainer.parentElement.tagName)?g&&g.nodeType!==3&&this.range.startOffset===0&&(c=g):this.range.startOffset===0&&!g?(c=this.range.startContainer.parentElement.previousSibling,this.range.setStartBefore(this.range.startContainer.parentElement)):c=this.range.startContainer.parentElement;let h=!1;const m=rt(this.range.endContainer);["DIV","TD","TH","TR"].includes(this.range.endContainer.parentElement.tagName)?m&&m.nodeType!==3&&this.range.endOffset===this.range.endContainer.textContent.length&&(d=m):this.range.endOffset===this.range.endContainer.textContent.length&&!m?(d=this.range.endContainer.parentElement.nextSibling,this.range.setEndAfter(this.range.endContainer.parentElement),r===""&&(h=!0,this.range.collapse(!1))):d=this.range.endContainer.parentElement,this.range.insertNode(document.createElement("wbr"));const b=s.outerHTML,y=this.range.extractContents();if(this.mergeNode(y.childNodes),c&&d&&c.isSameNode(d)&&y.firstChild?.nodeType===3){const E=c.attributes;y.childNodes.forEach(T=>{const H=document.createElement("span");for(let D=0;D<E.length;D++)H.setAttribute(E[D].name,E[D].value);H.innerHTML=T.textContent,T.replaceWith(H)})}const _=(0,I.tq)()?document.querySelector("#keyboardToolbar .keyboard__dynamic").nextElementSibling:this.element,v=a==="toolbar"?_.querySelector(`[data-type="${n}"]`):void 0,k=[];if(n==="clear"||v?.classList.contains("protyle-toolbar__item--current")||a==="range"&&l.length>0&&l.includes(n)&&!i){if(n==="clear"?_.querySelectorAll('[data-type="em"],[data-type="u"],[data-type="s"],[data-type="mark"],[data-type="sup"],[data-type="sub"],[data-type="strong"]').forEach(E=>{E.classList.remove("protyle-toolbar__item--current")}):v&&v.classList.remove("protyle-toolbar__item--current"),y.childNodes.length===0)if(l.find((E,T)=>{if(n===E)return l.splice(T,1),!0}),l.length===0||n==="clear")k.push(document.createTextNode(p.Constants.ZWSP));else{let E=0;for(;E<l.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(l[E])?l.splice(E,1):++E;const T=document.createElement("span");T.setAttribute("data-type",l.join(" ")),T.textContent=p.Constants.ZWSP,k.push(T)}y.childNodes.forEach((E,T)=>{if(E.nodeType!==3&&E.tagName!=="BR"&&E.tagName!=="IMG"){const H=(E.getAttribute("data-type")||"").split(" ");if(n==="clear")for(let D=0;D<H.length;D++)i&&i.type==="text"?H[D]==="text"&&(H.splice(D,1),D--):["kbd","text","strong","em","u","s","mark","sup","sub","code"].includes(H[D])&&(H.splice(D,1),D--);else H.find((D,U)=>{if(n===D)return H.splice(U,1),!0});if(H.length===0)E.textContent===""&&(E.textContent=p.Constants.ZWSP),k.push(document.createTextNode(E.textContent));else{if(r&&n==="clear"&&i&&i.type==="text"&&E.style.color===""&&E.style.webkitTextFillColor===""&&E.style.webkitTextStroke===""&&E.style.textShadow===""&&E.style.backgroundColor===""&&E.style.fontSize==="")return E.setAttribute("data-type",H.join(" ")),k.push(E),!0;n==="clear"&&(E.style.color="",E.style.webkitTextFillColor="",E.style.webkitTextStroke="",E.style.textShadow="",E.style.backgroundColor="",E.style.fontSize=""),T===0&&c&&c.nodeType!==3&&(0,I.qP)(H,(c.getAttribute("data-type")||"").split(" "))&&gs(E,c,i)?(u=c.textContent.length,c.innerHTML=c.innerHTML+E.innerHTML):T===y.childNodes.length-1&&d&&d.nodeType!==3&&(0,I.qP)(H,(d.getAttribute("data-type")||"").split(" "))&&gs(E,d,i)?(f=E.textContent.length,d.innerHTML=E.innerHTML+d.innerHTML):(E.setAttribute("data-type",H.join(" ")),k.push(E))}}else k.push(E)})}else if(!this.element.classList.contains("fn__none")&&n!=="text"&&v&&v.classList.add("protyle-toolbar__item--current"),r===""){const E=document.createElement("span");if(l.push(n),h){let T=0;for(;T<l.length;)["inline-memo","text","block-ref","file-annotation-ref","a"].includes(l[T])?l.splice(T,1):++T}E.setAttribute("data-type",[...new Set(l)].join(" ")),E.textContent=p.Constants.ZWSP,Pd(E,i),k.push(E)}else{if(n==="block-ref")for(;y.childNodes.length>1;)y.childNodes[0].remove();y.childNodes.forEach((E,T)=>{if(E.nodeType===3)if(T===0&&c&&c.nodeType!==3&&n===c.getAttribute("data-type")&&gs(E,c,i))u=c.textContent.length,c.innerHTML=c.innerHTML+E.textContent;else if(T===y.childNodes.length-1&&d&&d.nodeType!==3&&n===d.getAttribute("data-type")&&gs(E,d,i))f=E.textContent.length,d.innerHTML=E.textContent+d.innerHTML;else{const H=document.createElement("span");H.setAttribute("data-type",n),H.textContent=E.textContent,Pd(H,i),k.push(H)}else{let H=(E.getAttribute("data-type")||"").split(" ");for(let D=0;D<H.length;D++)["backslash","virtual-block-ref","search-mark"].includes(H[D])&&(H.splice(D,1),D--);H.push(n),n==="sub"&&H.includes("sup")?H.find((D,U)=>{if(D==="sup")return H.splice(U,1),_.querySelector('[data-type="sup"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="sup"&&H.includes("sub")?H.find((D,U)=>{if(D==="sub")return H.splice(U,1),_.querySelector('[data-type="sub"]').classList.remove("protyle-toolbar__item--current"),!0}):n==="block-ref"&&(H.includes("a")||H.includes("file-annotation-ref"))?H.find((D,U)=>{if(D==="a"||D==="file-annotation-ref")return H.splice(U,1),!0}):n==="a"&&(H.includes("block-ref")||H.includes("file-annotation-ref"))?H.find((D,U)=>{if(D==="block-ref"||D==="file-annotation-ref")return H.splice(U,1),!0}):n==="file-annotation-ref"&&(H.includes("block-ref")||H.includes("a"))?H.find((D,U)=>{if(D==="block-ref"||D==="a")return H.splice(U,1),!0}):n==="inline-memo"&&H.includes("inline-math")?(H.find((D,U)=>{if(D==="inline-math")return H.splice(U,1),!0}),E.textContent=E.getAttribute("data-content")):n==="inline-math"&&H.includes("inline-memo")&&H.find((D,U)=>{if(D==="inline-memo")return H.splice(U,1),!0}),H=[...new Set(H)],T===0&&c&&c.nodeType!==3&&(0,I.qP)(H,(c.getAttribute("data-type")||"").split(" "))&&gs(E,c,i)?(u=c.textContent.length,c.innerHTML=c.innerHTML+E.innerHTML):T===y.childNodes.length-1&&d&&d.nodeType!==3&&(0,I.qP)(H,(d.getAttribute("data-type")||"").split(" "))&&gs(E,d,i)?(f=E.textContent.length,d.innerHTML=E.innerHTML+d.innerHTML):(E.tagName!=="BR"&&E.tagName!=="IMG"&&(E.setAttribute("data-type",H.join(" ")),Pd(E,i)),k.push(E))}})}if(this.range.startContainer.nodeType!==3&&this.range.startContainer.tagName==="SPAN"&&this.range.startContainer.isSameNode(this.range.endContainer)&&!h){const E=this.range.startContainer,T=document.createElement("span"),H=E.attributes;for(let D=0;D<H.length;D++)T.setAttribute(H[D].name,H[D].value);this.range.setEnd(E.lastChild,E.lastChild.textContent.length),T.append(this.range.extractContents()),E.after(T),this.range.setStartBefore(T),this.range.collapse(!0)}for(let E=0;E<k.length;E++){const T=k[E],H=k[E+1];if(T.nodeType!==3&&H&&H.nodeType!==3&&H.tagName===T.tagName&&(0,I.qP)((H.getAttribute("data-type")||"").split(" "),(T.getAttribute("data-type")||"").split(" "))&&T.getAttribute("data-id")===H.getAttribute("data-id")&&T.getAttribute("data-subtype")===H.getAttribute("data-subtype")&&T.style.color===H.style.color&&T.style.webkitTextFillColor===H.style.webkitTextFillColor&&T.style.webkitTextStroke===H.style.webkitTextStroke&&T.style.textShadow===H.style.textShadow&&T.style.fontSize===H.style.fontSize&&T.style.backgroundColor===H.style.backgroundColor){const D=T.getAttribute("data-type");D.indexOf("inline-math")>-1?H.setAttribute("data-content",T.getAttribute("data-content")+H.getAttribute("data-content")):(H.innerHTML=T.innerHTML+H.innerHTML,D.indexOf("inline-memo")>-1&&H.setAttribute("data-inline-memo-content",(T.getAttribute("data-inline-memo-content")||"")+(H.getAttribute("data-inline-memo-content")||""))),k.splice(E,1),E--}else{if(this.range.insertNode(T),T.nodeType!==3&&["code","tag","kbd"].includes(n)){const D=Ke(T);(!D||D.textContent.endsWith(`
`))&&T.before(document.createTextNode(p.Constants.ZWSP)),T.textContent.startsWith(p.Constants.ZWSP)||(T.textContent=p.Constants.ZWSP+T.textContent);const U=rt(T);(!U||U&&(U.nodeType!==3||U.nodeType===3&&!U.textContent.startsWith(p.Constants.ZWSP)))&&T.after(document.createTextNode(p.Constants.ZWSP))}this.range.collapse(!1)}}if(c&&(c.nodeType!==3&&c.textContent===p.Constants.ZWSP?c.remove():this.mergeNode(c.childNodes)),d&&this.mergeNode(d.childNodes),u?this.range.setStart(c.firstChild,u):k.length>0?k[0].nodeType!==3&&k[0].getAttribute("data-type")==="inline-math"||(k[0].firstChild?k[0].firstChild.textContent===p.Constants.ZWSP?this.range.setStart(k[0].firstChild,1):this.range.setStart(k[0].firstChild,0):k[0].nodeType===3?this.range.setStart(k[0],0):this.range.setStartBefore(k[0])):d&&this.range.setStart(d.firstChild,0),f)this.range.setEnd(d.lastChild,f);else if(k.length>0){const E=k[k.length-1];if(E.nodeType!==3&&E.getAttribute("data-type").indexOf("inline-math")>-1){const T=Ke(E);T&&T.nodeType===3?this.range.setStart(T,T.textContent.length):this.range.setStartBefore(E);const H=rt(E);H&&H.nodeType===3?this.range.setEnd(H,0):this.range.setEndAfter(E)}else E.lastChild?E.lastChild.textContent===p.Constants.ZWSP?this.range.collapse(!0):this.range.setEnd(E.lastChild,E.lastChild.textContent.length):E.nodeType===3?(this.range.setEnd(E,E.textContent.length),E.textContent===p.Constants.ZWSP&&this.range.collapse(!1)):this.range.setEndAfter(E)}else c&&this.range.setEnd(c.firstChild,c.firstChild.textContent.length);let L=!0;if(n==="inline-math"){if(Ln(s),r===""){e.toolbar.showRender(e,k[0],void 0,b);return}}else if(n==="inline-memo"){e.toolbar.showRender(e,k[0],k,b);return}else if(n==="block-ref")this.range.collapse(!1);else if(n==="a"){const E=k[0];E.textContent.replace(p.Constants.ZWSP,"")===""||!E.getAttribute("data-href")?(L=!1,vo(e,E,!!E.getAttribute("data-href"))):this.range.collapse(!1)}s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(e,s.getAttribute("data-node-id"),s.outerHTML,b);const C=s.querySelector("wbr");C&&C.remove(),L&&Z(this.range)}showRender(e,n,a,i){const s=x(n);if(!s)return;X(["hint"],e),window.siyuan.menus.menu.remove();const o=s.getAttribute("data-node-id"),l=(n.getAttribute("data-type")||"").split(" "),r=i||s.outerHTML;let c="HTML",d="";const u=l.includes("inline-memo");switch(n.getAttribute("data-subtype")){case"abc":c=window.siyuan.languages.staff;break;case"echarts":c=window.siyuan.languages.chart;break;case"flowchart":c="Flow Chart";break;case"graphviz":c="Graphviz";break;case"mermaid":c="Mermaid";break;case"mindmap":d=`- foo
  - bar
- baz`,c=window.siyuan.languages.mindmap;break;case"plantuml":c="UML";break;case"math":l.includes("NodeMathBlock")?c=window.siyuan.languages.math:c=window.siyuan.languages["inline-math"];break}l.includes("NodeBlockQueryEmbed")?c=window.siyuan.languages.blockEmbed:u&&(c=window.siyuan.languages.memo);const f=this.subElement.querySelector('[data-type="pin"]')?.getAttribute("aria-label")===window.siyuan.languages.unpin,g={};if(f){const v=this.subElement.querySelector(".b3-text-field");g.styleH=v.style.height,g.styleW=v.style.width}else this.subElement.style.width="",this.subElement.style.padding="0";this.subElement.innerHTML=`<div ${f&&this.subElement.firstElementChild.getAttribute("data-drag")==="true"?'data-drag="true"':""}><div class="block__icons block__icons--menu fn__flex" style="border-radius: var(--b3-border-radius-b) var(--b3-border-radius-b) 0 0;">
    <span class="fn__flex-1 resize__move">
        ${c}
    </span>
    <span class="fn__space"></span>
    <button data-type="refresh" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${f&&!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active")?"":" block__icon--active"}${l.includes("NodeBlockQueryEmbed")?" fn__none":""}" aria-label="${window.siyuan.languages.refresh}"><svg><use xlink:href="#iconRefresh"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="before" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-before"]}"><svg><use xlink:href="#iconBefore"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="after" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw${e.disabled?" fn__none":""}" aria-label="${window.siyuan.languages["insert-after"]}"><svg><use xlink:href="#iconAfter"></use></svg></button>
    <span class="fn__space${e.disabled?" fn__none":""}"></span>
    <button data-type="export" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.export} ${window.siyuan.languages.image}"><svg><use xlink:href="#iconImage"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="pin" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${f?window.siyuan.languages.unpin:window.siyuan.languages.pin}"><svg><use xlink:href="#icon${f?"Unpin":"Pin"}"></use></svg></button>
    <span class="fn__space"></span>
    <button data-type="close" class="block__icon block__icon--show b3-tooltips b3-tooltips__nw" aria-label="${window.siyuan.languages.close}"><svg style="width: 10px"><use xlink:href="#iconClose"></use></svg></button>
</div>
<textarea ${e.disabled?" readonly":""} spellcheck="false" class="b3-text-field b3-text-field--text fn__block" placeholder="${d}" style="${(0,I.tq)()?"":"width:"+Math.max(480,n.clientWidth*.7)+"px"};max-height:calc(80vh - 44px);min-height: 48px;min-width: 268px;border-radius: 0 0 var(--b3-border-radius-b) var(--b3-border-radius-b);font-family: var(--b3-font-family-code);"></textarea></div>`;const h=()=>{if(y.style.height=y.scrollHeight+"px",(0,I.tq)()){ke(this.subElement,0,0);return}if(this.subElement.firstElementChild.getAttribute("data-drag")==="true"){y.getBoundingClientRect().bottom>window.innerHeight&&(this.subElement.style.top=window.innerHeight-this.subElement.clientHeight+"px");return}const v=_.bottom===_.top?_.bottom+26:_.bottom;this.subElement.clientHeight<=window.innerHeight-v||this.subElement.clientHeight<=_.top?l.includes("inline-math")||u?ke(this.subElement,_.left,v,_.height||26):ke(this.subElement,_.left+(_.width-this.subElement.clientWidth)/2,v,_.height||26):ke(this.subElement,_.right,v)},m=this.subElement.querySelector(".block__icons");m.addEventListener("click",v=>{const k=v.target,L=A(k,"b3-tooltips");if(!L){if(v.detail===2){const C=m.querySelector('[data-type="pin"]');C.getAttribute("aria-label")===window.siyuan.languages.unpin?(C.querySelector("svg use").setAttribute("xlink:href","#iconPin"),C.setAttribute("aria-label",window.siyuan.languages.pin)):(C.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),C.setAttribute("aria-label",window.siyuan.languages.unpin)),v.preventDefault(),v.stopPropagation()}return}switch(v.stopPropagation(),L.getAttribute("data-type")){case"close":this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),X(["util"],e);break;case"pin":L.getAttribute("aria-label")===window.siyuan.languages.unpin?(L.querySelector("svg use").setAttribute("xlink:href","#iconPin"),L.setAttribute("aria-label",window.siyuan.languages.pin)):(L.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),L.setAttribute("aria-label",window.siyuan.languages.unpin));break;case"refresh":L.classList.toggle("block__icon--active");break;case"before":wn(e,"beforebegin",o),X(["util"],e);break;case"after":wn(e,"afterend",o),X(["util"],e);break;case"export":b();break}});const b=()=>{const v=M(window.siyuan.languages.exporting,0);if(n.getAttribute("data-subtype")==="plantuml"){fetch(n.querySelector("img").getAttribute("src")).then(function(k){return k.blob()}).then(function(k){const L=new FormData;L.append("file",k),L.append("type","image/png"),w("/api/export/exportAsFile",L,C=>{Ee(C.data.file),W(v)})});return}setTimeout(()=>{(0,ze.addScript)("/stage/protyle/js/html2canvas.min.js?v=1.4.1","protyleHtml2canvas").then(()=>{window.html2canvas(n,{useCORS:!0}).then(k=>{k.toBlob(L=>{const C=new FormData;C.append("file",L),C.append("type","image/png"),w("/api/export/exportAsFile",C,E=>{Ee(E.data.file),W(v)})})})})},p.Constants.TIMEOUT_LOAD)};Tu(this.subElement,()=>{const v=m.querySelector('[data-type="pin"]');v.querySelector("svg use").setAttribute("xlink:href","#iconUnpin"),v.setAttribute("aria-label",window.siyuan.languages.unpin),this.subElement.firstElementChild.setAttribute("data-drag","true")});const y=this.subElement.querySelector(".b3-text-field");l.includes("NodeHTMLBlock")?y.value=Lute.UnEscapeHTMLStr(n.querySelector("protyle-html").getAttribute("data-content")||""):u?y.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-inline-memo-content")||""):y.value=Lute.UnEscapeHTMLStr(n.getAttribute("data-content")||""),y.addEventListener("input",v=>{if(n.parentElement&&(y.clientHeight!==y.scrollHeight&&h(),!!this.subElement.querySelector('[data-type="refresh"]').classList.contains("block__icon--active"))){if(l.includes("NodeHTMLBlock"))n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(y.value));else if(u){let k;a?k=a:k=[n],k.forEach(L=>{L.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value))})}else n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render");(!l.includes("NodeBlockQueryEmbed")||!l.includes("NodeHTMLBlock")||!u)&&bt(n),v.stopPropagation()}}),y.addEventListener("keydown",v=>{if(v.stopPropagation(),$(window.siyuan.config.keymap.editor.insert["inline-math"].custom,v)){v.preventDefault();return}if(!v.isComposing){if(v.key==="Escape"||$("\u2318\u21A9",v))this.subElement.querySelector('[data-type="pin"]').setAttribute("aria-label",window.siyuan.languages.pin),X(["util"],e);else if(v.key==="Tab")document.execCommand("insertText",!1,"	"),v.preventDefault();else if(Ya(v))return}}),this.subElementCloseCB=()=>{if(!n.parentElement||e.disabled)return;let v;if(l.includes("NodeHTMLBlock")){let k=y.value;k&&(k=k.trim().replace(/\n+/g,`
`),k.startsWith("<div>")&&k.endsWith("</div>")||(k=`<div>
${k}
</div>`)),n.querySelector("protyle-html").setAttribute("data-content",Lute.EscapeHTMLStr(k))}else if(u){let k;a?k=a:k=[n],k.forEach((L,C)=>{if(y.value)L.setAttribute("data-inline-memo-content",Lute.EscapeHTMLStr(y.value));else{const E=L.getAttribute("data-type").split(" ");E.length===1&&E[0]==="inline-memo"?L.outerHTML=L.innerHTML+(C===k.length-1?"<wbr>":""):(E.find((T,H)=>{if(T==="inline-memo")return E.splice(H,1),!0}),L.setAttribute("data-type",E.join(" ")),L.removeAttribute("data-inline-memo-content")),C===k.length-1&&(v=L)}})}else l.includes("inline-math")?y.value?(n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render"),bt(n)):(v=n,n.outerHTML="<wbr>"):(n.setAttribute("data-content",Lute.EscapeHTMLStr(y.value)),n.removeAttribute("data-render"),l.includes("NodeBlockQueryEmbed")?Be(e,n):bt(n));if(getSelection().rangeCount===0||getSelection().rangeCount>0&&A(getSelection().getRangeAt(0).startContainer,"protyle-util")?n.tagName==="SPAN"?v?v.parentElement?(this.range.setStartAfter(v),this.range.collapse(!0),Z(this.range)):fe(s,this.range):n.parentElement&&(this.range.setStartAfter(n),this.range.collapse(!0),Z(this.range)):(le(n),n.classList.add("protyle-wysiwyg--select")):s.querySelector("wbr")?.remove(),s.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),l.includes("NodeHTMLBlock")){const k=document.createElement("template");k.innerHTML=e.lute.SpinBlockDOM(s.outerHTML),k.content.childElementCount>1&&M(window.siyuan.languages.htmlBlockTip)}J(e,o,s.outerHTML,r)},this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none");const _=n.getBoundingClientRect();this.element.classList.add("fn__none"),f?(y.style.width=g.styleW,y.style.height=g.styleH):h(),e.disabled||y.select(),e.app.plugins.forEach(v=>{v.eventBus.emit("open-noneditableblock",{protyle:e,toolbar:this})})}showCodeLanguage(e,n){const a=x(n);if(!a)return;X(["hint"],e),window.siyuan.menus.menu.remove(),this.range=re(a);const i=a.getAttribute("data-node-id");let s=a.outerHTML,o=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`;const l=p.Constants.ALIAS_CODE_LANGUAGES.concat(window.hljs?.listLanguages()??[]).sort();l.forEach((u,f)=>{o+=`<div class="b3-list-item${f===0?" b3-list-item--focus":""}">${u}</div>`}),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input placeholder="${window.siyuan.languages.search}" style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${o}</div>
</div>`;const r=this.subElement.lastElementChild.lastElementChild,c=this.subElement.querySelector("input");c.addEventListener("keydown",u=>{if(u.stopPropagation(),!u.isComposing){if(Bn(r,u),u.key==="Enter"){const f=this.subElement.querySelector(".b3-list-item--focus").textContent;n.textContent=f===window.siyuan.languages.clear?"":f,window.siyuan.storage[p.Constants.LOCAL_CODELANG]=n.textContent,pe(p.Constants.LOCAL_CODELANG,window.siyuan.storage[p.Constants.LOCAL_CODELANG]);const g=ae(a),h=a.getAttribute("linenumber");h==="true"||h!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?g.classList.add("protyle-linenumber"):g.classList.remove("protyle-linenumber"),g.textContent=g.textContent,g.removeAttribute("data-render"),qe(a),a.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(e,i,a.outerHTML,s),s=a.outerHTML,u.preventDefault(),u.stopPropagation()}(u.key==="Escape"||u.key==="Enter")&&(this.subElement.classList.add("fn__none"),Z(this.range))}}),c.addEventListener("input",u=>{const f=c.value.toLowerCase(),g=l.filter(b=>b.includes(f));let h="",m=!1;g.sort((b,y)=>b.startsWith(f)&&y.startsWith(f)?b.length<y.length?-1:b.length===y.length?0:1:b.startsWith(f)?-1:y.startsWith(f)?1:0).forEach(b=>{c.value===b&&(m=!0),h+=`<div class="b3-list-item">${b.replace(f,"<b>"+f+"</b>")}</div>`}),c.value.trim()&&!m&&(h=`<div class="b3-list-item"><b>${c.value.replace(/`| /g,"_")}</b></div>${h}`),h=`<div class="b3-list-item">${window.siyuan.languages.clear}</div>`+h,r.innerHTML=h,r.firstElementChild.nextElementSibling?r.firstElementChild.nextElementSibling.classList.add("b3-list-item--focus"):r.firstElementChild.classList.add("b3-list-item--focus"),u.stopPropagation()}),r.addEventListener("click",u=>{const f=u.target,g=A(f,"b3-list-item");if(!g)return;n.textContent=g.textContent===window.siyuan.languages.clear?"":g.textContent,window.siyuan.storage[p.Constants.LOCAL_CODELANG]=n.textContent,pe(p.Constants.LOCAL_CODELANG,window.siyuan.storage[p.Constants.LOCAL_CODELANG]);const h=x(n);if(h){const m=ae(h),b=h.getAttribute("linenumber");b==="true"||b!=="false"&&window.siyuan.config.editor.codeSyntaxHighlightLineNum?m.classList.add("protyle-linenumber"):m.classList.remove("protyle-linenumber"),m.textContent=m.textContent,m.removeAttribute("data-render"),qe(h),h.setAttribute("updated",Q().format("YYYYMMDDHHmmss")),J(e,i,h.outerHTML,s),s=h.outerHTML,this.subElement.classList.add("fn__none"),Z(this.range)}}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0;const d=n.getBoundingClientRect();ke(this.subElement,d.left,d.bottom,d.height),this.element.classList.add("fn__none"),c.select()}showTpl(e,n,a){this.range=a,X(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div style="max-height:50vh" class="fn__flex">
<div class="fn__flex-column" style="${(0,I.tq)()?"width: 100%":"min-width: 260px;max-width:50vw"}">
    <div class="fn__flex" style="margin: 0 8px 4px 8px">
        <input class="b3-text-field fn__flex-1"/>
        <span class="fn__space"></span>
        <span data-type="previous" class="block__icon block__icon--show"><svg><use xlink:href="#iconLeft"></use></svg></span>
        <span class="fn__space"></span>
        <span data-type="next" class="block__icon block__icon--show"><svg><use xlink:href="#iconRight"></use></svg></span>
    </div>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height: 64px" src="/stage/loading-pure.svg"></div>
</div>
<div style="width: 520px;${(0,I.tq)()||window.outerWidth<window.outerWidth/2+520?"display:none":""};overflow: auto;"></div>
</div>`;const i=this.subElement.querySelector(".b3-list"),s=this.subElement.firstElementChild.lastElementChild;let o=i.firstElementChild.getAttribute("data-value");hs(o,s,e.block.parentID),i.addEventListener("mouseover",r=>{const c=r.target,d=A(c,"b3-list-item");if(!d)return;const u=d.getAttribute("data-value");o!==u&&(o=u,hs(o,s,e.block.parentID))});const l=this.subElement.querySelector("input");l.addEventListener("keydown",r=>{if(r.stopPropagation(),r.isComposing)return;const c=!this.subElement.querySelector(".b3-list-item");if(!c){const d=Bn(i,r);if(d){const u=d.getAttribute("data-value");if(o===u)return;o=u,hs(o,s,e.block.parentID)}}r.key==="Enter"?(c?Z(this.range):Dp(decodeURIComponent(this.subElement.querySelector(".b3-list-item--focus").getAttribute("data-value")),e,n),this.subElement.classList.add("fn__none"),r.preventDefault()):r.key==="Escape"&&(this.subElement.classList.add("fn__none"),Z(this.range))}),l.addEventListener("input",r=>{r.stopPropagation(),w("/api/search/searchTemplate",{k:l.value},c=>{let d="";c.data.blocks.forEach((f,g)=>{d+=`<div data-value="${f.path}" class="b3-list-item${g===0?" b3-list-item--focus":""}">${f.content}</div>`}),i.innerHTML=d||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`;const u=c.data.blocks[0]?.path;o!==u&&(o=u,hs(o,s,e.block.parentID))})}),this.subElement.lastElementChild.addEventListener("click",r=>{const c=r.target;if(c.classList.contains("b3-list--empty")){this.subElement.classList.add("fn__none"),Z(this.range),r.stopPropagation();return}const d=A(c,"b3-list-item__action");if(d&&d.getAttribute("data-type")==="open"){fn(d.parentElement.getAttribute("data-value"),"folder"),r.stopPropagation();return}if(d&&d.getAttribute("data-type")==="remove"){Ne(window.siyuan.languages.remove,window.siyuan.languages.confirmDelete+"?",()=>{w("/api/search/removeTemplate",{path:d.parentElement.getAttribute("data-value")},()=>{if(d.parentElement.parentElement.childElementCount===1)d.parentElement.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,hs("",s,e.block.parentID);else{if(d.parentElement.classList.contains("b3-list-item--focus")){const h=d.parentElement.previousElementSibling||d.parentElement.nextElementSibling;h.classList.add("b3-list-item--focus");const m=h.getAttribute("data-value");if(o===m)return;o=m,hs(o,s,e.block.parentID)}d.parentElement.remove()}})}),r.stopPropagation();return}if(q(c,"data-type","previous")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowUp"})),r.stopPropagation();return}if(q(c,"data-type","next")){l.dispatchEvent(new KeyboardEvent("keydown",{key:"ArrowDown"})),r.stopPropagation();return}const g=A(c,"b3-list-item");g&&(Dp(decodeURIComponent(g.getAttribute("data-value")),e,n),r.stopPropagation())}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),l.select(),w("/api/search/searchTemplate",{k:""},r=>{let c="";r.data.blocks.forEach((u,f)=>{c+=`<div data-value="${u.path}" class="b3-list-item--hide-action b3-list-item${f===0?" b3-list-item--focus":""}">
<span class="b3-list-item__text">${u.content}</span>`,c+=`<span data-type="open" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.showInFolder}">
    <svg><use xlink:href="#iconFolder"></use></svg>
</span>`,c+=`<span data-type="remove" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></div>`}),c===""&&(c=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`),this.subElement.querySelector(".b3-list--background").innerHTML=c;const d=$n(n,a);ke(this.subElement,d.left,d.top+18,p.Constants.SIZE_TOOLBAR_HEIGHT),this.subElement.firstElementChild.style.maxHeight=Math.min(window.innerHeight*.8,window.innerHeight-this.subElement.getBoundingClientRect().top)-16+"px"})}showWidget(e,n,a){this.range=a,X(["hint"],e),window.siyuan.menus.menu.remove(),this.subElement.style.width="",this.subElement.style.padding="",this.subElement.innerHTML=`<div class="fn__flex-column" style="max-height:50vh">
    <input style="margin: 0 8px 4px 8px" class="b3-text-field"/>
    <div class="b3-list fn__flex-1 b3-list--background" style="position: relative"><img style="margin: 0 auto;display: block;width: 64px;height:64px" src="/stage/loading-pure.svg"></div>
</div>`;const i=this.subElement.lastElementChild.lastElementChild,s=this.subElement.querySelector("input");s.addEventListener("keydown",o=>{o.stopPropagation(),!o.isComposing&&(Bn(i,o),o.key==="Enter"?($p(this.subElement.querySelector(".b3-list-item--focus").textContent,e),this.subElement.classList.add("fn__none"),o.preventDefault()):o.key==="Escape"&&(this.subElement.classList.add("fn__none"),Z(this.range)))}),s.addEventListener("input",o=>{o.stopPropagation(),w("/api/search/searchWidget",{k:s.value},l=>{let r="";l.data.blocks.forEach((c,d)=>{r+=`<div data-value="${c.path}" class="b3-list-item${d===0?" b3-list-item--focus":""}">${c.content}</div>`}),i.innerHTML=r})}),this.subElement.lastElementChild.addEventListener("click",o=>{const l=o.target,r=A(l,"b3-list-item");r&&$p(r.textContent,e)}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none"),s.select(),w("/api/search/searchWidget",{k:""},o=>{let l="";o.data.blocks.forEach((c,d)=>{l+=`<div class="b3-list-item${d===0?" b3-list-item--focus":""}">${c.content}</div>`}),this.subElement.querySelector(".b3-list--background").innerHTML=l;const r=$n(n,a);ke(this.subElement,r.left,r.top+18,p.Constants.SIZE_TOOLBAR_HEIGHT)})}showContent(e,n,a){this.range=n,X(["hint"],e),this.subElement.style.width="auto",this.subElement.style.padding="0 8px";let i="";const s=n.toString()!==""||n.cloneContents().childNodes[0]?.classList?.contains("emoji");s&&(i+='<button class="keyboard__action" data-action="copy"><svg><use xlink:href="#iconCopy"></use></svg></button>',e.disabled||(i+=`<button class="keyboard__action" data-action="cut"><svg><use xlink:href="#iconCut"></use></svg></button>
<button class="keyboard__action" data-action="delete"><svg><use xlink:href="#iconTrashcan"></use></svg></button>`)),e.disabled||(i+=`<button class="keyboard__action" data-action="paste"><svg><use xlink:href="#iconPaste"></use></svg></button>
<button class="keyboard__action" data-action="select"><svg><use xlink:href="#iconSelect"></use></svg></button>`),(s||!e.disabled)&&(i+='<button class="keyboard__action" data-action="more"><svg><use xlink:href="#iconMore"></use></svg></button>'),this.subElement.innerHTML=`<div class="fn__flex">${i}</div>`,this.subElement.lastElementChild.addEventListener("click",async l=>{const r=A(l.target,"keyboard__action");if(!r)return;const c=r.getAttribute("data-action");if(c==="copy")Z(re(a)),document.execCommand("copy"),this.subElement.classList.add("fn__none");else if(c==="cut")Z(re(a)),document.execCommand("cut"),this.subElement.classList.add("fn__none");else if(c==="delete"){const d=re(a);d.insertNode(document.createElement("wbr"));const u=a.outerHTML;d.extractContents(),fe(a,d),Z(d),J(e,a.getAttribute("data-node-id"),a.outerHTML,u),this.subElement.classList.add("fn__none")}else if(c==="paste"){if(document.queryCommandSupported("paste"))document.execCommand("paste");else try{const d=await ce();kd(e,d,a)}catch(d){console.log(d)}this.subElement.classList.add("fn__none")}else c==="select"?(Fo(e,a,n),this.subElement.classList.add("fn__none")):c==="copyPlainText"?(Z(re(a)),ee(getSelection().getRangeAt(0).toString()),this.subElement.classList.add("fn__none")):c==="pasteAsPlainText"?(Z(re(a)),Ed(e),this.subElement.classList.add("fn__none")):c==="pasteEscaped"?(Op(e,a),this.subElement.classList.add("fn__none")):c==="back"?this.subElement.lastElementChild.innerHTML=i:c==="more"&&(this.subElement.lastElementChild.innerHTML=`<button class="keyboard__action${s?"":" fn__none"}" data-action="copyPlainText"><span>${window.siyuan.languages.copyPlainText}</span></button>
<div class="keyboard__split${s?"":" fn__none"}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteAsPlainText"><span>${window.siyuan.languages.pasteAsPlainText}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action${e.disabled?" fn__none":""}" data-action="pasteEscaped"><span>${window.siyuan.languages.pasteEscaped}</span></button>
<div class="keyboard__split${e.disabled?" fn__none":""}"></div>
<button class="keyboard__action" data-action="back"><svg><use xlink:href="#iconBack"></use></svg></button>`,ke(this.subElement,o.left,o.top+28,p.Constants.SIZE_TOOLBAR_HEIGHT))}),this.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),this.subElement.classList.remove("fn__none"),this.subElementCloseCB=void 0,this.element.classList.add("fn__none");const o=$n(a,n);ke(this.subElement,o.left,o.top-48,p.Constants.SIZE_TOOLBAR_HEIGHT)}}const rb=t=>{window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.transferBlockRef,icon:"iconScrollHoriz",click(){const e=new me({title:window.siyuan.languages.transferBlockRef,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.targetBlockID}">
    <div class="b3-label__text">${window.siyuan.languages.transferBlockRefTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.focus(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{w("/api/block/transferBlockRef",{fromID:t,toID:n.value}),e.destroy()})}}).element)};class zE{constructor(e){$e()?this.gutterTip=window.siyuan.languages.gutterTip:this.gutterTip=window.siyuan.languages.gutterTip.replace(/⌘/g,"Ctrl+").replace(/⌥/g,"Alt+").replace(/⇧/g,"Shift+").replace(/⌃/g,"Ctrl+"),this.element=document.createElement("div"),this.element.className="protyle-gutters",this.element.addEventListener("dragstart",n=>{hn();const a=n.target.parentElement;let i=[],s=[],o;a.dataset.rowId?(o=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"]`)).find(r=>{if(!q(r,"data-type","NodeBlockQueryEmbed"))return!0}),o.querySelector(`.av__row[data-id="${a.dataset.rowId}"]`).classList.add("av__row--select"),o.querySelectorAll(".av__row--select:not(.av__row--header)").forEach(r=>{i.push(r.getAttribute("data-id")),s.push(r)})):(i=[a.getAttribute("data-node-id")],s=Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select")),s.length>0?(i=[],s.forEach(r=>{i.push(r.getAttribute("data-node-id"))})):s=[e.wysiwyg.element.querySelector(`[data-node-id="${i[0]}"]`)]);const l=document.createElement("div");l.className=e.wysiwyg.element.className,s.forEach(r=>{if(r.getAttribute("data-type")==="NodeIFrame"){const c=Cn();c.classList.add("protyle-wysiwyg--select"),ae(c).innerHTML='<svg class="svg"><use xlink:href="#iconLanguage"></use></svg> IFrame',l.append(c)}else l.append(r.cloneNode(!0))}),l.setAttribute("style",`position:fixed;opacity:.1;width:${s[0].clientWidth}px;padding:0;`),document.body.append(l),n.dataTransfer.setDragImage(l,0,0),setTimeout(()=>{l.remove()}),a.style.opacity="0.1",window.siyuan.dragElement=o||e.wysiwyg.element,n.dataTransfer.setData(`${p.Constants.SIYUAN_DROP_GUTTER}${a.getAttribute("data-type")}${p.Constants.ZWSP}${a.getAttribute("data-subtype")}${p.Constants.ZWSP}${i}`,e.wysiwyg.element.innerHTML)}),this.element.addEventListener("dragend",()=>{this.element.querySelectorAll("button").forEach(n=>{n.style.opacity=""}),window.siyuan.dragElement=void 0}),this.element.addEventListener("click",n=>{const a=_e(n.target,"BUTTON");if(!a)return;n.preventDefault(),n.stopPropagation(),hn();const i=a.getAttribute("data-node-id");if(!i){if(a.getAttribute("disabled"))return;a.setAttribute("disabled","disabled");let o;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${(a.previousElementSibling||a.nextElementSibling).getAttribute("data-node-id")}"]`)).find(l=>{if(!q(l.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(l))return o=l,!0}),!o)return;if(n.altKey){let l=!0;Array.from(o.children).find(d=>{if(d.classList.contains("list")&&Array.from(d.children).find(f=>{if(f.classList.contains("li")&&f.getAttribute("fold")!=="1"&&f.childElementCount>3)return l=!1,!0}))return!0});const r=[],c=[];Array.from(o.children).forEach(d=>{d.classList.contains("list")&&Array.from(d.children).forEach(u=>{if(u.classList.contains("li")){l?u.removeAttribute("fold"):u.childElementCount>3&&u.setAttribute("fold","1");const f=u.getAttribute("data-node-id");r.push({action:"setAttrs",id:f,data:JSON.stringify({fold:l?"0":"1"})}),c.push({action:"setAttrs",id:f,data:JSON.stringify({fold:l?"1":"0"})})}})}),F(e,r,c),a.removeAttribute("disabled")}else{const l=zt(e,o);l==="1"?a.firstElementChild.style.transform="":l==="0"&&(a.firstElementChild.style.transform="rotate(90deg)")}X(["select"],e),window.siyuan.menus.menu.remove();return}const s=a.getBoundingClientRect();if(a.dataset.type==="NodeAttributeViewRowMenu"||a.dataset.type==="NodeAttributeViewRow"){const o=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"] .av__row[data-id="${a.dataset.rowId}"]`)).find(r=>{if(!q(r,"data-type","NodeBlockQueryEmbed"))return!0});if(!o)return;const l=x(o);if(!l)return;if(a.dataset.type==="NodeAttributeViewRow"){const r=l.getAttribute("data-av-id"),c=[Lute.NewNodeID()],d=n.altKey?o.previousElementSibling.getAttribute("data-id")||"":a.dataset.rowId;F(e,[{action:"insertAttrViewBlock",avID:r,previousID:d,srcIDs:c,isDetached:!0}],[{action:"removeAttrViewBlock",srcIDs:c,avID:r}]),co(l,c,d,r)}else Kl(e,o,{x:s.left,y:s.bottom,w:s.width,h:s.height,isLeft:!0});return}if(O(n))Vt({protyle:e,id:i});else if(n.altKey&&!e.disabled){let o;if(Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${i}"]`)).find(l=>{if(!q(l.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(l))return o=l,!0}),!o)return;if(a.getAttribute("data-type")==="NodeListItem"&&o.parentElement.getAttribute("data-node-id")){let l=!0;Array.from(o.parentElement.children).find(d=>{if(d.classList.contains("li")&&d.getAttribute("fold")!=="1"&&d.childElementCount>3)return l=!1,!0});const r=[],c=[];Array.from(o.parentElement.children).find(d=>{if(d.classList.contains("li")){l?d.removeAttribute("fold"):d.childElementCount>3&&d.setAttribute("fold","1");const u=d.getAttribute("data-node-id");r.push({action:"setAttrs",id:u,data:JSON.stringify({fold:l?"0":"1"})}),c.push({action:"setAttrs",id:u,data:JSON.stringify({fold:l?"1":"0"})})}}),F(e,r,c)}else zt(e,o);o.classList.remove("protyle-wysiwyg--hl")}else window.siyuan.shiftIsPressed&&!e.disabled?Ca(e.wysiwyg.element.querySelector(`[data-node-id="${i}"]`),"bookmark",e):!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed&&(this.renderMenu(e,a),e.toolbar.range||(e.toolbar.range=re(e.wysiwyg.element.firstElementChild)),(0,I.tq)()?window.siyuan.menus.menu.fullscreen():(window.siyuan.menus.menu.popup({x:s.left,y:s.bottom,isLeft:!0}),window.siyuan.menus.menu.element.setAttribute("data-from",A(e.element,"block__edit")?"popover":"app"),Z(e.toolbar.range)))}),this.element.addEventListener("contextmenu",n=>{const a=_e(n.target,"BUTTON");if(!(!a||a.getAttribute("data-type")==="fold")){if(!window.siyuan.ctrlIsPressed&&!window.siyuan.altIsPressed&&!window.siyuan.shiftIsPressed){hn();const i=a.getBoundingClientRect();if(a.dataset.type==="NodeAttributeViewRowMenu"){const s=Array.from(e.wysiwyg.element.querySelectorAll(`.av[data-node-id="${a.dataset.nodeId}"] .av__row[data-id="${a.dataset.rowId}"]`)).find(o=>{if(!q(o,"data-type","NodeBlockQueryEmbed"))return!0});s&&Kl(e,s,{x:i.left,y:i.bottom,w:i.width,h:i.height,isLeft:!0})}else a.dataset.type!=="NodeAttributeViewRow"&&(this.renderMenu(e,a),window.siyuan.menus.menu.popup({x:i.left,y:i.bottom,isLeft:!0}),window.siyuan.menus.menu.element.setAttribute("data-from",A(e.element,"block__edit")?"popover":"app"))}n.preventDefault(),n.stopPropagation()}}),this.element.addEventListener("mouseover",n=>{const a=_e(n.target,"BUTTON");if(!a)return;const i=a.getAttribute("data-type");if(i==="fold"||i==="NodeAttributeViewRow"){Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(s=>{s.classList.remove("protyle-wysiwyg--hl","av__row--hl")});return}Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${a.getAttribute("data-node-id")}"]`)).find(s=>{if(!q(s.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(s)){const o=s.querySelector(`.av__row[data-id="${a.dataset.rowId}"]`);return Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, av__row--hl")).forEach(l=>{s.isSameNode(l)||l.classList.remove("protyle-wysiwyg--hl"),o&&!o.isSameNode(l)&&o.classList.remove("av__row--hl")}),i==="NodeAttributeViewRowMenu"?o.classList.add("av__row--hl"):s.classList.add("protyle-wysiwyg--hl"),!0}}),n.preventDefault()}),this.element.addEventListener("mouseleave",n=>{Array.from(e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl, .av__row--hl")).forEach(a=>{a.classList.remove("protyle-wysiwyg--hl","av__row--hl")}),n.preventDefault(),n.stopPropagation()})}isMatchNode(e){const n=e.getBoundingClientRect();let a=this.element.getBoundingClientRect().top+4;return n.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&(a=a-(n.height-this.element.clientHeight)/2),n.top<=a&&n.bottom>=a}turnsOneInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,async click(){if(e.nodeElement.querySelector("wbr")||ae(e.nodeElement)?.insertAdjacentHTML("afterbegin","<wbr>"),e.type==="CancelList"||e.type==="CancelBlockquote")for await(const o of e.nodeElement.querySelectorAll('[data-type="NodeHeading"][fold="1"]')){const l=o.getAttribute("data-node-id");o.removeAttribute("fold");const r=await lt("/api/transactions",{session:e.protyle.id,app:p.Constants.SIYUAN_APPID,transactions:[{doOperations:[{action:"unfoldHeading",id:l}],undoOperations:[{action:"foldHeading",id:l}]}]});e.protyle.undo.add([{action:"unfoldHeading",id:l}],[{action:"foldHeading",id:l}]),o.insertAdjacentHTML("afterend",r.data[0].doOperations[0].retData)}const n=e.nodeElement.outerHTML,a=e.nodeElement.previousElementSibling?.getAttribute("data-node-id"),i=e.nodeElement.parentElement.getAttribute("data-node-id")||e.protyle.block.parentID,s=e.protyle.lute[e.type](e.nodeElement.outerHTML,e.level);if(e.nodeElement.outerHTML=s,e.type==="CancelList"||e.type==="CancelBlockquote"){const o=document.createElement("template");o.innerHTML=s;const l=[{action:"delete",id:e.id}],r=[];let c=a;Array.from(o.content.children).forEach(d=>{const u=d.getAttribute("data-node-id");l.push({action:"insert",data:d.outerHTML,id:u,previousID:c,parentID:i}),r.push({action:"delete",id:u}),c=u}),r.push({action:"insert",data:n,id:e.id,previousID:a,parentID:i}),F(e.protyle,l,r)}else J(e.protyle,e.id,s,n);fe(e.protyle.wysiwyg.element,re(e.protyle.wysiwyg.element)),e.protyle.wysiwyg.element.querySelectorAll('[data-type~="block-ref"]').forEach(o=>{o.textContent===""&&w("/api/block/getRefText",{id:o.getAttribute("data-id")},l=>{o.innerHTML=l.data})}),Be(e.protyle,e.protyle.wysiwyg.element),bt(e.protyle.wysiwyg.element),qe(e.protyle.wysiwyg.element),mt(e.protyle.wysiwyg.element,e.protyle)}}}turnsIntoOne(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){sr(e)}}}turnsInto(e){return{icon:e.icon,label:e.label,accelerator:e.accelerator,click(){aa(e)}}}showMobileAppearance(e){const n=document.getElementById("keyboardToolbar"),a=n.querySelectorAll("#keyboardToolbar .keyboard__dynamic");a[0].classList.add("fn__none"),a[1].classList.remove("fn__none"),n.querySelector('.keyboard__action[data-type="text"]').classList.add("protyle-toolbar__item--current"),n.querySelector('.keyboard__action[data-type="done"] use').setAttribute("xlink:href","#iconCloseRound"),n.classList.remove("fn__none");const i=e.contentElement.scrollTop+333.5;rg(e,n),Md(i)}renderMultipleMenu(e,n){let a=!1,i=!1,s=!1;if(n.find((c,d)=>{if(c.classList.contains("li"))return a=!0,!0;if((c.classList.contains("sb")||c.classList.contains("p"))&&(s=!0),c.nextElementSibling&&n[d+1]&&c.nextElementSibling.isSameNode(n[d+1]))i=!0;else if(d!==n.length-1)return i=!1,!0}),!a&&!e.disabled){const c=[];i&&(c.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:n,type:"Blocks2ULs"})),c.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:n,type:"Blocks2OLs"})),c.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:n,type:"Blocks2TLs"})),c.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:n,type:"Blocks2Blockquote"}))),s||c.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:n,type:"Blocks2Ps",isContinue:i})),c.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:n,level:1,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:n,level:2,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:n,level:3,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:n,level:4,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:n,level:5,type:"Blocks2Hs",isContinue:i})),c.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:n,level:6,type:"Blocks2Hs",isContinue:i})),window.siyuan.menus.menu.append(new S({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:c}).element),i&&window.siyuan.menus.menu.append(new S({icon:"iconSuper",label:window.siyuan.languages.merge+" "+window.siyuan.languages.superBlock,type:"submenu",submenu:[this.turnsIntoOne({label:window.siyuan.languages.hLayout,accelerator:window.siyuan.config.keymap.editor.general.hLayout.custom,icon:"iconSplitLR",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"col"}),this.turnsIntoOne({label:window.siyuan.languages.vLayout,accelerator:window.siyuan.config.keymap.editor.general.vLayout.custom,icon:"iconSplitTB",protyle:e,selectsElement:n,type:"BlocksMergeSuperBlock",level:"row"})]}).element)}e.disabled||eb(n,e);const o=[{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){if(Ft(n[0])){let c="";n.forEach(d=>{c+=ma(d)}),G(e.lute.BlockDOM2StdMd(c).trimEnd())}else Z(re(n[0])),document.execCommand("copy")}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let c="";n.forEach(d=>{d.querySelectorAll("[spellcheck]").forEach(u=>{c+=u.textContent+`
`})}),ee(c.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){Rd(n,e)}}],l=this.genCopyTextRef(n);if(l&&o.splice(2,0,l),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:o}).element),e.disabled)return;window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{if(Ft(n[0])){let c="";n.forEach(d=>{c+=ma(d)}),G(e.lute.BlockDOM2StdMd(c).trimEnd()),e.breadcrumb?.hide(),rn(e,n[0],re(n[0]))}else Z(re(n[0])),document.execCommand("cut")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{ga(c=>{bd(c[0],n,e)})}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{e.breadcrumb?.hide(),rn(e,n[0],re(n[0]))}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element);const r=new S({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append($d(e,n)),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0;const c=n[0].getBoundingClientRect();ke(e.toolbar.subElement,c.left,c.top)}}).element;return window.siyuan.menus.menu.append(r),(0,I.tq)()||r.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign(n,e),this.genWidths(n,e),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){Do(e,n)}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){const c=[];n.forEach(d=>{d.getAttribute("data-type")!=="NodeThematicBreak"&&c.push(d.getAttribute("data-node-id"))}),Io(e.app,c)}}).element),e?.app?.plugins&&en({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:n},separatorPosition:"top"}),window.siyuan.menus.menu}renderMenu(e,n){if(!n)return;X(["util","toolbar","hint"],e),window.siyuan.menus.menu.remove(),(0,I.tq)()&&nr();const a=n.getAttribute("data-node-id"),i=e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");if(i.length>1&&Array.from(i).find(g=>{if(a===g.getAttribute("data-node-id"))return!0}))return this.renderMultipleMenu(e,Array.from(i));let s;if(n.tagName==="BUTTON"?Array.from(e.wysiwyg.element.querySelectorAll(`[data-node-id="${a}"]`)).find(f=>{if(!q(f.parentElement,"data-type","NodeBlockQueryEmbed")&&this.isMatchNode(f))return s=f,!0}):s=n,!s)return;const o=s.getAttribute("data-type"),l=s.getAttribute("data-subtype"),r=[];X(["select"],e),s.classList.add("protyle-wysiwyg--select"),Gt([a],e.block.rootID),o==="NodeParagraph"&&!e.disabled?(r.push(this.turnsIntoOne({icon:"iconList",label:window.siyuan.languages.list,protyle:e,selectsElement:[s],type:"Blocks2ULs"})),r.push(this.turnsIntoOne({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,selectsElement:[s],type:"Blocks2OLs"})),r.push(this.turnsIntoOne({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,selectsElement:[s],type:"Blocks2TLs"})),r.push(this.turnsIntoOne({icon:"iconQuote",label:window.siyuan.languages.quote,protyle:e,selectsElement:[s],type:"Blocks2Blockquote"})),r.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[s],level:1,type:"Blocks2Hs"})),r.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[s],level:2,type:"Blocks2Hs"})),r.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[s],level:3,type:"Blocks2Hs"})),r.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[s],level:4,type:"Blocks2Hs"})),r.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[s],level:5,type:"Blocks2Hs"})),r.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[s],level:6,type:"Blocks2Hs"}))):o==="NodeHeading"&&!e.disabled?(r.push(this.turnsInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,accelerator:window.siyuan.config.keymap.editor.heading.paragraph.custom,protyle:e,selectsElement:[s],type:"Blocks2Ps"})),l!=="h1"&&r.push(this.turnsInto({icon:"iconH1",label:window.siyuan.languages.heading1,accelerator:window.siyuan.config.keymap.editor.heading.heading1.custom,protyle:e,selectsElement:[s],level:1,type:"Blocks2Hs"})),l!=="h2"&&r.push(this.turnsInto({icon:"iconH2",label:window.siyuan.languages.heading2,accelerator:window.siyuan.config.keymap.editor.heading.heading2.custom,protyle:e,selectsElement:[s],level:2,type:"Blocks2Hs"})),l!=="h3"&&r.push(this.turnsInto({icon:"iconH3",label:window.siyuan.languages.heading3,accelerator:window.siyuan.config.keymap.editor.heading.heading3.custom,protyle:e,selectsElement:[s],level:3,type:"Blocks2Hs"})),l!=="h4"&&r.push(this.turnsInto({icon:"iconH4",label:window.siyuan.languages.heading4,accelerator:window.siyuan.config.keymap.editor.heading.heading4.custom,protyle:e,selectsElement:[s],level:4,type:"Blocks2Hs"})),l!=="h5"&&r.push(this.turnsInto({icon:"iconH5",label:window.siyuan.languages.heading5,accelerator:window.siyuan.config.keymap.editor.heading.heading5.custom,protyle:e,selectsElement:[s],level:5,type:"Blocks2Hs"})),l!=="h6"&&r.push(this.turnsInto({icon:"iconH6",label:window.siyuan.languages.heading6,accelerator:window.siyuan.config.keymap.editor.heading.heading6.custom,protyle:e,selectsElement:[s],level:6,type:"Blocks2Hs"}))):o==="NodeList"&&!e.disabled?(r.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:s,id:a,type:"CancelList"})),s.getAttribute("data-subtype")==="o"?(r.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:s,id:a,type:"OL2UL"})),r.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:s,id:a,type:"UL2TL"}))):s.getAttribute("data-subtype")==="t"?(r.push(this.turnsOneInto({icon:"iconList",label:window.siyuan.languages.list,protyle:e,nodeElement:s,id:a,type:"TL2UL"})),r.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:s,id:a,type:"TL2OL"}))):(r.push(this.turnsOneInto({icon:"iconOrderedList",label:window.siyuan.languages["ordered-list"],protyle:e,nodeElement:s,id:a,type:"UL2OL"})),r.push(this.turnsOneInto({icon:"iconCheck",label:window.siyuan.languages.check,protyle:e,nodeElement:s,id:a,type:"OL2TL"})))):o==="NodeBlockquote"&&!e.disabled&&r.push(this.turnsOneInto({icon:"iconParagraph",label:window.siyuan.languages.paragraph,protyle:e,nodeElement:s,id:a,type:"CancelBlockquote"})),r.length>0&&!e.disabled&&window.siyuan.menus.menu.append(new S({icon:"iconRefresh",label:window.siyuan.languages.turnInto,type:"submenu",submenu:r}).element),!e.disabled&&!s.classList.contains("hr")&&eb([s],e);const c=Li(a,!0,s).concat([{label:window.siyuan.languages.copy,accelerator:"\u2318C",click(){Ft(s)?G(e.lute.BlockDOM2StdMd(ma(s)).trimEnd()):(Z(re(s)),document.execCommand("copy"))}},{label:window.siyuan.languages.copyPlainText,accelerator:window.siyuan.config.keymap.editor.general.copyPlainText.custom,click(){let f="";s.querySelectorAll("[spellcheck]").forEach(g=>{f+=g.textContent+`
`}),ee(f.trimEnd())}},{label:window.siyuan.languages.duplicate,accelerator:window.siyuan.config.keymap.editor.general.duplicate.custom,disabled:e.disabled,click(){Rd([s],e)}}]),d=this.genCopyTextRef([s]);if(d&&c.splice(c.length-1,0,d),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:c}).element),e.disabled||(window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.cut,accelerator:"\u2318X",icon:"iconCut",click:()=>{Ft(s)?(G(e.lute.BlockDOM2StdMd(ma(s)).trimEnd()),rn(e,s,re(s)),e.breadcrumb?.hide()):(Z(re(s)),document.execCommand("cut"))}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.move,accelerator:window.siyuan.config.keymap.general.move.custom,icon:"iconMove",click:()=>{ga(f=>{bd(f[0],[s],e)})}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.delete,icon:"iconTrashcan",accelerator:"\u232B",click:()=>{e.breadcrumb?.hide(),rn(e,s,re(s))}}).element)),o==="NodeSuperBlock"&&!e.disabled)window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.cancel+" "+window.siyuan.languages.superBlock,click(){const f=ns(e,s);F(e,f.doOperations,f.undoOperations),le(e.wysiwyg.element.querySelector(`[data-node-id="${f.previousId}"]`)),X(["gutter"],e)}}).element);else if(o==="NodeCodeBlock"&&!e.disabled&&!s.getAttribute("data-subtype")){window.siyuan.menus.menu.append(new S({type:"separator"}).element);const f=s.getAttribute("linewrap"),g=s.getAttribute("ligatures"),h=s.getAttribute("linenumber");window.siyuan.menus.menu.append(new S({type:"submenu",icon:"iconCode",label:window.siyuan.languages.code,submenu:[{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md31}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${f==="true"||window.siyuan.config.editor.codeLineWrap&&f!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const y=m.querySelector("input");b.target.tagName!=="INPUT"&&(y.checked=!y.checked),s.setAttribute("linewrap",y.checked.toString()),s.querySelector(".hljs").removeAttribute("data-render"),qe(s),w("/api/attr/setBlockAttrs",{id:a,attrs:{linewrap:y.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md2}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${g==="true"||window.siyuan.config.editor.codeLigatures&&g!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const y=m.querySelector("input");b.target.tagName!=="INPUT"&&(y.checked=!y.checked),s.setAttribute("ligatures",y.checked.toString()),s.querySelector(".hljs").removeAttribute("data-render"),qe(s),w("/api/attr/setBlockAttrs",{id:a,attrs:{ligatures:y.checked.toString()}}),window.siyuan.menus.menu.remove()})}},{iconHTML:"",label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.md27}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${h==="true"||window.siyuan.config.editor.codeSyntaxHighlightLineNum&&h!=="false"?" checked":""}></div>`,bind(m){m.addEventListener("click",b=>{const y=m.querySelector("input");b.target.tagName!=="INPUT"&&(y.checked=!y.checked),s.setAttribute("linenumber",y.checked.toString()),s.querySelector(".hljs").removeAttribute("data-render"),qe(s),w("/api/attr/setBlockAttrs",{id:a,attrs:{linenumber:y.checked.toString()}}),window.siyuan.menus.menu.remove()})}}]}).element)}else if(o==="NodeCodeBlock"&&!e.disabled&&["echarts","mindmap"].includes(s.getAttribute("data-subtype"))){window.siyuan.menus.menu.append(new S({type:"separator"}).element);const f=s.style.height;let g=s.outerHTML;window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.chart,icon:"iconCode",submenu:[{label:`${window.siyuan.languages.height}<span class="fn__space"></span>
<input style="margin: 4px 0;width: 84px" type="number" step="1" min="148" class="b3-text-field" value="${f?parseInt(f):"420"}">`,bind:h=>{h.querySelector("input").addEventListener("change",m=>{const b=(m.target.value||"420")+"px";s.style.height=b,s.firstElementChild.nextElementSibling.style.height=b,J(e,a,s.outerHTML,g),g=s.outerHTML,m.stopPropagation();const y=window.echarts.getInstanceById(s.firstElementChild.nextElementSibling.getAttribute("_echarts_instance_"));y&&y.resize()})}},{label:window.siyuan.languages.update,icon:"iconEdit",click(){e.toolbar.showRender(e,s)}}]}).element)}else if(o==="NodeTable"&&!e.disabled){let f=re(s);const g=s.querySelector("table");g.contains(f.startContainer)||(f=re(g.querySelector("th")));const h=se(f.startContainer,"TD")||se(f.startContainer,"TH");h&&(window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({type:"submenu",icon:"iconTable",label:window.siyuan.languages.table,submenu:_g(e,s,h,f)}).element))}else if((o==="NodeVideo"||o==="NodeAudio")&&!e.disabled)window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({id:"assetSubMenu",type:"submenu",icon:o==="NodeVideo"?"iconVideo":"iconRecord",label:window.siyuan.languages.assets,submenu:l_(e,s,o)}).element);else if(o==="NodeIFrame"&&!e.disabled)window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({id:"assetSubMenu",type:"submenu",icon:"iconLanguage",label:window.siyuan.languages.assets,submenu:o_(e,s)}).element);else if(o==="NodeHTMLBlock"&&!e.disabled)window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({icon:"iconHTML5",label:"HTML",click(){e.toolbar.showRender(e,s)}}).element);else if(o==="NodeBlockQueryEmbed"&&!e.disabled){window.siyuan.menus.menu.append(new S({type:"separator"}).element);const f=s.getAttribute("breadcrumb");window.siyuan.menus.menu.append(new S({id:"assetSubMenu",type:"submenu",icon:"iconSQL",label:window.siyuan.languages.blockEmbed,submenu:[{icon:"iconRefresh",label:`${window.siyuan.languages.refresh} SQL`,click(){s.removeAttribute("data-render"),Be(e,s)}},{icon:"iconEdit",label:`${window.siyuan.languages.update} SQL`,click(){e.toolbar.showRender(e,s)}},{type:"separator"},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.embedBlockBreadcrumb}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${f==="true"||window.siyuan.config.editor.embedBlockBreadcrumb&&f!=="false"?" checked":""}></div>`,bind(g){g.addEventListener("click",h=>{const m=g.querySelector("input");h.target.tagName!=="INPUT"&&(m.checked=!m.checked),s.setAttribute("breadcrumb",m.checked.toString()),w("/api/attr/setBlockAttrs",{id:a,attrs:{breadcrumb:m.checked.toString()}}),s.removeAttribute("data-render"),Be(e,s),window.siyuan.menus.menu.remove()})}},{label:`<div class="fn__flex" style="margin-bottom: 4px"><span>${window.siyuan.languages.hideHeadingBelowBlocks}</span><span class="fn__space fn__flex-1"></span>
<input type="checkbox" class="b3-switch fn__flex-center"${s.getAttribute("custom-heading-mode")==="1"?" checked":""}></div>`,bind(g){g.addEventListener("click",h=>{const m=g.querySelector("input");h.target.tagName!=="INPUT"&&(m.checked=!m.checked),s.setAttribute("custom-heading-mode",m.checked?"1":"0"),w("/api/attr/setBlockAttrs",{id:a,attrs:{"custom-heading-mode":m.checked?"1":"0"}}),s.removeAttribute("data-render"),Be(e,s),window.siyuan.menus.menu.remove()})}}]}).element)}else if(o==="NodeHeading"&&!e.disabled){window.siyuan.menus.menu.append(new S({type:"separator"}).element);const f=[];l!=="h1"&&f.push(this.genHeadingTransform(e,a,1)),l!=="h2"&&f.push(this.genHeadingTransform(e,a,2)),l!=="h3"&&f.push(this.genHeadingTransform(e,a,3)),l!=="h4"&&f.push(this.genHeadingTransform(e,a,4)),l!=="h5"&&f.push(this.genHeadingTransform(e,a,5)),l!=="h6"&&f.push(this.genHeadingTransform(e,a,6)),window.siyuan.menus.menu.append(new S({type:"submenu",icon:"iconRefresh",label:window.siyuan.languages.tWithSubtitle,submenu:f}).element),window.siyuan.menus.menu.append(new S({icon:"iconCopy",label:`${window.siyuan.languages.copy} ${window.siyuan.languages.headings1}`,click(){w("/api/block/getHeadingChildrenDOM",{id:a},g=>{G(g.data+p.Constants.ZWSP)})}}).element),window.siyuan.menus.menu.append(new S({icon:"iconCut",label:`${window.siyuan.languages.cut} ${window.siyuan.languages.headings1}`,click(){w("/api/block/getHeadingChildrenDOM",{id:a},g=>{G(g.data+p.Constants.ZWSP),w("/api/block/getHeadingDeleteTransaction",{id:a},h=>{h.data.doOperations.forEach(m=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${m.id}"]`).forEach(b=>{b.remove()})}),F(e,h.data.doOperations,h.data.undoOperations)})})}}).element),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:`${window.siyuan.languages.delete} ${window.siyuan.languages.headings1}`,click(){w("/api/block/getHeadingDeleteTransaction",{id:a},g=>{g.data.doOperations.forEach(h=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${h.id}"]`).forEach(m=>{m.remove()})}),F(e,g.data.doOperations,g.data.undoOperations)})}}).element)}if(window.siyuan.menus.menu.append(new S({type:"separator"}).element),e.options.backlinkData||(window.siyuan.menus.menu.append(new S({accelerator:`${K(window.siyuan.config.keymap.general.enter.custom)}/${K("\u2318Click")}`,label:window.siyuan.languages.enter,click:()=>{Vt({protyle:e,id:a})}}).element),window.siyuan.menus.menu.append(new S({accelerator:window.siyuan.config.keymap.general.enterBack.custom,label:window.siyuan.languages.enterBack,click:()=>{Ud(e,a)}}).element)),!e.disabled){window.siyuan.menus.menu.append(new S({icon:"iconBefore",label:window.siyuan.languages["insert-before"],accelerator:window.siyuan.config.keymap.editor.general.insertBefore.custom,click(){X(["select"],e),Gt([],e.block.rootID),wn(e,"beforebegin",a)}}).element),window.siyuan.menus.menu.append(new S({icon:"iconAfter",label:window.siyuan.languages["insert-after"],accelerator:window.siyuan.config.keymap.editor.general.insertAfter.custom,click(){X(["select"],e),Gt([],e.block.rootID),wn(e,"afterend",a)}}).element);const f=s.lastElementChild.querySelector(".protyle-attr--refcount");f&&f.textContent&&rb(a)}if(window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.jumpToParentNext,accelerator:window.siyuan.config.keymap.editor.general.jumpToParentNext.custom,click(){X(["select"],e),Zf(e,s)}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),o!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.fold,accelerator:`${K(window.siyuan.config.keymap.editor.general.collapse.custom)}/${K("\u2325Click")}`,click(){zt(e,s),le(s)}}).element),e.disabled||window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+K("\u21E7Click"),click(){Ca(s,"bookmark",e)}}).element)),!e.disabled){const f=new S({label:window.siyuan.languages.appearance,icon:"iconFont",accelerator:window.siyuan.config.keymap.editor.insert.appearance.custom,click:()=>{e.toolbar.element.classList.add("fn__none"),e.toolbar.subElement.innerHTML="",e.toolbar.subElement.style.width="",e.toolbar.subElement.style.padding="",e.toolbar.subElement.append($d(e,[s])),e.toolbar.subElement.style.zIndex=(++window.siyuan.zIndex).toString(),e.toolbar.subElement.classList.remove("fn__none"),e.toolbar.subElementCloseCB=void 0;const g=s.getBoundingClientRect();ke(e.toolbar.subElement,g.left,g.top)}}).element;window.siyuan.menus.menu.append(f),(0,I.tq)()||f.lastElementChild.classList.add("b3-menu__submenu--row"),this.genAlign([s],e),this.genWidths([s],e)}window.siyuan.menus.menu.append(new S({type:"separator"}).element),!["NodeThematicBreak","NodeBlockQueryEmbed","NodeIFrame","NodeHTMLBlock","NodeWidget","NodeVideo","NodeAudio"].includes(o)&&ae(s)?.textContent.trim()!==""&&(o!=="NodeCodeBlock"||o==="NodeCodeBlock"&&!s.getAttribute("data-subtype"))&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){m_(s)}}).element),o!=="NodeThematicBreak"&&(window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,iconHTML:'<svg class="b3-menu__icon" style="color:var(--b3-theme-primary)"><use xlink:href="#iconRiffCard"></use></svg>',icon:"iconRiffCard",click(){Do(e,[s])}}).element),window.siyuan.config.flashcard.deck&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.addToDeck,icon:"iconRiffCard",click(){Io(e.app,[s.getAttribute("data-node-id")])}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element)),e?.app?.plugins&&en({plugins:e.app.plugins,type:"click-blockicon",detail:{protyle:e,blockElements:[s]},separatorPosition:"bottom"});let u=s.getAttribute("updated")||"";return u&&(u=`${window.siyuan.languages.modifiedAt} ${Q(u).format("YYYY-MM-DD HH:mm:ss")}<br>`),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,type:"readonly",label:`${u}${window.siyuan.languages.createdAt} ${Q(a.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu}genHeadingTransform(e,n,a){return{iconHTML:"",icon:"iconHeading"+a,label:window.siyuan.languages["heading"+a],click(){w("/api/block/getHeadingLevelTransaction",{id:n,level:a},i=>{i.data.doOperations.forEach((s,o)=>{e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{l.outerHTML=s.data}),e.wysiwyg.element.querySelectorAll(`[data-node-id="${s.id}"]`).forEach(l=>{Ln(l)}),o===0&&le(e.wysiwyg.element.querySelector(`[data-node-id="${s.id}"]`),e.wysiwyg.element,!0)}),F(e,i.data.doOperations,i.data.undoOperations)})}}}genClick(e,n,a){bs(e,n,a),le(e[0])}genAlign(e,n){window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.layout,type:"submenu",submenu:[{label:window.siyuan.languages.alignLeft,icon:"iconAlignLeft",accelerator:window.siyuan.config.keymap.editor.general.alignLeft.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="":a.style.textAlign="left"})}},{label:window.siyuan.languages.alignCenter,icon:"iconAlignCenter",accelerator:window.siyuan.config.keymap.editor.general.alignCenter.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="center":a.style.textAlign="center"})}},{label:window.siyuan.languages.alignRight,icon:"iconAlignRight",accelerator:window.siyuan.config.keymap.editor.general.alignRight.custom,click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="flex-end":a.style.textAlign="right"})}},{label:window.siyuan.languages.justify,icon:"iconMenu",click:()=>{this.genClick(e,n,a=>{a.style.textAlign="justify"})}},{type:"separator"},{label:window.siyuan.languages.ltr,icon:"iconLtr",click:()=>{this.genClick(e,n,a=>{a.style.direction="ltr"})}},{label:window.siyuan.languages.rtl,icon:"iconRtl",click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")||(a.style.direction="rtl")})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(e,n,a=>{a.classList.contains("av")?a.style.justifyContent="":(a.style.textAlign="",a.style.direction="")})}}]}).element)}genWidths(e,n){const a=[];["25%","33%","50%","67%","75%"].forEach(s=>{a.push({label:s,click:()=>{this.genClick(e,n,o=>{o.style.width=s,o.style.flex="none"})}})}),a.push({type:"separator"});let i=100;if(e.length===1){const s=e[0].style.width;s.endsWith("%")&&(i=parseInt(s))}window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.width,submenu:a.concat([{label:`<div aria-label="${i}%" class="b3-tooltips b3-tooltips__n${(0,I.tq)()?"":" fn__size200"}">
    <input style="box-sizing: border-box" value="${i}" class="b3-slider fn__block" max="100" min="1" step="1" type="range">
</div>`,bind(s){const o=s.querySelector("input");o.addEventListener("input",()=>{e.forEach(c=>{c.style.width=o.value+"%",c.style.flex="none"}),o.parentElement.setAttribute("aria-label",`${o.value}%`)});const l=[],r=[];e.forEach(c=>{l.push({action:"update",id:c.getAttribute("data-node-id"),data:c.outerHTML})}),o.addEventListener("change",()=>{e.forEach(c=>{r.push({action:"update",id:c.getAttribute("data-node-id"),data:c.outerHTML})}),F(n,r,l),window.siyuan.menus.menu.remove(),le(e[0])})}},{type:"separator"},{label:window.siyuan.languages.clearFontStyle,icon:"iconTrashcan",click:()=>{this.genClick(e,n,s=>{s.style.width&&(s.style.width="",s.style.flex="")})}}])}).element)}genCopyTextRef(e){return Ft(e[0])?!1:{accelerator:window.siyuan.config.keymap.editor.general.copyText.custom,label:window.siyuan.languages.copyText,click(){e[0].setAttribute("data-reftext","true"),Z(re(e[0])),document.execCommand("copy")}}}render(e,n,a,i){const s=a.parentElement.querySelector(".protyle-title__input");if(s&&s.getAttribute("data-render")!=="true")return;const o=a.parentElement.parentElement.querySelector(".protyle-select");if(o&&!o.classList.contains("fn__none"))return;let l="",r=n,c=0,d=0,u,f=!1;for(;r;){const v=!f||f&&r.getAttribute("fold")==="1";if(!q(r.parentElement,"data-type","NodeBlockQueryEmbed")){let C;v&&(C=r.getAttribute("data-type"));const E=r.getAttribute("data-node-id");if(C==="NodeAttributeView"&&i){const D=A(i,"av__row");if(D&&!D.classList.contains("av__row--header")){n=D,l=`<button data-type="NodeAttributeViewRowMenu" data-node-id="${E}" data-row-id="${D.dataset.id}" class="ariaLabel" data-position="right" aria-label="${window.siyuan.languages.rowTip}"><svg><use xlink:href="#iconDrag"></use></svg><span ${e.disabled?"":'draggable="true"'}></span></button>`,e.disabled||(l=`<button data-type="NodeAttributeViewRow" data-node-id="${E}" data-row-id="${D.dataset.id}" class="ariaLabel" data-position="right" aria-label="${$e()?window.siyuan.languages.addBelowAbove:window.siyuan.languages.addBelowAbove.replace("\u2325","Alt+")}"><svg><use xlink:href="#iconAdd"></use></svg></button>${l}`);break}}if(d===0){if(["NodeBlockquote","NodeList","NodeSuperBlock"].includes(C))return;const D=be(r);u=D.querySelector(".li")||D.querySelector(".list"),q(u,"data-type","NodeBlockQueryEmbed")&&(u=void 0),!D.isSameNode(r)&&C!=="NodeHeading"&&(r=D,C=r.getAttribute("data-type"))}C==="NodeListItem"&&d===1&&!v&&(l=""),d+=1;const T=`<button class="ariaLabel" data-position="right" aria-label="${this.gutterTip}" 
data-type="${C}" data-subtype="${r.getAttribute("data-subtype")}" data-node-id="${r.getAttribute("data-node-id")}">
    <svg><use xlink:href="#${bn(C,r.getAttribute("data-subtype"))}"></use></svg>
    <span ${e.disabled?"":'draggable="true"'}></span>
</button>`;v&&(l=T+l);let H="";if(C==="NodeListItem"&&r.childElementCount>3||C==="NodeHeading"){const D=r.getAttribute("fold");H=`<button class="ariaLabel" data-position="right" aria-label="${window.siyuan.languages.fold}" 
data-type="fold"><svg style="width:10px${D&&D==="1"?"":";transform:rotate(90deg)"}"><use xlink:href="#iconPlay"></use></svg></button>`}(C==="NodeListItem"||C==="NodeList")&&(u=r,C==="NodeListItem"&&r.childElementCount>3&&(l=T+H)),C==="NodeHeading"&&(l=l+H),C==="NodeBlockquote"&&(c+=8),r.previousElementSibling&&r.previousElementSibling.getAttribute("data-node-id")&&(f=!0)}const L=x(r.parentElement);if(L)r=L;else break}let g=!0;const h=this.element.querySelectorAll("button");if(h.length!==l.split("</button>").length-1?g=!1:Array.from(h).find(v=>{const k=v.getAttribute("data-node-id");if(k&&l.indexOf(k)===-1)return g=!1,!0;const L=v.getAttribute("data-row-id");if(L&&l.indexOf(L)===-1||!L&&l.indexOf("NodeAttributeViewRowMenu")>-1)return g=!1,!0}),g&&this.element.childElementCount>0){this.element.classList.remove("fn__none");return}this.element.innerHTML=l,this.element.classList.remove("fn__none"),this.element.style.width="";const m=a.parentElement.getBoundingClientRect().top;let b=n.getBoundingClientRect(),y=0;u?(b=u.firstElementChild.getBoundingClientRect(),c=0):r.getAttribute("data-type")==="NodeBlockQueryEmbed"?(b=r.getBoundingClientRect(),c=0):n.classList.contains("av__row")||(b.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)+8||b.height>Math.floor(window.siyuan.config.editor.fontSize*1.625)+8&&b.height<Math.floor(window.siyuan.config.editor.fontSize*1.625)*2+8?y=(b.height-this.element.clientHeight)/2:(r.getAttribute("data-type")==="NodeAttributeView"||n.getAttribute("data-type")==="NodeAttributeView")&&m<b.top&&(y=8)),this.element.style.top=`${Math.max(b.top,m)+y}px`;let _=b.left-this.element.clientWidth-c;r.getAttribute("data-type")==="NodeBlockQueryEmbed"&&this.element.childElementCount===1&&(_=r.getBoundingClientRect().left-this.element.clientWidth-c),this.element.style.left=`${_}px`,_<this.element.parentElement.getBoundingClientRect().left?(this.element.style.width="24px",this.element.style.left=`${b.left-this.element.clientWidth-c/2+3}px`,l="",Array.from(this.element.children).reverse().forEach((v,k)=>{k!==0&&(v.firstElementChild.style.height="14px"),l+=v.outerHTML}),this.element.innerHTML=l):this.element.querySelectorAll("svg").forEach(v=>{v.style.height=""})}}class YE{constructor(e){this.SAMPLE_RATE=44100,this.isRecording=!1,this.readyFlag=!1,this.leftChannel=[],this.rightChannel=[],this.recordingLength=0;let n;if(typeof AudioContext<"u")n=new AudioContext;else if(webkitAudioContext)n=new webkitAudioContext;else return;this.DEFAULT_SAMPLE_RATE=n.sampleRate;const a=n.createGain();n.createMediaStreamSource(e).connect(a),this.recorder=n.createScriptProcessor(2048,2,1),this.recorder.onaudioprocess=null,a.connect(this.recorder),this.recorder.connect(n.destination),this.readyFlag=!0}cloneChannelData(e,n){this.leftChannel.push(new Float32Array(e)),this.rightChannel.push(new Float32Array(n)),this.recordingLength+=2048}startRecordingNewWavFile(){this.readyFlag&&(this.isRecording=!0,this.leftChannel.length=this.rightChannel.length=0,this.recordingLength=0)}stopRecording(){this.isRecording=!1}buildWavFileBlob(){const e=this.mergeBuffers(this.leftChannel),n=this.mergeBuffers(this.rightChannel);let a=new Float32Array(e.length);for(let u=0;u<e.length;++u)a[u]=.5*(e[u]+n[u]);this.DEFAULT_SAMPLE_RATE>this.SAMPLE_RATE&&(a=this.downSampleBuffer(a,this.SAMPLE_RATE));const i=44+a.length*2,s=new ArrayBuffer(i),o=new DataView(s);this.writeUTFBytes(o,0,"RIFF"),o.setUint32(4,i,!0),this.writeUTFBytes(o,8,"WAVE"),this.writeUTFBytes(o,12,"fmt "),o.setUint32(16,16,!0),o.setUint16(20,1,!0),o.setUint16(22,1,!0),o.setUint32(24,this.SAMPLE_RATE,!0),o.setUint32(28,this.SAMPLE_RATE*2,!0),o.setUint16(32,2,!0),o.setUint16(34,16,!0);const l=a.length*2;this.writeUTFBytes(o,36,"data"),o.setUint32(40,l,!0);const r=a.length;let c=44;const d=1;for(let u=0;u<r;u++)o.setInt16(c,a[u]*(32767*d),!0),c+=2;return new Blob([o],{type:"audio/wav"})}downSampleBuffer(e,n){if(n===this.DEFAULT_SAMPLE_RATE||n>this.DEFAULT_SAMPLE_RATE)return e;const a=this.DEFAULT_SAMPLE_RATE/n,i=Math.round(e.length/a),s=new Float32Array(i);let o=0,l=0;for(;o<s.length;){const r=Math.round((o+1)*a);let c=0,d=0;for(let u=l;u<r&&u<e.length;u++)c+=e[u],d++;s[o]=c/d,o++,l=r}return s}mergeBuffers(e){const n=new Float32Array(this.recordingLength);let a=0;const i=e.length;for(let s=0;s<i;++s){const o=e[s];n.set(o,a),a+=o.length}return n}writeUTFBytes(e,n,a){const i=a.length;for(let s=0;s<i;s++)e.setUint8(n+s,a.charCodeAt(s))}}const Nu=(t,e)=>{if(hn(),!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="titleMenu"){window.siyuan.menus.menu.remove();return}w("/api/block/getDocInfo",{id:t.block.rootID},n=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","titleMenu"),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:Li(t.block.rootID)}).element),t.disabled||(window.siyuan.menus.menu.append(Xd([t.path])),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",label:window.siyuan.languages.delete,click:()=>{Xg(t.notebookId,t.path)}}).element)),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({icon:"iconAlignCenter",label:window.siyuan.languages.outline,accelerator:window.siyuan.config.keymap.editor.general.outline.custom,click:()=>{Rg(t)}}).element),window.siyuan.menus.menu.append(new S({icon:"iconLink",label:window.siyuan.languages.backlinks,accelerator:window.siyuan.config.keymap.editor.general.backlinks.custom,click:()=>{rr({app:t.app,blockId:t.block.id,rootId:t.block.rootID,useBlockId:t.block.showAll,title:t.title?t.title.editElement.textContent||"Untitled":null})}}).element),window.siyuan.menus.menu.append(new S({icon:"iconGraph",label:window.siyuan.languages.graphView,accelerator:window.siyuan.config.keymap.editor.general.graphView.custom,click:()=>{cr({app:t.app,blockId:t.block.id,rootId:t.block.rootID,useBlockId:t.block.showAll,title:t.title?t.title.editElement.textContent||"Untitled":null})}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.attr,icon:"iconAttr",accelerator:window.siyuan.config.keymap.editor.general.attr.custom+"/"+K("\u21E7Click"),click(){Un(n.data.ial,"bookmark",t)}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.wechatReminder,icon:"iconMp",click(){b_(t)}}).element);const a=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.editor.general.spaceRepetition.custom,click:()=>{w("/api/riff/getTreeRiffDueCards",{rootID:t.block.rootID},i=>{Ci(t.app,i.data,"doc",t.block.rootID,i.data.name)})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{w("/api/filetree/getHPathByID",{id:t.block.rootID},i=>{_s(t.app,t.block.rootID,Le().join(ea(t.notebookId),i.data),"Tree")})}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.quickMakeCard,accelerator:window.siyuan.config.keymap.editor.general.quickMakeCard.custom,click:()=>{let i=t.title?.element;i||(i=document.createElement("div"),i.setAttribute("data-node-id",t.block.rootID),i.setAttribute(p.Constants.CUSTOM_RIFF_DECKS,n.data.ial[p.Constants.CUSTOM_RIFF_DECKS])),Do(t,[i])}}];window.siyuan.config.flashcard.deck&&a.push({iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.addToDeck,click:()=>{Io(t.app,[t.block.rootID])}}),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:a}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.search,icon:"iconSearch",accelerator:window.siyuan.config.keymap.general.search.custom,async click(){const i=ft(t.path,!1,!0);_n({app:t.app,hotkey:p.Constants.DIALOG_SEARCH,notebookId:t.notebookId,searchPath:i})}}).element),t.disabled||rb(t.block.rootID),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.openByNewWindow,icon:"iconOpenWindow",click(){to(t.block.rootID)}}).element),window.siyuan.menus.menu.append(new S({icon:"iconFolder",label:window.siyuan.languages.showInFolder,click:()=>{Qn(kt.join(window.siyuan.config.system.dataDir,t.notebookId,t.path))}}).element),t.disabled||window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.fileHistory,icon:"iconHistory",click(){eh({app:t.app,id:t.block.rootID,notebookId:t.notebookId,pathString:n.data.name})}}).element),nu(t.notebookId,t.path),window.siyuan.menus.menu.append(Kg(t.block.showAll?t.block.id:t.block.rootID)),t?.app?.plugins&&en({plugins:t.app.plugins,type:"click-editortitleicon",detail:{protyle:t,data:n.data},separatorPosition:"top"}),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,type:"readonly",label:`${window.siyuan.languages.modifiedAt} ${Q(n.data.ial.updated).format("YYYY-MM-DD HH:mm:ss")}<br>
${window.siyuan.languages.createdAt} ${Q(n.data.ial.id.substr(0,14)).format("YYYY-MM-DD HH:mm:ss")}`}).element),window.siyuan.menus.menu.popup(e)})};class GE{constructor(e){const n=document.createElement("div");n.className="protyle-breadcrumb",n.innerHTML=`${(0,I.tq)()?`<button class="protyle-breadcrumb__icon" data-type="mobile-menu">${window.siyuan.languages.breadcrumb}</button>`:'<div class="protyle-breadcrumb__bar"></div>'}
<span class="protyle-breadcrumb__space"></span>
<button class="protyle-breadcrumb__icon fn__none" data-type="exit-focus">${window.siyuan.languages.exitFocus}</button>
<button class="block__icon block__icon--show fn__flex-center ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.lockEdit}" data-type="readonly"><svg><use xlink:href="#iconUnlock"></use></svg></button>
<span class="fn__space${window.siyuan.config.readonly?" fn__none":""}"></span>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" data-type="doc" aria-label="${$e()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}"><svg><use xlink:href="#iconFile"></use></svg></button>
<span class="fn__space"></span>
<button class="block__icon block__icon--show fn__flex-center ariaLabel" data-type="more" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></button>
<button class="block__icon block__icon--show fn__flex-center fn__none ariaLabel" style="margin-left: 8px" data-type="context" aria-label="${window.siyuan.languages.context}"><svg><use xlink:href="#iconAlignCenter"></use></svg></button>`,this.element=n.firstElementChild,n.addEventListener("click",a=>{e.model&&Ze(e.model.element.parentElement.parentElement);let i=a.target;for(;i&&!i.isEqualNode(n);){const s=i.getAttribute("data-node-id"),o=i.getAttribute("data-type");if(s){e.options.render.breadcrumbDocName&&window.siyuan.ctrlIsPressed?de({app:e.app,id:s,action:s===e.block.rootID?[p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]}):Vt({protyle:e,id:s}),a.preventDefault();break}else if(o==="mobile-menu"){this.genMobileMenu(e),a.preventDefault(),a.stopPropagation();break}else if(o==="doc"){if(window.siyuan.shiftIsPressed)w("/api/block/getDocInfo",{id:e.block.rootID},l=>{Un(l.data.ial,"bookmark",e)});else{const l=i.getBoundingClientRect();Nu(e,{x:l.right,y:l.bottom,isLeft:!0})}a.stopPropagation(),a.preventDefault();break}else if(o==="more"){const l=i.getBoundingClientRect();this.showMenu(e,{x:l.right,y:l.bottom,isLeft:!0}),a.stopPropagation(),a.preventDefault();break}else if(o==="readonly"){if(!window.siyuan.config.readonly){const l=i.querySelector("use").getAttribute("xlink:href")!=="#iconUnlock";window.siyuan.config.editor.readOnly?l?Kd(e):ia(e):w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_READONLY]:l?"false":"true"}})}a.stopPropagation(),a.preventDefault();break}else if(o==="exit-focus"){Vt({protyle:e,id:e.block.rootID,focusId:e.block.id}),a.stopPropagation(),a.preventDefault();break}else if(o==="context"){a.stopPropagation(),a.preventDefault(),i.classList.contains("block__icon--active")?(Vt({protyle:e,id:e.options.blockId}),i.classList.remove("block__icon--active")):(w("/api/filetree/getDoc",{id:e.options.blockId,mode:3,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{st({data:l,protyle:e,action:[p.Constants.CB_GET_HL]})}),i.classList.add("block__icon--active"));break}i=i.parentElement}}),n.addEventListener("mouseleave",()=>{e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(a=>{a.classList.remove("protyle-wysiwyg--hl")})}),this.element.addEventListener("mouseover",a=>{if(!e.selectElement.classList.contains("fn__none"))return;const i=a.target,s=q(i,"data-node-id",null);if(s){e.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--hl").forEach(l=>{l.classList.remove("protyle-wysiwyg--hl")});const o=e.wysiwyg.element.querySelector(`[data-node-id="${s.getAttribute("data-node-id")}"]`);o&&o.classList.add("protyle-wysiwyg--hl")}}),this.element.addEventListener("mousewheel",a=>{this.element.scrollLeft=this.element.scrollLeft+a.deltaY},{passive:!0})}startRecord(e){this.messageId=M(`<div class="fn__flex fn__flex-wrap">
<span class="fn__flex-center">${window.siyuan.languages.recording}</span><span class="fn__space"></span>
<button class="b3-button b3-button--white">${window.siyuan.languages.endRecord}</button></div>`,-1),document.querySelector(`#message [data-id="${this.messageId}"] button`).addEventListener("click",()=>{this.mediaRecorder.stopRecording(),W(this.messageId);const n=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});ka(e,[n])}),this.mediaRecorder.startRecordingNewWavFile()}genMobileMenu(e){const n=new At("breadcrumb-mobile-path");let a;if(getSelection().rangeCount>0){const s=getSelection().getRangeAt(0);!e.wysiwyg.element.isEqualNode(s.startContainer)&&!e.wysiwyg.element.contains(s.startContainer)?a=Kt(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:a=x(s.startContainer)}a||(a=Kt(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const i=a.getAttribute("data-node-id");w("/api/block/getBlockBreadcrumb",{id:i,excludeTypes:[]},s=>{s.data.forEach(o=>{let l=!1;(!e.block.showAll&&o.id===e.block.parentID||e.block.showAll&&o.id===e.block.id)&&(l=!0),n.addItem({current:l,icon:bn(o.type,o.subType),label:o.name,click(){Vt({protyle:e,id:o.id,focusId:i})}})}),n.fullscreen()})}toggleExit(e){const n=this.element.parentElement.querySelector('[data-type="exit-focus"]');e?n.classList.add("fn__none"):n.classList.remove("fn__none")}showMenu(e,n){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="breadcrumbMore"){window.siyuan.menus.menu.remove();return}let a;const i=x(re(e.element).startContainer);i&&(a=i.getAttribute("data-node-id")),w("/api/block/getTreeStat",{id:a||(e.block.showAll?e.block.id:e.block.rootID)},s=>{if(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","breadcrumbMore"),!e.contentElement.classList.contains("fn__none")&&!e.disabled){let o="";o='<input class="b3-form__upload" type="file" multiple="multiple"',e.options.upload.accept?o+=` accept="${e.options.upload.accept}">`:o+=">";const l=new S({icon:"iconDownload",label:`${window.siyuan.languages.insertAsset}${o}`}).element;l.querySelector("input").addEventListener("change",r=>{r.target.files.length!==0&&(ka(e,r.target.files,r.target),window.siyuan.menus.menu.remove())}),window.siyuan.menus.menu.append(l),at()||window.siyuan.menus.menu.append(new S({current:this.mediaRecorder&&this.mediaRecorder.isRecording,icon:"iconRecord",label:this.mediaRecorder?.isRecording?window.siyuan.languages.endRecord:window.siyuan.languages.startRecord,click:async()=>{if(window.siyuan.config.system.os==="darwin"){const r=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"getMicrophone"});if(["denied","restricted","unknown"].includes(r)){M(window.siyuan.languages.microphoneDenied);return}else if(r==="not-determined"&&!await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"askMicrophone"})){M(window.siyuan.languages.microphoneNotAccess);return}}if(!this.mediaRecorder){navigator.mediaDevices.getUserMedia({audio:!0}).then(r=>{this.mediaRecorder=new YE(r),this.mediaRecorder.recorder.onaudioprocess=c=>{if(!this.mediaRecorder.isRecording)return;const d=c.inputBuffer.getChannelData(0),u=c.inputBuffer.getChannelData(1);this.mediaRecorder.cloneChannelData(d,u)},this.startRecord(e)}).catch(()=>{M(window.siyuan.languages["record-tip"])});return}if(this.mediaRecorder.isRecording){this.mediaRecorder.stopRecording(),W(this.messageId);const r=new File([this.mediaRecorder.buildWavFileBlob()],`record${new Date().getTime()}.wav`,{type:"video/webm"});ka(e,[r])}else W(this.messageId),this.startRecord(e)}}).element)}if(e.disabled||(window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.netImg2LocalAsset,icon:"iconImgDown",accelerator:window.siyuan.config.keymap.editor.general.netImg2LocalAsset.custom,click(){ar(e,"Img")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.netAssets2LocalAssets,icon:"iconTransform",accelerator:window.siyuan.config.keymap.editor.general.netAssets2LocalAssets.custom,click(){ar(e,"Assets")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.uploadAssets2CDN,icon:"iconCloudSucc",click(){va()||Ne("\u{1F4E6} "+window.siyuan.languages.uploadAssets2CDN,window.siyuan.languages.uploadAssets2CDNConfirmTip,()=>{w("/api/asset/uploadCloud",{id:e.block.parentID})})}}).element),window.siyuan.user&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.share2Liandi,icon:"iconLiandi",click(){Ne("\u{1F680} "+window.siyuan.languages.share2Liandi,window.siyuan.languages.share2LiandiConfirmTip,()=>{w("/api/export/export2Liandi",{id:e.block.parentID})})}}).element)),e.scroll?.element.classList.contains("fn__none")||window.siyuan.menus.menu.append(new S({current:e.scroll.keepLazyLoad,label:window.siyuan.languages.keepLazyLoad,click:()=>{e.scroll.keepLazyLoad=!e.scroll.keepLazyLoad}}).element),window.siyuan.menus.menu.element.lastElementChild.childElementCount>0&&window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({icon:"iconRefresh",accelerator:window.siyuan.config.keymap.editor.general.refresh.custom,label:window.siyuan.languages.refresh,click:()=>{na(e,!(0,I.tq)())}}).element),e.disabled||window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.optimizeTypography,accelerator:window.siyuan.config.keymap.editor.general.optimizeTypography.custom,icon:"iconFormat",click:()=>{X(["toolbar"],e),w("/api/format/autoSpace",{id:e.block.rootID})}}).element),window.siyuan.menus.menu.append(new S({icon:e.element.className.includes("fullscreen")?"iconFullscreenExit":"iconFullscreen",accelerator:window.siyuan.config.keymap.editor.general.fullscreen.custom,label:window.siyuan.languages.fullscreen,click:()=>{_o(e.element),qt(e)}}).element),window.siyuan.menus.menu.append(new S({icon:"iconEdit",label:window.siyuan.languages["edit-mode"],type:"submenu",submenu:[{current:!e.contentElement.classList.contains("fn__none"),label:window.siyuan.languages.wysiwyg,accelerator:window.siyuan.config.keymap.editor.general.wysiwyg.custom,click:()=>{Di(e,"wysiwyg"),e.scroll.lastScrollTop=0,w("/api/filetree/getDoc",{id:e.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},o=>{st({data:o,protyle:e})}),Zn()}},{current:!e.preview.element.classList.contains("fn__none"),icon:"iconPreview",label:window.siyuan.languages.preview,accelerator:window.siyuan.config.keymap.editor.general.preview.custom,click:()=>{Di(e,"preview"),window.siyuan.menus.menu.remove(),Zn()}}]}).element),!window.siyuan.config.editor.readOnly&&!window.siyuan.config.readonly){const o=e.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_READONLY);window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.editReadonly,icon:"iconLock",type:"submenu",submenu:[{iconHTML:"",current:o==="true",label:window.siyuan.languages.enable,click(){w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_READONLY]:"true"}})}},{iconHTML:"",current:!o||o==="false",label:window.siyuan.languages.disable,click(){w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_READONLY]:"false"}})}}]}).element)}if(!e.disabled){const o=e.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_FULLWIDTH);window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.fullWidth,icon:"iconDock",type:"submenu",submenu:[{iconHTML:"",current:o==="true",label:window.siyuan.languages.enable,click(){w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_FULLWIDTH]:"true"}})}},{iconHTML:"",current:o==="false",label:window.siyuan.languages.disable,click(){w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_FULLWIDTH]:"false"}})}},{iconHTML:"",current:!o,label:window.siyuan.languages.default,click(){w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{[p.Constants.CUSTOM_SY_FULLWIDTH]:""}})}}]}).element)}e?.app?.plugins&&en({plugins:e.app.plugins,type:"open-menu-breadcrumbmore",detail:{protyle:e,data:s.data},separatorPosition:"top"}),window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({iconHTML:p.Constants.ZWSP,type:"readonly",label:`<div class="fn__flex">${window.siyuan.languages.runeCount}<span class="fn__space fn__flex-1"></span>${s.data.runeCount}</div>
<div class="fn__flex">${window.siyuan.languages.wordCount}<span class="fn__space fn__flex-1"></span>${s.data.wordCount}</div>
<div class="fn__flex">${window.siyuan.languages.linkCount}<span class="fn__space fn__flex-1"></span>${s.data.linkCount}</div>
<div class="fn__flex">${window.siyuan.languages.imgCount}<span class="fn__space fn__flex-1"></span>${s.data.imageCount}</div>
<div class="fn__flex">${window.siyuan.languages.refCount}<span class="fn__space fn__flex-1"></span>${s.data.refCount}</div>`}).element),window.siyuan.menus.menu.popup(n)})}render(e,n=!1){if((0,I.tq)())return;let a,i;getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0),!e.wysiwyg.element.isEqualNode(a.startContainer)&&!e.wysiwyg.element.contains(a.startContainer)?e.element.id==="searchPreview"?i=x(e.wysiwyg.element.querySelector('[data-type="search-mark"]')):i=Kt(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild:i=x(a.startContainer)),i||(i=Kt(e.wysiwyg.element.firstElementChild)||e.wysiwyg.element.firstElementChild);const s=i.getAttribute("data-node-id");if(s===this.id&&!n){e.breadcrumb.element.querySelectorAll(".protyle-breadcrumb__item--active").forEach(r=>{r.classList.remove("protyle-breadcrumb__item--active")});const l=e.breadcrumb.element.querySelector(`[data-node-id="${e.block.showAll?e.block.id:e.block.parentID}"]`);l&&l.classList.add("protyle-breadcrumb__item--active");return}this.id=s;const o=[];this.element.parentElement?.parentElement&&this.element.parentElement.parentElement.classList.contains("card__block")&&o.push("NodeTextMark-mark"),w("/api/block/getBlockBreadcrumb",{id:s,excludeTypes:o},l=>{let r="";l.data.forEach((u,f)=>{let g=!1;(!e.block.showAll&&u.id===e.block.parentID||e.block.showAll&&u.id===e.block.id)&&(g=!0),f===0&&!e.options.render.breadcrumbDocName?r+=`<span class="protyle-breadcrumb__item${g?" protyle-breadcrumb__item--active":""}" data-node-id="${u.id}"${l.data.length===1?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${u.id}"><use xlink:href="#${bn(u.type,u.subType)}"></use></svg>
</span>`:r+=`<span class="protyle-breadcrumb__item${g?" protyle-breadcrumb__item--active":""}" data-node-id="${u.id}"${l.data.length===1||f===0?' style="max-width:none"':""}>
    <svg class="popover__block" data-id="${u.id}"><use xlink:href="#${bn(u.type,u.subType)}"></use></svg>
    <span class="protyle-breadcrumb__text" title="${u.name}">${u.name}</span>
</span>`,f!==l.data.length-1&&(r+='<svg class="protyle-breadcrumb__arrow"><use xlink:href="#iconRight"></use></svg>')}),this.element.classList.remove("protyle-breadcrumb__bar--nowrap"),this.element.innerHTML=r;const c=Array.from(this.element.querySelectorAll(".protyle-breadcrumb__text"));if(c.length===0)return;let d=!1;for(;this.element.scrollHeight>30&&!d&&c.length>1;)c.find((u,f)=>{if(f>0){if(!u.classList.contains("protyle-breadcrumb__text--ellipsis"))return u.classList.add("protyle-breadcrumb__text--ellipsis"),!0;f===c.length-1&&u.classList.contains("protyle-breadcrumb__text--ellipsis")&&(d=!0)}});this.element.classList.add("protyle-breadcrumb__bar--nowrap"),this.element.lastElementChild&&(this.element.scrollLeft=this.element.lastElementChild.offsetLeft-this.element.clientWidth+14)})}hide(){(0,I.tq)()||(this.element.classList.add("protyle-breadcrumb__bar--hide"),window.siyuan.hideBreadcrumb=!0)}}const cb=t=>t.replace(/\u00a0/g," ");class jE{constructor(e){this.element=document.createElement("div"),this.element.className="protyle-title",window.siyuan.config.editor.displayBookmarkIcon&&this.element.classList.add("protyle-wysiwyg--attr"),this.element.innerHTML=`<span aria-label="${$e()?window.siyuan.languages.gutterTip2:window.siyuan.languages.gutterTip2.replace("\u21E7","Shift+")}" data-position="right" class="protyle-title__icon ariaLabel"><svg><use xlink:href="#iconFile"></use></svg></span>
<div contenteditable="true" spellcheck="${window.siyuan.config.editor.spellcheck}" class="protyle-title__input" data-tip="${window.siyuan.languages._kernel[16]}"> </div><div class="protyle-attr"></div>`,this.editElement=this.element.querySelector(".protyle-title__input"),this.editElement.addEventListener("paste",a=>{a.stopPropagation(),a.preventDefault(),document.execCommand("insertText",!1,mn(a.clipboardData.getData("text/plain"))),this.rename(e)}),this.editElement.addEventListener("click",()=>{e.model&&(Ze(e.model.element.parentElement.parentElement),Ta({protyle:e,focus:!1,pushBackStack:!1,reload:!1,resize:!1})),e.toolbar?.element.classList.add("fn__none")}),this.editElement.addEventListener("input",a=>{a.isComposing||this.rename(e)}),this.editElement.addEventListener("compositionend",()=>{this.rename(e)}),this.editElement.addEventListener("drop",a=>{a.stopPropagation(),a.preventDefault()}),this.editElement.addEventListener("keydown",a=>{if(!a.isComposing){if(fg(e,a))return!0;if($(window.siyuan.config.keymap.general.enterBack.custom,a)){const i=e.path.split("/");i.length>2&&de({app:e.app,id:i[i.length-2],action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]}),a.preventDefault(),a.stopPropagation();return}if(!Ya(a))if(a.key==="ArrowDown"){const i=Kt(e.wysiwyg.element.firstElementChild);i&&le(i,e.wysiwyg.element),a.preventDefault(),a.stopPropagation()}else if(a.key==="Enter"){const i=Lute.NewNodeID(),s=Cn(!1,!0,i);e.wysiwyg.element.insertAdjacentElement("afterbegin",s),fe(s,e.toolbar.range||re(s)),F(e,[{action:"insert",data:s.outerHTML,id:i,parentID:e.block.parentID}],[{action:"delete",id:i}]),a.preventDefault(),a.stopPropagation()}else $(window.siyuan.config.keymap.editor.general.attr.custom,a)?(w("/api/block/getDocInfo",{id:e.block.rootID},i=>{Un(i.data.ial,"bookmark",e)}),a.preventDefault(),a.stopPropagation()):$("\u2318A",a)?(re(this.editElement).selectNodeContents(this.editElement),a.preventDefault(),a.stopPropagation()):$(window.siyuan.config.keymap.editor.general.copyID.custom,a)?(G(e.block.rootID),a.preventDefault(),a.stopPropagation()):$(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,a)?(G(`{{select * from blocks where id='${e.block.rootID}'}}`),a.preventDefault(),a.stopPropagation()):$(window.siyuan.config.keymap.editor.general.copyProtocol.custom,a)&&(G(`siyuan://blocks/${e.block.rootID}`),a.preventDefault(),a.stopPropagation())}});const n=this.element.querySelector(".protyle-title__icon");n.addEventListener("click",()=>{if(window.siyuan.shiftIsPressed)w("/api/block/getDocInfo",{id:e.block.rootID},a=>{Un(a.data.ial,"bookmark",e)});else{const a=n.getBoundingClientRect();Nu(e,{x:a.left,y:a.bottom})}}),this.element.addEventListener("contextmenu",a=>{if(a.shiftKey)return;if(getSelection().rangeCount===0){Nu(e,{x:a.clientX,y:a.clientY});return}e.toolbar?.element.classList.add("fn__none"),window.siyuan.menus.menu.remove();const i=re(this.editElement);i.toString()!==""&&(window.siyuan.menus.menu.append(new S({icon:"iconCopy",accelerator:"\u2318C",label:window.siyuan.languages.copy,click:()=>{Z(re(this.editElement)),document.execCommand("copy")}}).element),window.siyuan.menus.menu.append(new S({icon:"iconCut",accelerator:"\u2318X",label:window.siyuan.languages.cut,click:()=>{Z(re(this.editElement)),document.execCommand("cut"),setTimeout(()=>{this.rename(e)},p.Constants.TIMEOUT_INPUT)}}).element),window.siyuan.menus.menu.append(new S({icon:"iconTrashcan",accelerator:"\u232B",label:window.siyuan.languages.delete,click:()=>{const s=re(this.editElement);s.extractContents(),Z(s),setTimeout(()=>{this.rename(e)},p.Constants.TIMEOUT_INPUT)}}).element)),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.paste,accelerator:"\u2318V",click:async()=>{Z(re(this.editElement));const s=await ce();document.execCommand("insertText",!1,mn(s)),this.rename(e)}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.selectAll,accelerator:"\u2318A",click:()=>{i.selectNodeContents(this.editElement),Z(i)}}).element),window.siyuan.menus.menu.popup({x:a.clientX,y:a.clientY})}),this.element.querySelector(".protyle-attr").addEventListener("click",a=>{w("/api/block/getDocInfo",{id:e.block.rootID},i=>{lb(a,e,i.data.ial)})})}rename(e){if(clearTimeout(this.timeout),!Fl(this.editElement.textContent,this.editElement)){const n=yt(this.editElement);return this.setTitle(this.editElement.textContent.substring(0,p.Constants.SIZE_TITLE)),Gn(this.editElement,n.start,n.end),!1}hn(),this.timeout=window.setTimeout(()=>{const n=mn(this.editElement.textContent);w("/api/filetree/renameDoc",{notebook:e.notebookId,path:e.path,title:n}),this.setTitle(n),Bo(n)},p.Constants.TIMEOUT_INPUT)}setTitle(e){cb(e)!==cb(this.editElement.textContent)&&(this.editElement.textContent=e==="Untitled"?"":e)}render(e,n){if(this.editElement.getAttribute("data-render")==="true")return!1;this.element.setAttribute("data-node-id",e.block.rootID),n.data.ial[p.Constants.CUSTOM_RIFF_DECKS]&&this.element.setAttribute(p.Constants.CUSTOM_RIFF_DECKS,n.data.ial[p.Constants.CUSTOM_RIFF_DECKS]),e.background?.render(n.data.ial,e.block.rootID),e.wysiwyg.renderCustom(n.data.ial),this.editElement.setAttribute("data-render","true"),this.setTitle(n.data.ial.title);let a="";if(n.data.ial.bookmark&&(a+=`<div class="protyle-attr--bookmark">${Lute.EscapeHTMLStr(n.data.ial.bookmark)}</div>`),n.data.ial.name&&(a+=`<div class="protyle-attr--name"><svg><use xlink:href="#iconN"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.name)}</div>`),n.data.ial.alias&&(a+=`<div class="protyle-attr--alias"><svg><use xlink:href="#iconA"></use></svg>${Lute.EscapeHTMLStr(n.data.ial.alias)}</div>`),n.data.ial.memo&&(a+=`<div class="protyle-attr--memo b3-tooltips b3-tooltips__sw" aria-label="${Lute.EscapeHTMLStr(n.data.ial.memo)}"><svg><use xlink:href="#iconM"></use></svg></div>`),n.data.ial["custom-avs"]&&(a+='<div class="protyle-attr--av"><svg><use xlink:href="#iconDatabase"></use></svg></div>'),this.element.querySelector(".protyle-attr").innerHTML=a,n.data.refCount!==0&&this.element.querySelector(".protyle-attr").insertAdjacentHTML("beforeend",`<div class="protyle-attr--refcount popover__block" data-defids='${JSON.stringify([e.block.rootID])}' data-id='${JSON.stringify(n.data.refIDs)}'>${n.data.refCount}</div>`),new Date().getTime()-Q(n.data.id.split("-")[0]).toDate().getTime()<2e3){const i=this.editElement.ownerDocument.createRange();i.selectNodeContents(this.editElement),Z(i)}}}const Br=["background:radial-gradient(black 3px, transparent 4px),radial-gradient(black 3px, transparent 4px),linear-gradient(#fff 4px, transparent 0),linear-gradient(45deg, transparent 74px, transparent 75px, #a4a4a4 75px, #a4a4a4 76px, transparent 77px, transparent 109px),linear-gradient(-45deg, transparent 75px, transparent 76px, #a4a4a4 76px, #a4a4a4 77px, transparent 78px, transparent 109px),#fff;background-size: 109px 109px, 109px 109px,100% 6px, 109px 109px, 109px 109px;background-position: 54px 55px, 0px 0px, 0px 0px, 0px 0px, 0px 0px;","background: linear-gradient(45deg, #dca 12%, transparent 0, transparent 88%, #dca 0),linear-gradient(135deg, transparent 37%, #a85 0, #a85 63%, transparent 0),linear-gradient(45deg, transparent 37%, #dca 0, #dca 63%, transparent 0) #753;background-size: 25px 25px;","background: linear-gradient(315deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(45deg, transparent 75%, #d45d55 0)-10px 0, linear-gradient(135deg, #a7332b 50%, transparent 0) 0 0, linear-gradient(45deg, #6a201b 50%, #561a16 0) 0 0 #561a16;background-size: 20px 20px;","background: linear-gradient(#ffffff 50%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 53%, rgba(255,255,255,0) 0) 0 0, radial-gradient(circle closest-side, #FFFFFF 50%, rgba(255,255,255,0) 0) 55px 0 #48B;background-size: 110px 200px;background-repeat: repeat-x;","background:radial-gradient(circle farthest-side at 0% 50%,#fb1 23.5%,rgba(240,166,17,0) 0)21px 30px, radial-gradient(circle farthest-side at 0% 50%,#B71 24%,rgba(240,166,17,0) 0)19px 30px, linear-gradient(#fb1 14%,rgba(240,166,17,0) 0, rgba(240,166,17,0) 85%,#fb1 0)0 0, linear-gradient(150deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(30deg,#fb1 24%,#B71 0,#B71 26%,rgba(240,166,17,0) 0,rgba(240,166,17,0) 74%,#B71 0,#B71 76%,#fb1 0)0 0, linear-gradient(90deg,#B71 2%,#fb1 0,#fb1 98%,#B71 0%)0 0 #fb1;background-size: 40px 60px;","background-color: gray;background-image: linear-gradient(transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: gray;background-image: linear-gradient(90deg, transparent 50%, rgba(255,255,255,.5) 50%);background-size: 50px 50px;","background-color: #026873;background-image: linear-gradient(90deg, rgba(255,255,255,.07) 50%, transparent 50%),linear-gradient(90deg, rgba(255,255,255,.13) 50%, transparent 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.17) 50%),linear-gradient(90deg, transparent 50%, rgba(255,255,255,.19) 50%);background-size: 13px, 29px, 37px, 53px;","background-color: gray;background-image: repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.5) 35px, rgba(255,255,255,.5) 70px);","background-color:white;background-image: linear-gradient(90deg, rgba(200,0,0,.5) 50%, transparent 50%),linear-gradient(rgba(200,0,0,.5) 50%, transparent 50%);background-size:50px 50px;","background-color:#269;background-image: linear-gradient(white 2px, transparent 2px),linear-gradient(90deg, white 2px, transparent 2px),linear-gradient(rgba(255,255,255,.3) 1px, transparent 1px),linear-gradient(90deg, rgba(255,255,255,.3) 1px, transparent 1px);background-size: 100px 100px, 100px 100px, 20px 20px, 20px 20px;background-position:-2px -2px, -2px -2px, -1px -1px, -1px -1px;","background-color: #fff;background-image:linear-gradient(90deg, transparent 79px, #abced4 79px, #abced4 81px, transparent 81px),linear-gradient(#eee .1em, transparent .1em);background-size: 100% 1.2em;","background-color: hsl(34, 53%, 82%);background-image: repeating-linear-gradient(45deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 120px, hsla(197, 62%, 11%, 0.5) 120px, hsla(197, 62%, 11%, 0.5) 140px),repeating-linear-gradient(135deg, transparent 5px, hsla(197, 62%, 11%, 0.5) 5px, hsla(197, 62%, 11%, 0.5) 10px, hsla(5, 53%, 63%, 0) 10px, hsla(5, 53%, 63%, 0) 35px, hsla(5, 53%, 63%, 0.5) 35px, hsla(5, 53%, 63%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 40px, hsla(197, 62%, 11%, 0.5) 50px, hsla(197, 62%, 11%, 0) 50px, hsla(197, 62%, 11%, 0) 60px, hsla(5, 53%, 63%, 0.5) 60px, hsla(5, 53%, 63%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 70px, hsla(35, 91%, 65%, 0.5) 80px, hsla(35, 91%, 65%, 0) 80px, hsla(35, 91%, 65%, 0) 90px, hsla(5, 53%, 63%, 0.5) 90px, hsla(5, 53%, 63%, 0.5) 110px, hsla(5, 53%, 63%, 0) 110px, hsla(5, 53%, 63%, 0) 140px, hsla(197, 62%, 11%, 0.5) 140px, hsla(197, 62%, 11%, 0.5) 160px);","background-color: hsl(2, 57%, 40%);background-image: repeating-linear-gradient(transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(270deg, transparent, transparent 50px, rgba(0,0,0,.4) 50px, rgba(0,0,0,.4) 53px, transparent 53px, transparent 63px, rgba(0,0,0,.4) 63px, rgba(0,0,0,.4) 66px, transparent 66px, transparent 116px, rgba(0,0,0,.5) 116px, rgba(0,0,0,.5) 166px, rgba(255,255,255,.2) 166px, rgba(255,255,255,.2) 169px, rgba(0,0,0,.5) 169px, rgba(0,0,0,.5) 179px, rgba(255,255,255,.2) 179px, rgba(255,255,255,.2) 182px, rgba(0,0,0,.5) 182px, rgba(0,0,0,.5) 232px, transparent 232px),repeating-linear-gradient(125deg, transparent, transparent 2px, rgba(0,0,0,.2) 2px, rgba(0,0,0,.2) 3px, transparent 3px, transparent 5px, rgba(0,0,0,.2) 5px);","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;","background-color: #eee;background-image: linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black),linear-gradient(45deg, black 25%, transparent 25%, transparent 75%, black 75%, black);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background:linear-gradient(-45deg, white 25%, transparent 25%, transparent 75%, black 75%, black) 0 0, linear-gradient(-45deg, black 25%, transparent 25%, transparent 75%, white 75%, white) 1em 1em, linear-gradient(45deg, black 17%, transparent 17%, transparent 25%, black 25%, black 36%, transparent 36%, transparent 64%, black 64%, black 75%, transparent 75%, transparent 83%, black 83%) 1em 1em;background-color: white;background-size: 2em 2em;","background-color:#001;background-image: radial-gradient(white 15%, transparent 16%),radial-gradient(white 15%, transparent 16%);background-size: 60px 60px;background-position: 0 0, 30px 30px;","background-color:#556;background-image: linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(30deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(150deg, #445 12%, transparent 12.5%, transparent 87%, #445 87.5%, #445),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a),linear-gradient(60deg, #99a 25%, transparent 25.5%, transparent 75%, #99a 75%, #99a);background-size:80px 140px;background-position: 0 0, 0 0, 40px 70px, 40px 70px, 0 0, 40px 70px;","background-color:silver;background-image:radial-gradient(circle at 100% 150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 0    150%, silver 24%, white 24%, white 28%, silver 28%, silver 36%, white 36%, white 40%, transparent 40%, transparent),radial-gradient(circle at 50%  100%, white 10%, silver 10%, silver 23%, white 23%, white 30%, silver 30%, silver 43%, white 43%, white 50%, silver 50%, silver 63%, white 63%, white 71%, transparent 71%, transparent),radial-gradient(circle at 100% 50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent),radial-gradient(circle at 0    50%, white 5%, silver 5%, silver 15%, white 15%, white 20%, silver 20%, silver 29%, white 29%, white 34%, silver 34%, silver 44%, white 44%, white 49%, transparent 49%, transparent);background-size: 100px 50px;","background-color: silver;background-image: linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px),linear-gradient(335deg, #b00 23px, transparent 23px),linear-gradient(155deg, #d00 23px, transparent 23px);background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 34px 6px;","background-color:#def;background-image: radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%),radial-gradient(closest-side, transparent 98%, rgba(0,0,0,.3) 99%);background-size:80px 80px;background-position:0 0, 40px 40px;","background-image:radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%),radial-gradient(closest-side, transparent 0%, transparent 75%, #B6CC66 76%, #B6CC66 85%, #EDFFDB 86%, #EDFFDB 94%, #FFFFFF 95%, #FFFFFF 103%, #D9E6A7 104%, #D9E6A7 112%, #798B3C 113%, #798B3C 121%, #FFFFFF 122%, #FFFFFF 130%, #E0EAD7 131%, #E0EAD7 140%);background-size: 110px 110px;background-color: #C8D3A7;background-position: 0 0, 55px 55px;","background:linear-gradient(324deg, #232927 4%,   transparent 4%) -70px 43px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 30px 43px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 30px 43px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -70px 43px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -70px 23px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 30px 23px, linear-gradient(324deg, #232927 4%,   transparent 4%) -20px 93px, linear-gradient( 36deg, #232927 4%,   transparent 4%) 80px 93px, linear-gradient( 72deg, #e3d7bf 8.5%, transparent 8.5%) 80px 93px, linear-gradient(288deg, #e3d7bf 8.5%, transparent 8.5%) -20px 93px, linear-gradient(216deg, #e3d7bf 7.5%, transparent 7.5%) -20px 73px, linear-gradient(144deg, #e3d7bf 7.5%, transparent 7.5%) 80px 73px;background-color: #232927;background-size: 100px 100px;","background:radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 50px 0, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 50px 0, radial-gradient(circle at 50% 59%, #D2CAAB 3%, #364E27 4%, #364E27 11%, rgba(54,78,39,0) 12%, rgba(54,78,39,0)) 0 50px, radial-gradient(circle at 50% 41%, #364E27 3%, #D2CAAB 4%, #D2CAAB 11%, rgba(210,202,171,0) 12%, rgba(210,202,171,0)) 0 50px, radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%),radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%),radial-gradient(circle at 100% 50%, #D2CAAB 16%, rgba(210,202,171,0) 17%) 50px 50px, radial-gradient(circle at 0% 50%, #364E27 16%, rgba(54,78,39,0) 17%) 50px 50px;background-color:#63773F;background-size:100px 100px;","background:radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent),radial-gradient(circle, transparent 20%, slategray 20%, slategray 80%, transparent 80%, transparent) 50px 50px, linear-gradient(#A8B1BB 8px, transparent 8px) 0 -4px, linear-gradient(90deg, #A8B1BB 8px, transparent 8px) -4px 0;background-color: slategray;background-size:100px 100px, 100px 100px, 50px 50px, 50px 50px;","background:radial-gradient(circle at 100% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent),radial-gradient(circle at 0% 50%, transparent 20%, rgba(255,255,255,.3) 21%, rgba(255,255,255,.3) 34%, transparent 35%, transparent) 0 -50px;background-color: slategray;background-size:75px 100px;","background-color: #FF7D9D;background-size: 58px 58px;background-position: 0px 2px, 4px 35px, 29px 31px, 33px 6px, 0px 36px, 4px 2px, 29px 6px, 33px 30px;background-image:linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 23px, transparent 23px),linear-gradient(155deg, #C90032 23px, transparent 23px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px),linear-gradient(335deg, #C90032 10px, transparent 10px),linear-gradient(155deg, #C90032 10px, transparent 10px);","background-color: #6d695c;background-image:repeating-linear-gradient(120deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),repeating-linear-gradient(60deg, rgba(255,255,255,.1), rgba(255,255,255,.1) 1px, transparent 1px, transparent 60px),linear-gradient(60deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1)),linear-gradient(120deg, rgba(0,0,0,.1) 25%, transparent 25%, transparent 75%, rgba(0,0,0,.1) 75%, rgba(0,0,0,.1));background-size: 70px 120px;","background:radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%),radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%),radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%),radial-gradient(circle closest-side at 60% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 43%, #b03 26%, rgba(187,0,51,0) 27%) 50px 50px, radial-gradient(circle closest-side at 40% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 60% 22%, #d35 45%, rgba(221,51,85,0) 46%) 50px 50px, radial-gradient(circle closest-side at 50% 35%, #d35 30%, rgba(221,51,85,0) 31%) 50px 50px;background-color:#b03;background-size:100px 100px;","background:radial-gradient(black 15%, transparent 16%) 0 0, radial-gradient(black 15%, transparent 16%) 8px 8px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 0 1px, radial-gradient(rgba(255,255,255,.1) 15%, transparent 20%) 8px 9px;background-color:#282828;background-size:16px 16px;","background:linear-gradient(27deg, #151515 5px, transparent 5px) 0 5px, linear-gradient(207deg, #151515 5px, transparent 5px) 10px 0px, linear-gradient(27deg, #222 5px, transparent 5px) 0px 10px, linear-gradient(207deg, #222 5px, transparent 5px) 10px 5px, linear-gradient(90deg, #1b1b1b 10px, transparent 10px),linear-gradient(#1d1d1d 25%, #1a1a1a 25%, #1a1a1a 50%, transparent 50%, transparent 75%, #242424 75%, #242424);background-color: #131313;background-size: 20px 20px;","background:radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.15) 30%, rgba(255,255,255,.3) 32%, rgba(255,255,255,0) 33%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.3) 13%, rgba(255,255,255,0) 14%) 0 0, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 17%, rgba(255,255,255,.43) 19%, rgba(255,255,255,0) 20%) 0 110px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) -130px -170px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.2) 11%, rgba(255,255,255,.4) 13%, rgba(255,255,255,0) 14%) 130px 370px, radial-gradient(rgba(255,255,255,0) 0, rgba(255,255,255,.1) 11%, rgba(255,255,255,.2) 13%, rgba(255,255,255,0) 14%) 0 0, linear-gradient(45deg, #343702 0%, #184500 20%, #187546 30%, #006782 40%, #0b1284 50%, #760ea1 60%, #83096e 70%, #840b2a 80%, #b13e12 90%, #e27412 100%);background-size: 470px 470px, 970px 970px, 410px 410px, 610px 610px, 530px 530px, 730px 730px, 100% 100%;background-color: #840b2a;","background-color:white;background-image:radial-gradient(midnightblue 9px, transparent 10px),repeating-radial-gradient(midnightblue 0, midnightblue 4px, transparent 5px, transparent 20px, midnightblue 21px, midnightblue 25px, transparent 26px, transparent 50px);background-size: 30px 30px, 90px 90px;background-position: 0 0;","background-color:black;background-image:radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 40px),radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 30px),radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 40px),radial-gradient(rgba(255,255,255,.4), rgba(255,255,255,.1) 2px, transparent 30px);background-size: 550px 550px, 350px 350px, 250px 250px, 150px 150px;background-position: 0 0, 40px 60px, 130px 270px, 70px 100px;","background:radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 9%, hsla(0, 100%, 20%, 0) 9%) 0 0, radial-gradient(hsl(0, 100%, 27%) 4%, hsl(0, 100%, 18%) 8%, hsla(0, 100%, 20%, 0) 10%) 50px 50px, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 50px 0, radial-gradient(hsla(0, 100%, 30%, 0.8) 20%, hsla(0, 100%, 20%, 0)) 0 50px, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 50px 0, radial-gradient(hsla(0, 100%, 20%, 1) 35%, hsla(0, 100%, 20%, 0) 60%) 100px 50px, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 0 0, radial-gradient(hsla(0, 100%, 15%, 0.7), hsla(0, 100%, 20%, 0)) 50px 50px, linear-gradient(45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0, linear-gradient(-45deg, hsla(0, 100%, 20%, 0) 49%, hsla(0, 100%, 0%, 1) 50%, hsla(0, 100%, 20%, 0) 70%) 0 0;background-color: #300;background-size: 100px 100px;","background:linear-gradient(135deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px),linear-gradient(225deg, #708090 21px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px)0 64px;background-color:#708090;background-size: 64px 128px;","background:linear-gradient(135deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(225deg, #ECEDDC 25%, transparent 25%) -50px 0, linear-gradient(315deg, #ECEDDC 25%, transparent 25%),linear-gradient(45deg, #ECEDDC 25%, transparent 25%);background-size: 100px 100px;background-color: #EC173A;","background:linear-gradient(45deg, #92baac 45px, transparent 45px)64px 64px, linear-gradient(45deg, #92baac 45px, transparent 45px,transparent 91px, #e1ebbd 91px, #e1ebbd 135px, transparent 135px),linear-gradient(-45deg, #92baac 23px, transparent 23px, transparent 68px,#92baac 68px,#92baac 113px,transparent 113px,transparent 158px,#92baac 158px);background-color:#e1ebbd;background-size: 128px 128px;","background:linear-gradient(63deg, #999 23%, transparent 23%) 7px 0,linear-gradient(63deg, transparent 74%, #999 78%),linear-gradient(63deg, transparent 34%, #999 38%, #999 58%, transparent 62%),#444;background-size: 16px 48px;","background:#36c;background:linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 0 0,linear-gradient(115deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,linear-gradient(245deg, transparent 75%, rgba(255,255,255,.8) 75%) 7px -15px,#36c;background-size: 15px 30px;","background:radial-gradient(circle at 0% 50%, rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px) 0px 10px,radial-gradient(at 100% 100%,rgba(96, 16, 48, 0) 9px, #613 10px, rgba(96, 16, 48, 0) 11px),#8a3;background-size: 20px 20px;","background-image:linear-gradient(to top, #a18cd1 0%, #fbc2eb 100%)","background-image:linear-gradient(to top, #fbc2eb 0%, #a6c1ee 100%)","background-image:linear-gradient(120deg, #a6c0fe 0%, #f68084 100%)","background-image:linear-gradient(120deg, #e0c3fc 0%, #8ec5fc 100%)","background-image:linear-gradient(to right, #fa709a 0%, #fee140 100%)","background-image:linear-gradient(to top, #30cfd0 0%, #330867 100%)","background-image:linear-gradient(to top, #a8edea 0%, #fed6e3 100%)","background-image:linear-gradient(to top, #d299c2 0%, #fef9d7 100%)","background-image:linear-gradient(to top, #fddb92 0%, #d1fdff 100%)","background-image:linear-gradient(to top, #9890e3 0%, #b1f4cf 100%)","background-image:linear-gradient(to top, #96fbc4 0%, #f9f586 100%)","background-image:linear-gradient(to right, #eea2a2 0%, #bbc1bf 19%, #57c6e1 42%, #b49fda 79%, #7ac5d8 100%)","background-image:linear-gradient(to top, #9795f0 0%, #fbc8d4 100%)","background-image:linear-gradient(to top, #3f51b1 0%, #5a55ae 13%, #7b5fac 25%, #8f6aae 38%, #a86aa4 50%, #cc6b8e 62%, #f18271 75%, #f3a469 87%, #f7c978 100%)","background-image:linear-gradient(to top, #f43b47 0%, #453a94 100%)","background-image:linear-gradient(to top, #88d3ce 0%, #6e45e2 100%)","background-image:linear-gradient(to top, #d9afd9 0%, #97d9e1 100%)","background-image:linear-gradient(-20deg, #b721ff 0%, #21d4fd 100%)","background-image:linear-gradient(60deg, #abecd6 0%, #fbed96 100%)","background-image:linear-gradient(to top, #3b41c5 0%, #a981bb 49%, #ffc8a9 100%)","background-image:linear-gradient(to top, #0fd850 0%, #f9f047 100%)","background-image:linear-gradient(to top, #d5dee7 0%, #ffafbd 0%, #c9ffbf 100%)","background-image:linear-gradient(to top, #65bd60 0%, #5ac1a8 25%, #3ec6ed 50%, #b7ddb7 75%, #fef381 100%)","background-image:linear-gradient(to top, #50cc7f 0%, #f5d100 100%)","background-image:linear-gradient(to top, #df89b5 0%, #bfd9fe 100%)","background-image:linear-gradient(to top, #e14fad 0%, #f9d423 100%)","background-image:linear-gradient(to right, #ec77ab 0%, #7873f5 100%)","background-image:linear-gradient(-225deg, #2CD8D5 0%, #C5C1FF 56%, #FFBAC3 100%)","background-image:linear-gradient(-225deg, #5271C4 0%, #B19FFF 48%, #ECA1FE 100%)","background-image:linear-gradient(-225deg, #FF3CAC 0%, #562B7C 52%, #2B86C5 100%)","background-image:linear-gradient(-225deg, #69EACB 0%, #EACCF8 48%, #6654F1 100%)","background-image:linear-gradient(-225deg, #231557 0%, #44107A 29%, #FF1361 67%, #FFF800 100%)"];class KE{constructor(e){this.transparentData="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mNkYAAAAAYAAjCB0C8AAAAASUVORK5CYII=",this.element=document.createElement("div"),this.element.className="protyle-background",this.element.innerHTML=`<div class="protyle-background__img">
    <img class="fn__none">
    <div class="protyle-icons">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__sw" style="position: relative" aria-label="${window.siyuan.languages.upload}"><input type="file" style="position: absolute;width: 22px;height: 100%;top: 0;left: 0;opacity: .001;overflow: hidden;cursor: pointer;"><svg><use xlink:href="#iconUpload"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="link" aria-label="${window.siyuan.languages.link}"><svg><use xlink:href="#iconLink"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="asset" aria-label="${window.siyuan.languages.assets}"><svg><use xlink:href="#iconImage"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw" data-type="show-random" aria-label="${window.siyuan.languages.random}"><svg><use xlink:href="#iconRefresh"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__sw fn__none" data-type="position" aria-label="${window.siyuan.languages.dragPosition}"><svg><use xlink:href="#iconMove"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__sw" data-type="remove" aria-label="${window.siyuan.languages.remove}"><svg><use xlink:href="#iconTrashcan"></use></svg></span>
    </div>
    <div class="protyle-icons fn__none"><span class="protyle-icon protyle-icon--text">${window.siyuan.languages.dragPosition}</span></div>
    <div class="protyle-icons fn__none" style="opacity: .86;">
        <span class="protyle-icon protyle-icon--first" data-type="cancel">${window.siyuan.languages.cancel}</span>
        <span class="protyle-icon protyle-icon--last" data-type="confirm">${window.siyuan.languages.confirm}</span>
    </div>
</div>
<div class="b3-chips"></div>
<div class="protyle-background__iconw">
    <div class="protyle-background__icon" data-menu="true" data-type="open-emoji"></div>
    <div class="protyle-icons fn__flex-center">
        <span class="protyle-icon protyle-icon--first b3-tooltips b3-tooltips__s" data-menu="true" data-type="tag" aria-label="${window.siyuan.languages.addTag}"><svg><use xlink:href="#iconTags"></use></svg></span>
        <span class="protyle-icon b3-tooltips b3-tooltips__s" data-type="icon" aria-label="${window.siyuan.languages.randomIcon}"><svg><use xlink:href="#iconEmoji"></use></svg></span>
        <span class="protyle-icon protyle-icon--last b3-tooltips b3-tooltips__s" data-type="random" aria-label="${window.siyuan.languages.titleBg}"><svg><use xlink:href="#iconImage"></use></svg></span>
    </div>
</div>`,this.tagsElement=this.element.querySelector(".b3-chips"),this.iconElement=this.element.querySelector(".protyle-background__icon"),this.imgElement=this.element.firstElementChild.firstElementChild,this.element.addEventListener("dragover",async n=>{n.preventDefault()}),this.element.addEventListener("drop",async n=>{n.dataTransfer.types[0]==="Files"&&n.dataTransfer.files[0].type.indexOf("image")!==-1&&ka(e,[n.dataTransfer.files[0]],void 0,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})}),this.imgElement.addEventListener("mousedown",n=>{if(n.preventDefault(),!this.element.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none"))return;const a=n.clientY,i=document,s=this.imgElement.naturalHeight*this.imgElement.clientWidth/this.imgElement.naturalWidth-this.imgElement.clientHeight;let o=parseFloat(this.imgElement.style.objectPosition.substring(7))||50;this.imgElement.style.objectPosition.endsWith("px")&&(o=-parseInt(this.imgElement.style.objectPosition.substring(7))/s*100),i.onmousemove=l=>{this.imgElement.style.objectPosition=`center ${((a-l.clientY)/s*100+o).toFixed(2)}%`,n.preventDefault()},i.onmouseup=()=>{i.onmousemove=null,i.onmouseup=null,i.ondragstart=null,i.onselectstart=null,i.onselect=null}}),this.element.querySelector("input").addEventListener("change",n=>{n.target.files.length!==0&&ka(e,n.target.files,n.target,a=>{const i=JSON.parse(a),s=`background-image:url("${i.data.succMap[Object.keys(i.data.succMap)[0]]}")`;this.ial["title-img"]=s,this.render(this.ial,e.block.rootID),w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":s}})})}),this.element.addEventListener(z(),n=>{if(e.disabled)return;let a=n.target;for(X(["gutter"],e);a&&!a.isEqualNode(this.element);){const i=a.getAttribute("data-type");if(i==="position"){const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");s[0].classList.add("fn__none"),s[1].classList.remove("fn__none"),s[2].classList.remove("fn__none"),this.imgElement.style.cursor="move",n.preventDefault(),n.stopPropagation();break}else if(i==="cancel"||i==="confirm"){this.imgElement.style.cursor="";const s=this.element.firstElementChild.querySelectorAll(".protyle-icons");if(s[0].classList.remove("fn__none"),s[1].classList.add("fn__none"),s[2].classList.add("fn__none"),i==="confirm"){const o=`background-image:url("${this.imgElement.getAttribute("src")}");object-position:${this.imgElement.style.objectPosition}`;this.ial["title-img"]=o,w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":o}})}else this.render(this.ial,e.block.rootID);n.preventDefault(),n.stopPropagation();break}else if(i==="open-emoji"){const s=this.iconElement.getBoundingClientRect();fi(e.block.rootID,"doc",{x:s.left,y:s.bottom,h:s.height,w:s.width}),n.preventDefault(),n.stopPropagation();break}else if(i==="show-random"){let s="";Br.forEach((l,r)=>{s+=`<div data-index="${r}" style="height: 148px;width: 148px;${l}" class="b3-card"></div>`});const o=new me({title:window.siyuan.languages.random,content:`<div class="b3-cards" style="margin-right: 0">${s}</div>`,width:(0,I.tq)()?"92vw":"912px",height:(0,I.tq)()?"80vh":"70vh"});o.element.addEventListener("click",l=>{const r=l.target;r.classList.contains("b3-card")&&(this.ial["title-img"]=Br[parseInt(r.getAttribute("data-index"))],this.render(this.ial,e.block.rootID),w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),o.destroy())}),n.preventDefault(),n.stopPropagation();break}else if(i==="random"){this.ial["title-img"]=Br[(0,I.sZ)(0,Br.length-1)],this.render(this.ial,e.block.rootID),w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),n.preventDefault(),n.stopPropagation();break}else if(i==="asset"){const s=a.getBoundingClientRect();Bd(e,{x:a.parentElement.getBoundingClientRect().right,y:s.bottom+8,isLeft:!0},o=>{this.ial["title-img"]=`background-image:url("${o}")`,this.render(this.ial,e.block.rootID),w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}})},p.Constants.SIYUAN_ASSETS_IMAGE),n.preventDefault(),n.stopPropagation();break}else if(i==="remove"){delete this.ial["title-img"],this.render(this.ial,e.block.rootID),w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":""}}),n.preventDefault(),n.stopPropagation();break}else if(i==="icon"){const s=Df();s&&(pi(s,e.block.rootID),Bl(s,e.block.rootID),w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{icon:s}}),e.model&&e.model.parent.setDocIcon(s)),n.preventDefault(),n.stopPropagation();break}else if(i==="tag"){this.openTag(e),n.preventDefault(),n.stopPropagation();break}else if(i==="link"){const s=new me({title:window.siyuan.languages.link,width:(0,I.tq)()?"92vw":"520px",content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" value="${this.imgElement.src.startsWith("data:")?"":this.imgElement.getAttribute("src")}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`}),o=s.element.querySelectorAll(".b3-button");o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{const l=`background-image:url("${s.element.querySelector("input").value}");`;this.ial["title-img"]=l,this.render(this.ial,e.block.rootID),w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{"title-img":this.ial["title-img"]}}),s.destroy()}),s.element.querySelector("input").focus(),n.preventDefault(),n.stopPropagation();break}else if(i==="open-search"){Fn(e.app,`#${a.textContent}#`,!window.siyuan.ctrlIsPressed),n.preventDefault(),n.stopPropagation();break}else if(i==="remove-tag"){a.parentElement.remove(),this.removeTag(e),n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})}removeTag(e){const n=this.getTags();w("/api/attr/setBlockAttrs",{id:e.block.rootID,attrs:{tags:n.toString()}}),n.length===0?delete this.ial.tags:this.ial.tags=n.toString(),this.render(this.ial,e.block.rootID)}render(e,n){const a=e["title-img"],i=e.icon,s=e.tags;if(this.ial=e,this.element.setAttribute("data-node-id",n),s){let o="";const l=["secondary","primary","info","success","warning","error","pink"];s.split(",").forEach((r,c)=>{o+=`<div class="b3-chip b3-chip--middle b3-chip--pointer b3-chip--${l[c%7]}" data-type="open-search">${r}<svg class="b3-chip__close" data-type="remove-tag"><use xlink:href="#iconCloseRound"></use></svg></div>`}),this.tagsElement.innerHTML=o}else this.tagsElement.innerHTML="";if(i?(this.iconElement.classList.remove("fn__none"),this.iconElement.innerHTML=ie(i)):this.iconElement.classList.add("fn__none"),a)if(this.imgElement.classList.remove("fn__none"),this.imgElement.setAttribute("style",Lute.UnEscapeHTMLStr(a)),a.indexOf("url(")>-1){const o=this.imgElement.style.backgroundPosition||this.imgElement.style.objectPosition,l=this.imgElement.style.backgroundImage?.replace(/^url\(["']?/,"").replace(/["']?\)$/,"");this.imgElement.removeAttribute("style"),this.imgElement.setAttribute("src",l),this.imgElement.style.objectPosition=o,this.element.querySelector('[data-type="position"]').classList.remove("fn__none")}else this.imgElement.setAttribute("src",this.transparentData),this.element.querySelector('[data-type="position"]').classList.add("fn__none");else this.imgElement.classList.add("fn__none");a?this.element.style.minHeight=(0,I.tq)()?"200px":"30vh":i?this.element.style.minHeight=this.tagsElement.clientHeight+56+"px":s?this.element.style.minHeight=this.tagsElement.clientHeight+"px":this.element.style.minHeight="0"}openTag(e){w("/api/search/searchTag",{k:""},n=>{let a="";n.data.tags.forEach((l,r)=>{a+=`<div class="b3-list-item${r===0?" b3-list-item--focus":""}">${l}</div>`}),window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.lastElementChild.innerHTML=`<div class="fn__flex-column" style="max-height:50vh;margin: 0 -8px"><input style="margin: 0px 8px 4px 8px" class="b3-text-field"/>
<div class="b3-list fn__flex-1 b3-list--background" style="position: relative">${a}</div>
</div>`;const i=window.siyuan.menus.menu.element.querySelector(".b3-list--background"),s=window.siyuan.menus.menu.element.querySelector("input");s.addEventListener("keydown",l=>{if(l.stopPropagation(),!l.isComposing)if(Bn(i,l),l.key==="Enter"){const r=i.querySelector(".b3-list-item--focus");r?this.addTags(r.textContent,e):this.addTags(s.value,e),window.siyuan.menus.menu.remove()}else l.key==="Escape"&&window.siyuan.menus.menu.remove()}),s.addEventListener("input",l=>{l.stopPropagation(),w("/api/search/searchTag",{k:s.value},r=>{let c="",d=!1;r.data.tags.forEach(u=>{c+=`<div class="b3-list-item">${u}</div>`,u===`<mark>${r.data.k}</mark>`&&(d=!0)}),!d&&r.data.k&&(c=`<div class="b3-list-item"><mark>${r.data.k}</mark></div>`+c),i.innerHTML=c,i.firstElementChild.classList.add("b3-list-item--focus")})}),i.addEventListener("click",l=>{const r=l.target,c=A(r,"b3-list-item");c&&this.addTags(c.textContent,e)});const o=this.iconElement.nextElementSibling.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.left,y:o.top+o.height}),s.focus()})}getTags(e){const n=[];return this.tagsElement.querySelectorAll(".b3-chip").forEach(a=>{const i=a.textContent.trim();e&&i===e&&a.remove(),n.push(i)}),n}addTags(e,n){const a=this.getTags(e);if(a.includes(e)){this.removeTag(n);return}a.push(e),w("/api/attr/setBlockAttrs",{id:n.block.rootID,attrs:{tags:a.toString()}}),this.ial.tags=a.toString(),this.render(this.ial,n.block.rootID)}}class pn{constructor(e,n,a){this.version=p.Constants.SIYUAN_VERSION;const s=new IE(a).merge();if(this.protyle={getInstance:()=>this,app:e,transactionTime:new Date().getTime(),id:Se(),disabled:!1,updated:!1,element:n,options:s,block:{}},this.protyle.hint=new CE(this.protyle),s.render.breadcrumb&&(this.protyle.breadcrumb=new GE(this.protyle)),s.render.title&&(this.protyle.title=new jE(this.protyle)),s.render.background&&(this.protyle.background=new KE(this.protyle)),this.protyle.element.innerHTML="",this.protyle.element.classList.add("protyle"),s.render.breadcrumb&&this.protyle.element.appendChild(this.protyle.breadcrumb.element.parentElement),this.protyle.undo=new qy,this.protyle.wysiwyg=new RE(this.protyle),this.protyle.toolbar=new VE(this.protyle),this.protyle.scroll=new DE(this.protyle),this.protyle.options.render.gutter&&(this.protyle.gutter=new zE(this.protyle)),(s.upload.url||s.upload.handler)&&(this.protyle.upload=new Ly),this.init(),s.action.includes(p.Constants.CB_GET_HISTORY))this.protyle.contentElement.classList.add("protyle-content--transition");else{if(this.protyle.ws=new ct({app:e,id:this.protyle.id,type:"protyle",msgCallback:o=>{switch(o.cmd){case"reload":o.data===this.protyle.block.rootID&&na(this.protyle,!1);break;case"refreshAttributeView":Array.from(this.protyle.wysiwyg.element.querySelectorAll(`[data-av-id="${o.data.id}"]`)).forEach(l=>{l.removeAttribute("data-render"),mt(l,this.protyle)});break;case"addLoading":o.data===this.protyle.block.rootID&&$i(this.protyle,o.msg);break;case"transactions":o.data[0].doOperations.forEach(l=>{!this.protyle.preview.element.classList.contains("fn__none")&&l.action!=="updateAttrs"?this.protyle.preview.render(this.protyle):Yd(this.protyle,l,!1)});break;case"readonly":window.siyuan.config.editor.readOnly=o.data,Og(this.protyle);break;case"heading2doc":case"li2doc":this.protyle.block.rootID===o.data.srcRootBlockID&&(this.protyle.block.showAll&&o.cmd==="heading2doc"&&!this.protyle.options.backlinkData?w("/api/filetree/getDoc",{id:this.protyle.block.rootID,size:window.siyuan.config.editor.dynamicLoadBlocks},l=>{st({data:l,protyle:this.protyle})}):na(this.protyle,!1),o.cmd==="heading2doc"&&Ta({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!0,resize:!1}));break;case"rename":this.protyle.path===o.data.path&&(this.protyle.model&&this.protyle.model.parent.updateTitle(o.data.title),this.protyle.background&&(this.protyle.background.ial.title=o.data.title)),this.protyle.options.render.title&&this.protyle.block.parentID===o.data.id&&(getSelection().rangeCount>0&&this.protyle.title.editElement.contains(getSelection().getRangeAt(0).startContainer)||this.protyle.title.setTitle(o.data.title)),this.protyle.wysiwyg.element.querySelectorAll(`[data-type~="block-ref"][data-id="${o.data.id}"]`).forEach(l=>{l.getAttribute("data-subtype")==="d"&&(l.textContent=o.data.refText)});break;case"moveDoc":this.protyle.path===o.data.fromPath&&(this.protyle.path=o.data.newPath,this.protyle.notebookId=o.data.toNotebook);break;case"unmount":this.protyle.notebookId===o.data.box&&this.protyle.model&&this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1);break;case"removeDoc":o.data.ids.includes(this.protyle.block.rootID)&&(this.protyle.model&&this.protyle.model.parent.parent.removeTab(this.protyle.model.parent.id,!1),delete window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION][this.protyle.block.rootID],pe(p.Constants.LOCAL_FILEPOSITION,window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION]));break}}}),a.backlinkData){this.protyle.block.rootID=a.blockId,Dg(this.protyle,a.backlinkData);return}if(!a.blockId){$r(this.protyle);return}this.protyle.options.mode!=="preview"&&a.rootId&&window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION][a.rootId]&&(s.action.includes(p.Constants.CB_GET_SCROLL)||s.action.includes(p.Constants.CB_GET_ROOTSCROLL)&&a.rootId===a.blockId)?Sd({protyle:this.protyle,scrollAttr:window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION][a.rootId],mergedOptions:s,cb:()=>{this.afterOnGet(s)}}):this.getDoc(s)}}getDoc(e){w("/api/filetree/getDoc",{id:e.blockId,isBacklink:e.action.includes(p.Constants.CB_GET_BACKLINK),mode:e.action&&e.action.includes(p.Constants.CB_GET_CONTEXT)?3:0,size:e.action?.includes(p.Constants.CB_GET_ALL)?p.Constants.SIZE_GET_MAX:window.siyuan.config.editor.dynamicLoadBlocks},n=>{st({data:n,protyle:this.protyle,action:e.action,afterCB:()=>{this.afterOnGet(e)}})})}afterOnGet(e){this.protyle.model&&(e.action?.includes(p.Constants.CB_GET_FOCUS)&&Ze(this.protyle.model.element.parentElement.parentElement),Ta({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!1,resize:!1})),qt(this.protyle),this.protyle.wysiwyg.element.addEventListener("focusin",()=>{if(this.protyle&&this.protyle.model){let n=!0;if(this.protyle.model.element.parentElement.parentElement.classList.contains("layout__wnd--active")&&this.protyle.model.headElement.classList.contains("item--focus")&&(n=!1),!n)return;Ze(this.protyle.model.element.parentElement.parentElement),Ta({protyle:this.protyle,focus:!1,pushBackStack:!1,reload:!1,resize:!1})}else document.querySelectorAll(".layout__tab--active").forEach(n=>{n.classList.remove("layout__tab--active")}),document.querySelectorAll(".layout__wnd--active").forEach(n=>{n.classList.remove("layout__wnd--active")})}),e.after&&e.after(this),this.protyle.contentElement.classList.add("protyle-content--transition")}init(){this.protyle.lute=xE({emojiSite:this.protyle.options.hint.emojiPath,emojis:this.protyle.options.hint.emoji,headingAnchor:!1,listStyle:this.protyle.options.preview.markdown.listStyle,paragraphBeginningSpace:this.protyle.options.preview.markdown.paragraphBeginningSpace,sanitize:this.protyle.options.preview.markdown.sanitize}),this.protyle.preview=new TE(this.protyle),hE(this.protyle)}focus(){this.protyle.wysiwyg.element.focus()}isUploading(){return this.protyle.upload.isUploading}clearStack(){this.protyle.undo.clear()}destroy(){Np(this.protyle)}resize(){qt(this.protyle)}reload(e){na(this.protyle,e)}insert(e,n=!1,a=!1){wt(e,this.protyle,n,a)}transaction(e,n){F(this.protyle,e,n)}turnIntoOneTransaction(e,n,a){sr({protyle:this.protyle,selectsElement:e,type:n,level:a})}turnIntoTransaction(e,n,a){aa({protyle:this.protyle,nodeElement:e,type:n,level:a})}updateTransaction(e,n,a){J(this.protyle,e,n,a)}updateBatchTransaction(e,n){bs(e,this.protyle,n)}getRange(e){return re(e)}hasClosestBlock(e){return x(e)}focusBlock(e,n=!0){return le(e,void 0,n)}}class dt extends ct{constructor(e){super({app:e.app,id:e.tab.id}),window.siyuan.config.fileTree.openFilesUseCurrentTab&&e.tab.headElement.classList.add("item--unupdate"),this.headElement=e.tab.headElement,this.element=e.tab.panelElement,this.initProtyle(e)}initProtyle(e){this.editor=new pn(this.app,this.element,{action:e.action||[],blockId:e.blockId,rootId:e.rootId,mode:e.mode,render:{title:!0,background:!0,scroll:!0},typewriterMode:!0,after:n=>{window.siyuan.editorIsFullscreen&&(n.protyle.element.classList.add("fullscreen"),Gm(n.protyle),Pe().editor.forEach(a=>{!n.protyle.element.isSameNode(a.element)&&a.element.classList.contains("fullscreen")&&(a.element.classList.remove("fullscreen"),qt(a.editor.protyle))})),Gt([],n.protyle.block.rootID),au()}}),this.editor.protyle.model=this}}class gt{constructor(e){if(this.id=Se(),this.callback=e.callback,e.title||e.icon){this.title=e.title,this.icon=e.icon,this.docIcon=e.docIcon,this.headElement=document.createElement("li"),this.headElement.setAttribute("data-type","tab-header"),this.headElement.setAttribute("draggable","true"),this.headElement.setAttribute("data-id",this.id),this.headElement.classList.add("item","item--focus");let n="";e.icon?n=`<svg class="item__graphic"><use xlink:href="#${e.icon}"></use></svg>`:e.docIcon&&(n=`<span class="item__icon">${ie(e.docIcon)}</span>`),this.headElement.innerHTML=`${n}<span class="item__text">${we(e.title)}</span>
<span class="item__close"><svg><use xlink:href="#iconClose"></use></svg></span>`,this.headElement.addEventListener("mouseenter",a=>{a.stopPropagation(),a.preventDefault();let i="";if(this.model instanceof dt&&this.model.editor?.protyle?.block?.rootID)i=this.model.editor.protyle.block.rootID;else if(!this.model){const s=JSON.parse(this.headElement.getAttribute("data-initdata")||"{}");s&&s.instance==="Editor"&&(i=s.blockId)}i?w("/api/filetree/getFullHPathByID",{id:i},s=>{this.headElement.getAttribute("aria-label")||ql(no(s.data),this.headElement),this.headElement.setAttribute("aria-label",no(s.data))}):this.headElement.setAttribute("aria-label",no(e.title))}),this.headElement.addEventListener("dragstart",a=>{if((0,I.b1)()){a.stopPropagation(),a.preventDefault();return}window.getSelection().removeAllRanges();const i=_e(a.target,"LI");if(i){a.dataTransfer.setData("text/html",i.outerHTML);const s={id:this.id};Da(this,s),a.dataTransfer.setData(p.Constants.SIYUAN_DROP_TAB,JSON.stringify(s)),a.dataTransfer.dropEffect="move",i.style.opacity="0.1",window.siyuan.dragElement=this.headElement}}),this.headElement.addEventListener("dragend",a=>{const i=_e(a.target,"LI");i&&(i.style.opacity="1",document.querySelectorAll(".layout-tab-bar li[data-clone='true']").forEach(s=>{s.remove()})),setTimeout(()=>{document.body.contains(this.panelElement)&&(a.clientX<0||a.clientY<0||a.clientX>window.innerWidth||a.clientY>window.innerHeight)&&pa(this)},p.Constants.TIMEOUT_LOAD),window.siyuan.dragElement=void 0,a.dataTransfer.dropEffect==="none"&&this.parent.children.forEach((s,o)=>{const l=this.headElement.parentElement.children[o];s.headElement.isSameNode(l)||(o===0?this.headElement.parentElement.firstElementChild.before(s.headElement):this.headElement.parentElement.children[o-1].after(s.headElement))})})}this.panelElement=document.createElement("div"),this.panelElement.classList.add("fn__flex-1"),this.panelElement.innerHTML=e.panel||"",this.panelElement.setAttribute("data-id",this.id)}updateTitle(e){this.title=e,this.headElement.querySelector(".item__text").innerHTML=we(e)}addModel(e){this.model=e,e.parent=this}pin(){if(!(!this.headElement.previousElementSibling||this.headElement.previousElementSibling&&this.headElement.previousElementSibling.classList.contains("item--pin"))){let e,n=0,a;this.parent.children.find((i,s)=>{if(i.headElement.classList.contains("item--pin")&&(n=s+1,a=i.headElement),i.id===this.id)return e=this.parent.children.splice(s,1)[0],!0}),a?a.after(e.headElement):this.parent.children[0].headElement.before(e.headElement),this.parent.children.splice(n,0,e)}this.headElement.classList.add("item--pin"),(this.docIcon||this.icon)&&this.headElement.querySelector(".item__text").classList.add("fn__none"),Zn()}setDocIcon(e){if(this.docIcon=e,this.docIcon){const n=this.headElement.querySelector(".item__icon");n?n.innerHTML=ie(e):this.headElement.querySelector(".item__text").insertAdjacentHTML("beforebegin",`<span class="item__icon">${ie(e)}</span>`),this.headElement.classList.contains("item--pin")&&this.headElement.querySelector(".item__text").classList.add("fn__none")}else this.headElement.querySelector(".item__icon").remove(),this.headElement.querySelector(".item__text").classList.remove("fn__none")}unpin(){if(!(!this.headElement.nextElementSibling||this.headElement.nextElementSibling&&!this.headElement.nextElementSibling.classList.contains("item--pin"))){let e,n=0,a;for(let i=0;i<this.parent.children.length;i++)this.parent.children[i].id===this.id&&(e=this.parent.children.splice(i,1)[0],i--),i>-1&&this.parent.children[i].headElement.classList.contains("item--pin")&&(n=i+1,a=this.parent.children[i].headElement);a.after(e.headElement),this.parent.children.splice(n,0,e)}this.headElement.classList.remove("item--pin"),(this.docIcon||this.icon)&&this.headElement.querySelector(".item__text").classList.remove("fn__none"),Zn()}close(){this.parent.removeTab(this.id)}}const Hu=async(t,e,n)=>{let a="",i=0;t.forEach(r=>{(!n||r.title.toLowerCase().includes(n.toLowerCase()))&&(a+=`<li data-index="${i}" data-node-id="${r.rootID}" class="b3-list-item${i===0?" b3-list-item--focus":""}">
${ie(r.icon||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0)}
<span class="b3-list-item__text">${we(r.title)}</span>
</li>`,i++)});let s="";if(a){const r=await lt("/api/filetree/getFullHPathByID",{id:t[0].rootID});s=we(r.data)}let o="";if(!(0,I.FJ)()){o='<ul class="b3-list b3-list--background" style="overflow: auto;width: 200px;">',(!n||window.siyuan.languages.riffCard.toLowerCase().includes(n.toLowerCase()))&&(o+=`<li data-type="riffCard" data-index="0" class="b3-list-item${s?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span>
    <span class="b3-list-item__meta">${K(window.siyuan.config.keymap.general.riffCard.custom)}</span>
</li>`,s||(s=window.siyuan.languages.riffCard));let r=1;Mr().forEach(c=>{(!n||c.title.toLowerCase().includes(n.toLowerCase()))&&(o+=`<li data-type="${c.type}" data-index="${r}" class="b3-list-item${s?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#${c.icon}"></use></svg>
    <span class="b3-list-item__text">${c.title}</span>
    <span class="b3-list-item__meta">${K(c.hotkey||"")}</span>
</li>`,r++,s||(s=window.siyuan.languages.riffCard))}),o=o+"</ul>"}const l=e.querySelector(".switch-doc__path");l.innerHTML=s,l.previousElementSibling.innerHTML=`<div class="fn__flex fn__flex-1" style="overflow:auto;">
        ${o}
        <ul style="${(0,I.FJ)()?"border-left:0;":""}min-width:360px;" class="b3-list b3-list--background fn__flex-1">${a}</ul>
    </div>`},Ou=()=>{if(window.siyuan.dialogs.find(e=>{if(e.element.getAttribute("data-key")===p.Constants.DIALOG_RECENTDOCS)return!0})){X(["dialog"]);return}w("/api/storage/getRecentDocs",{},e=>{let n;getSelection().rangeCount>0&&(n=getSelection().getRangeAt(0));const a=new me({positionId:p.Constants.DIALOG_RECENTDOCS,title:`<div class="fn__flex">
<div class="fn__flex-center">${window.siyuan.languages.recentDocs}</div>
<div class="fn__flex-1"></div>
<div class="b3-form__icon fn__size200">
    <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
    <input placeholder="${window.siyuan.languages.search}" class="b3-text-field fn__block b3-form__icon-input">
</div>
</div>`,content:`<div class="fn__flex-column switch-doc">
    <div class="fn__flex fn__flex-1" style="overflow:auto;"></div>
    <div class="switch-doc__path"></div>
</div>`,height:"80vh",destroyCallback:()=>{n&&n.getBoundingClientRect().height!==0&&Z(n)}}),i=a.element.querySelector("input");i.focus(),i.addEventListener("compositionend",()=>{Hu(e.data,a.element,i.value)}),i.addEventListener("input",s=>{s.isComposing||Hu(e.data,a.element,i.value)}),a.element.setAttribute("data-key",p.Constants.DIALOG_RECENTDOCS),a.element.addEventListener("click",s=>{const o=A(s.target,"b3-list-item");o&&(a.element.querySelector(".b3-list-item--focus").classList.remove("b3-list-item--focus"),o.classList.add("b3-list-item--focus"),window.dispatchEvent(new KeyboardEvent("keydown",{key:"Enter"})),s.stopPropagation(),s.preventDefault())}),Hu(e.data,a.element)})},Qa=(t=!0)=>{const e=document.querySelector(".layout__wnd--active .item--focus");let n;return e&&(n=Lt(e.getAttribute("data-id"))),!n&&!t&&Yn().find(a=>{a.headElement?.classList.contains("item--focus")&&(n=a)}),n},jn=t=>{const e=document.querySelector(".dock .dock__item--activefocus");if(e){let a=e.parentElement.children[t];t===-1?(a=e.parentElement.lastElementChild,a.getAttribute("data-type")||(a=a.previousElementSibling)):t===-2?a=e.previousElementSibling:t===-3&&(a=e.nextElementSibling);const i=a?.getAttribute("data-type");i&&St(i)?.toggleModel(i,!0,!1);return}const n=Qa(!1);if(n){let a=n.parent.headersElement.children[t];t===-1?a=n.parent.headersElement.lastElementChild:t===-2?a=n.headElement.previousElementSibling:t===-3&&(a=n.headElement.nextElementSibling),a&&(n.parent.switchTab(a,!0),n.parent.showHeading())}};let db;const jt=(t=!0)=>{clearTimeout(db),db=window.setTimeout(()=>{const e=Pe();e.editor.forEach(n=>{n.editor&&n.editor.protyle&&n.element.parentElement&&!n.element.classList.contains("fn__none")&&n.editor.resize()}),e.backlink.forEach(n=>{const a=n.element.querySelector(".backlinkMList");a.style.height&&a.style.height!=="0px"&&n.element.clientHeight!==0&&(a.style.height=n.element.clientHeight-a.previousElementSibling.clientHeight*2+"px"),n.editors.forEach(i=>{X(["gutter"],i.protyle),i.resize()})}),e.search.forEach(n=>{n.edit.resize()}),e.custom.forEach(n=>{n.resize&&n.resize()}),by(),Ja(["gutter"]),t&&Zn()},200)},St=t=>{if(window.siyuan.layout.leftDock){if(window.siyuan.layout.leftDock.data[t])return window.siyuan.layout.leftDock;if(window.siyuan.layout.rightDock.data[t])return window.siyuan.layout.rightDock;if(window.siyuan.layout.bottomDock.data[t])return window.siyuan.layout.bottomDock}},ub=t=>new gt({panel:`<div class="layout__empty b3-list">
    <div class="${window.siyuan.config.readonly?"":" fn__none"}">
        <div class="config-about__logo">
            <img src="/stage/icon.png">
            ${window.siyuan.languages.siyuanNote}
        </div>
        <div class="b3-label__text">${window.siyuan.languages.slogan}</div>
    </div>
    <div class="fn__hr"></div>
    <div class="b3-list-item" id="editorEmptySearch">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg>
        <span>${window.siyuan.languages.search}</span>
        <span class="b3-list-item__meta">${K(window.siyuan.config.keymap.general.globalSearch.custom)}</span>
    </div>
    <div id="editorEmptyRecent" class="b3-list-item">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconList"></use></svg>
        <span>${window.siyuan.languages.recentDocs}</span>
        <span class="b3-list-item__meta">${K(window.siyuan.config.keymap.general.recentDocs.custom)}</span>
    </div>
    <div id="editorEmptyHistory" class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconHistory"></use></svg>
        <span>${window.siyuan.languages.dataHistory}</span>
        <span class="b3-list-item__meta">${K(window.siyuan.config.keymap.general.dataHistory.custom)}</span>
    </div>
    <div class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyFile">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconFile"></use></svg>
        <span>${window.siyuan.languages.newFile}</span>
        <span class="b3-list-item__meta">${K(window.siyuan.config.keymap.general.newFile.custom)}</span>
    </div>
    <div class="b3-list-item${window.siyuan.config.readonly?" fn__none":""}" id="editorEmptyNewNotebook">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconFilesRoot"></use></svg>
        <span>${window.siyuan.languages.newNotebook}</span>
    </div>
    <div class="b3-list-item" id="editorEmptyHelp">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconHelp"></use></svg>
        <span>${window.siyuan.languages.help}</span>
    </div>
</div>`,callback(e){e.panelElement.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(e.panelElement);){if(a.id==="editorEmptySearch"){_n({app:t,hotkey:p.Constants.DIALOG_GLOBALSEARCH}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyRecent"){Ou(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyHistory"){Dd(t),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyFile"){gi({app:t,useSavePath:!0}),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyNewNotebook"){Jp(),n.stopPropagation(),n.preventDefault();break}else if(a.id==="editorEmptyHelp"){er(),n.stopPropagation(),n.preventDefault();break}a=a.parentElement}})}}),qr=(t,e)=>new gt({icon:e.icon,docIcon:e.docIcon,title:e.title,callback(n){let a;if(e.model instanceof dt)a=new dt({app:t,tab:n,blockId:e.model.editor.protyle.block.id,rootId:e.model.editor.protyle.block.rootID});else if(e.model instanceof zn)a=new zn({app:t,tab:n,path:e.model.path});else if(e.model instanceof oa)a=new oa({app:t,tab:n,blockId:e.model.blockId,rootId:e.model.rootId,type:e.model.type});else if(e.model instanceof xa)a=new xa({app:t,tab:n});else if(e.model instanceof ja)a=new ja({app:t,tab:n,blockId:e.model.blockId,type:e.model.type,isPreview:e.model.isPreview});else if(e.model instanceof Ka)a=new Ka({app:t,tab:n,blockId:e.model.blockId,rootId:e.model.rootId,type:e.model.type});else if(e.model instanceof Pi)a=new Pi(t,n);else if(e.model instanceof Mi)a=new Mi(t,n);else if(e.model instanceof Za)a=new Za({app:t,tab:n,config:e.model.config});else if(e.model instanceof sa){const i=e.model;i.type==="siyuan-card"?a=ku({app:t,tab:n,data:i.data}):t.plugins.find(s=>{if(s.models[i.type])return a=s.models[i.type]({tab:n,data:i.data}),!0})}else if(!e.model&&e.headElement){const i=JSON.parse(e.headElement.getAttribute("data-initdata")||"{}");i&&(a=vb(t,n,i))}n.addModel(a)}}),ca=async(t,e,n)=>{if(e==="closeOthers")for(let a=0;a<t.parent.children.length;a++)t.parent.children[a].id!==t.id&&!t.parent.children[a].headElement.classList.contains("item--pin")&&(await t.parent.children[a].parent.removeTab(t.parent.children[a].id,!0,!1),a--);else if(e==="closeAll")for(let a=0;a<t.parent.children.length;a++)t.parent.children[a].headElement.classList.contains("item--pin")||(await t.parent.children[a].parent.removeTab(t.parent.children[a].id,!0),a--);else if(n.length>0)for(let a=0;a<n.length;a++)n[a].headElement.classList.contains("item--pin")||await n[a].parent.removeTab(n[a].id);t.headElement.parentElement&&!t.headElement.parentElement.querySelector(".item--focus")?t.parent.switchTab(t.headElement,!0):t.parent.children.length>0&&t.parent.switchTab(t.parent.children[t.parent.children.length-1].headElement,!0)};class Kn{constructor(e){const n=Object.assign({direction:"tb",size:"auto",type:"normal"},e);this.id=Se(),this.direction=n.direction,this.type=n.type,this.size=n.size,this.resize=e.resize,this.children=[],this.element=e.element||document.createElement("div"),this.type==="center"&&this.element.classList.add("layout__center"),n.direction==="tb"?this.element.classList.add("fn__flex-column"):this.element.classList.add("fn__flex"),n.type==="left"&&this.element.classList.add("fn__flex-shrink")}addLayout(e,n){n?this.children.find((a,i)=>{if(a.id===n)return this.children.splice(i+1,0,e),a.element.after(e.element),!0}):(this.children.splice(this.children.length,0,e),this&&this.element.append(e.element)),e.size==="auto"?e.element.classList.add("fn__flex-1"):e.element.style[this&&this.direction==="lr"?"width":"height"]=e.size,Eb(e),e.parent=this}addWnd(e,n){n?this.children.find((a,i)=>{if(a.id===n)return this.children.splice(i+1,0,e),a.element.style.width="",a.element.style.height="",a.element.classList.add("fn__flex-1"),this.direction==="lr"&&a.element.querySelectorAll(".protyle-content").forEach(s=>{s.parentElement.classList.contains("fn__none")||(s.classList.remove("protyle-content--transition"),s.querySelector(".protyle-wysiwyg").style.padding="",s.classList.add("protyle-content--transition"))}),a.element.after(e.element),!0}):(this.children.splice(this.children.length,0,e),this.element.append(e.element)),Eb(e),jt(!1),this.direction==="tb"&&(e.element.style.minHeight="64px"),e.parent=this}}class ZE extends ct{constructor(e,n){super({app:e,id:n.id}),this.selectIds=[],this.currentPage=1,this.pageCount=1,this.data={},n instanceof Element?this.element=n:this.element=n.panelElement,this.element.classList.add("fn__flex-column","file-tree","sy__inbox"),this.element.innerHTML=`<div class="block__icons">
    <div class="block__logo">
        <svg><use xlink:href="#iconInbox"></use></svg>
        ${window.siyuan.languages.inbox}&nbsp;
         <span class="inboxSelectCount"></span>
    </div>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <span data-type="selectall" class="block__icon"><svg><use xlink:href="#iconUncheck"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="previous" class="block__icon b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.previousLabel}"><svg><use xlink:href="#iconLeft"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="next" class="block__icon b3-tooltips b3-tooltips__w" disabled="disabled" aria-label="${window.siyuan.languages.nextLabel}"><svg><use xlink:href="#iconRight"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="more" data-menu="true" class="block__icon b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.more}"><svg><use xlink:href="#iconMore"></use></svg></span>
    <span class="fn__space"></span>
    <span data-type="min" class="block__icon b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.min} ${K(window.siyuan.config.keymap.general.closeTab.custom)}"><svg><use xlink:href="#iconMin"></use></svg></span>
</div>
<div class="fn__loading fn__none">
    <img width="64px" src="/stage/loading-pure.svg"></div>
</div>
<div class="fn__flex-1 fn__none inboxDetails fn__flex-column" style="min-height: auto;background-color: var(--b3-theme-background)"></div>
<div class="fn__flex-1"></div>`;const a=this.element.querySelector(".inboxSelectCount"),i=this.element.querySelector(".inboxDetails"),s=this.element.firstElementChild.querySelector('[data-type="selectall"]');this.element.lastElementChild.addEventListener("contextmenu",o=>{const l=A(o.target,"b3-list-item");l&&this.more(o,l)}),this.element.addEventListener("click",o=>{Ze(this.element);let l=o.target;for(;l&&!l.isEqualNode(this.element);){if(l.tagName==="A"){o.stopPropagation();break}const r=l.getAttribute("data-type");if(r==="min"){St("inbox").toggleModel("inbox"),o.preventDefault();break}else if(r==="selectall"){const c=l.querySelector("use");c.getAttribute("xlink:href")==="#iconUncheck"?(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(d=>{d.querySelector("use").setAttribute("xlink:href","#iconCheck"),this.selectIds.push(d.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)]}),c.setAttribute("xlink:href","#iconCheck")):(this.element.lastElementChild.querySelectorAll(".b3-list-item").forEach(d=>{d.querySelector("use").setAttribute("xlink:href","#iconUncheck"),this.selectIds.splice(this.selectIds.indexOf(d.getAttribute("data-id")),1)}),c.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,window.siyuan.menus.menu.remove(),o.stopPropagation();break}else if(r==="select"){const c=l.querySelector("use");c.getAttribute("xlink:href")==="#iconUncheck"?(this.selectIds.push(l.parentElement.getAttribute("data-id")),this.selectIds=[...new Set(this.selectIds)],c.setAttribute("xlink:href","#iconCheck")):(this.selectIds.splice(this.selectIds.indexOf(l.parentElement.getAttribute("data-id")),1),c.setAttribute("xlink:href","#iconUncheck")),a.innerHTML=`${this.selectIds.length.toString()}/${this.pageCount.toString()}`,s.querySelector("use").setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===this.element.lastElementChild.querySelectorAll(".b3-list-item").length?"#iconCheck":"#iconUncheck"),window.siyuan.menus.menu.remove(),o.stopPropagation();break}else if(r==="previous"){l.getAttribute("disabled")!=="disabled"&&(this.currentPage--,this.update()),o.preventDefault();break}else if(r==="next"){l.getAttribute("disabled")!=="disabled"&&(this.currentPage++,this.update()),o.preventDefault();break}else if(r==="back"){this.back(),o.preventDefault();break}else if(r==="more"){this.more(o),o.stopPropagation(),o.preventDefault();break}else if(l.classList.contains("b3-list-item")){const c=this.data[l.getAttribute("data-id")];s.classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.add("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.add("fn__none"),i.innerHTML=this.genDetail(c),i.setAttribute("data-id",c.oId),i.classList.remove("fn__none"),i.scrollTop=0,this.element.lastElementChild.classList.add("fn__none"),o.preventDefault();break}l=l.parentElement}}),this.update()}back(){this.element.firstElementChild.querySelector('[data-type="selectall"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="previous"]').classList.remove("fn__none"),this.element.firstElementChild.querySelector('[data-type="next"]').classList.remove("fn__none"),this.element.querySelector(".inboxDetails").classList.add("fn__none"),this.element.lastElementChild.classList.remove("fn__none")}genDetail(e){let n="";return e.shorthandURL&&(n=`<span class="fn__space"></span><a href="${e.shorthandURL}" target="_blank" class="block__icon block__icon--show b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.link}">
        <svg><use xlink:href="#iconLink"></use></svg>
    </a>`),`<div class="block__icons">
    <div class="block__logo fn__pointer fn__flex-1" data-type="back">
        <svg><use xlink:href="#iconLeft"></use></svg><span class="ft__breakword">${e.shorthandTitle}</span>
    </div>
    ${n}
</div>
<div class="b3-typography b3-typography--default" style="padding: 0 8px 8px;user-select: text">
${e.shorthandContent}
</div>`}genItemHTML(e){return`<li style="padding-left: 0" data-id="${e.oId}" class="b3-list-item">
    <span data-type="select" class="b3-list-item__action">
        <svg><use xlink:href="#icon${this.selectIds.includes(e.oId)?"Check":"Uncheck"}"></use></svg> 
    </span>
    <span class="fn__space--small"></span>
    <span class="b3-list-item__text" title="${e.shorthandTitle}${e.shorthandTitle===e.shorthandDesc?"":`
`+e.shorthandDesc}">${e.shorthandTitle}</span>
    <span class="b3-list-item__meta">${e.hCreated}</span>
</li>`}more(e,n){const a=this.element.querySelector(".inboxDetails");window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.refresh,icon:"iconRefresh",click:()=>{n?w("/api/inbox/getShorthand",{id:n.dataset.id},s=>{this.data[s.data.oId]=s.data,n.outerHTML=this.genItemHTML(s.data)}):a.classList.contains("fn__none")?(this.currentPage=1,this.update()):w("/api/inbox/getShorthand",{id:a.getAttribute("data-id")},s=>{this.data[s.data.oId]=s.data,a.innerHTML=this.genDetail(s.data),a.scrollTop=0})}}).element);let i=[];n?i=[n.dataset.id]:a.classList.contains("fn__none")?i=this.selectIds:i=[a.getAttribute("data-id")],i.length>0&&(window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.move,icon:"iconMove",click:()=>{this.move(i)}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.remove,icon:"iconTrashcan",click:()=>{let s="";i.forEach((o,l)=>{s+='<code class="fn__code">'+we(this.data[o].shorthandTitle)+"</code>"+(l===i.length-1?"":", ")}),Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.confirmDelete} ${s}?`,()=>{n?this.remove(n.dataset.id):a.classList.contains("fn__none")?this.remove():this.remove(a.getAttribute("data-id"))})}}).element)),this.app.plugins&&en({plugins:this.app.plugins,type:"open-menu-inbox",detail:{ids:i,element:n||a},separatorPosition:"top"}),window.siyuan.menus.menu.popup({x:e.clientX,y:e.clientY+16})}remove(e){let n;e?n=[e]:n=this.selectIds,w("/api/inbox/removeShorthands",{ids:n},()=>{e?(this.back(),this.selectIds.find((a,i)=>{if(a===e)return this.selectIds.splice(i,1),!0})):this.selectIds=[],this.currentPage=1,this.update()})}move(e){ga((n,a)=>{e.forEach(i=>{w("/api/inbox/getShorthand",{id:i},s=>{this.data[s.data.oId]=s.data,w("/api/filetree/createDoc",{notebook:a[0],path:Le().join(ft(n[0],!1,!0),Lute.NewNodeID()+".sy"),title:mn(s.data.shorthandTitle),md:s.data.shorthandMd},()=>{this.remove(i)})})})})}update(){const e=this.element.querySelector(".fn__loading");if(va("")){this.element.lastElementChild.innerHTML=`<ul class="b3-list b3-list--background">
    <li class="b3-list--empty">
        ${window.siyuan.languages.inboxTip}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",Ut("subscribe/siyuan"))}
    </li>
</ul>`,e.classList.add("fn__none");return}e.classList.contains("fn__none")&&(e.classList.remove("fn__none"),w("/api/inbox/getShorthands",{page:this.currentPage},n=>{e.classList.add("fn__none");let a="";n.data.data.shorthands.length===0?a=`<ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.inboxTip}</li></ul>`:(a='<ul style="padding: 8px 0" class="b3-list b3-list--background">',n.data.data.shorthands.forEach(l=>{a+=this.genItemHTML(l),this.data[l.oId]=l}),a+="</ul>"),this.element.lastElementChild.innerHTML=a,this.pageCount=n.data.data.pagination.paginationRecordCount,this.element.querySelector(".inboxSelectCount").innerHTML=`${this.selectIds.length}/${this.pageCount}`;const i=this.element.querySelector('[data-type="previous"]'),s=this.element.querySelector('[data-type="next"]');n.data.data.pagination.paginationPageCount>this.currentPage?s.removeAttribute("disabled"):s.setAttribute("disabled","disabled"),this.currentPage===1?i.setAttribute("disabled","disabled"):i.removeAttribute("disabled");const o=this.element.lastElementChild.querySelectorAll(".b3-list-item").length;this.element.firstElementChild.querySelector('[data-type="selectall"] use').setAttribute("xlink:href",this.element.lastElementChild.querySelectorAll('[*|href="#iconCheck"]').length===o&&o!==0?"#iconCheck":"#iconUncheck"),this.element.lastElementChild.scrollTop=0}))}}const Ru=["file","outline","inbox","bookmark","tag","graph","globalGraph","backlink"];class Bu{constructor(e){switch(this.pin=!0,e.position){case"Left":this.layout=window.siyuan.layout.layout.children[0].children[0],this.resizeElement=this.layout.element.nextElementSibling,this.layout.element.classList.add("layout__dockl"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize layout__dockresize--lr"></div>');break;case"Right":this.layout=window.siyuan.layout.layout.children[0].children[2],this.resizeElement=this.layout.element.previousElementSibling,this.layout.element.classList.add("layout__dockr"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize layout__dockresize--lr"></div>');break;case"Bottom":this.layout=window.siyuan.layout.layout.children[1],this.resizeElement=this.layout.element.previousElementSibling,this.layout.element.classList.add("layout__dockb"),this.layout.element.insertAdjacentHTML("beforeend",'<div class="layout__dockresize"></div>');break}this.app=e.app,this.element=document.getElementById("dock"+e.position);const n=e.position==="Bottom"?' class="fn__flex"':"";this.element.innerHTML=`<div${n}></div><div class="fn__flex-1"></div><div${n}></div>`,this.position=e.position,this.pin=e.data.pin,this.data={};let a=!1;e.data.data.length!==0&&(a||e.data.data[0].find(s=>{if(Ru.includes(s.type))return a=!0,!0}),!a&&e.data.data[1]&&e.data.data[1].find(s=>{if(Ru.includes(s.type))return a=!0,!0})),a?(this.genButton(e.data.data[0],0),e.data.data[1]&&this.genButton(e.data.data[1],1),this.element.classList.remove("fn__none")):(this.element.firstElementChild.innerHTML=`<span class="dock__item dock__item--pin b3-tooltips b3-tooltips__${this.getClassDirect(0)}" aria-label="${this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}">
    <svg><use xlink:href="#icon${this.pin?"Unpin":"Pin"}"></use></svg>
</span>`,this.element.classList.add("fn__none"));const i=this.element.querySelectorAll(".dock__item--active");this.element.querySelectorAll(".dock__item").forEach(s=>{s.getAttribute("data-type")==="file"&&!s.classList.contains("dock__item--active")&&(this.toggleModel("file",!0,!1,!1,!1),this.toggleModel("file",!1,!1,!1,!1))}),i.length===0?this.resizeElement.classList.add("fn__none"):i.forEach(s=>{this.toggleModel(s.getAttribute("data-type"),!0,!1,!1,!1)}),this.element.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isEqualNode(this.element);){const l=o.getAttribute("data-type");if(l){this.toggleModel(l,!1,!0),s.preventDefault();break}else if(o.classList.contains("dock__item")){this.togglePin(),o.setAttribute("aria-label",this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin),o.querySelector("use").setAttribute("xlink:href",this.pin?"#iconUnpin":"#iconPin"),s.preventDefault();break}o=o.parentElement}}),this.layout.element.addEventListener("mouseleave",s=>{s.buttons!==0||this.pin||s.toElement?.classList.contains("b3-menu")||this.position==="Left"&&s.clientX<43||this.position==="Right"&&s.clientX>window.innerWidth-43||this.position==="Bottom"&&s.clientY>window.innerHeight-73||this.hideDock()}),this.layout.element.querySelector(".layout__dockresize").addEventListener("mousedown",s=>{const o=document,l=this.position==="Bottom"?"tb":"lr",r=s[l==="lr"?"clientX":"clientY"],c=l==="lr"?this.layout.element.clientWidth:this.layout.element.clientHeight;o.onmousemove=d=>{d.preventDefault(),d.stopPropagation();let u;this.position==="Left"?u=c+(d.clientX-r):this.position==="Right"?u=c+(r-d.clientX):u=c+(r-d.clientY);let f=227;Array.from(this.layout.element.querySelectorAll(".file-tree")).find(g=>{if((g.classList.contains("sy__backlink")||g.classList.contains("sy__graph")||g.classList.contains("sy__globalGraph")||g.classList.contains("sy__inbox"))&&!g.classList.contains("fn__none")&&!A(g,"fn__none"))return f=320,!0}),!(u<f&&l==="lr")&&(u<64&&l==="tb"||(this.layout.element.style[l==="lr"?"width":"height"]=u+"px"))},o.onmouseup=()=>{o.onmousemove=null,o.onmouseup=null,o.ondragstart=null,o.onselectstart=null,o.onselect=null,this.setSize(),this.element.querySelectorAll(".dock__item--active").forEach(d=>{const u=this.data[d.getAttribute("data-type")];u&&u instanceof sa&&u.resize&&u.resize()})}}),window.siyuan.config.uiLayout.hideDock&&this.element.classList.add("fn__none"),this.pin||setTimeout(()=>{this.resetDockPosition(!1),this.hideDock(!0),this.layout.element.classList.add("layout--float"),this.resizeElement.classList.add("fn__none")})}togglePin(){this.pin=!this.pin;const e=this.element.querySelector(".dock__item--active");this.pin?(this.layout.element.style.opacity="",this.layout.element.style.transform="",this.layout.element.style.zIndex="",e&&this.resizeElement.classList.remove("fn__none")):(this.resetDockPosition(!!e),this.resizeElement.classList.add("fn__none"),e?this.showDock(!0):this.hideDock(!0)),this.layout.element.classList.toggle("layout--float"),jt()}resetDockPosition(e){this.position==="Left"?this.layout.element.setAttribute("style",`width:${this.layout.element.clientWidth}px;opacity:${e?1:0};`):this.position==="Right"?this.layout.element.setAttribute("style",`width:${this.layout.element.clientWidth}px;opacity:${e?1:0};`):this.layout.element.setAttribute("style",`height:${this.layout.element.clientHeight}px;opacity:${e?1:0};`)}showDock(e=!1){!e&&(this.pin||!this.element.querySelector(".dock__item--active")||this.layout.element.style.opacity==="1")||!e&&(this.position==="Left"||this.position==="Right")&&this.layout.element.clientWidth===0&&this.layout.element.style.width.startsWith("0")||!e&&this.position==="Bottom"&&this.layout.element.clientHeight===0&&this.layout.element.style.height.startsWith("0")||(document.querySelector(".b3-dialog")||document.querySelector(".block__popover")||document.querySelector("#commonMenu:not(.fn__none)"))&&(window.siyuan.layout.leftDock?.layout.element.style.opacity==="1"||window.siyuan.layout.rightDock?.layout.element.style.opacity==="1"||window.siyuan.layout.bottomDock?.layout.element.style.opacity==="1")||(e||(this.layout.element.style.opacity="1"),this.layout.element.style.transform="",this.layout.element.style.zIndex=(++window.siyuan.zIndex).toString(),this.position==="Left"?this.layout.element.style.left=`${this.element.clientWidth}px`:this.position==="Right"?this.layout.element.style.right=`${this.element.clientWidth}px`:this.position==="Bottom"&&(this.layout.element.style.bottom=`${this.element.offsetHeight+document.getElementById("status").offsetHeight}px`))}hideDock(e=!1){if(!e&&(this.layout.element.style.opacity==="0"||this.pin)||this.layout.element.querySelector(".fullscreen")||document.activeElement&&this.layout.element.contains(document.activeElement)&&document.activeElement.classList.contains("b3-text-field"))return;const n=document.querySelector(".b3-dialog"),a=document.querySelector(".block__popover"),i=document.querySelector("#commonMenu:not(.fn__none)");n&&n.style.zIndex>this.layout.element.style.zIndex||a&&a.style.zIndex>this.layout.element.style.zIndex||i&&i.style.zIndex>this.layout.element.style.zIndex||(this.position==="Left"?(this.layout.element.style.transform=`translateX(-${this.layout.element.clientWidth+8}px)`,this.layout.element.style.left=""):this.position==="Right"?(this.layout.element.style.transform=`translateX(${this.layout.element.clientWidth+8}px)`,this.layout.element.style.right=""):this.position==="Bottom"&&(this.layout.element.style.transform=`translateY(${this.layout.element.clientHeight+8}px)`,this.layout.element.style.bottom=""),!e&&(this.layout.element.style.opacity="0",this.element.querySelector(".dock__item--activefocus")?.classList.remove("dock__item--activefocus"),this.layout.element.querySelector(".layout__tab--active")?.classList.remove("layout__tab--active")))}toggleModel(e,n=!1,a=!1,i=!1,s=!0){if(!e)return;const o=this.element.querySelector(`[data-type="${e}"]`);n&&o.classList.contains("dock__item--active")&&o.classList.remove("dock__item--active","dock__item--activefocus");const l=parseInt(o.getAttribute("data-index")),r=this.layout.children[l];if(o.classList.contains("dock__item--active")||i){if(!a){let g=!1;if(Array.from(r.element.querySelector(".layout-tab-container").children).find(h=>{if(h.getAttribute("data-id")===o.getAttribute("data-id"))return h.classList.contains("layout__tab--active")||(Ze(h),g=!0),!0}),g){document.activeElement&&document.activeElement.blur(),this.showDock();return}}if(o.classList.remove("dock__item--active","dock__item--activefocus"),this.element.querySelectorAll(".dock__item--active").length===0&&(this.position==="Left"||this.position==="Right"?this.layout.element.style.width="0px":this.layout.element.style.height="0px",this.resizeElement.classList.add("fn__none"),this.hideDock()),(e==="graph"||e==="globalGraph")&&this.layout.element.querySelector(".fullscreen")&&document.getElementById("drag")?.classList.remove("fn__hidden"),s&&!document.querySelector(".layout__center .layout__wnd--active")){const g=document.querySelector(".layout__center ul.layout-tab-bar .item--focus");g&&Yn().find(h=>{if(h.id===g.getAttribute("data-id"))return h.parent.switchTab(h.headElement),!0})}}else{if(this.element.querySelectorAll(`.dock__item--active[data-index="${l}"]`).forEach(g=>{g.classList.remove("dock__item--active","dock__item--activefocus")}),o.classList.add("dock__item--active","dock__item--activefocus"),o.getAttribute("data-id"))Array.from(r.element.querySelector(".layout-tab-container").children).forEach(g=>{g.getAttribute("data-id")===o.getAttribute("data-id")?(g.classList.remove("fn__none"),Ze(g)):g.classList.add("fn__none")});else{let g;Pe().editor.find(b=>{if(b.parent.headElement.classList.contains("item--focus")&&b.editor?.protyle?.path)return g=b.editor,!0});let m;switch(e){case"file":m=new gt({callback:b=>{b.addModel(new xa({tab:b,app:this.app}))}});break;case"bookmark":m=new gt({callback:b=>{b.addModel(new Pi(this.app,b))}});break;case"tag":m=new gt({callback:b=>{b.addModel(new Mi(this.app,b))}});break;case"outline":m=new gt({callback:b=>{const y=new ja({app:this.app,type:"pin",tab:b,blockId:g?.protyle?.block?.rootID,isPreview:!g?.protyle?.preview?.element.classList.contains("fn__none")});g?.protyle?.title?.editElement&&y.updateDocTitle(g.protyle?.background?.ial),b.addModel(y)}});break;case"graph":m=new gt({callback:b=>{b.addModel(new oa({app:this.app,tab:b,blockId:g?.protyle?.block?.rootID,type:"pin"}))}});break;case"globalGraph":m=new gt({callback:b=>{b.addModel(new oa({app:this.app,tab:b,type:"global"}))}});break;case"backlink":m=new gt({callback:b=>{b.addModel(new Ka({app:this.app,type:"pin",tab:b,blockId:g?.protyle?.block?.rootID}))}});break;case"inbox":m=new gt({callback:b=>{b.addModel(new ZE(this.app,b))}});break;default:m=new gt({callback:b=>{let y;this.app.plugins.find(_=>{if(_.docks[e])return y=_.docks[e].model({tab:b}),!0}),y&&b.addModel(y)}});break}r.addTab(m,!1,!1),o.setAttribute("data-id",m.id),this.data[e]=m.model,Ze(m.panelElement)}this.position==="Left"||this.position==="Right"?this.layout.element.style.width=this.getMaxSize()+"px":this.layout.element.style.height=this.getMaxSize()+"px",(e==="graph"||e==="globalGraph")&&this.layout.element.querySelector(".fullscreen")&&document.getElementById("drag")?.classList.add("fn__hidden"),this.pin&&(this.layout.element.style.opacity="",setTimeout(()=>{this.resizeElement.classList.remove("fn__none")},200)),document.activeElement&&document.activeElement.blur()}const c=l===0?1:0,d=this.layout.children[c],u=this.element.querySelectorAll(`.dock__item--active[data-index="${c}"]`).length>0,f=this.element.querySelectorAll(`.dock__item--active[data-index="${l}"]`).length>0;if(f&&u){let g=r;c===0?d.element.nextElementSibling.classList.remove("fn__none"):(g=d,d.element.previousElementSibling.classList.remove("fn__none"));const h=this.element.querySelector('.dock__item--active[data-index="1"]');if(this.position==="Left"||this.position==="Right"){const m=parseInt(h.getAttribute("data-height"));m!==0&&!isNaN(m)&&(g.element.style.height=m+"px",g.element.classList.remove("fn__flex-1"))}else{const m=parseInt(h.getAttribute("data-width"));m!==0&&!isNaN(m)&&(g.element.style.width=m+"px",g.element.classList.remove("fn__flex-1"))}}else c===0?d.element.nextElementSibling.classList.add("fn__none"):d.element.previousElementSibling.classList.add("fn__none");u?d.element.classList.remove("fn__none"):d.element.classList.add("fn__none"),f?r.element.classList.remove("fn__none"):r.element.classList.add("fn__none"),f&&!u?(r.element.classList.add("fn__flex-1"),r.element.style.height="",r.element.style.width=""):!f&&u&&(d.element.classList.add("fn__flex-1"),d.element.style.height="",d.element.style.width=""),jt(s),this.showDock()}add(e,n){n.setAttribute("data-height",""),n.setAttribute("data-width","");const a=n.getAttribute("data-type"),i=St(a);i.element.querySelectorAll(".dock__item").length===2&&i.element.classList.add("fn__none");const s=i.layout.children[parseInt(n.getAttribute("data-index"))];n.getAttribute("data-id")&&(s.removeTab(n.getAttribute("data-id")),n.removeAttribute("data-id"));const l=n.classList.contains("dock__item--active");l&&i.toggleModel(a),delete i.data[a],n.classList.remove("b3-tooltips__n","b3-tooltips__ne","b3-tooltips__nw","b3-tooltips__s","b3-tooltips__se","b3-tooltips__sw","b3-tooltips__e","b3-tooltips__w"),n.classList.add(`b3-tooltips__${this.getClassDirect(e)}`),n.setAttribute("data-index",e.toString()),e===0?this.element.firstElementChild.insertAdjacentElement("afterbegin",n):this.element.lastElementChild.insertAdjacentElement("afterbegin",n),this.element.classList.remove("fn__none"),Zd(),this.data[a]=!0,l&&this.toggleModel(a,!0)}remove(e){this.toggleModel(e,!1,!0,!0),this.element.querySelector(`[data-type="${e}"]`).remove();const n=this.data[e];n.parent&&n.parent.parent.removeTab(n.parent.id),delete this.data[e]}getClassDirect(e){let n="e";switch(this.position){case"Right":n="w";break;case"Bottom":e===0?n="ne":n="nw";break}return n}setSize(){const e=this.element.querySelectorAll(".dock__item--active");e.forEach(n=>{this.position==="Left"||this.position==="Right"?(n.getAttribute("data-index")==="1"&&e.length>1&&n.setAttribute("data-height",this.data[n.getAttribute("data-type")].parent.parent.element.clientHeight.toString()),n.setAttribute("data-width",this.layout.element.clientWidth.toString())):(n.getAttribute("data-index")==="1"&&e.length>1&&n.setAttribute("data-width",this.data[n.getAttribute("data-type")].parent.parent.element.clientWidth.toString()),n.setAttribute("data-height",this.layout.element.clientHeight.toString()))})}getMaxSize(){let e=0;return this.element.querySelectorAll(".dock__item--active").forEach(n=>{let a;this.position==="Left"||this.position==="Right"?a=parseInt(n.getAttribute("data-width"))||(["graph","globalGraph","backlink"].includes(n.getAttribute("data-type"))?320:227):a=parseInt(n.getAttribute("data-height"))||227,a>e&&(e=a)}),e}genButton(e,n,a){let i="";e.forEach(s=>{typeof a>"u"&&!Ru.includes(s.type)||(i+=`<span data-height="${s.size.height}" data-width="${s.size.width}" data-type="${s.type}" data-index="${n}" data-hotkey="${s.hotkey||""}" data-hotkeyLangId="${s.hotkeyLangId||""}" data-title="${s.title}" class="dock__item${s.show?" dock__item--active":""} b3-tooltips b3-tooltips__${this.getClassDirect(n)}" aria-label="${s.title} ${s.hotkey?K(s.hotkey):""}${window.siyuan.languages.dockTip}">
    <svg><use xlink:href="#${s.icon}"></use></svg>
</span>`,this.data[s.type]=!0)}),n===0?typeof a=="number"?this.element.firstElementChild.children[a]?this.element.firstElementChild.children[a].insertAdjacentHTML("beforebegin",i):this.element.firstElementChild.lastElementChild.insertAdjacentHTML("beforebegin",i):this.element.firstElementChild.innerHTML=`${i}<span class="dock__item dock__item--pin b3-tooltips b3-tooltips__${this.getClassDirect(n)}" aria-label="${this.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}">
    <svg><use xlink:href="#icon${this.pin?"Unpin":"Pin"}"></use></svg>
</span>`:typeof a=="number"?this.element.lastElementChild.children[a]?this.element.lastElementChild.children[a].insertAdjacentHTML("beforebegin",i):this.element.lastElementChild.insertAdjacentHTML("beforeend",i):this.element.lastElementChild.innerHTML=i,typeof a=="number"&&(window.siyuan.config.uiLayout.hideDock||this.element.classList.remove("fn__none"),e[0].show&&this.toggleModel(e[0].type,!0,!1,!1,!1))}}class fb{constructor(e){this.data={},this.protyleSlash=[],this.customBlockRenders={},this.topBarIcons=[],this.statusBarIcons=[],this.commands=[],this.models={},this.docks={},this.addFloatLayer=n=>{window.siyuan.blockPanels.push(new Ro({app:this.app,targetElement:n.targetElement,isBacklink:n.isBacklink,x:n.x,y:n.y,nodeIds:n.ids,defIds:n.defIds}))},this.app=e.app,this.i18n=e.i18n,this.displayName=e.displayName,this.eventBus=new Ey(e.name)}onload(){}onunload(){}onLayoutReady(){}addCommand(e){this.commands.push(e)}addIcons(e){document.body.insertAdjacentHTML("afterbegin",`<svg data-name="${this.name}" style="position: absolute; width: 0; height: 0; overflow: hidden;" xmlns="http://www.w3.org/2000/svg">
<defs>${e}</defs></svg>`)}addTopBar(e){if(!e.icon.startsWith("icon")&&!e.icon.startsWith("<svg")){console.error(`plugin ${this.name} addTopBar error: icon must be svg id or svg tag`);return}const n=document.createElement("div");return n.setAttribute("data-menu","true"),n.addEventListener("click",e.callback),n.id=`plugin_${this.name}_${this.topBarIcons.length}`,(0,I.tq)()?(n.className="b3-menu__item",n.innerHTML=(e.icon.startsWith("icon")?`<svg class="b3-menu__icon"><use xlink:href="#${e.icon}"></use></svg>`:e.icon)+`<span class="b3-menu__label">${e.title}</span>`):(0,I.FJ)()||(n.className="toolbar__item ariaLabel",n.setAttribute("aria-label",e.title),n.innerHTML=e.icon.startsWith("icon")?`<svg><use xlink:href="#${e.icon}"></use></svg>`:e.icon,n.addEventListener("click",e.callback),n.setAttribute("data-position",e.position||"right")),this.topBarIcons.push(n),n}addStatusBar(e){return e.element.setAttribute("data-position",e.position||"right"),this.statusBarIcons.push(e.element),e.element}openSetting(){this.setting&&this.setting.open(this.name)}loadData(e){return typeof this.data[e]>"u"&&(this.data[e]=""),new Promise(n=>{w("/api/file/getFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{a.code!==404&&(this.data[e]=a),n(this.data[e])})})}saveData(e,n){return new Promise(a=>{const i=`/data/storage/petal/${this.name}/${e}`;let s;typeof n=="object"?s=new File([new Blob([JSON.stringify(n)],{type:"application/json"})],i.split("/").pop()):s=new File([new Blob([n])],i.split("/").pop());const o=new FormData;o.append("path",i),o.append("file",s),o.append("isDir","false"),w("/api/file/putFile",o,l=>{this.data[e]=n,a(l)})})}removeData(e){return new Promise(n=>{this.data||(this.data={}),w("/api/file/removeFile",{path:`/data/storage/petal/${this.name}/${e}`},a=>{delete this.data[e],n(a)})})}getOpenedTab(){const e={},n=Object.keys(this.models);return n.forEach(a=>{e[a.replace(this.name,"")]=[]}),Pe().custom.find(a=>{n.includes(a.type)&&e[a.type.replace(this.name,"")].push(a)}),e}addTab(e){const n=this.name+e.type;return this.models[n]=a=>{const i=new sa({app:this.app,tab:a.tab,type:n,data:a.data,init:e.init,beforeDestroy:e.beforeDestroy,destroy:e.destroy,resize:e.resize,update:e.update});return i.element.addEventListener("click",()=>{Ze(i.element.parentElement.parentElement)}),i},this.models[n]}addDock(e){const n=this.name+e.type;return typeof e.config.index>"u"&&(e.config.index=1e3),this.docks[n]={config:e.config,model:a=>{const i=new sa({app:this.app,tab:a.tab,type:n,data:e.data,init:e.init,destroy:e.destroy,resize:e.resize,update:e.update});return i.element.addEventListener("click",s=>{Ze(i.element),q(s.target,"data-type","min")&&St(n).toggleModel(n)}),i.element.classList.add("sy__"+n),i}},this.docks[n]}}class JE{constructor(e){this.items=[],this.confirmCallback=e.confirmCallback,this.width=e.width||((0,I.tq)()?"92vw":"768px"),this.height=e.height||"80vh"}addItem(e){this.items.push(e)}open(e){const n=new me({title:e,content:`<div class="b3-dialog__content">
</div>
<div class="b3-dialog__action${this.confirmCallback?"":" fn__none"}">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <div class="fn__space${this.confirmCallback?"":" fn__none"}"></div>
    <button class="b3-button b3-button--text${this.confirmCallback?"":" fn__none"}">${window.siyuan.languages.save}</button>
</div>`,width:this.width,height:this.height,destroyCallback:()=>{this.destroyCallback&&this.destroyCallback()}}),a=n.element.querySelector(".b3-dialog__content");this.items.forEach(s=>{let o="",l=s.actionElement;!s.actionElement&&s.createActionElement&&(l=s.createActionElement()),l&&l.tagName==="TEXTAREA"?o=`<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${s.title}
        ${s.description?`<div class="b3-label__text">${s.description}</div>`:""}
        <div class="fn__hr"></div>
    </div>
</label>`:o=`<label class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${s.title}
        ${s.description?`<div class="b3-label__text">${s.description}</div>`:""}
    </div>
    <span class="fn__space${l?"":" fn__none"}"></span>
</label>`,a.insertAdjacentHTML("beforeend",o),l&&(["INPUT","TEXTAREA"].includes(l.tagName)&&n.bindInput(l,()=>{i[1].dispatchEvent(new CustomEvent("click"))},l.tagName==="INPUT"),l.tagName==="TEXTAREA"?a.lastElementChild.lastElementChild.insertAdjacentElement("beforeend",l):a.lastElementChild.insertAdjacentElement("beforeend",l))}),a.querySelector("input")?.focus();const i=n.element.querySelectorAll(".b3-dialog__action .b3-button");i[0].addEventListener("click",()=>{n.destroy()}),i[1].addEventListener("click",()=>{this.confirmCallback&&this.confirmCallback(),n.destroy()})}}let pb,gb;gb=t=>{if(t.doc&&t.doc.id){to(t.doc.id,{position:t.position,width:t.width,height:t.height});return}if(t.tab){pa(t.tab,{position:t.position,width:t.width,height:t.height});return}},pb=t=>{if(t.doc)return t.doc.zoomIn&&(t.doc.action&&!t.doc.action.includes(p.Constants.CB_GET_ALL)?t.doc.action.push(p.Constants.CB_GET_ALL):t.doc.action=[p.Constants.CB_GET_ALL]),t.doc.action||(t.doc.action=[]),de({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,id:t.doc.id,action:t.doc.action,zoomIn:t.doc.zoomIn});if(t.asset)return Dn({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,assetPath:t.asset.path});if(t.pdf)return Dn({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,assetPath:t.pdf.path,page:t.pdf.id||t.pdf.page});if(t.search)return t.search.idPath||(t.search.idPath=[]),t.search.hPath||(t.search.hPath=""),Dn({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,searchData:t.search});if(t.card)return Dn({app:t.app,keepCursor:t.keepCursor,removeCurrentTab:t.removeCurrentTab,position:t.position,afterOpen:t.afterOpen,custom:{icon:"iconRiffCard",title:window.siyuan.languages.spaceRepetition,data:{cardType:t.card.type,id:t.card.id||"",title:t.card.title},id:"siyuan-card"}});if(t.custom)return Dn(t)};const XE={confirm:Ne,showMessage:M,adaptHotkey:K,fetchPost:w,fetchSyncPost:lt,fetchGet:Iu,getFrontend:I.UP,getBackend:I.N_,openTab:pb,openWindow:gb,Protyle:pn,Plugin:fb,Dialog:me,Menu:At,Setting:JE,Constants:p.Constants,openMobileFileById:Ky},hb=t=>({siyuan:XE})[t]??window.require?.(t);window.require instanceof Function&&(hb.__proto__=window.require);const QE=(t,e)=>window.eval("(function anonymous(require, module, exports){".concat(t,`
})
//# sourceURL=`).concat(e,`
`)),mb=async t=>{const e=await lt("/api/petal/loadPetals",{frontend:(0,I.UP)()});let n="";e.data.forEach(i=>{bb(t,i),n+=i.css||`
`});const a=document.getElementById("pluginsStyle");a?a.innerHTML=n:document.head.insertAdjacentHTML("beforeend",`<style id="pluginsStyle">${n}</style>`)},bb=async(t,e)=>{const n={},a={exports:n};try{QE(e.js,"plugin:"+encodeURIComponent(e.name))(hb,a,n)}catch(o){console.error(`plugin ${e.name} run error:`,o);return}const i=(a.exports||n).default||a.exports;if(typeof i!="function"){console.error(`plugin ${e.name} has no export`);return}if(!(i.prototype instanceof fb)){console.error(`plugin ${e.name} does not extends Plugin`);return}const s=new i({app:t,displayName:e.displayName,name:e.name,i18n:e.i18n});Object.defineProperty(s,"name",{value:e.name,writable:!1}),t.plugins.push(s);try{await s.onload()}catch(o){console.error(`plugin ${e.name} onload error:`,o)}return s},wb=async(t,e)=>{const n=await bb(t,e),a=document.createElement("style");return a.textContent=e.css,document.head.append(a),Fu(n),n},qu=(t,e,n,a)=>{const i=Object.keys(n.docks);t.forEach((s,o)=>{i.includes(s.type)&&(a==="Left"?n.docks[s.type].config.position=e===0?"LeftTop":"LeftBottom":a==="Right"?n.docks[s.type].config.position=e===0?"RightTop":"RightBottom":a==="Bottom"&&(n.docks[s.type].config.position=e===0?"BottomLeft":"BottomRight"),n.docks[s.type].config.index=o,n.docks[s.type].config.show=s.show,n.docks[s.type].config.size=s.size)})},ek=t=>{window.siyuan.config.keymap.plugin||(window.siyuan.config.keymap.plugin={});for(let e=0;e<t.commands.length;e++){const n=t.commands[e];window.siyuan.config.keymap.plugin[t.name]?window.siyuan.config.keymap.plugin[t.name][n.langKey]?window.siyuan.config.keymap.plugin[t.name][n.langKey]&&(typeof window.siyuan.config.keymap.plugin[t.name][n.langKey].custom=="string"?n.customHotkey=window.siyuan.config.keymap.plugin[t.name][n.langKey].custom:n.customHotkey=n.hotkey,window.siyuan.config.keymap.plugin[t.name][n.langKey].default=n.hotkey):(n.customHotkey=n.hotkey,window.siyuan.config.keymap.plugin[t.name][n.langKey]={default:n.hotkey,custom:n.hotkey}):(n.customHotkey=n.hotkey,window.siyuan.config.keymap.plugin[t.name]={[n.langKey]:{default:n.hotkey,custom:n.hotkey}}),typeof n.customHotkey!="string"&&(console.error(`${t.name} - commands data is error and has been removed.`),t.commands.splice(e,1),e--)}},Fu=t=>{try{t.onLayoutReady()}catch(e){console.error(`plugin ${t.name} onLayoutReady error:`,e)}if(!(0,I.FJ)()||(0,I.tq)()){const e=[];if(t.topBarIcons.forEach(n=>{(0,I.tq)()?window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].includes(n.id)?e.push({iconHTML:n.firstElementChild.outerHTML,label:n.textContent.trim(),click(){n.dispatchEvent(new CustomEvent("click"))}}):document.querySelector("#menuAbout").after(n):(0,I.FJ)()||(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].includes(n.id)&&n.classList.add("fn__none"),document.querySelector("#"+(n.getAttribute("data-position")==="right"?"barPlugins":"drag")).before(n))}),(0,I.tq)()&&e.length>0)return e}Ur(),ek(t),t.statusBarIcons.forEach(e=>{const n=document.getElementById("status");e.getAttribute("data-position")==="right"?n.insertAdjacentElement("beforeend",e):n.insertAdjacentElement("afterbegin",e)}),!(0,I.FJ)()&&(window.siyuan.config.uiLayout.left.data.forEach((e,n)=>{qu(e,n,t,"Left")}),window.siyuan.config.uiLayout.right.data.forEach((e,n)=>{qu(e,n,t,"Right")}),window.siyuan.config.uiLayout.bottom.data.forEach((e,n)=>{qu(e,n,t,"Bottom")}),Object.keys(t.docks).forEach(e=>{const n=t.docks[e];n.config.position.startsWith("Left")?window.siyuan.layout.leftDock.genButton([{type:e,size:n.config.size,show:n.config.show,icon:n.config.icon,title:n.config.title,hotkey:n.config.hotkey}],n.config.position==="LeftBottom"?1:0,n.config.index):n.config.position.startsWith("Bottom")?window.siyuan.layout.bottomDock.genButton([{type:e,size:n.config.size,show:n.config.show,icon:n.config.icon,title:n.config.title,hotkey:n.config.hotkey}],n.config.position==="BottomRight"?1:0,n.config.index):n.config.position.startsWith("Right")&&window.siyuan.layout.rightDock.genButton([{type:e,size:n.config.size,show:n.config.show,icon:n.config.icon,title:n.config.title,hotkey:n.config.hotkey}],n.config.position==="RightBottom"?1:0,n.config.index)}))},Ze=t=>{if(t.getAttribute("data-type")==="wnd"&&Bo(t.querySelector('.layout-tab-bar .item--focus[data-type="tab-header"] .item__text')?.textContent||window.siyuan.languages.siyuanNote),!(t.classList.contains("layout__tab--active")||t.classList.contains("layout__wnd--active")))if(document.querySelectorAll(".layout__tab--active").forEach(e=>{e.classList.remove("layout__tab--active")}),document.querySelectorAll(".dock__item--activefocus").forEach(e=>{e.classList.remove("dock__item--activefocus")}),document.querySelectorAll(".layout__wnd--active").forEach(e=>{e.classList.remove("layout__wnd--active")}),t.getAttribute("data-type")==="wnd")t.classList.add("layout__wnd--active");else{t.classList.add("layout__tab--active"),Array.from(t.classList).find(n=>{if(n.startsWith("sy__"))return document.querySelector(`.dock__item[data-type="${n.substring(4)}"]`).classList.add("dock__item--activefocus"),!0});const e=x(document.activeElement);if(e){const n=ae(e);n&&n.blur()}}},Uu=(t,e)=>{const n=[];e.children.forEach(a=>{if(a.model instanceof dt&&a.model.editor.protyle.toolbar.range){const i=x(a.model.editor.protyle.toolbar.range.startContainer);if(i){const s=yt(i,void 0,a.model.editor.protyle.toolbar.range);n.push({id:i.getAttribute("data-node-id"),start:s.start,end:s.end})}}}),t.element.after(e.element),e.children.forEach(a=>{if(a.model instanceof dt){const i=n.splice(0,1)[0];if(!i)return;const s=Gn(a.model.editor.protyle.wysiwyg.element.querySelector(`[data-node-id="${i.id}"]`),i.start,i.end);s&&(a.model.editor.protyle.toolbar.range=s)}}),t.element.after(t.element.previousElementSibling),t.parent.children.find((a,i)=>{if(a.id===t.id){const s=t.parent.children[i].resize;t.parent.children[i].resize=t.parent.children[i-1].resize,t.parent.children[i-1].resize=s;const o=a;return t.parent.children[i]=t.parent.children[i-1],t.parent.children[i-1]=o,!0}}),Ai()},Ni=t=>{for(let e=0;e<t.children.length;e++){const n=t.children[e];return n instanceof la?n:Ni(n)}},Ia=t=>{const e=[],n=s=>{const o=[];return t.element.querySelectorAll(`span[data-index="${s}"]`).forEach(l=>{o.push({type:l.getAttribute("data-type"),size:{height:parseInt(l.getAttribute("data-height")),width:parseInt(l.getAttribute("data-width"))},title:l.getAttribute("data-title"),show:l.classList.contains("dock__item--active"),icon:l.querySelector("use").getAttribute("xlink:href").substring(1),hotkey:l.getAttribute("data-hotkey")||"",hotkeyLangId:l.getAttribute("data-hotkeyLangId")||""})}),o},a=n(0),i=n(1);return(a.length>0||i.length>0)&&e.push(a),i.length>0&&e.push(i),{pin:t.pin,data:e}},yb=()=>{w("/api/system/setUILayout",{layout:{}},()=>{window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION]={},pe(p.Constants.LOCAL_FILEPOSITION,window.siyuan.storage[p.Constants.LOCAL_FILEPOSITION]),window.siyuan.storage[p.Constants.LOCAL_DIALOGPOSITION]={},pe(p.Constants.LOCAL_DIALOGPOSITION,window.siyuan.storage[p.Constants.LOCAL_DIALOGPOSITION]),window.location.reload()})};let Fr=0;const Zn=()=>{const t={};let e={};if((0,I.FJ)())e={layout:{}},Da(window.siyuan.layout.layout,e.layout,t);else{const n=document.querySelector("#barDock use");n&&(e={hideDock:n.getAttribute("xlink:href")==="#iconDock",layout:{},bottom:Ia(window.siyuan.layout.bottomDock),left:Ia(window.siyuan.layout.leftDock),right:Ia(window.siyuan.layout.rightDock)},Da(window.siyuan.layout.layout,e.layout,t))}Object.keys(t).length>0&&Fr<10?(Fr++,setTimeout(()=>{Zn()},p.Constants.TIMEOUT_LOAD*Fr)):(Fr=0,(0,I.FJ)()?sessionStorage.setItem("layout",JSON.stringify(e)):w("/api/system/setUILayout",{layout:e,errorExit:!1}))},It=t=>{if((0,I.FJ)()){const a={layout:{}};Da(window.siyuan.layout.layout,a.layout),Pe().editor.forEach(i=>{cs(i.editor.protyle)}),sessionStorage.setItem("layout",JSON.stringify(a)),t.cb();return}const e=document.querySelector("#barDock use");if(!e)return;const n={hideDock:e.getAttribute("xlink:href")==="#iconDock",layout:{},bottom:Ia(window.siyuan.layout.bottomDock),left:Ia(window.siyuan.layout.leftDock),right:Ia(window.siyuan.layout.rightDock)};Da(window.siyuan.layout.layout,n.layout),Pe().editor.forEach(a=>{cs(a.editor.protyle)}),w("/api/system/setUILayout",{layout:n,errorExit:t.errorExit},()=>{t.cb()})},_b=()=>{const t={hideDock:document.querySelector("#barDock use").getAttribute("xlink:href")==="#iconDock",layout:{},bottom:Ia(window.siyuan.layout.bottomDock),left:Ia(window.siyuan.layout.leftDock),right:Ia(window.siyuan.layout.rightDock)};return Da(window.siyuan.layout.layout,t.layout),t},Wu=t=>{t.forEach(e=>{e.hotkeyLangId&&(e.title=window.siyuan.languages[e.hotkeyLangId],e.hotkey=window.siyuan.config.keymap.general[e.hotkeyLangId].custom)})},tk=(t,e)=>{t.left.data.forEach(n=>{Wu(n)}),t.right.data.forEach(n=>{Wu(n)}),t.bottom.data.forEach(n=>{Wu(n)}),window.siyuan.layout.centerLayout=window.siyuan.layout.layout.children[0].children[1],window.siyuan.layout.leftDock=new Bu({position:"Left",data:t.left,app:e}),window.siyuan.layout.rightDock=new Bu({position:"Right",data:t.right,app:e}),window.siyuan.layout.bottomDock=new Bu({position:"Bottom",data:t.bottom,app:e})},Wo=(t,e,n)=>{let a;if(e.instance==="Layout")n?(a=new Kn({direction:e.direction,size:e.size,type:e.type,resize:e.resize}),n.addLayout(a)):window.siyuan.layout.layout=new Kn({element:document.getElementById("layouts"),direction:e.direction,size:e.size,type:e.type,resize:e.resize});else if(e.instance==="Wnd")a=new la(t,e.resize,n.type),n.addWnd(a),e.width&&(a.element.classList.remove("fn__flex-1"),a.element.style.width=e.width),e.height&&(a.element.classList.remove("fn__flex-1"),a.element.style.height=e.height);else if(e.instance==="Tab"){if(!e.title)a=ub(t);else{let i=e.title;e.lang&&(i=window.siyuan.languages[e.lang]),a=new gt({icon:e.icon,docIcon:e.docIcon,title:i})}e.pin&&(a.headElement.classList.add("item--pin"),(e.docIcon||e.icon)&&a.headElement.querySelector(".item__text").classList.add("fn__none")),e.active&&a.headElement&&a.headElement.setAttribute("data-init-active","true"),n.addTab(a,!1,!1),n.showHeading()}else e.instance==="Editor"&&e.blockId?(window.siyuan.config.fileTree.openFilesUseCurrentTab&&n.headElement.classList.add("item--unupdate"),n.headElement.setAttribute("data-initdata",JSON.stringify(e))):e.instance==="Asset"?n.addModel(new zn({app:t,tab:n,path:e.path,page:e.page})):e.instance==="Backlink"?n.addModel(new Ka({app:t,tab:n,blockId:e.blockId,rootId:e.rootId,type:e.type})):e.instance==="Bookmark"?n.addModel(new Pi(t,n)):e.instance==="Files"?n.addModel(new xa({app:t,tab:n})):e.instance==="Graph"?n.addModel(new oa({app:t,tab:n,blockId:e.blockId,rootId:e.rootId,type:e.type})):e.instance==="Outline"?n.addModel(new ja({app:t,tab:n,blockId:e.blockId,type:e.type,isPreview:e.isPreview})):e.instance==="Tag"?n.addModel(new Mi(t,n)):e.instance==="Search"?n.addModel(new Za({app:t,tab:n,config:e.config})):e.instance==="Custom"&&(window.siyuan.config.fileTree.openFilesUseCurrentTab&&n.headElement.classList.add("item--unupdate"),n.headElement.setAttribute("data-initdata",JSON.stringify(e)));e.children&&(Array.isArray(e.children)?e.children.forEach(i=>{Wo(t,i,n?a:window.siyuan.layout.layout)}):Wo(t,e.children,a))},nk=(t,e)=>{Wo(t,window.siyuan.config.uiLayout.layout,void 0),tk(window.siyuan.config.uiLayout,t),window.siyuan.config.fileTree.closeTabsOnStart&&e&&Yn().forEach(a=>{a.headElement&&!a.headElement.classList.contains("item--pin")&&a.parent.removeTab(a.id,!1,!1)}),t.plugins.forEach(a=>{Fu(a)}),document.querySelectorAll('li[data-type="tab-header"]').forEach(a=>{const i=a.getAttribute("data-initdata");if(i){const s=JSON.parse(i);if(s.instance==="Custom"&&s.customModelType!=="siyuan-card"){let o=!1;if(t.plugins.find(l=>{if(Object.keys(l.models).includes(s.customModelType))return o=!0,!0}),!o){const l=a.getAttribute("data-id"),r=Lt(l);r&&r.parent.removeTab(l,!1,!1)}}}});const n=Rw();n.id?de({app:t,id:n.id,action:n.isZoomIn?[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:n.isZoomIn}):document.querySelectorAll('li[data-type="tab-header"][data-init-active="true"]').forEach(a=>{a.removeAttribute("data-init-active"),Lt(a.getAttribute("data-id")).parent.switchTab(a,!1,!1,!0,!1)}),Ur()},Da=(t,e,n)=>{t instanceof Kn?(e.direction=t.direction,t.parent&&(t.element.classList.contains("fn__flex-1")?e.size="auto":e.size=(t.parent.direction==="tb"?t.element.clientHeight:t.element.clientWidth)+"px"),e.resize=t.resize,e.type=t.type,e.instance="Layout"):t instanceof la?(e.resize=t.resize,e.height=t.element.style.height,e.width=t.element.style.width,e.instance="Wnd"):t instanceof gt?(t.headElement&&(e.title=t.title,e.icon=t.icon,e.docIcon=t.docIcon,e.pin=t.headElement.classList.contains("item--pin"),t.model instanceof xa?e.lang="fileTree":t.model instanceof Ka&&t.model.type==="pin"?e.lang="backlinks":t.model instanceof Pi?e.lang="bookmark":t.model instanceof oa&&t.model.type!=="local"?e.lang="graphView":t.model instanceof ja&&t.model.type!=="local"?e.lang="outline":t.model instanceof Mi&&(e.lang="tag"),t.headElement.classList.contains("item--focus")&&(e.active=!0)),e.instance="Tab"):t instanceof dt?(!t.editor.protyle.notebookId&&n&&(n.editor="true"),e.notebookId=t.editor.protyle.notebookId,e.blockId=t.editor.protyle.block.id,e.rootId=t.editor.protyle.block.rootID,e.mode=t.editor.protyle.preview.element.classList.contains("fn__none")?"wysiwyg":"preview",e.action=t.editor.protyle.block.showAll?p.Constants.CB_GET_ALL:p.Constants.CB_GET_SCROLL,e.instance="Editor"):t instanceof zn?(e.path=t.path,t.pdfObject&&(e.page=t.pdfObject.page),e.instance="Asset"):t instanceof Ka?(e.blockId=t.blockId,e.rootId=t.rootId,e.type=t.type,e.instance="Backlink"):t instanceof Pi?e.instance="Bookmark":t instanceof xa?e.instance="Files":t instanceof oa?(e.blockId=t.blockId,e.rootId=t.rootId,e.type=t.type,e.instance="Graph"):t instanceof ja?(e.blockId=t.blockId,e.type=t.type,e.isPreview=t.isPreview,e.instance="Outline"):t instanceof Mi?e.instance="Tag":t instanceof Za?(e.instance="Search",e.config=t.config):t instanceof sa&&(e.instance="Custom",e.customModelType=t.type,e.customModelData=Object.assign({},t.data),delete e.customModelData.editor),t instanceof Kn||t instanceof la?t instanceof Kn&&(t.type==="bottom"||t.type==="left"||t.type==="right")?t.type==="bottom"?e.children=[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"lr",children:[]}]:e.children=[{instance:"Wnd",children:[]},{instance:"Wnd",resize:"tb",children:[]}]:(e.children=[],t.children.forEach(a=>{const i={};e.children.push(i),Da(a,i,n)})):t instanceof gt&&(t.model?(e.children={},Da(t.model,e.children,n)):t.headElement?e.children=JSON.parse(t.headElement.getAttribute("data-initdata")||"{}"):e.children={})},Ur=()=>{const t=document.querySelector("#toolbar");if(!t)return;const e=t.querySelector("#drag");e.style.padding="";const n=t.querySelector("#barMore");n.classList.remove("fn__none"),n.removeAttribute("data-hideids"),Array.from(t.querySelectorAll('[data-hide="true"]')).forEach(d=>{d.classList.remove("fn__none"),d.removeAttribute("data-hide")});let a=e.nextElementSibling;const i=[];for(;t.scrollWidth>t.clientWidth+2&&(i.push(a.id),a.classList.add("fn__none"),a.setAttribute("data-hide","true"),a=a.nextElementSibling,a.id!=="barMore"););let s=e.previousElementSibling;for(;t.scrollWidth>t.clientWidth+2&&(i.push(s.id),s.classList.add("fn__none"),s.setAttribute("data-hide","true"),s=s.previousElementSibling,s.id!=="barWorkspace"););i.length>0?n.classList.remove("fn__none"):n.classList.add("fn__none"),n.setAttribute("data-hideids",i.join(","));const o=e.clientWidth,l=e.getBoundingClientRect(),r=l.left,c=window.innerWidth-l.right;r>c&&r-c<o/3?e.style.paddingRight=r-c+"px":r<c&&c-r<o/3&&(e.style.paddingLeft=c-r+"px"),window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].forEach(d=>{t.querySelector("#"+d)?.classList.add("fn__none")})},vb=(t,e,n)=>{let a;return n.instance==="Custom"?n.customModelType==="siyuan-card"?a=ku({app:t,tab:e,data:n.customModelData}):t.plugins.find(i=>{if(i.models[n.customModelType])return a=i.models[n.customModelType]({tab:e,data:n.customModelData}),!0}):n.instance==="Editor"&&(a=new dt({app:t,tab:e,rootId:n.rootId,blockId:n.blockId,mode:n.mode,action:typeof n.action=="string"?[n.action]:n.action})),a},Hi=t=>{const e=!!t.querySelector('.layout-tab-container > [data-loading="true"]');return e&&M(window.siyuan.languages.pdfIsLoading),e},Lt=(t,e=window.siyuan.layout.centerLayout)=>{const n=(a,i)=>{if(a.id===i)return a;if(!a.children)return;let s;for(let o=0;o<a.children.length;o++)if(s=n(a.children[o],i),s)return s};return n(e,t)},Eb=t=>{if(!t.resize)return;const e=i=>{let s=227;return Array.from(i.querySelectorAll(".file-tree")).find(o=>{if((o.classList.contains("sy__backlink")||o.classList.contains("sy__graph")||o.classList.contains("sy__globalGraph")||o.classList.contains("sy__inbox"))&&!o.classList.contains("fn__none")&&!A(o,"fn__none"))return s=320,!0}),s},n=(i,s)=>{const o=(r,c)=>{r.classList.contains("fn__flex-1")&&(c==="lr"?r.style.width=r.clientWidth+"px":r.style.height=r.clientHeight+"px",r.classList.remove("fn__flex-1"))};let l;i.addEventListener("mousedown",r=>{Pe().editor.forEach(m=>{m.editor&&m.editor.protyle&&m.element.parentElement&&X(["gutter"],m.editor.protyle)}),getSelection().rangeCount>0&&(l=getSelection().getRangeAt(0));const c=document,d=i.nextElementSibling,u=i.previousElementSibling;d.style.overflow="auto",u.style.overflow="auto",!d.nextElementSibling||d.nextElementSibling.classList.contains("layout__dockresize")?o(d,s):o(u,s);const f=r[s==="lr"?"clientX":"clientY"],g=s==="lr"?u.clientWidth:u.clientHeight,h=s==="lr"?d.clientWidth:d.clientHeight;c.ondragstart=()=>(document.querySelectorAll(".sy__file .b3-list-item").forEach(m=>{m.style.opacity==="0.1"&&(m.style.opacity="")}),!1),c.onmousemove=m=>{m.preventDefault(),m.stopPropagation();const b=g+(m[s==="lr"?"clientX":"clientY"]-f),y=h-(m[s==="lr"?"clientX":"clientY"]-f);b<8||y<8||window.siyuan.layout.leftDock?.layout.element.isSameNode(u)&&b<e(u)||window.siyuan.layout.rightDock?.layout.element.isSameNode(d)&&y<e(d)||window.siyuan.layout.bottomDock?.layout.element.isSameNode(d)&&y<64||(u.classList.contains("fn__flex-1")||(u.style[s==="lr"?"width":"height"]=b+"px"),d.classList.contains("fn__flex-1")||(d.style[s==="lr"?"width":"height"]=y+"px"))},c.onmouseup=()=>{c.onmousemove=null,c.onmouseup=null,c.ondragstart=null,c.onselectstart=null,c.onselect=null,jt(),(0,I.FJ)()||(window.siyuan.layout.leftDock.setSize(),window.siyuan.layout.bottomDock.setSize(),window.siyuan.layout.rightDock.setSize()),l&&Z(l),d.style.overflow="",u.style.overflow=""}})},a=document.createElement("div");t.resize==="lr"&&a.classList.add("layout__resize--lr"),a.classList.add("layout__resize"),t.element.insertAdjacentElement("beforebegin",a),n(a,t.resize)},kb=t=>(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy,type:"submenu",submenu:Li(t)}).element),window.siyuan.menus.menu),Cs=(t,e)=>new S({label:window.siyuan.languages[t],icon:t.replace("moveTo","icon"),click:()=>{t.indexOf("moveToLeft")>-1?window.siyuan.layout.leftDock.add(t.endsWith("Top")?0:1,e):t.indexOf("moveToRight")>-1?window.siyuan.layout.rightDock.add(t.endsWith("Top")?0:1,e):t.indexOf("moveToBottom")>-1&&window.siyuan.layout.bottomDock.add(t.endsWith("Left")?0:1,e)}}),Sb=t=>(window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.append(Cs("moveToLeftTop",t).element),window.siyuan.menus.menu.append(Cs("moveToLeftBottom",t).element),window.siyuan.menus.menu.append(Cs("moveToRightTop",t).element),window.siyuan.menus.menu.append(Cs("moveToRightBottom",t).element),window.siyuan.menus.menu.append(Cs("moveToBottomLeft",t).element),window.siyuan.menus.menu.append(Cs("moveToBottomRight",t).element),window.siyuan.menus.menu),ak=t=>{const e=[],n=[],a=[];let i=-1;t.parent.children.forEach((s,o)=>{const l=s.model;(!l||l.editor?.protyle&&!l.editor?.protyle.updated)&&e.push(s),s.id===t.id&&(i=o),i===-1?n.push(s):o>i&&a.push(s)}),window.siyuan.menus.menu.append(new S({icon:"iconClose",label:window.siyuan.languages.close,accelerator:window.siyuan.config.keymap.general.closeTab.custom,click:()=>{t.parent.removeTab(t.id)}}).element),t.parent.children.length>1&&(window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.closeOthers,accelerator:window.siyuan.config.keymap.general.closeOthers.custom,click(){ca(t,"closeOthers")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.closeAll,accelerator:window.siyuan.config.keymap.general.closeAll.custom,click(){ca(t,"closeAll")}}).element),e.length>0&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.closeUnmodified,accelerator:window.siyuan.config.keymap.general.closeUnmodified.custom,click(){ca(t,"other",e)}}).element),n.length>0&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.closeLeft,accelerator:window.siyuan.config.keymap.general.closeLeft.custom,click:async()=>{ca(t,"other",n)}}).element),a.length>0&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.closeRight,accelerator:window.siyuan.config.keymap.general.closeRight.custom,click(){ca(t,"other",a)}}).element)),window.siyuan.menus.menu.append(new S({type:"separator"}).element)},ik=(t,e)=>{const n=[{icon:"iconSplitLR",accelerator:window.siyuan.config.keymap.general.splitLR.custom,label:window.siyuan.languages.splitLR,click:()=>{e.parent.split("lr").addTab(qr(t,e))}}];e.parent.children.length>1&&n.push({icon:"iconLayoutRight",accelerator:window.siyuan.config.keymap.general.splitMoveR.custom,label:window.siyuan.languages.splitMoveR,click:()=>{const i=e.parent.split("lr");i.headersElement.append(e.headElement),i.headersElement.parentElement.classList.remove("fn__none"),i.moveTab(e),jt()}}),n.push({icon:"iconSplitTB",accelerator:window.siyuan.config.keymap.general.splitTB.custom,label:window.siyuan.languages.splitTB,click:()=>{e.parent.split("tb").addTab(qr(t,e))}}),e.parent.children.length>1&&n.push({icon:"iconLayoutBottom",accelerator:window.siyuan.config.keymap.general.splitMoveB.custom,label:window.siyuan.languages.splitMoveB,click:()=>{const i=e.parent.split("tb");i.headersElement.append(e.headElement),i.headersElement.parentElement.classList.remove("fn__none"),i.moveTab(e),jt()}});let a=[];return Pr(window.siyuan.layout.centerLayout,a),a.length>1&&(n.push({label:window.siyuan.languages.unsplit,click:()=>{let i=e.parent.parent;for(;i.id!==window.siyuan.layout.centerLayout.id&&(a=[],Pr(i,a),!(a.length>1));)i=i.parent;Vu(e.parent.parent.children[0],i,!0),jt()}}),n.push({label:window.siyuan.languages.unsplitAll,click:()=>{Vu(window.siyuan.layout.centerLayout,window.siyuan.layout.centerLayout,!1),jt()}})),n},Lb=(t,e)=>{window.siyuan.menus.menu.remove(),ak(e),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.split,submenu:ik(t,e)}).element);const n=e.model;let a;if(n&&n instanceof dt)a=n.editor.protyle.block.rootID;else{const i=e.headElement.getAttribute("data-initdata");if(i){const s=JSON.parse(i);s&&s.instance==="Editor"&&(a=s.rootId||s.blockId)}}return a&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.copy,icon:"iconCopy",type:"submenu",submenu:Li(a,!1)}).element),e.headElement.classList.contains("item--pin")?window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.unpin,icon:"iconUnpin",click:()=>{e.unpin()}}).element):window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.pin,icon:"iconPin",click:()=>{e.pin()}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.tabToWindow,accelerator:window.siyuan.config.keymap.general.tabToWindow.custom,icon:"iconOpenWindow",click:()=>{pa(e)}}).element),window.siyuan.menus.menu},Vu=(t,e,n)=>{let a=t;for(;a instanceof Kn;)a=a.children[0];for(let i=0;i<e.children.length;i++){const s=e.children[i];if(s instanceof Kn&&!n)Vu(a,s,n);else if(s instanceof la&&s.id!==a.id&&s.children.length>0){for(let o=0;o<s.children.length;o++){const l=s.children[o];a.headersElement.append(l.headElement),a.moveTab(l),o--}i--}}};class sk{constructor(e){this.menu=new Yw,window.addEventListener("contextmenu",n=>{if(n.shiftKey)return;let a=n.target;for(;a&&a.parentElement&&!a.parentElement.isEqualNode(document.querySelector("body"));){n.preventDefault();const i=a.getAttribute("data-type");if(i==="tab-header"){this.unselect(),Lb(e,Lt(a.getAttribute("data-id"))).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}if(i==="navigation-root"&&!window.siyuan.config.readonly){if(a.querySelector(".b3-list-item__text").classList.contains("ft__on-surface"))return;this.unselect(),hr(e,a).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}if(i==="navigation-file"){this.unselect(),mr(e,this.getDir(a),a.getAttribute("data-path"),a).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}if(i==="search-item"){const s=a.getAttribute("data-node-id");s&&kb(s).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}if(a.classList.contains("dock__item")&&a.getAttribute("data-type")){Sb(a).popup({x:n.clientX,y:n.clientY}),n.stopPropagation();break}a=a.parentElement}},!1)}getDir(e){const n=xt(e,"UL");if(n)return n.getAttribute("data-url")}unselect(){getSelection().rangeCount>0&&getSelection().getRangeAt(0).collapse(!0)}}const ok=t=>{const e=Lt(t.data);e&&e instanceof gt&&e.parent.removeTab(t.data)},lk=t=>{switch(t.cmd){case"closetab":ok(t);break;case"lockscreen":It({errorExit:!1,cb(){w("/api/system/logoutAuth",{},()=>{Pf()})}});break;case"lockscreenByMode":window.siyuan.config.system.lockScreenMode===1&&It({errorExit:!1,cb(){w("/api/system/logoutAuth",{},()=>{Pf()})}});break}},Oe={element:void 0,setReadonly:t=>{window.siyuan.config.editor.readOnly=t,w("/api/setting/setEditor",window.siyuan.config.editor)},genHTML:()=>{let t="";return t='<select id="fontFamily" class="b3-select fn__flex-center fn__size200"></select>',`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fullWidth}
        <div class="b3-label__text">${window.siyuan.languages.fullWidthTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="fullWidth" type="checkbox"${window.siyuan.config.editor.fullWidth?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.justify}
        <div class="b3-label__text">${window.siyuan.languages.justifyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="justify" type="checkbox"${window.siyuan.config.editor.justify?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.rtl}
        <div class="b3-label__text">${window.siyuan.languages.rtlTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="rtl" type="checkbox"${window.siyuan.config.editor.rtl?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.editReadonly} 
        <code class="fn__code">${K(window.siyuan.config.keymap.general.editReadonly.custom)}</code>
        <div class="b3-label__text">${window.siyuan.languages.editReadonlyTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="readOnly" type="checkbox"${window.siyuan.config.editor.readOnly?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md12}
        <div class="b3-label__text">${window.siyuan.languages.md16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayBookmarkIcon" type="checkbox"${window.siyuan.config.editor.displayBookmarkIcon?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md7}
        <div class="b3-label__text">${window.siyuan.languages.md8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="displayNetImgMark" type="checkbox"${window.siyuan.config.editor.displayNetImgMark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.embedBlockBreadcrumb}
        <div class="b3-label__text">${window.siyuan.languages.embedBlockBreadcrumbTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="embedBlockBreadcrumb" type="checkbox"${window.siyuan.config.editor.embedBlockBreadcrumb?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.floatWindowMode}
        <div class="b3-label__text">${window.siyuan.languages.floatWindowModeTip.replace("${hotkey}",K("\u2318"))}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="floatWindowMode" type="checkbox"${window.siyuan.config.editor.floatWindowMode===0?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.outlineOutdent}
        <div class="b3-label__text">${window.siyuan.languages.outlineOutdentTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="listLogicalOutdent" type="checkbox"${window.siyuan.config.editor.listLogicalOutdent?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.spellcheck}
        <div class="b3-label__text">${window.siyuan.languages.spellcheckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="spellcheck" type="checkbox"${window.siyuan.config.editor.spellcheck?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.onlySearchForDoc}
        <div class="b3-label__text">${window.siyuan.languages.onlySearchForDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="onlySearchForDoc" type="checkbox"${window.siyuan.config.editor.onlySearchForDoc?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md31}
        <div class="b3-label__text">${window.siyuan.languages.md32}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLineWrap" type="checkbox"${window.siyuan.config.editor.codeLineWrap?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md2}
        <div class="b3-label__text">${window.siyuan.languages.md3}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeLigatures" type="checkbox"${window.siyuan.config.editor.codeLigatures?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md27}
        <div class="b3-label__text">${window.siyuan.languages.md28}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="codeSyntaxHighlightLineNum" type="checkbox"${window.siyuan.config.editor.codeSyntaxHighlightLineNum?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md33}
        <div class="b3-label__text">${window.siyuan.languages.md34}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="virtualBlockRef" type="checkbox"${window.siyuan.config.editor.virtualBlockRef?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md9}
        <div class="b3-label__text">${window.siyuan.languages.md36}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="virtualBlockRefInclude" value="${window.siyuan.config.editor.virtualBlockRefInclude}" />
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md35}
        <div class="b3-label__text">${window.siyuan.languages.md36}</div>
        <div class="b3-label__text">${window.siyuan.languages.md41}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="virtualBlockRefExclude" value="${window.siyuan.config.editor.virtualBlockRefExclude}" />
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md39}
        <div class="b3-label__text">${window.siyuan.languages.md40}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="plantUMLServePath" value="${window.siyuan.config.editor.plantUMLServePath}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.dynamicLoadBlocks}
        <div class="b3-label__text">${window.siyuan.languages.dynamicLoadBlocksTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="dynamicLoadBlocks" type="number" min="48" max="1024" value="${window.siyuan.config.editor.dynamicLoadBlocks}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md37}
        <div class="b3-label__text">${window.siyuan.languages.md38}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="blockRefDynamicAnchorTextMaxLen" type="number" min="1" max="5120" value="${window.siyuan.config.editor.blockRefDynamicAnchorTextMaxLen}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backlinkExpand}
        <div class="b3-label__text">${window.siyuan.languages.backlinkExpandTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="backlinkExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backlinkExpandCount}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.backmentionExpand}
        <div class="b3-label__text">${window.siyuan.languages.backmentionExpandTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="backmentionExpandCount" type="number" min="0" max="512" value="${window.siyuan.config.editor.backmentionExpandCount}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateHistory}
        <div class="b3-label__text">${window.siyuan.languages.generateHistoryInterval}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="generateHistoryInterval" type="number" min="0" max="120" value="${window.siyuan.config.editor.generateHistoryInterval}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.historyRetentionDays} 
        <a href="javascript:void(0)" id="clearHistory">${window.siyuan.languages.clearHistory}</a>
        <div class="b3-label__text">${window.siyuan.languages.historyRetentionDaysTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="historyRetentionDays" type="number" min="0" value="${window.siyuan.config.editor.historyRetentionDays}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.font}
        <div class="b3-label__text">${window.siyuan.languages.font1}</div>
    </div>
    <span class="fn__space"></span>
    ${t}
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fontSizeScrollZoom}
        <div class="b3-label__text">${window.siyuan.languages.fontSizeScrollZoomTip.replace("Ctrl",K("\u2318"))}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="fontSizeScrollZoom" type="checkbox"${window.siyuan.config.editor.fontSizeScrollZoom?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fontSize}
        <div class="b3-label__text">${window.siyuan.languages.fontSizeTip}</div>
    </div>
    <span class="fn__space"></span>
    <div class="b3-tooltips b3-tooltips__n fn__flex-center" aria-label="${window.siyuan.config.editor.fontSize}">   
        <input class="b3-slider fn__size200" id="fontSize" max="72" min="9" step="1" type="range" value="${window.siyuan.config.editor.fontSize}">
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.md29}
        <div class="b3-label__text">${window.siyuan.languages.md30}</div>
    </div>
    <span class="fn__space"></span>
    <div class="b3-tooltips b3-tooltips__n fn__flex-center" aria-label="${window.siyuan.config.editor.codeTabSpaces}">   
        <input class="b3-slider fn__size200" id="codeTabSpaces" max="8" min="0" step="2" type="range" value="${window.siyuan.config.editor.codeTabSpaces}">
    </div>
</div>
<div class="b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.katexMacros}
        <div class="b3-label__text">${window.siyuan.languages.katexMacrosTip}</div>
        <div class="fn__hr"></div>
        <textarea class="b3-text-field fn__block" id="katexMacros" spellcheck="false">${window.siyuan.config.editor.katexMacros}</textarea>
    </div>
</div>`},bindEvent:()=>{const t=Oe.element.querySelector("#fontFamily");if(t.tagName==="SELECT"){let n=`<option value="">${window.siyuan.languages.default}</option>`;w("/api/system/getSysFonts",{},a=>{a.data.forEach(i=>{n+=`<option value="${i}"${window.siyuan.config.editor.fontFamily===i?" selected":""}>${i}</option>`}),t.innerHTML=n})}Oe.element.querySelector("#clearHistory").addEventListener("click",()=>{Ne(window.siyuan.languages.clearHistory,window.siyuan.languages.confirmClearHistory,()=>{w("/api/history/clearWorkspaceHistory",{})})});const e=()=>{let n=parseInt(Oe.element.querySelector("#dynamicLoadBlocks").value);48>n&&(n=48,Oe.element.querySelector("#dynamicLoadBlocks").value="48"),1024<n&&(n=1024,Oe.element.querySelector("#dynamicLoadBlocks").value="1024"),w("/api/setting/setEditor",{fullWidth:Oe.element.querySelector("#fullWidth").checked,justify:Oe.element.querySelector("#justify").checked,rtl:Oe.element.querySelector("#rtl").checked,readOnly:Oe.element.querySelector("#readOnly").checked,displayBookmarkIcon:Oe.element.querySelector("#displayBookmarkIcon").checked,displayNetImgMark:Oe.element.querySelector("#displayNetImgMark").checked,codeSyntaxHighlightLineNum:Oe.element.querySelector("#codeSyntaxHighlightLineNum").checked,embedBlockBreadcrumb:Oe.element.querySelector("#embedBlockBreadcrumb").checked,listLogicalOutdent:Oe.element.querySelector("#listLogicalOutdent").checked,spellcheck:Oe.element.querySelector("#spellcheck").checked,onlySearchForDoc:Oe.element.querySelector("#onlySearchForDoc").checked,floatWindowMode:Oe.element.querySelector("#floatWindowMode").checked?0:1,plantUMLServePath:Oe.element.querySelector("#plantUMLServePath").value,katexMacros:Oe.element.querySelector("#katexMacros").value,codeLineWrap:Oe.element.querySelector("#codeLineWrap").checked,virtualBlockRef:Oe.element.querySelector("#virtualBlockRef").checked,virtualBlockRefInclude:Oe.element.querySelector("#virtualBlockRefInclude").value,virtualBlockRefExclude:Oe.element.querySelector("#virtualBlockRefExclude").value,blockRefDynamicAnchorTextMaxLen:parseInt(Oe.element.querySelector("#blockRefDynamicAnchorTextMaxLen").value),backlinkExpandCount:parseInt(Oe.element.querySelector("#backlinkExpandCount").value),backmentionExpandCount:parseInt(Oe.element.querySelector("#backmentionExpandCount").value),dynamicLoadBlocks:n,codeLigatures:Oe.element.querySelector("#codeLigatures").checked,codeTabSpaces:parseInt(Oe.element.querySelector("#codeTabSpaces").value),fontSize:parseInt(Oe.element.querySelector("#fontSize").value),fontSizeScrollZoom:Oe.element.querySelector("#fontSizeScrollZoom").checked,generateHistoryInterval:parseInt(Oe.element.querySelector("#generateHistoryInterval").value),historyRetentionDays:parseInt(Oe.element.querySelector("#historyRetentionDays").value),fontFamily:t.value,emoji:window.siyuan.config.editor.emoji},a=>{Oe._onSetEditor(a.data)})};Oe.element.querySelectorAll("input.b3-switch, select.b3-select, input.b3-slider").forEach(n=>{n.addEventListener("change",()=>{e()})}),Oe.element.querySelectorAll("textarea.b3-text-field, input.b3-text-field, input.b3-slider").forEach(n=>{n.addEventListener("blur",()=>{e()})}),Oe.element.querySelectorAll("input.b3-slider").forEach(n=>{n.addEventListener("input",a=>{const i=a.target;i.parentElement.setAttribute("aria-label",i.value)})})},_onSetEditor:t=>{t.readOnly!==window.siyuan.config.editor.readOnly&&Oe.setReadonly(t.readOnly),window.siyuan.config.editor=t,Pe().editor.forEach(n=>{na(n.editor.protyle,!1);let a=n.editor.protyle.wysiwyg.element.getAttribute(p.Constants.CUSTOM_SY_FULLWIDTH);a||(a=window.siyuan.config.editor.fullWidth?"true":"false"),!(a==="true"&&n.editor.protyle.contentElement.getAttribute("data-fullwidth")==="true")&&(qt(n.editor.protyle),a==="true"?n.editor.protyle.contentElement.setAttribute("data-fullwidth","true"):n.editor.protyle.contentElement.removeAttribute("data-fullwidth"))}),ko()}},_t={element:void 0,genHTML:()=>`<label class="fn__flex b3-label${(0,I.jU)()||window.siyuan.config.system.isMicrosoftStore||window.siyuan.config.system.container!=="std"||window.siyuan.config.system.os==="linux"?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.autoLaunch}
        <div class="b3-label__text">${window.siyuan.languages.autoLaunchTip}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="autoLaunch" type="checkbox"${window.siyuan.config.system.autoLaunch?" checked":""}>
</label>
<label class="fn__flex b3-label${(0,I.jU)()||window.siyuan.config.system.isMicrosoftStore||window.siyuan.config.system.container!=="std"?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.autoDownloadUpdatePkg}
        <div class="b3-label__text">${window.siyuan.languages.autoDownloadUpdatePkgTip}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="downloadInstallPkg" type="checkbox"${window.siyuan.config.system.downloadInstallPkg?" checked":""}>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.googleAnalytics}
        <div class="b3-label__text">${window.siyuan.languages.googleAnalyticsTip}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="googleAnalytics" type="checkbox"${window.siyuan.config.system.disableGoogleAnalytics?"":" checked"}>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about9}
        <div class="b3-label__text">${window.siyuan.languages.about10}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="uploadErrLog" type="checkbox"${window.siyuan.config.system.uploadErrLog?" checked":""}>
</label>
<label class="b3-label fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about11}
        <div class="b3-label__text">${window.siyuan.languages.about12}</div>
    </div>
    <div class="fn__space"></div>
    <input class="b3-switch fn__flex-center" id="networkServe" type="checkbox"${window.siyuan.config.system.networkServe?" checked":""}>
</label>
<div class="b3-label${window.siyuan.config.readonly||(0,I.jU)()&&!Bt()&&!at()&&!ht()?" fn__none":""}">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.about5}
            <div class="b3-label__text">${window.siyuan.languages.about6}</div>
        </div>
        <div class="fn__space"></div>
        <button class="fn__flex-center b3-button b3-button--outline fn__size200" id="authCode">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
    <label class="b3-label fn__flex${!window.siyuan.config.accessAuthCode||(0,I.jU)()?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.about7}
            <div class="b3-label__text">${window.siyuan.languages.about8}</div>
        </div>
        <div class="fn__space"></div>
        <input class="b3-switch fn__flex-center" id="lockScreenMode" type="checkbox"${window.siyuan.config.system.lockScreenMode===1?" checked":""}>
    </label>
</div>
<div class="b3-label config__item${(0,I.jU)()&&!at()?" fn__none":" fn__flex"}">
    <div class="fn__flex-1">
       ${window.siyuan.languages.about2}
        <div class="b3-label__text">${window.siyuan.languages.about3.replace("${port}",location.port)}</div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(t=>!(t.startsWith("[")&&t.endsWith("]"))).join("</code> <code class='fn__code'>")}</code></div>
        <div class="b3-label__text"><code class="fn__code">${window.siyuan.config.localIPs.filter(t=>t.startsWith("[")&&t.endsWith("]")).join("</code> <code class='fn__code'>")}</code></div>
        <div class="b3-label__text">${window.siyuan.languages.about18}</div>
    </div>
    <div class="fn__space"></div>
    <button data-type="open" data-url="http://${window.siyuan.config.system.networkServe?window.siyuan.config.localIPs[0]:"127.0.0.1"}:${location.port}" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconLink"></use></svg>${window.siyuan.languages.about4}
    </button>
</div>
<div class="b3-label fn__flex config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.dataRepoKey}
        <div class="b3-label__text">${window.siyuan.languages.dataRepoKeyTip1}</div>
        <div class="b3-label__text"><span class="ft__error">${window.siyuan.languages.dataRepoKeyTip2}</span></div>
    </div>
    <div class="fn__space"></div>
    <div class="fn__size200 config__item-line fn__flex-center${window.siyuan.config.repo.key?" fn__none":""}">
        <button class="b3-button b3-button--outline fn__block" id="importKey">
            <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.importKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKey">
            <svg><use xlink:href="#iconLock"></use></svg>${window.siyuan.languages.genKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="initKeyByPW">
            <svg><use xlink:href="#iconHand"></use></svg>${window.siyuan.languages.genKeyByPW}
        </button>
    </div>
    <div class="fn__size200 config__item-line fn__flex-center${window.siyuan.config.repo.key?"":" fn__none"}">
        <button class="b3-button b3-button--outline fn__block" id="copyKey">
            <svg><use xlink:href="#iconCopy"></use></svg>${window.siyuan.languages.copyKey}
        </button>
        <div class="fn__hr"></div>
        <button class="b3-button b3-button--outline fn__block" id="resetRepo">
            <svg><use xlink:href="#iconUndo"></use></svg>${window.siyuan.languages.resetRepo}
        </button>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.dataRepoPurge}
        <div class="b3-label__text">${window.siyuan.languages.dataRepoPurgeTip}</div>
    </div>
    <div class="fn__space"></div>
    <button id="purgeRepo" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconTrashcan"></use></svg>${window.siyuan.languages.purge}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.systemLog}
        <div class="b3-label__text">${window.siyuan.languages.systemLogTip}</div>
    </div>
    <div class="fn__space"></div>
    <button id="exportLog" class="b3-button b3-button--outline fn__size200 fn__flex-center">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.currentVer} v${p.Constants.SIYUAN_VERSION}
        <span id="isInsider"></span>
        <div class="b3-label__text">${window.siyuan.languages.downloadLatestVer}</div>
    </div>
    <div class="fn__space"></div>
    <div class="fn__flex-center fn__size200 config__item-line">
        <button id="checkUpdateBtn" class="b3-button b3-button--outline fn__block">
            <svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}
        </button>
    </div>
</div>
<div class="fn__flex config__item  b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.about13}
         <div class="b3-label__text">${window.siyuan.languages.about14}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="token" value="${window.siyuan.config.api.token}">
</div>
<div class="b3-label${window.siyuan.config.system.container==="std"||window.siyuan.config.system.container==="docker"?"":" fn__none"}">
    ${window.siyuan.languages.networkProxy}
    <div class="b3-label__text">
        ${window.siyuan.languages.about17}
    </div>
    <div class="b3-label__text fn__flex config__item" style="padding: 4px 0 4px 4px;">
        <select id="aboutScheme" class="b3-select">
            <option value="" ${window.siyuan.config.system.networkProxy.scheme===""?"selected":""}>${window.siyuan.languages.directConnection}</option>
            <option value="socks5" ${window.siyuan.config.system.networkProxy.scheme==="socks5"?"selected":""}>SOCKS5</option>
            <option value="https" ${window.siyuan.config.system.networkProxy.scheme==="https"?"selected":""}>HTTPS</option>
            <option value="http" ${window.siyuan.config.system.networkProxy.scheme==="http"?"selected":""}>HTTP</option>
        </select>
        <span class="fn__space"></span>
        <input id="aboutHost" placeholder="Host/IP" class="b3-text-field fn__block" value="${window.siyuan.config.system.networkProxy.host}"/>
        <span class="fn__space"></span>
        <input id="aboutPort" placeholder="Port" class="b3-text-field fn__block" value="${window.siyuan.config.system.networkProxy.port}" type="number"/>
        <span class="fn__space"></span>
        <button id="aboutConfirm" class="b3-button fn__size200 b3-button--outline">${window.siyuan.languages.confirm}</button>
    </div>
</div>
<div class="b3-label">
    <div class="config-about__logo">
        <img src="/stage/icon.png">
        <span>${window.siyuan.languages.siyuanNote}</span>
        <span class="fn__space"></span>
        <span class="ft__on-surface">${window.siyuan.languages.slogan}</span>
        <span class="fn__space"></span>
        <span style="color:var(--b3-theme-background);font-family: cursive;">\u4F1A\u6CFD\u767E\u5BB6&nbsp;\u81F3\u516C\u5929\u4E0B</span>
    </div>
    <div class='fn__hr'></div>
    ${window.siyuan.languages.about1}
</div>`,bindEvent:()=>{window.siyuan.config.system.isInsider&&(_t.element.querySelector("#isInsider").innerHTML="<span class='ft__secondary'>Insider Preview</span>");const t=_t.element.querySelector("#token");t.addEventListener("click",()=>{t.select()}),t.addEventListener("change",()=>{w("/api/system/setAPIToken",{token:t.value},()=>{window.siyuan.config.api.token=t.value})}),_t.element.querySelector("#exportLog").addEventListener("click",()=>{w("/api/system/exportLog",{},c=>{Ee(c.data.zip)})});const e=_t.element.querySelector("#checkUpdateBtn");e.addEventListener("click",()=>{e.firstElementChild.classList.contains("fn__rotate")||(e.innerHTML=`<svg class="fn__rotate"><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}`,w("/api/system/checkUpdate",{showMsg:!0},()=>{e.innerHTML=`<svg><use xlink:href="#iconRefresh"></use></svg>${window.siyuan.languages.checkUpdate}`}))}),_t.element.querySelectorAll('[data-type="open"]').forEach(c=>{c.addEventListener("click",()=>{const d=c.getAttribute("data-url");d.startsWith("http")?te.shell.openExternal(d):te.shell.openPath(d)})}),_t.element.querySelector("#authCode").addEventListener("click",()=>{wy()});const n=_t.element.querySelector("#importKey");n.addEventListener("click",()=>{const c=new me({title:"\u{1F511} "+window.siyuan.languages.key,content:`<div class="b3-dialog__content">
    <textarea class="b3-text-field fn__block" placeholder="${window.siyuan.languages.keyPlaceholder}"></textarea>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"}),d=c.element.querySelector("textarea");d.focus();const u=c.element.querySelectorAll(".b3-button");u[0].addEventListener("click",()=>{c.destroy()}),u[1].addEventListener("click",()=>{w("/api/repo/importRepoKey",{key:d.value},()=>{window.siyuan.config.repo.key=d.value,n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none"),c.destroy()})})}),_t.element.querySelector("#initKey").addEventListener("click",()=>{Ne("\u{1F511} "+window.siyuan.languages.genKey,window.siyuan.languages.initRepoKeyTip,()=>{w("/api/repo/initRepoKey",{},c=>{window.siyuan.config.repo.key=c.data.key,n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none")})})}),_t.element.querySelector("#initKeyByPW").addEventListener("click",()=>{Hb(!1,()=>{n.parentElement.classList.add("fn__none"),n.parentElement.nextElementSibling.classList.remove("fn__none")})}),_t.element.querySelector("#copyKey").addEventListener("click",()=>{M(window.siyuan.languages.copied),G(window.siyuan.config.repo.key)}),_t.element.querySelector("#resetRepo").addEventListener("click",()=>{Ne("\u26A0\uFE0F "+window.siyuan.languages.resetRepo,window.siyuan.languages.resetRepoTip,()=>{w("/api/repo/resetRepo",{},()=>{window.siyuan.config.repo.key="",window.siyuan.config.sync.enabled=!1,ra(),n.parentElement.classList.remove("fn__none"),n.parentElement.nextElementSibling.classList.add("fn__none")})})}),_t.element.querySelector("#purgeRepo").addEventListener("click",()=>{Ne("\u267B\uFE0F "+window.siyuan.languages.dataRepoPurge,window.siyuan.languages.dataRepoPurgeConfirm,()=>{w("/api/repo/purgeRepo")})});const a=_t.element.querySelector("#networkServe");a.addEventListener("change",()=>{w("/api/system/setNetworkServe",{networkServe:a.checked},()=>{It({errorExit:!0,cb:Ss})})});const i=_t.element.querySelector("#lockScreenMode");i.addEventListener("change",()=>{w("/api/system/setFollowSystemLockScreen",{lockScreenMode:i.checked?1:0},()=>{window.siyuan.config.system.lockScreenMode=i.checked?1:0})});const s=_t.element.querySelector("#googleAnalytics");s.addEventListener("change",()=>{w("/api/system/setGoogleAnalytics",{googleAnalytics:s.checked},()=>{It({errorExit:!1,cb(){window.location.reload()}})})});const o=_t.element.querySelector("#uploadErrLog");o.addEventListener("change",()=>{w("/api/system/setUploadErrLog",{uploadErrLog:o.checked},()=>{It({errorExit:!0,cb:Ss})})});const l=_t.element.querySelector("#downloadInstallPkg");l.addEventListener("change",()=>{w("/api/system/setDownloadInstallPkg",{downloadInstallPkg:l.checked},()=>{window.siyuan.config.system.downloadInstallPkg=l.checked})});const r=_t.element.querySelector("#autoLaunch");r.addEventListener("change",()=>{w("/api/system/setAutoLaunch",{autoLaunch:r.checked},()=>{window.siyuan.config.system.autoLaunch=r.checked,te.ipcRenderer.send(p.Constants.SIYUAN_AUTO_LAUNCH,{openAtLogin:r.checked})})}),_t.element.querySelector("#aboutConfirm").addEventListener("click",()=>{const c=_t.element.querySelector("#aboutScheme").value,d=_t.element.querySelector("#aboutHost").value,u=_t.element.querySelector("#aboutPort").value;w("/api/system/setNetworkProxy",{scheme:c,host:d,port:u},async()=>{window.siyuan.config.system.networkProxy.scheme=c,window.siyuan.config.system.networkProxy.host=d,window.siyuan.config.system.networkProxy.port=u,te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"setProxy",proxyURL:`${window.siyuan.config.system.networkProxy.scheme}://${window.siyuan.config.system.networkProxy.host}:${window.siyuan.config.system.networkProxy.port}`}).then(()=>{It({errorExit:!1,cb(){window.location.reload()}})})})})}},Pn={element:void 0,genHTML:()=>`<div class="fn__flex-column" style="height: 100%">
    <div class="layout-tab-bar fn__flex">
        <div class="item item--full item--focus" data-type="remove">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.unreferencedAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
        <div class="item item--full" data-type="missing">
            <span class="fn__flex-1"></span>
            <span class="item__text">${window.siyuan.languages.missingAssets}</span>
            <span class="fn__flex-1"></span>
        </div>
    </div>
    <div class="fn__flex-1">
        <div class="config-assets" data-type="remove" data-init="true">
            <div class="fn__hr--b"></div>
            <label class="fn__flex">
                <div class="fn__space"></div>
                <button id="removeAll" class="b3-button b3-button--outline fn__flex-center fn__size200">
                    <svg class="svg"><use xlink:href="#iconTrashcan"></use></svg>
                    ${window.siyuan.languages.delete}
                </button>
            </label>
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="config-assets__preview"></div>
        </div>
        <div class="fn__none config-assets" data-type="missing">
            <div class="fn__hr"></div>
            <ul class="b3-list b3-list--background config-assets__list">
                <li class="fn__loading"><img src="/stage/loading-pure.svg"></li>
            </ul>
            <div class="fn__hr"></div>
        </div>
    </div>
</div>`,bindEvent:()=>{const t=Pn.element.querySelector(".config-assets__list");Pn.element.addEventListener("click",e=>{let n=e.target;for(;n&&!n.isEqualNode(Pn.element);){const a=n.getAttribute("data-type");if(n.id==="removeAll")Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.clearAll}`,()=>{w("/api/asset/removeUnusedAssets",{},i=>{Pe().asset.forEach(s=>{i.data.paths.includes(s.path)&&s.parent.close()}),t.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`,Pn.element.querySelector(".config-assets__preview").innerHTML=""})});else if(n.classList.contains("item")&&!n.classList.contains("item--focus")){Pn.element.querySelector(".layout-tab-bar .item--focus").classList.remove("item--focus"),n.classList.add("item--focus"),Pn.element.querySelectorAll(".config-assets").forEach(i=>{a===i.getAttribute("data-type")?(i.classList.remove("fn__none"),i.getAttribute("data-init")||(w("/api/asset/getMissingAssets",{},s=>{Pn._renderList(s.data.missingAssets,i.querySelector(".config-assets__list"),!1)}),i.setAttribute("data-init","true"))):i.classList.add("fn__none")}),e.preventDefault(),e.stopPropagation();break}else if(a==="copy")G(n.parentElement.querySelector(".b3-list-item__text").textContent.trim());else if(a==="open")fn(n.parentElement.getAttribute("data-path"),"folder");else if(a==="clear"){const i=n.parentElement.getAttribute("data-path");Ne(window.siyuan.languages.deleteOpConfirm,`${window.siyuan.languages.delete} <b>${Le().basename(i)}</b>`,()=>{w("/api/asset/removeUnusedAsset",{path:i},s=>{Pe().asset.forEach(l=>{s.data.path===l.path&&l.parent.parent.removeTab(l.parent.id)});const o=n.parentElement;o.parentElement.querySelectorAll("li").length===1?o.parentElement.innerHTML=`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`:o.remove(),Pn.element.querySelector(".config-assets__preview").innerHTML=""})}),e.preventDefault(),e.stopPropagation();break}n=n.parentElement}}),t.addEventListener("mouseover",e=>{const n=A(e.target,"b3-list-item");if(n&&n.getAttribute("data-path")!==t.nextElementSibling.getAttribute("data-path")){const a=n.getAttribute("data-path");t.nextElementSibling.setAttribute("data-path",a),t.nextElementSibling.innerHTML=_i(a)}}),w("/api/asset/getUnusedAssets",{},e=>{Pn._renderList(e.data.unusedAssets,t)})},_renderList:(t,e,n=!0)=>{let a="",i="";!(0,I.jU)()&&n&&(i=`<span data-type="open" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.showInFolder}">
    <svg><use xlink:href="#iconFolder"></use></svg>
</span>`);let s="";n?s=`<span data-type="clear" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span>`:s=`<span data-type="copy" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.copy}">
    <svg><use xlink:href="#iconCopy"></use></svg>
</span>`,t.forEach(o=>{const l=o.indexOf("assets/"),r=o.substr(l);a+=`<li data-path="${r}"  class="b3-list-item b3-list-item--hide-action">
    <span class="b3-list-item__text">${we(o)}</span>
    ${i}
    ${s}
</li>`}),e.innerHTML=a||`<li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li>`}};let Me;const rk=t=>{let e,n;document.addEventListener("mouseover",a=>{if(!window.siyuan.config)return;const i=q(a.target,"data-type","a",!0)||q(a.target,"data-type","tab-header")||A(a.target,"av__celltext")||A(a.target,"ariaLabel")||q(a.target,"data-type","inline-memo");if(i){let s=i.getAttribute("aria-label")||i.getAttribute("data-inline-memo-content");if(i.classList.contains("av__celltext"))if(i.offsetWidth>i.parentElement.clientWidth-5)i.querySelector(".av__cellicon")?s=`${i.firstChild.textContent} \u2192 ${i.lastChild.textContent}`:s=i.textContent;else return;if(!s){s=i.getAttribute("data-href")?.substring(0,p.Constants.SIZE_TITLE)||"";const o=i.getAttribute("data-title");o&&(s+="<br>"+o)}if(s&&!s.startsWith("siyuan://blocks")&&!i.classList.contains("b3-tooltips")){ql(s,i),a.stopPropagation();return}}else if(!i){const s=q(a.target,"id","tooltip",!0);(!s||s&&s.clientHeight>=s.scrollHeight&&s.clientWidth>=s.scrollWidth)&&hn()}if(window.siyuan.config.editor.floatWindowMode===1||window.siyuan.shiftIsPressed){if(clearTimeout(n),n=window.setTimeout(()=>{Cb(a)},p.Constants.TIMEOUT_INPUT),!xb(a,i)||a.relatedTarget&&!document.contains(a.relatedTarget))return;window.siyuan.ctrlIsPressed?(clearTimeout(n),Vo(t)):window.siyuan.shiftIsPressed&&(clearTimeout(n),Vo(t,!0));return}clearTimeout(e),clearTimeout(n),n=window.setTimeout(()=>{Cb(a)&&!Me&&!i&&clearTimeout(e)},p.Constants.TIMEOUT_INPUT),e=window.setTimeout(()=>{xb(a,i)&&(clearTimeout(n),Vo(t))},620)})},Cb=t=>{const e=document.elementFromPoint(t.clientX,t.clientY);if(!e||A(e,"b3-menu")||e.id&&e.tagName!=="svg"&&(e.id.startsWith("minder_node")||e.id.startsWith("kity_")||e.id.startsWith("node_"))||e.classList.contains("counter")||e.tagName==="circle")return!1;Me=q(e,"data-type","block-ref")||q(e,"data-type","virtual-block-ref"),Me&&Me.classList.contains("b3-tooltips")&&(Me=void 0),Me||(Me=A(e,"popover__block"));const n=q(e,"data-type","a",!0);if(!Me&&n&&n.getAttribute("data-href")?.startsWith("siyuan://blocks")&&(Me=n),!Me){let a=e;!a.parentElement&&t.path&&t.path[1]&&(a=t.path[1]);const i=A(a,"block__popover",!0),s={oid:0};if(window.siyuan.blockPanels.forEach(o=>{if((o.targetElement||typeof o.x=="number")&&o.element.getAttribute("data-pin")==="true"){const l=parseInt(o.element.getAttribute("data-level")),r=o.element.getAttribute("data-oid");s[r]?l>s[r]&&(s[r]=l):s[r]=l}}),i)for(let o=0;o<window.siyuan.blockPanels.length;o++){const l=window.siyuan.blockPanels[o];(l.targetElement||typeof l.x=="number")&&parseInt(l.element.getAttribute("data-level"))>(s[l.element.getAttribute("data-oid")]||0)&&l.element.getAttribute("data-pin")==="false"&&parseInt(l.element.getAttribute("data-level"))>parseInt(i.getAttribute("data-level"))&&(l.destroy(),o--)}else for(let o=0;o<window.siyuan.blockPanels.length;o++){const l=window.siyuan.blockPanels[o];(l.targetElement||typeof l.x=="number")&&l.element.getAttribute("data-pin")==="false"&&(l.destroy(),o--)}}},xb=(t,e)=>{if(A(t.target,"history__repo",!0)||(Me=q(t.target,"data-type","block-ref")||q(t.target,"data-type","virtual-block-ref"),Me&&Me.classList.contains("b3-tooltips")&&(Me=void 0),Me||(Me=A(t.target,"popover__block")),!Me&&e&&(e.getAttribute("data-href")?.startsWith("siyuan://blocks")&&e.getAttribute("prevent-popover")!=="true"||e.classList.contains("av__celltext")&&e.dataset.type==="url")&&(Me=e),!Me||window.siyuan.altIsPressed||window.siyuan.config.editor.floatWindowMode===0&&window.siyuan.ctrlIsPressed||Me&&Me.getAttribute("prevent-popover")==="true"))return!1;if(Me&&getSelection().rangeCount>0){const n=getSelection().getRangeAt(0);if(n.toString()!==""&&Me.contains(n.startContainer))return!1}return!0},Vo=async(t,e=!1)=>{if(!Me)return;let n,a;const i=Me.getAttribute("data-id");if(i)if(e){const o=await lt("/api/block/getRefIDs",{id:i});n=o.data.refIDs,a=o.data.defIDs}else i.startsWith("[")?n=JSON.parse(i):n=[i],a=JSON.parse(Me.getAttribute("data-defids")||"[]");else if(Me.getAttribute("data-type")?.indexOf("virtual-block-ref")>-1){const o=x(Me);o&&(n=(await lt("/api/block/getBlockDefIDsByRefText",{anchor:Me.textContent,excludeIDs:[o.getAttribute("data-node-id")]})).data)}else if(Me.getAttribute("data-type")?.split(" ").includes("a"))n=[so(Me.getAttribute("data-href"))];else if(Me.dataset.type==="url")n=[so(Me.textContent.trim())];else{let o,l="/api/block/getRefIDs";Me.classList.contains("protyle-attr--refcount")?o=Me.parentElement.parentElement.getAttribute("data-node-id"):Me.classList.contains("pdf__rect")?(o=Me.getAttribute("data-node-id"),l="/api/block/getRefIDsByFileAnnotationID"):o||(o=Me.parentElement.getAttribute("data-node-id"));const r=await lt(l,{id:o});n=r.data.refIDs,a=r.data.defIDs}let s=!1;window.siyuan.blockPanels.find(o=>{if((o.targetElement||typeof o.x=="number")&&o.element.getAttribute("data-pin")==="true"&&JSON.stringify(n)===JSON.stringify(o.nodeIds))return s=!0,!0}),!s&&Me.parentElement&&Me.parentElement.style.opacity!=="0.1"&&window.siyuan.blockPanels.push(new Ro({app:t,targetElement:Me,isBacklink:e||Me.classList.contains("protyle-attr--refcount")||Me.classList.contains("counter"),nodeIds:n,defIds:a}))},Ab=t=>{const e=new me({width:(0,I.tq)()?"92vw":"80vw",height:(0,I.tq)()?"80vh":"70vh",title:window.siyuan.languages.commandPanel,content:`<div class="fn__flex-column">
    <div class="b3-form__icon search__header" style="border-top: 0;border-bottom: 1px solid var(--b3-theme-surface-lighter);">
        <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
        <input class="b3-text-field b3-text-field--text" style="padding-left: 32px !important;">
    </div>
    <div class="fn__hr"></div>
    <ul class="b3-list b3-list--background fn__flex-1" id="commands"></ul>
    <div class="fn__hr"></div>
</div>`}),n=e.element.querySelector("#commands");if(t.plugins.forEach(i=>{i.commands.forEach(s=>{const o=document.createElement("li");o.classList.add("b3-list-item"),n.childElementCount===0&&o.classList.add("b3-list-item--focus"),o.innerHTML=`<span class="b3-list-item__text">${i.displayName}: ${s.langText||i.i18n[s.langKey]}</span>
<span class="b3-list-item__meta${(0,I.tq)()?" fn__none":""}">${K(s.customHotkey)}</span>`,o.addEventListener("click",()=>{s.callback?s.callback():s.globalCallback&&s.globalCallback(),e.destroy()}),n.insertAdjacentElement("beforeend",o)})}),n.childElementCount===0){const i=document.createElement("li");i.classList.add("b3-list-item","b3-list-item--focus"),i.innerHTML=`<span class="b3-list-item__text" style="-webkit-line-clamp: inherit;">${(0,I.tq)()?window.siyuan.languages._kernel[122]:window.siyuan.languages.commandEmpty}</span>`,i.addEventListener("click",()=>{e.destroy(),As(t).element.querySelector('.b3-tab-bar [data-name="bazaar"]').dispatchEvent(new CustomEvent("click"))}),n.insertAdjacentElement("beforeend",i)}else n.firstElementChild.classList.add("b3-list-item--focus");const a=e.element.querySelector(".b3-text-field");a.focus(),a.addEventListener("keydown",i=>{if(i.stopPropagation(),!i.isComposing)if(Bn(n,i),i.key==="Enter"){const s=n.querySelector(".b3-list-item--focus");s&&s.dispatchEvent(new CustomEvent("click")),e.destroy()}else i.key==="Escape"&&e.destroy()}),a.addEventListener("compositionend",()=>{Tb(a,n)}),a.addEventListener("input",i=>{i.isComposing||(i.stopPropagation(),Tb(a,n))})},Tb=(t,e)=>{const n=t.value.toLowerCase();e.querySelector(".b3-list-item--focus")?.classList.remove("b3-list-item--focus");let a=!1;Array.from(e.children).forEach(i=>{const s=i.querySelector(".b3-list-item__text").textContent.toLowerCase();n.indexOf(s)>-1||s.indexOf(n)>-1?(a||i.classList.add("b3-list-item--focus"),a=!0,i.classList.remove("fn__none")):i.classList.add("fn__none")})},zu=(t,e)=>({label:`${t.pin?window.siyuan.languages.unpin:window.siyuan.languages.pin}`,icon:e,current:!t.pin,click(){t.togglePin()}}),Ib=(t,e)=>{if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barWorkspace"){window.siyuan.menus.menu.remove();return}w("/api/system/getWorkspaces",{},n=>{window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barWorkspace"),window.siyuan.config.readonly||window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.config,icon:"iconSettings",accelerator:window.siyuan.config.keymap.general.config.custom,click:()=>{As(t)}}).element);const a=[];if(Mr().forEach(s=>{a.push({icon:s.icon,accelerator:s.hotkey,label:s.title,click(){St(s.type).toggleModel(s.type)}})}),window.siyuan.config.readonly||(a.push({type:"separator"}),a.push(zu(window.siyuan.layout.leftDock,"iconLeftTop")),a.push(zu(window.siyuan.layout.rightDock,"iconRightTop")),a.push(zu(window.siyuan.layout.bottomDock,"iconBottomLeft"))),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.panels,icon:"iconDock",type:"submenu",submenu:a}).element),!window.siyuan.config.readonly){let s;s=[{label:`${window.siyuan.languages.new} / ${window.siyuan.languages.openBy}`,iconHTML:"",click:async()=>{const o=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"showOpenDialog",defaultPath:window.siyuan.config.system.homeDir,properties:["openDirectory","createDirectory"]});o.filePaths.length!==0&&w("/api/system/checkWorkspaceDir",{path:o.filePaths[0]},l=>{l.data.isWorkspace?Wr(o.filePaths[0]):Ne(window.siyuan.languages.createWorkspace,window.siyuan.languages.createWorkspaceTip+`<br><br><code class="fn__code">${o.filePaths[0]}</code>`,()=>{Wr(o.filePaths[0])})})}}],s.push({type:"separator"}),n.data.forEach(o=>{s.push(ck(o))}),(!(0,I.jU)()||Bt()||at())&&window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.workspaceList,icon:"iconWorkspace",type:"submenu",submenu:s}).element)}const i=[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.save,click(){const s=new me({title:window.siyuan.languages.save,content:`<div class="b3-dialog__content">
        <input class="b3-text-field fn__block" placeholder="${window.siyuan.languages.memo}">
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:"520px"}),o=s.element.querySelectorAll(".b3-button");s.bindInput(s.element.querySelector("input"),()=>{o[1].dispatchEvent(new CustomEvent("click"))}),o[0].addEventListener("click",()=>{s.destroy()}),o[1].addEventListener("click",()=>{const l=s.element.querySelector("input").value;if(!l){M(window.siyuan.languages._kernel[142]);return}window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].find(c=>{if(c.name===l)return s.destroy(),Ne(window.siyuan.languages.save,window.siyuan.languages.exportTplTip,()=>{c.layout=_b(),pe(p.Constants.LOCAL_LAYOUTS,window.siyuan.storage[p.Constants.LOCAL_LAYOUTS])}),!0})||(window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].push({name:l,layout:_b()}),pe(p.Constants.LOCAL_LAYOUTS,window.siyuan.storage[p.Constants.LOCAL_LAYOUTS]),s.destroy())})}}];if(window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].length>0&&i.push({type:"separator"}),window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].forEach(s=>{i.push({iconHTML:p.Constants.ZWSP,action:"iconCloseRound",label:s.name,bind(o){o.addEventListener("click",l=>{if(A(l.target,"b3-menu__action")){l.preventDefault(),l.stopPropagation(),window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].find((r,c)=>{if(r.name===s.name)return o.remove(),window.siyuan.storage[p.Constants.LOCAL_LAYOUTS].splice(c,1),pe(p.Constants.LOCAL_LAYOUTS,window.siyuan.storage[p.Constants.LOCAL_LAYOUTS]),!0});return}w("/api/system/setUILayout",{layout:s.layout},()=>{window.location.reload()})})}})}),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.layout,icon:"iconLayout",type:"submenu",submenu:i}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element),!window.siyuan.config.readonly){if(nd()<2)window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.dailyNote,icon:"iconCalendar",accelerator:window.siyuan.config.keymap.general.dailyNote.custom,click:()=>{Zp(t)}}).element);else{const s=[];window.siyuan.notebooks.forEach(o=>{o.closed||s.push({label:we(o.name),iconHTML:ie(o.icon||p.Constants.SIYUAN_IMAGE_NOTE,"b3-menu__icon",!0),accelerator:window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID]===o.id?window.siyuan.config.keymap.general.dailyNote.custom:"",click:()=>{Ql(t,o.id),window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID]=o.id,pe(p.Constants.LOCAL_DAILYNOTEID,window.siyuan.storage[p.Constants.LOCAL_DAILYNOTEID])}})}),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.dailyNote,icon:"iconCalendar",type:"submenu",submenu:s}).element)}window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.riffCard,type:"submenu",icon:"iconRiffCard",submenu:[{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.spaceRepetition,accelerator:window.siyuan.config.keymap.general.riffCard.custom,click:()=>{Co(t)}},{iconHTML:p.Constants.ZWSP,label:window.siyuan.languages.manage,click:()=>{_s(t,"",window.siyuan.languages.all,"")}}]}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.recentDocs,icon:"iconFile",accelerator:window.siyuan.config.keymap.general.recentDocs.custom,click:()=>{Ou()}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.lockScreen,icon:"iconLock",accelerator:window.siyuan.config.keymap.general.lockScreen.custom,click:()=>{Xm(t)}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.dataHistory,icon:"iconHistory",accelerator:window.siyuan.config.keymap.general.dataHistory.custom,click:()=>{Dd(t)}}).element),window.siyuan.menus.menu.append(new S({type:"separator"}).element)}window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.help,icon:"iconHelp",click:()=>{er()}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.feedback,icon:"iconFeedback",click:()=>{window.siyuan.config.lang==="zh_CN"||window.siyuan.config.lang==="zh_CHT"?window.open("https://ld246.com/article/1649901726096"):window.open("https://liuyun.io/article/1686530886208")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.debug,icon:"iconBug",click:()=>{te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"openDevTools")}}).element),(ht()||at()||!(0,I.jU)())&&(window.siyuan.menus.menu.append(new S({type:"separator"}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.safeQuit,icon:"iconQuit",click:()=>{It({errorExit:!0,cb:Ss})}}).element)),window.siyuan.menus.menu.popup({x:e.left,y:e.bottom})})},Wr=t=>{t!==window.siyuan.config.system.workspaceDir&&w("/api/system/setWorkspaceDir",{path:t},()=>{te.ipcRenderer.send(p.Constants.SIYUAN_OPEN_WORKSPACE,{workspace:t,lang:window.siyuan.config.appearance.lang})})},ck=t=>({label:`<div aria-label="${t.path}" class="fn__ellipsis ariaLabel" style="max-width: 256px">
    ${qw().basename(t.path)}
</div>`,current:!t.closed,iconHTML:p.Constants.ZWSP,type:"submenu",submenu:[{icon:"iconOpenWindow",label:window.siyuan.languages.openBy,click(){Wr(t.path)}},{icon:"iconFolder",label:window.siyuan.languages.showInFolder,click(){Qn(t.path)}},{icon:"iconCopy",label:window.siyuan.languages.copyPath,click(){G(t.path),M(window.siyuan.languages.copied)}},{icon:"iconTrashcan",label:window.siyuan.languages.removeWorkspaceTip,click(){w("/api/system/removeWorkspaceDir",{path:t.path})}}],click(){Wr(t.path)}}),dk=(t,e)=>{if(getSelection().rangeCount===0)return!1;const n=getSelection().getRangeAt(0);if(A(n.startContainer,"protyle",!0))return!1;let a,i,s,o;if(window.siyuan.dialogs.find(b=>{if(b.element.contains(n.startContainer)&&b.element.querySelector("#searchList"))return a=b.element.querySelector(".b3-dialog__body"),i=b,o=i.data,s=i.editor,!0}),a||Pe().search.find(b=>{if(b.element.contains(n.startContainer))return a=b.element,s=b.edit,o=b.config,!0}),!a)return!1;const l=a.querySelector("#searchAssets"),r=!l.classList.contains("fn__none"),c=r?l.querySelector("#searchAssetList"):a.querySelector("#searchList"),d=a.querySelector("#searchInput");if(!r&&$(window.siyuan.config.keymap.general.newFile.custom,e))return o.method===0&&ld(t,d.value),!0;const u=e.target.id;if(e.key==="ArrowDown"&&e.altKey)return r?Up(l):u==="replaceInput"?Wp(a):Vp(a,o,s),!0;const f=window.siyuan.storage[p.Constants.LOCAL_SEARCHASSET];if(!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;let g=c.querySelector(".b3-list-item--focus");if(!g)return!1;if(g.getAttribute("data-type")==="search-new")return e.key==="Enter"&&o.method===0?(ld(t,d.value),!0):!1;if(!r){if($(window.siyuan.config.keymap.editor.general.insertRight.custom,e)){const y=g.getAttribute("data-node-id");return ot(y,(_,v)=>{de({app:t,id:y,position:"right",action:v,zoomIn:_}),i&&i.destroy({focus:"false"})}),!0}const b=g.getAttribute("data-node-id");if($("\u2318/",e)){const y=g.getBoundingClientRect();return kb(b).popup({x:y.left+30,y:y.bottom}),!0}if($(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,e))return w("/api/block/getRefText",{id:b},y=>{G(`((${b} '${y.data}'))`)}),!0;if($(window.siyuan.config.keymap.editor.general.copyBlockEmbed.custom,e))return G(`{{select * from blocks where id='${b}'}}`),!0;if($(window.siyuan.config.keymap.editor.general.copyProtocol.custom,e))return G(`siyuan://blocks/${b}`),!0;if($(window.siyuan.config.keymap.editor.general.copyProtocolInMd.custom,e))return w("/api/block/getRefText",{id:b},y=>{G(`[${y.data}](siyuan://blocks/${b})`)}),!0;if($(window.siyuan.config.keymap.editor.general.copyHPath.custom,e))return w("/api/filetree/getHPathByID",{id:b},y=>{G(y.data)}),!0;if($(window.siyuan.config.keymap.editor.general.copyID.custom,e))return G(b),!0}if(p.Constants.KEYCODELIST[e.keyCode]==="PageUp"){if(r){if(!l.querySelector('[data-type="assetPrevious"]').getAttribute("disabled")){let b=parseInt(l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/")[0]);b>1&&(b--,dn(l,f,b))}}else a.querySelector('[data-type="previous"]').getAttribute("disabled")||o.page>1&&(o.page--,Wt(a,o,s));return!0}if(p.Constants.KEYCODELIST[e.keyCode]==="PageDown"){if(r){if(!l.querySelector('[data-type="assetNext"]').getAttribute("disabled")){const b=l.querySelector("#searchAssetResult .fn__flex-center").textContent.split("/");let y=parseInt(b[0]);y<parseInt(b[1])&&(y++,dn(l,f,y))}}else{const b=a.querySelector('[data-type="next"]');b.getAttribute("disabled")||o.page<parseInt(b.parentElement.querySelector("#searchResult").getAttribute("data-pagecount"))&&(o.page++,Wt(a,o,s))}return!0}if(!window.siyuan.menus.menu.element.classList.contains("fn__none"))return!1;if(e.key==="Enter"){if(r)Qn(kt.join(window.siyuan.config.system.dataDir,g.lastElementChild.getAttribute("aria-label")));else if(u==="replaceInput")Ad(a,o,s,!1);else{const b=g.getAttribute("data-node-id");ot(b,(y,_)=>{de({app:t,id:b,action:_,zoomIn:y}),i&&i.destroy({focus:"false"})})}return!0}const h=28,m=l.querySelector("#searchAssetPreview");return e.key==="ArrowDown"?(g.classList.remove("b3-list-item--focus"),g.nextElementSibling?g.nextElementSibling.classList.add("b3-list-item--focus"):o.group===1&&!r?g.parentElement.nextElementSibling?g.parentElement.nextElementSibling.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"):c.children[1].firstElementChild.classList.add("b3-list-item--focus"):c.firstElementChild.classList.add("b3-list-item--focus"),g=c.querySelector(".b3-list-item--focus"),(c.scrollTop<g.offsetTop-c.clientHeight+h||c.scrollTop>g.offsetTop)&&(c.scrollTop=g.offsetTop-c.clientHeight+h),r?Jl(m,g.dataset.id,d.value,f.method):ds({id:g.getAttribute("data-node-id"),config:o,value:d.value,edit:s}),!0):e.key==="ArrowUp"?(g.classList.remove("b3-list-item--focus"),g.previousElementSibling?g.previousElementSibling.classList.add("b3-list-item--focus"):o.group===1&&!r?g.parentElement.previousElementSibling.previousElementSibling?g.parentElement.previousElementSibling.previousElementSibling.lastElementChild.classList.add("b3-list-item--focus"):c.lastElementChild.lastElementChild.classList.add("b3-list-item--focus"):c.lastElementChild.classList.add("b3-list-item--focus"),g=c.querySelector(".b3-list-item--focus"),(c.scrollTop<g.offsetTop-c.clientHeight+h||c.scrollTop>g.offsetTop-h*2)&&(c.scrollTop=g.offsetTop-h*2),r?Jl(m,g.dataset.id,d.value,f.method):ds({id:g.getAttribute("data-node-id"),config:o,value:d.value,edit:s}),!0):!1},Db=(t,e)=>{e.preventDefault();let n=e.target;for(;!n.isSameNode(Mn.element);){if(n.classList.contains("b3-list-item")){const a=n.getAttribute("data-type");if(a)a==="riffCard"?Co(t):St(a).toggleModel(a,!0);else{const i=n.getAttribute("data-id");Yn().find(s=>{if(s.id===i)return s.parent.switchTab(s.headElement),s.parent.showHeading(),!0})}Mn.destroy(),Mn=void 0;break}n=n.parentElement}},$b=(t,e,n)=>{let a=e.querySelector(".b3-list-item--focus");if(a){if(a.classList.remove("b3-list-item--focus"),n.key==="ArrowUp")a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):a.parentElement.lastElementChild.classList.add("b3-list-item--focus");else if(n.key==="ArrowDown")a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus");else if(n.key==="ArrowLeft"||n.key==="ArrowRight"){const r=a.parentElement.previousElementSibling||a.parentElement.nextElementSibling;if(r){const c=r.querySelector(`[data-index="${a.getAttribute("data-index")}"]`)||r.lastElementChild;c?c.classList.add("b3-list-item--focus"):a.classList.add("b3-list-item--focus")}else a.classList.add("b3-list-item--focus")}else if(n.key==="Enter"){const r=a.getAttribute("data-type");r?r==="riffCard"?Co(t):St(r).toggleModel(r,!0):de({app:t,id:a.getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_SCROLL]}),X(["dialog"]);return}a=e.querySelector(".b3-list-item--focus");const i=a.getAttribute("data-node-id"),s=e.querySelector(".switch-doc__path");i?w("/api/filetree/getFullHPathByID",{id:i},r=>{s.innerHTML=we(r.data)}):s.innerHTML=a.querySelector(".b3-list-item__text").innerHTML;const o=a.getBoundingClientRect(),l=a.parentElement.getBoundingClientRect();o.top<l.top?a.scrollIntoView(!0):o.bottom>l.bottom&&a.scrollIntoView(!1)}},uk=(t,e)=>{let n,a;getSelection().rangeCount>0&&(a=getSelection().getRangeAt(0));const i=document.querySelector(".layout__tab--active");let s=!1;i&&i.classList.contains("sy__file")&&(s=!0),a&&window.siyuan.dialogs.find(c=>{if(c.editor&&c.editor.protyle.element.contains(a.startContainer))return n=c.editor.protyle,s=!1,!0});const o=Qa();if(!n&&o)if(o.model instanceof dt)n=o.model.editor.protyle;else if(o.model instanceof Za)n=o.model.edit.protyle;else if(o.model instanceof sa&&o.model.data?.editor instanceof pn)n=o.model.data.editor.protyle;else return!1;else if(!n){!n&&a&&window.siyuan.blockPanels.find(d=>{if(d.editors.find(u=>{if(u.protyle.element.contains(a.startContainer))return n=u.protyle,!0}),n)return!0});const c=Pe();if(n||c.backlink.find(d=>{if(d.element.classList.contains("layout__tab--active"))return a&&d.editors.find(u=>{if(u.protyle.element.contains(a.startContainer))return n=u.protyle,!0}),!n&&d.editors.length>0&&(n=d.editors[0].protyle),!0}),n||c.editor.find(d=>{if(d.parent.headElement.classList.contains("item--focus"))return n=d.editor.protyle,!0}),!n)return!1}let l="";if($(window.siyuan.config.keymap.general.replace.custom,e)?l=p.Constants.DIALOG_REPLACE:$(window.siyuan.config.keymap.general.search.custom,e)&&(l=p.Constants.DIALOG_SEARCH),!s&&l)return a&&n.element.contains(a.startContainer)?_n({app:t,hotkey:l,key:a.toString(),notebookId:n.notebookId,searchPath:n.path}):_n({app:t,hotkey:l}),e.preventDefault(),!0;if(!s&&$(window.siyuan.config.keymap.editor.general.quickMakeCard.custom,e)){if(n.title?.editElement.contains(a.startContainer))Do(n,[n.title.element]);else{const c=[];if(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select").forEach(d=>{c.push(d)}),c.length===0){const d=x(a.startContainer);d&&c.push(d)}Do(n,c)}return e.preventDefault(),!0}if(!s&&$(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e))return w("/api/riff/getTreeRiffDueCards",{rootID:n.block.rootID},c=>{Ci(t,c.data,"doc",n.block.rootID,n.title.editElement.textContent||"Untitled")}),e.preventDefault(),!0;if(!s&&$(window.siyuan.config.keymap.general.move.custom,e)){let c,d;if(getSelection().rangeCount>0&&(c=getSelection().getRangeAt(0),d=x(c.startContainer)),n.title?.editElement.contains(c.startContainer))ga((u,f)=>{ed([n.path],f[0],u[0])},[n.path],c);else if(d&&c&&n.element.contains(c.startContainer)){let u=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));u.length===0&&(u=[d]),ga(f=>{bd(f[0],u,n)})}return e.preventDefault(),!0}const r=e.target;if(r.tagName!=="TABLE"&&["INPUT","TEXTAREA"].includes(r.tagName))return!1;if($(window.siyuan.config.keymap.editor.general.backlinks.custom,e)){if(e.preventDefault(),a){const c=q(a.startContainer,"data-type","block-ref");if(c)return rr({app:n.app,blockId:c.dataset.id}),!0}return rr({app:n.app,blockId:n.block.id,rootId:n.block.rootID,useBlockId:n.block.showAll,title:n.title?n.title.editElement.textContent||"Untitled":null}),!0}if($(window.siyuan.config.keymap.editor.general.graphView.custom,e)){if(e.preventDefault(),a){const c=q(a.startContainer,"data-type","block-ref");if(c)return cr({app:n.app,blockId:c.dataset.id}),!0}return cr({app:n.app,blockId:n.block.id,rootId:n.block.rootID,useBlockId:n.block.showAll,title:n.title?n.title.editElement.textContent||"Untitled":null}),!0}if($(window.siyuan.config.keymap.editor.general.outline.custom,e)){e.preventDefault();const c=yt(r);return Rg(n),Gn(r,c.start,c.end),!0}if($(window.siyuan.config.keymap.editor.general.copyPlainText.custom,e)){const c=x(a.startContainer);if(!c)return!1;if(a.toString()===""){const d=Array.from(n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select"));let u="";d.length===0&&d.push(c),d.forEach(f=>{f.querySelectorAll("[spellcheck]").forEach(g=>{u+=g.textContent+`
`})}),ee(u.trimEnd())}else G(a.toString());return e.preventDefault(),!0}if($(window.siyuan.config.keymap.editor.general.refresh.custom,e))return na(n,!0),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.general.fullscreen.custom,e))return _o(n.element),qt(n),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.general.preview.custom,e))return Di(n,"preview"),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.general.wysiwyg.custom,e)&&!n.options.backlinkData)return Di(n,"wysiwyg"),n.scroll.lastScrollTop=0,w("/api/filetree/getDoc",{id:n.block.parentID,size:window.siyuan.config.editor.dynamicLoadBlocks},c=>{st({data:c,protyle:n})}),e.preventDefault(),!0;if($(window.siyuan.config.keymap.editor.general.copyBlockRef.custom,e))if(e.preventDefault(),e.stopPropagation(),A(a.startContainer,"protyle-title"))w("/api/block/getRefText",{id:n.block.rootID},c=>{G(`((${n.block.rootID} '${c.data}'))`)});else{const c=x(a.startContainer);if(!c)return!1;const d=n.wysiwyg.element.querySelectorAll(".protyle-wysiwyg--select");let u;if(d.length===1)u=d[0];else{const g=c.querySelector(".img--select");if(g)return rp(g.querySelector("img")),!0;u=c}const f=u.getAttribute("data-node-id");a.toString()!==""?Mu(a,g=>{G(`((${f} "${g.trim()}"))`)}):w("/api/block/getRefText",{id:f},g=>{G(`((${f} '${g.data}'))`)})}return A(r,"protyle-title__input")?!1:$(window.siyuan.config.keymap.editor.general.undo.custom,e)?(n.undo.undo(n),e.preventDefault(),!0):$(window.siyuan.config.keymap.editor.general.redo.custom,e)?(n.undo.redo(n),e.preventDefault(),!0):!1},fk=(t,e)=>{const n=St("file");if(!n)return!1;const a=n.data.file;if($(window.siyuan.config.keymap.general.selectOpen1.custom,e)){e.preventDefault();const f=document.querySelector(".layout__wnd--active > .fn__flex > .layout-tab-bar > .item--focus")||document.querySelector("ul.layout-tab-bar > .item--focus");if(f){const g=Lt(f.getAttribute("data-id"));g&&g.model instanceof dt&&(g.model.editor.protyle.wysiwyg.element.blur(),g.model.editor.protyle.title.editElement.blur(),a.selectItem(g.model.editor.protyle.notebookId,g.model.editor.protyle.path))}n.toggleModel("file",!0);return}if(!a.element.parentElement.classList.contains("layout__tab--active"))return!1;let i=!1;if(t.plugins.find(f=>{if(f.commands.find(g=>{if(g.fileTreeCallback&&$(g.customHotkey,e))return i=!0,g.fileTreeCallback(a),!0}),i)return!0}),i)return!0;const s=Array.from(a.element.querySelectorAll(".b3-list-item--focus"));if(s.length===0){if(e.key.startsWith("Arrow")&&R(e)){const f=a.element.querySelector(".b3-list-item");f&&f.classList.add("b3-list-item--focus"),e.preventDefault()}return!1}const o=xt(s[0],"UL");if(!o)return!1;const l=o.getAttribute("data-url"),r=s[0].getAttribute("data-path"),c=s[0].getAttribute("data-type")==="navigation-file";if($(window.siyuan.config.keymap.editor.general.spaceRepetition.custom,e))if(c){const f=s[0].getAttribute("data-node-id");w("/api/riff/getTreeRiffDueCards",{rootID:f},g=>{Ci(t,g.data,"doc",f,ft(s[0].getAttribute("data-name"),!1,!0))})}else w("/api/riff/getNotebookRiffDueCards",{notebook:l},f=>{Ci(t,f.data,"notebook",l,ea(l))});if($(window.siyuan.config.keymap.editor.general.quickMakeCard.custom,e)){const f=[];return s.forEach(g=>{const h=g.getAttribute("data-node-id");h&&f.push(h)}),f.length>0&&F(void 0,[{action:"addFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:f}],[{action:"removeFlashcards",deckID:p.Constants.QUICK_DECK_ID,blockIDs:f}]),e.preventDefault(),!0}if($(window.siyuan.config.keymap.editor.general.rename.custom,e))return window.siyuan.menus.menu.remove(),id({notebookId:l,path:r,name:c?ft(s[0].getAttribute("data-name"),!1,!0):ea(l),type:c?"file":"notebook"}),e.preventDefault(),!0;if($("\u2318/",e)){const f=s[0].getBoundingClientRect();return c?mr(t,l,r,s[0]).popup({x:f.right-15,y:f.top+15}):hr(t,s[0]).popup({x:f.right-15,y:f.top+15}),!0}if(c&&$(window.siyuan.config.keymap.general.move.custom,e)){window.siyuan.menus.menu.remove();const f=Qc(s);return ga((g,h)=>{ed(f,h[0],g[0])},f),e.preventDefault(),!0}if(c&&$(window.siyuan.config.keymap.editor.general.insertRight.custom,e))return window.siyuan.menus.menu.remove(),de({app:t,id:s[0].getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS],position:"right"}),e.preventDefault(),!0;let d="";if($(window.siyuan.config.keymap.general.replace.custom,e)?d=p.Constants.DIALOG_REPLACE:$(window.siyuan.config.keymap.general.search.custom,e)&&(d=p.Constants.DIALOG_SEARCH),d)return window.siyuan.menus.menu.remove(),_n(c?{app:t,hotkey:d,notebookId:l,searchPath:ft(r,!1,!0)}:{app:t,hotkey:d,notebookId:l}),e.preventDefault(),!0;const u=e.target;if(["INPUT","TEXTAREA"].includes(u.tagName)||q(u,"contenteditable",null)||A(u,"protyle",!0))return!1;if(e.shiftKey){if(e.key==="ArrowUp"){const f=ir(s);let g;if(f.startElement.getBoundingClientRect().top>=f.endElement.getBoundingClientRect().top?(g=Ra(f.endElement),g&&(g.classList.add("b3-list-item--focus"),g.setAttribute("select-end","true"),f.endElement.removeAttribute("select-end"))):(f.endElement.classList.remove("b3-list-item--focus"),f.endElement.removeAttribute("select-end"),g=Ra(f.endElement),g&&g.setAttribute("select-end","true")),g){const h=g.getBoundingClientRect(),m=a.element.getBoundingClientRect();(h.top<m.top||h.bottom>m.bottom)&&g.scrollIntoView(h.top<m.top)}}else if(e.key==="ArrowDown"){const f=ir(s);let g;if(f.startElement.getBoundingClientRect().top<=f.endElement.getBoundingClientRect().top?(g=on(f.endElement),g&&(g.classList.add("b3-list-item--focus"),g.setAttribute("select-end","true"),f.endElement.removeAttribute("select-end"))):(f.endElement.classList.remove("b3-list-item--focus"),f.endElement.removeAttribute("select-end"),g=on(f.endElement),g&&g.setAttribute("select-end","true")),g){const h=g.getBoundingClientRect(),m=a.element.getBoundingClientRect();(h.top<m.top||h.bottom>m.bottom)&&g.scrollIntoView(h.top<m.top)}}return}else if(R(e)){if(a.element.querySelector('[select-end="true"]')?.removeAttribute("select-end"),a.element.querySelector('[select-start="true"]')?.removeAttribute("select-start"),e.key==="ArrowRight"&&!s[0].querySelector(".b3-list-item__arrow--open")&&!s[0].querySelector(".b3-list-item__toggle").classList.contains("fn__hidden")||e.key==="ArrowLeft"&&s[0].querySelector(".b3-list-item__arrow--open"))return a.getLeaf(s[0],l),s.forEach((f,g)=>{g!==0&&f.classList.remove("b3-list-item--focus")}),e.preventDefault(),!0;if(e.key==="ArrowLeft"){let f=s[0].parentElement.previousElementSibling;if(f){f.tagName!=="LI"&&(f=a.element.querySelector(".b3-list-item")),s.forEach(m=>{m.classList.remove("b3-list-item--focus")}),f.classList.add("b3-list-item--focus");const g=f.getBoundingClientRect(),h=a.element.getBoundingClientRect();(g.top<h.top||g.bottom>h.bottom)&&f.scrollIntoView(g.top<h.top)}return e.preventDefault(),!0}if(e.key==="ArrowDown"||e.key==="ArrowRight"){let f=s[0];for(;f;)if(f.nextElementSibling){f.nextElementSibling.tagName==="UL"?f=f.nextElementSibling.firstElementChild:f=f.nextElementSibling;break}else{if(f.parentElement.classList.contains("fn__flex-1"))break;f=f.parentElement}if(f.classList.contains("b3-list-item")){s.forEach(m=>{m.classList.remove("b3-list-item--focus")}),f.classList.add("b3-list-item--focus");const g=f.getBoundingClientRect(),h=a.element.getBoundingClientRect();(g.top<h.top||g.bottom>h.bottom)&&f.scrollIntoView(g.top<h.top)}return e.preventDefault(),!0}if(e.key==="ArrowUp"){let f=s[0];for(;f;)if(f.previousElementSibling){if(f.previousElementSibling.tagName==="LI")f=f.previousElementSibling;else{const g=f.previousElementSibling.querySelectorAll(".b3-list-item");f=g[g.length-1]}break}else{if(f.parentElement.classList.contains("fn__flex-1"))break;f=f.parentElement}if(f.classList.contains("b3-list-item")){s.forEach(m=>{m.classList.remove("b3-list-item--focus")}),f.classList.add("b3-list-item--focus");const g=f.getBoundingClientRect(),h=a.element.getBoundingClientRect();(g.top<h.top||g.bottom>h.bottom)&&f.scrollIntoView(g.top<h.top)}return e.preventDefault(),!0}}if(e.key==="Delete"||e.key==="Backspace"&&$e())return window.siyuan.menus.menu.remove(),fr(s),!0;if(e.key==="Enter")return window.siyuan.menus.menu.remove(),s.forEach(f=>{if(f.getAttribute("data-type")==="navigation-file")de({app:t,id:f.getAttribute("data-node-id"),action:[p.Constants.CB_GET_FOCUS]});else{const g=xt(f,"UL");g&&a.getLeaf(f,g.getAttribute("data-url"))}}),!0},pk=(t,e)=>{const n=e.target;if(["INPUT","TEXTAREA"].includes(n.tagName)||q(n,"contenteditable",null)||A(n,"protyle",!0))return!1;let a=document.querySelector(".layout__tab--active");if(a||Array.from(document.querySelectorAll(".layout__wnd--active .layout-tab-container > div")).find(d=>{if(!d.classList.contains("fn__none")&&d.className.indexOf("sy__")>-1)return a=d,!0}),!a||a.className.indexOf("sy__")===-1)return!1;let i=!1;if(t.plugins.find(d=>{if(d.commands.find(u=>{if(u.dockCallback&&$(u.customHotkey,e))return i=!0,u.dockCallback(a),!0}),i)return!0}),i)return!0;if(!$(window.siyuan.config.keymap.editor.general.collapse.custom,e)&&!$(window.siyuan.config.keymap.editor.general.expand.custom,e)&&!e.key.startsWith("Arrow")&&e.key!=="Enter")return!1;if(!e.repeat&&$(window.siyuan.config.keymap.editor.general.collapse.custom,e)){const d=a.querySelector('.block__icon[data-type="collapse"]');if(d)return d.dispatchEvent(new CustomEvent("click")),e.preventDefault(),!0}if(!e.repeat&&$(window.siyuan.config.keymap.editor.general.expand.custom,e)){const d=a.querySelector('.block__icon[data-type="expand"]');if(d)return d.dispatchEvent(new CustomEvent("click")),e.preventDefault(),!0}if(a.classList.contains("sy__inbox")||a.classList.contains("sy__globalGraph")||a.classList.contains("sy__graph"))return!1;const s=Lt(a.getAttribute("data-id"),window.siyuan.layout.layout)?.model;if(!s)return!1;let o=a.querySelector(".b3-list-item--focus");if(!o)return o=a.querySelector(".b3-list .b3-list-item"),o&&o.classList.add("b3-list-item--focus"),!1;let l=s.tree;if(o.parentElement.parentElement.classList.contains("backlinkMList")&&(l=s.mTree),!l)return!1;if(e.key==="Enter")return l.click(o),e.preventDefault(),!0;const r=o.querySelector(".b3-list-item__arrow");if(e.key==="ArrowRight"&&!r.classList.contains("b3-list-item__arrow--open")&&!r.parentElement.classList.contains("fn__hidden")||e.key==="ArrowLeft"&&r.classList.contains("b3-list-item__arrow--open")&&!r.parentElement.classList.contains("fn__hidden"))return l.toggleBlocks(o),e.preventDefault(),!0;const c=A(o,"b3-list");if(!c)return!1;if(e.key==="ArrowLeft"){let d=o.parentElement.previousElementSibling;if(d){d.tagName!=="LI"&&(d=c.querySelector(".b3-list-item")),o.classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus");const u=d.getBoundingClientRect(),f=c.parentElement.getBoundingClientRect();(u.top<f.top||u.bottom>f.bottom)&&d.scrollIntoView(u.top<f.top)}return e.preventDefault(),!0}if(e.key==="ArrowDown"||e.key==="ArrowRight"){let d=o;for(;d;)if(d.nextElementSibling){d.nextElementSibling.tagName==="UL"?d.nextElementSibling.classList.contains("fn__none")?d.nextElementSibling.nextElementSibling&&(d=d.nextElementSibling.nextElementSibling):d=d.nextElementSibling.firstElementChild:d.nextElementSibling.classList.contains("protyle")?d.nextElementSibling.nextElementSibling&&(d=d.nextElementSibling.nextElementSibling):d=d.nextElementSibling;break}else{if(d.parentElement.classList.contains("fn__flex-1"))break;d=d.parentElement}if(d.classList.contains("b3-list-item")&&!d.classList.contains("b3-list-item--focus")){o.classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus");const u=d.getBoundingClientRect(),f=c.parentElement.getBoundingClientRect();(u.top<f.top||u.bottom>f.bottom)&&d.scrollIntoView(u.top<f.top)}return e.preventDefault(),!0}if(e.key==="ArrowUp"){let d=o;for(;d;)if(d.previousElementSibling){if(d.previousElementSibling.tagName==="LI")d=d.previousElementSibling;else if(d.previousElementSibling.classList.contains("protyle"))d.previousElementSibling.previousElementSibling&&(d=d.previousElementSibling.previousElementSibling);else if(d.previousElementSibling.tagName==="UL"&&d.previousElementSibling.classList.contains("fn__none"))d.previousElementSibling.previousElementSibling&&(d=d.previousElementSibling.previousElementSibling);else{const u=d.previousElementSibling.querySelectorAll(".b3-list-item");d=u[u.length-1]}break}else{if(d.parentElement.classList.contains("fn__flex-1"))break;d=d.parentElement}if(d.classList.contains("b3-list-item")&&!d.classList.contains("b3-list-item--focus")){o.classList.remove("b3-list-item--focus"),d.classList.add("b3-list-item--focus");const u=d.getBoundingClientRect(),f=c.parentElement.getBoundingClientRect();(u.top<f.top||u.bottom>f.bottom)&&d.scrollIntoView(u.top<f.top)}return e.preventDefault(),!0}return!1};let Mn;const gk=(t,e)=>{if(document.getElementById("errorLog")||e.isComposing)return;const n=e.target;if(R(e)&&!e.shiftKey&&!e.altKey&&!["INPUT","TEXTAREA"].includes(n.tagName)&&["0","1","2","3","4","j","k","l",";","s"," ","p","enter"].includes(e.key.toLowerCase())){let r;if(window.siyuan.dialogs.find(c=>{if(c.element.getAttribute("data-key")===p.Constants.DIALOG_OPENCARD)return r=c.element,!0}),r||(r=document.querySelector(`.layout__wnd--active div[data-key="${p.Constants.DIALOG_OPENCARD}"]:not(.fn__none)`)),r){e.preventDefault(),r.dispatchEvent(new CustomEvent("click",{detail:e.key.toLowerCase()}));return}}if(R(e)&&e.key!=="Escape"&&!e.shiftKey&&!e.altKey&&p.Constants.KEYCODELIST[e.keyCode]!=="PageUp"&&p.Constants.KEYCODELIST[e.keyCode]!=="PageDown"&&!/^F\d{1,2}$/.test(e.key)&&e.key.indexOf("Arrow")===-1&&e.key!=="Enter"&&e.key!=="Backspace"&&e.key!=="Delete")return;if(!e.altKey&&!e.shiftKey&&O(e)&&(($e()?e.key==="Meta":e.key==="Control")||O(e)?(window.siyuan.ctrlIsPressed=!0,(e.key==="Meta"||e.key==="Control")&&window.siyuan.config.editor.floatWindowMode===1&&!e.repeat&&Vo(t)):window.siyuan.ctrlIsPressed=!1),!e.altKey&&e.shiftKey&&R(e)&&(e.key==="Shift"?(window.siyuan.shiftIsPressed=!0,e.repeat||Vo(t,!0)):window.siyuan.shiftIsPressed=!1),e.altKey&&!e.shiftKey&&R(e)&&(e.key==="Alt"?window.siyuan.altIsPressed=!0:window.siyuan.altIsPressed=!1),Mn&&(Gf(window.siyuan.config.keymap.general.goToEditTabNext.custom,e)||Gf(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e))&&e.key.startsWith("Arrow")){$b(t,Mn.element,e);return}if(dk(t,e)){e.preventDefault(),e.stopPropagation();return}const a=(0,I.FJ)();if($(window.siyuan.config.keymap.general.goToEditTabNext.custom,e)||$(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e)){if(Mn&&Mn.element.parentElement)return;let r="",c=document.querySelector(".layout__wnd--active ul.layout-tab-bar > .item--focus");if(c||(c=document.querySelector("ul.layout-tab-bar > .item--focus")),c){const u=c.getAttribute("data-id");Yn().sort((f,g)=>f.headElement.getAttribute("data-activetime")>g.headElement.getAttribute("data-activetime")?-1:1).forEach((f,g)=>{let h=`<svg class="b3-list-item__graphic"><use xlink:href="#${f.icon}"></use></svg>`,m="";const b=f.headElement.getAttribute("data-initdata");if(f.model instanceof dt)m=` data-node-id="${f.model.editor.protyle.block.rootID}"`,h=ie(f.docIcon||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0);else if(b){const y=JSON.parse(b);y.instance==="Editor"&&(m=` data-node-id="${y.rootId}"`,h=ie(f.docIcon||p.Constants.SIYUAN_IMAGE_FILE,"b3-list-item__graphic",!0))}r+=`<li data-index="${g}" data-id="${f.id}"${m} class="b3-list-item${u===f.id?" b3-list-item--focus":""}"${u===f.id?' data-original="true"':""}>${h}<span class="b3-list-item__text">${we(f.title)}</span></li>`})}let d="";a||(d=`<ul class="b3-list b3-list--background" style="overflow: auto;width: 200px;">
<li data-type="riffCard" data-index="0" class="b3-list-item${r?"":" b3-list-item--focus"}">
    <svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg>
    <span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span>
    <span class="b3-list-item__meta">${K(window.siyuan.config.keymap.general.riffCard.custom)}</span>
</li>`,Mr().forEach((u,f)=>{d+=`<li data-type="${u.type}" data-index="${f+1}" class="b3-list-item">
    <svg class="b3-list-item__graphic"><use xlink:href="#${u.icon}"></use></svg>
    <span class="b3-list-item__text">${u.title}</span>
    <span class="b3-list-item__meta">${K(u.hotkey||"")}</span>
</li>`}),d=d+"</ul>"),X(["dialog"]),Mn=new me({positionId:p.Constants.DIALOG_SWITCHTAB,title:window.siyuan.languages.switchTab,content:`<div class="fn__flex-column switch-doc">
    <input style="opacity: 0;height: 0.1px;box-sizing: border-box;margin: 0;padding: 0;border: 0;">
    <div class="fn__flex" style="overflow:auto;">${d}
        <ul${a?' style="border-left:0"':""} class="b3-list b3-list--background fn__flex-1">${r}</ul>
    </div>
    <div class="switch-doc__path"></div>
</div>`}),Mn.element.setAttribute("data-key",p.Constants.DIALOG_SWITCHTAB),Mn.element.querySelector("input").focus(),$e()&&Mn.element.addEventListener("contextmenu",u=>{Db(t,u)}),Mn.element.addEventListener("click",u=>{Db(t,u)});return}if(R(e)&&!e.shiftKey&&!e.altKey&&(e.key.startsWith("Arrow")||e.key==="Enter")){const r=window.siyuan.dialogs.find(c=>{if(c.element.getAttribute("data-key")===p.Constants.DIALOG_RECENTDOCS)return!0});if(r){e.preventDefault(),$b(t,r.element,e);return}}if($(window.siyuan.config.keymap.general.recentDocs.custom,e)){Ou(),e.preventDefault();return}if(Gw(e)){e.preventDefault();return}if(e.key==="ArrowUp"||e.key==="ArrowDown"){const r=window.siyuan.dialogs.find(c=>{if(c.element.getAttribute("data-key")===p.Constants.DIALOG_VIEWCARDS)return!0});if(r){r.element.dispatchEvent(new CustomEvent("click",{detail:e.key.toLowerCase()})),e.preventDefault();return}}if($("\u2318=",e)&&!A(n,"pdf__outer")){Ts("zoomIn"),e.preventDefault();return}if($("\u23180",e)){Ts("restore"),e.preventDefault();return}if($("\u2318-",e)&&!A(n,"pdf__outer")){Ts("zoomOut"),e.preventDefault();return}if(!a&&$(window.siyuan.config.keymap.general.syncNow.custom,e)){e.preventDefault(),Ku(t);return}if($(window.siyuan.config.keymap.general.commandPanel.custom,e)){e.preventDefault(),Ab(t);return}if($(window.siyuan.config.keymap.general.editReadonly.custom,e)){e.preventDefault(),Oe.setReadonly(!window.siyuan.config.editor.readOnly);return}if($(window.siyuan.config.keymap.general.lockScreen.custom,e)){Xm(t),e.preventDefault();return}if(!a&&$(window.siyuan.config.keymap.general.dataHistory.custom,e)){window.siyuan.config.readonly||Dd(t),e.preventDefault();return}if(!a&&$(window.siyuan.config.keymap.general.toggleDock.custom,e)){Bg(document.querySelector("#barDock use")),e.preventDefault();return}if(!a&&!window.siyuan.config.readonly&&$(window.siyuan.config.keymap.general.config.custom,e)){As(t),e.preventDefault();return}if($("\u2318A",e)&&!["INPUT","TEXTAREA"].includes(n.tagName)){e.preventDefault();return}if(Mr().find(r=>{if($(r.hotkey,e))return St(r.type).toggleModel(r.type),e.preventDefault(),!0}))return;if(!a&&$(window.siyuan.config.keymap.general.riffCard.custom,e)){Co(t),document.activeElement&&document.activeElement.blur(),e.preventDefault();return}if(!a&&$(window.siyuan.config.keymap.general.dailyNote.custom,e)){Zp(t),e.stopPropagation(),e.preventDefault();return}if($(window.siyuan.config.keymap.general.newFile.custom,e)){gi({app:t,useSavePath:!0}),e.preventDefault();return}const s=document.querySelector("#confirmDialogConfirmBtn");if(s){if(e.key==="Enter"){s.dispatchEvent(new CustomEvent("click")),e.preventDefault();return}else if(e.key==="Escape"){s.previousElementSibling.previousElementSibling.dispatchEvent(new CustomEvent("click")),e.preventDefault();return}}if(e.key==="Escape"&&!e.isComposing){const r=document.querySelector(".protyle-img");if(r){r.remove();return}if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&!(window.siyuan.dialogs.length>0&&window.siyuan.menus.menu.element.style.zIndex<window.siyuan.dialogs[0].element.querySelector(".b3-dialog").style.zIndex)){window.siyuan.menus.menu.remove();return}const c=document.querySelector(".av__panel");if(c){const h=document.querySelector(".av__cell--select");h&&le(x(h)),c.remove();return}if(window.siyuan.dialogs.length>0){window.siyuan.dialogs[window.siyuan.dialogs.length-1].destroy();return}const d={oid:0};window.siyuan.blockPanels.forEach(h=>{if((h.targetElement||typeof h.x=="number")&&h.element.getAttribute("data-pin")==="true"){const m=parseInt(h.element.getAttribute("data-level")),b=h.element.getAttribute("data-oid");d[b]?m>d[b]&&(d[b]=m):d[b]=1}});let u=!1;for(let h=0;h<window.siyuan.blockPanels.length;h++){const m=window.siyuan.blockPanels[h];(m.targetElement||typeof m.x=="number")&&m.element.getAttribute("data-pin")==="false"&&(m.destroy(),u=!0,h--)}if(u)return;let f;if(getSelection().rangeCount>0){if(f=getSelection().getRangeAt(0),A(f.startContainer,"protyle-content",!0)){Z(f);return}}else f=document.createRange();const g=window.siyuan.backStack[window.siyuan.backStack.length-1];if(g&&g.protyle.toolbar.range)Z(g.protyle.toolbar.range);else{const h=Pe().editor[0];h&&le(h.editor.protyle.wysiwyg.element.firstElementChild)}e.preventDefault();return}if(!a&&$(window.siyuan.config.keymap.general.mainMenu.custom,e)){Ib(t,document.querySelector("#barWorkspace").getBoundingClientRect()),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goForward.custom,e)){jd(t),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goBack.custom,e)){Gd(t),e.preventDefault();return}if($(window.siyuan.config.keymap.general.closeTab.custom,e)&&!e.repeat){e.preventDefault();const r=document.querySelector(".layout__tab--active");if(r&&r.getBoundingClientRect().width>0){let d="";Array.from(r.classList).find(u=>{if(u.startsWith("sy__"))return d=u.replace("sy__",""),!0}),d&&St(d)?.toggleModel(d,!1,!0);return}const c=Qa(!1);c&&c.parent.removeTab(c.id);return}if($(window.siyuan.config.keymap.general.goToTab1.custom,e)&&!e.repeat){jn(0),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTab2.custom,e)&&!e.repeat){jn(1),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTab3.custom,e)&&!e.repeat){jn(2),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTab4.custom,e)&&!e.repeat){jn(3),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTab5.custom,e)&&!e.repeat){jn(4),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTab6.custom,e)&&!e.repeat){jn(5),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTab7.custom,e)&&!e.repeat){jn(6),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTab8.custom,e)&&!e.repeat){jn(7),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTab9.custom,e)&&!e.repeat){jn(-1),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTabNext.custom,e)&&!e.repeat){jn(-3),e.preventDefault();return}if($(window.siyuan.config.keymap.general.goToTabPrev.custom,e)&&!e.repeat){jn(-2),e.preventDefault();return}if($(window.siyuan.config.keymap.general.closeOthers.custom,e)&&!e.repeat){const r=Qa(!1);r&&ca(r,"closeOthers"),e.preventDefault();return}if($(window.siyuan.config.keymap.general.closeAll.custom,e)&&!e.repeat){const r=Qa(!1);r&&ca(r,"closeAll"),e.preventDefault();return}if($(window.siyuan.config.keymap.general.closeUnmodified.custom,e)&&!e.repeat){const r=Qa(!1);if(r){const c=[];r.parent.children.forEach(d=>{const u=d.model;(!u||u.editor?.protyle&&!u.editor?.protyle.updated)&&c.push(d)}),c.length>0&&ca(r,"other",c)}e.preventDefault();return}if(($(window.siyuan.config.keymap.general.closeLeft.custom,e)||$(window.siyuan.config.keymap.general.closeRight.custom,e))&&!e.repeat){const r=Qa(!1);if(r){const c=[],d=[];let u=-1;r.parent.children.forEach((f,g)=>{f.id===r.id&&(u=g),u===-1?c.push(f):g>u&&d.push(f)}),$(window.siyuan.config.keymap.general.closeLeft.custom,e)?c.length>0&&ca(r,"other",c):d.length>0&&ca(r,"other",d)}e.preventDefault();return}if(($(window.siyuan.config.keymap.general.splitLR.custom,e)||$(window.siyuan.config.keymap.general.splitMoveR.custom,e)||$(window.siyuan.config.keymap.general.splitTB.custom,e)||$(window.siyuan.config.keymap.general.tabToWindow.custom,e)||$(window.siyuan.config.keymap.general.splitMoveB.custom,e))&&!e.repeat){e.preventDefault();const r=Qa(!1);if(r){if($(window.siyuan.config.keymap.general.tabToWindow.custom,e))pa(r);else if($(window.siyuan.config.keymap.general.splitLR.custom,e))r.parent.split("lr").addTab(qr(t,r));else if($(window.siyuan.config.keymap.general.splitTB.custom,e))r.parent.split("tb").addTab(qr(t,r));else if(r.parent.children.length>1){const c=r.parent.split($(window.siyuan.config.keymap.general.splitMoveB.custom,e)?"tb":"lr");c.headersElement.append(r.headElement),c.headersElement.parentElement.classList.remove("fn__none"),c.moveTab(r),jt()}}return}if($(window.siyuan.config.keymap.general.stickSearch.custom,e)){if(getSelection().rangeCount>0){const r=getSelection().getRangeAt(0);Fn(t,r.toString(),!1)}else Fn(t,"",!1);e.preventDefault();return}if(uk(t,e)||!a&&fk(t,e)||!a&&pk(t,e))return;let o=!1;if(t.plugins.find(r=>{if(r.commands.find(c=>{if(c.callback&&!c.fileTreeCallback&&!c.editorCallback&&!c.dockCallback&&!c.globalCallback&&$(c.customHotkey,e))return o=!0,c.callback(),!0}),o)return!0}),o)return e.stopPropagation(),e.preventDefault(),!0;let l="";if($(window.siyuan.config.keymap.general.replace.custom,e)?l=p.Constants.DIALOG_REPLACE:!A(n,"pdf__outer")&&$(window.siyuan.config.keymap.general.search.custom,e)?l=p.Constants.DIALOG_SEARCH:$(window.siyuan.config.keymap.general.globalSearch.custom,e)&&(l=p.Constants.DIALOG_GLOBALSEARCH),l){if(getSelection().rangeCount>0){const r=getSelection().getRangeAt(0);_n({app:t,hotkey:l,key:r.toString()})}else _n({app:t,hotkey:l});e.preventDefault();return}if($("\u2318S",e))return e.preventDefault(),!0},xs=t=>{const e=[window.siyuan.config.keymap.general.toggleWin.custom];t.plugins.forEach(n=>{n.commands.forEach(a=>{a.globalCallback&&e.push(a.customHotkey)})}),te.ipcRenderer.send(p.Constants.SIYUAN_HOTKEY,{languages:window.siyuan.languages._trayMenu,hotkeys:e})},Je={element:void 0,_genItem(t,e){let n="";return Object.keys(t).forEach(a=>{if(window.siyuan.languages[a]){const i=K(t[a].custom);n+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${window.siyuan.languages[a]}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${i}</span>
    <input data-key="${e+p.Constants.ZWSP+a}" data-value="${t[a].custom}" data-default="${t[a].default}" class="b3-text-field fn__none" value="${i}" spellcheck="false">
</label>`}}),n},genHTML(t){let e="";return t.plugins.forEach(n=>{let a="";n.commands.forEach(i=>{const s=K(i.customHotkey);a+=`<label class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
    <span class="b3-list-item__text">${i.langText||(n.i18n?n.i18n[i.langKey]:"")||i.langKey}</span>
    <span data-type="reset" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.reset}">
        <svg><use xlink:href="#iconUndo"></use></svg>
    </span>
    <span data-type="clear" class="b3-list-item__action b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.remove}">
        <svg><use xlink:href="#iconTrashcan"></use></svg>
    </span>
    <span data-type="update" class="config-keymap__key">${s}</span>
    <input data-key="plugin${p.Constants.ZWSP}${n.name}${p.Constants.ZWSP}${i.langKey}" data-value="${i.customHotkey}" data-default="${i.hotkey}" class="b3-text-field fn__none" value="${s}" spellcheck="false">
</label>`}),a&&(e+=`<div class="b3-list-item b3-list-item--narrow toggle">
    <span class="b3-list-item__toggle b3-list-item__toggle--hl">
        <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
    </span>
    <span class="b3-list-item__text ft__on-surface">${n.displayName}</span>
</div>
<div class="fn__none b3-list__panel">
    ${a}
</div>`)}),e&&(e=`<div class="b3-list b3-list--border b3-list--background">
    <div class="b3-list-item b3-list-item--narrow toggle">
        <span class="b3-list-item__toggle b3-list-item__toggle--hl">
            <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
        </span>
        <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.plugin}</span>
    </div>
    <div class="b3-list__panel">
        ${e}
    </div>
</div>`),`<div class="fn__flex b3-label config__item">
    <span class="fn__flex-center">${window.siyuan.languages.keymapTip}</span>
    <span class="fn__flex-1"></span>
    <button id="keymapRefreshBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
        <svg><use xlink:href="#iconRefresh"></use></svg>
        ${window.siyuan.languages.refresh}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <span class="fn__flex-center">${window.siyuan.languages.keymapTip2}</span>
    <span class="fn__flex-1"></span>
    <span class="fn__space"></span>
    <button id="keymapResetBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
        <svg><use xlink:href="#iconUndo"></use></svg>
        ${window.siyuan.languages.reset}
    </button>
</div>
<div class="b3-label file-tree config-keymap" id="keymapList">
    <div class="fn__flex config__item">
        <label class="b3-form__icon fn__block">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
            <input id="keymapInput" class="b3-form__icon-input b3-text-field fn__block" placeholder="${window.siyuan.languages.search}">
        </label>
        <div class="fn__space"></div>
        <label class="b3-form__icon fn__block searchByKeyLabel">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconKeymap"></use></svg>
            <input id="searchByKey" class="b3-form__icon-input b3-text-field fn__block" spellcheck="false" placeholder="${window.siyuan.languages.keymap}">
        </label>
        <div class="fn__space"></div>
        <button id="clearSearchBtn" class="b3-button b3-button--outline fn__flex-center fn__size200">
            <svg style="height: 14px"><use xlink:href="#iconClose"></use></svg>
            ${window.siyuan.languages.clear}
        </button>
    </div>
    <div class="fn__hr"></div>
    <div class="b3-list b3-list--border b3-list--background">
        <div class="b3-list-item b3-list-item--narrow toggle">
            <span class="b3-list-item__toggle b3-list-item__toggle--hl"><svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg></span>
            <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.general}</span>
        </div>
        <div class="fn__none b3-list__panel">${Je._genItem(window.siyuan.config.keymap.general,"general")}</div>
    </div>
    <div class="b3-list b3-list--border b3-list--background">
        <div class="b3-list-item b3-list-item--narrow toggle">
            <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                <svg class="b3-list-item__arrow b3-list-item__arrow--open"><use xlink:href="#iconRight"></use></svg>
            </span>
            <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.editor}</span>
        </div>
        <div class="b3-list__panel">
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.general}</span>
            </div>
            <div class="fn__none b3-list__panel">${Je._genItem(window.siyuan.config.keymap.editor.general,"editor"+p.Constants.ZWSP+"general")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.insert}</span>
            </div>
            <div class="fn__none b3-list__panel">${Je._genItem(window.siyuan.config.keymap.editor.insert,"editor"+p.Constants.ZWSP+"insert")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.headings}</span>
            </div>
            <div class="fn__none b3-list__panel">${Je._genItem(window.siyuan.config.keymap.editor.heading,"editor"+p.Constants.ZWSP+"heading")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.list1}</span>
            </div>
            <div class="fn__none b3-list__panel">${Je._genItem(window.siyuan.config.keymap.editor.list,"editor"+p.Constants.ZWSP+"list")}</div>
            <div class="b3-list-item b3-list-item--narrow toggle">
                <span class="b3-list-item__toggle b3-list-item__toggle--hl">
                    <svg class="b3-list-item__arrow"><use xlink:href="#iconRight"></use></svg>
                </span>
                <span class="b3-list-item__text ft__on-surface">${window.siyuan.languages.table}</span>
            </div>
            <div class="fn__none b3-list__panel">${Je._genItem(window.siyuan.config.keymap.editor.table,"editor"+p.Constants.ZWSP+"table")}</div>
        </div>
    </div>
    ${e}
</div>`},_setkeymap(t){const e=JSON.parse(JSON.stringify(p.Constants.SIYUAN_KEYMAP));Je.element.querySelectorAll("label.b3-list-item input").forEach(n=>{const a=n.getAttribute("data-key").split(p.Constants.ZWSP),i=n.getAttribute("data-value");a[0]==="plugin"?(window.siyuan.config.keymap.plugin[a[1]][a[2]].custom=i,e.plugin=window.siyuan.config.keymap.plugin,t.plugins.forEach(s=>{s.name===a[1]&&s.commands.forEach(o=>{o.langKey===a[2]&&(o.customHotkey=i)})})):a[0]==="general"?e[a[0]][a[1]].custom=i:a[0]==="editor"&&(a[1]==="general"||a[1]==="insert"||a[1]==="heading"||a[1]==="list"||a[1]==="table")&&(e[a[0]][a[1]][a[2]].custom=i)}),window.siyuan.config.keymap=e,w("/api/setting/setKeymap",{data:e},()=>{xs(t)})},search(t,e){Je.element.querySelectorAll("#keymapList .b3-list-item--hide-action > .b3-list-item__text").forEach(a=>{const i=a.parentElement;let s=!1;if((e===""||i.querySelector(".b3-text-field").value.indexOf(K(e))>-1)&&(s=!0),(a.textContent.toLowerCase().indexOf(t.toLowerCase())>-1||t.toLowerCase().indexOf(a.textContent.toLowerCase())>-1||t==="")&&s?(i.classList.remove("fn__none"),i.parentElement.classList.remove("fn__none"),i.parentElement.parentElement.classList.remove("fn__none")):i.classList.add("fn__none"),!i.nextElementSibling){const o=i.parentElement.previousElementSibling,l=o.querySelector(".b3-list-item__arrow");t===""&&e===""&&(l.classList.contains("b3-list-item__arrow--open")?i.parentElement.classList.remove("fn__none"):i.parentElement.classList.add("fn__none")),i.parentElement.childElementCount===i.parentElement.querySelectorAll(".b3-list-item.fn__none").length?o.classList.add("fn__none"):o.classList.remove("fn__none")}});const n=Je.element.querySelector("#keymapList").lastElementChild;t===""&&e===""&&(n.querySelector(".b3-list-item__arrow").classList.contains("b3-list-item__arrow--open")?n.lastElementChild.classList.remove("fn__none"):n.lastElementChild.classList.add("fn__none")),n.querySelectorAll(".b3-list-item--hide-action.fn__none").length===n.querySelectorAll(".b3-list-item--hide-action").length?n.firstElementChild.classList.add("fn__none"):n.firstElementChild.classList.remove("fn__none")},_getTip(t){const e=t.parentElement;let n=e.querySelector(".b3-list-item__text").textContent.trim();const a=e.parentElement.previousElementSibling;n=a.textContent.trim()+"-"+n;const i=a.parentElement.previousElementSibling;return i.classList.contains("b3-list-item")&&(n=i.textContent.trim()+"-"+n),n},bindEvent(t){Je.element.querySelector("#keymapRefreshBtn").addEventListener("click",()=>{It({cb(){window.location.reload()},errorExit:!1})});const e=Je.element.querySelector("#keymapInput"),n=Je.element.querySelector("#searchByKey");e.addEventListener("compositionend",()=>{Je.search(e.value,n.value)}),e.addEventListener("input",s=>{s.isComposing||Je.search(e.value,n.value)}),n.addEventListener("focus",()=>{te.ipcRenderer.send(p.Constants.SIYUAN_CMD,{cmd:"unregisterAll"})}),n.addEventListener("blur",()=>{xs(t)}),n.addEventListener("keydown",function(s){s.stopPropagation(),s.preventDefault();const o=Je._getKeymapString(s);setTimeout(()=>{this.value=K(o)}),Je.search(e.value,o)}),Je.element.querySelector("#clearSearchBtn").addEventListener("click",()=>{e.value="",n.value="",Je.search("","")}),Je.element.querySelector("#keymapResetBtn").addEventListener("click",()=>{Ne(window.siyuan.languages.reset,window.siyuan.languages.confirmReset,()=>{w("/api/setting/setKeymap",{data:p.Constants.SIYUAN_KEYMAP},()=>{window.location.reload(),xs(t)})})});const a=Je.element.querySelector("#keymapList");a.addEventListener("click",s=>{let o=s.target;for(;o&&!o.isEqualNode(a);){const l=o.getAttribute("data-type");if(l==="reset"){const r=o.parentElement.querySelector(".b3-text-field");r.value=K(r.getAttribute("data-default")),r.setAttribute("data-value",r.getAttribute("data-default")),r.previousElementSibling.textContent=r.value,Je._setkeymap(t),s.preventDefault(),s.stopPropagation();break}else if(l==="clear"){const r=o.parentElement.querySelector(".b3-text-field");r.value="",r.previousElementSibling.textContent="",r.setAttribute("data-value",""),Je._setkeymap(t),s.preventDefault(),s.stopPropagation();break}else if(l==="update"){o.classList.add("fn__none");const r=o.nextElementSibling;r.classList.remove("fn__none"),r.focus(),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("b3-list-item--hide-action")){const r=o.querySelector(".b3-text-field");r.classList.remove("fn__none"),r.focus(),r.previousElementSibling.classList.add("fn__none"),s.preventDefault(),s.stopPropagation();break}else if(o.classList.contains("toggle")){o.nextElementSibling.classList.contains("fn__none")?(o.firstElementChild.firstElementChild.classList.add("b3-list-item__arrow--open"),o.nextElementSibling.classList.remove("fn__none")):(o.firstElementChild.firstElementChild.classList.remove("b3-list-item__arrow--open"),o.nextElementSibling.classList.add("fn__none")),s.preventDefault(),s.stopPropagation();break}o=o.parentElement}});let i;a.querySelectorAll("label.b3-list-item input").forEach(s=>{s.addEventListener("keydown",function(o){o.stopPropagation(),o.preventDefault();const l=Je._getKeymapString(o),r=K(l);clearTimeout(i),i=window.setTimeout(()=>{const c=this.getAttribute("data-key").split(p.Constants.ZWSP);c[1]==="list"&&(c[1]="list1"),c[1]==="heading"&&(c[1]="headings");let d=!1;if((["\u2318","\u21E7","\u2325","\u2303"].includes(l.substr(l.length-1,1))||["\u2318A","\u2318X","\u2318C","\u2318V","\u2318-","\u2318=","\u23180","\u21E7\u2318V","\u2318/","\u21E7\u2191","\u21E7\u2193","\u21E7\u2192","\u21E7\u2190","\u21E7\u21E5","\u2303D","\u21E7\u2318\u2192","\u21E7\u2318\u2190","\u2318Home","\u2318End","\u21E7\u21A9","\u21A9","PageUp","PageDown","\u232B","\u2326"].includes(l)||$e()&&c[0]==="general"&&["goToEditTabNext","goToEditTabPrev"].includes(c[1])&&l.includes("\u2318"))&&(M(`${window.siyuan.languages.invalid} [${r}]`),d=!0),Array.from(Je.element.querySelectorAll("label.b3-list-item input")).find(u=>{if(!u.isSameNode(this)&&u.getAttribute("data-value")===l){const f=u.getAttribute("data-key").split(p.Constants.ZWSP);return f[1]==="list"&&(f[1]="list1"),f[1]==="heading"&&(f[1]="headings"),M(`${window.siyuan.languages.conflict} [${Je._getTip(u)} ${r}]`),d=!0,!0}}),d){this.value=K(this.getAttribute("data-value"));return}W(),this.setAttribute("data-value",l),this.value=r,Je._setkeymap(t)},p.Constants.TIMEOUT_TRANSITION)}),s.addEventListener("blur",function(){xs(t),setTimeout(()=>{this.classList.add("fn__none"),this.previousElementSibling.textContent=this.value,this.previousElementSibling.classList.remove("fn__none")},p.Constants.TIMEOUT_INPUT)}),s.addEventListener("focus",()=>{te.ipcRenderer.send(p.Constants.SIYUAN_CMD,{cmd:"unregisterAll"})})})},_getKeymapString(t){let e="";return t.ctrlKey&&$e()&&(e+="\u2303"),t.altKey&&(e+="\u2325"),t.shiftKey&&(e+="\u21E7"),(t.metaKey||!$e()&&t.ctrlKey)&&(e+="\u2318"),t.key!=="Shift"&&t.key!=="Alt"&&t.key!=="Meta"&&t.key!=="Control"&&t.key!=="Unidentified"&&(t.keyCode===229?t.code==="Minus"?e+="-":t.code==="Semicolon"?e+=";":t.code==="Quote"?e+="'":t.code==="Comma"?e+=",":t.code==="Period"?e+=".":t.code==="Slash"&&(e+="/"):e+=p.Constants.KEYCODELIST[t.keyCode]||(t.key.length>1?t.key:t.key.toUpperCase())),e}},vn=t=>{const e=[];return t.forEach(n=>{e.push(window.siyuan.languages[n])}),e},hk=(t,e)=>{const n=[vn(["config","fullWidth","md7","md8","md37","md38","editor","md2","md3","md12","md16","md27","md28","md29","md30","md31","md32","md33","md34","md39","md40","fontSizeTip","fontSize","font","font1","generateHistory","generateHistoryInterval","historyRetentionDays","historyRetentionDaysTip","clearHistory","katexMacros","katexMacrosTip","editReadonly","editReadonlyTip","embedBlockBreadcrumb","embedBlockBreadcrumbTip","outlineOutdentTip","outdent","floatWindowMode","floatWindowModeTip","justify","justifyTip","rtl","rtlTip","spellcheck","spellcheckTip","backlinkExpand","backlinkExpandTip","onlySearchForDoc","onlySearchForDocTip","dynamicLoadBlocks","dynamicLoadBlocksTip","fontSizeScrollZoom","fontSizeScrollZoomTip"]),vn(["selectOpen","tabLimit","fileTree","fileTree2","fileTree3","fileTree4","fileTree5","fileTree6","fileTree7","fileTree8","fileTree9","fileTree10","fileTree12","fileTree13","fileTree15","fileTree16","fileTree17","fileTree21"]),vn(["riffCard","flashcardNewCardLimit","flashcardNewCardLimitTip","flashcardReviewCardLimit","flashcardNewCardLimit","flashcardReviewCardLimitTip","flashcardMark","flashcardMarkTip","flashcardList","flashcardSuperBlock","flashcardHeading","flashcardDeck","flashcardDeckTip","flashcardFSRSParamRequestRetention","flashcardFSRSParamRequestRetentionTip","flashcardFSRSParamMaximumInterval","flashcardFSRSParamMaximumIntervalTip","flashcardFSRSParamWeights","flashcardFSRSParamWeightsTip"]),["AI"].concat(vn(["ai","apiTimeout","apiTimeoutTip","apiMaxTokens","apiMaxTokensTip","apiKey","apiKeyTip","apiProxy","apiProxyTip","apiBaseURL","apiBaseURLTip"])),vn(["assets","unreferencedAssets","missingAssets"]),vn(["paragraphBeginningSpace","md4","export","export1","export2","export5","export9","export11","export13","export14","export15","export19","export20","ref","blockEmbed","export17","export18","export23","export24","export25","export26","export27","export28","export29"]),vn(["language","language1","appearance","appearance1","appearance2","appearance3","appearance4","appearance5","appearance6","appearance8","appearance9","appearance10","appearance11","appearance16","appearance17","resetLayout","reset","icon","themeLight","themeDark","close","themeOS","theme","theme2","theme11","theme12","customEmoji","customEmojiTip","refresh"]),vn(["bazaar","theme","template","icon","widget"]),vn(["search","searchLimit","searchLimit1","memo","name","alias","keywordsLimit","doc","headings","list1","listItem","code","math","table","quote","superBlock","paragraph","indexAssetPath","embedBlock","database","searchBackmention","searchVirtualRef","searchBlockAttr","searchBlockType","searchCaseSensitive"]),vn(["keymap","keymapTip2"].concat(Object.keys(p.Constants.SIYUAN_KEYMAP.general)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.general)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.heading)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.insert)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.list)).concat(Object.keys(p.Constants.SIYUAN_KEYMAP.editor.table))),vn(["cloudStorage","trafficStat","sync","backup","cdn","total","sizeLimit","cloudBackup","cloudBackupTip","updatePath","cloudSync","upload","download","syncMode","syncModeTip","generateConflictDoc","generateConflictDocTip","syncProvider","syncProviderTip","syncMode1","syncMode2","reposTip","openSyncTip1","openSyncTip2","cloudSyncDir","config"]),vn(["accountTip","accountName","password","captcha","forgetPassword","login","register","twoFactorCaptcha","account1","account2","account5"]),vn(["autoLaunch","autoLaunchTip","about","about1","about2","about3","about4","about5","about6","about7","about8","about9","about10","about11","about12","about13","about14","about17","config","dataRepoKey","dataRepoKeyTip1","dataRepoKeyTip2","slogan","currentVer","checkUpdate","updatePath","systemLog","importKey","genKey","genKeyByPW","copyKey","resetRepo","systemLogTip","export","downloadLatestVer","safeQuit","directConnection","siyuanNote","key","password","copied","resetRepoTip","autoDownloadUpdatePkg","autoDownloadUpdatePkgTip","networkProxy","keyPlaceholder","initRepoKeyTip","googleAnalytics","googleAnalyticsTip"])],a=t.querySelector(".b3-form__icon input");a.focus();const i=()=>{const s=[],o=a.value;n.map((c,d)=>{c.map(u=>{u||console.warn("Search config miss language: ",c,d),u&&(o.toLowerCase().indexOf(u.toLowerCase())>-1||u.toLowerCase().indexOf(o.toLowerCase())>-1)&&s.push(d)})});let l;t.querySelectorAll(".b3-tab-bar li").forEach((c,d)=>{if(s.includes(d)){l||(l=c);const u=c.getAttribute("data-name");if(c.style.display="",["image","bazaar","account"].includes(u))return;const f=t.querySelector(`.config__tab-container[data-name="${u}"]`);if(f.innerHTML===""&&Pb(u,f,e),u==="keymap"){const g=Je.element.querySelector("#keymapInput"),h=Je.element.querySelector("#searchByKey");g.value=o,h.value="",Je.search(g.value,h.value)}else f.querySelectorAll(`.config__tab-container[data-name="${u}"] .b3-label`).forEach(g=>{if(!g.classList.contains("fn__none")){const h=g.textContent.toLowerCase();h.indexOf(o.toLowerCase())>-1||o.toLowerCase().indexOf(h)>-1?g.style.display="":g.style.display="none"}})}else c.style.display="none"});const r=t.querySelectorAll(".config__tab-container");l?l.click():r.forEach(c=>{c.classList.add("fn__none")}),a.focus()};a.addEventListener("compositionend",()=>{i()}),a.addEventListener("input",s=>{s.isComposing||i()})},Ht={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.selectOpen}
        <div class="b3-label__text">${window.siyuan.languages.fileTree2}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="alwaysSelectOpenedFile" type="checkbox"${window.siyuan.config.fileTree.alwaysSelectOpenedFile?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree7}
        <div class="b3-label__text">${window.siyuan.languages.fileTree8}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="openFilesUseCurrentTab" type="checkbox"${window.siyuan.config.fileTree.openFilesUseCurrentTab?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree9}
        <div class="b3-label__text">${window.siyuan.languages.fileTree10}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="closeTabsOnStart" type="checkbox"${window.siyuan.config.fileTree.closeTabsOnStart?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree18}
        <div class="b3-label__text">${window.siyuan.languages.fileTree19}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="allowCreateDeeper" type="checkbox"${window.siyuan.config.fileTree.allowCreateDeeper?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree3}
        <div class="b3-label__text">${window.siyuan.languages.fileTree4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="removeDocWithoutConfirm" type="checkbox"${window.siyuan.config.fileTree.removeDocWithoutConfirm?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree20}
        <div class="b3-label__text">${window.siyuan.languages.fileTree21}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="useSingleLineSave" type="checkbox"${window.siyuan.config.fileTree.useSingleLineSave?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree12}
        <div class="b3-label__text">${window.siyuan.languages.fileTree13}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="docCreateSavePath" value="">
</div>
<div class="b3-label fn__flex config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree5}
        <div class="b3-label__text">${window.siyuan.languages.fileTree6}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="refCreateSavePath" value="${window.siyuan.config.fileTree.refCreateSavePath}">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.fileTree16}
        <div class="b3-label__text">${window.siyuan.languages.fileTree17}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maxListCount" type="number" min="1" max="10240" value="${window.siyuan.config.fileTree.maxListCount}">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.tabLimit}
        <div class="b3-label__text">${window.siyuan.languages.tabLimit1}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maxOpenTabCount" type="number" min="1" max="32" value="${window.siyuan.config.fileTree.maxOpenTabCount}">
</div>`,_send(){let t=parseInt(Ht.element.querySelector("#maxOpenTabCount").value);32<t&&(t=32,Ht.element.querySelector("#maxOpenTabCount").value="32"),1>t&&(t=1,Ht.element.querySelector("#maxOpenTabCount").value="1"),w("/api/setting/setFiletree",{sort:window.siyuan.config.fileTree.sort,alwaysSelectOpenedFile:Ht.element.querySelector("#alwaysSelectOpenedFile").checked,refCreateSavePath:Ht.element.querySelector("#refCreateSavePath").value,docCreateSavePath:Ht.element.querySelector("#docCreateSavePath").value,openFilesUseCurrentTab:Ht.element.querySelector("#openFilesUseCurrentTab").checked,closeTabsOnStart:Ht.element.querySelector("#closeTabsOnStart").checked,allowCreateDeeper:Ht.element.querySelector("#allowCreateDeeper").checked,removeDocWithoutConfirm:Ht.element.querySelector("#removeDocWithoutConfirm").checked,useSingleLineSave:Ht.element.querySelector("#useSingleLineSave").checked,maxListCount:parseInt(Ht.element.querySelector("#maxListCount").value),maxOpenTabCount:t},e=>{Ht.onSetfiletree(e.data)})},bindEvent:()=>{Ht.element.querySelector("#docCreateSavePath").value=window.siyuan.config.fileTree.docCreateSavePath,Ht.element.querySelector("#refCreateSavePath").value=window.siyuan.config.fileTree.refCreateSavePath,Ht.element.querySelectorAll("input").forEach(t=>{t.addEventListener("change",()=>{Ht._send()})})},onSetfiletree:t=>{window.siyuan.config.fileTree=t}},We={element:void 0,genHTML:()=>`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.paragraphBeginningSpace}
        <div class="b3-label__text">${window.siyuan.languages.md4}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="paragraphBeginningSpace" type="checkbox"${window.siyuan.config.export.paragraphBeginningSpace?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export17}
        <div class="b3-label__text">${window.siyuan.languages.export18}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="addTitle" type="checkbox"${window.siyuan.config.export.addTitle?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export23}
        <div class="b3-label__text">${window.siyuan.languages.export24}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="markdownYFM" type="checkbox"${window.siyuan.config.export.markdownYFM?" checked":""}/>
</label>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.ref}
        <div class="b3-label__text">${window.siyuan.languages.export11}</div>
    </div>
    <span class="fn__space"></span>
    <select id="blockRefMode" class="b3-select fn__flex-center fn__size200">
        <option value="2" ${window.siyuan.config.export.blockRefMode===2?"selected":""}>${window.siyuan.languages.export2}</option>
        <option value="3" ${window.siyuan.config.export.blockRefMode===3?"selected":""}>${window.siyuan.languages.export3}</option>
        <option value="4" ${window.siyuan.config.export.blockRefMode===4?"selected":""}>${window.siyuan.languages.export4}</option>
    </select>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.blockEmbed}
        <div class="b3-label__text">${window.siyuan.languages.export12}</div>
    </div>
    <span class="fn__space"></span>
    <select id="blockEmbedMode" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.export.blockEmbedMode===0?"selected":""}>${window.siyuan.languages.export0}</option>
        <option value="1" ${window.siyuan.config.export.blockEmbedMode===1?"selected":""}>${window.siyuan.languages.export1}</option>
    </select>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export5}
        <div class="b3-label__text">${window.siyuan.languages.export6}</div>
    </div>
    <span class="fn__space"></span>
    <select id="fileAnnotationRefMode" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.export.fileAnnotationRefMode===0?"selected":""}>${window.siyuan.languages.export7}</option>
        <option value="1" ${window.siyuan.config.export.fileAnnotationRefMode===1?"selected":""}>${window.siyuan.languages.export8}</option>
    </select>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export21}
        <div class="b3-label__text">${window.siyuan.languages.export22}</div>
    </div>
    <input class="b3-text-field fn__flex-center fn__size200" id="pdfFooter">
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.export27}
    <div class="b3-label__text">${window.siyuan.languages.export28}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="pdfWatermarkStr">
    <div class="fn__hr"></div>
    <div class="b3-label__text"><a href="https://pdfcpu.io/core/watermark#description" target="_blank">${window.siyuan.languages.export29}</a></div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" id="pdfWatermarkDesc"></textarea>
</div>
<div class="b3-label config__item">
    ${window.siyuan.languages.export9}
    <div class="b3-label__text">${window.siyuan.languages.export28}</div>
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block" id="imageWatermarkStr">
    <div class="fn__hr"></div>
    <div class="b3-label__text">${window.siyuan.languages.export29}</div>
    <div class="fn__hr"></div>
    <textarea class="b3-text-field fn__block" id="imageWatermarkDesc"></textarea>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export25}
        <div class="b3-label__text">${window.siyuan.languages.export26}</div>
    </div>
    <input class="b3-text-field fn__flex-center fn__size200" id="docxTemplate" placeholder="F:\\template.docx">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export13}
        <div class="b3-label__text">${window.siyuan.languages.export14}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="blockRefTextLeft">
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="blockRefTextRight">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export15}
        <div class="b3-label__text">${window.siyuan.languages.export16}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="tagOpenMarker">
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size96" id="tagCloseMarker">
</div>
<div class="fn__flex b3-label config__item${(0,I.jU)()?" fn__none":""}">
    <div class="fn__flex-1">
        ${window.siyuan.languages.export19}
        <span class="fn__space"></span>
        <a href="javascript:void(0)" id="pandocBinPath" style="word-break: break-all">${window.siyuan.config.export.pandocBin}</a>
        <div class="b3-label__text">${window.siyuan.languages.export20}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="pandocBin"><svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}</button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.export} Data
        <div class="b3-label__text">${window.siyuan.languages.exportDataTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" id="exportData">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1 fn__flex-center">
        ${window.siyuan.languages.import} Data
        <div class="b3-label__text">${window.siyuan.languages.importDataTip}</div>
    </div>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--outline fn__flex-center fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
</div>`,bindEvent:()=>{We.element.querySelector("#docxTemplate").value=window.siyuan.config.export.docxTemplate,We.element.querySelector("#pdfFooter").value=window.siyuan.config.export.pdfFooter,We.element.querySelector("#pdfWatermarkStr").value=window.siyuan.config.export.pdfWatermarkStr,We.element.querySelector("#pdfWatermarkDesc").value=window.siyuan.config.export.pdfWatermarkDesc,We.element.querySelector("#imageWatermarkStr").value=window.siyuan.config.export.imageWatermarkStr,We.element.querySelector("#imageWatermarkDesc").value=window.siyuan.config.export.imageWatermarkDesc,We.element.querySelector("#blockRefTextLeft").value=window.siyuan.config.export.blockRefTextLeft,We.element.querySelector("#blockRefTextRight").value=window.siyuan.config.export.blockRefTextRight,We.element.querySelector("#tagOpenMarker").value=window.siyuan.config.export.tagOpenMarker,We.element.querySelector("#tagCloseMarker").value=window.siyuan.config.export.tagCloseMarker;const t=We.element.querySelector("#pandocBinPath"),e=a=>{w("/api/setting/setExport",{paragraphBeginningSpace:We.element.querySelector("#paragraphBeginningSpace").checked,addTitle:We.element.querySelector("#addTitle").checked,markdownYFM:We.element.querySelector("#markdownYFM").checked,blockRefMode:parseInt(We.element.querySelector("#blockRefMode").value,10),blockEmbedMode:parseInt(We.element.querySelector("#blockEmbedMode").value,10),fileAnnotationRefMode:parseInt(We.element.querySelector("#fileAnnotationRefMode").value,10),pdfFooter:We.element.querySelector("#pdfFooter").value,pdfWatermarkStr:We.element.querySelector("#pdfWatermarkStr").value,pdfWatermarkDesc:We.element.querySelector("#pdfWatermarkDesc").value,imageWatermarkStr:We.element.querySelector("#imageWatermarkStr").value,imageWatermarkDesc:We.element.querySelector("#imageWatermarkDesc").value,docxTemplate:We.element.querySelector("#docxTemplate").value,blockRefTextLeft:We.element.querySelector("#blockRefTextLeft").value,blockRefTextRight:We.element.querySelector("#blockRefTextRight").value,tagOpenMarker:We.element.querySelector("#tagOpenMarker").value,tagCloseMarker:We.element.querySelector("#tagCloseMarker").value,pandocBin:a||window.siyuan.config.export.pandocBin},i=>{We.onSetexport(i.data),t.textContent=i.data.pandocBin})};We.element.querySelectorAll("select").forEach(a=>{a.addEventListener("change",()=>{e()})}),We.element.querySelectorAll("input, textarea").forEach(a=>{a.id=="importData"?a.addEventListener("change",i=>{const s=new FormData;s.append("file",i.target.files[0]),w("/api/import/importData",s)}):a.addEventListener("change",()=>{e()})}),We.element.querySelector("#exportData").addEventListener("click",async()=>{const a=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"showOpenDialog",title:window.siyuan.languages.export+" Data",properties:["createDirectory","openDirectory"]});if(a.canceled||a.filePaths.length===0)return;const i=M(window.siyuan.languages.exporting,-1);w("/api/export/exportDataInFolder",{folder:a.filePaths[0]},s=>{dr(kt.join(a.filePaths[0],s.data.name),i)})}),t.addEventListener("click",()=>{window.siyuan.config.export.pandocBin&&Qn(window.siyuan.config.export.pandocBin)});const n=We.element.querySelector("#pandocBin");n.addEventListener("click",async()=>{const a=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"showOpenDialog",defaultPath:window.siyuan.config.system.homeDir,properties:["openFile","showHiddenFiles"]});if(a.filePaths.length===0){n.value=window.siyuan.config.export.pandocBin;return}e(a.filePaths[0])})},onSetexport:t=>{window.siyuan.config.export=t}};var mk=Ye(970);const Yu=t=>t===0?va("")?`<div class="b3-label b3-label--inner">${window.siyuan.config.system.container==="ios"?window.siyuan.languages._kernel[122]:window.siyuan.languages._kernel[29].replace("${url}",Ut("subscribe/siyuan"))}</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro1}
    <div class="b3-label__text">
        <ul class="fn__list">
            <li>${window.siyuan.languages.cloudIntro2}</li>
            <li>${window.siyuan.languages.cloudIntro3}</li>
            <li>${window.siyuan.languages.cloudIntro4}</li>
            <li>${window.siyuan.languages.cloudIntro5}</li>
            <li>${window.siyuan.languages.cloudIntro6}</li>
            <li>${window.siyuan.languages.cloudIntro7}</li>
            <li>${window.siyuan.languages.cloudIntro8}</li>
        </ul>
    </div>
</div>
<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.cloudIntro9}
    <div class="b3-label__text">
        <ul style="padding-left: 2em">
            <li>${window.siyuan.languages.cloudIntro10}</li>
            <li>${window.siyuan.languages.cloudIntro11}</li>
        </ul>
    </div>
</div>`:`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncOfficialProviderIntro}
</div>`:Ea()?t===2?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderS3Intro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.featureBetaStage}</em>
    <div class="fn__hr"></div>
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Access Key</div>
    <div class="fn__space"></div>
    <input id="accessKey" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.accessKey}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Secret Key</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="secretKey" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.s3.secretKey}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Bucket</div>
    <div class="fn__space"></div>
    <input id="bucket" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.bucket}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Region</div>
    <div class="fn__space"></div>
    <input id="region" class="b3-text-field fn__block" value="${window.siyuan.config.sync.s3.region}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.s3.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Addressing</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="pathStyle">
        <option ${window.siyuan.config.sync.s3.pathStyle?"":"selected"} value="false">Virtual-hosted-style</option>
        <option ${window.siyuan.config.sync.s3.pathStyle?"selected":""} value="true">Path-style</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="s3SkipTlsVerify">
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.s3.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="s3">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="s3">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:t===3?`<div class="b3-label b3-label--inner">
    ${window.siyuan.languages.syncThirdPartyProviderWebDAVIntro}
    <div class="fn__hr"></div>
    <em>${window.siyuan.languages.featureBetaStage}</em>
    <div class="fn__hr"></div>    
    ${window.siyuan.languages.syncThirdPartyProviderTip}
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Endpoint</div>
    <div class="fn__space"></div>
    <input id="endpoint" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.endpoint}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Username</div>
    <div class="fn__space"></div>
    <input id="username" class="b3-text-field fn__block" value="${window.siyuan.config.sync.webdav.username}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Password</div>
    <div class="fn__space"></div>
    <div class="b3-form__icona fn__block">
        <input id="password" type="password" class="b3-text-field b3-form__icona-input" value="${window.siyuan.config.sync.webdav.password}">
        <svg class="b3-form__icona-icon" data-action="togglePassword"><use xlink:href="#iconEye"></use></svg>
    </div>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">Timeout (s)</div>
    <div class="fn__space"></div>
    <input id="timeout" class="b3-text-field fn__block" type="number" min="7" max="300" value="${window.siyuan.config.sync.webdav.timeout}">
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-center fn__size200">TLS Verify</div>
    <div class="fn__space"></div>
    <select class="b3-select fn__block" id="webdavSkipTlsVerify">
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"":"selected"} value="false">Verify</option>
        <option ${window.siyuan.config.sync.webdav.skipTlsVerify?"selected":""} value="true">Skip</option>
    </select>
</div>
<div class="b3-label b3-label--inner fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline fn__size200" style="position: relative">
        <input id="importData" class="b3-form__upload" type="file" data-type="webdav">
        <svg><use xlink:href="#iconDownload"></use></svg>${window.siyuan.languages.import}
    </button>
    <div class="fn__space"></div>
    <button class="b3-button b3-button--outline fn__size200" data-action="exportData" data-type="webdav">
        <svg><use xlink:href="#iconUpload"></use></svg>${window.siyuan.languages.export}
    </button>
</div>`:"":`<div class="b3-label b3-label--inner">${window.siyuan.languages._kernel[214]}</div>`,Gu=()=>{const t=Dt.element.querySelector("#importData");t&&t.addEventListener("change",()=>{const s=new FormData;s.append("file",t.files[0]);const o=t.getAttribute("data-type")==="s3";w(o?"/api/sync/importSyncProviderS3":"/api/sync/importSyncProviderWebDAV",s,l=>{o?window.siyuan.config.sync.s3=l.data.s3:window.siyuan.config.sync.webdav=l.data.webdav,Dt.element.querySelector("#syncProviderPanel").innerHTML=Yu(window.siyuan.config.sync.provider),Gu(),M(window.siyuan.languages.imported),t.value=""})});const e=Dt.element.querySelector("#reposData"),n=Dt.element.querySelector("#reposLoading");if(window.siyuan.config.sync.provider===0){if(va("")){n.classList.add("fn__none");let s=e;for(;s;)s.classList.add("fn__none"),s=s.nextElementSibling;return}w("/api/cloud/getCloudSpace",{},s=>{if(n.classList.add("fn__none"),s.code===1){e.innerHTML=s.msg;return}else e.innerHTML=`<div class="fn__flex">
    <div class="fn__flex-1">
        ${window.siyuan.languages.cloudStorage}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sync}<span class="b3-list-item__meta">${s.data.sync?s.data.sync.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.backup}<span class="b3-list-item__meta">${s.data.backup?s.data.backup.hSize:"0B"}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${Ut("settings/file?type=3")}" target="_blank">${window.siyuan.languages.cdn}</a><span class="b3-list-item__meta">${s.data.hAssetSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.total}<span class="b3-list-item__meta">${s.data.hSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.sizeLimit}<span class="b3-list-item__meta">${s.data.hTotalSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;"><a href="${Ut("settings/point")}" target="_blank">${window.siyuan.languages.pointExchangeSize}</a><span class="b3-list-item__meta">${s.data.hExchangeSize}</span></li>
        </ul>
    </div>
    <div class="fn__flex-1">
        ${window.siyuan.languages.trafficStat}
        <div class="fn__hr"></div>
        <ul class="b3-list" style="margin-left: 12px">
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.upload}<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficUploadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">${window.siyuan.languages.download}<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficDownloadSize}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API GET<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficAPIGet}</span></li>
            <li class="b3-list-item" style="cursor: auto;">API PUT<span class="fn__space"></span><span class="ft__on-surface">${s.data.hTrafficAPIPut}</span></li>
        </ul>
    </div>
</div>`}),e.classList.remove("fn__none");return}n.classList.add("fn__none");let a=e.nextElementSibling;for(;a;)Ea()?a.classList.remove("fn__none"):a.classList.add("fn__none"),a=a.nextElementSibling;e.classList.add("fn__none");const i=Dt.element.querySelector("#syncProviderPanel");i.querySelectorAll(".b3-text-field, .b3-select").forEach(s=>{s.addEventListener("blur",()=>{if(window.siyuan.config.sync.provider===2){let o=parseInt(i.querySelector("#timeout").value,10);7>o&&(1>o?o=30:o=7),300<o&&(o=300),i.querySelector("#timeout").value=o.toString();const l={endpoint:i.querySelector("#endpoint").value,accessKey:i.querySelector("#accessKey").value,secretKey:i.querySelector("#secretKey").value,bucket:i.querySelector("#bucket").value,pathStyle:i.querySelector("#pathStyle").value==="true",region:i.querySelector("#region").value,skipTlsVerify:i.querySelector("#s3SkipTlsVerify").value==="true",timeout:o};w("/api/sync/setSyncProviderS3",{s3:l},()=>{window.siyuan.config.sync.s3=l})}else if(window.siyuan.config.sync.provider===3){let o=parseInt(i.querySelector("#timeout").value,10);7>o&&(o=7),300<o&&(o=300),i.querySelector("#timeout").value=o.toString();const l={endpoint:i.querySelector("#endpoint").value,username:i.querySelector("#username").value,password:i.querySelector("#password").value,skipTlsVerify:i.querySelector("#webdavSkipTlsVerify").value==="true",timeout:o};w("/api/sync/setSyncProviderWebDAV",{webdav:l},()=>{window.siyuan.config.sync.webdav=l})}})})},Dt={element:void 0,genHTML:()=>`<div>
<div style="position: fixed;width: 800px;height: 434px;box-sizing: border-box;text-align: center;display: flex;align-items: center;justify-content: center;z-index: 1;" id="reposLoading">
    <img src="/stage/loading-pure.svg">
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.syncProvider}
        <div class="b3-label__text">${window.siyuan.languages.syncProviderTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="syncProvider" class="b3-select fn__flex-center fn__size200">
        <option value="0" ${window.siyuan.config.sync.provider===0?"selected":""}>SiYuan</option>
        <option value="2" ${window.siyuan.config.sync.provider===2?"selected":""}>S3</option>
        <option value="3" ${window.siyuan.config.sync.provider===3?"selected":""}>WebDAV</option>
    </select>
</div>
<div id="syncProviderPanel" class="b3-label">
    ${Yu(window.siyuan.config.sync.provider)}
</div>
<div id="reposData" class="b3-label">
    <div class="fn__flex">
        <div class="fn__flex-1">
            ${window.siyuan.languages.cloudStorage}
        </div>
        <div class="fn__flex-1">
            ${window.siyuan.languages.trafficStat}
        </div>
    </div>
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.openSyncTip1}
        <div class="b3-label__text">${window.siyuan.languages.openSyncTip2}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="reposCloudSyncSwitch"${window.siyuan.config.sync.enabled?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.generateConflictDoc}
        <div class="b3-label__text">${window.siyuan.languages.generateConflictDocTip}</div>
    </div>
    <span class="fn__space"></span>
    <input type="checkbox" id="generateConflictDoc"${window.siyuan.config.sync.generateConflictDoc?" checked='checked'":""} class="b3-switch fn__flex-center">
</label>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncMode}
            <div class="b3-label__text">${window.siyuan.languages.syncModeTip}</div>
        </div>
        <span class="fn__space"></span>
        <select id="syncMode" class="b3-select fn__flex-center fn__size200">
            <option value="1" ${window.siyuan.config.sync.mode===1?"selected":""}>${window.siyuan.languages.syncMode1}</option>
            <option value="2" ${window.siyuan.config.sync.mode===2?"selected":""}>${window.siyuan.languages.syncMode2}</option>
            <option value="3" ${window.siyuan.config.sync.mode===3?"selected":""}>${window.siyuan.languages.syncMode3}</option>
        </select>
    </div>
    <label class="fn__flex b3-label${window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?" fn__none":""}">
        <div class="fn__flex-1">
            ${window.siyuan.languages.syncPerception}
            <div class="b3-label__text">${window.siyuan.languages.syncPerceptionTip}</div>
        </div>
        <span class="fn__space"></span>
        <input type="checkbox" id="syncPerception"${window.siyuan.config.sync.perception?" checked='checked'":""} class="b3-switch fn__flex-center">
    </label>
</div>
<div class="b3-label">
    <div class="fn__flex config__item">
        <div class="fn__flex-center">${window.siyuan.languages.cloudSyncDir}</div>
        <div class="fn__flex-1"></div>
        <button class="b3-button b3-button--outline fn__flex-center fn__size200" data-action="config">
            <svg><use xlink:href="#iconSettings"></use></svg>${window.siyuan.languages.config}
        </button>
    </div>
    <div id="reposCloudSyncList" class="fn__none b3-label"><img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg"></div>
</div>
<div class="b3-label fn__flex">
    <div class="fn__flex-center">${window.siyuan.languages.cloudBackup}</div>
    <div class="b3-list-item__meta fn__flex-center">${window.siyuan.languages.cloudBackupTip}</div>
</div>
</div>`,bindEvent:()=>{Gu();const t=Dt.element.querySelector("#reposCloudSyncSwitch");t.addEventListener("change",()=>{if(t.checked&&window.siyuan.config.sync.cloudName===""){t.checked=!1,M(window.siyuan.languages._kernel[123]);return}w("/api/sync/setSyncEnable",{enabled:t.checked},()=>{window.siyuan.config.sync.enabled=t.checked,ra()})});const e=Dt.element.querySelector("#syncPerception");e.addEventListener("change",()=>{w("/api/sync/setSyncPerception",{enabled:e.checked},()=>{window.siyuan.config.sync.perception=e.checked,ra()})});const n=Dt.element.querySelector("#generateConflictDoc");n.addEventListener("change",()=>{w("/api/sync/setSyncGenerateConflictDoc",{enabled:n.checked},()=>{window.siyuan.config.sync.generateConflictDoc=n.checked})});const a=Dt.element.querySelector("#syncMode");a.addEventListener("change",()=>{w("/api/sync/setSyncMode",{mode:parseInt(a.value,10)},()=>{a.value==="1"&&window.siyuan.config.sync.provider===0&&window.siyuan.config.system.container!=="docker"?e.parentElement.classList.remove("fn__none"):e.parentElement.classList.add("fn__none"),window.siyuan.config.sync.mode=parseInt(a.value,10)})});const i=Dt.element.querySelector("#reposCloudSyncList"),s=Dt.element.querySelector("#syncProvider");s.addEventListener("change",()=>{w("/api/sync/setSyncProvider",{provider:parseInt(s.value,10)},l=>{l.code===1?(M(l.msg),s.value="0",window.siyuan.config.sync.provider=0):window.siyuan.config.sync.provider=parseInt(s.value,10),Dt.element.querySelector("#syncProviderPanel").innerHTML=Yu(window.siyuan.config.sync.provider),Gu(),i.innerHTML="",i.classList.add("fn__none"),window.siyuan.config.sync.mode!==1||window.siyuan.config.system.container==="docker"||window.siyuan.config.sync.provider!==0?e.parentElement.classList.add("fn__none"):e.parentElement.classList.remove("fn__none")})});const o=Dt.element.querySelector("#reposLoading");o.style.width=Dt.element.clientWidth+"px",o.style.height=Dt.element.clientHeight+"px",Mb(i),Dt.element.firstElementChild.addEventListener("click",l=>{let r=l.target;for(;r&&r!==Dt.element;){const c=r.getAttribute("data-action");if(c==="config"){i.classList.contains("fn__none")?(zo(i,!0),i.classList.remove("fn__none")):i.classList.add("fn__none");break}else if(c==="togglePassword"){const d=r.firstElementChild.getAttribute("xlink:href")==="#iconEye";r.firstElementChild.setAttribute("xlink:href",d?"#iconEyeoff":"#iconEye"),r.previousElementSibling.setAttribute("type",d?"text":"password");break}else if(c==="exportData"){w(r.getAttribute("data-type")==="s3"?"/api/sync/exportSyncProviderS3":"/api/sync/exportSyncProviderWebDAV",{},d=>{Ee(d.data.zip)});break}r=r.parentElement}})}},Vr=()=>{let t="";const e=[];return document.querySelectorAll("body > svg > defs > symbol").forEach(n=>{e.push(n.id)}),Array.from({length:45},()=>{const n=Math.floor(Math.random()*e.length);t+=`<svg><use xlink:href="#${e[n]}"></use></svg>`,e.splice(n,1)}),`<div class="fn__flex config-account__svg">${t}</div>`},Pt={element:void 0,genHTML:(t=!1)=>{const e=`
<a class="b3-button b3-button--big" href="${Ut("subscribe/siyuan")}" target="_blank">
    <svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account1}
</a>
<div class="fn__hr--b"></div>
<span class="b3-chip b3-chip--primary b3-chip--hover${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}" id="trialSub">
    <svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>
    ${window.siyuan.languages.freeSub}
</span>
<div class="fn__hr${window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===2?" fn__none":""}"></div>
<a href="${Ut("sponsor")}" target="_blank" class="b3-chip b3-chip--pink b3-chip--hover">
    <svg version='1.1' xmlns='http://www.w3.org/2000/svg' width='32' height='32' viewBox='0 0 32 32'><path fill='#ffe43c' d='M6.4 0h19.2c4.268 0 6.4 2.132 6.4 6.4v19.2c0 4.268-2.132 6.4-6.4 6.4h-19.2c-4.268 0-6.4-2.132-6.4-6.4v-19.2c0-4.268 2.135-6.4 6.4-6.4z'></path> <path fill='#00f5d4' d='M25.6 0h-8.903c-7.762 1.894-14.043 7.579-16.697 15.113v10.487c0 3.533 2.867 6.4 6.4 6.4h19.2c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#01beff' d='M25.6 0h-0.119c-12.739 2.754-20.833 15.316-18.079 28.054 0.293 1.35 0.702 2.667 1.224 3.946h16.974c3.533 0 6.4-2.867 6.4-6.4v-19.2c0-3.537-2.863-6.4-6.4-6.4z'></path> <path fill='#9a5ce5' d='M31.005 2.966c-0.457-0.722-1.060-1.353-1.784-1.849-8.342 3.865-13.683 12.223-13.679 21.416-0.003 3.256 0.67 6.481 1.978 9.463h8.081c0.602 0 1.185-0.084 1.736-0.238-2.1-3.189-3.401-7.624-3.401-12.526 0-7.337 2.921-13.628 7.070-16.266z'></path> <path fill='#f15bb5' d='M32 25.6v-19.2c0-1.234-0.354-2.419-0.998-3.43-4.149 2.638-7.067 8.928-7.067 16.266 0 4.902 1.301 9.334 3.401 12.526 2.693-0.757 4.664-3.231 4.664-6.162z'></path> <path fill='#fff' opacity='0.2' d='M26.972 22.415c-2.889 0.815-4.297 2.21-6.281 3.182 1.552 0.348 3.105 0.461 4.902 0.461 2.644 0 5.363-1.449 6.406-2.519v-1.085c-1.598-0.399-2.664-0.705-5.028-0.039zM4.773 21.612c-0.003 0-0.006-0.003-0.006-0.003-1.726-0.863-3.382-1.205-4.767-1.301v2.487c0.779-0.341 2.396-0.921 4.773-1.182zM17.158 26.599c1.472-0.158 2.57-0.531 3.533-1.002-1.063-0.238-2.126-0.583-3.269-1.079-2.767-1.205-5.63-3.092-10.491-3.034-0.779 0.010-1.495 0.058-2.158 0.132 4.503 2.248 7.882 5.463 12.384 4.983z'></path> <path fill='#fff' opacity='0.2' d='M20.691 25.594c-0.963 0.47-2.061 0.844-3.533 1.002-4.503 0.483-7.882-2.731-12.381-4.983-2.38 0.261-3.994 0.841-4.773 1.179v2.809c0 4.268 2.132 6.4 6.4 6.4h19.197c4.268 0 6.4-2.132 6.4-6.4v-2.065c-1.044 1.069-3.762 2.519-6.406 2.519-1.797 0-3.35-0.113-4.902-0.461z'></path> <path fill='#fff' opacity='0.5' d='M3.479 19.123c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' opacity='0.5' d='M29.027 14.266c0 0.334 0.271 0.606 0.606 0.606s0.606-0.271 0.606-0.606v0c0-0.334-0.271-0.606-0.606-0.606s-0.606 0.271-0.606 0.606v0z'></path> <path fill='#fff' d='M9.904 1.688c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' d='M2.673 10.468c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.6' d='M30.702 9.376c0 0.167 0.136 0.303 0.303 0.303s0.303-0.136 0.303-0.303v0c0-0.167-0.136-0.303-0.303-0.303s-0.303 0.136-0.303 0.303v0z'></path> <path fill='#fff' opacity='0.8' d='M29.236 20.881c0 0.276 0.224 0.499 0.499 0.499s0.499-0.224 0.499-0.499v0c0-0.276-0.224-0.499-0.499-0.499s-0.499 0.224-0.499 0.499v0z'></path> <path fill='#fff' opacity='0.8' d='M15.38 1.591c0.047 0.016 0.101 0.026 0.158 0.026 0.276 0 0.499-0.224 0.499-0.499 0-0.219-0.141-0.406-0.338-0.473l-0.004-0.001c-0.047-0.016-0.101-0.026-0.158-0.026-0.276 0-0.499 0.224-0.499 0.499 0 0.219 0.141 0.406 0.338 0.473l0.004 0.001z'></path> <path fill='#ffdeeb' d='M25.732 8.268c-2.393-2.371-6.249-2.371-8.642 0l-1.089 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 6.474 6.464c0.596 0.593 1.562 0.593 2.158 0l6.474-6.464 2.193-2.158c2.384-2.383 2.384-6.242 0.003-8.622z'></path> <path fill='#fff' d='M17.081 8.268l-1.079 1.085-1.079-1.089c-2.38-2.39-6.249-2.393-8.639-0.013s-2.393 6.249-0.013 8.639l2.158 2.158 2.548 2.487c4.097-1.044 7.627-3.646 9.837-7.254 1.424-2.271 2.284-4.848 2.503-7.518-2.193-0.715-4.606-0.132-6.236 1.504z'></path> </svg>
    ${window.siyuan.languages.sponsor}
</a>
<div class="fn__hr--b"></div>
<div class="fn__flex-1"></div>
<div>
${window.siyuan.languages.accountSupport1}
</div>
<div class="fn__hr--b"></div>
<div>
${window.siyuan.languages.accountSupport2}
</div>`;if(t)return`<div class="fn__flex-1 fn__hr--b"></div>
${Vr()}
<div class="fn__flex-1 fn__hr--b"></div>    
${e}
<div class="fn__flex-1 fn__hr--b"></div>
${Vr()}
<div class="fn__flex-1 fn__hr--b"></div>`;if(window.siyuan.user){let n="";window.siyuan.user.userTitles.length>0&&(n='<div class="b3-chips" style="position: absolute">',window.siyuan.user.userTitles.forEach(s=>{n+=`<div class="b3-chip b3-chip--middle">${s.icon} ${s.name}</div>`}),n+="</div>");let a="",i=`<div class="b3-form__icon fn__block">
   <svg class="ft__secondary b3-form__icon-icon"><use xlink:href="#iconVIP"></use></svg>
   <input class="b3-text-field fn__block b3-form__icon-input" style="padding-right: 44px;" placeholder="${window.siyuan.languages.activationCodePlaceholder}">
   <button id="activationCode" class="b3-button b3-button--text" style="position: absolute;right: 0;top: 0;">${window.siyuan.languages.confirm}</button>
</div>`;if(window.siyuan.user.userSiYuanProExpireTime===-1)i="",a=`<div class="b3-chip b3-chip--secondary">${p.Constants.SIYUAN_IMAGE_VIP}${window.siyuan.languages.account12}</div>`;else if(window.siyuan.user.userSiYuanProExpireTime>0){const s=`<div class="fn__hr--b"></div>
<div class="ft__on-surface ft__smaller">
    ${window.siyuan.languages.account6} 
    ${Math.max(0,Math.floor((window.siyuan.user.userSiYuanProExpireTime-new Date().getTime())/1e3/60/60/24))} 
    ${window.siyuan.languages.day} 
    <a href="${Ut("subscribe/siyuan")}" target="_blank">${window.siyuan.languages.clickMeToRenew}</a>
</div>`;window.siyuan.user.userSiYuanOneTimePayStatus===1&&(a=`<div class="b3-chip"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}</div>
<div class="fn__hr--b"></div>`),window.siyuan.user.userSiYuanSubscriptionPlan===2?a+=`<div class="b3-chip b3-chip--primary"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account3}</div>
${s}
<div class="fn__hr--b"></div>`:a+=`<div class="b3-chip b3-chip--primary"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.account10}</div>${s}`}else window.siyuan.user.userSiYuanOneTimePayStatus===1?a=`<div class="b3-chip"><svg><use xlink:href="#iconVIP"></use></svg>${window.siyuan.languages.onepay}</div>
<div class="fn__hr--b"></div>${e}`:a=e;return`<div class="fn__flex config-account">
<div class="config-account__center">
    <div class="config-account__bg">
        <div class="config-account__cover" style="background-image: url(${window.siyuan.user.userHomeBImgURL})"></div>
        <a href="${Ut("settings/avatar")}" class="config-account__avatar" style="background-image: url(${window.siyuan.user.userAvatarURL})" target="_blank"></a>
        <h1 class="config-account__name">
            <a target="_blank" class="fn__a" href="${Ut("member/"+window.siyuan.user.userName)}">${window.siyuan.user.userName}</a>
            <span class="ft__on-surface ft__smaller">${window.siyuan.config.cloudRegion===0?"ld246.com":"liuyun.io"}</span>
        </h1>
        ${n}
    </div>
    <div class="config-account__info">
        <div class="fn__flex">
            <a class="b3-button b3-button--text" href="${Ut("settings")}" target="_blank">${window.siyuan.languages.manage}</a>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--cancel" id="logout">
                ${window.siyuan.languages.logout}
            </button>
            <span class="fn__space"></span>
            <button class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?"":" fn__none"}" id="deactivateUser">
                ${window.siyuan.languages.deactivateUser}
            </button>
            <span class="fn__flex-1"></span>
            <button class="b3-button b3-button--cancel b3-tooltips b3-tooltips__n" id="refresh" aria-label="${window.siyuan.languages.refresh}">
                <svg><use xlink:href="#iconRefresh"></use></svg>
            </button>
        </div>
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <label>
                ${window.siyuan.languages.accountDisplayTitle}
                <input class="b3-switch fn__flex-center" id="displayTitle" type="checkbox"${window.siyuan.config.account.displayTitle?" checked":""}/>
            </label>
            <div class="fn__flex-1"></div>
            <label>
                ${window.siyuan.languages.accountDisplayVIP}
                <input class="b3-switch fn__flex-center" id="displayVIP" type="checkbox"${window.siyuan.config.account.displayVIP?" checked":""}/>
            </label>
        </div>
    </div>
</div>
<div class="config-account__center config-account__center--text${window.siyuan.config.system.container==="ios"?" fn__none":""}">
    <div class="fn__flex-1 fn__hr--b"></div>
    ${a}
    <div class="fn__flex-1 fn__hr--b"></div>
    ${i}
</div></div>`}return`<div class="fn__flex config-account">
<div class="b3-form__space config-account__center">
    <div class="config-account__form" id="form1">
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconAccount"></use></svg>
            <input id="userName" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.accountName}">
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
            <input type="password" id="userPassword" class="b3-text-field b3-form__icon-input fn__block" placeholder="${window.siyuan.languages.password}">
        </div>
        <div class="fn__hr--b"></div>
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconFocus"></use></svg>
            <select class="b3-select b3-form__icon-input fn__block" id="cloudRegion">
                <option value="0"${window.siyuan.config.cloudRegion===0?" selected":""}>${window.siyuan.languages.cloudRegionChina}</option>
                <option value="1"${window.siyuan.config.cloudRegion===1?" selected":""}>${window.siyuan.languages.cloudRegionNorthAmerica}</option>
            </select>
        </div>
        <div class="b3-form__img fn__none">
            <div class="fn__hr--b"></div>
            <img id="captchaImg" class="fn__pointer" style="top: 17px">
            <input id="captcha" class="b3-text-field fn__block" placeholder="${window.siyuan.languages.captcha}">
        </div>
        <div class="fn__hr--b"></div>
        <label class="ft__smaller ft__on-surface fn__flex">
            <span class="fn__space"></span>
            <input type="checkbox" class="b3-switch fn__flex-center" id="agreeLogin">
            <span class="fn__space"></span>
            <span>${window.siyuan.languages.accountTip}</span>
        </label>
        <div class="fn__hr--b"></div>
        <button id="login" disabled class="b3-button fn__block">${window.siyuan.languages.login}</button>
        <div class="fn__hr--b"></div>
        <div class="ft__center">
            <a href="${Ut("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
            <span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
            <a href="${Ut("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>
        </div>
    </div>
    <div class="fn__none config-account__form" id="form2">
        <div class="b3-form__icon">
            <svg class="b3-form__icon-icon"><use xlink:href="#iconLock"></use></svg>
            <input id="twofactorAuthCode" class="b3-text-field fn__block b3-form__icon-input" placeholder="${window.siyuan.languages.twoFactorCaptcha}">
        </div>
        <div class="fn__hr--b"></div>
        <button id="login2" class="b3-button fn__block">${window.siyuan.languages.login}</button>
    </div>
</div>
<div class="config-account__center config-account__center--text${window.siyuan.config.system.container==="ios"?" fn__none":""}">
    <div class="fn__flex-1 fn__hr--b"></div>
    ${Vr()}
    <div class="fn__flex-1 fn__hr--b"></div>    
    ${e}
    <div class="fn__flex-1 fn__hr--b"></div>
    ${Vr()}
    <div class="fn__flex-1 fn__hr--b"></div>
</div>
</div>`},bindEvent:t=>{const e=t.querySelector("#trialSub");e&&e.addEventListener("click",()=>{w("/api/account/startFreeTrial",{},()=>{t.querySelector("#refresh").dispatchEvent(new Event("click"))})});const n=t.querySelector("#agreeLogin"),a=t.querySelector("#userName");if(!a){const g=t.querySelector("#refresh");g.addEventListener("click",()=>{const m=g.firstElementChild;m.classList.contains("fn__rotate")||(m.classList.add("fn__rotate"),w("/api/setting/getCloudUser",{token:window.siyuan.user.userToken},b=>{window.siyuan.user=b.data,t.innerHTML=Pt.genHTML(),Pt.bindEvent(t),M(window.siyuan.languages.refreshUser,3e3),Pt.onSetaccount(),ra()}))}),t.querySelector("#logout").addEventListener("click",()=>{w("/api/setting/logoutCloudUser",{},()=>{w("/api/setting/getCloudUser",{},m=>{window.siyuan.user=m.data,t.innerHTML=Pt.genHTML(),Pt.bindEvent(t),Pt.onSetaccount(),ra()})})}),t.querySelector("#deactivateUser").addEventListener(z(),()=>{Ne("\u26A0\uFE0F "+window.siyuan.languages.deactivateUser,window.siyuan.languages.deactivateUserTip,()=>{w("/api/account/deactivate",{},()=>{window.siyuan.user=null,t.innerHTML=Pt.genHTML(),Pt.bindEvent(t),Pt.onSetaccount(),ra()})})}),t.querySelectorAll("input[type='checkbox']").forEach(m=>{m.addEventListener("change",()=>{w("/api/setting/setAccount",{displayTitle:t.querySelector("#displayTitle").checked,displayVIP:t.querySelector("#displayVIP").checked},b=>{window.siyuan.config.account.displayTitle=b.data.displayTitle,window.siyuan.config.account.displayVIP=b.data.displayVIP,Pt.onSetaccount()})})});const h=t.querySelector("#activationCode");h.addEventListener("click",()=>{const m=h.previousElementSibling;w("/api/account/checkActivationcode",{data:m.value},b=>{b.code!==0&&(m.value=""),Ne(window.siyuan.languages.activationCode,b.msg,()=>{b.code===0&&w("/api/account/useActivationcode",{data:h.previousElementSibling.value},()=>{g.dispatchEvent(new CustomEvent("click"))})})})});return}const i=t.querySelector("#userPassword"),s=t.querySelector("#captchaImg"),o=t.querySelector("#captcha"),l=t.querySelector("#twofactorAuthCode"),r=t.querySelector("#login"),c=t.querySelector("#login2");n.addEventListener("click",()=>{n.checked?r.removeAttribute("disabled"):r.setAttribute("disabled","disabled")}),a.focus(),a.addEventListener("keydown",g=>{if(g.isComposing){g.preventDefault();return}g.key==="Enter"&&(r.click(),g.preventDefault())}),l.addEventListener("keydown",g=>{if(g.isComposing){g.preventDefault();return}g.key==="Enter"&&(c.click(),g.preventDefault())}),o.addEventListener("keydown",g=>{if(g.isComposing){g.preventDefault();return}g.key==="Enter"&&(r.click(),g.preventDefault())}),i.addEventListener("keydown",g=>{if(g.isComposing){g.preventDefault();return}g.key==="Enter"&&(r.click(),g.preventDefault())});let d,u;s.addEventListener("click",()=>{s.setAttribute("src",Ut("captcha")+`/login?needCaptcha=${u}&t=${new Date().getTime()}`)});const f=t.querySelector("#cloudRegion");f.addEventListener("change",()=>{window.siyuan.config.cloudRegion=parseInt(f.value),t.querySelector(".config-account__center--text").innerHTML=Pt.genHTML(!0),t.querySelector("#form1").lastElementChild.innerHTML=`<a href="${Ut("forget-pwd")}" class="b3-button b3-button--cancel" target="_blank">${window.siyuan.languages.forgetPassword}</a>
<span class="fn__space${window.siyuan.config.system.container==="ios"?" fn__none":""}"></span>
<a href="${Ut("register")}" class="b3-button b3-button--cancel${window.siyuan.config.system.container==="ios"?" fn__none":""}" target="_blank">${window.siyuan.languages.register}</a>`}),r.addEventListener("click",()=>{w("/api/account/login",{userName:a.value.replace(/(^\s*)|(\s*$)/g,""),userPassword:mk(i.value),captcha:o.value.replace(/(^\s*)|(\s*$)/g,""),cloudRegion:window.siyuan.config.cloudRegion},g=>{let h;if(g.code===1){if(h=M(g.msg),g.data.needCaptcha){u=g.data.needCaptcha,o.parentElement.classList.remove("fn__none"),o.previousElementSibling.setAttribute("src",Ut("captcha")+`/login?needCaptcha=${g.data.needCaptcha}`),o.value="";return}return}if(g.code===10){t.querySelector("#form1").classList.add("fn__none"),t.querySelector("#form2").classList.remove("fn__none"),l.focus(),d=g.data.token;return}W(h),w("/api/setting/getCloudUser",{token:g.data.token},m=>{Pt._afterLogin(m,t)})})}),c.addEventListener("click",()=>{w("/api/setting/login2faCloudUser",{code:l.value,token:d},g=>{w("/api/setting/getCloudUser",{token:g.data.token},h=>{Pt._afterLogin(h,t)})})})},_afterLogin(t,e){if(window.siyuan.user=t.data,ra(),e.innerHTML=Pt.genHTML(),Pt.bindEvent(e),Pt.onSetaccount(),e.getAttribute("data-action")==="go-repos")if(va("")&&window.siyuan.config.sync.provider===0){const n=A(e,"b3-dialog--open");n&&(n.querySelector('.b3-tab-bar [data-name="repos"]').dispatchEvent(new CustomEvent("click")),e.removeAttribute("data-action"))}else X(["dialog"]),Ku()},onSetaccount(){if(Dt.element&&(Dt.element.innerHTML=""),window.siyuan.config.system.container==="ios")return;let t="";window.siyuan.config.account.displayVIP&&window.siyuan.user&&(window.siyuan.user.userSiYuanProExpireTime===-1?t=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.account12}">${p.Constants.SIYUAN_IMAGE_VIP}</div>`:window.siyuan.user.userSiYuanProExpireTime>0&&(window.siyuan.user.userSiYuanSubscriptionPlan===2?t=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.account3}"><svg><use xlink:href="#iconVIP"></use></svg></div>`:t=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.account10}"><svg class="ft__secondary"><use xlink:href="#iconVIP"></use></svg></div>`),window.siyuan.user.userSiYuanOneTimePayStatus===1&&(t+=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.onepay}"><svg><use xlink:href="#iconVIP"></use></svg></div>`)),(!window.siyuan.user||window.siyuan.user&&window.siyuan.user.userSiYuanSubscriptionStatus===-1)&&(t=`<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.freeSub}"><svg class="ft__error"><use xlink:href="#iconVIP"></use></svg></div>`),window.siyuan.config.account.displayTitle&&window.siyuan.user&&window.siyuan.user.userTitles.forEach(e=>{t+=`<div class="toolbar__item ariaLabel" aria-label="${e.name}\uFF1A${e.desc}">${e.icon}</div>`}),document.getElementById("toolbarVIP").innerHTML=t}},ju=(t,e)=>{t.plugins.find((n,a)=>{if(n.name===e){try{n.onunload()}catch(o){console.error(`plugin ${n.name} onunload error:`,o)}const i=Object.keys(n.models);return Pe().custom.forEach(o=>{i.includes(o.type)&&o.parent.parent.removeTab(o.parent.id)}),n.topBarIcons.forEach(o=>{o.remove()}),Ur(),n.statusBarIcons.forEach(o=>{o.remove()}),Object.keys(n.docks).forEach(o=>{Object.keys(window.siyuan.layout.leftDock.data).includes(o)?window.siyuan.layout.leftDock.remove(o):Object.keys(window.siyuan.layout.rightDock.data).includes(o)?window.siyuan.layout.rightDock.remove(o):Object.keys(window.siyuan.layout.bottomDock.data).includes(o)&&window.siyuan.layout.bottomDock.remove(o)}),Array.from(document.childNodes).find(o=>{if(o.nodeType===8&&o.textContent===e)return o.remove(),!0}),t.plugins.splice(a,1),!0}})},he={element:void 0,genHTML(){if(!window.siyuan.config.bazaar.trust)return`<div class="fn__flex-column">
<div class="fn__flex-1"></div>
<div class="b3-label">
    <div>${window.siyuan.languages.bazaarTrust}</div>
    <div class="fn__hr--b"></div>
    <div>${window.siyuan.languages.bazaarTrust3}</div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconEye"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarTrustCodeReview}
        <div class="b3-label__text">${window.siyuan.languages.bazaarTrustCodeReviewTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconGithub"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarTrustOpenSource}
        <div class="b3-label__text">${window.siyuan.languages.bazaarTrustOpenSourceTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconUsers"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarCommunityReview}
        <div class="b3-label__text">${window.siyuan.languages.bazaarPeerReviewTip}</div>
    </div>
</div>
<div class="fn__flex b3-label">
    <svg class="b3-label__icon"><use xlink:href="#iconInfo"></use></svg>
    <div>
        ${window.siyuan.languages.bazaarUserReport}
        <div class="b3-label__text">${window.siyuan.languages.bazaarUserReportTip}</div>
    </div>
</div>
<div class="b3-label b3-label--noborder">
    <div>${window.siyuan.languages.bazaarTrust1}</div>
    <div class="fn__hr--b"></div>
    <diiv>${window.siyuan.languages.bazaarTrust2}</diiv>
</div>
<div class="ft__center b3-label b3-label--noborder">
    <button class="b3-button fn__size200">${window.siyuan.languages.trust}</button>
</div>
<div class="fn__flex-1"></div>
</div>`;const t=window.siyuan.storage[p.Constants.LOCAL_BAZAAR],e=`<div style="height: ${he.element.clientHeight-80}px;display: flex;align-items: center;justify-content: center;"><img src="/stage/loading-pure.svg"></div>`;return`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="downloaded" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.downloaded}</span><span class="fn__flex-1"></span></div>
    <div data-type="plugin" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.plugin}</span><span class="fn__flex-1"></span></div>
    <div data-type="theme" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.theme}</span><span class="fn__flex-1"></span></div>
    <div data-type="icon" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.icon}</span><span class="fn__flex-1"></span></div>
    <div data-type="template" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.template}</span><span class="fn__flex-1"></span></div>
    <div data-type="widget" class="item item--full"><span class="fn__flex-1"></span><span class="item__text">${window.siyuan.languages.widget}</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div class="bazaarPanel" data-type="downloaded" data-init="true">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <button data-type="myPlugin" class="b3-button">${window.siyuan.languages.plugin}</button>
            <div class="fn__space"></div>
            <button data-type="myTheme" class="b3-button b3-button--outline">${window.siyuan.languages.theme}</button>
            <div class="fn__space"></div>
            <button data-type="myIcon" class="b3-button b3-button--outline">${window.siyuan.languages.icon}</button>
            <div class="fn__space"></div>
            <button data-type="myTemplate" class="b3-button b3-button--outline">${window.siyuan.languages.template}</button>
            <div class="fn__space"></div>
            <button data-type="myWidget" class="b3-button b3-button--outline">${window.siyuan.languages.widget}</button>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input" placeholder="Enter ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter fn__none fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}" style="background: var(--b3-theme-surface)"></div>
            <div class="fn__space"></div>
            <div class="fn__space"></div>
        </div>
        <div id="configBazaarDownloaded">
            ${e}
        </div>
    </div>
    <div data-type="theme" class="bazaarPanel fn__none">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.theme==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.theme==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.theme==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.theme==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <select id="bazaarSelect" class="b3-select">
                <option selected value="2">${window.siyuan.languages.all}</option>
                <option value="0">${window.siyuan.languages.themeLight}</option>
                <option value="1">${window.siyuan.languages.themeDark}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input" placeholder="Enter ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}" style="background: var(--b3-theme-surface)"></div>
            <div class="fn__space"></div>
            <div class="fn__space"></div>
        </div>
        <div id="configBazaarTheme">
            ${e}
        </div>
    </div>
    <div class="fn__none bazaarPanel" data-type="template">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.template==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.template==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.template==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.template==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input" placeholder="Enter ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}" style="background: var(--b3-theme-surface)"></div>
            <div class="fn__space"></div>
            <div class="fn__space"></div>
        </div>
        <div id="configBazaarTemplate">
            ${e}
        </div>
    </div>
    <div class="fn__none bazaarPanel" data-type="plugin">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.plugin==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.plugin==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.plugin==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.plugin==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input" placeholder="Enter ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}" style="background: var(--b3-theme-surface)"></div>
            <div class="fn__space"></div>
            <div class="fn__space"></div>
        </div>
        <div id="configBazaarPlugin">
            ${e}
        </div>
    </div>
    <div class="fn__none bazaarPanel" data-type="icon">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.icon==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.icon==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.icon==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.icon==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input" placeholder="Enter ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}" style="background: var(--b3-theme-surface)"></div>
            <div class="fn__space"></div>
            <div class="fn__space"></div>
        </div>
        <div id="configBazaarIcon">
            ${e}
        </div>
    </div>
    <div class="fn__none bazaarPanel" data-type="widget">
        <div class="fn__hr--b"></div>
        <div class="fn__flex">
            <div class="fn__space"></div>
            <div class="fn__space"></div>
            <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconSort"></use></svg>
            <div class="fn__space"></div>
            <select class="b3-select">
                <option ${t.widget==="0"?"selected":""} value="0">${window.siyuan.languages.sortByUpdateTimeDesc}</option>
                <option ${t.widget==="1"?"selected":""} value="1">${window.siyuan.languages.sortByUpdateTimeAsc}</option>
                <option ${t.widget==="2"?"selected":""} value="2">${window.siyuan.languages.sortByDownloadsDesc}</option>
                <option ${t.widget==="3"?"selected":""} value="3">${window.siyuan.languages.sortByDownloadsAsc}</option>
            </select>
            <div class="fn__space"></div>
            <div class="b3-form__icon">
                <svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg>
                <input class="b3-text-field b3-form__icon-input" placeholder="Enter ${window.siyuan.languages.search}">
            </div>
            <div class="fn__space"></div>
            <div class="fn__flex-1"></div>
            <div class="counter fn__flex-center b3-tooltips b3-tooltips__w" aria-label="${window.siyuan.languages.total}" style="background: var(--b3-theme-surface)"></div>
            <div class="fn__space"></div>
            <div class="fn__space"></div>
        </div>
        <div id="configBazaarWidget">
            ${e}
        </div>
    </div>
</div>
<div id="configBazaarReadme" class="config-bazaar__readme"></div>
</div>`},_genCardHTML(t,e){let n=!1,a="";if(e==="themes"){const o=he.element.querySelector("#bazaarSelect").value;(o==="0"&&t.modes.includes("dark")||o==="1"&&t.modes.includes("light"))&&(n=!0),a=t.modes.toString()}let i=!1;["icons","themes"].includes(e)&&(i=!0);const s={bazaarType:e,themeMode:a,updated:t.updated,name:t.name,repoURL:t.repoURL,repoHash:t.repoHash,downloads:t.downloads,downloaded:!1};return`<div data-obj='${JSON.stringify(s)}' class="b3-card b3-card--wrap${n?" fn__none":""}${t.current?" b3-card--current":""}">
    <div class="b3-card__img">
        <img src="${t.iconURL}" onerror="this.src='${t.previewURLThumb}'"/>
    </div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info fn__flex-1">
            ${t.preferredName} <span class="ft__on-surface ft__smaller">${t.name}</span>
            <div class="b3-card__desc" title="${Ba(t.preferredDesc)||""}">
                ${t.preferredDesc||""}
            </div>
        </div>
        <div class="b3-card__actions">
            <span class="block__icon block__icon--show ft__primary">
                <svg><use xlink:href="#iconDownload"></use></svg>
                <span class="fn__space"></span>
                ${t.downloads}
            </span>
            <span class="fn__space"></span>
            ${t.preferredFunding?`<a target="_blank" href="${t.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${t.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a><span class="fn__space"></span>`:""}
            <div class="fn__flex-1"></div>
            <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${t.installed?"":" fn__none"}" data-type="uninstall" aria-label="${window.siyuan.languages.uninstall}">
                <svg><use xlink:href="#iconTrashcan"></use></svg>
            </span>
            <div class="fn__space${!t.current&&t.installed&&i?"":" fn__none"}"></div>
            <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${!t.current&&t.installed&&i?"":" fn__none"}" data-type="switch" aria-label="${window.siyuan.languages.use}">
                <svg><use xlink:href="#iconSelect"></use></svg>
            </span>
            <div class="fn__space${t.outdated?"":" fn__none"}"></div>
            <span data-type="install-t" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${t.outdated?"":" fn__none"}" aria-label="${window.siyuan.languages.update}">
                <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
            </span>
        </div>
    </div>
</div>`},_genMyHTML(t,e){const n=he.element.querySelector("#configBazaarDownloaded");if(n.getAttribute("data-loading")==="true"||n.previousElementSibling.querySelector(`[data-type="my${t.replace(t[0],t[0].toUpperCase()).substring(0,t.length-1)}"]`).classList.contains("b3-button--outline"))return;n.setAttribute("data-loading","true");let a="/api/bazaar/getInstalledTheme";t==="icons"?a="/api/bazaar/getInstalledIcon":t==="widgets"?a="/api/bazaar/getInstalledWidget":t==="templates"?a="/api/bazaar/getInstalledTemplate":t==="plugins"&&(a="/api/bazaar/getInstalledPlugin"),w(a,{frontend:(0,I.UP)(),keyword:n.previousElementSibling.querySelector(".b3-text-field")?.value||""},i=>{n.removeAttribute("data-loading");let s="",o=!1;["icons","themes"].includes(t)&&(o=!0);const l=n.parentElement.querySelector(".counter");i.data.packages.length===0?l.classList.add("fn__none"):(l.classList.remove("fn__none"),l.textContent=i.data.packages.length,i.data.packages.forEach(r=>{const c={bazaarType:t,themeMode:r.modes?.toString(),updated:r.updated,name:r.name,repoURL:r.repoURL,repoHash:r.repoHash,downloaded:!0};let d=!1;t==="plugins"&&e.plugins.find(u=>{if(u.name===c.name)return d=u.setting||u.__proto__.hasOwnProperty("openSetting"),!0}),s+=`<div data-obj='${JSON.stringify(c)}' class="b3-card${r.current?" b3-card--current":""}${window.siyuan.config.bazaar.petalDisabled&&t==="plugins"?" b3-card--disabled":""}">
    <div class="b3-card__img"><img src="${r.iconURL}" onerror="this.src='${r.previewURLThumb}'"/></div>
    <div class="fn__flex-1 fn__flex-column">
        <div class="b3-card__info b3-card__info--left fn__flex-1">
            ${r.preferredName} <span class="ft__on-surface ft__smaller">${r.name}</span>
            <div class="b3-card__desc" title="${Ba(r.preferredDesc)||""}">${r.preferredDesc||""}</div>
        </div>
    </div>
    <div class="b3-card__actions b3-card__actions--right">
        ${r.incompatible?`<span class="fn__space"></span><span class="fn__flex-center b3-tooltips b3-tooltips__nw b3-chip b3-chip--error b3-chip--small" aria-label="${window.siyuan.languages.incompatiblePluginTip}">${window.siyuan.languages.incompatible}</span>`:""}
        ${r.preferredFunding?`<a target="_blank" href="${r.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${r.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:""}
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${d?"":" fn__none"}" data-type="setting" aria-label="${window.siyuan.languages.config}">
            <svg><use xlink:href="#iconSettings"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show" data-type="uninstall" aria-label="${window.siyuan.languages.uninstall}">
            <svg><use xlink:href="#iconTrashcan"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${(0,I.jU)()?" fn__none":""}" data-type="open" aria-label="${window.siyuan.languages.showInFolder}">
            <svg><use xlink:href="#iconFolder"></use></svg>
        </span>
        <span class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${!r.current&&o?"":" fn__none"}" data-type="switch" aria-label="${window.siyuan.languages.use}">
            <svg><use xlink:href="#iconSelect"></use></svg>
        </span>
        <span data-type="install-t" aria-label="${window.siyuan.languages.update}" class="b3-tooltips b3-tooltips__nw block__icon block__icon--show${r.outdated?"":" fn__none"}">
            <svg class="ft__primary"><use xlink:href="#iconRefresh"></use></svg>
        </span>
        <span class="fn__space${t==="plugins"?"":" fn__none"}"></span>
        <span class="fn__space${t==="plugins"?"":" fn__none"}"></span>
        <input class="b3-switch fn__flex-center${t==="plugins"?"":" fn__none"}" ${r.enabled?"checked":""} data-type="plugin-enable" type="checkbox" ${r.incompatible?" disabled":""}>
    </div>
</div>`})),he._data.downloaded=i.data.packages,t==="plugins"&&(s=`<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <input ${window.siyuan.config.bazaar.petalDisabled?"":" checked"} data-type="plugins-enable" type="checkbox" class="b3-switch" style="margin: 8px 32px">
</div>${s}`),n.innerHTML=s||`<div class="fn__hr"></div><ul class="b3-list b3-list--background"><li class="b3-list--empty">${window.siyuan.languages.emptyContent}</li></ul>`})},_data:{themes:[],templates:[],icons:[],widgets:[],plugins:[],downloaded:[]},_renderReadme(t,e){const n=JSON.parse(t.getAttribute("data-obj"));let a;(n.downloaded?he._data.downloaded:he._data[e]).find(r=>{if(r.repoURL===n.repoURL)return a=r,!0});const i=he.element.querySelector("#configBazaarReadme"),s=a.repoURL.split("/");s.pop();let o=window.siyuan.languages.icon;e==="themes"?o=window.siyuan.languages.theme:e==="widgets"?o=window.siyuan.languages.widget:e==="templates"?o=window.siyuan.languages.template:e==="plugins"&&(o=window.siyuan.languages.plugin);const l={bazaarType:e,themeMode:a.modes?.toString(),name:a.name,repoURL:a.repoURL,repoHash:a.repoHash,downloaded:!0};if(i.innerHTML=` <div class="item__side" data-obj='${JSON.stringify(l)}'>
    <div class="fn__flex">
        <div style="padding-right: 8px" class="block__icon block__icon--show b3-tooltips b3-tooltips__e" data-type="goBack" aria-label="${window.siyuan.languages.back}">
            <svg><use xlink:href="#iconLeft"></use></svg>
            <span class="fn__space"></span>
            ${o}
        </div>
    </div>
    <div class="fn__flex-1"></div>
    <img class="item__img" src="${a.iconURL}" onerror="this.src='${a.previewURLThumb}'">
    <a href="${a.repoURL}" target="_blank" class="item__title" title="GitHub Repo">${a.preferredName}</a>
    <br>
    <a href="${a.repoURL}" target="_blank" class="ft__on-surface ft__smaller" title="GitHub Repo">${a.name}</a>
    <div class="block__icons">
        <span class="fn__flex-1"></span>
        ${a.preferredFunding?`<a target="_blank" href="${a.preferredFunding}" class="block__icon block__icon--show ariaLabel" aria-label="${window.siyuan.languages.sponsor} ${a.preferredFunding}"><svg class="ft__pink"><use xlink:href="#iconHeart"></use></svg></a>`:`<span class="b3-tooltips b3-tooltips__ne block__icon block__icon--show ft__primary" aria-label="${window.siyuan.languages.author}"><svg><use xlink:href="#iconAccount"></use></svg></span>`}
        <span class="fn__space"></span>
        <a href="${s.join("/")}" target="_blank" title="Creator">${a.author}</a>
        <span class="fn__flex-1"></span>
    </div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${window.siyuan.languages.currentVer}<br>v${a.version}</div>
    <div class="fn__hr"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${n.downloaded?window.siyuan.languages.installDate:window.siyuan.languages.releaseDate}<br>${n.downloaded?a.hInstallDate:a.hUpdated}</div>
    <div class="fn__hr"></div>
    <div class="ft__on-surface ft__smaller" style="line-height: 20px;">${n.downloaded?window.siyuan.languages.installSize:window.siyuan.languages.pkgSize}<br>${n.downloaded?a.hInstallSize:a.hSize}</div>
    <div class="fn__hr--b${a.installed||n.downloaded?" fn__none":""}"></div>
    <div class="fn__hr--b${a.installed||n.downloaded?" fn__none":""}"></div>
    <div${a.installed||n.downloaded?' class="fn__none"':""}>
        <button class="b3-button" style="width: 168px"  data-type="install">${window.siyuan.languages.download}</button>
    </div>
    <div${a.outdated&&(a.installed||n.downloaded)?"":' class="fn__none"'}>
        <button class="b3-button" style="width: 168px" data-type="install-t">${window.siyuan.languages.update}</button>
    </div>
    <div class="fn__hr--b${n.downloaded?" fn__none":""}"></div>
    <div class="fn__hr--b${n.downloaded?" fn__none":""}"></div>
    <div class="fn__flex${n.downloaded?" fn__none":""}" style="justify-content: center;">
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconGithub"></use></svg>
        <span class="fn__space"></span>
        <a href="${a.repoURL}" target="_blank" title="GitHub Repo">Repo</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconStar"></use></svg>
        <span class="fn__space"></span>
        <a href="${a.repoURL}/stargazers" target="_blank" title="Starts">${a.stars}</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconGitHubI"></use></svg>
        <span class="fn__space"></span>
        <a href="${a.repoURL}/issues" target="_blank" title="Open issues">${a.openIssues}</a>
        <span class="fn__space"></span>
        <span class="fn__space"></span>
        <svg class="svg ft__on-surface fn__flex-center"><use xlink:href="#iconDownload"></use></svg>
        <span class="fn__space"></span>
        ${a.downloads}
    </div>
    <div class="fn__hr--b"></div>
    <div class="fn__hr--b"></div>
    <div class="fn__flex-1"></div>
</div>
<div class="item__main">
    <div class="item__preview" style="background-image: url(${a.previewURL})"></div>
    <div class="b3-typography${a.preferredDesc?"":" fn__none"}">
        <div data-type="NodeBlockquote" class="bq" data-node-id>
            <div data-type="NodeParagraph" class="p" data-node-id>
                ${a.preferredDesc||""}
            </div>
         </div>
    </div>
    <div class="item__readme b3-typography b3-typography--default"">
        <img data-type="img-loading" style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 48px;box-sizing: border-box;" src="/stage/loading-pure.svg">
    </div>
</div>`,n.downloaded){const r=i.querySelector(".item__readme");r.innerHTML=a.preferredReadme,qe(r)}else w("/api/bazaar/getBazaarPackageREAME",{repoURL:a.repoURL,repoHash:a.repoHash,packageType:e},r=>{const c=i.querySelector(".item__readme");c.innerHTML=r.data.html,qe(c)});i.classList.add("config-bazaar__readme--show")},bindEvent(t){if(!window.siyuan.config.bazaar.trust){he.element.querySelector("button").addEventListener("click",()=>{w("/api/setting/setBazaar",{trust:!0,petalDisabled:window.siyuan.config.bazaar.petalDisabled},()=>{window.siyuan.config.bazaar.trust=!0,he.element.innerHTML=he.genHTML(),he.bindEvent(t)})});return}this._genMyHTML("plugins",t),he.element.firstElementChild.addEventListener("click",e=>{let n=e.target;const a=q(n,"data-obj",null);let i;for(a&&(i=JSON.parse(a.getAttribute("data-obj")));n&&!n.isEqualNode(he.element);){const s=n.getAttribute("data-type");if(n.tagName==="A")break;if(s==="open"&&i){const o=i.bazaarType;o==="icons"||o==="themes"?te.shell.openPath(kt.join(window.siyuan.config.system.confDir,"appearance",o,i.name)):te.shell.openPath(kt.join(window.siyuan.config.system.dataDir,o,i.name)),e.preventDefault(),e.stopPropagation();break}else if(["myTheme","myTemplate","myIcon","myWidget","myPlugin"].includes(s)){n.classList.contains("b3-button--outline")&&!he.element.querySelector("#configBazaarDownloaded").getAttribute("data-loading")&&(n.parentElement.childNodes.forEach(o=>{o.nodeType!==3&&o.classList.contains("b3-button")&&o.classList.add("b3-button--outline")}),n.classList.remove("b3-button--outline"),this._genMyHTML(s.replace("my","").toLowerCase()+"s",t)),e.preventDefault(),e.stopPropagation();break}else if(s==="goBack"){he.element.querySelector("#configBazaarReadme").classList.remove("config-bazaar__readme--show"),e.preventDefault(),e.stopPropagation();break}else if(s==="install"){if(!n.classList.contains("b3-button--progress")){const o=i.bazaarType;let l="/api/bazaar/installBazaarTemplate";o==="themes"?l="/api/bazaar/installBazaarTheme":o==="icons"?l="/api/bazaar/installBazaarIcon":o==="widgets"?l="/api/bazaar/installBazaarWidget":o==="plugins"&&(l="/api/bazaar/installBazaarPlugin"),w(l,{repoURL:i.repoURL,packageName:i.name,repoHash:i.repoHash,mode:i.themeMode==="dark"?1:0,frontend:(0,I.UP)()},r=>{if(window.siyuan.config.appearance.themeJS&&o==="themes"){It({cb(){window.location.reload()},errorExit:!1});return}he._onBazaar(r,o,["themes","icons"].includes(o)),he._genMyHTML(o,t),o==="plugins"&&Ne(window.siyuan.languages.confirm,window.siyuan.languages.enablePluginTip,()=>{w("/api/petal/setPetalEnabled",{packageName:i.name,enabled:!0,frontend:(0,I.UP)()},c=>{wb(t,c.data),he._genMyHTML(o,t)})})})}e.preventDefault(),e.stopPropagation();break}else if(s==="install-t"){n.classList.contains("b3-button--progress")||Ne(window.siyuan.languages.update,window.siyuan.languages.exportTplTip,()=>{const o=i.bazaarType;let l="/api/bazaar/installBazaarTemplate";o==="themes"?l="/api/bazaar/installBazaarTheme":o==="icons"?l="/api/bazaar/installBazaarIcon":o==="widgets"?l="/api/bazaar/installBazaarWidget":o==="plugins"&&(l="/api/bazaar/installBazaarPlugin"),n.classList.contains("b3-button")||n.parentElement.insertAdjacentHTML("afterend",'<img data-type="img-loading" style="position: absolute;top: 0;left: 0;height: 100%;width: 100%;padding: 48px;box-sizing: border-box;" src="/stage/loading-pure.svg">'),w(l,{repoURL:i.repoURL,packageName:i.name,repoHash:i.repoHash,mode:i.themeMode==="dark"?1:0,update:!0,frontend:(0,I.UP)()},r=>{if(this._genMyHTML(o,t),he._onBazaar(r,o,["icons"].includes(o)),o==="themes"&&(window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight===i.name||window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark===i.name))if(window.siyuan.config.appearance.themeJS)It({cb(){window.location.reload()},errorExit:!1});else{const c=document.getElementById("themeDefaultStyle");c.href=c.href+"1"}})}),e.preventDefault(),e.stopPropagation();break}else if(s==="uninstall"){const o=i.bazaarType;let l="/api/bazaar/uninstallBazaarTemplate";o==="themes"?l="/api/bazaar/uninstallBazaarTheme":o==="icons"?l="/api/bazaar/uninstallBazaarIcon":o==="widgets"?l="/api/bazaar/uninstallBazaarWidget":o==="plugins"&&(l="/api/bazaar/uninstallBazaarPlugin");const r=i.name;window.siyuan.config.appearance.themeDark===r||window.siyuan.config.appearance.themeLight===r||window.siyuan.config.appearance.icon===r?M(window.siyuan.languages.uninstallTip):Ne(window.siyuan.languages.uninstall,window.siyuan.languages.confirmUninstall.replace("${name}",r),()=>{w(l,{packageName:r,frontend:(0,I.UP)()},c=>{this._genMyHTML(o,t),he._onBazaar(c,o,["themes","icons"].includes(o)),o==="plugins"&&ju(t,r)})}),e.preventDefault(),e.stopPropagation();break}else if(s==="switch"){const o=i.bazaarType,l=i.name,r=i.themeMode==="dark"?1:0;o==="icons"?w("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{icon:l}),c=>{this._genMyHTML(o,t),w("/api/bazaar/getBazaarIcon",{},d=>{d.data.appearance=c.data,he._onBazaar(d,"icons",!0),he._data.icons=d.data.packages})}):o==="themes"&&w("/api/setting/setAppearance",Object.assign({},window.siyuan.config.appearance,{mode:r,modeOS:!1,themeDark:r===1?l:window.siyuan.config.appearance.themeDark,themeLight:r===0?l:window.siyuan.config.appearance.themeLight}),c=>{(r!==window.siyuan.config.appearance.mode||r===1&&window.siyuan.config.appearance.themeDark!==l||r===0&&window.siyuan.config.appearance.themeLight!==l)&&window.siyuan.config.appearance.themeJS?It({cb(){window.location.reload()},errorExit:!1}):(this._genMyHTML("themes",t),w("/api/bazaar/getBazaarTheme",{},d=>{d.data.appearance=c.data,he._onBazaar(d,"themes",!0),he._data.themes=d.data.packages}))}),e.preventDefault(),e.stopPropagation();break}else if(s==="setting"){t.plugins.find(o=>{if(o.name===i.name)return o.openSetting(),!0}),e.preventDefault(),e.stopPropagation();break}else if(s==="plugins-enable"){n.getAttribute("disabled")||(n.setAttribute("disabled","disabled"),window.siyuan.config.bazaar.petalDisabled=!n.checked,w("/api/setting/setBazaar",window.siyuan.config.bazaar,()=>{n.removeAttribute("disabled"),window.siyuan.config.bazaar.petalDisabled?he.element.querySelectorAll("#configBazaarDownloaded .b3-card").forEach(o=>{o.classList.add("b3-card--disabled"),ju(t,JSON.parse(o.getAttribute("data-obj")).name)}):(he.element.querySelectorAll("#configBazaarDownloaded .b3-card").forEach(o=>{o.classList.remove("b3-card--disabled")}),mb(t).then(()=>{t.plugins.forEach(o=>{Fu(o)})}))})),e.stopPropagation();break}else if(s==="plugin-enable"){if(!n.getAttribute("disabled")){n.setAttribute("disabled","disabled");const o=n.checked;w("/api/petal/setPetalEnabled",{packageName:i.name,enabled:o,frontend:(0,I.UP)()},l=>{n.removeAttribute("disabled"),o?wb(t,l.data).then(r=>{r.setting||r.__proto__.hasOwnProperty("openSetting")?n.parentElement.querySelector('[data-type="setting"]').classList.remove("fn__none"):n.parentElement.querySelector('[data-type="setting"]').classList.add("fn__none")}):(ju(t,i.name),n.parentElement.querySelector('[data-type="setting"]').classList.add("fn__none"))})}e.stopPropagation();break}else if(n.classList.contains("b3-card")){A(e.target,"b3-card__actions--right")||he._renderReadme(n,i.bazaarType),e.preventDefault(),e.stopPropagation();break}else if(n.classList.contains("item")&&!n.classList.contains("item--focus")){he.element.querySelector(".layout-tab-bar .item--focus").classList.remove("item--focus"),n.classList.add("item--focus"),he.element.querySelectorAll(".bazaarPanel").forEach(o=>{s===o.getAttribute("data-type")?(o.classList.remove("fn__none"),o.getAttribute("data-init")||(s==="template"?w("/api/bazaar/getBazaarTemplate",{},l=>{he._onBazaar(l,"templates",!1),he._data.templates=l.data.packages}):s==="icon"?w("/api/bazaar/getBazaarIcon",{},l=>{he._onBazaar(l,"icons",!1),he._data.icons=l.data.packages}):s==="widget"?w("/api/bazaar/getBazaarWidget",{},l=>{he._onBazaar(l,"widgets",!1),he._data.widgets=l.data.packages}):s==="theme"?w("/api/bazaar/getBazaarTheme",{},l=>{he._onBazaar(l,"themes",!1),he._data.themes=l.data.packages}):s==="plugin"&&w("/api/bazaar/getBazaarPlugin",{frontend:(0,I.UP)()},l=>{he._onBazaar(l,"plugins",!1),he._data.plugins=l.data.packages}),o.setAttribute("data-init","true"))):o.classList.add("fn__none")}),e.preventDefault(),e.stopPropagation();break}else if(n.classList.contains("item__preview")){n.classList.toggle("item__preview--fullscreen"),e.preventDefault(),e.stopPropagation();break}n=n.parentElement}}),he.element.querySelectorAll(".bazaarPanel .b3-form__icon > .b3-text-field").forEach(e=>{e.addEventListener("keydown",n=>{if(!n.isComposing&&n.key==="Enter"){const a=e.value.trim(),i=A(e,"bazaarPanel").getAttribute("data-type");if(i==="template")w("/api/bazaar/getBazaarTemplate",{keyword:a},s=>{he._onBazaar(s,"templates",!1),he._data.templates=s.data.packages});else if(i==="icon")w("/api/bazaar/getBazaarIcon",{keyword:a},s=>{he._onBazaar(s,"icons",!1),he._data.icons=s.data.packages});else if(i==="widget")w("/api/bazaar/getBazaarWidget",{keyword:a},s=>{he._onBazaar(s,"widgets",!1),he._data.widgets=s.data.packages});else if(i==="theme")w("/api/bazaar/getBazaarTheme",{keyword:a},s=>{he._onBazaar(s,"themes",!1),he._data.themes=s.data.packages});else if(i==="plugin")w("/api/bazaar/getBazaarPlugin",{frontend:(0,I.UP)(),keyword:a},s=>{he._onBazaar(s,"plugins",!1),he._data.plugins=s.data.packages});else if(i==="downloaded"){const s=e.parentElement.parentElement.querySelector(".b3-button:not(.b3-button--outline)").getAttribute("data-type").replace("my","").toLowerCase()+"s";this._genMyHTML(s,t)}n.preventDefault();return}})}),he.element.querySelectorAll(".b3-select").forEach(e=>{e.addEventListener("change",n=>{if(e.id==="bazaarSelect")he.element.querySelectorAll("#configBazaarTheme .b3-card").forEach(a=>{const i=JSON.parse(a.getAttribute("data-obj"));e.value==="0"?i.themeMode.indexOf("light")>-1?a.classList.remove("fn__none"):a.classList.add("fn__none"):e.value==="1"?i.themeMode.indexOf("dark")>-1?a.classList.remove("fn__none"):a.classList.add("fn__none"):a.classList.remove("fn__none")}),n.target.parentElement.querySelector(".counter").textContent=he.element.querySelectorAll("#configBazaarTheme .b3-card:not(.fn__none)").length.toString();else{const a=window.siyuan.storage[p.Constants.LOCAL_BAZAAR],i=e.parentElement.parentElement;let s="";const o=Array.from(i.querySelectorAll(".b3-card"));e.value==="0"?o.sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(l.getAttribute("data-obj")).updated?-1:1).forEach(l=>{s+=l.outerHTML}):e.value==="1"?o.sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(l.getAttribute("data-obj")).updated?1:-1).forEach(l=>{s+=l.outerHTML}):e.value==="2"?o.sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?-1:1).forEach(l=>{s+=l.outerHTML}):e.value==="3"&&o.sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?1:-1).forEach(l=>{s+=l.outerHTML}),a[e.parentElement.parentElement.getAttribute("data-type")]=e.value,pe(p.Constants.LOCAL_BAZAAR,window.siyuan.storage[p.Constants.LOCAL_BAZAAR]),o.length>1&&(s+='<div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div><div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div>'),i.querySelector(".b3-cards").innerHTML=s}})})},_onBazaar(t,e,n){let a="#configBazaarTemplate";e==="themes"?a="#configBazaarTheme":e==="icons"?a="#configBazaarIcon":e==="widgets"?a="#configBazaarWidget":e==="plugins"&&(a="#configBazaarPlugin");const i=he.element.querySelector(a);t.code===1&&(M(t.msg),i.querySelectorAll("img[data-type='img-loading']").forEach(l=>{l.remove()}));let s="";t.data.packages.forEach(l=>{s+=this._genCardHTML(l,e)}),he._data[e]=t.data.packages,i.innerHTML=`<div class="b3-cards">${s}</div>`,i.parentElement.querySelector(".counter").textContent=i.querySelectorAll(".b3-card:not(.fn__none)").length.toString();const o=window.siyuan.storage[p.Constants.LOCAL_BAZAAR];o[e.replace("s","")]==="1"?(s="",Array.from(i.querySelectorAll(".b3-card")).sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).updated<JSON.parse(l.getAttribute("data-obj")).updated?1:-1).forEach(l=>{s+=l.outerHTML})):o[e.replace("s","")]==="2"?(s="",Array.from(i.querySelectorAll(".b3-card")).sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?-1:1).forEach(l=>{s+=l.outerHTML})):o[e.replace("s","")]==="3"&&(s="",Array.from(i.querySelectorAll(".b3-card")).sort((l,r)=>JSON.parse(r.getAttribute("data-obj")).downloads<JSON.parse(l.getAttribute("data-obj")).downloads?1:-1).forEach(l=>{s+=l.outerHTML})),t.data.packages.length>1&&(s+='<div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div><div class="fn__flex-1" style="margin-left: 15px;min-width: 342px;"></div>'),i.innerHTML=`<div class="b3-cards">${s}</div>`,n&&tt.onSetappearance(t.data.appearance)}},Ge={element:void 0,genHTML:()=>`<div class="b3-label">
 ${window.siyuan.languages.searchBlockType}
    <div class="fn__flex config-query">
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconMath"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.math}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="mathBlock" type="checkbox"${window.siyuan.config.search.mathBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconTable"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.table}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="table" type="checkbox"${window.siyuan.config.search.table?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconQuote"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.quote}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="blockquote" type="checkbox"${window.siyuan.config.search.blockquote?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconSuper"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.superBlock}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="superBlock" type="checkbox"${window.siyuan.config.search.superBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconParagraph"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.paragraph}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="paragraph" type="checkbox"${window.siyuan.config.search.paragraph?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconFile"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.doc}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="document" type="checkbox"${window.siyuan.config.search.document?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconHeadings"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.headings}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="heading" type="checkbox"${window.siyuan.config.search.heading?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconList"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.list1}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="list" type="checkbox"${window.siyuan.config.search.list?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconListItem"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.listItem}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="listItem" type="checkbox"${window.siyuan.config.search.listItem?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconCode"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.code}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="codeBlock" type="checkbox"${window.siyuan.config.search.codeBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconHTML5"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                HTML
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="htmlBlock" type="checkbox"${window.siyuan.config.search.htmlBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconSQL"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.embedBlock}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="embedBlock" type="checkbox"${window.siyuan.config.search.embedBlock?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconDatabase"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.database}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="databaseBlock" type="checkbox"${window.siyuan.config.search.databaseBlock?" checked":""}/>
        </label>        
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchBlockAttr}
    <div class="config-query">
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconN"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="name" type="checkbox"${window.siyuan.config.search.name?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconA"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="alias" type="checkbox"${window.siyuan.config.search.alias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <svg class="svg"><use xlink:href="#iconM"></use></svg>
            <span class="fn__space"></span>
            <div class="fn__flex-1">
                ${window.siyuan.languages.memo}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="memo" type="checkbox"${window.siyuan.config.search.memo?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.allAttrs}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="ial" type="checkbox"${window.siyuan.config.search.ial?" checked":""}/>
        </label>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchBackmention}
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionName" type="checkbox"${window.siyuan.config.search.backlinkMentionName?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionAlias" type="checkbox"${window.siyuan.config.search.backlinkMentionAlias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.anchor}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionAnchor" type="checkbox"${window.siyuan.config.search.backlinkMentionAnchor?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.docName}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="backlinkMentionDoc" type="checkbox"${window.siyuan.config.search.backlinkMentionDoc?" checked":""}/>
        </label>
        <div class="fn__flex label" style="flex: 2">
            <div>
                ${window.siyuan.languages.keywordsLimit}
            </div>
            <span class="fn__space"></span>
            <input class="b3-text-field" id="backlinkMentionKeywordsLimit" type="number" min="1" max="10240" value="${window.siyuan.config.search.backlinkMentionKeywordsLimit}">
        </div>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchVirtualRef}
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.name}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefName" type="checkbox"${window.siyuan.config.search.virtualRefName?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.alias}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefAlias" type="checkbox"${window.siyuan.config.search.virtualRefAlias?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.anchor}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefAnchor" type="checkbox"${window.siyuan.config.search.virtualRefAnchor?" checked":""}/>
        </label>
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.docName}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="virtualRefDoc" type="checkbox"${window.siyuan.config.search.virtualRefDoc?" checked":""}/>
        </label>
    </div>
</div>
<div class="b3-label">
 ${window.siyuan.languages.searchIndex}
    <div class="config-query">
        <label class="fn__flex">
            <div class="fn__flex-1">
                ${window.siyuan.languages.indexAssetPath}
            </div>
            <span class="fn__space"></span>
            <input class="b3-switch" id="indexAssetPath" type="checkbox"${window.siyuan.config.search.indexAssetPath?" checked":""}/>
        </label>
    </div>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.searchLimit}
         <div class="b3-label__text">${window.siyuan.languages.searchLimit1}</div>
         <div class="b3-label__text">${window.siyuan.languages.searchLimit2}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="limit" type="number" min="32" max="10240" value="${window.siyuan.config.search.limit}">
</div>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.searchCaseSensitive}
         <div class="b3-label__text">${window.siyuan.languages.searchCaseSensitive1}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="caseSensitive" type="checkbox"${window.siyuan.config.search.caseSensitive?" checked":""}/>
</label>`,bindEvent:()=>{Ge.element.querySelectorAll("input").forEach(t=>{t.addEventListener("change",()=>{w("/api/setting/setSearch",{document:Ge.element.querySelector("#document").checked,heading:Ge.element.querySelector("#heading").checked,list:Ge.element.querySelector("#list").checked,listItem:Ge.element.querySelector("#listItem").checked,codeBlock:Ge.element.querySelector("#codeBlock").checked,htmlBlock:Ge.element.querySelector("#htmlBlock").checked,embedBlock:Ge.element.querySelector("#embedBlock").checked,databaseBlock:Ge.element.querySelector("#databaseBlock").checked,mathBlock:Ge.element.querySelector("#mathBlock").checked,table:Ge.element.querySelector("#table").checked,blockquote:Ge.element.querySelector("#blockquote").checked,superBlock:Ge.element.querySelector("#superBlock").checked,paragraph:Ge.element.querySelector("#paragraph").checked,name:Ge.element.querySelector("#name").checked,alias:Ge.element.querySelector("#alias").checked,memo:Ge.element.querySelector("#memo").checked,ial:Ge.element.querySelector("#ial").checked,indexAssetPath:Ge.element.querySelector("#indexAssetPath").checked,limit:parseInt(Ge.element.querySelector("#limit").value),caseSensitive:Ge.element.querySelector("#caseSensitive").checked,backlinkMentionName:Ge.element.querySelector("#backlinkMentionName").checked,backlinkMentionAlias:Ge.element.querySelector("#backlinkMentionAlias").checked,backlinkMentionAnchor:Ge.element.querySelector("#backlinkMentionAnchor").checked,backlinkMentionDoc:Ge.element.querySelector("#backlinkMentionDoc").checked,backlinkMentionKeywordsLimit:parseInt(Ge.element.querySelector("#backlinkMentionKeywordsLimit").value),virtualRefName:Ge.element.querySelector("#virtualRefName").checked,virtualRefAlias:Ge.element.querySelector("#virtualRefAlias").checked,virtualRefAnchor:Ge.element.querySelector("#virtualRefAnchor").checked,virtualRefDoc:Ge.element.querySelector("#virtualRefDoc").checked},e=>{window.siyuan.config.search=e.data})})})}},da={element:void 0,genHTML:()=>{let t="";return t=`<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiTimeout}
        <div class="b3-label__text">${window.siyuan.languages.apiTimeoutTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="1" min="5" max="600" id="apiTimeout" value="${window.siyuan.config.ai.openAI.apiTimeout}"/>
</div>
<div class="fn__flex b3-label config__item">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiModel}
        <div class="b3-label__text">${window.siyuan.languages.apiModelTip}</div>
    </div>
    <span class="fn__space"></span>
    <select id="apiModel" class="b3-select fn__flex-center fn__size200">
        <option value="gpt-4" ${window.siyuan.config.ai.openAI.apiModel==="gpt-4"?"selected":""}>gpt-4</option>
        <option value="gpt-4-32k" ${window.siyuan.config.ai.openAI.apiModel==="gpt-4-32k"?"selected":""}>gpt-4-32k</option>
        <option value="gpt-4-1106-preview" ${window.siyuan.config.ai.openAI.apiModel==="gpt-4-1106-preview"?"selected":""}>gpt-4-1106-preview</option>
        <option value="gpt-3.5-turbo" ${window.siyuan.config.ai.openAI.apiModel==="gpt-3.5-turbo"?"selected":""}>gpt-3.5-turbo</option>
        <option value="gpt-3.5-turbo-16k" ${window.siyuan.config.ai.openAI.apiModel==="gpt-3.5-turbo-16k"?"selected":""}>gpt-3.5-turbo-16k</option>
        <option value="gpt-3.5-turbo-1106" ${window.siyuan.config.ai.openAI.apiModel==="gpt-3.5-turbo-1106"?"selected":""}>gpt-3.5-turbo-1106</option>
    </select>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.apiMaxTokens}
        <div class="b3-label__text">${window.siyuan.languages.apiMaxTokensTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" type="number" step="1" min="0" id="apiMaxTokens" value="${window.siyuan.config.ai.openAI.apiMaxTokens}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.apiKey}
        <div class="b3-label__text">${window.siyuan.languages.apiKeyTip}</div>
        <div class="fn__hr"></div>
        <input class="b3-text-field fn__block" id="apiKey" value="${window.siyuan.config.ai.openAI.apiKey}"/>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.apiProxy}
        <div class="b3-label__text">${window.siyuan.languages.apiProxyTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiProxy" value="${window.siyuan.config.ai.openAI.apiProxy}"/>
    </div>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.apiBaseURL}
        <div class="b3-label__text">${window.siyuan.languages.apiBaseURLTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="apiBaseURL" value="${window.siyuan.config.ai.openAI.apiBaseURL}"/>
    </div>
</div>`,`<div class="fn__flex-column" style="height: 100%">
<div class="layout-tab-bar fn__flex">
    <div data-type="openai" class="item item--full item--focus"><span class="fn__flex-1"></span><span class="item__text">OpenAI</span><span class="fn__flex-1"></span></div>
</div>
<div class="fn__flex-1">
    <div data-type="openai">
        ${t}
    </div>
</div>
</div>`},bindEvent:()=>{da.element.querySelectorAll("input,select").forEach(t=>{t.addEventListener("change",()=>{w("/api/setting/setAI",{openAI:{apiBaseURL:da.element.querySelector("#apiBaseURL").value,apiKey:da.element.querySelector("#apiKey").value,apiModel:da.element.querySelector("#apiModel").value,apiMaxTokens:parseInt(da.element.querySelector("#apiMaxTokens").value),apiProxy:da.element.querySelector("#apiProxy").value,apiTimeout:parseInt(da.element.querySelector("#apiTimeout").value)}},e=>{window.siyuan.config.ai=e.data})})})}},gn={element:void 0,genHTML:()=>{let t=`<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardMark}
        <div class="b3-label__text">${window.siyuan.languages.flashcardMarkTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="mark" type="checkbox"${window.siyuan.config.flashcard.mark?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardList}
        <div class="b3-label__text">${window.siyuan.languages.flashcardListTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="list" type="checkbox"${window.siyuan.config.flashcard.list?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardHeading}
        <div class="b3-label__text">${window.siyuan.languages.flashcardHeadingTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="heading" type="checkbox"${window.siyuan.config.flashcard.heading?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardSuperBlock}
        <div class="b3-label__text">${window.siyuan.languages.flashcardSuperBlockTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="superBlock" type="checkbox"${window.siyuan.config.flashcard.superBlock?" checked":""}/>
</label>
<label class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardDeck}
        <div class="b3-label__text">${window.siyuan.languages.flashcardDeckTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-switch fn__flex-center" id="deck" type="checkbox"${window.siyuan.config.flashcard.deck?" checked":""}/>
</label>`;return t=`${t}<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardNewCardLimit}
        <div class="b3-label__text">${window.siyuan.languages.flashcardNewCardLimitTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="newCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.newCardLimit?" checked":""} value="${window.siyuan.config.flashcard.newCardLimit}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardReviewCardLimit}
        <div class="b3-label__text">${window.siyuan.languages.flashcardReviewCardLimitTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="reviewCardLimit" step="1" min="0" type="number"${window.siyuan.config.flashcard.reviewCardLimit?" checked":""} value="${window.siyuan.config.flashcard.reviewCardLimit}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardFSRSParamRequestRetention}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamRequestRetentionTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="requestRetention" step="0.01" min="0" max="1" type="number" value="${window.siyuan.config.flashcard.requestRetention}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__flex-1">
        ${window.siyuan.languages.flashcardFSRSParamMaximumInterval}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamMaximumIntervalTip}</div>
    </div>
    <span class="fn__space"></span>
    <input class="b3-text-field fn__flex-center fn__size200" id="maximumInterval" step="1" min="365" max="36500" type="number" value="${window.siyuan.config.flashcard.maximumInterval}"/>
</div>
<div class="fn__flex b3-label">
    <div class="fn__block">
        ${window.siyuan.languages.flashcardFSRSParamWeights}
        <div class="b3-label__text">${window.siyuan.languages.flashcardFSRSParamWeightsTip}</div>
        <span class="fn__hr"></span>
        <input class="b3-text-field fn__block" id="weights" value="${window.siyuan.config.flashcard.weights}"/>
    </div>
</div>`,t},bindEvent:()=>{gn.element.querySelectorAll("input").forEach(t=>{t.addEventListener("change",()=>{w("/api/setting/setFlashcard",{newCardLimit:parseInt(gn.element.querySelector("#newCardLimit").value),reviewCardLimit:parseInt(gn.element.querySelector("#reviewCardLimit").value),mark:gn.element.querySelector("#mark").checked,list:gn.element.querySelector("#list").checked,superBlock:gn.element.querySelector("#superBlock").checked,heading:gn.element.querySelector("#heading").checked,deck:gn.element.querySelector("#deck").checked,requestRetention:parseFloat(gn.element.querySelector("#requestRetention").value),maximumInterval:parseInt(gn.element.querySelector("#maximumInterval").value),weights:gn.element.querySelector("#weights").value},e=>{window.siyuan.config.flashcard=e.data})})})}},Pb=(t,e,n)=>{switch(t){case"filetree":e.innerHTML=Ht.genHTML(),Ht.element=e,Ht.bindEvent();break;case"AI":e.innerHTML=da.genHTML(),da.element=e,da.bindEvent();break;case"card":e.innerHTML=gn.genHTML(),gn.element=e,gn.bindEvent();break;case"image":e.innerHTML=Pn.genHTML(),Pn.element=e,Pn.bindEvent();break;case"export":e.innerHTML=We.genHTML(),We.element=e,We.bindEvent();break;case"appearance":e.innerHTML=tt.genHTML(),tt.element=e,tt.bindEvent();break;case"keymap":e.innerHTML=Je.genHTML(n),Je.element=e,Je.bindEvent(n);break;case"bazaar":he.element=e,e.innerHTML=he.genHTML(),he.bindEvent(n);break;case"account":e.innerHTML=Pt.genHTML(),Pt.element=e,Pt.bindEvent(Pt.element);break;case"repos":e.innerHTML=Dt.genHTML(),Dt.element=e,Dt.bindEvent();break;case"about":e.innerHTML=_t.genHTML(),_t.element=e,_t.bindEvent();break;case"search":e.innerHTML=Ge.genHTML(),Ge.element=e,Ge.bindEvent();break;default:break}},As=t=>{const e=window.siyuan.dialogs.find(a=>{if(a.element.querySelector(".config__tab-container"))return a.destroy(),!0});if(e)return e;const n=new me({content:`<div class="fn__flex-1 fn__flex config__panel" style="overflow: hidden;position: relative">
  <ul class="b3-tab-bar b3-list b3-list--background">
    <div class="config__tab-title resize__move">
        <svg class="b3-list-item__graphic"><use xlink:href="#iconSettings"></use></svg>
        <span class="b3-list-item__text">${window.siyuan.languages.config}</span>
    </div>
    <div class="b3-form__icon"><svg class="b3-form__icon-icon"><use xlink:href="#iconSearch"></use></svg><input placeholder="${window.siyuan.languages.search}" class="b3-text-field fn__block b3-form__icon-input"></div>
    <div class="config__tab-hr"></div>
    <li data-name="editor" class="b3-list-item--focus b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconEdit"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.editor}</span></li>
    <li data-name="filetree" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconFiles"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.fileTree}</span></li>
    <li data-name="card" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconRiffCard"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.riffCard}</span></li>
    <li data-name="AI" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconSparkles"></use></svg><span class="b3-list-item__text">AI</span></li>
    <li data-name="image" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconImage"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.assets}</span></li>
    <li data-name="export" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconUpload"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.export}</span></li>
    <li data-name="appearance" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconTheme"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.appearance}</span></li>
    <li data-name="bazaar" class="b3-list-item${Y()?" fn__none":""}"><svg class="b3-list-item__graphic"><use xlink:href="#iconBazaar"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.bazaar}</span></li>
    <li data-name="search" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconSearch"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.search}</span></li>
    <li data-name="keymap" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconKeymap"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.keymap}</span></li>
    <li data-name="account" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconAccount"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.account}</span></li>
    <li data-name="repos" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconCloud"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.cloud}</span></li>
    <li data-name="about" class="b3-list-item"><svg class="b3-list-item__graphic"><use xlink:href="#iconInfo"></use></svg><span class="b3-list-item__text">${window.siyuan.languages.about}</span></li>
  </ul>
  <div class="config__tab-wrap">
      <div class="fn__hr--b resize__move"></div>
      <div class="config__tab-container" data-name="editor">${Oe.genHTML()}</div>
      <div class="config__tab-container fn__none" data-name="filetree"></div>
      <div class="config__tab-container fn__none" data-name="card"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="AI"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="image"></div>
      <div class="config__tab-container fn__none" data-name="export"></div>
      <div class="config__tab-container fn__none" data-name="appearance"></div>
      <div class="config__tab-container config__tab-container--top fn__none" data-name="bazaar"></div>
      <div class="config__tab-container fn__none" data-name="search"></div>
      <div class="config__tab-container fn__none" style="overflow: scroll" data-name="keymap"></div>
      <div class="config__tab-container config__tab-container--full fn__none" data-name="account"></div>
      <div class="config__tab-container fn__none" data-name="repos"></div>
      <div class="config__tab-container fn__none" data-name="about"></div>
      <div class="fn__hr--b"></div>
  </div>
</div>`,width:"90vw",height:"90vh"});return hk(n.element,t),n.element.querySelector(".b3-dialog__container").style.maxWidth="1280px",n.element.querySelectorAll(".b3-tab-bar .b3-list-item").forEach(a=>{a.addEventListener("click",()=>{const i=a.getAttribute("data-name"),s=n.element.querySelector(`.config__tab-container[data-name="${i}"]`);n.element.querySelectorAll(".config__tab-container").forEach(o=>{o.classList.add("fn__none")}),n.element.querySelector(".b3-tab-bar .b3-list-item.b3-list-item--focus").classList.remove("b3-list-item--focus"),a.classList.add("b3-list-item--focus"),s.classList.remove("fn__none"),(s.innerHTML===""||i==="repos"||i==="bazaar")&&Pb(i,s,t)})}),Oe.element=n.element.querySelector('.config__tab-container[data-name="editor"]'),Oe.bindEvent(),n},bk=t=>{const e=new me({title:window.siyuan.languages.cloudSyncDir,content:`<div class="b3-dialog__content">
    <input class="b3-text-field fn__block" value="main">
    <div class="b3-label__text">${window.siyuan.languages.reposTip}</div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),n=e.element.querySelector("input"),a=e.element.querySelectorAll(".b3-button");e.bindInput(n,()=>{a[1].click()}),n.focus(),n.select(),a[0].addEventListener("click",()=>{e.destroy()}),a[1].addEventListener("click",()=>{t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',w("/api/sync/createCloudSyncDir",{name:n.value},()=>{e.destroy(),zo(t,!0)})})},Mb=(t,e)=>{t.addEventListener("click",n=>{let a=n.target;for(;a&&!a.isEqualNode(t);){const i=a.getAttribute("data-type");if(i){switch(i){case"addCloud":bk(t);break;case"removeCloud":Ne(window.siyuan.languages.confirm,`${window.siyuan.languages.confirmDeleteCloudDir} <i>${a.parentElement.getAttribute("data-name")}</i>`,()=>{t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',w("/api/sync/removeCloudSyncDir",{name:a.parentElement.getAttribute("data-name")},s=>{window.siyuan.config.sync.cloudName=s.data,zo(t,!0,e)})});break;case"selectCloud":t.innerHTML='<img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">',w("/api/sync/setCloudSyncDir",{name:a.getAttribute("data-name")},()=>{window.siyuan.config.sync.cloudName=a.getAttribute("data-name"),zo(t,!0,e)});break}n.preventDefault(),n.stopPropagation();break}a=a.parentElement}})},zo=(t,e=!1,n)=>{!e&&t.firstElementChild.tagName!=="IMG"||w("/api/sync/listCloudSyncDir",{},a=>{let i=`<ul><li style="padding: 0 16px" class="b3-list--empty">${window.siyuan.languages.emptyCloudSyncList}</li></ul>`;a.code===1?i=`<ul>
    <li class="b3-list--empty ft__error">
        ${a.msg}
    </li>
    <li class="b3-list--empty">
        ${window.siyuan.languages.cloudConfigTip}
    </li>
</ul>`:a.code!==1&&(i='<ul class="b3-list b3-list--background fn__flex-1" style="overflow: auto;">',a.data.syncDirs.forEach(s=>{i+=`<li data-type="selectCloud" data-name="${s.cloudName}" class="b3-list-item b3-list-item--narrow b3-list-item--hide-action">
<input type="radio" name="cloudName"${s.cloudName===a.data.checkedSyncDir?" checked":""}/>
<span class="fn__space"></span>
<span>${s.cloudName}</span>
<span class="fn__space"></span>
<span class="ft__on-surface">${s.hSize}</span>
<span class="b3-list-item__meta">${s.updated}</span>
<span class="fn__flex-1 fn__space"></span>
<span data-type="removeCloud" class="b3-tooltips b3-tooltips__w b3-list-item__action" aria-label="${window.siyuan.languages.delete}">
    <svg><use xlink:href="#iconTrashcan"></use></svg>
</span></li>`}),i+=`</ul>
<div class="fn__hr"></div>
<div class="fn__flex">
    <div class="fn__flex-1"></div>
    <button class="b3-button b3-button--outline" data-type="addCloud"><svg><use xlink:href="#iconAdd"></use></svg>${window.siyuan.languages.addAttr}</button>
</div>`),t.innerHTML=i,n&&n()})},Ku=t=>{if(!window.siyuan.config.readonly&&!document.querySelector("#barSync")?.classList.contains("toolbar__item--active")){if(window.siyuan.config.sync.provider===0&&va("")&&t){const e=As(t);window.siyuan.user?e.element.querySelector('.b3-tab-bar [data-name="repos"]').dispatchEvent(new CustomEvent("click")):(e.element.querySelector('.b3-tab-bar [data-name="account"]').dispatchEvent(new CustomEvent("click")),e.element.querySelector('.config__tab-container[data-name="account"]').setAttribute("data-action","go-repos"));return}if(window.siyuan.config.sync.provider!==0&&!Ea()&&t){M(window.siyuan.languages._kernel[214]);return}if(!window.siyuan.config.repo.key){Hb(!0);return}if(!window.siyuan.config.sync.enabled){Nb();return}Zu()}},Zu=()=>{if(window.siyuan.config.sync.mode!==3){w("/api/sync/performSync",{});return}const t=new me({title:window.siyuan.languages.chooseSyncDirection,content:`<div class="b3-dialog__content">
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="true">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.uploadData2Cloud}
            <div class="b3-label__text">${window.siyuan.languages.uploadData2CloudTip}</div>
        </div>
    </label>
    <label class="fn__flex b3-label">
        <input type="radio" name="upload" value="false">
        <span class="fn__space"></span>
        <div>
            ${window.siyuan.languages.downloadDataFromCloud}
            <div class="b3-label__text">${window.siyuan.languages.downloadDataFromCloudTip}</div>
        </div>
    </label>
</div>
<div class="b3-dialog__action">
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button><div class="fn__space"></div>
    <button class="b3-button b3-button--text">${window.siyuan.languages.confirm}</button>
</div>`,width:(0,I.tq)()?"92vw":"520px"}),e=t.element.querySelectorAll(".b3-button");e[0].addEventListener("click",()=>{t.destroy()}),e[1].addEventListener("click",()=>{const n=t.element.querySelector("input[name=upload]:checked");if(!n){M(window.siyuan.languages.plsChoose);return}w("/api/sync/performSync",{upload:n.value==="true"}),t.destroy()})},Nb=(t,e)=>{if(t&&(window.siyuan.config.repo.key=t),window.siyuan.config.sync.enabled)e&&e.destroy(),Ne(window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{Zu()});else{const n=`<div class="b3-dialog__content">
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide3}</div>
    <div class="fn__hr--b"></div>
    <div style="display: flex;flex-direction: column;height: 40vh;">
        <img style="margin: 0 auto;display: block;width: 64px;height: 100%" src="/stage/loading-pure.svg">
    </div>
</div>
<div class="b3-dialog__action">
    <button class="b3-button" disabled="disabled">${window.siyuan.languages.openSyncTip1}</button>
</div>`;e?(e.element.querySelector(".b3-dialog__header").innerHTML=window.siyuan.languages.cloudSyncDir,e.element.querySelector(".b3-dialog__body").innerHTML=n):e=new me({title:window.siyuan.languages.cloudSyncDir,content:n,width:(0,I.tq)()?"92vw":"520px"});const a=e.element.querySelector(".b3-dialog__content").lastElementChild,i=e.element.querySelector(".b3-button");Mb(a,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),zo(a,!1,()=>{a.querySelector("input[checked]")?i.removeAttribute("disabled"):i.setAttribute("disabled","disabled")}),i.addEventListener("click",()=>{e.destroy(),w("/api/sync/setSyncEnable",{enabled:!0},()=>{window.siyuan.config.sync.enabled=!0,ra(),Ne(window.siyuan.languages.syncConfGuide4,window.siyuan.languages.syncConfGuide5,()=>{Zu()})})})}},Hb=(t,e)=>{const n=new me({title:window.siyuan.languages.syncConfGuide1,content:`<div class="b3-dialog__content ft__center">
    <img style="width: 260px" src="/stage/images/sync-guide.svg"/>
    <div class="fn__hr--b"></div>
    <div class="ft__on-surface">${window.siyuan.languages.syncConfGuide2}</div>
    <div class="fn__hr--b"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.passphrase}">
    <div class="fn__hr"></div>
    <input class="b3-text-field fn__block ft__center" placeholder="${window.siyuan.languages.duplicate} ${window.siyuan.languages.passphrase}">
</div>
<div class="b3-dialog__action">
    <label>
        <input type="checkbox" class="b3-switch fn__flex-center">
        <span class="fn__space"></span>
        ${window.siyuan.languages.confirmPassword}
    </label>
    <span class="fn__flex-1"></span>
    <button class="b3-button b3-button--cancel">${window.siyuan.languages.cancel}</button>
    <span class="fn__space"></span>
    <button class="b3-button b3-button--text" id="initKeyByPW" disabled>
        ${window.siyuan.languages.confirm}
    </button>
</div>`,width:(0,I.tq)()?"92vw":"520px"});n.element.querySelector(".b3-button--cancel").addEventListener("click",()=>{n.destroy()});const a=n.element.querySelector("#initKeyByPW");n.element.querySelector(".b3-switch").addEventListener("change",function(){this.checked?a.removeAttribute("disabled"):a.setAttribute("disabled","disabled")});const i=n.element.querySelectorAll(".b3-text-field");a.addEventListener("click",()=>{if(!i[0].value||!i[1].value){M(window.siyuan.languages._kernel[142]);return}if(i[0].value!==i[1].value){M(window.siyuan.languages.passwordNoMatch);return}Ne("\u{1F511} "+window.siyuan.languages.genKeyByPW,window.siyuan.languages.initRepoKeyTip,()=>{t||n.destroy(),w("/api/repo/initRepoKeyFromPassphrase",{pass:i[0].value},s=>{window.siyuan.config.repo.key=s.data.key,e&&e(),t&&Nb(s.data.key,n)})})}),i[0].focus()},wk=t=>{const e=document.getElementById("toolbar");e.innerHTML=`
<div id="barWorkspace" aria-label="${window.siyuan.languages.mainMenu} ${K(window.siyuan.config.keymap.general.mainMenu.custom)}" class="ariaLabel toolbar__item toolbar__item--active">
    <span class="toolbar__text">${op()}</span>
    <svg class="toolbar__svg"><use xlink:href="#iconDown"></use></svg>
</div>
<div id="barSync" class="ariaLabel toolbar__item${window.siyuan.config.readonly?" fn__none":""}">
    <svg><use xlink:href="#iconCloudSucc"></use></svg>
</div>
<button id="barBack" class="ariaLabel toolbar__item toolbar__item--disabled" aria-label="${window.siyuan.languages.goBack} ${K(window.siyuan.config.keymap.general.goBack.custom)}">
    <svg><use xlink:href="#iconBack"></use></svg>
</button>
<button id="barForward" class="ariaLabel toolbar__item toolbar__item--disabled" aria-label="${window.siyuan.languages.goForward} ${K(window.siyuan.config.keymap.general.goForward.custom)}">
    <svg><use xlink:href="#iconForward"></use></svg>
</button>
<div class="fn__flex-1 fn__ellipsis" id="drag"><span class="fn__none">\u5F00\u53D1\u7248\uFF0C\u4F7F\u7528\u524D\u8BF7\u8FDB\u884C\u5907\u4EFD Development version, please backup before use</span></div>
<div id="toolbarVIP" class="fn__flex${window.siyuan.config.readonly?" fn__none":""}"></div>
<div id="barPlugins" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.plugin}">
    <svg><use xlink:href="#iconPlugin"></use></svg>
</div>
<div id="barSearch" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.globalSearch} ${K(window.siyuan.config.keymap.general.globalSearch.custom)}">
    <svg><use xlink:href="#iconSearch"></use></svg>
</div>
<div id="barZoom" class="toolbar__item ariaLabel${window.siyuan.storage[p.Constants.LOCAL_ZOOM]===1||(0,I.jU)()?" fn__none":""}" aria-label="${window.siyuan.languages.zoom}">
    <svg><use xlink:href="#iconZoom${window.siyuan.storage[p.Constants.LOCAL_ZOOM]>1?"In":"Out"}"></use></svg>
</div>
<div id="barMode" class="toolbar__item ariaLabel${window.siyuan.config.readonly?" fn__none":""}" aria-label="${window.siyuan.languages.appearanceMode}">
    <svg><use xlink:href="#icon${window.siyuan.config.appearance.modeOS?"Mode":window.siyuan.config.appearance.mode===0?"Light":"Dark"}"></use></svg>
</div>
<div id="barExit" class="toolbar__item ariaLabel${Bt()||at()?"":" fn__none"}" aria-label="${window.siyuan.languages.safeQuit}">
    <svg><use xlink:href="#iconQuit"></use></svg>
</div>
<div id="barMore" class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.more}">
    <svg><use xlink:href="#iconMore"></use></svg>
</div>
<div class="fn__flex" id="windowControls"></div>`,ra(),e.addEventListener("click",a=>{let i=a.target;for(typeof a.detail=="string"&&(i=e.querySelector("#"+a.detail));!i.classList.contains("toolbar");){const s=typeof a.detail=="string"?a.detail:i.id;if(s==="barBack"){Gd(t),a.stopPropagation();break}else if(s==="barMore"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barmore"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barmore"),(i.getAttribute("data-hideids")||"").split(",").forEach(l=>{const r=e.querySelector("#"+l),c=r.querySelector("use"),d={label:l==="toolbarVIP"?window.siyuan.languages.account:r.getAttribute("aria-label"),icon:l==="toolbarVIP"?"iconAccount":c?c.getAttribute("xlink:href").substring(1):void 0,click:()=>{l.startsWith("plugin")?r.dispatchEvent(new CustomEvent("click")):e.dispatchEvent(new CustomEvent("click",{detail:l}))}};if(!c){const u=r.querySelector("svg").cloneNode(!0);u.classList.add("b3-menu__icon"),d.iconHTML=u.outerHTML}window.siyuan.menus.menu.append(new S(d).element)});const o=i.getBoundingClientRect();window.siyuan.menus.menu.popup({x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation();break}else if(s==="barForward"){jd(t),a.stopPropagation();break}else if(s==="barSync"){Ku(t),a.stopPropagation();break}else if(s==="barWorkspace"){Ib(t,i.getBoundingClientRect()),a.stopPropagation();break}else if(s==="barExit"){It({errorExit:!0,cb:Ss}),a.stopPropagation();break}else if(s==="barMode"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barmode"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barmode"),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.themeLight,icon:"iconLight",current:window.siyuan.config.appearance.mode===0&&!window.siyuan.config.appearance.modeOS,click:()=>{Jd(0)}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.themeDark,current:window.siyuan.config.appearance.mode===1&&!window.siyuan.config.appearance.modeOS,icon:"iconDark",click:()=>{Jd(1)}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.themeOS,current:window.siyuan.config.appearance.modeOS,icon:"iconMode",click:()=>{Jd(2)}}).element);let o=i.getBoundingClientRect();o.width===0&&(o=e.querySelector("#barMore").getBoundingClientRect()),window.siyuan.menus.menu.popup({x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation();break}else if(s==="toolbarVIP"){window.siyuan.config.readonly||As(t).element.querySelector('.b3-tab-bar [data-name="account"]').dispatchEvent(new CustomEvent("click")),a.stopPropagation();break}else if(s==="barSearch"){_n({app:t,hotkey:p.Constants.DIALOG_GLOBALSEARCH}),a.stopPropagation();break}else if(s==="barPlugins"){yk(t,i),a.stopPropagation();break}else if(s==="barZoom"){if(!window.siyuan.menus.menu.element.classList.contains("fn__none")&&window.siyuan.menus.menu.element.getAttribute("data-name")==="barZoom"){window.siyuan.menus.menu.remove();return}window.siyuan.menus.menu.remove(),window.siyuan.menus.menu.element.setAttribute("data-name","barZoom"),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.zoomIn,icon:"iconZoomIn",accelerator:"\u2318=",click:()=>{Ts("zoomIn")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.zoomOut,accelerator:"\u2318-",icon:"iconZoomOut",click:()=>{Ts("zoomOut")}}).element),window.siyuan.menus.menu.append(new S({label:window.siyuan.languages.reset,accelerator:"\u23180",click:()=>{Ts("restore")}}).element);let o=i.getBoundingClientRect();o.width===0&&(o=e.querySelector("#barMore").getBoundingClientRect()),window.siyuan.menus.menu.popup({x:o.right,y:o.bottom,isLeft:!0}),a.stopPropagation();break}i=i.parentElement}});const n=e.querySelector("#barSync");n.addEventListener("mouseenter",a=>{a.stopPropagation(),a.preventDefault(),w("/api/sync/getSyncInfo",{},i=>{let s="";!window.siyuan.config.sync.enabled||window.siyuan.config.sync.provider===0&&va("")?s=i.data.stat:(s=window.siyuan.languages._kernel[82].replace("%s",Q(i.data.synced).format("YYYY-MM-DD HH:mm"))+"<br>",s+="&emsp;"+i.data.stat,i.data.kernels.length>0&&(s+="<br>",s+=window.siyuan.languages.currentKernel+"<br>",s+="&emsp;"+i.data.kernel+"/"+window.siyuan.config.system.kernelVersion+" ("+window.siyuan.config.system.os+"/"+window.siyuan.config.system.name+")<br>",s+=window.siyuan.languages.otherOnlineKernels+"<br>",i.data.kernels.forEach(o=>{s+=`&emsp;${o.id}/${o.ver} (${o.os}/${o.hostname}) <br>`}))),n.setAttribute("aria-label",s)})}),n.setAttribute("aria-label",window.siyuan.config.sync.stat||window.siyuan.languages.syncNow+" "+K(window.siyuan.config.keymap.general.syncNow.custom))},Ts=t=>{const e=(0,I.FJ)();let n=1;t==="zoomIn"?p.Constants.SIZE_ZOOM.find((i,s)=>{if(i===window.siyuan.storage[p.Constants.LOCAL_ZOOM])return n=p.Constants.SIZE_ZOOM[s+1]||3,!0}):t==="zoomOut"&&p.Constants.SIZE_ZOOM.find((i,s)=>{if(i===window.siyuan.storage[p.Constants.LOCAL_ZOOM])return n=p.Constants.SIZE_ZOOM[s-1]||.25,!0}),te.webFrame.setZoomFactor(n),window.siyuan.storage[p.Constants.LOCAL_ZOOM]=n,e||pe(p.Constants.LOCAL_ZOOM,n);const a=document.getElementById("barZoom");n===1?a.classList.add("fn__none"):(n>1?a.querySelector("use").setAttribute("xlink:href","#iconZoomIn"):a.querySelector("use").setAttribute("xlink:href","#iconZoomOut"),a.classList.remove("fn__none"))},yk=(t,e)=>{const n=new At("topBarPlugin");Y()||n.addItem({icon:"iconSettings",label:window.siyuan.languages.manage,click(){As(t).element.querySelector('.b3-tab-bar [data-name="bazaar"]').dispatchEvent(new CustomEvent("click"))}}),n.addItem({icon:"iconLayoutBottom",accelerator:window.siyuan.config.keymap.general.commandPanel.custom,label:window.siyuan.languages.commandPanel,click(){Ab(t)}}),n.addSeparator();let a=!1;t.plugins.forEach(s=>{const o=s.setting||s.__proto__.hasOwnProperty("openSetting");let l=!1;s.topBarIcons.forEach(r=>{const c=window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].includes(r.id),d=[{icon:c?"iconPin":"iconUnpin",label:c?window.siyuan.languages.pin:window.siyuan.languages.unpin,click(){c?(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].splice(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].indexOf(r.id),1),r.classList.remove("fn__none")):(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN].push(r.id),window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN]=Array.from(new Set(window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN])),r.classList.add("fn__none")),pe(p.Constants.LOCAL_PLUGINTOPUNPIN,window.siyuan.storage[p.Constants.LOCAL_PLUGINTOPUNPIN])}}];o&&d.push({icon:"iconSettings",label:window.siyuan.languages.config,click(){s.openSetting()}});const u={icon:"iconInfo",label:r.getAttribute("aria-label"),click(){r.dispatchEvent(new CustomEvent("click"))},type:"submenu",submenu:d};if(r.querySelector("use"))u.icon=r.querySelector("use").getAttribute("xlink:href").replace("#","");else{const f=r.querySelector("svg").cloneNode(!0);f.classList.add("b3-menu__icon"),u.iconHTML=f.outerHTML}n.addItem(u),a=!0,l=!0}),!l&&o&&(a=!0,n.addItem({icon:"iconSettings",label:s.displayName,click(){s.openSetting()}}))}),a||window.siyuan.menus.menu.element.querySelector(".b3-menu__separator").remove();let i=e.getBoundingClientRect();i.width===0&&(i=document.querySelector("#barMore").getBoundingClientRect()),n.open({x:i.right,y:i.bottom,isLeft:!0})},_k=()=>{w("/api/system/getChangelog",{},t=>{if(!t.data.show)return;const e=new me({title:`\u2728 ${window.siyuan.languages.whatsNewInSiYuan} v${window.siyuan.config.system.kernelVersion}`,width:(0,I.tq)()?"92vw":"768px",height:(0,I.tq)()?"80vh":"70vh",content:`<div style="overflow:auto;" class="b3-dialog__content b3-typography b3-typography--default">${t.data.html}</div>`});qe(e.element)})},Ob=(t,e,n)=>{let a=1,i=t;for(;i&&(i.classList.contains("list")||i.classList.contains("li"));)i=document.elementFromPoint(e+73*a,n),i=x(i),a++;return i},vk=(t,e)=>{if(document.body.classList.contains("body--blur"))return;const n=window.siyuan.coordinates??(window.siyuan.coordinates={pageX:0,pageY:0,clientX:0,clientY:0,screenX:0,screenY:0});n.pageX=t.pageX,n.pageY=t.pageY,n.clientX=t.clientX,n.clientY=t.clientY,n.screenX=t.screenX,n.screenY=t.screenY,window.siyuan.hideBreadcrumb&&(window.siyuan.hideBreadcrumb=!1,Zm().forEach(o=>{o.protyle.breadcrumb?.element.classList.contains("protyle-breadcrumb__bar--hide")&&(o.protyle.breadcrumb.element.classList.remove("protyle-breadcrumb__bar--hide"),o.protyle.breadcrumb.render(o.protyle,!0))})),!e&&t.buttons===0&&window.siyuan.layout.bottomDock&&!(0,I.FJ)()&&(t.clientX<43?!window.siyuan.layout.leftDock.pin&&window.siyuan.layout.leftDock.layout.element.clientWidth>0&&(window.siyuan.layout.leftDock.element.clientWidth>0||window.siyuan.layout.leftDock.element.clientWidth===0&&t.clientX<8)&&(t.clientY>document.getElementById("toolbar").clientHeight&&t.clientY<window.innerHeight-document.getElementById("status").clientHeight-document.getElementById("dockBottom").clientHeight?!A(t.target,"b3-menu")&&!A(t.target,"layout--float")&&window.siyuan.layout.leftDock.showDock():window.siyuan.layout.leftDock.hideDock()):t.clientX>window.innerWidth-41&&!window.siyuan.layout.rightDock.pin&&window.siyuan.layout.rightDock.layout.element.clientWidth>0&&(window.siyuan.layout.rightDock.element.clientWidth>0||window.siyuan.layout.rightDock.element.clientWidth===0&&t.clientX>window.innerWidth-8)&&(t.clientY>document.getElementById("toolbar").clientHeight&&t.clientY<window.innerHeight-document.getElementById("status").clientHeight-document.getElementById("dockBottom").clientHeight?A(t.target,"layout--float")||window.siyuan.layout.rightDock.showDock():window.siyuan.layout.rightDock.hideDock()),t.clientY>Math.min(window.innerHeight-10,window.innerHeight-(window.siyuan.config.uiLayout.hideDock?0:42)-document.querySelector("#status").clientHeight)&&window.siyuan.layout.bottomDock.showDock());const a=t.composedPath()[0];if(a&&a.nodeType!==3&&a.classList.contains("protyle-wysiwyg")&&a.style.paddingLeft){const o=document.elementFromPoint(a.getBoundingClientRect().left+parseInt(a.style.paddingLeft)+13,t.clientY),l=x(o);if(l){const r=Ob(l,l.getBoundingClientRect().left+1,t.clientY);if(!r)return;let c;r.classList.contains("av")&&(c=A(o,"av__row"));const d=Pe();let u=!1;d.editor.find(f=>{if(f.editor.protyle.wysiwyg.element.isSameNode(a))return f.editor.protyle.gutter.render(f.editor.protyle,r,f.editor.protyle.wysiwyg.element,c),u=!0,!0}),u||window.siyuan.blockPanels.find(f=>{if(f.editors.find(g=>{if(g.protyle.wysiwyg.element.contains(a))return g.protyle.gutter.render(g.protyle,r,g.protyle.wysiwyg.element,c),u=!0,!0}),u)return!0}),u||d.backlink.find(f=>{if(f.editors.find(g=>{if(g.protyle.wysiwyg.element.isSameNode(a))return g.protyle.gutter.render(g.protyle,r,g.protyle.wysiwyg.element,c),u=!0,!0}),u)return!0})}return}if(a&&a.nodeType!==3&&(a.classList.contains("li")||a.classList.contains("list"))){const o=Ob(a,a.getBoundingClientRect().left+1,t.clientY);if(!o)return;const l=Pe();let r=!1;l.editor.find(c=>{if(c.editor.protyle.wysiwyg.element.contains(a))return c.editor.protyle.gutter.render(c.editor.protyle,o,c.editor.protyle.wysiwyg.element),r=!0,!0}),r||window.siyuan.blockPanels.find(c=>{if(c.editors.find(d=>{if(d.protyle.wysiwyg.element.contains(a))return d.protyle.gutter.render(d.protyle,o,d.protyle.wysiwyg.element),r=!0,!0}),r)return!0}),r||l.backlink.find(c=>{if(c.editors.find(d=>{if(d.protyle.wysiwyg.element.contains(a))return d.protyle.gutter.render(d.protyle,o,d.protyle.wysiwyg.element),r=!0,!0}),r)return!0});return}const i=t.target,s=A(i,"table");if(s&&s.style.cursor!=="col-resize"&&!A(s,"protyle-wysiwyg__embed")){const o=se(i,"TH")||se(i,"TD");if(o){const l=s.querySelector("table"),r=s.querySelector("table").clientHeight,c=s.querySelector(".table__resize");s.style.textAlign==="center"||s.style.textAlign==="right"?c.parentElement.style.left=l.offsetLeft+"px":c.parentElement.style.left="";const d=o.getBoundingClientRect();d.right-t.clientX<3&&d.right-t.clientX>0?(c.setAttribute("data-col-index",(xn(o)+o.colSpan-1).toString()),c.setAttribute("style",`height:${r}px;left: ${Math.round(o.offsetWidth+o.offsetLeft-s.firstElementChild.scrollLeft-3)}px;display:block`)):t.clientX-d.left<3&&t.clientX-d.left>0&&o.previousElementSibling&&(c.setAttribute("data-col-index",(xn(o)-1).toString()),c.setAttribute("style",`height:${r}px;left: ${Math.round(o.offsetLeft-s.firstElementChild.scrollLeft-3)}px;display:block`))}}},Ek=(t,e)=>{window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,window.siyuan.altIsPressed=!1;const n=window.siyuan.dialogs.find(a=>{if(a.element.getAttribute("data-key")===p.Constants.DIALOG_SWITCHTAB)return!0});if(n&&n.element.parentElement){if(window.siyuan.config.keymap.general.goToEditTabNext.custom.endsWith(p.Constants.KEYCODELIST[e.keyCode])||window.siyuan.config.keymap.general.goToEditTabPrev.custom.endsWith(p.Constants.KEYCODELIST[e.keyCode])){let a=n.element.querySelector(".b3-list-item--focus");if(a.classList.remove("b3-list-item--focus"),$(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e)?a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):a.getAttribute("data-original")?(a.parentElement.lastElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.parentElement.nextElementSibling?a.parentElement.nextElementSibling.lastElementChild?a.parentElement.nextElementSibling.lastElementChild.classList.add("b3-list-item--focus"):a.parentElement.lastElementChild.classList.add("b3-list-item--focus"):a.parentElement.previousElementSibling&&a.parentElement.previousElementSibling.lastElementChild.classList.add("b3-list-item--focus"):a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.getAttribute("data-original")?(a.parentElement.firstElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.parentElement.nextElementSibling?a.parentElement.nextElementSibling.firstElementChild?a.parentElement.nextElementSibling.firstElementChild.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus"):a.parentElement.previousElementSibling&&a.parentElement.previousElementSibling.firstElementChild.classList.add("b3-list-item--focus"),a=n.element.querySelector(".b3-list-item--focus"),a){const s=a.getAttribute("data-node-id");s?w("/api/filetree/getFullHPathByID",{id:s},r=>{a.parentElement.parentElement.nextElementSibling.innerHTML=we(r.data)}):a.parentElement.parentElement.nextElementSibling.innerHTML=a.querySelector(".b3-list-item__text").innerHTML;const o=a.getBoundingClientRect(),l=a.parentElement.getBoundingClientRect();o.top<l.top?a.scrollIntoView(!0):o.bottom>l.bottom&&a.scrollIntoView(!1)}const i=n.element.querySelector('[data-original="true"]');i&&i.removeAttribute("data-original")}else if(window.siyuan.config.keymap.general.goToEditTabNext.custom.startsWith(p.Constants.KEYCODELIST[e.keyCode])||window.siyuan.config.keymap.general.goToEditTabPrev.custom.startsWith(p.Constants.KEYCODELIST[e.keyCode])){let a=n.element.querySelector(".b3-list-item--focus");a.getAttribute("data-original")&&(a.classList.remove("b3-list-item--focus"),$(window.siyuan.config.keymap.general.goToEditTabPrev.custom,e)?a.previousElementSibling?a.previousElementSibling.classList.add("b3-list-item--focus"):(a.parentElement.lastElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original")):a.nextElementSibling?a.nextElementSibling.classList.add("b3-list-item--focus"):a.parentElement.firstElementChild.classList.add("b3-list-item--focus"),a.removeAttribute("data-original"),a=n.element.querySelector(".b3-list-item--focus"));const i=a.getAttribute("data-type");if(i)i==="riffCard"?Co(t):St(i).toggleModel(i,!0),document.activeElement&&document.activeElement.blur();else{const s=a.getAttribute("data-id");Yn().find(o=>{if(o.id===s)return o.parent.switchTab(o.headElement),o.parent.showHeading(),!0})}n.destroy()}}},kk=t=>{!window.siyuan.menus.menu.element.contains(t.target)&&!q(t.target,"data-menu","true")&&(getSelection().rangeCount>0&&window.siyuan.menus.menu.element.contains(getSelection().getRangeAt(0).startContainer)&&window.siyuan.menus.menu.element.contains(document.activeElement)||window.siyuan.menus.menu.remove()),A(t.target,"protyle-toolbar")||Ja(["toolbar"]),A(t.target,"pdf__outer")||Ja(["pdfutil"]),!(0,I.FJ)()&&window.siyuan.layout.leftDock&&!A(t.target,"b3-dialog--open",!0)&&!A(t.target,"b3-menu")&&!A(t.target,"block__popover")&&!A(t.target,"dock")&&!A(t.target,"layout--float",!0)&&(window.siyuan.layout.bottomDock.hideDock(),window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock());const e=ut(t.target,"protyle-action__copy");if(e){let a=e.parentElement.nextElementSibling.textContent.trimEnd();a=a.replace(/\u00A0/g," "),G(a),M(window.siyuan.languages.copied,2e3),t.preventDefault();return}if(q(t.target,"id","secondaryToolbarToggle")||q(t.target,"id","viewFind")||q(t.target,"id","findbar"))return;let n;Pe().asset.find(a=>{if(a.pdfObject&&!a.pdfObject.appConfig.appContainer.classList.contains("fn__none"))return n=a.pdfObject,!0}),n&&(n.secondaryToolbar.isOpen&&n.secondaryToolbar.close(),!n.supportsIntegratedFind&&n.findBar.opened&&n.findBar.close())},Sk=t=>{const e=t.target,n=A(e,"protyle-background");if(n&&e.tagName==="IMG"&&n.firstElementChild.querySelector(".protyle-icons").classList.contains("fn__none")){const a=A(e,"protyle-content",!0);if(!a)return!1;a.style.overflow="hidden";const i=t.touches[0].clientY,s=e.naturalHeight*e.clientWidth/e.naturalWidth-e.clientHeight;let o=parseFloat(e.style.objectPosition.substring(7))||50;e.style.objectPosition.endsWith("px")&&(o=-parseInt(e.style.objectPosition.substring(7))/s*100);const l=document;return l.ontouchmove=r=>{e.style.objectPosition=`center ${((i-r.touches[0].clientY)/s*100+o).toFixed(2)}%`},l.ontouchend=()=>{a.style.overflow="",l.ontouchmove=null,l.ontouchstart=null,l.ondragstart=null,l.onselectstart=null,l.onselect=null},t.stopImmediatePropagation(),!0}return!1},Lk=(t,e,n,a)=>{const i=t.target,s=ht();if(typeof e>"u"&&new Date().getTime()-n>900){const o=q(i,"data-type","navigation-root")||q(i,"data-type","navigation-file");if(o){if(!window.siyuan.config.readonly&&o.dataset.type==="navigation-root"){const l=hr(a,o);if(s){const r=o.getBoundingClientRect();l.popup({x:r.right-52,y:r.bottom,h:r.height}),hn()}else window.siyuan.menus.menu.fullscreen("bottom")}else if(o.dataset.type==="navigation-file"){const l=xt(o,"UL");if(l){const r=mr(a,l.dataset.url,o.dataset.path,o);if(s){const c=o.getBoundingClientRect();r.popup({x:c.right-52,y:c.bottom,h:c.height}),hn()}else window.siyuan.menus.menu.fullscreen("bottom")}}return!0}if(i.tagName==="SPAN"&&!q(i,"data-type","NodeBlockQueryEmbed")){let l;const r=A(i,"protyle",!0);if(r){const d=Lt(r.dataset.id);d instanceof gt&&d.model instanceof dt&&(l=d.model.editor)}if(!l)return!1;const c=(i.getAttribute("data-type")||"").split(" ");if(c.includes("inline-memo")&&l.protyle.toolbar.showRender(l.protyle,i),l.protyle.disabled)return t.stopImmediatePropagation(),t.preventDefault(),!0;if(c.includes("block-ref"))return Fd(l.protyle,i),!0;if(c.includes("file-annotation-ref"))return qd(l.protyle,i),!0;if(c.includes("tag"))return Vd(l.protyle,i),!0;if(c.includes("a"))return vo(l.protyle,i),!0}}return!1},Ck=t=>{document.body.addEventListener("mouseleave",()=>{window.siyuan.layout.leftDock&&(window.siyuan.layout.leftDock.hideDock(),window.siyuan.layout.rightDock.hideDock(),window.siyuan.layout.bottomDock.hideDock()),hn()});let e=!1;document.body.addEventListener("mouseenter",()=>{window.siyuan.layout.leftDock&&(e=!0,setTimeout(()=>{e=!1},p.Constants.TIMEOUT_TRANSITION))}),window.addEventListener("mousemove",a=>{vk(a,e)}),window.addEventListener("mouseup",a=>{a.button===3?(a.preventDefault(),Gd(t)):a.button===4&&(a.preventDefault(),jd(t))}),window.addEventListener("keyup",a=>{Ek(t,a)}),window.addEventListener("keydown",a=>{gk(t,a)}),window.addEventListener("blur",()=>{window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,window.siyuan.altIsPressed=!1}),window.addEventListener("click",a=>{kk(a)});let n=0;document.addEventListener("touchstart",a=>{n=new Date().getTime();const i=a.target;if(A(i,"protyle-icons")||A(i,"item")||i.classList.contains("protyle-background__icon"))return;const s=A(i,"protyle-background");if(s){Sk(a)||s.classList.toggle("protyle-background--mobileshow");return}const o=q(i,"data-type","NodeBlockQueryEmbed");if(o){o.firstElementChild.classList.toggle("protyle-icons--show");return}},!1),document.addEventListener("touchend",a=>{if(ht()){if(Lk(a,void 0,n,t)){a.stopImmediatePropagation(),a.preventDefault();return}if(new Date().getTime()-n<=900)return;const i=a.target,s=A(i,"dock__item");if(s&&s.getAttribute("data-type")){const r=s.getBoundingClientRect();Sb(s).popup({x:r.right,y:r.top}),a.stopImmediatePropagation(),a.preventDefault();return}const o=q(i,"data-type","tab-header");if(o){const r=o.getBoundingClientRect();Lb(t,Lt(o.getAttribute("data-id"))).popup({x:r.left,y:r.bottom}),hn(),a.stopImmediatePropagation(),a.preventDefault();return}const l=A(i,"protyle-breadcrumb__item");if(l){const r=l.getAttribute("data-id")||l.getAttribute("data-node-id");r&&ot(r,c=>{de({app:t,id:r,action:c?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT],zoomIn:c}),window.siyuan.menus.menu.remove()}),a.stopImmediatePropagation(),a.preventDefault();return}}},!1)},Is=(t,e,n)=>{if(e==="general"){if(!window.siyuan.config.keymap[e])return window.siyuan.config.keymap[e]=t,!1}else{if(!window.siyuan.config.keymap[e])return window.siyuan.config.keymap[e]=JSON.parse(JSON.stringify(p.Constants.SIYUAN_KEYMAP.editor)),!1;if(!window.siyuan.config.keymap[e][n])return window.siyuan.config.keymap[e][n]=t,!1}let a=!0;return Object.keys(t).forEach(i=>{e==="general"?(!window.siyuan.config.keymap[e][i]||window.siyuan.config.keymap[e][i].default!==t[i].default)&&(a=!1,window.siyuan.config.keymap[e][i]=t[i]):(!window.siyuan.config.keymap[e][n][i]||window.siyuan.config.keymap[e][n][i].default!==t[i].default)&&(a=!1,window.siyuan.config.keymap[e][n][i]=t[i])}),a},Ds=(t,e,n)=>{let a=!0;return e==="editor"?Object.keys(window.siyuan.config.keymap[e][n]).length!==Object.keys(p.Constants.SIYUAN_KEYMAP[e][n]).length&&Object.keys(window.siyuan.config.keymap[e][n]).forEach(i=>{p.Constants.SIYUAN_KEYMAP[e][n][i]||(a=!1,delete window.siyuan.config.keymap[e][n][i])}):Object.keys(window.siyuan.config.keymap[e]).length!==Object.keys(p.Constants.SIYUAN_KEYMAP[e]).length&&Object.keys(window.siyuan.config.keymap[e]).forEach(i=>{p.Constants.SIYUAN_KEYMAP[e][i]||(a=!1,delete window.siyuan.config.keymap[e][i])}),a},xk=(t,e)=>{const n=Is(p.Constants.SIYUAN_KEYMAP.general,"general"),a=Is(p.Constants.SIYUAN_KEYMAP.editor.general,"editor","general"),i=Is(p.Constants.SIYUAN_KEYMAP.editor.insert,"editor","insert"),s=Is(p.Constants.SIYUAN_KEYMAP.editor.heading,"editor","heading"),o=Is(p.Constants.SIYUAN_KEYMAP.editor.list,"editor","list"),l=Is(p.Constants.SIYUAN_KEYMAP.editor.table,"editor","table"),r=Ds(p.Constants.SIYUAN_KEYMAP.general,"general"),c=Ds(p.Constants.SIYUAN_KEYMAP.editor.general,"editor","general"),d=Ds(p.Constants.SIYUAN_KEYMAP.editor.insert,"editor","insert"),u=Ds(p.Constants.SIYUAN_KEYMAP.editor.heading,"editor","heading"),f=Ds(p.Constants.SIYUAN_KEYMAP.editor.list,"editor","list"),g=Ds(p.Constants.SIYUAN_KEYMAP.editor.table,"editor","table");!window.siyuan.config.readonly&&(!n||!a||!i||!s||!o||!l||!r||!c||!d||!u||!f||!g)&&w("/api/setting/setKeymap",{data:window.siyuan.config.keymap},()=>{xs(e)}),te.ipcRenderer.invoke(p.Constants.SIYUAN_INIT,{languages:window.siyuan.languages._trayMenu,workspaceDir:window.siyuan.config.system.workspaceDir,port:location.port}),te.webFrame.setZoomFactor(window.siyuan.storage[p.Constants.LOCAL_ZOOM]),(!window.siyuan.config.uiLayout||window.siyuan.config.uiLayout&&!window.siyuan.config.uiLayout.left)&&(window.siyuan.config.uiLayout=p.Constants.SIYUAN_EMPTY_LAYOUT),Ck(e),w("/api/system/getEmojiConf",{},m=>{window.siyuan.emojis=m.data;try{nk(e,t),xs(e),_k()}catch{yb()}}),wk(e),EE(),Ak(e),tt.onSetappearance(window.siyuan.config.appearance),f_(),ko(),Mf();let h=0;window.addEventListener("resize",()=>{window.clearTimeout(h),h=window.setTimeout(()=>{jt(),Ur()},200)}),p_()},Yo=async()=>{const t=document.getElementById("maxWindow"),e=document.getElementById("restoreWindow"),n=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"isFullScreen"});await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"isMaximized"})||n?(e.style.display="flex",t.style.display="none"):(e.style.display="none",t.style.display="flex")},Ak=async t=>{const e=(n=!1)=>{It({cb(){window.siyuan.config.appearance.closeButtonBehavior===1&&!n?window.siyuan.config.system.os==="windows"?te.ipcRenderer.send(p.Constants.SIYUAN_CONFIG_TRAY,{languages:window.siyuan.languages._trayMenu}):te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"closeButtonBehavior"):Ss()},errorExit:!0})};if(te.ipcRenderer.send(p.Constants.SIYUAN_EVENT,"onEvent"),te.ipcRenderer.on(p.Constants.SIYUAN_EVENT,(n,a)=>{a==="focus"?(getSelection().rangeCount>0&&Z(getSelection().getRangeAt(0)),window.siyuan.altIsPressed=!1,window.siyuan.ctrlIsPressed=!1,window.siyuan.shiftIsPressed=!1,document.body.classList.remove("body--blur")):a==="blur"?document.body.classList.add("body--blur"):a==="enter-full-screen"?window.siyuan.config.system.os==="darwin"?(0,I.FJ)()?Ai():document.getElementById("toolbar").style.paddingLeft="0":Yo():a==="leave-full-screen"?window.siyuan.config.system.os==="darwin"?(0,I.FJ)()?Ai():document.getElementById("toolbar").setAttribute("style",""):Yo():(a==="maximize"||a==="unmaximize")&&Yo()}),(0,I.FJ)()||te.ipcRenderer.on(p.Constants.SIYUAN_OPEN_URL,(n,a)=>{let i;try{if(i=new URL(a),i.protocol!=="siyuan:")return}catch{return}if(i&&i.pathname.startsWith("//plugins/")){const s=i.pathname.replace("//plugins/","");if(!s)return;t.plugins.find(o=>{if(s.startsWith(o.name)){if(o.eventBus.emit("open-siyuan-url-plugin",{url:a}),s.split("/")[0]!==o.name){let l=i.searchParams.get("data");try{l=JSON.parse(l||"{}")}catch(r){console.log("Error open plugin tab with protocol:",r)}Dn({app:t,custom:{title:i.searchParams.get("title"),icon:i.searchParams.get("icon"),data:l,id:s}})}return!0}});return}if(i&&$f(a)){const s=so(a),o=i.searchParams.get("focus")==="1";w("/api/block/checkBlockExist",{id:s},l=>{l.data&&(ot(s,r=>{de({app:t,id:s,action:r||o?[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_ALL]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:r||o})}),te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"show")),t.plugins.forEach(r=>{r.eventBus.emit("open-siyuan-url-block",{url:a,id:s,focus:o,exist:l.data})})});return}}),te.ipcRenderer.on(p.Constants.SIYUAN_OPEN_FILE,(n,a)=>{Dn(a)}),te.ipcRenderer.on(p.Constants.SIYUAN_SAVE_CLOSE,(n,a)=>{(0,I.FJ)()?Au(t):e(a)}),te.ipcRenderer.on(p.Constants.SIYUAN_SEND_WINDOWS,(n,a)=>{lk(a)}),te.ipcRenderer.on(p.Constants.SIYUAN_HOTKEY,(n,a)=>{let i=!1;t.plugins.find(s=>{if(s.commands.find(o=>{if(o.globalCallback&&a.hotkey===o.customHotkey)return i=!0,o.globalCallback(),!0}),i)return!0})}),te.ipcRenderer.on(p.Constants.SIYUAN_EXPORT_PDF,async(n,a)=>{const i=M(window.siyuan.languages.exporting,-1);window.siyuan.storage[p.Constants.LOCAL_EXPORTPDF]={removeAssets:a.removeAssets,keepFold:a.keepFold,mergeSubdocs:a.mergeSubdocs,watermark:a.watermark,landscape:a.pdfOptions.landscape,marginType:a.pdfOptions.marginType,pageSize:a.pdfOptions.pageSize,scale:a.pdfOptions.scale,marginTop:a.pdfOptions.margins.top,marginRight:a.pdfOptions.margins.right,marginBottom:a.pdfOptions.margins.bottom,marginLeft:a.pdfOptions.margins.left},pe(p.Constants.LOCAL_EXPORTPDF,window.siyuan.storage[p.Constants.LOCAL_EXPORTPDF]);try{if(window.siyuan.config.export.pdfFooter.trim()){const o=await lt("/api/template/renderSprig",{template:window.siyuan.config.export.pdfFooter});a.pdfOptions.displayHeaderFooter=!0,a.pdfOptions.headerTemplate="<span></span>",a.pdfOptions.footerTemplate=`<div style="text-align:center;width:100%;font-size:8px;line-height:12px;">
${o.data.replace("%pages","<span class=totalPages></span>").replace("%page","<span class=pageNumber></span>")}
</div>`}const s=await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"printToPDF",pdfOptions:a.pdfOptions,webContentsId:a.webContentsId});w("/api/export/exportHTML",{id:a.rootId,pdf:!0,removeAssets:a.removeAssets,merge:a.mergeSubdocs,savePath:a.filePaths[0]},()=>{const o=kt.join(a.filePaths[0],ad(a.rootTitle)+".pdf");ts.writeFileSync(o,s),te.ipcRenderer.send(p.Constants.SIYUAN_CMD,{cmd:"destroy",webContentsId:a.webContentsId}),w("/api/export/processPDF",{id:a.rootId,merge:a.mergeSubdocs,path:o,removeAssets:a.removeAssets,watermark:a.watermark},()=>{if(dr(o,i),a.removeAssets){const l=r=>new Promise(function(c){ts.stat(r,function(d,u){u&&(u.isDirectory()?ts.readdir(r,function(f,g){g=g.map(h=>kt.join(r,h)),Promise.all(g.map(h=>l(h))).then(function(){ts.rmdir(r,c)})}):ts.unlink(r,c))})});l(kt.join(a.filePaths[0],"assets"))}})})}catch(s){M("Export PDF failed: "+s,0,"error",i),te.ipcRenderer.send(p.Constants.SIYUAN_CMD,{cmd:"destroy",webContentsId:a.webContentsId})}te.ipcRenderer.send(p.Constants.SIYUAN_CMD,{cmd:"hide",webContentsId:a.webContentsId})}),(0,I.FJ)()){document.body.insertAdjacentHTML("beforeend",`<div class="toolbar__window">
<div class="toolbar__item ariaLabel" aria-label="${window.siyuan.languages.pin}" id="pinWindow">
    <svg>
        <use xlink:href="#iconPin"></use>
    </svg>
</div></div>`);const n=document.getElementById("pinWindow");n.addEventListener("click",()=>{n.getAttribute("aria-label")===window.siyuan.languages.pin?(n.querySelector("use").setAttribute("xlink:href","#iconUnpin"),n.setAttribute("aria-label",window.siyuan.languages.unpin),te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"setAlwaysOnTopTrue")):(n.querySelector("use").setAttribute("xlink:href","#iconPin"),n.setAttribute("aria-label",window.siyuan.languages.pin),te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"setAlwaysOnTopFalse"))})}if(window.siyuan.config.system.os!=="darwin"){document.body.classList.add("body--win32");const n=`<div class="toolbar__item ariaLabel toolbar__item--win" aria-label="${window.siyuan.languages.min}" id="minWindow">
    <svg>
        <use xlink:href="#iconMin"></use>
    </svg>
</div>
<div aria-label="${window.siyuan.languages.max}" class="ariaLabel toolbar__item toolbar__item--win" id="maxWindow">
    <svg>
        <use xlink:href="#iconMax"></use>
    </svg>
</div>
<div aria-label="${window.siyuan.languages.restore}" class="ariaLabel toolbar__item toolbar__item--win" id="restoreWindow">
    <svg>
        <use xlink:href="#iconRestore"></use>
    </svg>
</div>
<div aria-label="${window.siyuan.languages.close}" class="ariaLabel toolbar__item toolbar__item--close" id="closeWindow">
    <svg>
        <use xlink:href="#iconClose"></use>
    </svg>
</div>`;(0,I.FJ)()?document.querySelector(".toolbar__window").insertAdjacentHTML("beforeend",n):document.getElementById("windowControls").innerHTML=n;const a=document.getElementById("maxWindow");document.getElementById("restoreWindow").addEventListener("click",()=>{te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"restore")}),a.addEventListener("click",()=>{te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"maximize")}),Yo();const s=document.getElementById("minWindow"),o=document.getElementById("closeWindow");s.addEventListener("click",()=>{s.classList.contains("window-controls__item--disabled")||te.ipcRenderer.send(p.Constants.SIYUAN_CMD,"minimize")}),o.addEventListener("click",()=>{(0,I.FJ)()?Au(t):e()})}else{const n=document.getElementById("toolbar");await te.ipcRenderer.invoke(p.Constants.SIYUAN_GET,{cmd:"isFullScreen"})&&!(0,I.FJ)()&&(n.style.paddingLeft="0")}};class Tk{constructor(){this.plugins=[],Bw(),this.appId=p.Constants.SIYUAN_APPID,window.siyuan={zIndex:10,transactions:[],reqIds:{},backStack:[],layout:{},dialogs:[],blockPanels:[],ctrlIsPressed:!1,altIsPressed:!1,ws:new ct({app:this,id:Se(),type:"main",msgCallback:e=>{if(this.plugins.forEach(n=>{n.eventBus.emit("ws-main",e)}),e)switch(e.cmd){case"syncMergeResult":Jm(this,e.data);break;case"readonly":window.siyuan.config.editor.readOnly=e.data,Ja(["util"]);break;case"setConf":window.siyuan.config=e.data;break;case"progress":wE(e);break;case"setLocalStorageVal":window.siyuan.storage[e.data.key]=e.data.val;break;case"rename":Yn().forEach(n=>{if(n.headElement){const a=n.headElement.getAttribute("data-initdata");if(a){const i=JSON.parse(a);i.instance==="Editor"&&i.rootId===e.data.id&&n.updateTitle(e.data.title)}}});break;case"unmount":Yn().forEach(n=>{if(n.headElement){const a=n.headElement.getAttribute("data-initdata");if(a){const i=JSON.parse(a);i.instance==="Editor"&&e.data.box===i.notebookId&&n.parent.removeTab(n.id)}}});break;case"removeDoc":Yn().forEach(n=>{if(n.headElement){const a=n.headElement.getAttribute("data-initdata");if(a){const i=JSON.parse(a);i.instance==="Editor"&&e.data.ids.includes(i.rootId)&&n.parent.removeTab(n.id)}}});break;case"statusbar":bE(e);break;case"downloadProgress":vE(e.data);break;case"txerr":mE();break;case"syncing":ra(e,this.plugins);break;case"backgroundtask":yE(e.data.tasks);break;case"refreshtheme":window.siyuan.config.appearance.mode===1&&window.siyuan.config.appearance.themeDark!=="midnight"||window.siyuan.config.appearance.mode===0&&window.siyuan.config.appearance.themeLight!=="daylight"?document.getElementById("themeStyle").href=e.data.theme:document.getElementById("themeDefaultStyle").href=e.data.theme;break;case"openFileById":de({app:this,id:e.data.id,action:[p.Constants.CB_GET_FOCUS]});break}}})},w("/api/system/getConf",{},async e=>{(0,ze.addScriptSync)(`${p.Constants.PROTYLE_CDN}/js/lute/lute.min.js?v=${p.Constants.SIYUAN_VERSION}`,"protyleLuteScript"),(0,ze.addScript)(`${p.Constants.PROTYLE_CDN}/js/protyle-html.js?v=${p.Constants.SIYUAN_VERSION}`,"protyleWcHtmlScript"),window.siyuan.config=e.data.conf,await mb(this),di(()=>{Iu(`/appearance/langs/${window.siyuan.config.appearance.lang}.json?v=${p.Constants.SIYUAN_VERSION}`,n=>{window.siyuan.languages=n,window.siyuan.menus=new sk(this),_E(),w("/api/setting/getCloudUser",{},a=>{window.siyuan.user=a.data,xk(e.data.start,this),Pt.onSetaccount(),Bo(window.siyuan.languages.siyuanNote),V()})})})}),ha(),rk(this)}}const Ik=new Tk;window.openFileByURL=t=>{if(t&&$f(t)){const e=(0,I.on)("focus",t)==="1";return de({app:Ik,id:so(t),action:e?[p.Constants.CB_GET_ALL,p.Constants.CB_GET_FOCUS]:[p.Constants.CB_GET_FOCUS,p.Constants.CB_GET_CONTEXT,p.Constants.CB_GET_ROOTSCROLL],zoomIn:e}),!0}return!1}})()})();
